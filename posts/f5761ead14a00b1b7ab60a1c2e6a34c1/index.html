<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>fastadmin添加活动二维码图片，扫码可以直接跳转到该活动 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="fastadmin添加活动二维码图片，扫码可以直接跳转到该活动" />
<meta property="og:description" content="一，在controll重写add方法
/** * 添加 */ public function add() { if ($this-&gt;request-&gt;isPost()) { $params = $this-&gt;request-&gt;post(&#34;row/a&#34;); if ($params) { $params = $this-&gt;preExcludeFields($params); if ($this-&gt;dataLimit &amp;&amp; $this-&gt;dataLimitFieldAutoFill) { $params[$this-&gt;dataLimitField] = $this-&gt;auth-&gt;id; } $result = false; Db::startTrans(); try { //是否采用模型验证 if ($this-&gt;modelValidate) { $name = str_replace(&#34;\\model\\&#34;, &#34;\\validate\\&#34;, get_class($this-&gt;model)); $validate = is_bool($this-&gt;modelValidate) ? ($this-&gt;modelSceneValidate ? $name . &#39;.add&#39; : $name) : $this-&gt;modelValidate; $this-&gt;model-&gt;validateFailException(true)-&gt;validate($validate); } $result = $this-&gt;model-&gt;allowField(true)-&gt;save($params); Db::commit(); //添加方法 if($result){ //通过save后获取自增的ID，传进获取二维码方法，生成跳转指定小程序页面的二维码，保存到数据表中 $this-&gt;getEwm($this-&gt;model-&gt;getData(&#39;id&#39;)); } } catch (ValidateException $e) { Db::rollback(); $this-&gt;error($e-&gt;getMessage()); } catch (PDOException $e) { Db::rollback(); $this-&gt;error($e-&gt;getMessage()); } catch (Exception $e) { Db::rollback(); $this-&gt;error($e-&gt;getMessage()); } if ($result !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/f5761ead14a00b1b7ab60a1c2e6a34c1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-01T21:55:42+08:00" />
<meta property="article:modified_time" content="2024-02-01T21:55:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">fastadmin添加活动二维码图片，扫码可以直接跳转到该活动</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>一，在controll重写add方法</p> 
<pre>/**
 * 添加
 */
public function add()
{
    if ($this-&gt;request-&gt;isPost()) {
        $params = $this-&gt;request-&gt;post("row/a");
        if ($params) {
            $params = $this-&gt;preExcludeFields($params);

            if ($this-&gt;dataLimit &amp;&amp; $this-&gt;dataLimitFieldAutoFill) {
                $params[$this-&gt;dataLimitField] = $this-&gt;auth-&gt;id;
            }
            $result = false;
            Db::startTrans();
            try {
                //是否采用模型验证
                if ($this-&gt;modelValidate) {
                    $name = str_replace("\\model\\", "\\validate\\", get_class($this-&gt;model));
                    $validate = is_bool($this-&gt;modelValidate) ? ($this-&gt;modelSceneValidate ? $name . '.add' : $name) : $this-&gt;modelValidate;
                    $this-&gt;model-&gt;validateFailException(true)-&gt;validate($validate);
                }
                $result = $this-&gt;model-&gt;allowField(true)-&gt;save($params);
                Db::commit();
              <span style="color:#fe2c24;">  //添加方法</span>
               <span style="color:#fe2c24;"> if($result){
                    //通过save后获取自增的ID，传进获取二维码方法，生成跳转指定小程序页面的二维码，保存到数据表中
                    $this-&gt;getEwm($this-&gt;model-&gt;getData('id'));
                }</span>
            } catch (ValidateException $e) {
                Db::rollback();
                $this-&gt;error($e-&gt;getMessage());
            } catch (PDOException $e) {
                Db::rollback();
                $this-&gt;error($e-&gt;getMessage());
            } catch (Exception $e) {
                Db::rollback();
                $this-&gt;error($e-&gt;getMessage());
            }
            if ($result !== false) {
                $this-&gt;success();
            } else {
                $this-&gt;error(__('No rows were inserted'));
            }
        }
        $this-&gt;error(__('Parameter %s can not be empty', ''));
    }
    return $this-&gt;view-&gt;fetch();
}</pre> 
<p>2、自定义<span style="color:#fe2c24;">getEwm</span><span style="color:#0d0016;">方法</span></p> 
<pre>   public function getEwm($id){
        $access_token = $this-&gt;getWxAccessToken();
//        p($access_token);die;
        //构建请求二维码参数
        //path是扫描二维码跳转的小程序路径，可以带参数?id=xxx
        //width是二维码宽度
        $qcode ="https://api.weixin.qq.com/cgi-bin/wxaapp/createwxaqrcode?access_token=".$access_token;

        $data = array();
        $data['scene'] =  'type=qrcode';
        $data['path'] = "pages/actDetails/actDetails?id=".$id;
        $data = json_encode($data);
//     $data = json_encode(array("path"=&gt;"pages/index/index?aOpenid=".$openid,"width"=&gt; 150));

        $jpg = $this-&gt;get_http_array($qcode,$data);
        $imgDir = 'uploads/zshd/';
//        $filename="ewm.jpg";///要生成的图片名字
        $filename = 'zshdact'.$id.'.jpg';
        $file = fopen("./".$imgDir.$filename,"w");//打开文件准备写入
        fwrite($file,$jpg);//写入
        fclose($file);//关闭

        $imgUrl = constant("URL").'/uploads/zshd/'.$filename;

<span style="color:#fe2c24;">//更新二维码图片到活动表中
        ZshdActivityModel::where('id',$id)-&gt;update(['ewmImage'=&gt;$imgUrl]);</span>
//        return json($imgUrl);
    }
    public function get_http_array($url,$post_data) {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);   //没有这个会自动输出，不用print_r();也会在后面多个1
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $post_data);
        $output = curl_exec($ch);

        return $output;
    }

    /**
     * 获取小程序access_token
     */
    public function getWxAccessToken(){
        $appId = constant('appidZshd');
        $appSecret = constant('secretZshd');
        $access_token = Cache::get('wx_access_token:'.$appId);
        if($access_token){
            return $access_token;
        }else{
            //1.请求url地址
            $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=".$appId."&amp;secret=".$appSecret;
            $res = $this-&gt;curl($url);
            if(isset($res['errcode']) &amp;&amp; $res['errcode']!=0){
                return ('获取access_token出错');
            }
            $access_token = $res['access_token'];

            Cache::set('wx_access_token:'.$appId,$access_token,5400);
            return $access_token;
        }
    }
    public function curl($url,$data = null){
//        p($data);die;
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($curl, CURLOPT_TIMEOUT, 500);
        // 为保证第三方服务器与微信服务器之间数据传输的安全性，所有微信接口采用https方式调用，必须使用下面2行代码打开ssl安全校验。
        // 如果在部署过程中代码在此处验证失败，请到 http://curl.haxx.se/ca/cacert.pem 下载新的证书判别文件。
        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
        curl_setopt($curl, CURLOPT_URL, $url);
        if (!empty($data)){
            curl_setopt($curl, CURLOPT_POST, 1);
//            curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($data));
            curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
        }

        $res = curl_exec($curl);
        curl_close($curl);
        $json_obj = json_decode($res,true);
//        p($json_obj);die;
        return $json_obj;
    }
</pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7436a0d5778e0ac754e40a3fd7760b05/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何在redis中存储ndarray</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/39b14978923ae05fee860c86cbd67919/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何用java开发网站？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>