<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MatConvNet配置详解，吐血整理Win10&#43;MATLAB2019a&#43;VS2015&#43;cuda11.0 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MatConvNet配置详解，吐血整理Win10&#43;MATLAB2019a&#43;VS2015&#43;cuda11.0" />
<meta property="og:description" content="一、准备工作
1、matconvnet深度学习工具包，我这里用的是最新版本matconvnet-1.0-beta25， matconvnet下载地址：Home - MatConvNet
下载好的文件解压，重命名为matconvnet放在C:\Program Files\Polyspace\R2019a\toolbox文件夹下
2、vs，推荐用VS2015及以上版本，我这里用的是VS2015，matconvnet在配置时需要用到这个软件里面的c&#43;&#43;编译器，这里注意安装的时候要自定义安装勾选C&#43;&#43;，不然不会生成cl.exe文件，如果忘记了也没事，安装好软件以后新建一个C&#43;&#43;工程他就会自动生成cl.exe文件
3、matlab2019a（win64）
4、在安装cuda 11.0之前要先安装上自己显卡最新的官方驱动，驱动下载链接：
NVIDIA GeForce 驱动程序 - N 卡驱动 | NVIDIA
5、cuda&#43;cudnn安装，默认路径安装（我这里使用的是cuda11.0，因为我的电脑显卡是RTX3060ti,网上说法是3060显卡只支持11.0以上的cuda算力），cuda版本和cudnn版本要一致，cuda下载连接CUDA Toolkit 11.8 Downloads | NVIDIA Developer
cudnn下载链接：Installation Guide :: NVIDIA Deep Learning cuDNN Documentation
二、matconvnet环境配置
1、cpu版本配置
输入命令mex -setup
运行vl_compilenn 程序，
这样vl_compilenn 程序成功编译
在命令行窗口输入vl_testnn命令
最后显示这个就成功了
2.配置GPU版本
（1）安装cuda，正常安装即可，没有特殊的要求，这里建议安装到默认路径，不要改变，防止之后填写环境变量的时候出现差错.
（2）设置环境变量：安装完毕后，在计算机上点右键，打开属性-&gt;高级系统设置-&gt;环境变量，可以看到系统中多了CUDA_PATH和CUDA_PATH_V11_0两个环境变量，接下来，还要在系统中添加以下几个环境变量：
如果是默认的CUDA安装路径，添加的路径分别是下面这样的：
CUDA_PATH
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.0
CUDA_PATH_V11_0
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.0
CUDA_SDK_PATH
C:\ProgramData\NVIDIA Corporation\CUDA Samples\v11.0
CUDA_LIB_PATH
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/74b045c659097eaaefabee11cc9d9e0e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-17T13:19:48+08:00" />
<meta property="article:modified_time" content="2022-11-17T13:19:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MatConvNet配置详解，吐血整理Win10&#43;MATLAB2019a&#43;VS2015&#43;cuda11.0</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>一、准备工作</strong></p> 
<p>1、matconvnet深度学习工具包，我这里用的是最新版本matconvnet-1.0-beta25， matconvnet下载地址：<a href="http://www.vlfeat.org/matconvnet/" rel="nofollow" title="Home - MatConvNet">Home - MatConvNet</a></p> 
<p>下载好的文件解压，重命名为matconvnet放在C:\Program Files\Polyspace\R2019a\toolbox文件夹下</p> 
<p>2、vs，推荐用VS2015及以上版本，我这里用的是VS2015，matconvnet在配置时需要用到这个软件里面的c++编译器，这里注意安装的时候要自定义安装勾选C++，不然不会生成cl.exe文件，如果忘记了也没事，安装好软件以后新建一个C++工程他就会自动生成cl.exe文件</p> 
<p>3、matlab2019a（win64）</p> 
<p>4、在安装cuda 11.0之前要先安装上自己显卡最新的官方驱动，驱动下载链接：</p> 
<p><strong><a href="https://www.geforce.cn/drivers" rel="nofollow" title="NVIDIA GeForce 驱动程序 - N 卡驱动 | NVIDIA">NVIDIA GeForce 驱动程序 - N 卡驱动 | NVIDIA</a></strong></p> 
<p><strong>5、</strong>cuda+cudnn安装，默认路径安装（我这里使用的是cuda11.0，因为我的电脑显卡是RTX3060ti,网上说法是3060显卡只支持11.0以上的cuda算力），cuda版本和cudnn版本要一致，cuda下载连接<a href="https://developer.nvidia.com/cuda-downloads" rel="nofollow" title="CUDA Toolkit 11.8 Downloads | NVIDIA Developer">CUDA Toolkit 11.8 Downloads | NVIDIA Developer</a></p> 
<p>cudnn下载链接：<a href="https://docs.nvidia.com/deeplearning/cudnn/install-guide/index.html#installwindows" rel="nofollow" title="Installation Guide :: NVIDIA Deep Learning cuDNN Documentation">Installation Guide :: NVIDIA Deep Learning cuDNN Documentation</a></p> 
<p><strong>二、matconvnet环境配置</strong></p> 
<p>1、cpu版本配置</p> 
<p>输入命令mex -setup</p> 
<p><img alt="" height="229" src="https://images2.imgbox.com/45/78/5lavyk60_o.png" width="833"></p> 
<p> 运行vl_compilenn 程序，</p> 
<p><img alt="" height="679" src="https://images2.imgbox.com/67/d9/nmG3On8B_o.png" width="565"></p> 
<p> <img alt="" height="648" src="https://images2.imgbox.com/10/50/whqlwy1E_o.png" width="1032"></p> 
<p>这样vl_compilenn 程序成功编译</p> 
<p>在命令行窗口输入vl_testnn命令</p> 
<p><img alt="" src="https://images2.imgbox.com/c8/6a/3DAobIg8_o.png"></p> 
<p> 最后显示这个就成功了</p> 
<p>2.配置GPU版本</p> 
<p>（1）安装cuda，正常安装即可，没有特殊的要求，这里建议安装到默认路径，不要改变，防止之后填写环境变量的时候出现差错.</p> 
<p>（2）设置环境变量：安装完毕后，在计算机上点右键，打开属性-&gt;高级系统设置-&gt;环境变量，可以看到系统中多了CUDA_PATH和CUDA_PATH_V11_0两个环境变量，接下来，还要在系统中添加以下几个环境变量：<br> 如果是默认的CUDA安装路径，添加的路径分别是下面这样的：<br> CUDA_PATH<br> C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.0<br> CUDA_PATH_V11_0<br> C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.0<br> CUDA_SDK_PATH<br> C:\ProgramData\NVIDIA Corporation\CUDA Samples\v11.0<br> CUDA_LIB_PATH<br> C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.0\lib\x64<br> CUDA_BIN_PATH<br> C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.0\bin<br> CUDA_SDK_BIN_PATH<br> C:\ProgramData\NVIDIA Corporation\CUDA Samples\v11.0\bin\win64<br> CUDA_SDK_LIB_PATH</p> 
<p>C:\ProgramData\NVIDIA Corporation\CUDA Samples\v.11.0\common\lib\x64</p> 
<p>(以上路径为可选添加)</p> 
<p>然后，在系统变量 PATH 的末尾添加： 　</p> 
<p>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.0\lib\x64；(可选)</p> 
<p>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.0\bin；(可选)</p> 
<p>C:\ProgramData\NVIDIA Corporation\CUDA Samples\v11.0\common\lib\x64；（必须添加）</p> 
<p>C:\ProgramData\NVIDIA Corporation\CUDA Samples\v11.0\bin\win64； （必须添加）</p> 
<p>配置完环境变量重启一下电脑</p> 
<p>（3）在matconvnet-1.0-beta25（建议重命名文件夹改为matconvnet）中建一个local文件夹（与example和matlab等同一”级别”），然后把下载的cudnn放进去,文件名一定要重命名成cudnn，如下图所示：</p> 
<p><img alt="" height="427" src="https://images2.imgbox.com/93/fa/OGHC4tTE_o.png" width="298"></p> 
<p>cudnn64_8.dll是cudnn文件夹下bin目录里的</p> 
<p>把cudnn中的bin,lib/x64,include中的文件分别拷贝至<br> C:\Program Files\NVIDIA GPU ComputingToolkit\CUDA\v11.0中的bin,lib/x64,include三个子目录下。注意这里千万不要把cudnn的三个文件夹直接复制替换cuda中的三个文件夹，只是将cudnn对应文件夹下的文件替换cuda\V11.0下的对应文件夹下的文件<br> （5）将nvcc路径加入环境变量中：<br> MW_NVCC_PATH：C:\ProgramFiles\NVIDIA GPU Computing Toolkit\CUDA\v11.0\bin\nvcc.exe</p> 
<p><img alt="" height="190" src="https://images2.imgbox.com/6a/6c/RdTEqzlV_o.png" width="667"></p> 
<p>重新编译vl_compilenn程序,输入命令vl_compilenn('enableGpu',true)：</p> 
<p>会出现如下错误：</p> 
<blockquote> 
 <p>nvcc fatal   : '-DNDEBUG': expected a number <br> 错误使用 vl_compilenn&gt;nvcc_compile (line 615)<br> Command "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v10.1\bin\nvcc" -c -o<br> "E:\matconvnet\matlab\mex\.build\bits\data.obj"<br> "E:\matconvnet\matlab\src\bits\data.cu" -DENABLE_GPU<br> -DENABLE_DOUBLE -O -DNDEBUG -D_FORCE_INLINES --std=c++11 -I"D:\Softwares\MATLAB\extern\include"<br> -I"D:\Softwares\MATLAB\toolbox\distcomp\gpu\extern\include" -gencode=arch=compute_75,code=\"sm_75,compute_75\"  --compiler-options=/MD<br> --compiler-bindir="D:\Softwares\VisualStudio\VC\Tools\MSVC\14.16.27023\bin\Hostx64"  failed.<br>  <br> 出错 vl_compilenn (line 487)<br>       nvcc_compile(opts, srcs{i}, objfile, flags) ;</p> 
</blockquote> 
<p>错误原因：</p> 
<p>CUDA 10.1以前的版本使用非debug模式下GPU优化指令是-O，CUDA 10.1以上版本把-O指令给弃用了。</p> 
<p>现在的指令为-O+数字，此处的数字为优化的等级。vl_compilenn默认编译是非debug模式的，所以matlab会提示我们需要一个数字。</p> 
<p>解决方法：</p> 
<p>1）使用debug运行vl_compilenn，这种方法会导致性能损失，不可取。</p> 
<p>2）将优化指令-O改为-O+数字。</p> 
<p>更改方法如下：</p> 
<p>将vl_compilenn.m，将606行的nvcc_compile函数</p> 
<blockquote> 
 <p>function nvcc_compile(opts, src, tgt, flags)<br> % --------------------------------------------------------------------<br> if check_deps(opts, tgt, src), return ; end<br> nvcc_path = fullfile(opts.cudaRoot, 'bin', 'nvcc');<br> nvcc_cmd = sprintf('"%s" -c -o "%s" "%s" %s ', ...<br>                    nvcc_path, tgt, src, ...<br>                    strjoin(horzcat(flags.base,flags.nvcc)));<br> opts.verbose &amp;&amp; fprintf('%s: NVCC CC: %s\n', mfilename, nvcc_cmd) ;<br> status = system(nvcc_cmd);<br> if status, error('Command %s failed.', nvcc_cmd); end;</p> 
</blockquote> 
<p>改为</p> 
<blockquote> 
 <p>function nvcc_compile(opts, src, tgt, flags)<br> % --------------------------------------------------------------------<br> mybase=flags.base;<br> mybase(3)={'-O3'};<br> if check_deps(opts, tgt, src), return ; end<br> nvcc_path = fullfile(opts.cudaRoot, 'bin', 'nvcc');<br> nvcc_cmd = sprintf('"%s" -c -o "%s" "%s" %s ', ...<br>                    nvcc_path, tgt, src, ...<br>                    strjoin(horzcat(mybase,flags.nvcc)));<br> opts.verbose &amp;&amp; fprintf('%s: NVCC CC: %s\n', mfilename, nvcc_cmd) ;<br> status = system(nvcc_cmd);<br> if status, error('Command %s failed.', nvcc_cmd); end;</p> 
</blockquote> 
<p>更改为第3、4、9行。</p> 
<p>注意对比，我们使用指令为“-O3”，即默认优化等级为3，也可以改为自己想优化的等级</p> 
<p>再次运行vl_compilenn('enableGpu', true)</p> 
<p>遇到如下错误：</p> 
<blockquote> 
 <p>错误使用 mex<br> 'E:\matconvnet\matlab\mex\vl_nnconv.mexw64' 使用了 '-R2018a' 进<br> 行编译并与 '-R2017b' 链接在一起。 有关详细信息，请参阅 MEX 文件使用了一个 API 进行编译并与另一个 API 链接在一起。<br>  <br> 出错 vl_compilenn&gt;mex_link (line 629)<br> mex(args{:}) ;<br>  <br> 出错 vl_compilenn (line 500)<br>   mex_link(opts, objs, flags.mex_dir, flags) </p> 
</blockquote> 
<p>解决方法：将vl_compilenn.m中的largeArrayDims全部替换为lmwblas，一共三处。</p> 
<p><img alt="" height="472" src="https://images2.imgbox.com/44/b3/wbGVg4kc_o.png" width="953"></p> 
<p>再次运行vl_compilenn('enableGpu', true)</p> 
<p>编译成功。</p> 
<p><img alt="" height="561" src="https://images2.imgbox.com/ba/63/CvhxkeSF_o.png" width="1055"></p> 
<p> <img alt="" height="476" src="https://images2.imgbox.com/09/d9/HyVi0Yhh_o.png" width="1078"></p> 
<p> </p> 
<p> 在命令行窗口输入vl_testnn('gpu', true)，</p> 
<p><img alt="" height="334" src="https://images2.imgbox.com/07/0c/G1xD8zCy_o.png" width="468"></p> 
<p>这样GPU版本就成功了 </p> 
<p>参考文章</p> 
<p>链接：https://blog.csdn.net/qq_33782064/article/details/80003520</p> 
<p>链接：https://blog.csdn.net/qq_17783559/article/details/105474663</p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6b42d399533e3fc646326fa1cffeb3a0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Windows系统之Yolov5的安装教程笔记</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8c5a882d0a0410a0e8eb8a5962bc7354/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python 考试练习题 3</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>