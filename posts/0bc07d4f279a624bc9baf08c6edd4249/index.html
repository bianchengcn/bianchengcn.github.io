<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>实战讲解及分析Spring新建Bean的几种方式以及创建过程（图&#43;文&#43;源码） - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="实战讲解及分析Spring新建Bean的几种方式以及创建过程（图&#43;文&#43;源码）" />
<meta property="og:description" content="1 缘起 作为一个应用开发人员而言，会使用某一个工具分为两个层次（个人观点）：
第一个层次，知道工具，会使用这个工具解决问题；
第二个层次，理解工具的实现原理。
关于Spring的学习，还在第一个层次转悠，缺少原理的研究，
随着学习的深入，开始研究些Spring源码，配合IDEA调试，
逐渐理解一些Spring原理，先从创建Bean开始，
分享如下。
2 新建Bean 对于Spring学习、使用和研究人员而言，
Bean必修课，Bean从何而来，又如何获取，
弄清楚这些，会加深对Spring的理解。
首先从创建Bean开始，常见的创建方式有3种：
注解@Bean方式XML方式BeanDefinitionBuilder方式 通过XML实现的Bean注入有多种方式：构造方法注入、set方法注入、静态工厂注入和实例工厂注入
Spring提供了多种方式创建Bean，这里的创建Bean是创建自定义的Bean，
不涉及Spring启动时需要创建的系统Bean，
但是殊途同归，最终都是通过BeanDefinition构建Bean，
创建自定义的Bean会经历两个核心步骤：
注册BeanDefinition
填充beanDefinitionMap和beanDefiinitionNames，为填充singletonObjects准备创建单例Bean
填充singletonObjects，供后续获取Bean使用 2.1 @Bean方式 通过@Bean方式创建自定义Bean是最明显的方式，
直接在对应的方法上添加@Bean注解，表明这是Bean，
结合@Configuration，Spring会自动创建Bean，
测试样例及注释如下：
package com.monkey.springboottemplate.modules.bean_definition; import com.monkey.springboottemplate.common.entity.UserEntity; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.context.annotation.AnnotationConfigApplicationContext; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; /** * 注解新建Bean. * * @author xindaqi * @since 2022-12-14 16:01 */ @Configuration public class BeanDefinitionByAnnotation { private static final Logger logger = LoggerFactory.getLogger(BeanDefinitionByAnnotation.class); @Bean public UserEntity myUserBean() { return new UserEntity(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/0bc07d4f279a624bc9baf08c6edd4249/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-08T15:33:21+08:00" />
<meta property="article:modified_time" content="2023-04-08T15:33:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">实战讲解及分析Spring新建Bean的几种方式以及创建过程（图&#43;文&#43;源码）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1 缘起</h2> 
<p>作为一个应用开发人员而言，会使用某一个工具分为两个层次（个人观点）：<br> 第一个层次，知道工具，会使用这个工具解决问题；<br> 第二个层次，理解工具的实现原理。<br> 关于Spring的学习，还在第一个层次转悠，缺少原理的研究，<br> 随着学习的深入，开始研究些Spring源码，配合IDEA调试，<br> 逐渐理解一些Spring原理，先从创建Bean开始，<br> 分享如下。</p> 
<h2><a id="2_Bean_8"></a>2 新建Bean</h2> 
<p>对于Spring学习、使用和研究人员而言，<br> Bean必修课，Bean从何而来，又如何获取，<br> 弄清楚这些，会加深对Spring的理解。<br> 首先从创建Bean开始，常见的创建方式有3种：</p> 
<ul><li>注解@Bean方式</li><li>XML方式</li><li>BeanDefinitionBuilder方式</li></ul> 
<p>通过XML实现的Bean注入有多种方式：构造方法注入、set方法注入、静态工厂注入和实例工厂注入</p> 
<p>Spring提供了多种方式创建Bean，这里的创建Bean是创建自定义的Bean，<br> 不涉及Spring启动时需要创建的系统Bean，<br> 但是殊途同归，最终都是通过BeanDefinition构建Bean，<br> 创建自定义的Bean会经历两个核心步骤：</p> 
<ul><li>注册BeanDefinition<br> 填充beanDefinitionMap和beanDefiinitionNames，为填充singletonObjects准备</li><li>创建单例Bean<br> 填充singletonObjects，供后续获取Bean使用</li></ul> 
<h3><a id="21_Bean_27"></a>2.1 @Bean方式</h3> 
<p>通过@Bean方式创建自定义Bean是最明显的方式，<br> 直接在对应的方法上添加@Bean注解，表明这是Bean，<br> 结合@Configuration，Spring会自动创建Bean，<br> 测试样例及注释如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>monkey<span class="token punctuation">.</span>springboottemplate<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>bean_definition</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>monkey<span class="token punctuation">.</span>springboottemplate<span class="token punctuation">.</span>common<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">UserEntity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 注解新建Bean.
 *
 * @author xindaqi
 * @since 2022-12-14 16:01
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanDefinitionByAnnotation</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionByAnnotation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">UserEntity</span> <span class="token function">myUserBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span><span class="token string">"xiaohua"</span><span class="token punctuation">,</span> <span class="token string">"欧洲"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AnnotationConfigApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册BeanDefinition</span>
        applicationContext<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionByAnnotation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载或刷新配置（Java基础配置/XML/properties等）的持久化描述，</span>
        <span class="token comment">// 这里关注填充singletonObjects</span>
        applicationContext<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;应用程序上下文启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserEntity</span> user <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;Bean:{}"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        applicationContext<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;关闭应用程序上下文"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22_XML_70"></a>2.2 XML方式</h3> 
<p>通过XML创建Bean，首先要构建对应的XML文件，</p> 
<h4><a id="221_set_72"></a>2.2.1 set方法注入</h4> 
<p>配置样例及注释如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 在Spring framework中启用@Resource注解 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>annotation-config</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- 构建User Bean实例：Bean id为user1 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userA<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.monkey.springboottemplate.common.entity.UserEntity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nickname<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>xiaoxml<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>欧洲<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="222__91"></a>2.2.2 构造器注入</h4> 
<p>配置样例及注释如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 在Spring framework中启用@Resource注解 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>annotation-config</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- 构建User Bean实例：Bean id为user1 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userA<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.monkey.springboottemplate.common.entity.UserEntity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nickname<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>xiaoxml<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>欧洲<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="223__110"></a>2.2.3 静态工厂注入</h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>monkey<span class="token punctuation">.</span>springboottemplate<span class="token punctuation">.</span>common<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * User工厂.
 *
 * @author xindaqi
 * @since 2023-04-08 15:26
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserFactory</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UserEntity</span> <span class="token function">getUserA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"China"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>配置样例及注释如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 在Spring framework中启用@Resource注解 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>annotation-config</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- 构建User Bean实例：Bean id为user1 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userA<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.monkey.springboottemplate.common.entity.UserFactory<span class="token punctuation">"</span></span> <span class="token attr-name">factroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getUserA<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="224__143"></a>2.2.4 实例工厂注入</h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>monkey<span class="token punctuation">.</span>springboottemplate<span class="token punctuation">.</span>common<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * User工厂.
 *
 * @author xindaqi
 * @since 2023-04-08 15:26
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserFactory</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"A"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"China"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>配置样例及注释如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 在Spring framework中启用@Resource注解 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>annotation-config</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- 构建UserFactory实例：供后续调用 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userFactroy<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.monkey.springboottemplate.common.entity.UserFactory<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">factory-bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userFactory<span class="token punctuation">"</span></span> <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getName<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>address<span class="token punctuation">"</span></span> <span class="token attr-name">factory-bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userFactory<span class="token punctuation">"</span></span> <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getAddress<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>XML文件只是存储Bean的持久化配置文件，<br> 想要使该Bean加载到Spring容器，仍需要通过相关类加载该XML文件，<br> 测试样例以及注释如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>monkey<span class="token punctuation">.</span>springboottemplate<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>bean_definition</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>monkey<span class="token punctuation">.</span>springboottemplate<span class="token punctuation">.</span>common<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">UserEntity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * XML新建Bean.
 *
 * @author xindaqi
 * @since 2022-12-14 15:59
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanDefinitionByXml</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionByXml</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> beanConfig <span class="token operator">=</span> <span class="token string">"bean-creation.xml"</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过XML配置文件构建Bean</span>
        <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span>beanConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserEntity</span> user <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"userA"</span><span class="token punctuation">,</span> <span class="token class-name">UserEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;Creation Bean using XML, User Bean :{}"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="23_BeanDefinition_214"></a>2.3 BeanDefinition</h3> 
<p>上面两种创建Bean的方式对于应用开发者而言是显式的，<br> 而，更贴近Spring底层的方式是通过BeanDefinition创建Bean，<br> Spring创建Bean的第一个过程即注册BeanDefinition，就是下面的样例，<br> 通过显式的方式注册BeanDefinition，<br> 然后再创建单例的Bean，测试样例及注释如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>monkey<span class="token punctuation">.</span>springboottemplate<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>bean_definition</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>monkey<span class="token punctuation">.</span>springboottemplate<span class="token punctuation">.</span>common<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">UserEntity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeansException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">BeanDefinitionBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">DefaultListableBeanFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * BeanDefinition新建Bean.
 *
 * @author xindaqi
 * @since 2022-12-14 16:01
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanDefinitionByBuilder</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionByBuilder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AnnotationConfigApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构建BeanDefinition，填充Bean属性</span>
        <span class="token class-name">BeanDefinitionBuilder</span> beanDefinitionBuilder <span class="token operator">=</span> <span class="token class-name">BeanDefinitionBuilder</span><span class="token punctuation">.</span><span class="token function">genericBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDefinitionBuilder<span class="token punctuation">.</span><span class="token function">addPropertyValue</span><span class="token punctuation">(</span><span class="token string">"nickname"</span><span class="token punctuation">,</span> <span class="token string">"xiaoxiao"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AbstractBeanDefinition</span> beanDefinition <span class="token operator">=</span> beanDefinitionBuilder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册BeanDefinition</span>
        applicationContext<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token string">"myBean"</span><span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载或刷新配置（Java基础配置/XML/properties等）的持久化描述，</span>
        <span class="token comment">// 这里关注填充singletonObjects</span>
        applicationContext<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;应用程序上下文启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserEntity</span> user1 <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserEntity</span> user2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserEntity</span><span class="token punctuation">)</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"myBean"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;User:{}, user2:{}"</span><span class="token punctuation">,</span> user1<span class="token punctuation">,</span> user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        applicationContext<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;关闭应用程序上下文"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="3__261"></a>3 源码分析</h2> 
<h3><a id="31_Bean_262"></a>3.1 创建Bean流程</h3> 
<p>Spring中创建自定义Bean的核心流程如下图所示，<br> 由图可知，创建自定义Bean分成两个部分：</p> 
<ul><li>注册BeanDefition</li><li>注册Bean</li></ul> 
<p>核心都是填充对应的数据结构，<br> 最终把Bean添加到Spring构建的Bean容器中，供后续取用。<br> 虽然干巴巴流程太流于表面，没有质感，但是，这些使用源码中抠出来的<br> 虽然散，但是，易于理解和记忆，<br> 后面会详细给出流程的源码及源码分析。<br> <img src="https://images2.imgbox.com/96/5a/N0cQHHpK_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32_BeanDefinition_274"></a>3.2 BeanDefinition相关</h3> 
<p>先从注册BeanDefinition开始分析，<br> BeanDefiniton，从命名即可知，是Bean的定义，用于描述Bean，<br> Spring将BeanDefinition设计为一个interface，面向接口，<br> BeanDefinition源码长这样，如下图所示，<br> 这里仅需要知道BeanDefinition是用于描述Bean的即可，<br> 会在其他文章详细讲解BeanDefinition。<br> <img src="https://images2.imgbox.com/ac/6f/Ks42PhyP_o.png" alt="在这里插入图片描述"><br> 为什么要注册BeanDefinition？<br> 因为BeanDefinition用于描述Bean实例，因此，创建Bean的时候需要先注册BeanDefition，描述Bean，然后再创建Bean，两者是关联的。<br> 注册BeanDefinition的核心是填充beanDefinitionMap和beanDefinitionNames。</p> 
<ul><li> <p>beanDefinitionMap<br> 位置：org.springframework.beans.factory.support.DefaultListableBeanFactory#beanDefinitionMap<br> 源码如下图所示，由注释可知，beanDefinitionMap用于存储bean名称和beanDefintion，所谓的关联关系就在这里，(key, value)-&gt;(beanName, beanDefinition)，为后续通过beanName获取beanDefinition做准备。<br> <img src="https://images2.imgbox.com/c3/aa/RYER82xc_o.png" alt="在这里插入图片描述"></p> </li><li> <p>beanDefinitionNames<br> 位置：org.springframework.beans.factory.support.DefaultListableBeanFactory#beanDefinitionNames<br> 源码如下图所示，由注释可知，beanDefintionNames存储Bean名称，为后续填充singletonObjects做准备。<br> <img src="https://images2.imgbox.com/c4/ce/09gPrkJp_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<h4><a id="321__295"></a>3.2.1 流程</h4> 
<p>前置知识已介绍，下面进入正题，讲解流程。<br> 源码调试流程如下图所示，感兴趣的可以参照流程图中打断点调试。<br> <img src="https://images2.imgbox.com/18/27/YDbsLsbs_o.png" alt="在这里插入图片描述"></p> 
<p>(1)AnnotationConfigApplicationContext中注册BeanDefinition：registerBeanDefinition<br> (2)GenericApplicationContext中注册BeanDefinition：registerBeanDefinition<br> (3)DefaultListableBeanFactory中注册BeanDefinition：registerBeanDefinition<br> (4)DefaultListableBeanFactory中填充beanDefinitionMap：beanDefinitionMap.put<br> (5)DefaultListableBeanFactory中填充beanDefinitionNames：beanDefinitionNames.add</p> 
<h4><a id="322__306"></a>3.2.2 源码调试过程</h4> 
<h5><a id="3221_AnnotationConfigApplicationContextBeanDefinitionregisterBeanDefinition_307"></a>3.2.2.1 AnnotationConfigApplicationContext中注册BeanDefinition：registerBeanDefinition</h5> 
<p><img src="https://images2.imgbox.com/9a/9f/i6f1ioCJ_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3222_GenericApplicationContextBeanDefinitionregisterBeanDefinition_309"></a>3.2.2.2 GenericApplicationContext中注册BeanDefinition：registerBeanDefinition</h5> 
<p><img src="https://images2.imgbox.com/e3/73/ROM2KSf0_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3223_DefaultListableBeanFactoryBeanDefinitionregisterBeanDefinition_312"></a>3.2.2.3 DefaultListableBeanFactory中注册BeanDefinition：registerBeanDefinition</h5> 
<p><img src="https://images2.imgbox.com/c7/e9/VTsEHnT2_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3224_DefaultListableBeanFactorybeanDefinitionMapbeanDefinitionMapput__314"></a>3.2.2.4 DefaultListableBeanFactory中填充beanDefinitionMap：beanDefinitionMap.put &amp;</h5> 
<h5><a id="3225_DefaultListableBeanFactorybeanDefinitionNamesbeanDefinitionNamesadd_315"></a>3.2.2.5 DefaultListableBeanFactory中填充beanDefinitionNames：beanDefinitionNames.add</h5> 
<p>合并步骤4和5，填充对应的数据。<br> <img src="https://images2.imgbox.com/f5/ee/QOP4BqpB_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="33_Bean_320"></a>3.3 Bean相关</h3> 
<p>完成上面的准备工作，接下来就要创建Bean，<br> 这个Bean实际单例对象，在singletonObjects中存储，为后面获取Bean做准备。<br> singletonObjects：<br> 位置：org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#singletonObjects<br> 源码如下图所示，由注释可知，singletonObjects缓存单例Bean实例。<br> <img src="https://images2.imgbox.com/35/7b/M1wX8n4S_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="331__328"></a>3.3.1 流程</h4> 
<p>下面开始讲解如何填充这个Map，<br> 源码调试流程如下图所示，感兴趣的可以参照流程图中打断点调试。<br> <img src="https://images2.imgbox.com/d0/3b/h8bjSd9w_o.png" alt="在这里插入图片描述"></p> 
<p>(1)AnnotationConfigApplicationContext中刷新相关的Bean：refresh<br> (2)同步锁，AbstractApplicationContext中刷新相关Bean：refresh<br> (3)结束BeanFactory初始化，AbstractApplicationContext初始化的最后一步，完成准备工作之后，需要固化相关的操作：finishBeanFactoryInitialization<br> (4)预处理，DefaultListableBeanFactory实例化单体Bean：preInstantiateSingletons<br> (5)获取Bean，AbstractBeanFactory根据Bean名称获取Bean：getBean(java.lang.String)<br> (6)获取Bean，AbstractBeanFactory获取Bean：doGetBean<br> (7)获取单例Bean，DefaultSingletonBeanRegistry根据Bean名称获取单例Bean：getSingleton(java.lang.String, org.springframework.beans.factory.ObjectFactory&lt;?&gt;)<br> (8)添加单例Bean，DefaultSingletonBeanRegistry添加单例Bean：addSingleton<br> (9)添加Bean，DefaultSingletonBeanRegistry：singletonObjects.put</p> 
<h4><a id="332__343"></a>3.3.2 源码调试过程</h4> 
<h5><a id="3321_AnnotationConfigApplicationContextBeanrefresh_344"></a>3.3.2.1 AnnotationConfigApplicationContext中刷新相关的Bean：refresh</h5> 
<p><img src="https://images2.imgbox.com/a9/f0/1sbab6OE_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3322_AbstractApplicationContextBeanrefresh_347"></a>3.3.2.2 同步锁，AbstractApplicationContext中刷新相关Bean：refresh</h5> 
<p><img src="https://images2.imgbox.com/63/05/Y5PRExMC_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3323_BeanFactoryAbstractApplicationContextfinishBeanFactoryInitialization_349"></a>3.3.2.3 结束BeanFactory初始化，AbstractApplicationContext初始化的最后一步，完成准备工作之后，需要固化相关的操作：finishBeanFactoryInitialization</h5> 
<p><img src="https://images2.imgbox.com/27/b7/RB8eix93_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3324_DefaultListableBeanFactoryBeanpreInstantiateSingletons_351"></a>3.3.2.4 预处理，DefaultListableBeanFactory实例化单体Bean：preInstantiateSingletons</h5> 
<p><img src="https://images2.imgbox.com/1b/4c/Z7HDtT1O_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/37/5b/VrU3yNFY_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3325_BeanAbstractBeanFactoryBeanBeangetBeanjavalangString_354"></a>3.3.2.5 获取Bean，AbstractBeanFactory根据Bean名称获取Bean：getBean(java.lang.String)</h5> 
<p><img src="https://images2.imgbox.com/dd/31/BeOOq6j3_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/f3/c2/zC8ELO3C_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3326_BeanAbstractBeanFactoryBeandoGetBean_359"></a>3.3.2.6 获取Bean，AbstractBeanFactory获取Bean：doGetBean</h5> 
<p><img src="https://images2.imgbox.com/b0/7a/IhruWZnq_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/13/cb/l8XShLfn_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3327_BeanDefaultSingletonBeanRegistryBeanBeangetSingletonjavalangString_orgspringframeworkbeansfactoryObjectFactory_364"></a>3.3.2.7 获取单例Bean，DefaultSingletonBeanRegistry根据Bean名称获取单例Bean：getSingleton(java.lang.String, org.springframework.beans.factory.ObjectFactory&lt;?&gt;)</h5> 
<p><img src="https://images2.imgbox.com/39/45/0jUNns3a_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/da/ca/jSDOKp9b_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3328_BeanDefaultSingletonBeanRegistryBeanaddSingleton_369"></a>3.3.2.8 添加单例Bean，DefaultSingletonBeanRegistry添加单例Bean：addSingleton</h5> 
<p><img src="https://images2.imgbox.com/e2/07/RKyR7PzN_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/2e/9a/ybfoi3AQ_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3329_BeanDefaultSingletonBeanRegistrysingletonObjectsput_373"></a>3.3.2.9 添加Bean，DefaultSingletonBeanRegistry：singletonObjects.put</h5> 
<p><img src="https://images2.imgbox.com/f1/fa/koGmdI5H_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/33/87/yzPNayE7_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="34_Bean_377"></a>3.4 获取Bean</h3> 
<p>通过上面的准备工作，填充了相关的数据，<br> 下面可以通过应用上下文获取Bean。</p> 
<h4><a id="341__380"></a>3.4.1 流程</h4> 
<p>源码调试流程如下图所示，感兴趣的可以参照流程图中打断点调试。<br> <img src="https://images2.imgbox.com/93/7e/TnwayS5s_o.png" alt="在这里插入图片描述"></p> 
<p>(1)获取Bean，AnnotationConfigApplicationContext：getBean<br> (2)获取Bean，AbstractApplicationContext：getBean(java.lang.String)<br> (3)获取Bean，AbstractBeanFactory：getBean(java.lang.String)<br> (4)处理逻辑，获取Bean，AbstractBeanFactory：doGetBean<br> (5)从填充的singletonObjects获取Bean，DefaultSingletonBeanRegistry：getSingleton(java.lang.String)<br> (6)获取Bean，得到查询的Bean，DefaultSingletonBeanRegistry：getSingleton(java.lang.String, boolean)</p> 
<h4><a id="342__392"></a>3.4.2 源码调试</h4> 
<h5><a id="3421_BeanAnnotationConfigApplicationContextgetBean_393"></a>3.4.2.1 获取Bean，AnnotationConfigApplicationContext：getBean</h5> 
<p><img src="https://images2.imgbox.com/85/11/NuV6syzV_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3422_BeanAbstractApplicationContextgetBeanjavalangString_395"></a>3.4.2.2 获取Bean，AbstractApplicationContext：getBean(java.lang.String)</h5> 
<p><img src="https://images2.imgbox.com/db/5a/34SyFFTc_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3423_BeanAbstractBeanFactorygetBeanjavalangString_397"></a>3.4.2.3 获取Bean，AbstractBeanFactory：getBean(java.lang.String)</h5> 
<p><img src="https://images2.imgbox.com/09/31/KCkDXedZ_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3424_BeanAbstractBeanFactorydoGetBean_399"></a>3.4.2.4 处理逻辑，获取Bean，AbstractBeanFactory：doGetBean</h5> 
<p><img src="https://images2.imgbox.com/1e/30/mq2cOVzG_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3425_singletonObjectsBeanDefaultSingletonBeanRegistrygetSingletonjavalangString_401"></a>3.4.2.5 从填充的singletonObjects获取Bean，DefaultSingletonBeanRegistry：getSingleton(java.lang.String)</h5> 
<p><img src="https://images2.imgbox.com/a0/7c/rhQ3Xghb_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3426_BeanBeanDefaultSingletonBeanRegistrygetSingletonjavalangString_boolean_403"></a>3.4.2.6 获取Bean，得到查询的Bean，DefaultSingletonBeanRegistry：getSingleton(java.lang.String, boolean)</h5> 
<p><img src="https://images2.imgbox.com/e3/cc/hyUlrQZ5_o.png" alt="在这里插入图片描述"><br> 最终返回查到的Bean。<br> <img src="https://images2.imgbox.com/cf/23/mbY3Yz1W_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4__408"></a>4 小结</h2> 
<p>（1）新建Bean的三种方式：XML、@Bean和BeanDefinition；<br> （2）创建Bean的核心过程：<br> （2.1）注册BeanDefinition，填充beanDefinitionMap和beanDefinitionNames；<br> （2.2）注册Bean，填充singletonObjects；<br> （3）通过应用上下文获取Bean，是通过singletonObjects查询获取。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8c48a9a18b200dc731031fe379685c0e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Node.js -- JavaScript的运行环境</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cfc329681e4b7a7e18f9b9dc3144b9c8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【网络】SNAT和DNAT</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>