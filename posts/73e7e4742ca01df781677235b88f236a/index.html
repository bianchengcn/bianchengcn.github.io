<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Nginx&#43;Egg.js配置Https - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Nginx&#43;Egg.js配置Https" />
<meta property="og:description" content="费了一下午终于把这个事搞定了，记录一下，也给有需要的小伙伴。
作为一个侧重前端的全栈，内心是很乐意用Node做后端的，也为有Eggjs这样的国产项目感到振奋。然而在看文档的时候又常常感到心里堵。 Nginx 在配置Https之前，我们的Nginx配置文件大概是这样的：
# /usr/local/nginx/conf/nginx.conf http { include mime.types; default_type application/octet-stream; sendfile on; keepalive_timeout 65; server { listen 80; server_name www.你的域名.com; location / { root html; try_files $uri $uri/ @router; # 配置使用路由 index index.html index.htm; } } } 关于证书的内容请另行搜索。假设你现在已经有了证书文件了，把它们放在服务器的某个文件夹中。然后来修改配置文件
# /usr/local/nginx/conf/nginx.conf http { include mime.types; default_type application/octet-stream; sendfile on; keepalive_timeout 65; # 这是新增的 server { listen 443 ssl; # 这是新版本Nginx的写法，老的写法是listen 443; ssl on; server_name www.你的域名.com; # 这是两个证书文件的路径，改成自己的 ssl_certificate /usr/local/nginx/cert/9139200_isincerely." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/73e7e4742ca01df781677235b88f236a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-11T18:10:11+08:00" />
<meta property="article:modified_time" content="2023-01-11T18:10:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nginx&#43;Egg.js配置Https</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="kdocs-document"> 
 <p style="">费了一下午终于把这个事搞定了，记录一下，也给有需要的小伙伴。</p> 
 <blockquote class="kdocs-blockquote" style="">
   作为一个侧重前端的全栈，内心是很乐意用Node做后端的，也为有Eggjs这样的国产项目感到振奋。然而在看文档的时候又常常感到心里堵。 
 </blockquote> 
 <h2 style="">Nginx</h2> 
 <p style="">在配置Https之前，我们的Nginx配置文件大概是这样的：</p> 
 <pre class="kdocs-nginx"><code class="language-nginx"># /usr/local/nginx/conf/nginx.conf
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    
    server {
        listen       80;
        server_name  www.你的域名.com;

        location / {
            root   html;
            try_files $uri $uri/ @router; # 配置使用路由
            index  index.html index.htm;
        }
    }
}</code></pre> 
 <p style="">关于证书的内容请另行搜索。假设你现在已经有了证书文件了，把它们放在服务器的某个文件夹中。然后来修改配置文件</p> 
 <pre class="kdocs-nginx"><code class="language-nginx"># /usr/local/nginx/conf/nginx.conf
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # 这是新增的
    server {
        listen       443 ssl; # 这是新版本Nginx的写法，老的写法是listen 443; ssl on;

        server_name  www.你的域名.com;

        # 这是两个证书文件的路径，改成自己的
        ssl_certificate  /usr/local/nginx/cert/9139200_isincerely.com.pem;
        ssl_certificate_key /usr/local/nginx/cert/9139200_isincerely.com.key;

        # 这些照抄
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2; 
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; 
        ssl_prefer_server_ciphers on;
        
        # 这是从原本listen 80的server剪切过来的
        location / {
            root   html;
            try_files $uri $uri/ @router; # 配置使用路由
            index  index.html index.htm;
        }

        # 这是新增的，为Egg写的
        location /api/ {
            proxy_pass http://127.0.0.1:7001/;
        }

    server {
        listen       80;
        server_name  www.你的域名.com;
        # 强制转到https
        return 301 https://$server_name$request_uri;
    }
}
    </code></pre> 
 <p style="">这里要注意的就是这段</p> 
 <pre class="kdocs-nginx"><code class="language-nginx">location /api/ {
    proxy_pass http://127.0.0.1:7001/;
}</code></pre> 
 <p style="">一般的Nginx配置https教程里没有这一段，就导致无法正确请求到Egg的接口。</p> 
 <h2 style="">Egg</h2> 
 <p style="">配置完前面的内容，再把前端的请求、后端的跨域配置改成https，这样你的页面应该可以用https打开但是会发现请求报错了。</p> 
 <p style="">原来还需要在Egg的配置文件里加这段代码</p> 
 <pre class="kdocs-javascript"><code class="language-javascript">// egg/config/config.default.js
const path = require("path");
module.exports = appInfo =&gt; {
    ...
    config.cluster = {
        https: {
            key: path.join(__dirname,'../app/cert/证书.key'), // https 证书绝对目录
           cert: path.join(__dirname,'../app/cert/证书.pem') // https 证书绝对目录
        }
    };
    ...
}</code></pre> 
 <p style="">我不知道这段代码在文档的哪个位置，反正在文档里搜https或者ssl，都没有找到有用的内容。</p> 
 <p style="">另外有帖子说需要在Egg配置文件里加上</p> 
 <pre class="kdocs-javascript"><code class="language-javascript">exports.proxy = true;</code></pre> 
 <p style="">我没有加也没报错。</p> 
 <p style="">最后就是记得把前后端的代码中所有的http都改成https。</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/05ed1c4a31434ce0be4aa0b739b0f138/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">js中Object设值和取值</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d3583a622c565163166e05d7e2757336/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">godot教程推荐</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>