<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>cubemx spi 中断_STM32HAL库SPI的16位数据中断发送与接收 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="cubemx spi 中断_STM32HAL库SPI的16位数据中断发送与接收" />
<meta property="og:description" content="HAL库的SPI发送接收函数的确令人迷惑，明明支持16位传输，却必须使用8位的指针。如果没能正确理解SPI发送接收函数，很容易导致程序接入HardFault_Handler中断死循环。
最近用到STM32F407的HAL编程，SPI通讯的外设要求16位通讯，对HAL库的SPI的16位通讯做了个深入研究。发现HAL库提供的函数除了入口参数含义不太明确，还是很好用的。下面以中断方式发送接收
uint16_t 数据为例，阐述函数调用的过程和要点。
1、
首先，建立发送和接收缓冲区，用16位的数组：
uint16_t SPI_TxBuff[1],
SPI_RxBuff[1];
2、SPI初始化：
HAL_SPI_DeInit(&amp;hspi1); //SPI1 复位
hspi1.Instance = SPI1;
hspi1.Init.Mode = SPI_MODE_MASTER;
hspi1.Init.Direction =
SPI_DIRECTION_2LINES; //双向通讯
hspi1.Init.DataSize =
SPI_DATASIZE_16BIT; //16位传输
hspi1.Init.CLKPolarity = SPI_POLARITY_LOW;
hspi1.Init.CLKPhase = SPI_PHASE_1EDGE;
hspi1.Init.NSS = SPI_NSS_SOFT;
hspi1.Init.BaudRatePrescaler =
SPI_BAUDRATEPRESCALER_16;
hspi1.Init.FirstBit = SPI_FIRSTBIT_MSB;
hspi1.Init.TIMode = SPI_TIMODE_DISABLE;
hspi1.Init.CRCCalculation =
SPI_CRCCALCULATION_DISABLE;
hspi1.Init.CRCPolynomial = 10;
if (HAL_SPI_Init(&amp;hspi1) != HAL_OK)
{
Error_Handler();
}
其中，DataSize 设为16位。
3、在程序中的调用：
SPI_TxBuff[0] =
data; //data
是uint16_t 类型，复制到发送缓存。
HAL_SPI_TransmitReceive_IT(&amp;hspi1,
(uint8_t*)SPI_TxBuff, (uint8_t*)SPI_RxBuff, 1);" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/900a2b51cdfe0e597669aac659b00b52/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-20T20:48:54+08:00" />
<meta property="article:modified_time" content="2020-12-20T20:48:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">cubemx spi 中断_STM32HAL库SPI的16位数据中断发送与接收</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>HAL库的SPI发送接收函数的确令人迷惑，明明支持16位传输，却必须使用8位的指针。如果没能正确理解SPI发送接收函数，很容易导致程序接入HardFault_Handler中断死循环。</p> 
 <p>最近用到STM32F407的HAL编程，SPI通讯的外设要求16位通讯，对HAL库的SPI的16位通讯做了个深入研究。发现HAL库提供的函数除了入口参数含义不太明确，还是很好用的。下面以中断方式发送接收</p> 
 <p>uint16_t 数据为例，阐述函数调用的过程和要点。</p> 
 <p>1、</p> 
 <p>首先，建立发送和接收缓冲区，用16位的数组：</p> 
 <p>uint16_t SPI_TxBuff[1],</p> 
 <p>SPI_RxBuff[1];</p> 
 <p>2、SPI初始化：</p> 
 <p>HAL_SPI_DeInit(&amp;hspi1);   //SPI1 复位</p> 
 <p>hspi1.Instance = SPI1;</p> 
 <p>hspi1.Init.Mode = SPI_MODE_MASTER;</p> 
 <p>hspi1.Init.Direction =</p> 
 <p>SPI_DIRECTION_2LINES;   //双向通讯</p> 
 <p>hspi1.Init.DataSize =</p> 
 <p>SPI_DATASIZE_16BIT;       //16位传输</p> 
 <p>hspi1.Init.CLKPolarity = SPI_POLARITY_LOW;</p> 
 <p>hspi1.Init.CLKPhase = SPI_PHASE_1EDGE;</p> 
 <p>hspi1.Init.NSS = SPI_NSS_SOFT;</p> 
 <p>hspi1.Init.BaudRatePrescaler =</p> 
 <p>SPI_BAUDRATEPRESCALER_16;</p> 
 <p>hspi1.Init.FirstBit = SPI_FIRSTBIT_MSB;</p> 
 <p>hspi1.Init.TIMode = SPI_TIMODE_DISABLE;</p> 
 <p>hspi1.Init.CRCCalculation =</p> 
 <p>SPI_CRCCALCULATION_DISABLE;</p> 
 <p>hspi1.Init.CRCPolynomial = 10;</p> 
 <p>if (HAL_SPI_Init(&amp;hspi1) != HAL_OK)</p> 
 <p>{<!-- --></p> 
 <p>Error_Handler();</p> 
 <p>}</p> 
 <p>其中，DataSize 设为16位。</p> 
 <p>3、在程序中的调用：</p> 
 <p>SPI_TxBuff[0] =</p> 
 <p>data;   //data</p> 
 <p>是uint16_t 类型，复制到发送缓存。</p> 
 <p>HAL_SPI_TransmitReceive_IT(&amp;hspi1,</p> 
 <p>(uint8_t*)SPI_TxBuff, (uint8_t*)SPI_RxBuff, 1);</p> 
 <p>//中断方式的传输</p> 
 <p>注意1：一定要用 (uint8_t*)</p> 
 <p>临时改变SPI_TxBuff和SPI_RxBuff的类型。 经对函数内部分析，实际执行时，将把这两个指针重新变换为( uint16_t *) 。</p> 
 <p>注意2：DataSize 必须是按 uint16_t</p> 
 <p>数据的数量来设置，而不是按uint8_t, 。此例中，要传输一个16位数据，所以 DataSize 设为1 。.</p> 
 <p>4、修改SPI中断程序(在stm32f4xx_it.c中)。</p> 
 <p>void SPI1_IRQHandler(void)</p> 
 <p>{<!-- --></p> 
 <p>HAL_SPI_IRQHandler(&amp;hspi1);</p> 
 <p>//如果接收完毕，处理数据</p> 
 <p>if(HAL_SPI_GetState(&amp;hspi1) == HAL_SPI_STATE_READY)</p> 
 <p>{<!-- --></p> 
 <p>IT_ProcessingData();   //接收完成的数据已经保存在 SPI_RxBuff[0], 调用此函数进行处理</p> 
 <p>}</p> 
 <p>}</p> 
 <p>注意：</p> 
 <p>HAL_SPI_TransmitReceive_IT() 函数将产生两次中断！</p> 
 <p>第一次开始发送(接收)数据；当发送(接收)完成后产生第二次中断。我们在中断程序中，用</p> 
 <p>HAL_SPI_GetState(&amp;hspi1) == HAL_SPI_STATE_READY</p> 
 <p>来判断是否是第二次，也就是传输完成后的中断，是的话，就调用数据处理函数。</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c19883d5466a07096fdd3c683eb45cd1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">cad怎么查找未闭合_CAD应该怎么测量图形？未封闭、不规则的图形要这样测量</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/124cfb9c8f3d6bafa95c31b0f8176744/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python request url 转义_python测试开发django56.模板渲染markdown语法&#43;代码高亮</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>