<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>spring boot整合支付宝支付(沙箱环境) - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="spring boot整合支付宝支付(沙箱环境)" />
<meta property="og:description" content="spring boot整合支付宝支付(沙盒环境) 1.1、注册支付宝开放平台账号 https://openhome.alipay.com/platform/home.htm
1.2进入管理中心 1.3进入研发服务 1.4下载支付宝支付SDK https://opendocs.alipay.com/open/54/106682（提供参考）
1.5在项目中新建一个配置类 AlipayConfig 配置类代码示例
package com.alipay.config; public class AlipayConfig { //在这里填入沙箱应用中的信息 // 商户appid public static String APPID = &#34;&#34;; // 私钥 pkcs8格式的 public static String RSA_PRIVATE_KEY = &#34;&#34;; // 服务器异步通知页面路径 需http://或者https://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问 public static String notify_url = &#34;http://商户网关地址/alipay.trade.wap.pay-JAVA-UTF-8/notify_url.jsp&#34;; // 页面跳转同步通知页面路径 需http://或者https://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问 商户可以自定义同步跳转地址 public static String return_url = &#34;http://商户网关地址/alipay.trade.wap.pay-JAVA-UTF-8/return_url.jsp&#34;; // 请求网关地址 public static String URL = &#34;https://openapi.alipay.com/gateway.do&#34;; // 编码 public static String CHARSET = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/fd03451222241cd56b8e5dd5b765e164/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-10T21:53:22+08:00" />
<meta property="article:modified_time" content="2021-01-10T21:53:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">spring boot整合支付宝支付(沙箱环境)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="spring_boot_0"></a>spring boot整合支付宝支付(沙盒环境)</h2> 
<h3><a id="11_2"></a>1.1、注册支付宝开放平台账号</h3> 
<p>https://openhome.alipay.com/platform/home.htm</p> 
<h3><a id="12_6"></a>1.2进入管理中心</h3> 
<p><img src="https://images2.imgbox.com/c2/3f/clUPi6aG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="13_10"></a>1.3进入研发服务</h3> 
<p><img src="https://images2.imgbox.com/d7/0f/4KT0YbJt_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="14SDK_15"></a>1.4下载支付宝支付SDK</h3> 
<p>https://opendocs.alipay.com/open/54/106682（提供参考）</p> 
<h3><a id="15_19"></a>1.5在项目中新建一个配置类</h3> 
<p><strong>AlipayConfig 配置类代码示例</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AlipayConfig</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//在这里填入沙箱应用中的信息</span>
	<span class="token comment">// 商户appid</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> String APPID <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

	<span class="token comment">// 私钥 pkcs8格式的</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> String RSA_PRIVATE_KEY <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

	<span class="token comment">// 服务器异步通知页面路径 需http://或者https://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> String notify_url <span class="token operator">=</span> <span class="token string">"http://商户网关地址/alipay.trade.wap.pay-JAVA-UTF-8/notify_url.jsp"</span><span class="token punctuation">;</span>

	<span class="token comment">// 页面跳转同步通知页面路径 需http://或者https://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问 商户可以自定义同步跳转地址</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> String return_url <span class="token operator">=</span> <span class="token string">"http://商户网关地址/alipay.trade.wap.pay-JAVA-UTF-8/return_url.jsp"</span><span class="token punctuation">;</span>

	<span class="token comment">// 请求网关地址</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> String URL <span class="token operator">=</span> <span class="token string">"https://openapi.alipay.com/gateway.do"</span><span class="token punctuation">;</span>

	<span class="token comment">// 编码</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> String CHARSET <span class="token operator">=</span> <span class="token string">"UTF-8"</span><span class="token punctuation">;</span>

	<span class="token comment">// 返回格式</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> String FORMAT <span class="token operator">=</span> <span class="token string">"json"</span><span class="token punctuation">;</span>

	<span class="token comment">// 支付宝公钥</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> String ALIPAY_PUBLIC_KEY <span class="token operator">=</span> <span class="token string">"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAjrEVFMOSiNJXaRNKicQuQdsREraftDA9Tua3WNZwcpeXeh8Wrt+V9JilLqSa7N7sVqwpvv8zWChgXhX/A96hEg97Oxe6GKUmzaZRNh0cZZ88vpkn5tlgL4mH/dhSr3Ip00kvM4rHq9PwuT4k7z1DpZAf1eghK8Q5BgxL88d0X07m9X96Ijd0yMkXArzD7jg+noqfbztEKoH3kPMRJC2w4ByVdweWUT2PwrlATpZZtYLmtDvUKG/sOkNAIKEMg3Rut1oKWpjyYanzDgS7Cg3awr1KPTl9rHCazk15aNYowmYtVabKwbGVToCAGK+qQ1gT3ELhkGnf3+h53fukNqRH+wIDAQAB"</span><span class="token punctuation">;</span>

	<span class="token comment">// 日志记录目录定义在 logFile 中</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> String log_path <span class="token operator">=</span> <span class="token string">"/log"</span><span class="token punctuation">;</span>

	<span class="token comment">// RSA2</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> String SIGNTYPE <span class="token operator">=</span> <span class="token string">"RSA2"</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>notify_url和return_url必须要外网能访问</strong></p> 
<h3><a id="16_62"></a>1.6提交页面</h3> 
<p>配置类填好之后修改订单提交页面</p> 
<p><img src="https://images2.imgbox.com/d0/7b/Dq0qI0Mx_o.png" alt="在这里插入图片描述"></p> 
<p><strong>参数列表</strong>：https://opendocs.alipay.com/apis/api_1/alipay.trade.wap.pay</p> 
<p>1.7 支付宝支付控制器</p> 
<pre><code class="prism language-java"><span class="token comment">//支付</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/aliPay"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> String <span class="token function">pay</span><span class="token punctuation">(</span>Pay pay<span class="token punctuation">)</span> <span class="token keyword">throws</span> AlipayApiException <span class="token punctuation">{<!-- --></span>
    AlipayConfig alipayConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1.封装Rsa签名方式</span>
    AlipayClient alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span>
            alipayConfig<span class="token punctuation">.</span>URL<span class="token punctuation">,</span>
            alipayConfig<span class="token punctuation">.</span>APPID<span class="token punctuation">,</span>
            alipayConfig<span class="token punctuation">.</span>RSA_PRIVATE_KEY<span class="token punctuation">,</span>
            alipayConfig<span class="token punctuation">.</span>FORMAT<span class="token punctuation">,</span>
            alipayConfig<span class="token punctuation">.</span>CHARSET<span class="token punctuation">,</span>
            alipayConfig<span class="token punctuation">.</span>ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span>
            alipayConfig<span class="token punctuation">.</span>SIGNTYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2.创建Request请求</span>
    AlipayTradeWapPayRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeWapPayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3.封装传入参数</span>
    AlipayTradeWapPayModel model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeWapPayModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">setOutTradeNo</span><span class="token punctuation">(</span>pay<span class="token punctuation">.</span><span class="token function">getOut_trade_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//商品Id</span>
    model<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>pay<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//商品名称</span>
    model<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>pay<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//商品描述</span>
    model<span class="token punctuation">.</span><span class="token function">setProductCode</span><span class="token punctuation">(</span>pay<span class="token punctuation">.</span><span class="token function">getProduct_code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//商品码</span>
    model<span class="token punctuation">.</span><span class="token function">setTimeoutExpress</span><span class="token punctuation">(</span>pay<span class="token punctuation">.</span><span class="token function">getTimeout_express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支付超时时间</span>
    model<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span>pay<span class="token punctuation">.</span><span class="token function">getTotal_amount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//商品金额</span>
    request<span class="token punctuation">.</span><span class="token function">setBizModel</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置异步回调地址</span>
    request<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span>AlipayConfig<span class="token punctuation">.</span>notify_url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置同步回调地址</span>
    request<span class="token punctuation">.</span><span class="token function">setReturnUrl</span><span class="token punctuation">(</span>AlipayConfig<span class="token punctuation">.</span>return_url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    String form <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回请求体</span>
    <span class="token keyword">return</span> form<span class="token punctuation">;</span>

</code></pre> 
<p>到这里就已经可以完成支付宝支付了，在支付完成后，支付宝会发给我们支付完成的通知，包括同步通知(return_url)和异步通知(notify_url)，所以我们需要写控制器来接收通知。</p> 
<h3><a id="17_111"></a>1.7通知回调(异步和同步)</h3> 
<p><strong>日志和线程：</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>AlipayCallBackController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> ExecutorService executorService <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="171_120"></a>1.7.1处理请求体信息</h4> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> <span class="token function">convertRequestParamsToMap</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> retMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Set<span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> entrySet <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> entry <span class="token operator">:</span> entrySet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String name <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> valLen <span class="token operator">=</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>valLen <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            retMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>valLen <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            StringBuilder stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String value <span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            retMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            retMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> retMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="172JSON_146"></a>1.7.2JSON字符串的处理</h4> 
<pre><code class="prism language-java"><span class="token keyword">private</span> AlipayNotifyParam <span class="token function">buildAliPayNotifyParam</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//将json数据转为字符串</span>
    String json <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将字符串转为object对象</span>
    <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> AlipayNotifyParam<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="173_157"></a>1.7.3检验订单信息是否一致</h4> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token keyword">throws</span> AlipayApiException <span class="token punctuation">{<!-- --></span>
    String outTradeNo <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号</span>
    Order order <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">findIdByOrderNum</span><span class="token punctuation">(</span>outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AlipayApiException</span><span class="token punctuation">(</span><span class="token string">"out_trade_no错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额）</span>
    <span class="token keyword">long</span> total_amount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>total_amount <span class="token operator">!=</span> order<span class="token punctuation">.</span><span class="token function">getOrder_total</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AlipayApiException</span><span class="token punctuation">(</span><span class="token string">"total_amount错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//3、校验通知中的seller_id(或者seller_email)是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email）</span>
    <span class="token comment">// 第三步可根据实际情况省略</span>

    <span class="token comment">// 4、验证app_id是否为该商户本身。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"app_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>AlipayConfig<span class="token punctuation">.</span>APPID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AlipayApiException</span><span class="token punctuation">(</span><span class="token string">"app_id不一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="174_185"></a>1.7.4调用异步回调</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/alipay_callback"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> String <span class="token function">callback</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------异步调用成功--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token function">convertRequestParamsToMap</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    String paramsJson <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"支付宝回调，{}"</span><span class="token punctuation">,</span> paramsJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        AlipayConfig alipayConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//支付宝验签</span>
        <span class="token keyword">boolean</span> signVerified <span class="token operator">=</span> AlipaySignature<span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>CHARSET<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>SIGNTYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>signVerified<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"支付宝回调签名认证成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//按照支付结果异步通知中描述，对支付结果中的业务内容进行1\2\3\4二次校验，校验成功后在response中返回success，校验失败返回failure</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    AlipayNotifyParam param <span class="token operator">=</span> <span class="token function">buildAliPayNotifyParam</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    String trade_status <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">getTradeStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//支付成功</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TRADE_SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//修改订单状态</span>
                            String out_trade_no <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            orderService<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------订单付款成功------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"支付宝回调业务处理报错,params:"</span> <span class="token operator">+</span> paramsJson<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"没有处理支付宝回调业务，支付宝交易状态：{},params:{}"</span><span class="token punctuation">,</span> trade_status<span class="token punctuation">,</span> paramsJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//订单完成</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TRADE_FINISHED"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//修改订单状态</span>
                            String out_trade_no <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            orderService<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------订单已经付款，请勿重复付款------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"支付宝回调业务处理报错,params:"</span> <span class="token operator">+</span> paramsJson<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"没有处理支付宝回调业务，支付宝交易状态：{},params:{}"</span><span class="token punctuation">,</span> trade_status<span class="token punctuation">,</span> paramsJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果签名验证正确，立即返回success，后续业务另起线程单独处理</span>
            <span class="token comment">// 业务处理失败，可查看日志进行补偿，跟支付宝已经没多大关系。</span>
            <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"支付宝回调签名认证失败，signVerified=false, paramsJson:{}"</span><span class="token punctuation">,</span> paramsJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"failure"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"支付宝回调签名认证失败,paramsJson:{},errorMsg:{}"</span><span class="token punctuation">,</span> paramsJson<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"failure"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>1.7.5调用同步回调</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/return_callback"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> String <span class="token function">returnCallback</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> Model model<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------同步调用成功--------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OrderInfoDTO orderInfoDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderInfoDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token function">convertRequestParamsToMap</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    String paramsJson <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        AlipayConfig alipayConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//支付宝验签</span>
        <span class="token keyword">boolean</span> signVerified <span class="token operator">=</span> AlipaySignature<span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>CHARSET<span class="token punctuation">,</span> AlipayConfig<span class="token punctuation">.</span>SIGNTYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>signVerified<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//按照支付结果异步通知中描述，对支付结果中的业务内容进行1\2\3\4二次校验，校验成功后在response中返回success，校验失败返回failure</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取支付金额</span>
            Double totalAmount <span class="token operator">=</span> Double<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取支付单号</span>
            String outTradeNo <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//校验</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>outTradeNo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> totalAmount <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                orderInfoDTO<span class="token punctuation">.</span><span class="token function">setOrder_total</span><span class="token punctuation">(</span>totalAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                orderInfoDTO<span class="token punctuation">.</span><span class="token function">setOrder_num</span><span class="token punctuation">(</span>outTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">,</span> orderInfoDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">"returnCallback"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"订单处理失败，请联系管理员处理！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"returnCallback"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"支付宝回调签名认证失败，signVerified=false, paramsJson:{}"</span><span class="token punctuation">,</span> paramsJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"订单验签失败，请联系管理员处理！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"returnCallback"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"支付宝回调签名认证失败,paramsJson:{},errorMsg:{}"</span><span class="token punctuation">,</span> paramsJson<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"订单异常，请联系管理员处理！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"returnCallback"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>调用完成后在沙盒平台里配置同步和异步地址</strong></p> 
<p><img src="https://images2.imgbox.com/aa/da/5hiLHgQK_o.png" alt="在这里插入图片描述"></p> 
<p>到这里支付宝支付就成功了，这里仅限于沙盒环境！！！</p> 
<h2><a id="_300"></a>注意！！！</h2> 
<p>同步回调和异步回调的地址需要在拦截器配置中放开，不然会被拦截！！</p> 
<h2><a id="_303"></a>注意！！！</h2> 
<p>同步回调和异步回调的地址需要在拦截器配置中放开，不然会被拦截！！</p> 
<p><img src="https://images2.imgbox.com/c4/53/Xo84t4F0_o.png" alt="在这里插入图片描述"><br> 回调参考自：https://blog.csdn.net/thc1987/article/details/80269181</p> 
<p>仅供自己参考，勿喷。有错欢迎指点。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8949a57539f8c872dca878abdea53744/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">store文件夹 vue_2020最新vue项目目录详解（超详细）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/258cba280885e9e3064809a74858b62e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python二进制创建写模式_Python 2和3 csv模块文本二进制模式向后兼容</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>