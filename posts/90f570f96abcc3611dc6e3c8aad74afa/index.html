<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>网络安全应急响应最全教程(2023年7月) - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="网络安全应急响应最全教程(2023年7月)" />
<meta property="og:description" content="目录 0、写在前面1、概念及应急响应流程2、Windows排查2.1文件排查2.2、进程排查2.3、系统信息排查2.4、工具排查2.5、日志排查 3、Linux排查3.1、文件排查3.2、进程排查3.3、系统信息排查3.4、后门排查3.5、日志排查3.5.1、基于时间的日志管理3.5.2、系统日志管理3.5.3、中间件日志3.5.4、数据库日志3.5.6、相关处置 4、实际案例分析4.1、案例：信息泄露 0、写在前面 最近逛CSDN发现很多文章都写的不够深入与详细，所以就想着自己能不能写一个全面且深入的教程，能覆盖到目前所有可能会遇到的问题，在翻看了国内外各个论坛和文章之后写下的这篇文章。
1、概念及应急响应流程 应急响应流程是一种在突发事件发生时组织和协调资源、快速响应并减轻损失的计划。一个有效的应急响应流程可以帮助组织提高应对风险的能力，保障人员安全和财产
2、PDCERF(6阶段)
（1）事件预警/发现：
通过安全监控系统或日志报警、告警等方式发现异常或有风险的行为。
(2）事件确认：
事件预警后需要进行核实，确认事件的具体情况，确定事件的类型、影响范围、紧急程度等。
（3）事件分类：
根据事件的类型和影响程度对事件进行分类，并作出响应计划。
（4）紧急响应：
根据响应计划，启动紧急响应模式，调集相关的人员和资源，进行紧急处理和控制事件。
（5）事件调查：
对事件进行深入分析，找出事件的成因，并根据分析结果调整相关防护策略和措施，降低风险。
（6）事件修复/恢复：
恢复受影响的系统、数据和业务功能，确保业务恢复正常运作。
（7）事件总结/报告：
回顾事件处理过程，总结经验教训，撰写事件报告，并需要对相关人员进行培训和宣传，提高业务人员的安全意识和技能水平。
2、Windows排查 2.1文件排查 （1）查看开机启动有无异常文件
【开始】➜【运行】➜【msconfig】
任务管理器中也可进行查看
（2）各个盘下的temp( tmp)相关目录下查看有无异常文件 ：Windows产生的临时文件
（3）浏览器浏览痕迹、浏览器 下载文件、浏览器cookie信息，根据不同浏览器进行排查；例如：IE浏览器，打开IE浏览器点击【查看】➜【浏览器栏】➜【历史记录】（快捷键是Ctrl&#43;Shift&#43;H）
谷歌浏览器如下：
（4）Recent是系统文件夹，里面存放着你最近使用的文档的快捷方式，查看用户recent相关文件，通过分析最近打开分析可疑文件：
【开始】➜【运行】➜【%UserProfile%\Recent】
（5）根据文件夹内文件列表时间 进行排序，查找可疑文件。当然也可以搜索指定日期范围的文件及文件
1.了解应急的时间轴，以及确定攻击ip
2.根据发生安全事件的时间轴梳理事件流程
3.根据时间轴查找可疑文件，减少可疑文件范围）
（6）查看文件时间，创建时间、修改时间、访问时间 ，黑客通过菜刀类工具改变的是修改时间。所以如果修改时间在创建时间之前明显是可疑文件
（7）搜索webshell 相关内容
例如：PHP webshell
findstr Window系统自带的命令，查找指定的一个或多个文件
findstr /m /i /s “eval” *.php (注意字符串编码格式) 参数说明：
/m	如果文件包含匹配项，则仅打印该文件名 /i 指定搜索不区分大小写 /s 在当前目录和所有子目录中搜索匹配的文件 /b 如果位于行的开头则匹配模式 /e 如果位于行的末尾则匹配模式 /x 打印完全匹配的行 /v 只打印不包含匹配的行 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/90f570f96abcc3611dc6e3c8aad74afa/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-04T17:08:47+08:00" />
<meta property="article:modified_time" content="2023-07-04T17:08:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">网络安全应急响应最全教程(2023年7月)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#0_1" rel="nofollow">0、写在前面</a></li><li><a href="#1_3" rel="nofollow">1、概念及应急响应流程</a></li><li><a href="#2Windows_22" rel="nofollow">2、Windows排查</a></li><li><ul><li><a href="#21_23" rel="nofollow">2.1文件排查</a></li><li><a href="#22_67" rel="nofollow">2.2、进程排查</a></li><li><a href="#23_104" rel="nofollow">2.3、系统信息排查</a></li><li><a href="#24_132" rel="nofollow">2.4、工具排查</a></li><li><a href="#25_170" rel="nofollow">2.5、日志排查</a></li></ul> 
  </li><li><a href="#3Linux_210" rel="nofollow">3、Linux排查</a></li><li><ul><li><a href="#31_211" rel="nofollow">3.1、文件排查</a></li><li><a href="#32_316" rel="nofollow">3.2、进程排查</a></li><li><a href="#33_406" rel="nofollow">3.3、系统信息排查</a></li><li><a href="#34_468" rel="nofollow">3.4、后门排查</a></li><li><a href="#35_497" rel="nofollow">3.5、日志排查</a></li><li><ul><li><a href="#351_545" rel="nofollow">3.5.1、基于时间的日志管理</a></li><li><a href="#352_573" rel="nofollow">3.5.2、系统日志管理</a></li><li><a href="#353_589" rel="nofollow">3.5.3、中间件日志</a></li><li><a href="#354_607" rel="nofollow">3.5.4、数据库日志</a></li><li><a href="#356_615" rel="nofollow">3.5.6、相关处置</a></li></ul> 
  </li></ul> 
  </li><li><a href="#4_628" rel="nofollow">4、实际案例分析</a></li><li><ul><li><a href="#41_629" rel="nofollow">4.1、案例：信息泄露</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="0_1"></a>0、写在前面</h2> 
<p>最近逛CSDN发现很多文章都写的不够深入与详细，所以就想着自己能不能写一个全面且深入的教程，能覆盖到目前所有可能会遇到的问题，在翻看了国内外各个论坛和文章之后写下的这篇文章。</p> 
<h2><a id="1_3"></a>1、概念及应急响应流程</h2> 
<p>应急响应流程是一种在突发事件发生时组织和协调资源、快速响应并减轻损失的计划。一个有效的应急响应流程可以帮助组织提高应对风险的能力，保障人员安全和财产<br> 2、PDCERF(6阶段)</p> 
<p><strong>（1）事件预警/发现：</strong><br> 通过安全监控系统或日志报警、告警等方式发现异常或有风险的行为。<br> <strong>(2）事件确认：</strong><br> 事件预警后需要进行核实，确认事件的具体情况，确定事件的类型、影响范围、紧急程度等。<br> <strong>（3）事件分类：</strong><br> 根据事件的类型和影响程度对事件进行分类，并作出响应计划。<br> <strong>（4）紧急响应：</strong><br> 根据响应计划，启动紧急响应模式，调集相关的人员和资源，进行紧急处理和控制事件。<br> <strong>（5）事件调查：</strong><br> 对事件进行深入分析，找出事件的成因，并根据分析结果调整相关防护策略和措施，降低风险。<br> <strong>（6）事件修复/恢复：</strong><br> 恢复受影响的系统、数据和业务功能，确保业务恢复正常运作。<br> <strong>（7）事件总结/报告：</strong><br> 回顾事件处理过程，总结经验教训，撰写事件报告，并需要对相关人员进行培训和宣传，提高业务人员的安全意识和技能水平。</p> 
<h2><a id="2Windows_22"></a>2、Windows排查</h2> 
<h3><a id="21_23"></a>2.1文件排查</h3> 
<p><strong>（1）查看开机启动有无异常文件</strong><br> 【开始】➜【运行】➜【msconfig】<br> <img src="https://images2.imgbox.com/6d/50/Y9qIpZSo_o.png" alt="在这里插入图片描述"><br> 任务管理器中也可进行查看<br> <img src="https://images2.imgbox.com/c9/01/Qouk2wI4_o.png" alt="在这里插入图片描述"></p> 
<p><strong>（2）各个盘下的temp( tmp)相关目录下查看有无异常文件 ：Windows产生的临时文件</strong><br> <img src="https://images2.imgbox.com/42/63/ESk2q255_o.png" alt="在这里插入图片描述"></p> 
<p><strong>（3）浏览器浏览痕迹、浏览器 下载文件、浏览器cookie信息，根据不同浏览器进行排查；例如：IE浏览器，打开IE浏览器点击【查看】➜【浏览器栏】➜【历史记录】（快捷键是Ctrl+Shift+H）</strong><br> <img src="https://images2.imgbox.com/39/62/8HHip4TU_o.png" alt="在这里插入图片描述"><br> 谷歌浏览器如下：<br> <img src="https://images2.imgbox.com/a8/53/FrUYnbF3_o.png" alt="在这里插入图片描述"><br> <strong>（4）Recent是系统文件夹，里面存放着你最近使用的文档的快捷方式，查看用户recent相关文件，通过分析最近打开分析可疑文件：</strong><br> 【开始】➜【运行】➜【%UserProfile%\Recent】</p> 
<p><strong>（5）根据文件夹内文件列表时间 进行排序，查找可疑文件。当然也可以搜索指定日期范围的文件及文件</strong><br> 1.了解应急的时间轴，以及确定攻击ip<br> 2.根据发生安全事件的时间轴梳理事件流程<br> 3.根据时间轴查找可疑文件，减少可疑文件范围）<br> <img src="https://images2.imgbox.com/26/5b/SbK9261t_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e4/96/fGBJ3eZ1_o.png" alt="在这里插入图片描述"><br> <strong>（6）查看文件时间，创建时间、修改时间、访问时间 ，黑客通过菜刀类工具改变的是修改时间。所以如果修改时间在创建时间之前明显是可疑文件</strong><br> <img src="https://images2.imgbox.com/5d/7d/ArnuH7mb_o.png" alt="在这里插入图片描述"><br> <strong>（7）搜索webshell 相关内容</strong><br> 例如：PHP webshell<br> findstr Window系统自带的命令，查找指定的一个或多个文件</p> 
<pre><code class="prism language-bash">findstr /m /i /s “eval” *.php  <span class="token punctuation">(</span>注意字符串编码格式<span class="token punctuation">)</span>
</code></pre> 
<p>参数说明：</p> 
<pre><code class="prism language-bash">/m		如果文件包含匹配项，则仅打印该文件名 
/i      指定搜索不区分大小写
/s      在当前目录和所有子目录中搜索匹配的文件
/b      如果位于行的开头则匹配模式
/e      如果位于行的末尾则匹配模式
/x      打印完全匹配的行
/v      只打印不包含匹配的行
</code></pre> 
<p><img src="https://images2.imgbox.com/8e/9e/eDhU7sWW_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22_67"></a>2.2、进程排查</h3> 
<p><strong>（1）netstat -ano 查看目前的网络连接，定位可疑的ESTABLISHED</strong><br> netstat 显示网络连接、路由表和网络接口信息；<br> 参数说明：</p> 
<pre><code class="prism language-bash">-a      显示所有网络连接、路由表和网络接口信息
-n	    以数字形式显示地址和端口号
-o      显示与每个连接相关的所属进程 ID
-r		显示路由表
-s		显示按协议统计信息、默认地、显示IP
</code></pre> 
<p>常见的状态说明：</p> 
<pre><code class="prism language-bash">LISTENING      侦听状态
ESTABLISHED    建立连接
CLOSE_WAIT     对方主动关闭连接或网络异常导致连接中断
</code></pre> 
<p>netstat -ano | findstr ESTABLISH<br> <img src="https://images2.imgbox.com/87/15/a6QB4L8m_o.png" alt="在这里插入图片描述"><br> <strong>（2）根据netstat定位出的pid，再通过tasklist 命令进行进程定位</strong><br> tasklist 显示运行在本地或远程计算机上的所有进程</p> 
<pre><code class="prism language-bash">tasklist <span class="token operator">|</span> findstr <span class="token number">13120</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1f/50/vGHPIrqP_o.png" alt="在这里插入图片描述"><br> <strong>（3）根据wmic process 获取进程的全路径 [任务管理器也可以定位到进程路径]</strong></p> 
<pre><code class="prism language-bash">wmic process <span class="token operator">|</span> findstr chrome
</code></pre> 
<p><img src="https://images2.imgbox.com/05/1b/Pvvg1qKJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c6/d7/TWgKtCK6_o.png" alt="在这里插入图片描述"><br> 很多种类的病毒都依赖网络进行传播和复制，并感染局域网中的大量终端。可以通过开放端口进行分析，有助于病毒对象的确认；下面提供一些常用的病毒使用的端口 信息，可以作为参考：<br> <img src="https://images2.imgbox.com/22/b1/AwhMCHZm_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23_104"></a>2.3、系统信息排查</h3> 
<p><strong>（1）查看环境 变量的设置</strong><br> 【我的电脑】➜【属性】➜【高级系统设置】➜【高级】➜【环境变量】<br> <img src="https://images2.imgbox.com/32/55/j7DD2nZL_o.png" alt="在这里插入图片描述"><br> 排查内容：temp变量的所在位置的内容；后缀映射PATHEXT是否包含有非windows的后缀；有没有增加其他的路径到PATH变量中(对用户变量和系统变量都要进行排查)；<br> <strong>（2）Windows 计划任务</strong><br> 【程序】➜【附件】➜【系统工具】➜【任务计划程序】<br> <img src="https://images2.imgbox.com/42/84/CPON5tZB_o.png" alt="在这里插入图片描述"><br> <strong>（3）Windows帐号信息，如隐藏帐号等</strong><br> 【开始】➜【运行】➜【compmgmt.msc】➜【本地用户和组】➜【用户】 (用户名以$结尾的为隐藏用户，如：admin $)</p> 
<pre><code class="prism language-bash">lusrmgr.msc
</code></pre> 
<p><img src="https://images2.imgbox.com/ca/79/ppV8c6OB_o.png" alt="在这里插入图片描述"><br> 命令行方式：net user，可直接收集用户信息（此方法看不到隐藏用户），若需查看某个用户的详细信息，可使用命令➜net user username；<br> <img src="https://images2.imgbox.com/c3/22/KhfWbGef_o.png" alt="在这里插入图片描述"><br> <strong>（4）查看当前系统用户的会话</strong><br> 使用➜ query user 查看当前系统的会话，比如查看是否有人使用远程终端登录服务器；<br> <img src="https://images2.imgbox.com/ef/da/YBHkZkv7_o.png" alt="在这里插入图片描述"><br> logoff 踢出该用户；<br> <img src="https://images2.imgbox.com/be/60/TsVkmJEj_o.png" alt="在这里插入图片描述"><br> <strong>（5）查看systeminfo 信息，系统版本以及补丁信息</strong><br> <img src="https://images2.imgbox.com/0f/92/1METmDzX_o.png" alt="在这里插入图片描述"><br> 例如系统的远程命令执行漏洞MS17-010（永恒之蓝）、MS08-067、MS09-001 …<br> 若进行漏洞比对，建议使用Windows-Privilege-Escalation-Exploit；<br> <a href="http://blog.neargle.com/win-powerup-exp-index/" rel="nofollow">http://blog.neargle.com/win-powerup-exp-index/</a><br> <img src="https://images2.imgbox.com/3c/a5/Krn2tEU2_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="24_132"></a>2.4、工具排查</h3> 
<p><strong>（1）PC Hunter 下载地址：</strong><a href="http://www.xuetr.com/" rel="nofollow">http://www.xuetr.com/</a><br> PC Hunter是一个Windows系统信息查看软件<br> <img src="https://images2.imgbox.com/5e/56/1lh594zF_o.png" alt="在这里插入图片描述"><br> 功能列表如下：</p> 
<pre><code class="prism language-bash"><span class="token number">1</span>.进程、线程、进程模块、进程窗口、进程内存信息查看，杀进程、杀线程、卸载模块等功能
<span class="token number">2</span>.内核驱动模块查看，支持内核驱动模块的内存拷贝
<span class="token number">3</span>.SSDT、Shadow SSDT、FSD、KBD、TCPIP、Classpnp、Atapi、Acpi、SCSI、IDT、GDT信息查看，并能检测和恢复ssdt hook和inline hook
<span class="token number">4</span>.CreateProcess、CreateThread、LoadImage、CmpCallback、BugCheckCallback、Shutdown、Lego等Notify Routine信息查看，并支持对这些Notify Routine的删除
<span class="token number">5</span>.端口信息查看，目前不支持2000系统
<span class="token number">6</span>.查看消息钩子
<span class="token number">7</span>.内核模块的iat、eat、inline hook、patches检测和恢复
<span class="token number">8</span>.磁盘、卷、键盘、网络层等过滤驱动检测，并支持删除
<span class="token number">9</span>.注册表编辑
<span class="token number">10</span>.进程iat、eat、inline hook、patches检测和恢复
<span class="token number">11</span>.文件系统查看，支持基本的文件操作
<span class="token number">12</span>.查看（编辑）IE插件、SPI、启动项、服务、Host文件、映像劫持、文件关联、系统防火墙规则、IME
<span class="token number">13</span>.ObjectType Hook检测和恢复
<span class="token number">14</span>.DPC定时器检测和删除
<span class="token number">15</span>.MBR Rootkit检测和修复
<span class="token number">16</span>.内核对象劫持检测
<span class="token number">17</span>.WorkerThread枚举
<span class="token number">18</span>.Ndis中一些回调信息枚举
<span class="token number">19</span>.硬件调试寄存器、调试相关API检测
<span class="token number">20</span>.枚举SFilter/Fltmgr的回调
</code></pre> 
<p><strong>（2）ProcessExplorer</strong><br> Windows系统和应用程序监视工具;<br> <img src="https://images2.imgbox.com/b3/92/D7Se643M_o.png" alt="在这里插入图片描述"><br> <strong>（3）Microsoft Network Monitor</strong><br> 一款轻量级网络协议数据分析工具；<br> <img src="https://images2.imgbox.com/42/7f/fgQHHCX9_o.png" alt="在这里插入图片描述"><br> <strong>（4）D盾Webshell 排查</strong></p> 
<p><img src="https://images2.imgbox.com/d0/04/zAhOqUn7_o.png" alt="在这里插入图片描述"><br> <strong>（5）河马webshell查杀</strong><br> <img src="https://images2.imgbox.com/f6/f4/DQWsSuM1_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="25_170"></a>2.5、日志排查</h3> 
<p><strong>（1）Windows登录日志排查</strong><br> a）打开事件管理器<br> 【开始】➜【管理工具】➜【事件查看】<br> 【开始】➜【运行】➜【eventvwr】<br> <img src="https://images2.imgbox.com/c8/fb/fmcOiFnc_o.png" alt="在这里插入图片描述"><br> b）主要分析安全日志，可以借助自带的筛选、查找、导出功能<img src="https://images2.imgbox.com/3d/c5/N68KwrRe_o.png" alt="在这里插入图片描述"><br> 可以把日志导出为文本格式，然后使用notepad++ 打开，使用正则模式去匹配远程登录过的IP地址，在界定事件日期范围的基础。<br> 正则：</p> 
<pre><code class="prism language-bash"><span class="token variable"><span class="token punctuation">((</span><span class="token operator">?</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token operator">:</span><span class="token number">25</span>[<span class="token number">0</span><span class="token operator">-</span><span class="token number">5</span>]<span class="token operator">|</span><span class="token number">2</span>[<span class="token number">0</span><span class="token operator">-</span><span class="token number">4</span>]\d<span class="token operator">|</span><span class="token punctuation">((</span><span class="token number">1</span>\d{<!-- --><span class="token number">2</span>}<span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>[<span class="token number">1</span><span class="token operator">-</span><span class="token number">9</span>]<span class="token operator">?</span>\d<span class="token punctuation">))</span></span><span class="token punctuation">)</span>.<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">(</span>?:25<span class="token punctuation">[</span><span class="token number">0</span>-5<span class="token punctuation">]</span><span class="token operator">|</span><span class="token number">2</span><span class="token punctuation">[</span><span class="token number">0</span>-4<span class="token punctuation">]</span><span class="token punctuation">\</span>d<span class="token operator">|</span><span class="token variable"><span class="token punctuation">((</span><span class="token number">1</span>\d{<!-- --><span class="token number">2</span>}<span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>[<span class="token number">1</span><span class="token operator">-</span><span class="token number">9</span>]<span class="token operator">?</span>\d<span class="token punctuation">))</span></span><span class="token punctuation">))</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/00/a6/ELvh4maj_o.png" alt="在这里插入图片描述"><br> <strong>（2）IIS日志排查</strong><br> a）查找IIS日志存放位置<br> 【开始】➜【IIS管理器】➜【网站】➜【日志】<br> IIS7.0：%SystemDrive%\inetpub\logs\LogFiles<br> <img src="https://images2.imgbox.com/54/3b/J5czHGNu_o.png" alt="在这里插入图片描述"><br> b）Log Parser 快速日志分析工具<br> Log Parser是一个用于日志文件分析的使用简单又强大的工具，多用于分析IIS web服务器的日志，支持基于文本的日志文件、XML 文件、CSV（逗号分隔符）文件以及注册表、文件系统等内容，它可以把相应的分析结果以图形的形式展现出来，大大地方便了运营人员；<br> 下载地址：<br> <a href="https://www.microsoft.com/en-us/download/confirmation.aspx?id=24659" rel="nofollow">https://www.microsoft.com/en-us/download/confirmation.aspx?id=24659</a><br> 用法：</p> 
<pre><code class="prism language-bash">LogParser.exe <span class="token string">"select top 10 time, c-ip,cs-uri-stem, sc-status, time-taken from C:\Users\liuhao02\Desktop\应急\样本\iis.log"</span> -o:datagrid
</code></pre> 
<p><img src="https://images2.imgbox.com/24/e5/m0qvpwHN_o.png" alt="在这里插入图片描述"><br> 关于windows日志工具（log parser）有无图形界面版？<br> Log Parser Lizard 是一款用Vc++.net写的logParser增强工具。主要有以下特点：</p> 
<pre><code class="prism language-bash">a<span class="token punctuation">)</span> 封装了logParser命令，带图形界面，大大降低了LogParser的使用难度。
b<span class="token punctuation">)</span> 集成了几个开源工具，如log4net等。可以对IIS logs<span class="token punctuation">\</span>EventLogs<span class="token punctuation">\</span>active directory<span class="token punctuation">\</span>log4net<span class="token punctuation">\</span>File Systems<span class="token punctuation">\</span>T-SQL进行方便的查询。
c<span class="token punctuation">)</span> 集成了Infragistics.UltraChart.Core.v4.3、Infragistics.Excel.v4.3.dll等，使查询结果可以方便的以图表或EXCEL格式展示。
d<span class="token punctuation">)</span> 集成了常见的查询命令，范围包含六大模块:IIS
e<span class="token punctuation">)</span> 可以将查询过的命令保存下来，方便再次使用。
</code></pre> 
<p><img src="https://images2.imgbox.com/af/b5/yD4rMziS_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3Linux_210"></a>3、Linux排查</h2> 
<h3><a id="31_211"></a>3.1、文件排查</h3> 
<p><strong>（1）敏感目录的文件分析 [类/tmp目录，命令目录 /usr/bin /usr/sbin等]<br> ls 用来显示目标列表</strong></p> 
<pre><code class="prism language-bash">-a   显示所有档案及目录（ls内定将档案名或目录名称为“.”的视为隐藏，不会列出）；
-C	 多列显示输出结果。这是默认选项；
-l	 以长格式显示目录下的内容列表。输出的信息从左到右依次包括文件名，文件类型、权限模式、硬连接数、所有者、组、文件大小和文件的最后修改时间等；
-t	 用文件和目录的更改时间排序；
</code></pre> 
<p><strong>（2） 查看tmp目录下的文件</strong></p> 
<pre><code class="prism language-bash">  <span class="token function">ls</span> –alt /tmp/
</code></pre> 
<p><img src="https://images2.imgbox.com/be/44/1ZO9lrJt_o.png" alt="在这里插入图片描述"><br> 如图，发现多个异常文件，疑似挖矿程序病毒：<br> <img src="https://images2.imgbox.com/b6/da/B2qEUzWq_o.png" alt="在这里插入图片描述"><br> 对已发现的恶意文件进行分析，查看559.sh脚本内容：脚本先是杀掉服务器上cpu占用大于20%的进程，然后从远程27.155.87.26（福建，黑客所控制的一个IDC服务器）下载了病毒程序并执行;<br> <img src="https://images2.imgbox.com/01/22/dE8JBuKi_o.png" alt="在这里插入图片描述"><br> <strong>（3） 查看开机启动项内容，/etc/init.d 是 /etc/rc.d/init.d 的软链接</strong></p> 
<pre><code class="prism language-bash"><span class="token function">ls</span> -alt  /etc/init.d/
</code></pre> 
<p><img src="https://images2.imgbox.com/b1/71/y7UdLUBa_o.png" alt="在这里插入图片描述"><br> <strong>（4） 按时间排序查看指定目录下文件</strong></p> 
<pre><code class="prism language-bash"><span class="token function">ls</span> -alt <span class="token operator">|</span> <span class="token function">head</span> -n <span class="token number">10</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/63/ec/4N6mWvQK_o.png" alt="在这里插入图片描述"><br> 针对可疑文件可以使用stat进行创建修改时间、访问时间的详细查看，若修改时间距离事件日期接近，有线性关联，说明可能被篡改或者其他。</p> 
<pre><code class="prism language-bash"><span class="token function">stat</span> /etc/passwd
（1）Access Time：简写为atime，表示文件的访问时间。当文件内容被访问时，更新这个时间。
（2）Modify Time：简写为mtime，表示文件内容的修改时间，当文件的数据内容被修改时，更新这个时间。 
（3）Change Time：简写为ctime，表示文件的状态时间，当文件的状态被修改时，更新这个时间，例如文件的链接数，大小，权限，Blocks数。
</code></pre> 
<p><img src="https://images2.imgbox.com/b3/d8/b3JSzkFm_o.png" alt="在这里插入图片描述"><br> <strong>（5） 查看历史命令记录文件~/.bash_history</strong><br> 查找~/.bash_history命令执行记录，主要分析是否有账户执行过恶意操作系统；命令在linux系统里，只要执行过命令的用户，那么在这个用户的HOME目录下，都会有一个.bash_history的文件记录着这个用户都执行过什么命令；</p> 
<pre><code class="prism language-bash"><span class="token function">cat</span> /root/.bash_history
</code></pre> 
<p><img src="https://images2.imgbox.com/83/98/6tCfC5DJ_o.png" alt="在这里插入图片描述"><br> <strong>（6） 查看操作系统用户信息文件/etc/passwd</strong><br> 查找/etc/passwd文件， /etc/passwd这个文件是保存着这个linux系统所有用户的信息，通过查看这个文件，我们就可以尝试查找有没有攻击者所创建的用户，或者存在异常的用户。我们主要关注的是第3、4列的用户标识号和组标识号，和倒数一二列的用户主目录和命令解析程序。一般来说最后一列命令解析程序如果是设置为nologin的话，那么表示这个用户是不能登录的，所以可以结合我们上面所说的bash_history文件的排查方法。首先在/etc/passwd中查找命令解释程序不是nologin的用户，然后再到这些用户的用户主目录里，找到bash_history，去查看这个用户有没执行过恶意命令。</p> 
<pre><code class="prism language-bash"><span class="token function">cat</span> /etc/passwd 
</code></pre> 
<p><img src="https://images2.imgbox.com/cd/53/7qSIql78_o.png" alt="在这里插入图片描述"><br> <strong>（7） 查看新增文件</strong><br> find：在指定目录下查找文件</p> 
<pre><code class="prism language-bash">-type	b/d/c/p/l/f查是块设备、目录、字符设备、管道、符号、链   接、普通文件
-mtime -n +n 	按文件更改时间来查找文件，-n指n天以内，+n指n天前
-atime -n +n 	按文件访问时间来查找文件，-n指n天以内，+n指n天前
-ctime -n +n 	按文件创建时间来查找文件，-n指n天以内，+n指n天前
</code></pre> 
<p>查找24小时前被修改的php文件</p> 
<pre><code class="prism language-bash"><span class="token function">find</span> ./ -mtime +0 -name <span class="token string">"*.php"</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/62/55/R3xDzi0f_o.png" alt="在这里插入图片描述"><br> 查找72小时内新增的文件<br> （PS：-ctime 内容未改变权限改变时候也可以查出）</p> 
<pre><code class="prism language-bash"><span class="token function">find</span> / -ctime <span class="token number">2</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/fc/c6/ZjapDDI7_o.png" alt="在这里插入图片描述"><br> grep 一种强大的文本搜索工具，它能使用正则表达式搜索文本，并把匹配的行打印出来</p> 
<pre><code class="prism language-bash">-v	反转查找 
-E	使用正则表达式选项 
-n	输出包含匹配字符串的行数
--color<span class="token operator">=</span>auto  标记匹配颜色
</code></pre> 
<p><img src="https://images2.imgbox.com/b2/ee/hyOICQ91_o.png" alt="在这里插入图片描述"><br> tail 查看档案的结尾，默认显示最后十行</p> 
<pre><code class="prism language-bash"><span class="token function">tail</span> -f /var/log/nps.log

-f	动态显示文件最新追加的内容；
</code></pre> 
<p><img src="https://images2.imgbox.com/cc/81/qLSjk97q_o.png" alt="在这里插入图片描述"><br> <strong>（8） 特殊权限的文件查看</strong><br> 查找777 的权限的文件</p> 
<pre><code class="prism language-bash"><span class="token function">find</span> / -perm <span class="token number">777</span> <span class="token operator">|</span> <span class="token function">more</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/52/63/joP66q5u_o.png" alt="在这里插入图片描述"><br> <strong>（9）隐藏的文件 （以 "."开头的具有隐藏属性的文件）PS：在文件分析过程中，手工排查频率较高的命令是 find grep ls 核心目的是为了关联推理出可疑文件</strong></p> 
<pre><code class="prism language-bash"><span class="token function">ls</span> /etc -ar <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"^\."</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/37/a8/cbbMJJyX_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32_316"></a>3.2、进程排查</h3> 
<p><strong>（1）使用top命令 实时动态地查看系统的整体运行情况，主要分析CPU和内存多的进程，是一个综合了多方信息监测系统性能和运行信息的实用工具</strong><br> <img src="https://images2.imgbox.com/55/d4/663vdQpI_o.png" alt="在这里插入图片描述"><br> 字段含义如下表：<br> <img src="https://images2.imgbox.com/13/d0/m4LTaZco_o.png" alt="在这里插入图片描述"><br> <strong>（2）用netstat 网络 连接命令，分析可疑端口、可疑IP、可疑PID及程序进程</strong><br> netstat用于显示与IP、TCP、UDP和ICMP协议相关的统计数据，一般用于检验本机各端口的网络连接情况。选项参数如下：</p> 
<pre><code class="prism language-bash">-a 	显示所有连线中的Socket。 
-n  直接使用IP地址，而不通过域名服务器。
-t 	显示TCP传输协议的连线状况。
-u  显示UDP传输协议的连线状况。
-v  显示指令执行过程。
-p  显示正在使用Socket的程序识别码和程序名称。
-s  显示网络工作信息统计表。
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">netstat</span> –antlp <span class="token operator">|</span> <span class="token function">more</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/12/00/nuFX2gUw_o.png" alt="在这里插入图片描述"><br> 说明：</p> 
<pre><code class="prism language-bash">a） <span class="token string">"Recv-Q"</span>和<span class="token string">"Send-Q"</span>指的是接收队列和发送队列。
b） Proto显示连接使用的协议；RefCnt表示连接到本套接口上的进程号；Types显示套接口的类型；State显示套接口当前的状态；Path表示连接到套接口的其它进程使用的路径名。
c）  套接口类型：
-t	TCP
-u 	UDP
-raw   RAW类型
--unix  UNIX域类型
--ax25  AX25类型
--ipx    ipx类型
--netrom  netrom类型
d）状态说明：
LISTENING    侦听状态
ESTABLISHED  建立连接
CLOSE_WAIT   对方主动关闭连接或网络异常导致连接中断
</code></pre> 
<p>如图，可查看到本地mysql数据库有外部连接行为：<br> <img src="https://images2.imgbox.com/d9/27/86QJjZNO_o.png" alt="在这里插入图片描述"><br> <strong>（3）根据netstat 定位出的pid，使用ps命令，分析进程</strong></p> 
<pre><code class="prism language-bash">-a  	代表 all。同时加上x参数会显示没有控制终端的进程
-aux  	显示所有包含其他使用者的行程（ps -aux --sort -pcpu <span class="token operator">|</span> less根据cpt使用率进行排序）
-C 	  	显示某的进程的信息
-axjf   以树形结构显示进程
-e  	显示所有进程。和 -A 相同。
-f	  	额外全格式
-t 		ttylist by <span class="token function">tty</span> 	显示终端ID在ttylist列表中的进程
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> pid <span class="token operator">|</span> <span class="token function">grep</span> –v <span class="token function">grep</span>
</code></pre> 
<p>将netstat与ps 结合：<br> <img src="https://images2.imgbox.com/f3/15/4n82QARK_o.png" alt="在这里插入图片描述"><br> 先用neststat查看外联进程，然后使用ps命令查看对应进程信息及所在位置<br> <img src="https://images2.imgbox.com/c9/c4/bb55uDc4_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash"><span class="token function">netstat</span> -antlp
<span class="token function">ps</span> aux <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">40634</span>
</code></pre> 
<p>可以使用lsof -i:1677 查看指定端口对应的程序</p> 
<blockquote> 
 <p>lsof（list openfiles）是一个列出当前系统打开文件的工具。在linux环境下，任何事物都以文件的形式存在，通过文件不仅仅可以访问常规数据，还可以访问网络连接和硬件。所以如传输控制协议 (TCP) 和用户数据报协议 (UDP)套接字等，系统在后台都为该应用程序分配了一个文件描述符，无论这个文件的本质如何，该文件描述符为应用程序与基础操作系统之间的交互提供了通用接口。因为应用程序打开文件的描述符列表提供了大量关于这个应用程序本身的信息。</p> 
</blockquote> 
<pre><code class="prism language-bash"><span class="token function">lsof</span> filename 	显示打开指定文件的所有进程
</code></pre> 
<blockquote> 
 <p>lsof -i 用以显示符合条件的进程情况，在终端下输入lsof即可显示系统打开的文件，因为 lsof需要访问核心内存和各种文件，所以必须以 root 用户的身份运行它才能够充分地发挥其功能。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/92/58/YeruynDm_o.png" alt="在这里插入图片描述"><br> <strong>（4）使用ls 以及 stat 查看系统命令是否被替换</strong><br> 两种思路：<br> 1、查看命令目录最近的时间排序<br> 2、根据确定时间去匹配</p> 
<pre><code class="prism language-bash"><span class="token function">ls</span> -alt /usr/bin <span class="token operator">|</span> <span class="token function">head</span> -10
<span class="token function">ls</span> -al /bin /usr/bin /usr/sbin/ /sbin/ <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Jan 15"</span>
备注：如果日期数字<span class="token operator">&lt;</span><span class="token number">10</span>，中间需要两个空格。比如1月1日，grep “Jan <span class="token number">1</span>”
</code></pre> 
<p><img src="https://images2.imgbox.com/d9/d5/oJK7FkV9_o.png" alt="在这里插入图片描述"><br> （5）隐藏进程查看</p> 
<pre><code class="prism language-bash"><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print}'</span> <span class="token operator">|</span> <span class="token function">sort</span> -n <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token operator">&gt;</span><span class="token number">1</span>
<span class="token function">ls</span> /proc <span class="token operator">|</span> <span class="token function">sort</span> -n <span class="token operator">|</span><span class="token function">uniq</span> <span class="token operator">&gt;</span><span class="token number">2</span>
<span class="token function">diff</span> <span class="token number">1</span> <span class="token number">2</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1e/3e/VyDd4KFX_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="33_406"></a>3.3、系统信息排查</h3> 
<p><strong>（1）查看分析history ，曾经的命令操作痕迹，以便进一步排查溯源。运气好有可能通过记录关联到如下信息：</strong></p> 
<blockquote> 
 <p>a) wget 远程某主机（域名&amp;IP）的远控文件；<br> b) 尝试连接内网某主机（ssh scp），便于分析攻击者意图;<br> c) 打包某敏感数据或代码，tar zip 类命令<br> d) 对系统进行配置，包括命令修改、远控木马类，可找到攻击者关联信息…</p> 
</blockquote> 
<pre><code class="prism language-bash"><span class="token function">cat</span> /root/.bash_history
</code></pre> 
<p><img src="https://images2.imgbox.com/05/df/yBTnQzik_o.png" alt="在这里插入图片描述"></p> 
<p><strong>（2）查看分析用户相关分析</strong></p> 
<pre><code class="prism language-bash">a<span class="token punctuation">)</span> <span class="token function">useradd</span> <span class="token function">userdel</span> 的命令时间变化（stat），以及是否包含可疑信息
b<span class="token punctuation">)</span> <span class="token function">cat</span> /etc/passwd 分析可疑帐号，可登录帐号
查看<span class="token environment constant">UID</span>为0的帐号➜➜➜awk -F: <span class="token string">'{if($3==0)print $1}'</span> /etc/passwd
查看能够登录的帐号➜➜➜cat /etc/passwd <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">"/bin/bash$"</span>

PS：<span class="token environment constant">UID</span>为0的帐号也不一定都是可疑帐号，Freebsd默认存在toor帐号，且uid为0.（toor 在BSD官网解释为root替代帐号，属于可信帐号）；
</code></pre> 
<p><img src="https://images2.imgbox.com/7c/ba/stfowJlC_o.png" alt="在这里插入图片描述"><br> <strong>（3）查看分析任务计划</strong></p> 
<pre><code class="prism language-bash"><span class="token function">crontab</span> -u  <span class="token operator">&lt;</span>-l, -r, -e<span class="token operator">&gt;</span>
</code></pre> 
<blockquote> 
 <p>-u 指定一个用户<br> -l 列出某个用户的任务计划<br> -r 删除某个用户的任务<br> -e 编辑某个用户的任务（编辑的是/var/spool/cron下对应用户的cron文件，也可以直接修改/etc/crontab文件）</p> 
</blockquote> 
<p>通过crontab –l 查看当前的任务计划有哪些，是否有后门木马程序启动相关信息；<br> 查看etc目录任务计划相关文件，ls /etc/cron*<br> <img src="https://images2.imgbox.com/0c/2e/d3YBGEVx_o.png" alt="在这里插入图片描述"><br> <strong>（4）查看linux 开机启动程序</strong><br> 查看rc.local文件（/etc/init.d/rc.local /etc/rc.local）</p> 
<pre><code class="prism language-bash"><span class="token function">ls</span> –alt /etc/init.d/
</code></pre> 
<p><img src="https://images2.imgbox.com/cd/43/HXSamks2_o.png" alt="在这里插入图片描述"><br> <strong>（5）查看系统用户登录信息</strong><br> a）使用lastlog命令，系统中所有用户最近一次登录信息。<img src="https://images2.imgbox.com/b2/f1/ilu0Jo8S_o.png" alt="在这里插入图片描述"><br> b) 使用lastb命令，用于显示用户错误的登录列表；<br> <img src="https://images2.imgbox.com/8b/7a/b5mxUDYl_o.png" alt="在这里插入图片描述"></p> 
<p>c) 使用last命令，用于显示用户最近登录信息<br> <img src="https://images2.imgbox.com/c9/14/P3y09TSS_o.png" alt="在这里插入图片描述"><br> <strong>（6）系统路径分析</strong></p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token environment constant">$PATH</span> 
分析有无敏感可疑信息
</code></pre> 
<p><img src="https://images2.imgbox.com/91/a7/9wldTlu7_o.png" alt="在这里插入图片描述"><br> <strong>（7）查看ssh相关目录有无可疑的公钥存在</strong><br> Redis（6379） 未授权恶意入侵，即可直接通过redis到目标主机导入公钥；<br> 目录： /etc/ssh ./.ssh/</p> 
<h3><a id="34_468"></a>3.4、后门排查</h3> 
<p>通过文件内容中的危险函数，去找到网站中的web后门。最常见的Webshell文件内容中常见的恶意函数：</p> 
<blockquote> 
 <p>PHP<br> Eval、System、assert、……</p> 
 <p>JSP<br> getRunTime、 FileOutputStream、……</p> 
 <p>ASP<br> eval、execute、 ExecuteGlobal、……</p> 
</blockquote> 
<pre><code class="prism language-bash"><span class="token function">find</span> /var/www/html/ -type f -name  <span class="token string">'*.php'</span><span class="token operator">|</span><span class="token function">xargs</span> <span class="token function">grep</span> <span class="token string">'eval'</span> <span class="token operator">|</span><span class="token function">more</span>
</code></pre> 
<blockquote> 
 <p>除了通过grep去找webshell，我们还可以用类似 D盾之类的webshell查杀工具，把源码拖下来在本机查杀。<br> 有时候黑客在上传完webshell后门，获取到自己想要的信息后，就会删除掉webshell，又或者遇到了一些变形过的webshell后门，我们的关键字没有搜索到，这时候通过文件去找到webshell的方法就不适用了。那么这个时候就只能通过分析web日志，来找到黑客的webshell文件。直接分析web日志的最直接方式就是通过web日志中的特征来判断是否存在恶意的webshell后门，比如上面列表展示的这些常见webshell会传递的get参数。常见webshell后门日志特征如下：</p> 
</blockquote> 
<pre><code class="prism language-bash">Darkblade：goaction<span class="token operator">=</span>login
    JspSpy：o<span class="token operator">=</span>login
    PhpSpy：action<span class="token operator">=</span>phpinfo
    Regeorg： <span class="token assign-left variable">cmd</span><span class="token operator">=</span>connect
Other：cmd<span class="token operator">=</span>
</code></pre> 
<blockquote> 
 <p>不过这种方式能发现的问题不多，因为很多时候web后门接收参数的方式都是post，前面说了大部分中间件默认情况下只能记录get，如果需要记录post的话，就需要安装第三方模块。<br> Ps：常规黑客攻击流程，一个黑客通常通过web漏洞获取管理员密码进入后台，然后上传webshell，这个webshell文件在以前的访问记录是没有的，那么我们就可以通过统计每天访客所访问过的动态脚本文件，来列出每天新增加的文件入口的记录，快速查找webshell后门，最后我们可以根据统计低频访问的动态脚本文件，来找出可能是webshell的文件，因为一般来说webshell的访问ip只有几个，并且访问的次数也不多，那么根据这个分析模型，我们就可以发现可能是恶意的动态脚本文件。此排查需要懂一点了解编程，作为思路了解。</p> 
</blockquote> 
<h3><a id="35_497"></a>3.5、日志排查</h3> 
<blockquote> 
 <p>Linux系统拥有非常灵活和强大的日志功能，可以保存几乎所有的操作记录，并可以从中检索出我们需要的信息。大部分Linux发行版默认的日志守护进程为 syslog，位于 /etc/syslog 或 /etc/syslogd 或/etc/rsyslog.d，默认配置文件为 /etc/syslog.conf 或 rsyslog.conf，任何希望生成日志的程序都可以向 syslog 发送信息。<br> Linux系统内核和许多程序会产生各种错误信息、警告信息和其他的提示信息，这些信息对管理员了解系统的运行状态是非常有用的，所以应该把它们写到日志文件中去。完成这个过程的程序就是syslog。syslog可以根据日志的类别和优先级将日志保存到不同的文件中。</p> 
</blockquote> 
<p><strong>（1）日志类型</strong><br> 下面是和应急相关的常见日志类型，但并不是所有的Linux发行版都包含这些类型：<br> 类型 说明</p> 
<pre><code class="prism language-bash">auth		用户认证时产生的日志，如login命令、su命令。
authpriv	与 auth 类似，但是只能被特定用户查看。
console		针对系统控制台的消息。
<span class="token function">cron</span>		系统定期执行计划任务时产生的日志。
daemon		某些守护进程产生的日志。
<span class="token function">ftp</span>			FTP服务。
kern		系统内核消息。
mail		邮件日志。
mark		产生时间戳。系统每隔一段时间向日志文件中输出当前时间，每行的格式类似于 May <span class="token number">26</span> <span class="token number">11</span>:17:09 rs2 -- MARK --，可以由此推断系统发生故障的大概时间。
news		网络新闻传输协议<span class="token punctuation">(</span>nntp<span class="token punctuation">)</span>产生的消息。
ntp			网络时间协议<span class="token punctuation">(</span>ntp<span class="token punctuation">)</span>产生的消息。
user		用户进程。
</code></pre> 
<p><strong>（2）日志优先级：</strong></p> 
<pre><code class="prism language-bash">优先级	说明
emerg	紧急情况，系统不可用（例如系统崩溃），一般会通知所有用户。
alert	需要立即修复，例如系统数据库损坏。
crit	危险情况，例如硬盘错误，可能会阻碍程序的部分功能。
err		一般错误消息。
warning	警告。
notice	不是错误，但是可能需要处理。
info	通用性消息，一般用来提供有用信息。
debug	调试程序产生的信息。
none	没有优先级，不记录任何日志消息。
</code></pre> 
<p><strong>（3）常用日志文件</strong></p> 
<pre><code class="prism language-bash">日志目录					作用
/var/log/message	包括整体系统信息
/var/log/auth.log	包含系统授权信息，包括用户登录和使用的权限机制等
/var/log/userlog	记录所有等级用户信息的日志
/var/log/cron		记录crontab命令是否被正确的执行
/var/log/vsftpd.log	记录Linux FTP日志
/var/log/lastlog	记录登录的用户，可以使用命令lastlog查看
/var/log/secure		记录大多数应用输入的账号与密码，登录成功与否
var/log/wtmp		记录登录系统成功的账户信息，等同于命令last
var/log/faillog		记录登录系统不成功的账号信息，一般会被黑客删除
</code></pre> 
<h4><a id="351_545"></a>3.5.1、基于时间的日志管理</h4> 
<p>/var/log/wtmp是一个二进制文件，记录每个用户的登录次数和持续时间等信息；</p> 
<pre><code class="prism language-bash">last命令
last命令用于显示用户最近登录信息。单独执行last命令，它会读取/var/log/wtmp的文件，并把该给文件的内容记录的登入系统的用户名单全部显示出来；
-f:		<span class="token operator">&lt;</span>记录文件<span class="token operator">&gt;</span>：指定记录文件
-a：	把从何处登入系统的主机名称或ip地址，显示在最后一行
</code></pre> 
<p><img src="https://images2.imgbox.com/4e/d9/QZSskU25_o.png" alt="在这里插入图片描述"><br> /var/run/utmp</p> 
<pre><code class="prism language-bash">/var/run/utmp是一个二进制文件，记录当前登录系统的用户信息。
可用who命令显示当中的内容，Who的缺省输出包括用户名、终端类型、登录日期及远程主机；
</code></pre> 
<p><img src="https://images2.imgbox.com/6d/de/tX1WikBM_o.png" alt="在这里插入图片描述"><br> /var/log/lastlog(lastlog)</p> 
<pre><code class="prism language-bash">/var/log/lastlog记录用户最后登录的时间和登录终端的地址，可使用lastlog命令查看；
</code></pre> 
<p><img src="https://images2.imgbox.com/63/ea/1oUi8gYa_o.png" alt="在这里插入图片描述"><br> /var/log/btmp(lastb)</p> 
<pre><code class="prism language-bash">/var/log/btmp记录错误登录的日志，可使用lostb查看，有很多黑客试图使用密码字典登录ssh服务，可以使用此日志查看恶意ip试图登录次数；
</code></pre> 
<p>PS：登录日志可以关注Accepted、Failed password 、invalid特殊关键字；</p> 
<h4><a id="352_573"></a>3.5.2、系统日志管理</h4> 
<p>/var/log/secure</p> 
<blockquote> 
 <p>安全日志secure包含验证和授权方面信息，比如最常用的远程管理协议ssh，就会把所有授权信息都记录在这里。<br> 所以通过查看该日志，我们就能查看是否有人爆破ssh，通过查看存在过爆破记录的ip是否有成功登录的行为，我们就能知道是否有攻击者通过ssh暴力破解的方式成功攻击进来了。<br> 通过时间的纬度去判断，可以查看出是机器行为还是人为的，机器登录事件间隔特别密； 主要分析点：是否有ip爆破ssh成功</p> 
</blockquote> 
<p>定位有多少IP在爆破主机的root帐号：</p> 
<pre><code class="prism language-bash"><span class="token function">grep</span> <span class="token string">"Failed password for root"</span> /var/log/secure <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $11}'</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> -c <span class="token operator">|</span> <span class="token function">sort</span> -nr <span class="token operator">|</span> <span class="token function">more</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/bc/0d/63QEMYf5_o.png" alt="在这里插入图片描述"><br> 登录成功的IP有哪些：</p> 
<pre><code class="prism language-bash"><span class="token function">grep</span> <span class="token string">"Accepted "</span> /var/log/secure <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $11}'</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> -c <span class="token operator">|</span> <span class="token function">sort</span> -nr <span class="token operator">|</span> <span class="token function">more</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/71/cc/swVQBvSA_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="353_589"></a>3.5.3、中间件日志</h4> 
<blockquote> 
 <p>Web攻击的方法多种多样，但是默认情况下Web日志中所能记录的内容并不算丰富，最致命的是web日志是不会记录post内容的，想要从Web 日志中直接找出攻击者的webshell是非常难的，所以一般来说我们的分析思路都是先通过文件的方式找到webshell，然后再从日志里找到相应的攻击者ip，再去分析攻击者的整个攻击路径，来回溯攻击者的所有行为；<br> 但各种各样的原因，如黑客在入侵完了之后把webshell删除了，通过文件搜索的方式找不到webshell或者客户因为一些原因不能让你登录服务器上去排查，只能给你一份日志排查，导致我们只能通过分析web日志去发现webshell，比如这时候要排查的话，难度会稍大。Web日志主要分析access_log，本文以常见的中间件apache为例，其他中间件日志格式和分析思路大同小异；<br> Apache默认自动生成两个日志文件，访问日志access_log和error_log；</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/12/3b/ka7E714Y_o.png" alt="在这里插入图片描述"><br> 在url中视图搜索所有关键词为“union”的请求，可以发现172.24.123.120在尝试SQL注入，类似，通过通过特殊的关键词搜索web攻击。如/etc/passwd，alert等。但单凭web日志无法判断攻击者是否攻击成功了，只能知道攻击者在尝试攻击；<br> <img src="https://images2.imgbox.com/c9/e9/m9W9ynIP_o.png" alt="在这里插入图片描述"><br> 查询访问量前十的IP地址：<br> <img src="https://images2.imgbox.com/d0/e8/Z7rplJt9_o.png" alt="在这里插入图片描述"><br> 查询访问量前十的URL：<br> <img src="https://images2.imgbox.com/47/a7/UWOIPK74_o.png" alt="在这里插入图片描述"><br> 在对WEB日志进行安全分析时，可以按照下面两种思路展开，逐步深入，还原整个攻击过程；<br> 1）首先确定受到攻击、入侵的时间范围，以此为线索，查找这个时间范围内可疑的日志，进一步排查，最终确定攻击者，还原攻击过程；<br> <img src="https://images2.imgbox.com/73/d9/qRBC8qHQ_o.png" alt="在这里插入图片描述"><br> 2）一般攻击者在入侵网站后，通常会上传一个后门文件，以方便自己以后访问。我们也可以以该文件为线索来展开分析；<br> <img src="https://images2.imgbox.com/33/41/XU2x6O4F_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="354_607"></a>3.5.4、数据库日志</h4> 
<p>数据库日志以常用的数据库Mysql数据库为例。Mysql数据库有五种日志，错误日志、查询日志、慢查询日志、更新日志、二进制日志，重点关注查询日志；<br> 查看是否开启查询日志：<br> <img src="https://images2.imgbox.com/4c/53/gAshxQyI_o.png" alt="在这里插入图片描述"><br> 查看数据库文件：路径为/var/log/mysql/，记录一次数据库的连接、查询和退出中间的数据库操作；<br> <img src="https://images2.imgbox.com/7a/87/Lucx94A6_o.png" alt="在这里插入图片描述"><br> 在查询语句中搜索所有关键词为“union”的请求，可以发现172.24.123.120在尝试SQL注入，类似，通过通过特殊的关键词搜索有无敏感的数据库操作。如读取/etc/passwd敏感文件，写webshsll等；<br> <img src="https://images2.imgbox.com/57/d1/wZjZvn3e_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="356_615"></a>3.5.6、相关处置</h4> 
<p>通过网络连接锁定的可疑进程，进行定位恶意程序后删除(kill)：</p> 
<pre><code class="prism language-bash"><span class="token function">kill</span> -9
</code></pre> 
<p>对设定文件不能删除、改名等权限，移除该权限：</p> 
<pre><code class="prism language-bash">chattr –i
</code></pre> 
<p>对发现的webshell和恶意文件进行删除：</p> 
<pre><code class="prism language-bash"><span class="token function">rm</span> –rfv
</code></pre> 
<h2><a id="4_628"></a>4、实际案例分析</h2> 
<h3><a id="41_629"></a>4.1、案例：信息泄露</h3> 
<p>（1）事件概述<br> 某厂商公网一台服务器被通告与APT组织木马关联并接收其它组织单位的被盗数据。<br> （2）事件分析</p> 
<blockquote> 
 <p>1）通过VNC远程访问服务器，查看当前连接状态，并未发现异常连接：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/43/5b/6zfDZtWQ_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>2）经与客户确认,该服务器为公网提供FTP服务,但本身没有做SNAT不允许主动连接互联网,确认没有异常外连行为。<br> 继续排查FTP日志,发现用户”reuter02”存在不同IP的登录行为,”124.74.64.38”该IP归属地为上海,经与用户确认该账户不应该出现本次登录行为,继续过滤该IP对应的所有用户登录,发现该IP还登录过”as_reporter01”这个用户:</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/28/3b/MKHZuoJH_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>3）分别针对这两个用户查看对应的上传日志和所对应的上传目录发现”as_reporter01”用户的非标准上传目录中存在大量文件,其中包含敏感信息：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/10/e2/CWTC0zm6_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>4）其中一个文件” FBBLCKICXE-log-(02.01.18-05.10.41)” 这些包含系统敏感信息的文件即为通告中的”被盗数据”，内容如下：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/45/16/b9r7lcJw_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>（3）结论<br> 经通过对服务器日志分析，判断本次事件主要用于服务器FTP用户口令泄漏，导致攻击者利用服务器FTP空间作为信息收集(盗取数据)的存储媒介。和管理员继续分析，为保证客户业务系统安全运行，并为客户提供相关处置建议：<br> a) 修改FTP用户”reuter02”、”as_reporter01”的用户口令<br> b) 禁止服务器主动发起外部连接请求，对于需要向外部服务器推送共享数据的，应使用白名单的方式，在出口防火墙加入相关策略，对主动连接IP范围进行限制；</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/15ae11e00f579e0aed0ef307992dc696/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">HTTP首部（下）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b2ab533805275f3b4748ae8757361e30/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">项目实战系列之解决Mybatis-plus利用collection查询一对多分页数据的Bug【一】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>