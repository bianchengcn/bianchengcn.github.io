<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>qt实现播放视屏的时候，加载外挂字幕(.srt文件解析) - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="qt实现播放视屏的时候，加载外挂字幕(.srt文件解析)" />
<meta property="og:description" content="之前用qt写了一个在windows下播放视频的软件，具体介绍参见qt编写的视频播放器，windows下使用，精致小巧_GreenHandBruce的博客-CSDN博客
后来发现有些视频没有内嵌字幕，需要外挂字幕，这时候，我就想着把加载外挂字幕的功能加上。如下图：
这里先做了解析.srt字幕文件的功能。具体实现如下
1.先在窗口放一个label，将label调整到界面底部，设置字体，颜色
//显示字幕用的label; labelSubTitle = new myLabel(this); // labelSubTitle-&gt;setText(&#34;这里显示字幕文件&#34;); QFont font(&#34;微软雅黑&#34;,15,QFont::Bold); QPalette palette = labelSubTitle-&gt;palette(); palette.setColor(QPalette::WindowText,Qt::white); labelSubTitle-&gt;setPalette(palette); labelSubTitle-&gt;setFont(font); labelSubTitle-&gt;setAlignment(Qt::AlignCenter); 2.在打开视频文件的时候找到同文件夹下的.srt文件
int nIndex = fileName.lastIndexOf(&#39;.&#39;);//寻找‘.’符号在字符串中的id nIndex&#43;&#43;; QString srtfile =fileName.mid(0,nIndex); //截取‘.’符号后面的字符串，这是为了获取文件后缀名 srtfile &#43;=&#34;srt&#34;; EncodingFormat code = FileCharacterEncoding(srtfile); QFile file(srtfile); if(!file.open(QIODevice::ReadOnly)) { qDebug()&lt;&lt;&#34;未找到外挂字幕文件：&#34;&lt;&lt;srtfile&lt;&lt;endl; } 3.解析.srt文件，先看一下.srt字幕文件格式如下：
然后写个结构体用来存放解析之后的srt内容，如下：
struct SrtInfo { qint16 Num; QTime dtStart; QTime dtEnd; QString strSubTitle; }; 然后解析，在解析的时候要注意.srt的编码格式，（编码格式这块参见我上一篇文章qt按照不同编码格式读取文字(UTF-16LE,UTF-8,UTF-8BOM,UTF-16BE)-CSDN博客）
void VideoPlayer::ParseSubTitle(QString fileName) { int nIndex = fileName.lastIndexOf(&#39;.&#39;);//寻找‘.’符号在字符串中的id nIndex&#43;&#43;; QString srtfile =fileName." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/9d80a58caa73e3df6d0631f801746b8c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-24T11:23:21+08:00" />
<meta property="article:modified_time" content="2023-11-24T11:23:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">qt实现播放视屏的时候，加载外挂字幕(.srt文件解析)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>之前用qt写了一个在windows下播放视频的软件，具体介绍参见<a href="https://blog.csdn.net/weixin_43935474/article/details/130236486?spm=1001.2014.3001.5502" title="qt编写的视频播放器，windows下使用，精致小巧_GreenHandBruce的博客-CSDN博客">qt编写的视频播放器，windows下使用，精致小巧_GreenHandBruce的博客-CSDN博客</a></p> 
<p>后来发现有些视频没有内嵌字幕，需要外挂字幕，这时候，我就想着把加载外挂字幕的功能加上。如下图：</p> 
<p><img alt="" height="336" src="https://images2.imgbox.com/18/b0/x3wOd6K1_o.png" width="598"></p> 
<p>这里先做了解析.srt字幕文件的功能。具体实现如下</p> 
<p>1.先在窗口放一个label，将label调整到界面底部，设置字体，颜色</p> 
<pre><code class="language-cpp">//显示字幕用的label;
    labelSubTitle = new myLabel(this);
//    labelSubTitle-&gt;setText("这里显示字幕文件");
    QFont font("微软雅黑",15,QFont::Bold);
    QPalette palette = labelSubTitle-&gt;palette();
    palette.setColor(QPalette::WindowText,Qt::white);
    labelSubTitle-&gt;setPalette(palette);
    labelSubTitle-&gt;setFont(font);
    labelSubTitle-&gt;setAlignment(Qt::AlignCenter);</code></pre> 
<p>2.在打开视频文件的时候找到同文件夹下的.srt文件</p> 
<p><img alt="" height="176" src="https://images2.imgbox.com/ed/3c/msIEr808_o.png" width="391"></p> 
<pre><code class="language-cpp">    int nIndex = fileName.lastIndexOf('.');//寻找‘.’符号在字符串中的id
    nIndex++;
    QString srtfile =fileName.mid(0,nIndex); //截取‘.’符号后面的字符串，这是为了获取文件后缀名
    srtfile +="srt";
    EncodingFormat code = FileCharacterEncoding(srtfile);
    QFile file(srtfile);
    if(!file.open(QIODevice::ReadOnly)) {
        qDebug()&lt;&lt;"未找到外挂字幕文件："&lt;&lt;srtfile&lt;&lt;endl;
    }</code></pre> 
<p>3.解析.srt文件，先看一下.srt字幕文件格式如下：</p> 
<p><img alt="" height="507" src="https://images2.imgbox.com/c4/0d/MA7Wm4JB_o.png" width="477"><br> 然后写个结构体用来存放解析之后的srt内容，如下：</p> 
<pre><code class="language-cpp">struct SrtInfo
{
    qint16 Num;
    QTime dtStart;
    QTime dtEnd;
    QString strSubTitle;
};</code></pre> 
<p>然后解析，在解析的时候要注意.srt的编码格式，（编码格式这块参见我上一篇文章<a href="https://blog.csdn.net/weixin_43935474/article/details/134580005?spm=1001.2014.3001.5502" title="qt按照不同编码格式读取文字(UTF-16LE,UTF-8,UTF-8BOM,UTF-16BE)-CSDN博客">qt按照不同编码格式读取文字(UTF-16LE,UTF-8,UTF-8BOM,UTF-16BE)-CSDN博客</a>）</p> 
<pre><code class="language-cpp">void VideoPlayer::ParseSubTitle(QString fileName)
{
    int nIndex = fileName.lastIndexOf('.');//寻找‘.’符号在字符串中的id
    nIndex++;
    QString srtfile =fileName.mid(0,nIndex); //截取‘.’符号后面的字符串，这是为了获取文件后缀名
    srtfile +="srt";
    EncodingFormat code = FileCharacterEncoding(srtfile);
    QFile file(srtfile);
    if(!file.open(QIODevice::ReadOnly)) {
        qDebug()&lt;&lt;"未找到外挂字幕文件："&lt;&lt;srtfile&lt;&lt;endl;
    }
    m_SrtInfoLst.clear();
    QTextCodec::ConverterState state;
    QTextCodec *codec = QTextCodec::codecForName("UTF-8");
    if(code==EncodingFormat::UTF16LE)
    {
        codec = QTextCodec::codecForName("UTF-16LE");
    }
    else if(code==EncodingFormat::UTF8)
    {
        codec = QTextCodec::codecForName("UTF-8");
    }
    else if(code==EncodingFormat::UTF8BOM)
    {
        codec = QTextCodec::codecForName("UTF-8");
    }
    else if(code==EncodingFormat::UTF16BE)
    {
        codec = QTextCodec::codecForName("UTF-16BE");
    }
    QTextStream stream_src(&amp;file);
    stream_src.setCodec(codec);
    while(!stream_src.atEnd()) {
        QString str = stream_src.readLine();
        str = str.replace('\r',"");//替换回车符
        str = str.replace('\n',"");//替换换行符
        bool ok;
        qint16 nID = str.toInt(&amp;ok,10);
        if(ok)
        {
            SrtInfo info;
            info.Num = nID;
            if(stream_src.atEnd())
                break;
            QString str2=stream_src.readLine();
            str2 = str2.replace('\r',"");//替换回车符
            str2 = str2.replace('\n',"");//替换换行符
            str2 = str2.replace(' ',"");//替换空格符
            if(str2=="")
                continue;
            info.dtStart = QTime::fromString(str2.split('-').first(),"hh:mm:ss,zzz");
            info.dtEnd = QTime::fromString(str2.split('&gt;').last(),"hh:mm:ss,zzz");

            QString str3=stream_src.readLine();
            if(str3=="")
                continue;
            str3 = str3.replace('\r',"");//替换回车符
            str3 = str3.replace('\n',"");//替换换行符
            info.strSubTitle = str3;

            QString str4=stream_src.readLine();
            if(str4=="")
                continue;
            str4 = str4.replace('\r',"");//替换回车符
            str4 = str4.replace('\n',"");//替换换行符
            info.strSubTitle.append('\n');
            info.strSubTitle.append(str4);

            m_SrtInfoLst.append(info);
        }
    }
    file.close();
}</code></pre> 
<p>然后就是在播放视频的时候，找到当前时刻对应的字幕并显示在label上，如下：</p> 
<pre><code class="language-cpp">void VideoPlayer::positionChanged(qint64 position)
{
    m_positionSlider-&gt;setValue(position);
    QTime timeCrt = QTime(0,0,0);
    timeCrt = timeCrt.addMSecs(position);
    QTime timeTotal =QTime(0,0,0);
    timeTotal = timeTotal.addMSecs(m_mediaPlayer-&gt;duration());
    QString str = timeCrt.toString("hh:mm:ss")+"/"+timeTotal.toString("hh:mm:ss");
//    m_labelTiem-&gt;setFont(QFont::gra);
    m_labelTiem-&gt;setText(str);
    if(m_mediaPlayer-&gt;duration()&gt;0&amp;&amp;position&gt;=m_mediaPlayer-&gt;duration())
    {
        //图标变成play
        QImage img;
        img.load(":/play");
        m_labelPlay-&gt;setPixmap(QPixmap::fromImage(img));
    }
    bool bShow = false;
    foreach(const SrtInfo item,m_SrtInfoLst)
    {
        if(item.dtStart&lt;timeCrt &amp;&amp; item.dtEnd&gt;timeCrt)
        {
            labelSubTitle-&gt;setText(item.strSubTitle);
            bShow = true;
            break;
        }
    }
    if(!bShow)
    {
        labelSubTitle-&gt;setText("");
    }
}</code></pre> 
<p>完整代码参见</p> 
<p><a href="https://download.csdn.net/download/weixin_43935474/88561361" title="https://download.csdn.net/download/weixin_43935474/88561361">https://download.csdn.net/download/weixin_43935474/88561361</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/487171f0aab3ebdd7816cc1a1d671e10/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SQL 常见函数整理 _ DATEPART() 从日期时间表达式中提取指定的日期部分</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/48896e1faa336a5e1f5eff5cbd88f7e2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Anaconda（4.2.0）和Tensorflow（2.9.1）安装教程（使用中科大镜像，清华镜像没有tensorflow了）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>