<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【stm32单片机基础】按键状态机实现长按和短按 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【stm32单片机基础】按键状态机实现长按和短按" />
<meta property="og:description" content="【stm32单片机基础】按键状态机 文章目录 【stm32单片机基础】按键状态机前言一、按键的消抖二、按键状态机实现0.状态机模式1.单个按键检测2.单个按键实现长按和短按 三、长按和短按测试示例四 、多按键检测按键处理经典例程：总结 前言 在单片机的教学例程中，常使用delay延迟的方式消除按键抖动，而delay延迟的方式使CPU处于空等的状态，不能进行其他任务，直到结束delay延时函数，这种阻塞的方式不利于多任务的情形。本文将使用非阻塞的方式消抖，并采用状态机的模式编写按键处理函数。 一、按键的消抖 按键消抖：通常的按键所用开关为机械弹性开关，当机械触点断开、闭合时，由于机械触点的弹性作用，一个按键开关在闭合时不会马上稳定地接通，在断开时也不会一下子断开，因而在闭合及断开的瞬间均伴随有一连串的抖动，按键抖动会引起一次按键被误读多次。
抖动时间的长短由按键的机械特性决定，一般为5ms～10ms。
软件消抖：硬件方法将导致系统硬件电路设计复杂化，常采用软件方法进行消抖。
软件方法去抖，即检测出键闭合后执行一个延时程序，5ms～10ms的延时，让前沿抖动消失后再一次检测键的状态，如果仍保持闭合状态电平，则确认为真正有键按下。
二、按键状态机实现 0.状态机模式 简单理解为：将一个事件划分为有限个状态，满足相应的条件，在有限个状态之间跳转；可以使用状态图来描述事件处理过程，这种方式使得程序逻辑思路更加清晰严谨。以按键为例，按键检测的过程可以分为三个状态：按键检测状态、按键确认状态、按键释放状态；而在这三个状态之间跳转的条件为当前状态下按键的值。
在单片机中实现状态机最常用的语句便是switch case语句。
【状态机中如何非阻塞消抖】：使用定时器中断，定时每10ms执行一次switch case语句，即两个状态之间跳转的时间为10ms，这样便代替了delay延时。当定时中断发生时，才跳转到中断服务函数执行。
1.单个按键检测 独立按键电路
单个按键的状态转移图如下：
S1状态为按键检测，S2为按键确认，S3为释放按键；状态跳转条件为当前状态下读取到的按键高低电平Key，当Result为1时，表示按键已经成功按下。
单个按键检测的代码实现：
#ifdef SingleKeyEvent typedef enum { KEY_CHECK = 0, KEY_COMFIRM = 1, KEY_RELEASE = 2 }KEY_STATE; KEY_STATE KeyState =KEY_CHECK; // 初始化按键状态为检测状态 u8 g_KeyFlag = 0; // 按键有效标志，0： 按键值无效； 1：按键值有效 /** * 单个按键检测事件 * 功能：使用状态机方式，扫描单个按键；扫描周期为10ms,10ms刚好跳过抖动； * 状态机使用switch case语句实现状态之间的跳转 * */ void Key_Scan(void) { switch (KeyState) { //按键未按下状态，此时判断Key的值 case KEY_CHECK: if(!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/81883fb260a458b27584c499b338d524/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-30T23:48:04+08:00" />
<meta property="article:modified_time" content="2022-06-30T23:48:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【stm32单片机基础】按键状态机实现长按和短按</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="stm32_0"></a>【stm32单片机基础】按键状态机</h2> 
<font color="#999AAA"> </font> 
<hr color="#000000" size='1"'> 
<font color="#999AAA"> </font> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#stm32_0" rel="nofollow">【stm32单片机基础】按键状态机</a></li><li><a href="#_13" rel="nofollow">前言</a></li><li><a href="#_22" rel="nofollow">一、按键的消抖</a></li><li><a href="#_32" rel="nofollow">二、按键状态机实现</a></li><li><ul><li><a href="#0_33" rel="nofollow">0.状态机模式</a></li><li><a href="#1_39" rel="nofollow">1.单个按键检测</a></li><li><a href="#2_103" rel="nofollow">2.单个按键实现长按和短按</a></li></ul> 
  </li><li><a href="#_262" rel="nofollow">三、长按和短按测试示例</a></li><li><a href="#__360" rel="nofollow">四 、多按键检测</a></li><li><a href="#_469" rel="nofollow">按键处理经典例程：</a></li><li><a href="#_635" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="_13"></a>前言</h2> 
<font color="#999AAA"> 在单片机的教学例程中，常使用delay延迟的方式消除按键抖动，而delay延迟的方式使CPU处于空等的状态，不能进行其他任务，直到结束delay延时函数，这种阻塞的方式不利于多任务的情形。本文将使用非阻塞的方式消抖，并采用状态机的模式编写按键处理函数。</font> 
<hr color="#000000" size='1"'> 
<h2><a id="_22"></a>一、按键的消抖</h2> 
<p><strong>按键消抖</strong>：通常的按键所用开关为机械弹性开关，当机械触点断开、闭合时，由于机械触点的弹性作用，一个按键开关在闭合时不会马上稳定地接通，在断开时也不会一下子断开，因而在闭合及断开的瞬间均伴随有一连串的抖动，按键抖动会引起一次按键被误读多次。</p> 
<p><img src="https://images2.imgbox.com/30/f5/5GHG1W4R_o.png" alt="在这里插入图片描述"><br> <strong>抖动时间的长短由按键的机械特性决定，一般为5ms～10ms</strong>。</p> 
<p><strong>软件消抖</strong>：硬件方法将导致系统硬件电路设计复杂化，常采用软件方法进行消抖。</p> 
<blockquote> 
 <p>软件方法去抖，即检测出键闭合后执行一个延时程序，5ms～10ms的延时，让前沿抖动消失后再一次检测键的状态，如果仍保持闭合状态电平，则确认为真正有键按下。</p> 
</blockquote> 
<h2><a id="_32"></a>二、按键状态机实现</h2> 
<h3><a id="0_33"></a>0.状态机模式</h3> 
<p>简单理解为：将一个事件划分为有限个状态，满足相应的条件，在有限个状态之间跳转；可以使用状态图来描述事件处理过程，这种方式使得程序逻辑思路更加清晰严谨。以按键为例，按键检测的过程可以分为三个状态：按键检测状态、按键确认状态、按键释放状态；而在这三个状态之间跳转的条件为当前状态下按键的值。<br> 在单片机中实现状态机最常用的语句便是switch case语句。</p> 
<blockquote> 
 <p>【状态机中如何非阻塞消抖】：使用定时器中断，定时每10ms执行一次switch case语句，即两个状态之间跳转的时间为10ms，这样便代替了delay延时。当定时中断发生时，才跳转到中断服务函数执行。</p> 
</blockquote> 
<h3><a id="1_39"></a>1.单个按键检测</h3> 
<p>独立按键电路<br> <img src="https://images2.imgbox.com/c0/e9/Q6nwlEF7_o.png" alt="按键"><br> 单个按键的状态转移图如下：<br> S1状态为按键检测，S2为按键确认，S3为释放按键；状态跳转条件为当前状态下读取到的按键高低电平Key，当Result为1时，表示按键已经成功按下。<br> <img src="https://images2.imgbox.com/9d/39/wGtHBXZj_o.jpg" alt="在这里插入图片描述"></p> 
<p><font color="#999AAA">单个按键检测的代码实现：</font></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SingleKeyEvent </span></span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{<!-- --></span>
    KEY_CHECK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    KEY_COMFIRM <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    KEY_RELEASE <span class="token operator">=</span> <span class="token number">2</span> 
<span class="token punctuation">}</span>KEY_STATE<span class="token punctuation">;</span>

KEY_STATE KeyState <span class="token operator">=</span>KEY_CHECK<span class="token punctuation">;</span>  <span class="token comment">// 初始化按键状态为检测状态</span>
u8 g_KeyFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                 <span class="token comment">// 按键有效标志，0： 按键值无效； 1：按键值有效</span>
<span class="token comment">/**
 * 单个按键检测事件
 * 功能：使用状态机方式，扫描单个按键；扫描周期为10ms,10ms刚好跳过抖动；
 * 状态机使用switch case语句实现状态之间的跳转
 * 
 */</span>
<span class="token keyword">void</span> <span class="token function">Key_Scan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>KeyState<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//按键未按下状态，此时判断Key的值</span>
        <span class="token keyword">case</span>   KEY_CHECK<span class="token operator">:</span>    
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Key<span class="token punctuation">)</span>   
            <span class="token punctuation">{<!-- --></span>
                KeyState <span class="token operator">=</span>  KEY_COMFIRM<span class="token punctuation">;</span>  <span class="token comment">//如果按键Key值为0，说明按键开始按下，进入下一个状态</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token comment">//按键按下状态：</span>
        <span class="token keyword">case</span>   KEY_COMFIRM<span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Key<span class="token punctuation">)</span>                     <span class="token comment">//查看当前Key是否还是0，再次确认是否按下</span>
            <span class="token punctuation">{<!-- --></span>
                KeyState <span class="token operator">=</span>  KEY_RELEASE<span class="token punctuation">;</span>  <span class="token comment">//进入下一个释放状态</span>
                g_KeyFlag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>           <span class="token comment">//按键有效值为1, 按键确认按下，按下就执行按键任务；        </span>
            <span class="token punctuation">}</span>   
            <span class="token keyword">else</span>                         <span class="token comment">//当前Key值为1，确认为抖动，则返回上一个状态</span>
            <span class="token punctuation">{<!-- --></span>
                KeyState <span class="token operator">=</span>  KEY_CHECK<span class="token punctuation">;</span>      <span class="token comment">//返回上一个状态</span>
            <span class="token punctuation">}</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token comment">//按键释放状态</span>
         <span class="token keyword">case</span>  KEY_RELEASE<span class="token operator">:</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>Key<span class="token punctuation">)</span>                     <span class="token comment">//当前Key值为1，说明按键已经释放，返回开始状态</span>
             <span class="token punctuation">{<!-- --></span> 
                 KeyState <span class="token operator">=</span>  KEY_CHECK<span class="token punctuation">;</span>
               <span class="token comment">//  g_KeyFlag = 1;        //如果置于此，则在按键释放状态后，才执行按键任务；</span>
             <span class="token punctuation">}</span> 
             <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="2_103"></a>2.单个按键实现长按和短按</h3> 
<p>单个按键实现短按和长按是个很常用的方式，区别单个按键是否是长按和短按依靠检测按键按下的持续时间。</p> 
<blockquote> 
 <p>此处将短按时间T设为 10ms &lt; T &lt;1 s；长按时间的T设置为：T &gt; 1s.</p> 
</blockquote> 
<p>在上面的按键实现基础上可继续实现长按和短按判断，具体程序如下：</p> 
<p><font color="#999AAA">代码如下（示例）：</font></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SingleKey_LongShort_Event </span></span>
<span class="token comment">/**
 * 单个按键检测短按和长按事件
 * 短按：时间 10ms &lt; T &lt; 1 s, 长按：时间 T &gt;1 s
 * 功能：使用状态机方式，扫描单个按键；扫描周期为10ms,10ms刚好跳过抖动；
 * 状态机使用switch case语句实现状态之间的跳转
 * lock变量用于判断是否是第一次进行按键确认状态
 * ：按键释放后才执行按键事件
 */</span>
<span class="token keyword">void</span> <span class="token function">Key_Scan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> u8 TimeCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> u8 lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>KeyState<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//按键未按下状态，此时判断Key的值</span>
        <span class="token keyword">case</span>   KEY_CHECK<span class="token operator">:</span>    
           <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Key<span class="token punctuation">)</span>   
            <span class="token punctuation">{<!-- --></span>
                KeyState <span class="token operator">=</span>  KEY_COMFIRM<span class="token punctuation">;</span>  <span class="token comment">//如果按键Key值为0，说明按键开始按下，进入下一个状态 </span>
            <span class="token punctuation">}</span>
            TimeCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                  <span class="token comment">//计数复位</span>
            lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">case</span>   KEY_COMFIRM<span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Key<span class="token punctuation">)</span>                     <span class="token comment">//查看当前Key是否还是0，再次确认是否按下</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">)</span>   lock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
               
                TimeCnt<span class="token operator">++</span><span class="token punctuation">;</span>   
                               
            <span class="token punctuation">}</span>   
            <span class="token keyword">else</span>                       
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span>                <span class="token comment">// 不是第一次进入，  释放按键才执行</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/*按键时长判断*/</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>TimeCnt <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span>            <span class="token comment">// 长按 1 s</span>
                    <span class="token punctuation">{<!-- --></span>
                        g_KeyActionFlag <span class="token operator">=</span> LONG_KEY<span class="token punctuation">;</span>
                        TimeCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>                         <span class="token comment">// Key值变为了1，说明此处动作为短按</span>
                    <span class="token punctuation">{<!-- --></span>
                        g_KeyActionFlag <span class="token operator">=</span> SHORT_KEY<span class="token punctuation">;</span>          <span class="token comment">// 短按</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">/*按键时长判断*/</span>
                    
                    KeyState <span class="token operator">=</span>  KEY_RELEASE<span class="token punctuation">;</span>    <span class="token comment">// 需要进入按键释放状态 </span>
                <span class="token punctuation">}</span>
                
                <span class="token keyword">else</span>                          <span class="token comment">// 当前Key值为1，确认为抖动，则返回上一个状态</span>
                <span class="token punctuation">{<!-- --></span>
                    KeyState <span class="token operator">=</span>  KEY_CHECK<span class="token punctuation">;</span>    <span class="token comment">// 返回上一个状态</span>
                <span class="token punctuation">}</span>
               
            <span class="token punctuation">}</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            
         <span class="token keyword">case</span>  KEY_RELEASE<span class="token operator">:</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>Key<span class="token punctuation">)</span>                     <span class="token comment">//当前Key值为1，说明按键已经释放，返回开始状态</span>
             <span class="token punctuation">{<!-- --></span> 
                 KeyState <span class="token operator">=</span>  KEY_CHECK<span class="token punctuation">;</span>    
             <span class="token punctuation">}</span>
             <span class="token keyword">break</span><span class="token punctuation">;</span>
             
         <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre> 
<hr color="#000000" size='1"'> 
<p>按键释放之后，才检测不太合理，做如下调整，长按事件需要达到时长就执行，短按可以在按键释放后执行。</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * 单个按键检测短按和长按事件
 * 短按：时间 10ms &lt; T &lt; 1 s, 长按：时间 T &gt;1 s
 * 功能：使用状态机方式，扫描单个按键；扫描周期为10ms,10ms刚好跳过抖动；
 * 状态机使用switch case语句实现状态之间的跳转
 * lock变量用于判断是否是第一次进行按键确认状态
 * ：长按键事件提前执行，短按键事件释放后才执行
 */</span>
<span class="token keyword">void</span> <span class="token function">Key_Scan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> u8 TimeCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> u8 lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>KeyState<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//按键未按下状态，此时判断Key的值</span>
        <span class="token keyword">case</span>   KEY_CHECK<span class="token operator">:</span>    
           <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Key<span class="token punctuation">)</span>   
            <span class="token punctuation">{<!-- --></span>
                KeyState <span class="token operator">=</span>  KEY_COMFIRM<span class="token punctuation">;</span>  <span class="token comment">//如果按键Key值为0，说明按键开始按下，进入下一个状态 </span>
            <span class="token punctuation">}</span>
            TimeCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                  <span class="token comment">//计数复位</span>
            lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">case</span>   KEY_COMFIRM<span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Key<span class="token punctuation">)</span>                     <span class="token comment">//查看当前Key是否还是0，再次确认是否按下</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">)</span>   lock <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
               
                TimeCnt<span class="token operator">++</span><span class="token punctuation">;</span>  
                
                <span class="token comment">/*按键时长判断*/</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>TimeCnt <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span>            <span class="token comment">// 长按 1 s</span>
                <span class="token punctuation">{<!-- --></span>
                    g_KeyActionFlag <span class="token operator">=</span> LONG_KEY<span class="token punctuation">;</span>
                    TimeCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
                    lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>               <span class="token comment">//重新检查</span>
                    KeyState <span class="token operator">=</span>  KEY_RELEASE<span class="token punctuation">;</span>    <span class="token comment">// 需要进入按键释放状态</span>
                <span class="token punctuation">}</span>                
                               
            <span class="token punctuation">}</span>   
            <span class="token keyword">else</span>                       
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">==</span>lock<span class="token punctuation">)</span>                <span class="token comment">// 不是第一次进入，  释放按键才执行</span>
                <span class="token punctuation">{<!-- --></span>

                    g_KeyActionFlag <span class="token operator">=</span> SHORT_KEY<span class="token punctuation">;</span>          <span class="token comment">// 短按</span>
                    KeyState <span class="token operator">=</span>  KEY_RELEASE<span class="token punctuation">;</span>    <span class="token comment">// 需要进入按键释放状态 </span>
                <span class="token punctuation">}</span>
                
                <span class="token keyword">else</span>                          <span class="token comment">// 当前Key值为1，确认为抖动，则返回上一个状态</span>
                <span class="token punctuation">{<!-- --></span>
                    KeyState <span class="token operator">=</span>  KEY_CHECK<span class="token punctuation">;</span>    <span class="token comment">// 返回上一个状态</span>
                <span class="token punctuation">}</span>
       
            <span class="token punctuation">}</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            
         <span class="token keyword">case</span>  KEY_RELEASE<span class="token operator">:</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>Key<span class="token punctuation">)</span>                     <span class="token comment">//当前Key值为1，说明按键已经释放，返回开始状态</span>
             <span class="token punctuation">{<!-- --></span> 
                 KeyState <span class="token operator">=</span>  KEY_CHECK<span class="token punctuation">;</span>    
             <span class="token punctuation">}</span>
             <span class="token keyword">break</span><span class="token punctuation">;</span>
             
         <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_262"></a>三、长按和短按测试示例</h2> 
<p><strong>头文件</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/**
  * 使用定时器来轮询Key_Scan()函数，定时节拍为2ms,
  * 状态转换时间为10ms,即每次进入switch case语句的时间差为10ms
  * 利用该10ms的间隙跳过按键抖动
  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__BUTTON_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__BUTTON_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token comment">//按键对应的IO管脚 KEY1  PA.15</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_IO_RCC</span>        <span class="token expression">RCC_APB2Periph_GPIOA      </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_IO_PORT</span>       <span class="token expression">GPIOA</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_IO_PIN</span>        <span class="token expression">GPIO_Pin_15</span></span>

<span class="token comment">//Key: 1:高电平，按键未按下， 0：低电平，按键按下</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Key</span>  <span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>KEY_IO_PORT<span class="token punctuation">,</span>KEY_IO_PIN<span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{<!-- --></span>
    KEY_CHECK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    KEY_COMFIRM <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    KEY_RELEASE <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>KEY_STATE<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span> 
<span class="token punctuation">{<!-- --></span>
    NULL_KEY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    SHORT_KEY <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
    LONG_KEY
<span class="token punctuation">}</span>KEY_TYPE<span class="token punctuation">;</span>

<span class="token comment">//extern u8 g_KeyFlag;</span>
<span class="token comment">//extern KEY_TYPE g_KeyActionFlag; </span>

<span class="token comment">//单个按键事件</span>
<span class="token comment">//#define SingleKeyEvent</span>

<span class="token comment">//单个按键实现长按和短按</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SingleKey_LongShort_Event</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token keyword">void</span> <span class="token function">Key_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Key_Scan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p><strong>main函数</strong></p> 
<pre><code class="prism language-c">KEY_STATE KeyState <span class="token operator">=</span>KEY_CHECK<span class="token punctuation">;</span>  <span class="token comment">// 初始化按键状态为检测状态</span>
u8 g_KeyFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token comment">// 按键有效标志，0： 按键值无效； 1：按键值有效</span>

KEY_TYPE g_KeyActionFlag<span class="token punctuation">;</span>		<span class="token comment">//用于区别长按和短按</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Key_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Timer_init</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">7199</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//10Khz的计数频率，计数到20为2ms</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">switch</span><span class="token punctuation">(</span>g_KeyActionFlag<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> SHORT_KEY<span class="token operator">:</span>
                <span class="token comment">/*
                执行短按对应的事件
                */</span>
            g_KeyActionFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//状态回到空</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            
            <span class="token keyword">case</span> LONG_KEY<span class="token operator">:</span>
                 <span class="token comment">/*
                执行长按对应的事件
                */</span>
            g_KeyActionFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//状态回到空</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">TIM3_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>   <span class="token comment">//TIM3 每 2ms 中断一次</span>
<span class="token punctuation">{<!-- --></span>   
    <span class="token keyword">static</span> u8 cnt<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TIM_GetITStatus</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span> <span class="token comment">//检查指定的TIM中断发生与否:TIM 中断源 </span>
		<span class="token punctuation">{<!-- --></span>
		cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">&gt;</span><span class="token number">5</span><span class="token punctuation">)</span>           <span class="token comment">// 每10ms 执行一次按键扫描程序</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">Key_Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">TIM_ClearITPendingBit</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//清除TIMx的中断待处理位:TIM 中断源 </span>
		<span class="token punctuation">}</span>   
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="__360"></a>四 、多按键检测</h2> 
<p>同样的，多按键也是一样的；<br> 示例如下：<br> Buttion.h 头文件中只需要把Key做下修改；</p> 
<pre><code class="prism language-c">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY0</span>  <span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span>GPIO_Pin_5<span class="token punctuation">)</span></span><span class="token comment">//读取按键0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1</span>  <span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span>GPIO_Pin_15<span class="token punctuation">)</span></span><span class="token comment">//读取按键1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WK_UP</span>   <span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span>GPIO_Pin_0<span class="token punctuation">)</span></span><span class="token comment">//读取按键2 </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Key</span>  <span class="token expression"><span class="token punctuation">(</span>KEY0 <span class="token operator">&amp;&amp;</span> KEY1 <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>WK_UP<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{<!-- --></span>
    KEY_CHECK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    KEY_COMFIRM <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    KEY_RELEASE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>KEY_STATE<span class="token punctuation">;</span>

<span class="token comment">//对应的按键值，</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{<!-- --></span>
    KEY_NULL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    KEY_0<span class="token punctuation">,</span>
    KEY_1<span class="token punctuation">,</span>
    KEY_WK_UP
<span class="token punctuation">}</span>KEY_VALUE<span class="token punctuation">;</span>
</code></pre> 
<p>对应的状态机中对按键值进行区分即可：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">Key_Scan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>KeyState<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//按键未按下状态，此时判断Key的值</span>
        <span class="token keyword">case</span>   KEY_CHECK<span class="token operator">:</span>    
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Key<span class="token punctuation">)</span>   
            <span class="token punctuation">{<!-- --></span>
                KeyState <span class="token operator">=</span>  KEY_COMFIRM<span class="token punctuation">;</span>  <span class="token comment">//如果按键Key值为0，说明按键开始按下，进入下一个状态</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token comment">//按键按下状态：</span>
        <span class="token keyword">case</span>   KEY_COMFIRM<span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Key<span class="token punctuation">)</span>                     <span class="token comment">//查看当前Key是否还是0，再次确认是否按下</span>
            <span class="token punctuation">{<!-- --></span>
                KeyState <span class="token operator">=</span>  KEY_RELEASE<span class="token punctuation">;</span>  <span class="token comment">//进入下一个释放状态</span>
                <span class="token comment">//g_KeyFlag = 1;           //按键有效值为1, 按键确认按下，按下就执行按键任务； </span>
                
                <span class="token comment">// 多按键判断</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> KEY0<span class="token punctuation">)</span>
                    g_Key <span class="token operator">=</span> KEY_0<span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> KEY1<span class="token punctuation">)</span>
                    g_Key <span class="token operator">=</span> KEY_1<span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> WK_UP<span class="token punctuation">)</span>
                    g_Key <span class="token operator">=</span> KEY_WK_UP<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>   
            <span class="token keyword">else</span>                         <span class="token comment">//当前Key值为1，确认为抖动，则返回上一个状态</span>
            <span class="token punctuation">{<!-- --></span>
                KeyState <span class="token operator">=</span>  KEY_CHECK<span class="token punctuation">;</span>      <span class="token comment">//返回上一个状态</span>
            <span class="token punctuation">}</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token comment">//按键释放状态</span>
         <span class="token keyword">case</span>  KEY_RELEASE<span class="token operator">:</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>Key<span class="token punctuation">)</span>                     <span class="token comment">//当前Key值为1，说明按键已经释放，返回开始状态</span>
             <span class="token punctuation">{<!-- --></span> 
                 KeyState <span class="token operator">=</span>  KEY_CHECK<span class="token punctuation">;</span>
             <span class="token punctuation">}</span> 
             <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>main函数中也是一样，使用switch case 语句执行按键事件即可：</p> 
<pre><code class="prism language-c">	<span class="token keyword">extern</span> KEY_VALUE g_Key<span class="token punctuation">;</span>
  
     <span class="token keyword">switch</span><span class="token punctuation">(</span>g_Key<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> KEY_0<span class="token operator">:</span>
            <span class="token comment">/* 
            KEY 0 按键事件 
            */</span>
        g_Key<span class="token operator">=</span>KEY_NULL<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        
        <span class="token keyword">case</span> KEY_1<span class="token operator">:</span>
             <span class="token comment">/* 
             KEY 1 按键事件 
             */</span>
        g_Key<span class="token operator">=</span>KEY_NULL<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        
        <span class="token keyword">case</span> KEY_WK_UP<span class="token operator">:</span>
             <span class="token comment">/* 
             KEY_WK_UP 按键事件 
             */</span>
        g_Key<span class="token operator">=</span>KEY_NULL<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
  

</code></pre> 
<h2><a id="_469"></a>按键处理经典例程：</h2> 
<p>以下是按键处理的经典程序：这是一个论坛中某位博主写的，在csdn这个blog中的也对这种方法进行了归纳：<br> <a href="https://blog.csdn.net/pillarpeng/article/details/50963127">[独立按键] - 1： 单击，双击，三击以及N击</a><br> 按键处理的核心就是把driver层和中间层进行拆分，driver层只需要判断长按，短按和无按下这三种状态，中间层再在上面进行处理，即可处理更多种情况；</p> 
<p>示例场景：一个按键需要通过长按和短按实现三种功能；短按的时候，在2 秒之内，继续短按，即转变为其他功能，长按的时候则是另外一种功能。对应具体需求就是：首先短按1下开机，开机之后，如果2秒之内继续短按，则短按切换为设置键；超过2秒之后，短按1下，则关机；<br> 这种情况下，程序可以如下：<br> driver 层不需要更改，只需要对中间层进行处理；</p> 
<pre><code class="prism language-c"><span class="token comment">//============================ key.c ===================</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_INPUT</span>           <span class="token expression">P1<span class="token punctuation">.</span><span class="token number">0</span>    </span><span class="token comment">// 按键IO</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_STATE_0</span>         <span class="token expression"><span class="token number">0</span>       </span><span class="token comment">// 按键状态</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_STATE_1</span>         <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_STATE_2</span>         <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_STATE_3</span>         <span class="token expression"><span class="token number">3</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LONG_KEY_TIME</span>       <span class="token expression"><span class="token number">300</span>     </span><span class="token comment">// LONG_KEY_TIME*10MS = 3S</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SINGLE_KEY_TIME</span>     <span class="token expression"><span class="token number">3</span>       </span><span class="token comment">// SINGLE_KEY_TIME*10MS = 30MS</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N_KEY</span>    <span class="token expression"><span class="token number">0</span>                  </span><span class="token comment">// no click</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_KEY</span>    <span class="token expression"><span class="token number">1</span>                  </span><span class="token comment">// single click</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">L_KEY</span>    <span class="token expression"><span class="token number">10</span>                 </span><span class="token comment">// long press</span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">key_driver</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>     
    <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>         <span class="token comment">// 按键状态变量</span>
    <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> key_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>           <span class="token comment">// 按键计时变量</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_press<span class="token punctuation">,</span> key_return<span class="token punctuation">;</span> 

    key_return <span class="token operator">=</span> N_KEY<span class="token punctuation">;</span>                         <span class="token comment">// 清除 返回按键值</span>

    key_press <span class="token operator">=</span> KEY_INPUT<span class="token punctuation">;</span>                      <span class="token comment">// 读取当前键值</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>key_state<span class="token punctuation">)</span>     
    <span class="token punctuation">{<!-- --></span>       
        <span class="token keyword">case</span> KEY_STATE_0<span class="token operator">:</span>                       <span class="token comment">// 按键状态0：判断有无按键按下</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key_press<span class="token punctuation">)</span>                     <span class="token comment">// 有按键按下</span>
            <span class="token punctuation">{<!-- --></span>
                key_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                   <span class="token comment">// 清零时间间隔计数</span>
                key_state <span class="token operator">=</span> KEY_STATE_1<span class="token punctuation">;</span>        <span class="token comment">// 然后进入 按键状态1</span>
            <span class="token punctuation">}</span>        
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> KEY_STATE_1<span class="token operator">:</span>                       <span class="token comment">// 按键状态1：软件消抖（确定按键是否有效，而不是误触）。按键有效的定义：按键持续按下超过设定的消抖时间。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key_press<span class="token punctuation">)</span>                     
            <span class="token punctuation">{<!-- --></span>
                key_time<span class="token operator">++</span><span class="token punctuation">;</span>                     <span class="token comment">// 一次10ms</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>key_time<span class="token operator">&gt;=</span>SINGLE_KEY_TIME<span class="token punctuation">)</span>   <span class="token comment">// 消抖时间为：SINGLE_KEY_TIME*10ms = 30ms;</span>
                <span class="token punctuation">{<!-- --></span>
                    key_state <span class="token operator">=</span> KEY_STATE_2<span class="token punctuation">;</span>    <span class="token comment">// 如果按键时间超过 消抖时间，即判定为按下的按键有效。按键有效包括两种：单击或者长按，进入 按键状态2， 继续判定到底是那种有效按键</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>         
            <span class="token keyword">else</span> key_state <span class="token operator">=</span> KEY_STATE_0<span class="token punctuation">;</span>       <span class="token comment">// 如果按键时间没有超过，判定为误触，按键无效，返回 按键状态0，继续等待按键</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> 

        <span class="token keyword">case</span> KEY_STATE_2<span class="token operator">:</span>                       <span class="token comment">// 按键状态2：判定按键有效的种类：是单击，还是长按</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key_press<span class="token punctuation">)</span>                       <span class="token comment">// 如果按键在 设定的长按时间 内释放，则判定为单击</span>
            <span class="token punctuation">{<!-- --></span> 
                 key_return <span class="token operator">=</span> S_KEY<span class="token punctuation">;</span>            <span class="token comment">// 返回 有效按键值：单击</span>
                 key_state <span class="token operator">=</span> KEY_STATE_0<span class="token punctuation">;</span>       <span class="token comment">// 返回 按键状态0，继续等待按键</span>
            <span class="token punctuation">}</span> 
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                key_time<span class="token operator">++</span><span class="token punctuation">;</span>                     

                <span class="token keyword">if</span><span class="token punctuation">(</span>key_time <span class="token operator">&gt;=</span> LONG_KEY_TIME<span class="token punctuation">)</span>   <span class="token comment">// 如果按键时间超过 设定的长按时间（LONG_KEY_TIME*10ms=200*10ms=2000ms）, 则判定为 长按</span>
                <span class="token punctuation">{<!-- --></span>
                    key_return <span class="token operator">=</span> L_KEY<span class="token punctuation">;</span>         <span class="token comment">// 返回 有效键值值：长按</span>
                    key_state <span class="token operator">=</span> KEY_STATE_3<span class="token punctuation">;</span>    <span class="token comment">// 去状态3，等待按键释放</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> KEY_STATE_3<span class="token operator">:</span>                         <span class="token comment">// 等待按键释放</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>key_press<span class="token punctuation">)</span> 
          <span class="token punctuation">{<!-- --></span>
              key_state <span class="token operator">=</span> KEY_STATE_0<span class="token punctuation">;</span>          <span class="token comment">// 按键释放后，进入 按键状态0 ，进行下一次按键的判定</span>
          <span class="token punctuation">}</span>         
          <span class="token keyword">break</span><span class="token punctuation">;</span> 

        <span class="token keyword">default</span><span class="token operator">:</span>                                <span class="token comment">// 特殊情况：key_state是其他值得情况，清零key_state。这种情况一般出现在 没有初始化key_state，第一次执行这个函数的时候</span>
            key_state <span class="token operator">=</span> KEY_STATE_0<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> key_return<span class="token punctuation">;</span>                          <span class="token comment">// 返回 按键值</span>
<span class="token punctuation">}</span> 
</code></pre> 
<p>中间层接收到driver层的返回数据，再根据功能需求编写处理函数；</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">key_event_handle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> <span class="token class-name">uint8_t</span> long_click_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token class-name">uint8_t</span> short_click_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">uint32_t</span> prev_cnt<span class="token punctuation">,</span> cur_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token keyword">switch</span><span class="token punctuation">(</span>key_return<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> S_KEY<span class="token operator">:</span>	  <span class="token comment">// 短按 开关</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">/* turn on */</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>power_state <span class="token operator">!=</span> ON<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				prev_cnt <span class="token operator">=</span> <span class="token function">get_tim3_systick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				power_state <span class="token operator">=</span> ON<span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"turn on!! \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
			<span class="token punctuation">}</span>			
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				cur_cnt <span class="token operator">=</span> <span class="token function">get_tim3_systick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 在定时器3中获取最新计数值</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cur_cnt <span class="token operator">-</span> prev_cnt<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">)</span>			<span class="token comment">// 两次单击时间小于2s</span>
				<span class="token punctuation">{<!-- --></span>
					short_click_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
					short_click_cnt <span class="token operator">=</span> short_click_cnt<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">;</span>
					<span class="token comment">/* 根据按键的次数依次执行不同的动作 */</span>
					<span class="token keyword">switch</span><span class="token punctuation">(</span>short_click_cnt<span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
								<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"enter case 0 \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token comment">/*此处可调用需要执行的函数*/</span>	
						<span class="token keyword">break</span><span class="token punctuation">;</span>
						
						<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
								<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"enter case 1 \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token comment">/*此处可调用需要执行的函数*/</span>	
						<span class="token keyword">break</span><span class="token punctuation">;</span>
						
						<span class="token keyword">default</span><span class="token operator">:</span><span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>		
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>     <span class="token comment">// 超过2秒，turn offs</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"turn off \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					power_state <span class="token operator">=</span> OFF<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token comment">/* 更新计数值 */</span>
			prev_cnt <span class="token operator">=</span> cur_cnt<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		
		<span class="token keyword">case</span> L_KEY<span class="token operator">:</span>			
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>power_state<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				long_click_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>long_click_cnt <span class="token operator">&gt;</span> <span class="token number">50</span><span class="token punctuation">)</span>  	<span class="token comment">// 500ms 进行一次调用</span>
				<span class="token punctuation">{<!-- --></span> 
					long_click_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"enter long press mode\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">/*
					此处调用长按处理函数
					*/</span>
			 	<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
	
</code></pre> 
<h2><a id="_635"></a>总结</h2> 
<font color="#999AAA"> </font> 
<blockquote> 
 <p>以上便是对按键状态机程序的总结，对长按和短按的判断实现……</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b028642baecdc453e5c19338d763f9ea/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">夜神模拟器无法连接网络的解决办法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1578f5fbf3ecee859d552b55575d6cfa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深度学习环境配置之windows下的torch-gpu=1.7.1（亲测有效）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>