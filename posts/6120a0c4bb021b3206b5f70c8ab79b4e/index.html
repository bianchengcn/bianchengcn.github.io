<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MUI混合开发——更新下载app时，系统状态栏显示下载进度 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MUI混合开发——更新下载app时，系统状态栏显示下载进度" />
<meta property="og:description" content="一、最开始的想法 本来最开始公司使用mui制作的app，没有系统状态栏显示下载进度的，后来突发奇想想要实现像qq等app下载更新或消息提示等在系统状态栏显示的效果，特意去研究了下。
在H5&#43;plus api中没有发现存在有设置系统通知栏的支持，于是采取android开发的方式，实现功能。
大致功能描述：
大致就是这种操作啦，下面像大家展示插件开发的方式实现上述功能。
二、系统通知栏插件开发 1、更新操作，下载安装包等依旧使用H5&#43;plus的方式实现
function createDownload(url) { if(!url) { mui.toast(&#34;获取下载路径错误&#34;); return; } //事件参数单位为s var downloadTask = plus.downloader.createDownload(url, { //timeout: 10, //retryInterval: 5, //retry: 3 }); plus.notification.setNotification(&#34;新版下载&#34;, &#34;开始下载&#34;); //插件调用 downloadTask.start(); console.log(&#34;$$$$$$&#34;); downloadTask.addEventListener(&#34;statechanged&#34;, function(task, status) { //console.log(&#34;task---&gt;&#34;&#43;task); console.log(&#34;task.state---&gt;&#34; &#43; task.state); //var current = parseInt(100 * task.downloadedSize / task.totalSize); //console.log(&#34;current--&gt;&#34; &#43; current); //console.log(&#34;status---&gt;&#34;&#43;status); switch(task.state) { case 1: // 开始 console.log(&#39;开始&#39;); break; case 2: //已连接到服务器 console.log(&#39;已连接到服务器&#39;); break; case 3: // 已接收到数据 console." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/6120a0c4bb021b3206b5f70c8ab79b4e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-10-09T15:51:22+08:00" />
<meta property="article:modified_time" content="2019-10-09T15:51:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MUI混合开发——更新下载app时，系统状态栏显示下载进度</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>一、最开始的想法</h4> 
<p>本来最开始公司使用mui制作的app，没有系统状态栏显示下载进度的，后来突发奇想想要实现像qq等app下载更新或消息提示等在系统状态栏显示的效果，特意去研究了下。</p> 
<p>在H5+plus api中没有发现存在有设置系统通知栏的支持，于是采取android开发的方式，实现功能。</p> 
<p>大致功能描述：</p> 
<p><img alt="" class="has" height="349" src="https://images2.imgbox.com/b1/ce/ZZn4OT6I_o.png" width="191">   <img alt="" class="has" height="358" src="https://images2.imgbox.com/d0/c5/hEh7hBx5_o.png" width="193"></p> 
<p>大致就是这种操作啦，下面像大家展示插件开发的方式实现上述功能。</p> 
<h4>二、系统通知栏插件开发</h4> 
<p>1、更新操作，下载安装包等依旧使用H5+plus的方式实现</p> 
<pre class="has"><code>function createDownload(url) {
				if(!url) {
					mui.toast("获取下载路径错误");
					return;
				}
				//事件参数单位为s
				var downloadTask = plus.downloader.createDownload(url, {
					//timeout: 10,
					//retryInterval: 5,
					//retry: 3
				});
				plus.notification.setNotification("新版下载", "开始下载"); //插件调用
				downloadTask.start();
				console.log("$$$$$$");
				downloadTask.addEventListener("statechanged", function(task, status) {
					//console.log("task---&gt;"+task);
					console.log("task.state---&gt;" + task.state);
					//var current = parseInt(100 * task.downloadedSize / task.totalSize);
					//console.log("current--&gt;" + current);
					//console.log("status---&gt;"+status);
					switch(task.state) {
						case 1: // 开始
							console.log('开始');
							break;
						case 2: //已连接到服务器
							console.log('已连接到服务器');
							break;
						case 3: // 已接收到数据
							console.log('已接收到数据');
							var current = parseInt(100 * task.downloadedSize / task.totalSize);
							plus.notification.setProgress(current); //插件调用
							break;
						case 4: // 下载完成 
							console.log('下载完成 ');
							plus.notification.compProgressNotification("下载完成"); //插件调用
							plus.runtime.install(task.filename, {}, function() {
								//成功安装回调，执行重启app操作
								plus.runtime.restart();
							}, function(DOMException) {
								console.log(JSON.stringify(DOMException));
								mui.toast("安装失败");
								//alert("安装失败")
							});
							break;
					}
				});
			}</code></pre> 
<p>2、java插件的制作</p> 
<p>相关制作细节，有不懂的，大家可以参考之前的博客，有比官方更好懂的插件开发。<a href="https://blog.csdn.net/qq_38322527/article/details/80862186">传送门</a>  </p> 
<p> 采取新插件开发的方式，编写实现代码</p> 
<pre class="has"><code class="language-java">import java.util.Timer;
import java.util.TimerTask;

import org.json.JSONArray;
import android.app.Activity;
import android.app.Notification;
import android.app.NotificationManager;
import android.util.Log;
import cn.linkpower.dtulock.R;
import io.dcloud.common.DHInterface.IWebview;
import io.dcloud.common.DHInterface.StandardFeature;

/**
 * app下载进度，状态栏显示---插件
 * 
 * @author 76519
 *
 */
public class DownloadProgress extends StandardFeature {
	static final int ids = 1000;
	Activity activity;
	// 通知栏设备管理器
	NotificationManager manager;
	// 通知栏信息传递操作类
	Notification.Builder builder;
	
	//定义全局当前下载进度(需要在开启和结束后的插件调用中，实现初始化操作)
	int preProgress  = 0;
	

	/**
	 * 初始设置
	 * 
	 * @param pWebview
	 * @param array
	 */
	public void setNotification(IWebview pWebview, JSONArray array) {
		Log.i("DownloadProgress--&gt;", "setNotification");
		check(pWebview);
		String title = array.optString(0);
		String ticker = array.optString(1);
		//设置通知标题
		builder.setContentTitle(title)
				//设置通知栏内容
				.setContentText(ticker)
				//通知首次出现在通知栏，带上升动画效果的
				.setTicker(ticker);
        //同时初始化全局参数
		preProgress = 0;
		builder.setProgress(100, 0, false);
		// 设置notify通知对象并发布通知，id为1000
		manager.notify(ids, builder.build());
	}

	/**
	 * 进度显示
	 * 
	 * @param pWebview
	 * @param array
	 * @throws Exception
	 */
	public void setProgress(IWebview pWebview, final JSONArray array) throws Exception {
		Log.i("DownloadProgress--&gt;", "setProgress");
		check(pWebview);
		
		//防止重复
		if(preProgress &lt; Integer.parseInt(array.optString(0)) ) {
			new Thread(new Runnable() {
				@Override
				public void run() {
					int incr = Integer.parseInt(array.optString(0));
					Log.i("setProgress---&gt;", String.valueOf(incr));
					/**
					 * 几个参数含义：&lt;br&gt;
					 * 参数一：定义进度可以采用的最大值；&lt;br&gt;
					 * 参数二：定义默认进度值，介于0到最大值之间；&lt;br&gt;
					 * 参数三：如果设置为true，则将显示非循环动画，而不显示进度&lt;br&gt;
					 */
					builder.setProgress(100, incr, false);
					// 下载进度文本显示
					builder.setContentText("下载" + String.valueOf(incr) + "%");
					//发送通知请求
					manager.notify(ids, builder.build());
				}
			}).start();
			preProgress = Integer.parseInt(array.optString(0));
		}
		
	}

	/**
	 * 下载完成后
	 * 
	 * @param pWebview
	 * @param array
	 */
	public void compProgressNotification(IWebview pWebview, JSONArray array) {
		Log.i("DownloadProgress--&gt;", "compProgressNotification");
		check(pWebview);
		String title = array.optString(0);
		builder.setContentTitle(title)
				//移除进度条
				.setProgress(0, 0, false)
				.setOngoing(false);
		manager.notify(ids, builder.build());
		//显示下载成功1500毫秒后  移除通知
		new Timer().schedule(new TimerTask() {
			@Override
			public void run() {
                //同时初始化全局参数
				preProgress = 0;
				//移除通知
				manager.cancel(ids);
			}
		}, 1500);
	}
	
	public void check(IWebview pWebview) {
		if (activity == null) {
			activity = pWebview.getActivity();
			manager = (NotificationManager) activity.getSystemService(Activity.NOTIFICATION_SERVICE);
			builder = new Notification.Builder(activity);
			// 设置通知时间
			builder.setWhen(System.currentTimeMillis())
					//设置优先级别
					.setPriority(Notification.PRIORITY_DEFAULT)
					// 设置通知标题
					.setContentTitle("新版下载")
					//通知首次出现在通知栏，带上升动画效果的
					.setTicker("开始下载")
					.setContentText("开始下载")
					//ture，设置他为一个正在进行的通知。他们通常是用来表示一个后台任务,用户积极参与(如播放音乐)或以某种方式正在等待,因此占用设备(如一个文件下载,同步操作,主动网络连接)
					//.setOngoing(true)
					// 设置默认的提示音、震动、灯光(开启震动后，下载会持续震动)
					//.setDefaults(Notification.DEFAULT_ALL)
					// 使用小图标
					.setSmallIcon(R.drawable.icon)
					// 设置要使用的振动模式
					.setVibrate(null);
		}
	}

}
</code></pre> 
<p>3、注册申明插件别名和native调用桥接</p> 
<p><img alt="" class="has" height="82" src="https://images2.imgbox.com/08/b5/0lStsmuQ_o.png" width="240"></p> 
<p>中追加一条新的注册信息 </p> 
<pre class="has"><code>&lt;!-- 20191009 增加下载进度提示插件 --&gt;
&lt;feature name="notification" value="cn.linkpower.plugin.download.DownloadProgress" &gt;&lt;/feature&gt;</code></pre> 
<p>4、编写桥接js</p> 
<pre class="has"><code class="language-javascript">document.addEventListener("plusready", function() {
	var B = window.plus.bridge;
	var notification = {
		setProgress: function(incr) {
			return B.exec("notification", "setProgress", [incr]);
		},
		setNotification: function(contentTitle, ticker) {
			return B.exec("notification", "setNotification", [contentTitle, ticker]);
		},
		compProgressNotification: function(contentTitle) {
			return B.exec("notification", "compProgressNotification", [contentTitle]);
		}
	};
	window.plus.notification = notification;
}, true);</code></pre> 
<p> 5、需要使用的页面引入</p> 
<pre class="has"><code>&lt;script src="../js/download/download.js" type="text/javascript" charset="utf-8"&gt;&lt;/script&gt;</code></pre> 
<h4>三、参考资料</h4> 
<p>1、H5+plus 中，针对下载操作回调有以下几种状态值返回</p> 
<pre class="has"><code>vaoid onCompleted(Download download, Number status) {
	// Download file complete code
}</code></pre> 
<p> 文档地址：<a href="https://www.html5plus.org/doc/zh_cn/downloader.html#plus.downloader.DownloadCompletedCallback" rel="nofollow">https://www.html5plus.org/doc/zh_cn/downloader.html#plus.downloader.DownloadCompletedCallback</a></p> 
<p>其中最为关键的看<a href="https://www.html5plus.org/doc/zh_cn/downloader.html#plus.downloader.Download" rel="nofollow">Download类</a></p> 
<pre class="has"><code class="language-javascript">interface plus.downloader.Download {
	readonly attribute String id;
	readonly attribute String url;
	readonly attribute Number state;
	readonly attribute DownloadOptions options;
	readonly attribute String filename;
	readonly attribute Number downloadedSize;
	readonly attribute Number totalSize;
	function void abort();
	function void addEventListener(String event, function Callback listener, Boolean capture);
	function String getAllResponseHeaders();
	function String getResponseHeader(String headerName);
	function void pause();
	function void resume();
	function void setRequestHeader(String headerName, String headerValue);
	function void start();
}</code></pre> 
<p> 2、android系统通知栏相关资料查询</p> 
<p>《<a href="https://www.cnblogs.com/panhouye/p/6147332.html" rel="nofollow" id="cb_post_title_url">ANDROID中使用NOTIFICATION实现进度通知栏（NOTIFICATION示例三）</a>》</p> 
<p>《<a href="https://blog.csdn.net/dsc114/article/details/51721472">Android通知Notification详解</a>》</p> 
<p>《<a href="https://blog.csdn.net/vipzjyno1/article/details/25248021">Android 通知栏Notification的整合 全面学习 （一个DEMO让你完全了解它）</a>》</p> 
<h4>四、注意细节</h4> 
<p>在设置进度条数据显示时，切记不要在主线程中实现设置通知，一定要开启一个子线程去实现操作，不然通知栏数据不会变更！！</p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ca1e461dc6bb5cf85c6a9dfc6bbd80af/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[转载]jdk1.8垃圾回收器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c62baf9d4253a6aaad309a2a97402c16/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在 Windows 系统下常用的 bat 脚本分享</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>