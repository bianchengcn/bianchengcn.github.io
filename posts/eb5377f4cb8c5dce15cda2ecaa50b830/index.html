<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>看书标记【R语言 商务数据分析实战9】 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="看书标记【R语言 商务数据分析实战9】" />
<meta property="og:description" content="看书标记——关于R语言 chapter 99.2 任务实现 【R语言 商务数据分析实战9】 chapter 9 餐饮企业综合分析
统计分析&gt;&gt;ARIMA预测销售额&gt;&gt;协同过滤算法对菜品进行智能推荐&gt;&gt;Apriori算法对菜品进行关联分析&gt;&gt;K-means算法进行客户价值分析&gt;&gt;决策树算法进行客户流失预测
这几种算法是不同从不同方面得到不同的结果的独立模块，根据算法的要求，对数据进行相关的数据预处理
9.2 任务实现 统计餐饮数据
# 【分组聚合：使用aggregate或者split-lapply-cbind模式】 # 设置工作目录 setwd() # [使用aggregate函数进行分组统计] # 导入数据 score &lt;- read.csv(&#34;./data/score.csv&#34;, stringsAsFactors = FALSE) # 提取score中的gender字段 gender &lt;- list(score$gender) # 对score1和score2列进行分组统计 aggregate(score[, c(2,3)], gender, mean) # [使用split-lapply-cbind模式进行分组统计] # 分组 sp &lt;- split(score, score$gender, drop = TRUE) # 求score1和score2的均值 score1 &lt;- lapply(sp, FUN = function(x) mean(x$score1)) score2 &lt;- lapply(sp, FUN = function(x) mean(x$score2)) # 合并分组计算结果 result &lt;- cbind(score1, score2 ) result # 【使用melt和dcast这两个函数实现透视表功能】 library(reshape2) data(airquality) airquality &lt;- airquality[29:34, ] names(airquality) &lt;- tolower(names(airquality)) airquality # 【用melt转换数据格式】 md &lt;- melt(airquality, id = c(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/eb5377f4cb8c5dce15cda2ecaa50b830/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-03T13:32:50+08:00" />
<meta property="article:modified_time" content="2023-02-03T13:32:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">看书标记【R语言 商务数据分析实战9】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>看书标记——关于R语言</h4> 
 <ul><li><a href="#chapter_9_4" rel="nofollow">chapter 9</a></li><li><ul><li><ul><li><ul><li><ul><li><a href="#92__9" rel="nofollow">9.2 任务实现</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<br> 【R语言 商务数据分析实战9】 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="chapter_9_4"></a>chapter 9</h2> 
<p><font color="#999AAA">餐饮企业综合分析</font></p> 
<p><strong>统计分析&gt;&gt;ARIMA预测销售额&gt;&gt;协同过滤算法对菜品进行智能推荐&gt;&gt;Apriori算法对菜品进行关联分析&gt;&gt;K-means算法进行客户价值分析&gt;&gt;决策树算法进行客户流失预测</strong><br> <font color="#999AAA">这几种算法是不同从不同方面得到不同的结果的独立模块，根据算法的要求，对数据进行相关的数据预处理</font></p> 
<h6><a id="92__9"></a>9.2 任务实现</h6> 
<p>统计餐饮数据</p> 
<pre><code class="prism language-r"><span class="token comment"># 【分组聚合：使用aggregate或者split-lapply-cbind模式】</span>

<span class="token comment"># 设置工作目录</span>
setwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># [使用aggregate函数进行分组统计]</span>
<span class="token comment"># 导入数据</span>
score <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./data/score.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
<span class="token comment"># 提取score中的gender字段</span>
gender <span class="token operator">&lt;-</span> list<span class="token punctuation">(</span>score<span class="token operator">$</span>gender<span class="token punctuation">)</span>
<span class="token comment"># 对score1和score2列进行分组统计</span>
aggregate<span class="token punctuation">(</span>score<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> gender<span class="token punctuation">,</span> mean<span class="token punctuation">)</span>
<span class="token comment"># [使用split-lapply-cbind模式进行分组统计]</span>
<span class="token comment"># 分组</span>
sp <span class="token operator">&lt;-</span> split<span class="token punctuation">(</span>score<span class="token punctuation">,</span> score<span class="token operator">$</span>gender<span class="token punctuation">,</span> drop <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span>
<span class="token comment"># 求score1和score2的均值</span>
score1 <span class="token operator">&lt;-</span> lapply<span class="token punctuation">(</span>sp<span class="token punctuation">,</span> FUN <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> mean<span class="token punctuation">(</span>x<span class="token operator">$</span>score1<span class="token punctuation">)</span><span class="token punctuation">)</span>
score2 <span class="token operator">&lt;-</span> lapply<span class="token punctuation">(</span>sp<span class="token punctuation">,</span> FUN <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> mean<span class="token punctuation">(</span>x<span class="token operator">$</span>score2<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 合并分组计算结果</span>
result <span class="token operator">&lt;-</span> cbind<span class="token punctuation">(</span>score1<span class="token punctuation">,</span> score2 <span class="token punctuation">)</span>
result

<span class="token comment"># 【使用melt和dcast这两个函数实现透视表功能】</span>
library<span class="token punctuation">(</span>reshape2<span class="token punctuation">)</span>
data<span class="token punctuation">(</span>airquality<span class="token punctuation">)</span>
airquality <span class="token operator">&lt;-</span> airquality<span class="token punctuation">[</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">34</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
names<span class="token punctuation">(</span>airquality<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> tolower<span class="token punctuation">(</span>names<span class="token punctuation">(</span>airquality<span class="token punctuation">)</span><span class="token punctuation">)</span>
airquality

<span class="token comment"># 【用melt转换数据格式】</span>
md <span class="token operator">&lt;-</span> melt<span class="token punctuation">(</span>airquality<span class="token punctuation">,</span> id <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">"month"</span><span class="token punctuation">,</span> <span class="token string">"day"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
md
<span class="token comment"># 还原melt后的数据</span>
cd <span class="token operator">&lt;-</span> dcast<span class="token punctuation">(</span>md<span class="token punctuation">,</span> month <span class="token operator">+</span> day <span class="token operator">~</span> variable<span class="token punctuation">)</span>
cd

<span class="token comment"># 设置工作目录</span>
setwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 【统计每日用餐人数与销售额】</span>
info <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./data/meal_order_info.csv"</span><span class="token punctuation">)</span>  <span class="token comment"># 导入数据</span>

info<span class="token operator">$</span>use_start_time <span class="token operator">&lt;-</span> as.Date<span class="token punctuation">(</span>info<span class="token operator">$</span>use_start_time<span class="token punctuation">)</span>  <span class="token comment"># 转换时间格式</span>
table<span class="token punctuation">(</span>info<span class="token operator">$</span>order_status<span class="token punctuation">)</span>  <span class="token comment"># 查看订单状态</span>
info <span class="token operator">&lt;-</span> info<span class="token punctuation">[</span>which<span class="token punctuation">(</span>info<span class="token operator">$</span>order_status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>  <span class="token comment"># 提取订单状态为1的数据</span>

<span class="token comment"># 【统计每日用餐人数与营业额】</span>
sale <span class="token operator">&lt;-</span> aggregate<span class="token punctuation">(</span>info<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> list<span class="token punctuation">(</span>info<span class="token operator">$</span>use_start_time<span class="token punctuation">)</span><span class="token punctuation">,</span> sum<span class="token punctuation">)</span>
colnames<span class="token punctuation">(</span>sale<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"saleroom"</span><span class="token punctuation">)</span>  <span class="token comment"># 修改列名</span>

<span class="token comment"># 【导出每日的用餐人数和销售额】</span>
write.csv<span class="token punctuation">(</span>sale<span class="token punctuation">,</span> <span class="token string">"./tmp/sale_day.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 【每日用餐人数折线图】</span>
sale<span class="token operator">$</span>date <span class="token operator">&lt;-</span> as.POSIXct<span class="token punctuation">(</span>sale<span class="token operator">$</span>date<span class="token punctuation">)</span>  <span class="token comment"># 将date字段转换时间格式</span>
plot<span class="token punctuation">(</span>sale<span class="token operator">$</span>date<span class="token punctuation">,</span> sale<span class="token operator">$</span>number<span class="token punctuation">,</span> col <span class="token operator">=</span> <span class="token string">"orange"</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">"b"</span><span class="token punctuation">,</span> 
     xlab <span class="token operator">=</span> <span class="token string">"日期"</span><span class="token punctuation">,</span> ylab <span class="token operator">=</span> <span class="token string">"用餐人数"</span><span class="token punctuation">)</span>
<span class="token comment"># 画出每日营业额的折线图</span>
plot<span class="token punctuation">(</span>sale<span class="token operator">$</span>date<span class="token punctuation">,</span> sale<span class="token operator">$</span>saleroom<span class="token punctuation">,</span> col <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">"o"</span><span class="token punctuation">,</span> 
     xlab <span class="token operator">=</span> <span class="token string">"日期"</span><span class="token punctuation">,</span> ylab <span class="token operator">=</span> <span class="token string">"营业额"</span><span class="token punctuation">)</span>

<span class="token comment"># 【计算菜品的热销度度】</span>
<span class="token comment"># 导入数据</span>
detail <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./data/meal_order_detail.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 菜品名称删除回车符和空格</span>
head<span class="token punctuation">(</span>detail<span class="token operator">$</span>dishes_name<span class="token punctuation">)</span>  <span class="token comment"># 查看前6个菜品名称</span>
detail<span class="token operator">$</span>dishes_name <span class="token operator">&lt;-</span> gsub<span class="token punctuation">(</span><span class="token string">"\\s|\\n+"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> detail<span class="token operator">$</span>dishes_name<span class="token punctuation">)</span>

<span class="token comment"># 求出每个菜品的销售量</span>
sales_volume <span class="token operator">&lt;-</span> aggregate<span class="token punctuation">(</span>detail<span class="token operator">$</span>counts<span class="token punctuation">,</span> list<span class="token punctuation">(</span>detail<span class="token operator">$</span>dishes_name<span class="token punctuation">)</span><span class="token punctuation">,</span> sum<span class="token punctuation">)</span>
colnames<span class="token punctuation">(</span>sales_volume<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token string">"dishes_name"</span><span class="token punctuation">,</span> <span class="token string">"counts"</span><span class="token punctuation">)</span>

<span class="token comment"># 求出每个菜品的热销度</span>
sales_formula <span class="token operator">&lt;-</span> <span class="token punctuation">(</span>sales_volume<span class="token operator">$</span>count <span class="token operator">-</span> min<span class="token punctuation">(</span>sales_volume<span class="token operator">$</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span>
  <span class="token punctuation">(</span>max<span class="token punctuation">(</span>sales_volume<span class="token operator">$</span>count<span class="token punctuation">)</span> <span class="token operator">-</span> min<span class="token punctuation">(</span>sales_volume<span class="token operator">$</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>
sales_volume<span class="token operator">$</span>sales_hot <span class="token operator">&lt;-</span> round<span class="token punctuation">(</span>sales_formula<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment"># 保留3位小数</span>

<span class="token comment"># 查看热销度最高和最低的菜品</span>
sales_volume<span class="token punctuation">[</span>which<span class="token punctuation">(</span>sales_volume<span class="token operator">$</span>sales_hot <span class="token operator">==</span> max<span class="token punctuation">(</span>sales_volume<span class="token operator">$</span>sales_hot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
sales_volume<span class="token punctuation">[</span>which<span class="token punctuation">(</span>sales_volume<span class="token operator">$</span>sales_hot <span class="token operator">==</span> min<span class="token punctuation">(</span>sales_volume<span class="token operator">$</span>sales_hot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>

<span class="token comment"># 画出热销度最高的前10个菜品的条形图</span>
<span class="token comment"># 按热销度进行排序</span>
sales_volume <span class="token operator">&lt;-</span> sales_volume<span class="token punctuation">[</span>order<span class="token punctuation">(</span>sales_volume<span class="token operator">$</span>sales_hot<span class="token punctuation">,</span> decreasing <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
barplot<span class="token punctuation">(</span>sales_volume<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> names.arg <span class="token operator">=</span> sales_volume<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        xlab <span class="token operator">=</span> <span class="token string">"菜品名称"</span><span class="token punctuation">,</span> ylab <span class="token operator">=</span> <span class="token string">"热销度"</span><span class="token punctuation">,</span> col <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">)</span>
write.csv<span class="token punctuation">(</span>sales_volume<span class="token punctuation">,</span> <span class="token string">"./tmp/sales_volume.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>  <span class="token comment"># 导出数据</span>

<span class="token comment"># 【计算菜品毛利率】</span>
<span class="token comment"># 导入数据</span>
dish <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./data/meal_dishes_detail.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
dish <span class="token operator">&lt;-</span> dish<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 特征选取</span>
<span class="token comment"># 菜品名称删除回车符</span>
head<span class="token punctuation">(</span>dish<span class="token operator">$</span>dishes_name<span class="token punctuation">)</span>
dish<span class="token operator">$</span>dishes_name <span class="token operator">&lt;-</span> gsub<span class="token punctuation">(</span><span class="token string">"\\s|\\n+"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> dish<span class="token operator">$</span>dishes_name<span class="token punctuation">)</span>

<span class="token comment"># 根据毛利率计算公式求出毛利率，并保留两位小数</span>
dish<span class="token operator">$</span>rate <span class="token operator">&lt;-</span> round<span class="token punctuation">(</span><span class="token punctuation">(</span>dish<span class="token operator">$</span>price <span class="token operator">-</span> dish<span class="token operator">$</span>cost<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>dish<span class="token operator">$</span>price<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 找出毛利率最高和最低的菜品</span>
dish<span class="token punctuation">[</span>which<span class="token punctuation">(</span>dish<span class="token operator">$</span>rate <span class="token operator">==</span> max<span class="token punctuation">(</span>dish<span class="token operator">$</span>rate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
dish<span class="token punctuation">[</span>which<span class="token punctuation">(</span>dish<span class="token operator">$</span>rate <span class="token operator">==</span> min<span class="token punctuation">(</span>dish<span class="token operator">$</span>rate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
write.csv<span class="token punctuation">(</span>dish<span class="token punctuation">,</span> <span class="token string">"./tmp/profit.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>  <span class="token comment"># 导出数据</span>
</code></pre> 
<p>构建ARIMA模型</p> 
<pre><code class="prism language-r"><span class="token comment"># 设置工作目录并读取数据</span>
<span class="token comment"># 【检验平稳性和纯随机性】</span>
setwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
sale <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./tmp/sale_day.csv"</span><span class="token punctuation">)</span>

saleroom <span class="token operator">&lt;-</span> ts<span class="token punctuation">(</span>sale<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plot<span class="token punctuation">(</span>saleroom<span class="token punctuation">,</span> xlab <span class="token operator">=</span> <span class="token string">"时间"</span><span class="token punctuation">,</span> ylab <span class="token operator">=</span> <span class="token string">"销售额"</span><span class="token punctuation">)</span>  <span class="token comment"># 绘制时序图</span>
acf<span class="token punctuation">(</span>saleroom<span class="token punctuation">,</span> lag.max <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>  <span class="token comment"># 绘制ACF图</span>

<span class="token comment"># 差分</span>
saleroom.diff <span class="token operator">&lt;-</span> diff<span class="token punctuation">(</span>saleroom<span class="token punctuation">,</span> differences <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 进行差分</span>
acf<span class="token punctuation">(</span>saleroom.diff<span class="token punctuation">,</span> lag.max <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>  <span class="token comment"># 绘制差分后序列的ACF图</span>
<span class="token comment"># 单位根检验</span>
library<span class="token punctuation">(</span>tseries<span class="token punctuation">)</span>
adf.test<span class="token punctuation">(</span>saleroom<span class="token punctuation">)</span>
Box.test<span class="token punctuation">(</span>saleroom<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"Ljung-Box"</span><span class="token punctuation">)</span>  <span class="token comment"># 纯随机性检验</span>
</code></pre> 
<pre><code class="prism language-r"><span class="token comment"># 【构建模型】</span>
<span class="token comment"># BIC图</span>
library<span class="token punctuation">(</span>TSA<span class="token punctuation">)</span>
<span class="token comment"># 原序列定阶</span>
saleroom.BIC <span class="token operator">&lt;-</span> armasubsets<span class="token punctuation">(</span>y <span class="token operator">=</span> saleroom<span class="token punctuation">,</span> nar <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> nma <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
plot<span class="token punctuation">(</span>saleroom.BIC<span class="token punctuation">)</span>
<span class="token comment"># 差分后的序列定阶</span>
saleroom.diff.BIC <span class="token operator">&lt;-</span> armasubsets<span class="token punctuation">(</span>y <span class="token operator">=</span> saleroom.diff<span class="token punctuation">,</span> nar <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> nma <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
plot<span class="token punctuation">(</span>saleroom.diff.BIC<span class="token punctuation">)</span>

<span class="token comment"># 根据BIC图定阶</span>
library<span class="token punctuation">(</span>forecast<span class="token punctuation">)</span>
<span class="token comment"># 初始化</span>
checkout <span class="token operator">&lt;-</span> data.frame<span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> q <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> P <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> D <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 
                       Q <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"残差P值"</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"平均误差"</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
test_checkout <span class="token operator">&lt;-</span> data.frame<span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> q <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> P <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> D <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 
                            Q <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"残差P值"</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"平均误差"</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
j <span class="token operator">&lt;-</span> <span class="token number">1</span>

test_model <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> P<span class="token punctuation">,</span> Q<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  model <span class="token operator">&lt;-</span> Arima<span class="token punctuation">(</span>saleroom<span class="token punctuation">,</span> order <span class="token operator">=</span> c<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 seasonal <span class="token operator">=</span> list<span class="token punctuation">(</span>order <span class="token operator">=</span> c<span class="token punctuation">(</span>P<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> Q<span class="token punctuation">)</span><span class="token punctuation">,</span> period <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  result <span class="token operator">&lt;-</span> Box.test<span class="token punctuation">(</span>model<span class="token operator">$</span>residuals<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"Ljung-Box"</span><span class="token punctuation">)</span>
  <span class="token comment"># 预测</span>
  sale.forecast <span class="token operator">&lt;-</span> forecast<span class="token punctuation">(</span>model<span class="token punctuation">,</span> h <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> level <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">99.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment"># 计算平均绝对百分误差</span>
  error <span class="token operator">&lt;-</span> abs<span class="token punctuation">(</span>as.numeric<span class="token punctuation">(</span>sale.forecast<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> sale<span class="token punctuation">[</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> sale<span class="token punctuation">[</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
  p.value <span class="token operator">&lt;-</span> round<span class="token punctuation">(</span>result<span class="token operator">$</span>p.value<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
  print<span class="token punctuation">(</span>paste<span class="token punctuation">(</span><span class="token string">'p='</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token string">';q='</span><span class="token punctuation">,</span> q<span class="token punctuation">,</span> <span class="token string">';P='</span><span class="token punctuation">,</span> P<span class="token punctuation">,</span><span class="token string">',Q='</span><span class="token punctuation">,</span> Q<span class="token punctuation">,</span> <span class="token string">';残差P值:'</span><span class="token punctuation">,</span>
              p.value<span class="token punctuation">,</span> <span class="token string">';平均误差:'</span><span class="token punctuation">,</span> mean<span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">,</span> collapse <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> p
  test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">0</span>
  test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> q
  test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> P
  test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token number">2</span>
  test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> Q
  test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> round<span class="token punctuation">(</span>result<span class="token operator">$</span>p.value<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
  test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> mean<span class="token punctuation">(</span>error<span class="token punctuation">)</span> 
  return<span class="token punctuation">(</span>test_checkout<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token keyword">in</span> c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">|</span> p <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>q <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>P <span class="token keyword">in</span> c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Q <span class="token keyword">in</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          test_checkout <span class="token operator">&lt;-</span> test_model<span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> P<span class="token punctuation">,</span> Q<span class="token punctuation">)</span>
          checkout<span class="token punctuation">[</span>j<span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token operator">&lt;-</span> test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
          j <span class="token operator">&lt;-</span> j <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>q <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Q <span class="token keyword">in</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          test_checkout <span class="token operator">&lt;-</span> test_model<span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Q<span class="token punctuation">)</span>
          checkout<span class="token punctuation">[</span>j<span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token operator">&lt;-</span> test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
          j <span class="token operator">&lt;-</span> j <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Q <span class="token keyword">in</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          test_checkout <span class="token operator">&lt;-</span> test_model<span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Q<span class="token punctuation">)</span>
          checkout<span class="token punctuation">[</span>j<span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token operator">&lt;-</span> test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
          j <span class="token operator">&lt;-</span> j <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>q <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>Q <span class="token keyword">in</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        test_checkout <span class="token operator">&lt;-</span> test_model<span class="token punctuation">(</span>p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Q<span class="token punctuation">)</span>
        checkout<span class="token punctuation">[</span>j<span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token operator">&lt;-</span> test_checkout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
        j <span class="token operator">&lt;-</span> j <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
write.csv<span class="token punctuation">(</span>checkout<span class="token punctuation">,</span> <span class="token string">"./tmp/checkout.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> F<span class="token punctuation">)</span>  <span class="token comment"># 导出每个模型的结果</span>


<span class="token comment"># 取最优模型预测</span>
model <span class="token operator">&lt;-</span> Arima<span class="token punctuation">(</span>saleroom<span class="token punctuation">,</span> order <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
               seasonal <span class="token operator">=</span> list<span class="token punctuation">(</span>order <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> period <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
summary<span class="token punctuation">(</span>model<span class="token punctuation">)</span>

Box.test<span class="token punctuation">(</span>model<span class="token operator">$</span>residuals<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"Ljung-Box"</span><span class="token punctuation">)</span>  <span class="token comment"># 纯随机性检验</span>

<span class="token comment"># 预测未来3天的销售额</span>
sale.forecast <span class="token operator">&lt;-</span> forecast<span class="token punctuation">(</span>model<span class="token punctuation">,</span> h <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> level <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">99.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plot<span class="token punctuation">(</span>sale.forecast<span class="token punctuation">)</span>

<span class="token comment"># 计算平均误差</span>
error <span class="token operator">&lt;-</span> abs<span class="token punctuation">(</span>as.numeric<span class="token punctuation">(</span>sale.forecast<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> sale<span class="token punctuation">[</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> sale<span class="token punctuation">[</span><span class="token number">29</span><span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
mean<span class="token punctuation">(</span>error<span class="token punctuation">)</span>
</code></pre> 
<p>使用协同过滤算法实现菜品的智能推荐</p> 
<pre><code class="prism language-r"><span class="token comment"># 设置工作目录并读取数据</span>
setwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
info <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./data/meal_order_info.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
detail <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./data/meal_order_detail.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 数据预处理</span>
<span class="token comment"># 菜品名称删除回车符和空格</span>
head<span class="token punctuation">(</span>detail<span class="token operator">$</span>dishes_name<span class="token punctuation">)</span>
detail<span class="token operator">$</span>dishes_name <span class="token operator">&lt;-</span> gsub<span class="token punctuation">(</span><span class="token string">"\\s|\\n+"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> detail<span class="token operator">$</span>dishes_name<span class="token punctuation">)</span>
<span class="token comment"># 删除白饭的记录</span>
detail <span class="token operator">&lt;-</span> detail<span class="token punctuation">[</span><span class="token operator">-</span>which<span class="token punctuation">(</span>detail<span class="token operator">$</span>dishes_name <span class="token operator">==</span> <span class="token string">"白饭/小碗"</span> <span class="token operator">|</span> 
                          detail<span class="token operator">$</span>dishes_name <span class="token operator">==</span> <span class="token string">"白饭/大碗"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>

<span class="token comment"># 查看订单状态</span>
table<span class="token punctuation">(</span>info<span class="token operator">$</span>order_status<span class="token punctuation">)</span>
<span class="token comment"># 统计订单状态为0或2的订单占比</span>
info.id <span class="token operator">&lt;-</span> info<span class="token punctuation">[</span>which<span class="token punctuation">(</span>info<span class="token operator">$</span>order_status <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">|</span> info<span class="token operator">$</span>order_status <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"info_id"</span><span class="token punctuation">]</span>
proportion <span class="token operator">&lt;-</span> length<span class="token punctuation">(</span>info.id<span class="token punctuation">)</span> <span class="token operator">/</span> nrow<span class="token punctuation">(</span>info<span class="token punctuation">)</span>
proportion
<span class="token comment"># 删除detail数据中无意义的订单</span>
detail <span class="token operator">&lt;-</span> detail<span class="token punctuation">[</span><span class="token operator">-</span>which<span class="token punctuation">(</span>detail<span class="token operator">$</span>order_id <span class="token percent-operator operator">%in%</span> info.id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
<span class="token comment"># 提取订单状态为1的数据</span>
info <span class="token operator">&lt;-</span> info<span class="token punctuation">[</span>which<span class="token punctuation">(</span>info<span class="token operator">$</span>order_status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>

<span class="token comment"># 特征选取</span>
info <span class="token operator">&lt;-</span> info<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
detail <span class="token operator">&lt;-</span> detail<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># 写出数据归约后的订单表和订单详情表</span>
write.csv<span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token string">"./tmp/info_clear.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
write.csv<span class="token punctuation">(</span>detail<span class="token punctuation">,</span> <span class="token string">"./tmp/detail_clear.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 【构建两个推荐模型】</span>
<span class="token comment"># 基于物品的协同过滤</span>
require<span class="token punctuation">(</span>recommenderlab<span class="token punctuation">)</span>
<span class="token comment"># 将用户ID和菜品名称转换为0-1二元型数据，即模型的输入数据集</span>
dishes <span class="token operator">&lt;-</span> as<span class="token punctuation">(</span>detail<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"binaryRatingMatrix"</span><span class="token punctuation">)</span> 
write.csv<span class="token punctuation">(</span>as<span class="token punctuation">(</span>dishes<span class="token punctuation">,</span> <span class="token string">"matrix"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"./tmp/dishes_matrix.csv"</span><span class="token punctuation">)</span>  <span class="token comment"># 导出二元型矩阵</span>

model.IBCF <span class="token operator">&lt;-</span> Recommender<span class="token punctuation">(</span>dishes<span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"IBCF"</span><span class="token punctuation">)</span>  <span class="token comment"># 建模</span>

<span class="token comment"># 导出相似度矩阵</span>
dishes.model.sim <span class="token operator">&lt;-</span> as<span class="token punctuation">(</span>model.IBCF<span class="token operator">@</span>model<span class="token operator">$</span>sim<span class="token punctuation">,</span> <span class="token string">"matrix"</span><span class="token punctuation">)</span>
write.csv<span class="token punctuation">(</span>dishes.model.sim<span class="token punctuation">,</span> <span class="token string">"./tmp/dishes_model_sim.csv"</span><span class="token punctuation">)</span>


<span class="token comment"># 利用模型对原始数据集进行预测并获得推荐长度为30的结果</span>
recommend.IBCF <span class="token operator">&lt;-</span> predict<span class="token punctuation">(</span>model.IBCF<span class="token punctuation">,</span> dishes<span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>  <span class="token comment"># 推荐列表</span>
as<span class="token punctuation">(</span>recommend.IBCF<span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">]</span>  <span class="token comment"># 查看前五个用户的推荐</span>

<span class="token comment"># 将结果保存至工作目录下的文件中，需要将结果转换为list型。</span>
<span class="token comment"># 对list型结果采用sink与print命令将其保存</span>
sink<span class="token punctuation">(</span><span class="token string">"./tmp/recommend_IBCF.txt"</span><span class="token punctuation">)</span>
print<span class="token punctuation">(</span>as<span class="token punctuation">(</span>recommend.IBCF<span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sink<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 基于用户的协同过滤</span>
model.UBCF <span class="token operator">&lt;-</span> Recommender<span class="token punctuation">(</span>dishes<span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"UBCF"</span><span class="token punctuation">)</span>  <span class="token comment"># 建模</span>
<span class="token comment"># 利用模型对原始数据集进行预测并获得推荐长度为30的结果</span>
recommend.UBCF <span class="token operator">&lt;-</span> predict<span class="token punctuation">(</span>model.UBCF<span class="token punctuation">,</span> dishes<span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>  <span class="token comment"># 推荐列表</span>
as<span class="token punctuation">(</span>recommend.UBCF<span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">]</span>  <span class="token comment"># 查看前五个用户的推荐</span>

<span class="token comment"># 将结果保存至工作目录下的文件中，需要将结果转换为list型。</span>
<span class="token comment"># 对list型结果采用sink与print命令将其保存</span>
sink<span class="token punctuation">(</span><span class="token string">"./tmp/recommend_UBCF.txt"</span><span class="token punctuation">)</span>
print<span class="token punctuation">(</span>as<span class="token punctuation">(</span>recommend.UBCF<span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sink<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 【离线评价两个推荐模型】</span>
<span class="token comment"># 评价模型</span>
algorithms <span class="token operator">&lt;-</span> list<span class="token punctuation">(</span><span class="token string">"ItemCF"</span> <span class="token operator">=</span> list<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"IBCF"</span><span class="token punctuation">,</span> param <span class="token operator">=</span> <span class="token keyword">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token string">"UserCF"</span> <span class="token operator">=</span> list<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"UBCF"</span><span class="token punctuation">,</span> param <span class="token operator">=</span> <span class="token keyword">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 将数据以交叉检验划分成10份，9份训练，1份测试</span>
dishes.es <span class="token operator">&lt;-</span> evaluationScheme<span class="token punctuation">(</span>dishes<span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"cross-validation"</span><span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> given <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># 采用算法列表对数据进行模型预测与评价，其推荐值n取15, 20, 25, 30, 35</span>
results <span class="token operator">&lt;-</span> evaluate<span class="token punctuation">(</span>dishes.es<span class="token punctuation">,</span> algorithms<span class="token punctuation">,</span> n <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 画出评价结果的图形</span>
plot<span class="token punctuation">(</span>results<span class="token punctuation">,</span> <span class="token string">"prec/rec"</span><span class="token punctuation">,</span> legend <span class="token operator">=</span> <span class="token string">"topleft"</span><span class="token punctuation">,</span> cex <span class="token operator">=</span> <span class="token number">0.67</span><span class="token punctuation">)</span>

<span class="token comment"># 构建F1的评价指标</span>
fvalue <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  return<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> p <span class="token operator">*</span> r <span class="token operator">/</span> <span class="token punctuation">(</span>p <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment"># 求两个模型的各个评价指标的均值，并将其转换为数据框的形式</span>
library<span class="token punctuation">(</span>plyr<span class="token punctuation">)</span>
index <span class="token operator">&lt;-</span> ldply<span class="token punctuation">(</span>avg<span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 将指标第一列有关于模型的名字重新命名</span>
index<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> paste<span class="token punctuation">(</span>index<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 计算两个模型的F1的指标，并将所有指标综合</span>
F1 <span class="token operator">&lt;-</span> fvalue<span class="token punctuation">(</span>index<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> index<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
dishes.Fvalue <span class="token operator">&lt;-</span> cbind<span class="token punctuation">(</span>index<span class="token punctuation">,</span> F1<span class="token punctuation">)</span>
<span class="token comment"># 对评价指标值只保留3位小数</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">2</span><span class="token operator">:</span>ncol<span class="token punctuation">(</span>dishes.Fvalue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  dishes.Fvalue<span class="token punctuation">[</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> round<span class="token punctuation">(</span>dishes.Fvalue<span class="token punctuation">[</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
write.csv<span class="token punctuation">(</span>dishes.Fvalue<span class="token punctuation">,</span> <span class="token string">"./tmp/dishes_predict_index.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
</code></pre> 
<p>使用Apriori算法实现菜品的关联分析</p> 
<pre><code class="prism language-r"><span class="token comment"># 【构建购物篮数据】</span>
<span class="token comment"># 设置工作目录并读取数据</span>
setwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
info <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./tmp/info_clear.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
detail <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./tmp/detail_clear.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>


<span class="token comment"># 建立aliment列表,每个列表代表一个订单的菜品</span>
order.id <span class="token operator">&lt;-</span> unique<span class="token punctuation">(</span>detail<span class="token operator">$</span>order_id<span class="token punctuation">)</span>  <span class="token comment"># 对id去重</span>
aliment <span class="token operator">&lt;-</span> list<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span>length<span class="token punctuation">(</span>order.id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  aliment<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> detail<span class="token punctuation">[</span>which<span class="token punctuation">(</span>detail<span class="token operator">$</span>order_id <span class="token operator">==</span> order.id<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
  aliment<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> unique<span class="token punctuation">(</span>aliment<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 去掉出现重复的事务</span>
<span class="token punctuation">}</span>

<span class="token comment"># 导出购物篮数据</span>
require<span class="token punctuation">(</span>plyr<span class="token punctuation">)</span>
aliment1 <span class="token operator">&lt;-</span> ldply<span class="token punctuation">(</span>aliment<span class="token punctuation">,</span> rbind<span class="token punctuation">)</span>  <span class="token comment"># 将列表转为数据框</span>
row.names<span class="token punctuation">(</span>aliment1<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> as.character<span class="token punctuation">(</span>order.id<span class="token punctuation">)</span>  <span class="token comment"># 修改数据框列名</span>
write.csv<span class="token punctuation">(</span>aliment1<span class="token punctuation">,</span> <span class="token string">"./tmp/aliment.csv"</span><span class="token punctuation">)</span>

<span class="token comment"># 【构建二元矩阵和Apriori模型】</span>
<span class="token comment"># 创建购物篮的二元矩阵</span>
col <span class="token operator">&lt;-</span> levels<span class="token punctuation">(</span>as.factor<span class="token punctuation">(</span>unlist<span class="token punctuation">(</span>aliment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 提取aliment列表中每个菜的菜名</span>
ruleData <span class="token operator">&lt;-</span> matrix<span class="token punctuation">(</span><span class="token boolean">FALSE</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span>aliment<span class="token punctuation">)</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span>col<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 创建一个空的矩阵</span>
colnames<span class="token punctuation">(</span>ruleData<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> col  <span class="token comment"># 修改ruleData的列名</span>
row.names<span class="token punctuation">(</span>ruleData<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> as.character<span class="token punctuation">(</span>order.id<span class="token punctuation">)</span>  <span class="token comment"># 修改ruleData的行名</span>
<span class="token comment"># 每一个订单中所包含的菜改为1</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span>length<span class="token punctuation">(</span>aliment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  ruleData<span class="token punctuation">[</span>i<span class="token punctuation">,</span> match<span class="token punctuation">(</span>aliment<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> col<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token boolean">TRUE</span>
<span class="token punctuation">}</span>

write.csv<span class="token punctuation">(</span>ruleData<span class="token punctuation">,</span> <span class="token string">"./tmp/ruleData.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>  <span class="token comment"># 导出二元矩阵</span>


<span class="token comment"># 构建关联规则模型</span>
library<span class="token punctuation">(</span>arules<span class="token punctuation">)</span>
<span class="token comment"># 把数据转换成关联规则需要的数据类型</span>
trans <span class="token operator">&lt;-</span> as<span class="token punctuation">(</span>aliment<span class="token punctuation">,</span> <span class="token string">"transactions"</span><span class="token punctuation">)</span>
<span class="token comment"># 或直接使用ruleData数据进行建模</span>
<span class="token comment"># trans &lt;- read.csv("./tmp/ruleData.csv", stringsAsFactors = FALSE)</span>

<span class="token comment"># 查看数据集前5行数据</span>
inspect<span class="token punctuation">(</span>trans<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 生成关联规则</span>
rules <span class="token operator">&lt;-</span> apriori<span class="token punctuation">(</span>trans<span class="token punctuation">,</span> parameter <span class="token operator">=</span> list<span class="token punctuation">(</span>support <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">,</span> confidence <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
summary<span class="token punctuation">(</span>rules<span class="token punctuation">)</span>
inspect<span class="token punctuation">(</span>sort<span class="token punctuation">(</span>rules<span class="token punctuation">,</span> by <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token string">'support'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 查看前10个支持度较高的规则</span>

<span class="token comment"># 绝对数量显示</span>
itemFrequencyPlot<span class="token punctuation">(</span>trans<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span> topN <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> horiz <span class="token operator">=</span> T<span class="token punctuation">)</span>

<span class="token comment"># 查看前项为"芹菜炒腰花" 的规则</span>
item <span class="token operator">&lt;-</span> subset<span class="token punctuation">(</span>rules<span class="token punctuation">,</span> subset <span class="token operator">=</span> rhs <span class="token percent-operator operator">%in%</span> <span class="token string">"芹菜炒腰花"</span><span class="token punctuation">)</span>
inspect<span class="token punctuation">(</span>sort<span class="token punctuation">(</span>item<span class="token punctuation">,</span> by <span class="token operator">=</span> <span class="token string">"support"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 导出规则数据</span>
write<span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">"./tmp/item.csv"</span><span class="token punctuation">,</span> sep <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
write<span class="token punctuation">(</span>rules<span class="token punctuation">,</span> <span class="token string">"./tmp/rules.csv"</span><span class="token punctuation">,</span> sep <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 【提取规则的前项和后项】</span>
<span class="token comment"># 处理规则数据</span>
result <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./tmp/rules.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
<span class="token comment"># 将规则拆开</span>
meal.recom <span class="token operator">&lt;-</span> strsplit<span class="token punctuation">(</span>result<span class="token operator">$</span>rules<span class="token punctuation">,</span> <span class="token string">"=&gt;"</span><span class="token punctuation">)</span>

<span class="token comment"># 去除中括号</span>
lhs <span class="token operator">&lt;-</span> <span class="token number">0</span>
rhs <span class="token operator">&lt;-</span> <span class="token number">0</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span>length<span class="token punctuation">(</span>meal.recom<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  lhs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> gsub<span class="token punctuation">(</span><span class="token string">"[{|}+\n]|\\s"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> meal.recom<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  rhs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> gsub<span class="token punctuation">(</span><span class="token string">"[{|}+\n]|\\s"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> meal.recom<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

rules.new <span class="token operator">&lt;-</span> data.frame<span class="token punctuation">(</span>lhs <span class="token operator">=</span> lhs<span class="token punctuation">,</span> rhs <span class="token operator">=</span> rhs<span class="token punctuation">,</span> support <span class="token operator">=</span> result<span class="token operator">$</span>support<span class="token punctuation">,</span>
                        confidence <span class="token operator">=</span> result<span class="token operator">$</span>confidence<span class="token punctuation">,</span> lift <span class="token operator">=</span> result<span class="token operator">$</span>lift<span class="token punctuation">)</span>

write.csv<span class="token punctuation">(</span>rules.new<span class="token punctuation">,</span> <span class="token string">"./tmp/rules_new.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>  <span class="token comment"># 写出数据</span>

<span class="token comment"># 【进行综合得分】</span>
<span class="token comment"># 计算综合评分</span>
<span class="token comment"># 读取数据</span>
rules.new <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./tmp/rules_new.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
sales_volume <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./tmp/sales_volume.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
profit <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./tmp/profit.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
dish <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./data/meal_dishes_detail.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 统计前项</span>
rules.count <span class="token operator">&lt;-</span> as.data.frame<span class="token punctuation">(</span>table<span class="token punctuation">(</span>rules.new<span class="token operator">$</span>lhs<span class="token punctuation">)</span><span class="token punctuation">)</span>
rules.count <span class="token operator">&lt;-</span> rules.count<span class="token punctuation">[</span>order<span class="token punctuation">(</span>rules.count<span class="token operator">$</span>Freq<span class="token punctuation">,</span> decreasing <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>

<span class="token comment"># 提取前项为“芹菜炒腰花,孜然羊排”的数据，对推荐的菜品进行综合评分</span>
<span class="token comment"># 计算每个菜所推荐的菜的综合评分</span>
<span class="token comment"># 设A的权重a1 = 1.5, a2 = 2.5, a3 = 2, a4 = 4</span>
A <span class="token operator">&lt;-</span> matrix<span class="token punctuation">(</span>c<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> 
              <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>
              <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>
              <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> byrow <span class="token operator">=</span> T<span class="token punctuation">)</span>
E <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 初始化</span>
rules.new<span class="token operator">$</span>sales <span class="token operator">&lt;-</span> <span class="token number">0</span>  <span class="token comment"># 热销度</span>
rules.new<span class="token operator">$</span>recommendation <span class="token operator">&lt;-</span> <span class="token number">0</span>  <span class="token comment"># 主推度</span>
rules.new<span class="token operator">$</span>profit <span class="token operator">&lt;-</span> <span class="token number">0</span>  <span class="token comment"># 毛利率</span>
rules.new<span class="token operator">$</span>mark <span class="token operator">&lt;-</span> <span class="token number">0</span>  <span class="token comment"># 综合评分</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span>nrow<span class="token punctuation">(</span>rules.new<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment"># 找到对应的热销度</span>
  sales.num <span class="token operator">&lt;-</span> which<span class="token punctuation">(</span>sales_volume<span class="token operator">$</span>dishes_name <span class="token operator">==</span> rules.new<span class="token operator">$</span>rhs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  rules.new<span class="token operator">$</span>sales<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> sales_volume<span class="token operator">$</span>sales_hot<span class="token punctuation">[</span>sales.num<span class="token punctuation">]</span>
  
  <span class="token comment"># 找到对应的毛利率和主推度</span>
  profit.num <span class="token operator">&lt;-</span> which<span class="token punctuation">(</span>profit<span class="token operator">$</span>dishes_name <span class="token operator">==</span> rules.new<span class="token operator">$</span>rhs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  rules.new<span class="token operator">$</span>profit<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> profit<span class="token operator">$</span>rate<span class="token punctuation">[</span>profit.num<span class="token punctuation">]</span>
  rules.new<span class="token operator">$</span>recommendation<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> profit<span class="token operator">$</span>recommend_percent<span class="token punctuation">[</span>profit.num<span class="token punctuation">]</span>
  
  <span class="token comment"># 计算综合评分</span>
  Y <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span>rules.new<span class="token operator">$</span>sales<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> rules.new<span class="token operator">$</span>recommendation<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> 
         rules.new<span class="token operator">$</span>profit<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> rules.new<span class="token operator">$</span>confidence<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  rules.new<span class="token operator">$</span>mark<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> round<span class="token punctuation">(</span><span class="token punctuation">(</span>E <span class="token operator">-</span> Y<span class="token punctuation">)</span> <span class="token percent-operator operator">%*%</span> A <span class="token percent-operator operator">%*%</span> t<span class="token punctuation">(</span>t<span class="token punctuation">(</span>Y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment"># 对综合评分进行排序</span>
rules.new <span class="token operator">&lt;-</span> rules.new<span class="token punctuation">[</span>order<span class="token punctuation">(</span>rules.new<span class="token operator">$</span>mark<span class="token punctuation">,</span> decreasing <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>

write.csv<span class="token punctuation">(</span>rules.new<span class="token punctuation">,</span> <span class="token string">"./tmp/recommend.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>  <span class="token comment"># 写出数据</span>


<span class="token comment"># 选取后项为"芹菜炒腰花" 的数据</span>
rules.item <span class="token operator">&lt;-</span> rules.new<span class="token punctuation">[</span>which<span class="token punctuation">(</span>rules.new<span class="token operator">$</span>rhs <span class="token operator">==</span> <span class="token string">"芹菜炒腰花"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
write.csv<span class="token punctuation">(</span>rules.item<span class="token punctuation">,</span> <span class="token string">"./tmp/rules_item.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
</code></pre> 
<p>使用K-means算法进行客户价值分析</p> 
<pre><code class="prism language-r"><span class="token comment"># 【数据预处理】</span>
<span class="token comment"># 设置工作目录并读取数据</span>
setwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
info <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./data/meal_order_info.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
users <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./data/users.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 数据预处理</span>
info <span class="token operator">&lt;-</span> info<span class="token punctuation">[</span>which<span class="token punctuation">(</span>info<span class="token operator">$</span>order_status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>  <span class="token comment"># 提取有效订单</span>

<span class="token comment"># 对info的时间列按用户的ID去重</span>
info_time <span class="token operator">&lt;-</span> info<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token string">"emp_id"</span><span class="token punctuation">,</span> <span class="token string">"use_start_time"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
library<span class="token punctuation">(</span>plyr<span class="token punctuation">)</span>
info_time <span class="token operator">&lt;-</span> ddply<span class="token punctuation">(</span>info_time<span class="token punctuation">,</span> .<span class="token punctuation">(</span>emp_id<span class="token punctuation">)</span><span class="token punctuation">,</span> tail<span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 匹配用户的最后一次用餐时间</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span>nrow<span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  num <span class="token operator">&lt;-</span> which<span class="token punctuation">(</span>users<span class="token operator">$</span>USER_ID <span class="token operator">==</span> info<span class="token operator">$</span>emp_id<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  users<span class="token punctuation">[</span>num<span class="token punctuation">,</span> <span class="token string">"LAST_VISITS"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> info<span class="token operator">$</span>use_start_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

user <span class="token operator">&lt;-</span> users<span class="token punctuation">[</span><span class="token operator">-</span>which<span class="token punctuation">(</span>users<span class="token operator">$</span>LAST_VISITS <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 特征选取</span>

<span class="token comment"># 构建RFM特征</span>
<span class="token comment"># 构建F特征</span>
user.value1 <span class="token operator">&lt;-</span> as.data.frame<span class="token punctuation">(</span>table<span class="token punctuation">(</span>info<span class="token operator">$</span>emp_id<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 统计每个人的用餐次数</span>
colnames<span class="token punctuation">(</span>user.value1<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token string">"USER_ID"</span><span class="token punctuation">,</span> <span class="token string">"F"</span><span class="token punctuation">)</span>  <span class="token comment"># 修改列名</span>

<span class="token comment"># 构建M特征</span>
user.value2 <span class="token operator">&lt;-</span> aggregate<span class="token punctuation">(</span>info<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token string">"expenditure"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> list<span class="token punctuation">(</span>info<span class="token operator">$</span>emp_id<span class="token punctuation">)</span><span class="token punctuation">,</span> FUN <span class="token operator">=</span> <span class="token string">'sum'</span><span class="token punctuation">)</span>
colnames<span class="token punctuation">(</span>user.value2<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token string">"USER_ID"</span><span class="token punctuation">,</span> <span class="token string">"M"</span><span class="token punctuation">)</span>
user.value <span class="token operator">&lt;-</span> merge<span class="token punctuation">(</span>user.value1<span class="token punctuation">,</span> user.value2<span class="token punctuation">,</span> by <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">"USER_ID"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 合并两个表</span>

<span class="token comment"># 构建R特征</span>
user.value <span class="token operator">&lt;-</span> merge<span class="token punctuation">(</span>user.value<span class="token punctuation">,</span> user<span class="token punctuation">,</span> by <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">"USER_ID"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 合并两个表</span>
<span class="token comment"># 转换时间格式</span>
last_time <span class="token operator">&lt;-</span> as.Date<span class="token punctuation">(</span>user.value<span class="token operator">$</span>LAST_VISITS<span class="token punctuation">,</span> <span class="token string">"%Y/%m/%d"</span><span class="token punctuation">)</span>
finally <span class="token operator">&lt;-</span> as.Date<span class="token punctuation">(</span><span class="token string">"2016-8-31"</span><span class="token punctuation">)</span>  <span class="token comment"># 观测窗口结束时间</span>

user.value<span class="token operator">$</span>R <span class="token operator">&lt;-</span> as.numeric<span class="token punctuation">(</span>difftime<span class="token punctuation">(</span>finally<span class="token punctuation">,</span> last_time<span class="token punctuation">,</span> units <span class="token operator">=</span> <span class="token string">"days"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

user.value <span class="token operator">&lt;-</span> user.value<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 特征提取</span>
write.csv<span class="token punctuation">(</span>user.value<span class="token punctuation">,</span> <span class="token string">"./tmp/user_value.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 【构建模型】</span>
<span class="token comment"># 确定类数</span>
user.value <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./tmp/user_value.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
USER_ID <span class="token operator">&lt;-</span> user.value<span class="token operator">$</span>USER_ID
ACCOUNT <span class="token operator">&lt;-</span> user.value<span class="token operator">$</span>ACCOUNT
user.value <span class="token operator">&lt;-</span> user.value<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">-</span>c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># 标准化数据</span>
standard <span class="token operator">&lt;-</span> scale<span class="token punctuation">(</span>user.value<span class="token punctuation">)</span>  <span class="token comment"># 数据标准化</span>
write.csv<span class="token punctuation">(</span>standard<span class="token punctuation">,</span> <span class="token string">'./tmp/standard.csv'</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>  <span class="token comment"># 写出数据</span>

<span class="token comment"># 求组间距离平方和与总体距离平方和的比值（betweenss / totss，越接近1越好）</span>
BT <span class="token operator">&lt;-</span> <span class="token number">0</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  model <span class="token operator">&lt;-</span> kmeans<span class="token punctuation">(</span>user.value<span class="token punctuation">,</span> centers <span class="token operator">=</span> i<span class="token punctuation">)</span>
  BT<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> model<span class="token operator">$</span>betweenss <span class="token operator">/</span> model<span class="token operator">$</span>totss
<span class="token punctuation">}</span>
plot<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span> BT<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"b"</span><span class="token punctuation">,</span> xlab <span class="token operator">=</span> <span class="token string">"聚类数"</span><span class="token punctuation">,</span> ylab <span class="token operator">=</span> <span class="token string">"组间平方和/总体距离平方和"</span><span class="token punctuation">)</span>

<span class="token comment"># 构建模型</span>
set.seed<span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
result <span class="token operator">&lt;-</span> kmeans<span class="token punctuation">(</span>standard<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

result<span class="token operator">$</span>center  <span class="token comment"># 查看聚类中心值</span>
result<span class="token operator">$</span>size  <span class="token comment"># 查看每一类的个数</span>

<span class="token comment"># 导出聚类后的数据</span>
users.class <span class="token operator">&lt;-</span> cbind<span class="token punctuation">(</span>USER_ID<span class="token punctuation">,</span> ACCOUNT<span class="token punctuation">,</span> user.value<span class="token punctuation">,</span> class <span class="token operator">=</span> result<span class="token operator">$</span>cluster<span class="token punctuation">)</span>
write.csv<span class="token punctuation">(</span>users.class<span class="token punctuation">,</span> <span class="token string">"./tmp/users_class.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 每一簇各指标的关系程度--雷达图</span>
library<span class="token punctuation">(</span>fmsb<span class="token punctuation">)</span>
max <span class="token operator">&lt;-</span> apply<span class="token punctuation">(</span>result<span class="token operator">$</span>centers<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> max<span class="token punctuation">)</span>
min <span class="token operator">&lt;-</span> apply<span class="token punctuation">(</span>result<span class="token operator">$</span>centers<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> min<span class="token punctuation">)</span>
radar <span class="token operator">&lt;-</span> data.frame<span class="token punctuation">(</span>rbind<span class="token punctuation">(</span>max<span class="token punctuation">,</span> min<span class="token punctuation">,</span> result<span class="token operator">$</span>centers<span class="token punctuation">)</span><span class="token punctuation">)</span>
radarchart<span class="token punctuation">(</span>radar<span class="token punctuation">,</span> pty <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">,</span> plty <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plwd <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> vlcex <span class="token operator">=</span> <span class="token number">1.2</span><span class="token punctuation">)</span>  <span class="token comment"># 画雷达图</span>
<span class="token comment"># 给雷达图加图例</span>
L <span class="token operator">&lt;-</span> <span class="token number">1.2</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  legend<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> L<span class="token punctuation">,</span> legend <span class="token operator">=</span> paste<span class="token punctuation">(</span><span class="token string">"客户群"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> lty <span class="token operator">=</span> i<span class="token punctuation">,</span> lwd <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> col <span class="token operator">=</span> i<span class="token punctuation">,</span> bty <span class="token operator">=</span> <span class="token string">"n"</span><span class="token punctuation">)</span>
  L <span class="token operator">&lt;-</span> L <span class="token operator">-</span> <span class="token number">0.3</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>用决策树算法实现餐饮客户流失预测</p> 
<pre><code class="prism language-r"><span class="token comment"># 【合并客户信息表和订单表】</span>
<span class="token comment"># 设置工作目录</span>
setwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 合并两个表</span>
<span class="token comment"># 读取数据</span>
users <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./data/user_loss.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
info <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./data/info_new.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 将时间转为时间格式</span>
library<span class="token punctuation">(</span>lubridate<span class="token punctuation">)</span>
info<span class="token operator">$</span>use_start_time <span class="token operator">&lt;-</span> parse_date_time<span class="token punctuation">(</span>info<span class="token operator">$</span>use_start_time<span class="token punctuation">,</span> orders <span class="token operator">=</span> <span class="token string">"YmdHMS"</span><span class="token punctuation">)</span>
<span class="token comment"># info$lock_time &lt;- parse_date_time(info$lock_time, orders = "YmdHMS")</span>
<span class="token comment"># users$CREATED &lt;- parse_date_time(users$CREATED, orders = "YmdHMS")</span>

<span class="token comment"># 对info的时间列按用户的ID去重</span>
info_time <span class="token operator">&lt;-</span> info<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token string">"emp_id"</span><span class="token punctuation">,</span> <span class="token string">"use_start_time"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
library<span class="token punctuation">(</span>plyr<span class="token punctuation">)</span>
info_time <span class="token operator">&lt;-</span> ddply<span class="token punctuation">(</span>info_time<span class="token punctuation">,</span> .<span class="token punctuation">(</span>emp_id<span class="token punctuation">)</span><span class="token punctuation">,</span> tail<span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 匹配用户的最后一次用餐时间</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span>nrow<span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  info1 <span class="token operator">&lt;-</span> info<span class="token punctuation">[</span>which<span class="token punctuation">(</span>info<span class="token operator">$</span>name <span class="token operator">==</span> users<span class="token operator">$</span>ACCOUNT<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>  <span class="token comment"># 提取某用户的订单数据</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>info1<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    info1 <span class="token operator">&lt;-</span> info1<span class="token punctuation">[</span>order<span class="token punctuation">(</span>info1<span class="token operator">$</span>use_start_time<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
    users<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token string">"LAST_VISITS"</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> as.character<span class="token punctuation">(</span>info1<span class="token operator">$</span>use_start_time<span class="token punctuation">[</span>nrow<span class="token punctuation">(</span>info1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 特征选取</span>
user <span class="token operator">&lt;-</span> users<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
info <span class="token operator">&lt;-</span> info<span class="token punctuation">[</span>which<span class="token punctuation">(</span>info<span class="token operator">$</span>order_status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 提取有效订单</span>

names<span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> <span class="token string">"USER_ID"</span>  <span class="token comment"># 修改列名</span>

info.user <span class="token operator">&lt;-</span> merge<span class="token punctuation">(</span>user<span class="token punctuation">,</span> info<span class="token punctuation">,</span> by <span class="token operator">=</span> <span class="token string">"USER_ID"</span><span class="token punctuation">)</span>  <span class="token comment"># 合并两个表</span>
write.csv<span class="token punctuation">(</span>info.user<span class="token punctuation">,</span> <span class="token string">"./tmp/info_user.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 【构建特征】</span>
info.user <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./tmp/info_user.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 提取info表的用户名和用餐时间，并按人名对用餐人数和金额进行分组求和</span>
info.user1 <span class="token operator">&lt;-</span> as.data.frame<span class="token punctuation">(</span>table<span class="token punctuation">(</span>info.user<span class="token operator">$</span>USER_ID<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 统计每个人的用餐次数</span>
colnames<span class="token punctuation">(</span>info.user1<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token string">"USER_ID"</span><span class="token punctuation">,</span> <span class="token string">"frequence"</span><span class="token punctuation">)</span>  <span class="token comment"># 修改列名</span>

<span class="token comment"># 求出每个人的消费总金额</span>
info.user2 <span class="token operator">&lt;-</span> aggregate<span class="token punctuation">(</span>info.user<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"number_consumers"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"expenditure"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                        list<span class="token punctuation">(</span>info.user<span class="token operator">$</span>USER_ID<span class="token punctuation">)</span><span class="token punctuation">,</span> FUN <span class="token operator">=</span> <span class="token string">"sum"</span><span class="token punctuation">)</span>  <span class="token comment"># 分组求和</span>
colnames<span class="token punctuation">(</span>info.user2<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token string">"USER_ID"</span><span class="token punctuation">,</span> <span class="token string">"numbers"</span><span class="token punctuation">,</span> <span class="token string">"amount"</span><span class="token punctuation">)</span>
info.user.new <span class="token operator">&lt;-</span> merge<span class="token punctuation">(</span>info.user1<span class="token punctuation">,</span> info.user2<span class="token punctuation">,</span> by <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">"USER_ID"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 合并两个表</span>

<span class="token comment"># 对合并后的数据进行处理</span>
info.user <span class="token operator">&lt;-</span> info.user<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
library<span class="token punctuation">(</span>plyr<span class="token punctuation">)</span>
info.user <span class="token operator">&lt;-</span> ddply<span class="token punctuation">(</span>info.user<span class="token punctuation">,</span> .<span class="token punctuation">(</span>USER_ID<span class="token punctuation">,</span> LAST_VISITS<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">,</span> tail<span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>

info.user.new <span class="token operator">&lt;-</span> merge<span class="token punctuation">(</span>info.user.new<span class="token punctuation">,</span> info.user<span class="token punctuation">,</span> by <span class="token operator">=</span> <span class="token string">"USER_ID"</span><span class="token punctuation">)</span>  <span class="token comment"># 合并两个表</span>


<span class="token comment"># 求平均消费金额，并保留2为小数</span>
info.user.new<span class="token operator">$</span>average <span class="token operator">&lt;-</span> round<span class="token punctuation">(</span>info.user.new<span class="token operator">$</span>amount <span class="token operator">/</span> info.user.new<span class="token operator">$</span>numbers<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># 计算每个客户最近一次点餐的时间距离观测窗口结束的天数</span>
<span class="token comment"># 修改时间列，改为日期</span>
info.user.new<span class="token operator">$</span>LAST_VISITS <span class="token operator">&lt;-</span> as.Date<span class="token punctuation">(</span>info.user.new<span class="token operator">$</span>LAST_VISITS<span class="token punctuation">)</span>

datefinally <span class="token operator">&lt;-</span> as.Date<span class="token punctuation">(</span><span class="token string">"2016-7-31"</span><span class="token punctuation">)</span>  <span class="token comment"># 观测窗口结束时间</span>

info.user.new<span class="token operator">$</span>recently  <span class="token operator">&lt;-</span> difftime<span class="token punctuation">(</span>datefinally<span class="token punctuation">,</span> info.user.new<span class="token operator">$</span>LAST_VISITS<span class="token punctuation">,</span> 
                                    units <span class="token operator">=</span> <span class="token string">"days"</span><span class="token punctuation">)</span>  <span class="token comment"># 计算时间差</span>
info.user.new<span class="token operator">$</span>recently  <span class="token operator">&lt;-</span> as.numeric<span class="token punctuation">(</span>info.user.new<span class="token operator">$</span>recently <span class="token punctuation">)</span>  <span class="token comment"># 转为数值型</span>

info.user.new <span class="token operator">&lt;-</span> info.user.new<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 特征选取</span>
write.csv<span class="token punctuation">(</span>info.user.new<span class="token punctuation">,</span> <span class="token string">"./tmp/info_user_clear.csv"</span><span class="token punctuation">,</span> row.names <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 【构建决策树模型并评价】</span>
<span class="token comment"># 划分测试集、训练集</span>
info.user <span class="token operator">&lt;-</span> read.csv<span class="token punctuation">(</span><span class="token string">"./tmp/info_user_clear.csv"</span><span class="token punctuation">,</span> stringsAsFactors <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

<span class="token comment"># 删除流失用户</span>
info.user <span class="token operator">&lt;-</span> info.user<span class="token punctuation">[</span><span class="token operator">-</span>which<span class="token punctuation">(</span>info.user<span class="token operator">$</span>type <span class="token operator">==</span> <span class="token string">"已流失"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>

model.data <span class="token operator">&lt;-</span> info.user<span class="token punctuation">[</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
model.data<span class="token operator">$</span>type <span class="token operator">&lt;-</span> as.factor<span class="token punctuation">(</span>model.data<span class="token operator">$</span>type<span class="token punctuation">)</span>  <span class="token comment"># 将类标号转换为因子型</span>

set.seed<span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">)</span>  <span class="token comment"># 设置随机种子</span>
ind <span class="token operator">&lt;-</span> sample<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> nrow<span class="token punctuation">(</span>model.data<span class="token punctuation">)</span><span class="token punctuation">,</span> replace <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span> prob <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
train <span class="token operator">&lt;-</span> model.data<span class="token punctuation">[</span>ind <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>
test <span class="token operator">&lt;-</span> model.data<span class="token punctuation">[</span>ind <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">]</span>

<span class="token comment"># 查看样本分布</span>
table<span class="token punctuation">(</span>train<span class="token operator">$</span>type<span class="token punctuation">)</span>
table<span class="token punctuation">(</span>test<span class="token operator">$</span>type<span class="token punctuation">)</span>


<span class="token comment"># 构建决策树模型</span>
library<span class="token punctuation">(</span>rpart<span class="token punctuation">)</span>
<span class="token comment"># method="class"为分类树；</span>
<span class="token comment"># parms = list(split = "information")为选择信息熵计算纯度；</span>
<span class="token comment"># xval设置交叉验证次数；minsplit设置最小分割；cp设置剪枝率。</span>
rpart <span class="token operator">&lt;-</span> rpart<span class="token punctuation">(</span>type <span class="token operator">~</span> .<span class="token punctuation">,</span> train<span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"class"</span><span class="token punctuation">,</span>
               parms <span class="token operator">=</span> list<span class="token punctuation">(</span>split <span class="token operator">=</span> <span class="token string">"information"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               control<span class="token operator">=</span>rpart.control<span class="token punctuation">(</span>xval <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> minsplit <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> cp <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 画树</span>
library<span class="token punctuation">(</span>rattle<span class="token punctuation">)</span>
fancyRpartPlot<span class="token punctuation">(</span>rpart<span class="token punctuation">,</span> cex <span class="token operator">=</span> <span class="token number">0.7</span><span class="token punctuation">)</span>  <span class="token comment"># 画决策图彩色图</span>
asRules<span class="token punctuation">(</span>rpart<span class="token punctuation">)</span>  <span class="token comment"># 导出决策规则</span>

<span class="token comment">#  测试集预测</span>
pre.rpart <span class="token operator">&lt;-</span> predict<span class="token punctuation">(</span>rpart<span class="token punctuation">,</span> test<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"class"</span><span class="token punctuation">)</span>  <span class="token comment"># 预测</span>
table.pre <span class="token operator">&lt;-</span> table<span class="token punctuation">(</span>test<span class="token operator">$</span>type<span class="token punctuation">,</span> pre.rpart<span class="token punctuation">)</span>  <span class="token comment"># 混淆矩阵</span>

<span class="token punctuation">(</span>P <span class="token operator">&lt;-</span> table.pre<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> sum<span class="token punctuation">(</span>table.pre<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 精确率</span>
<span class="token punctuation">(</span>R <span class="token operator">&lt;-</span> table.pre<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> sum<span class="token punctuation">(</span>table.pre<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 召回率</span>
<span class="token punctuation">(</span>F1 <span class="token operator">&lt;-</span> <span class="token number">2</span> <span class="token operator">*</span> P <span class="token operator">*</span> R <span class="token operator">/</span> <span class="token punctuation">(</span>P <span class="token operator">+</span> R<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a0f002efaeb5d1dcf98a63ae86f9d126/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">看书标记【R语言 商务数据分析实战4】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/47791dc236e388995a5e505b579f222d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">c&#43;&#43;中多重继承应用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>