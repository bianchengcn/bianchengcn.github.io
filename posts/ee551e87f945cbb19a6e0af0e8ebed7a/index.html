<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【笔记】Python3｜爬虫请求 CSRF-Token 时如何获取Token、Token过期、处理 CSRF-Token 需要注意的问题及示例 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【笔记】Python3｜爬虫请求 CSRF-Token 时如何获取Token、Token过期、处理 CSRF-Token 需要注意的问题及示例" />
<meta property="og:description" content="CSRF-Token 机制是 Web 应用程序中常用的安全机制，它可以防止跨站请求伪造攻击，但会给爬虫造成一定的困扰。本文将介绍在使用 Python3 爬虫时，处理 CSRF-Token 机制需要注意的问题及示例。
文章目录 1 CSRF-Token 机制的原理2 爬虫处理 CSRF-Token 机制的问题3 CSRF-Token 可能存在的位置3.1 CSRF-Token 位于 Web 表单时3.1.1 使用 Beautiful Soup 库3.1.2 使用正则表达式 3.2 CSRF-Token 位于 响应体 时3.3 CSRF-Token 位于 响应头 时3.4 注意事项 4 将 CSRF-Token 嵌入到请求中4.1 CSRF-Token 嵌入请求头4.2 CSRF-Token 嵌入请求参数 5 示例6 总结 1 CSRF-Token 机制的原理 在 Web 开发中，每次发送请求时，服务器都会生成一个 CSRF-Token。当用户访问 Web 页面时，该 CSRF-Token 将被嵌入到 Web 表单、请求 URL 或 请求头 中。当用户提交表单或者发送请求时，该 CSRF-Token 将会被服务器验证，以防止跨站请求伪造攻击。
2 爬虫处理 CSRF-Token 机制的问题 由于爬虫不同于浏览器，它无法直接接收服务器生成的 CSRF-Token。因此，在使用爬虫时，我们需要解决如下问题：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/ee551e87f945cbb19a6e0af0e8ebed7a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-02T00:58:27+08:00" />
<meta property="article:modified_time" content="2023-05-02T00:58:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【笔记】Python3｜爬虫请求 CSRF-Token 时如何获取Token、Token过期、处理 CSRF-Token 需要注意的问题及示例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>  CSRF-Token 机制是 Web 应用程序中常用的安全机制，它可以防止跨站请求伪造攻击，但会给爬虫造成一定的困扰。本文将介绍在使用 Python3 爬虫时，<strong>处理 CSRF-Token 机制需要注意的问题及示例</strong>。</p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1_CSRFToken__3" rel="nofollow">1 CSRF-Token 机制的原理</a></li><li><a href="#2__CSRFToken__6" rel="nofollow">2 爬虫处理 CSRF-Token 机制的问题</a></li><li><a href="#3_CSRFToken__12" rel="nofollow">3 CSRF-Token 可能存在的位置</a></li><li><ul><li><a href="#31_CSRFToken__Web__20" rel="nofollow">3.1 CSRF-Token 位于 Web 表单时</a></li><li><ul><li><a href="#311__Beautiful_Soup__23" rel="nofollow">3.1.1 使用 Beautiful Soup 库</a></li><li><a href="#312__41" rel="nofollow">3.1.2 使用正则表达式</a></li></ul> 
   </li><li><a href="#32_CSRFToken____54" rel="nofollow">3.2 CSRF-Token 位于 响应体 时</a></li><li><a href="#33_CSRFToken____92" rel="nofollow">3.3 CSRF-Token 位于 响应头 时</a></li><li><a href="#34__116" rel="nofollow">3.4 注意事项</a></li></ul> 
  </li><li><a href="#4__CSRFToken__153" rel="nofollow">4 将 CSRF-Token 嵌入到请求中</a></li><li><ul><li><a href="#41_CSRFToken__156" rel="nofollow">4.1 CSRF-Token 嵌入请求头</a></li><li><a href="#42_CSRFToken__177" rel="nofollow">4.2 CSRF-Token 嵌入请求参数</a></li></ul> 
  </li><li><a href="#5__198" rel="nofollow">5 示例</a></li><li><a href="#6__238" rel="nofollow">6 总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1_CSRFToken__3"></a>1 CSRF-Token 机制的原理</h2> 
<p>  在 Web 开发中，每次发送请求时，服务器都会生成一个 CSRF-Token。当用户访问 Web 页面时，该 CSRF-Token 将被嵌入到 <strong>Web 表单</strong>、<strong>请求 URL</strong> 或 <strong>请求头</strong> 中。当用户提交表单或者发送请求时，该 CSRF-Token 将会被服务器验证，以防止跨站请求伪造攻击。</p> 
<h2><a id="2__CSRFToken__6"></a>2 爬虫处理 CSRF-Token 机制的问题</h2> 
<p>  由于爬虫不同于浏览器，它无法直接接收服务器生成的 CSRF-Token。因此，在使用爬虫时，我们需要解决如下问题：</p> 
<ol><li>CSRF-Token 在哪生成？</li><li>如何将 CSRF-Token 嵌入到请求中？</li></ol> 
<h2><a id="3_CSRFToken__12"></a>3 CSRF-Token 可能存在的位置</h2> 
<p>  在使用 Python3 爬虫时，针对不同类型的 CSRF-Token 有不同的获取方法。一般来说，CSRF-Token 可能位于 Web 表单、响应头或响应体中。</p> 
<p>  如果你认为 CSRF-Token 位于请求 URL 或 请求头 中，你需要找到生成 CSRF-Token 的具体请求报文或者网页元素，而不是从这个请求 URL 中直接分离 CSRF-Token。因为 CSRF-Token 会动态更新。具体来说，我们需要先分析网页或者应用程序，找到生成 CSRF-Token 的具体请求报文或者网页元素，然后从中获取 CSRF-Token。</p> 
<p>  下面，我们将分别介绍这三种情况的获取方法。</p> 
<h3><a id="31_CSRFToken__Web__20"></a>3.1 CSRF-Token 位于 Web 表单时</h3> 
<p>  如果 CSRF-Token 位于 Web 表单中，我们可以使用 <code>Beautiful Soup</code> 库或者正则表达式来查找表单元素，然后获取 CSRF-Token。具体代码如下所示：</p> 
<h4><a id="311__Beautiful_Soup__23"></a>3.1.1 使用 Beautiful Soup 库</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup

url <span class="token operator">=</span> <span class="token string">'http://example.com'</span>

response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
csrf_token <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'csrf_token'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span>
</code></pre> 
<p>在上面的代码中，我们使用 requests 库来发送 GET 请求，并使用 Beautiful Soup 库来查找 CSRF-Token。</p> 
<p>其中 <code>Beautiful Soup</code> 库需要使用pip3安装：</p> 
<pre><code class="prism language-bash">pip3 <span class="token function">install</span> BeautifulSoup4
</code></pre> 
<h4><a id="312__41"></a>3.1.2 使用正则表达式</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> re
<span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">'http://example.com'</span>

response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

csrf_token <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r'&lt;input.*?name="csrf_token".*?value="(.*?)".*?&gt;'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre> 
<p>在上面的代码中，我们使用 requests 库来发送 GET 请求，并使用正则表达式来匹配 CSRF-Token。</p> 
<h3><a id="32_CSRFToken____54"></a>3.2 CSRF-Token 位于 响应体 时</h3> 
<p>  我们需要首先通过分析 HTML 页面或者 JavaScript 代码，找到生成 CSRF-Token 的具体请求报文。比如，假设生成 CSRF-Token 的请求报文为：</p> 
<pre><code class="prism language-bash">POST /api/csrf_token HTTP/1.1
Host: example.com
Content-Type: application/json
Authorization: Bearer <span class="token number">1234567890</span>

<span class="token punctuation">{<!-- --></span><span class="token string">"user_id"</span><span class="token builtin class-name">:</span> <span class="token string">"1234567890"</span><span class="token punctuation">}</span>
</code></pre> 
<p>  我们可以使用 requests 库来发送该请求报文，并<strong>从响应体中</strong>获取 CSRF-Token。具体代码如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">'http://example.com/api/csrf_token'</span>

headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'Authorization'</span><span class="token punctuation">:</span> <span class="token string">'Bearer 1234567890'</span><span class="token punctuation">,</span>
    <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span>
<span class="token punctuation">}</span>

data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'user_id'</span><span class="token punctuation">:</span> <span class="token string">'1234567890'</span>
<span class="token punctuation">}</span>

response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> json<span class="token operator">=</span>data<span class="token punctuation">)</span>

csrf_token <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'csrf_token'</span><span class="token punctuation">)</span>
</code></pre> 
<p>在上面的代码中，我们使用 requests 库来发送 POST 请求，并使用 response.json() 来解析响应的 JSON 数据，从而获取 CSRF-Token。</p> 
<p>  需要注意的是，由于 CSRF-Token 会动态更新，因此我们需要在<strong>每次请求时重新获取 CSRF-Token</strong>。</p> 
<p>  另外需要注意的是，有些网站在后台生成 CSRF-Token 时可能会根据不同的请求参数生成不同的 Token，这意味着您需要在发送完整的请求（<strong>包括所有参数</strong>）之后才能获取到完整的 CSRF-Token。如果在获取 CSRF-Token 时发现它不正确或已过期，您可以尝试重新请求页面并获取新的 CSRF-Token。</p> 
<h3><a id="33_CSRFToken____92"></a>3.3 CSRF-Token 位于 响应头 时</h3> 
<p>  CSRF-Token 除了可以存在于响应体（Response Body）之外，还可能被隐藏在<strong>请求的响应头</strong>（Response Header）中。因此，在获取 CSRF-Token 时，您还应该查看完整的响应头，以查看是否有其他的 CSRF-Token。具体代码如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">'http://example.com/api/csrf_token'</span>

headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'Authorization'</span><span class="token punctuation">:</span> <span class="token string">'Bearer 1234567890'</span><span class="token punctuation">,</span>
    <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span>
<span class="token punctuation">}</span>

data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'user_id'</span><span class="token punctuation">:</span> <span class="token string">'1234567890'</span>
<span class="token punctuation">}</span>

response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> json<span class="token operator">=</span>data<span class="token punctuation">)</span>
csrf_token <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Csrf-Token'</span><span class="token punctuation">]</span>
</code></pre> 
<p>以上就是针对 CSRF-Token 存在的三个位置获取 CSRF-Token 的 两种方法。在实际爬虫过程中，我们需要根据 CSRF-Token 的具体位置来选择相应的方法来获取 CSRF-Token。</p> 
<h3><a id="34__116"></a>3.4 注意事项</h3> 
<p>  Request 请求的构造过程往往只有以下两步：</p> 
<ol><li>首先，去网站上找一下对应的请求链接。</li><li>使用 requests.get或requests.post 发起请求就行。</li></ol> 
<p>  然而，由于 CSRF-Token 往往用于判断同一个会话的合法性，因此有这种机制的时候，需要保证获取 CSRF-Token 的请求和下一个请求处于同一个会话中（会话：Session），所以需要额外使用 <code>requests.Session</code>，然后将 <code>requests.get</code> 或 <code>requests.post</code> 直接替换成 <code>Session.get</code> 或 <code>Session.post</code>。</p> 
<p>下面是一个简单的示例：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests

<span class="token comment"># 创建一个 Session 对象</span>
session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 先请求登录页面获取 csrf_token</span>
login_url <span class="token operator">=</span> <span class="token string">'http://example.com/login'</span>
login_page <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>login_url<span class="token punctuation">)</span><span class="token punctuation">.</span>text
csrf_token <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'csrf_token=(.*?)&amp;'</span><span class="token punctuation">,</span> login_page<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token comment"># 使用获取到的 csrf_token 登录</span>
data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'username'</span><span class="token punctuation">:</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>
    <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
    <span class="token string">'csrf_token'</span><span class="token punctuation">:</span> csrf_token
<span class="token punctuation">}</span>
login_result <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>login_url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>

<span class="token comment"># 在同一个 Session 下进行其他操作</span>
data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'param1'</span><span class="token punctuation">:</span> <span class="token string">'value1'</span><span class="token punctuation">,</span>
    <span class="token string">'param2'</span><span class="token punctuation">:</span> <span class="token string">'value2'</span><span class="token punctuation">,</span>
    <span class="token string">'csrf_token'</span><span class="token punctuation">:</span> csrf_token
<span class="token punctuation">}</span>
result <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://example.com/other_operation'</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
</code></pre> 
<p>在上面的代码中，我们首先使用 <code>session.get</code> 获取登录页面，然后使用正则表达式获取其中的 <code>csrf_token</code>，接着使用 <code>session.post</code> 发起登录请求，并在同一个 <code>session</code> 对象下进行其他操作，确保处于同一个会话中，从而绕过 CSRF-Token 的检查。</p> 
<h2><a id="4__CSRFToken__153"></a>4 将 CSRF-Token 嵌入到请求中</h2> 
<p>  获取 CSRF-Token 后，我们需要将它嵌入到请求中，以便服务器可以验证请求的合法性。在使用 Python3 爬虫时，需要根据具体的网址判断 CSRF-Token 的嵌入位置，嵌入位置一般在请求头或请求参数中。下面我们将介绍这两种嵌入位置应该如何嵌入。</p> 
<h3><a id="41_CSRFToken__156"></a>4.1 CSRF-Token 嵌入请求头</h3> 
<p>  在请求头中嵌入 CSRF-Token 的方法和普通的请求头差不多，只需要在请求头中加入 X-CSRF-Token 或者 X-XSRF-Token 等字段（根据具体网址判断字段名称），并将获取到的 CSRF-Token 作为该字段的值即可。示例代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">'http://example.com/submit_form'</span>
csrf_token <span class="token operator">=</span> <span class="token string">'1234567890abcdef'</span>

headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'X-CSRF-Token'</span><span class="token punctuation">:</span> csrf_token<span class="token punctuation">,</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3'</span>
<span class="token punctuation">}</span>

data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'param1'</span><span class="token punctuation">:</span> <span class="token string">'value1'</span><span class="token punctuation">,</span>
    <span class="token string">'param2'</span><span class="token punctuation">:</span> <span class="token string">'value2'</span>
<span class="token punctuation">}</span>

response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="42_CSRFToken__177"></a>4.2 CSRF-Token 嵌入请求参数</h3> 
<p>  在请求参数中嵌入 CSRF-Token 的方法也很简单，只需要在请求参数中加入名为 csrf_token 的字段，并将获取到的 CSRF-Token 作为该字段的值即可。示例代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">'http://example.com/submit_form'</span>
csrf_token <span class="token operator">=</span> <span class="token string">'1234567890abcdef'</span>

params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'param1'</span><span class="token punctuation">:</span> <span class="token string">'value1'</span><span class="token punctuation">,</span>
    <span class="token string">'param2'</span><span class="token punctuation">:</span> <span class="token string">'value2'</span><span class="token punctuation">,</span>
    <span class="token string">'csrf_token'</span><span class="token punctuation">:</span> csrf_token
<span class="token punctuation">}</span>

response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span>
</code></pre> 
<p>以上代码中，如果是post请求，则需要使用<code>requests.post(url, headers=headers, data=data)</code>，将 CSRF-Token 嵌入到 <code>data</code> 字段。</p> 
<p>  需要注意的是，不同的网站可能采用不同的嵌入位置，甚至可能采用多种嵌入方式，需要具体情况具体分析。</p> 
<h2><a id="5__198"></a>5 示例</h2> 
<p>  下面，我们将使用 requests 库来实现一个简单的爬虫，用于获取西北工业大学的招生计划。</p> 
<p>  首先，我们需要获取西北工业大学网站的 CSRF-Token。具体代码如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json

headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token comment"># 请自行去网站上复制补全</span>
get_token_url <span class="token operator">=</span> <span class="token string">"https://zsb.nwpu.edu.cn/f/ajax_get_csrfToken"</span>
Session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_csrf_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> data
    update_ts<span class="token punctuation">(</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> Session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>get_token_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
    csrf_token <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> csrf_token
</code></pre> 
<p>在上面的代码中，我们使用 requests 库来发送 GET 请求，并使用 Beautiful Soup 库来查找 CSRF-Token。</p> 
<p>  接下来，我们需要将 CSRF-Token 添加到请求头中，并发送请求。具体代码如下所示：</p> 
<pre><code class="prism language-python">headers<span class="token punctuation">[</span><span class="token string">"Csrf-Token"</span><span class="token punctuation">]</span> <span class="token operator">=</span> get_csrf_token<span class="token punctuation">(</span><span class="token punctuation">)</span>
get_zsjh_url <span class="token operator">=</span> <span class="token string">"https://zsb.nwpu.edu.cn/f/ajax_zsjh"</span>
response <span class="token operator">=</span> Session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>get_zsjh_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre> 
<p>在上面的代码中，我们将 CSRF-Token 添加到请求头中，并使用 requests 库发送 POST 请求。由于西北工业大学的招生计划是动态生成的，因此我们需要使用 POST 请求来获取数据。</p> 
<p>  运行上面的代码后，我们将会得到西北工业大学的招生计划。</p> 
<p>  需要注意的是，该会话接下来的 CSRF-Token 在这个response 的响应头。因此如果需要继续请求，需要使用这个response的headers去更新 CSRF-Token，代码如下所示：</p> 
<pre><code class="prism language-python"><span class="token comment"># update Csrf-Token</span>
headers<span class="token punctuation">[</span><span class="token string">"Csrf-Token"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Csrf-Token'</span><span class="token punctuation">]</span>
</code></pre> 
<h2><a id="6__238"></a>6 总结</h2> 
<p>  在使用 Python3 爬虫时，我们需要了解 CSRF-Token 机制，并正确地处理它，以便服务器可以验证请求的合法性。</p> 
<p>  具体来说，我们需要通过发送 GET 请求来获取 CSRF-Token，然后将 CSRF-Token 嵌入到请求中，以便服务器可以验证请求的合法性。在 Python3 中，我们可以使用 requests 库和 Beautiful Soup 库来实现这一过程。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b3923aa2593de6a6906222c17d6597c5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用Node.js连接和发布/订阅MQTT消息</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9e99e5443def5c133050e15be9e20539/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2023年从入门到精通java开发全栈知识体系架构学习总结知识脑图（学习使用于项目实战）前端、后台、服务器、Linux、性能优化、集群搭建、微服务、大数据、项目实战等内容</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>