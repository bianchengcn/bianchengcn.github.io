<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【JVM】第三章：类加载与字节码技术 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【JVM】第三章：类加载与字节码技术" />
<meta property="og:description" content="一、字节码结构 回顾一下字节码
在 Java 中，JVM 可以理解的代码就叫做字节码（即扩展名为 .class的文件），它不面向任何特定的处理器，只面向虚拟机。Java 语言通过字节码的方式，在一定程序上解决了传统解释型语言执行效率低的问题，同时又保留了解释下语言可移植的特点。所以 Java 程序运行时比较高校，而且，由于字节码并不针对一种特定的机器，因此，Java 程序无需重新编译便可在多种不同操作系统的计算机上运行。
可以说 .class文件是不同的语言在 Java 虚拟机之间的重要桥梁，同时也是支持 Java 跨平台很重要的一个原因。
1.2 类文件结构 根据 Java 虚拟机规范，Class 文件通过 ClassFile定义，有点类似 C 语言的结构体。
魔数（Magin Number）
每个 Class 文件的头 4 个字节称为魔数，它的唯一作用是确定这个文件是否为一个能被虚拟机接受的 Class 文件。Java 规范规定魔数为固定值：0xCAFEBABE。如果读取的文件不是以这个魔数开头，Java 虚拟机将拒绝加载它。
Class 文件版本号 （Minor &amp; Minor Version）
紧接着魔数的四个字节存储的是 Class 文件的版本号：第 5 个和第 6 个字节是次版本号，第 7 和第 8 个字节是主版本号。
每当 Java 发布大版本（比如 Java8，Java9）的时候，主版本号都会加 1。使用 javap -v命令来快速查看 Class 文件的版本号信息。
高版本的 Java 虚拟机可以执行低版本编译器生成的 Class 文件，但是低版本的 Java 虚拟机不能执行高版本编译器生成的 Class 文件。所以，我们在实际开发的时候要确保开发的 JDK 版本和生成环境的 JDK 版本保持一致。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/521677b4efdd6d57d8b6cc548738ae02/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-31T21:48:44+08:00" />
<meta property="article:modified_time" content="2023-12-31T21:48:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【JVM】第三章：类加载与字节码技术</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>一、字节码结构</h3> 
<p>回顾一下字节码</p> 
<p>在 Java 中，JVM 可以理解的代码就叫做字节码（即扩展名为 <code>.class</code>的文件），它不面向任何特定的处理器，只面向虚拟机。Java 语言通过字节码的方式，在一定程序上解决了传统解释型语言执行效率低的问题，同时又保留了解释下语言可移植的特点。所以 Java 程序运行时比较高校，而且，由于字节码并不针对一种特定的机器，因此，Java 程序无需重新编译便可在多种不同操作系统的计算机上运行。</p> 
<p>可以说 <code>.class</code>文件是不同的语言在 Java 虚拟机之间的重要桥梁，同时也是支持 Java 跨平台很重要的一个原因。</p> 
<h4><a id="12__10"></a>1.2 类文件结构</h4> 
<p>根据 Java 虚拟机规范，Class 文件通过 <code>ClassFile</code>定义，有点类似 C 语言的结构体。</p> 
<p>魔数（Magin Number）</p> 
<p>每个 Class 文件的头 4 个字节称为魔数，它的唯一作用是确定这个文件是否为一个能被虚拟机接受的 Class 文件。Java 规范规定魔数为固定值：0xCAFEBABE。如果读取的文件不是以这个魔数开头，Java 虚拟机将拒绝加载它。</p> 
<p>Class 文件版本号 （Minor &amp; Minor Version）</p> 
<p>紧接着魔数的四个字节存储的是 Class 文件的版本号：第 5 个和第 6 个字节是次版本号，第 7 和第 8 个字节是主版本号。</p> 
<p>每当 Java 发布大版本（比如 Java8，Java9）的时候，主版本号都会加 1。使用 <code>javap -v</code>命令来快速查看 Class 文件的版本号信息。</p> 
<p>高版本的 Java 虚拟机可以执行低版本编译器生成的 Class 文件，但是低版本的 Java 虚拟机不能执行高版本编译器生成的 Class 文件。所以，我们在实际开发的时候要确保开发的 JDK 版本和生成环境的 JDK 版本保持一致。</p> 
<p>常量池</p> 
<p>常量池占据 Java 类文件中的大部分空间。存储了各种字面量和符号引用，以供类文件使用。它包含类、接口、字段、方法的符号引用、字面量等信息。</p> 
<p>访问标志</p> 
<p>用于标识类或接口的访问标志，例如是否为 public、final、abstract 等。</p> 
<p>类索引、父类索引和接口索引</p> 
<p>用来指示类的继承关系和实现的接口。</p> 
<p>类索引用来确定这个类的全限定名，父类索引用于确定这个父类的全限定名，由于 Java 语言的单继承，所以父类索引只有一个，除了 <code>java.lang.Object</code>之外，所有的 Java 类都有父类。</p> 
<p>接口所有集合用来描述这个类实现了哪些接口，这些被实现的接口按 <code>implements</code>(如果这个类本身是接口的话则是 <code>extends</code>)后的接口顺序从左到右排列在接口索引集合中。</p> 
<p>字段表</p> 
<p>描述类或接口中声明的字段信息，包括字段的访问标志、名称索引、描述符索引、属性表等。</p> 
<p>方法表</p> 
<p>描述类或接口中声明的方法信息，包括方法的访问标志、名称索引、描述符索引、属性表等。</p> 
<p>属性表</p> 
<p>描述类、字段、方法等的属性信息，包括代码属性、异常表、常量值属性等。</p> 
<h3><a id="_74"></a>二、字节码指令</h3> 
<p>查看一个 Java 字节码文件：</p> 
<h4><a id="21___80"></a>2.1 图解方法执行流程</h4> 
<ol><li>原始 Java 代码</li></ol> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 演示 字节码指令 和 操作数栈、常量池的关系
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_1</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token class-name">Short</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol><li>编译后的字节码文件</li></ol> 
<pre><code class="prism language-shell">Classfile /D:/study/java/jvm/资料 解密JVM/代码/jvm/src/cn/itcast/jvm/t3/bytecode/Demo3_1.class
  Last modified <span class="token number">2023</span>-12-21<span class="token punctuation">;</span> size <span class="token number">458</span> bytes
  MD5 checksum a099195e9abf23c79e0ebc4262c7875b
  Compiled from <span class="token string">"Demo3_1.java"</span>
public class cn.itcast.jvm.t3.bytecode.Demo3_1
  minor version: <span class="token number">0</span>
  major version: <span class="token number">52</span>
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   <span class="token comment">#1 = Methodref          #7.#16         // java/lang/Object."&lt;init&gt;":()V</span>
   <span class="token comment">#2 = Class              #17            // java/lang/Short</span>
   <span class="token comment">#3 = Integer            32768</span>
   <span class="token comment">#4 = Fieldref           #18.#19        // java/lang/System.out:Ljava/io/PrintStream;</span>
   <span class="token comment">#5 = Methodref          #20.#21        // java/io/PrintStream.println:(I)V</span>
   <span class="token comment">#6 = Class              #22            // cn/itcast/jvm/t3/bytecode/Demo3_1</span>
   <span class="token comment">#7 = Class              #23            // java/lang/Object</span>
   <span class="token comment">#8 = Utf8               &lt;init&gt;</span>
   <span class="token comment">#9 = Utf8               ()V</span>
  <span class="token comment">#10 = Utf8               Code</span>
  <span class="token comment">#11 = Utf8               LineNumberTable</span>
  <span class="token comment">#12 = Utf8               main</span>
  <span class="token comment">#13 = Utf8               ([Ljava/lang/String;)V</span>
  <span class="token comment">#14 = Utf8               SourceFile</span>
  <span class="token comment">#15 = Utf8               Demo3_1.java</span>
  <span class="token comment">#16 = NameAndType        #8:#9          // "&lt;init&gt;":()V</span>
  <span class="token comment">#17 = Utf8               java/lang/Short</span>
  <span class="token comment">#18 = Class              #24            // java/lang/System</span>
  <span class="token comment">#19 = NameAndType        #25:#26        // out:Ljava/io/PrintStream;</span>
  <span class="token comment">#20 = Class              #27            // java/io/PrintStream</span>
  <span class="token comment">#21 = NameAndType        #28:#29        // println:(I)V</span>
  <span class="token comment">#22 = Utf8               cn/itcast/jvm/t3/bytecode/Demo3_1</span>
  <span class="token comment">#23 = Utf8               java/lang/Object</span>
  <span class="token comment">#24 = Utf8               java/lang/System</span>
  <span class="token comment">#25 = Utf8               out</span>
  <span class="token comment">#26 = Utf8               Ljava/io/PrintStream;</span>
  <span class="token comment">#27 = Utf8               java/io/PrintStream</span>
  <span class="token comment">#28 = Utf8               println</span>
  <span class="token comment">#29 = Utf8               (I)V</span>
<span class="token punctuation">{<!-- --></span>
  public cn.itcast.jvm.t3.bytecode.Demo3_1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC
    Code:
      <span class="token assign-left variable">stack</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">locals</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">args_size</span><span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span>: aload_0
         <span class="token number">1</span>: invokespecial <span class="token comment">#1                  // Method java/lang/Object."&lt;init&gt;":()V</span>
         <span class="token number">4</span>: <span class="token builtin class-name">return</span>
      LineNumberTable:
        line <span class="token number">4</span>: <span class="token number">0</span>

  public static void main<span class="token punctuation">(</span>java.lang.String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      <span class="token assign-left variable">stack</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">locals</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">args_size</span><span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span>: bipush        <span class="token number">10</span>
         <span class="token number">2</span>: istore_1
         <span class="token number">3</span>: ldc           <span class="token comment">#3                  // int 32768</span>
         <span class="token number">5</span>: istore_2
         <span class="token number">6</span>: iload_1
         <span class="token number">7</span>: iload_2
         <span class="token number">8</span>: iadd
         <span class="token number">9</span>: istore_3
        <span class="token number">10</span>: getstatic     <span class="token comment">#4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span>
        <span class="token number">13</span>: iload_3
        <span class="token number">14</span>: invokevirtual <span class="token comment">#5                  // Method java/io/PrintStream.println:(I)V</span>
        <span class="token number">17</span>: <span class="token builtin class-name">return</span>
      LineNumberTable:
        line <span class="token number">6</span>: <span class="token number">0</span>
        line <span class="token number">7</span>: <span class="token number">3</span>
        line <span class="token number">8</span>: <span class="token number">6</span>
        line <span class="token number">9</span>: <span class="token number">10</span>
        line <span class="token number">10</span>: <span class="token number">17</span>
<span class="token punctuation">}</span>
SourceFile: <span class="token string">"Demo3_1.java"</span>
</code></pre> 
<ol><li>常量池载入运行时常量池</li></ol> 
<p><img src="https://images2.imgbox.com/f7/41/ygvpExMZ_o.png" alt="img"></p> 
<ol><li>方法字节码载入方法区</li></ol> 
<p><img src="https://images2.imgbox.com/9a/1c/wSbA4bU0_o.png" alt="img"></p> 
<ol><li>main 线程开始运作，分配栈帧内存</li></ol> 
<ul><li> <p>stack=2：</p> </li><li> <p>stack=2 表示该方法在执行时操作数栈的最大深度为 2。</p> </li><li> <p>操作数栈用于执行方法时的临时数据存储。它存储方法中间结果、操作数和返回值等信息。</p> </li><li> <p>locals=4：</p> </li><li> <p>locals = 4 表示该方法有 4 个局部变量</p> </li><li> <p>局部变量是方法内部定义的变量，包括方法参数和方法内部的临时变量。这些变量的值在方法的生命周期内可变。</p> </li></ul> 
<p><img src="https://images2.imgbox.com/69/2e/8DaborZm_o.png" alt="img"></p> 
<ol><li> <p>然后开始执行字节码指令</p> </li><li> <p>blpush10 ：将一个 byte 类型数压入操作数栈（其长度会补齐 4 个字节）</p> </li><li> <p>sipush 将一个 short 类型数压入操作数栈（其长度会补齐 4 个字节）</p> </li><li> <p>ldc 将一个 int 类型数压入操作数栈</p> </li><li> <p>ldc2_w 将一个 long 类型数压入操作数栈（分两次压入，因为 long 是 8 个字节）</p> </li><li> <p>这里小的数字都是和字节码指令存在一起，超过 short 范围的数字会存入常量池中。</p> </li></ol> 
<p><img src="https://images2.imgbox.com/37/39/O2ay8CsX_o.png" alt="img"></p> 
<ol><li>istore1 ：把操作数栈顶的数据放入局部变量表中的位置 1 中。</li></ol> 
<p><img src="https://images2.imgbox.com/79/87/SGXsyZdJ_o.png" alt="img"></p> 
<ol><li> <p>ldc #3 ：把常量池#3 中的数据放入到操作数栈中。</p> </li><li> <p>注意 Short.MAX_VALUE 是 32767，所哟 32768 实际实在编译期间就算好的。</p> </li></ol> 
<p><img src="https://images2.imgbox.com/65/5c/VzVPfVDU_o.png" alt="img"></p> 
<ol><li>istore2 ：把操作数栈顶的数据放入局部变量表中的位置 2 中。</li></ol> 
<p><img src="https://images2.imgbox.com/52/fe/CbfSHBKC_o.png" alt="img"></p> 
<ol><li>iload1：把局部变量表中位置 1 的位置压入操作数栈上。</li></ol> 
<p><img src="https://images2.imgbox.com/0b/e4/Dxqnrvvi_o.png" alt="img"></p> 
<ol><li>iload2：把局部变量表中位置 2 的位置压入操作数栈上。</li></ol> 
<p><img src="https://images2.imgbox.com/31/3f/sj5i4iOs_o.png" alt="img"></p> 
<ol><li>iadd：将操作栈中的两个数弹出并将两个数相加在压入到操作数栈中。</li></ol> 
<p><img src="https://images2.imgbox.com/f4/37/jGetOrYn_o.png" alt="img"></p> 
<ol><li>istore3：将操作数栈顶的数弹出栈放入到局部变量表的位置 3 中。</li></ol> 
<p><img src="https://images2.imgbox.com/76/53/dO9FrSNt_o.png" alt="img"></p> 
<ol><li>getstatic #4：去常量池中找到 System.out 的对象在堆中的位置，并将该对象的引用地址放入到操作数栈中。</li></ol> 
<p><img src="https://images2.imgbox.com/36/15/xoLmmwwN_o.png" alt="img"></p> 
<p><img src="https://images2.imgbox.com/16/20/qoaxRt0j_o.png" alt="img"></p> 
<ol><li>iload3：将局部变量表位置 3 中的数据压入操作数栈中。</li></ol> 
<p><img src="https://images2.imgbox.com/9d/07/ENwJJ6cO_o.png" alt="img"></p> 
<ol><li>invokevirtual #5：去常量池中找到 5 号条目，定位到方法区中的 <code>java/io/PrintStream.println:(I)V</code>方法。然后生成新的栈帧（每次调用方法都会产生一个新的栈帧加入到虚拟机栈中）。然后传递参数，执行新栈帧中的字节码。</li></ol> 
<p><img src="https://images2.imgbox.com/bd/60/Sei5mDvh_o.png" alt="img"></p> 
<ol><li>执行完毕，弹出栈帧。</li><li>清除 main 操作数栈内容</li></ol> 
<p><img src="https://images2.imgbox.com/d9/a7/qFNU2ta1_o.png" alt="img"></p> 
<ol><li> <p>return</p> </li><li> <p>完成 main 方法调用，弹出 main 栈帧。</p> </li><li> <p>程序结束。</p> </li></ol> 
<h4><a id="22____i_279"></a>2.2 练习 - 分析 i++</h4> 
<p>目的：从字节码角度分析 a++ 相关题目</p> 
<p>源码：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 从字节码角度分析　a++  相关题目
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_2</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> a<span class="token operator">++</span> <span class="token operator">+</span> <span class="token operator">++</span>a <span class="token operator">+</span> a<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-shell">  Last modified <span class="token number">2023</span>-12-22<span class="token punctuation">;</span> size <span class="token number">447</span> bytes
  MD5 checksum a74d7b7f29e5da2c4e5c4bf2e9f5508f
  Compiled from <span class="token string">"Demo3_2.java"</span>
public class cn.itcast.jvm.t3.bytecode.Demo3_2
  minor version: <span class="token number">0</span>
  major version: <span class="token number">52</span>
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   <span class="token comment">#1 = Methodref          #5.#14         // java/lang/Object."&lt;init&gt;":()V</span>
   <span class="token comment">#2 = Fieldref           #15.#16        // java/lang/System.out:Ljava/io/PrintStream;</span>
   <span class="token comment">#3 = Methodref          #17.#18        // java/io/PrintStream.println:(I)V</span>
   <span class="token comment">#4 = Class              #19            // cn/itcast/jvm/t3/bytecode/Demo3_2</span>
   <span class="token comment">#5 = Class              #20            // java/lang/Object</span>
   <span class="token comment">#6 = Utf8               &lt;init&gt;</span>
   <span class="token comment">#7 = Utf8               ()V</span>
   <span class="token comment">#8 = Utf8               Code</span>
   <span class="token comment">#9 = Utf8               LineNumberTable</span>
  <span class="token comment">#10 = Utf8               main</span>
  <span class="token comment">#11 = Utf8               ([Ljava/lang/String;)V</span>
  <span class="token comment">#12 = Utf8               SourceFile</span>
  <span class="token comment">#13 = Utf8               Demo3_2.java</span>
  <span class="token comment">#14 = NameAndType        #6:#7          // "&lt;init&gt;":()V</span>
  <span class="token comment">#15 = Class              #21            // java/lang/System</span>
  <span class="token comment">#16 = NameAndType        #22:#23        // out:Ljava/io/PrintStream;</span>
  <span class="token comment">#17 = Class              #24            // java/io/PrintStream</span>
  <span class="token comment">#18 = NameAndType        #25:#26        // println:(I)V</span>
  <span class="token comment">#19 = Utf8               cn/itcast/jvm/t3/bytecode/Demo3_2</span>
  <span class="token comment">#20 = Utf8               java/lang/Object</span>
  <span class="token comment">#21 = Utf8               java/lang/System</span>
  <span class="token comment">#22 = Utf8               out</span>
  <span class="token comment">#23 = Utf8               Ljava/io/PrintStream;</span>
  <span class="token comment">#24 = Utf8               java/io/PrintStream</span>
  <span class="token comment">#25 = Utf8               println</span>
  <span class="token comment">#26 = Utf8               (I)V</span>
<span class="token punctuation">{<!-- --></span>
  public cn.itcast.jvm.t3.bytecode.Demo3_2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC
    Code:
      <span class="token assign-left variable">stack</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">locals</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">args_size</span><span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span>: aload_0
         <span class="token number">1</span>: invokespecial <span class="token comment">#1                  // Method java/lang/Object."&lt;init&gt;":()V</span>
         <span class="token number">4</span>: <span class="token builtin class-name">return</span>
      LineNumberTable:
        line <span class="token number">4</span>: <span class="token number">0</span>

  public static void main<span class="token punctuation">(</span>java.lang.String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      <span class="token assign-left variable">stack</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">locals</span><span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">args_size</span><span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span>: bipush        <span class="token number">10</span>      // 将10压入操作数栈中
         <span class="token number">2</span>: istore_1							// 将操作数栈顶弹出压入局部变量表的位置1中
         <span class="token number">3</span>: iload_1								// 将局部变量表中位置1中的数据复制到操作数栈中
         <span class="token number">4</span>: iinc          <span class="token number">1</span>, <span class="token number">1</span>    // 将局部变量表中位置1的数据+1
         <span class="token number">7</span>: iinc          <span class="token number">1</span>, <span class="token number">1</span>    // 将局部变量表中位置1的数据+1
        <span class="token number">10</span>: iload_1               // 将局部变量表位置1的数据复制到操作数栈中
        <span class="token number">11</span>: iadd									// 将操作数栈中的两个数据相加并将结果压入栈中
        <span class="token number">12</span>: iload_1               // 将局部变量表位置1的数据复制到操作数栈中
        <span class="token number">13</span>: iinc          <span class="token number">1</span>, <span class="token parameter variable">-1</span>   // 将局部变量表位置1的数据-1
        <span class="token number">16</span>: iadd									// 将操作数栈中的两个数相加并将结果压入栈中		
        <span class="token number">17</span>: istore_2							// 将操作数栈中的栈顶弹出放入局部变量表的位置2中。
        <span class="token number">18</span>: getstatic     <span class="token comment">#2      // 将常量池中的#2放入到操作数栈中            // Field java/lang/System.out:Ljava/io/PrintStream;</span>
        <span class="token number">21</span>: iload_1								// 将局部变量表位置1的数据复制到操作数栈中
        <span class="token number">22</span>: invokevirtual <span class="token comment">#3      // 找到常量池中的#3，开启新的栈帧来执行方法            // Method java/io/PrintStream.println:(I)V</span>
        <span class="token number">25</span>: getstatic     <span class="token comment">#2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span>
        <span class="token number">28</span>: iload_2
        <span class="token number">29</span>: invokevirtual <span class="token comment">#3                  // Method java/io/PrintStream.println:(I)V</span>
        <span class="token number">32</span>: <span class="token builtin class-name">return</span>
      LineNumberTable:
        line <span class="token number">6</span>: <span class="token number">0</span>
        line <span class="token number">7</span>: <span class="token number">3</span>
        line <span class="token number">8</span>: <span class="token number">18</span>
        line <span class="token number">9</span>: <span class="token number">25</span>
        line <span class="token number">10</span>: <span class="token number">32</span>
<span class="token punctuation">}</span>
SourceFile: <span class="token string">"Demo3_2.java"</span>
</code></pre> 
<h4><a id="23__387"></a>2.3 条件判断指令</h4> 
<ul><li>byte、short、char 都会按 int 比较，因为操作数栈都是 4 个字节</li><li>goto 用来跳转到指定行号的字节码</li></ul> 
<p>源码：</p> 
<pre><code class="prism language-java"> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_3</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                a <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-powershell">0: iconst_0   
1: istore_1
2: iload_1
3: ifne 12    <span class="token operator">/</span><span class="token operator">/</span> 判断是否不等于0，如果是就转到12
6: bipush 10  <span class="token operator">/</span><span class="token operator">/</span> 不等于0，将10压入栈中
8: istore_1		<span class="token operator">/</span><span class="token operator">/</span> 赋值给a
9: goto 15		
12: bipush 20
14: istore_1
15: <span class="token keyword">return</span>
</code></pre> 
<h4><a id="24___426"></a>2.4 循环控制指令</h4> 
<ul><li>while 循环</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_4</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            a<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-powershell">0: iconst_0   
1: istore_1
2: iload_1
3: bipush 10
5: if_icmpge 14  <span class="token operator">/</span><span class="token operator">/</span> 将操作数栈中的两个数进行比较，判断a是否 &gt;= 10，如果是，直接跳转14行指令
8: iinc 1<span class="token punctuation">,</span> 1     <span class="token operator">/</span><span class="token operator">/</span> 不是，将a自增1
11: goto 2			<span class="token operator">/</span><span class="token operator">/</span> 在转到第2行指令
14: <span class="token keyword">return</span>
</code></pre> 
<ul><li>do while 循环</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_5</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
            a<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-powershell"> 0: iconst_0
 1: istore_1
 2: iinc 1<span class="token punctuation">,</span> 1  <span class="token operator">/</span><span class="token operator">/</span> 先自增1
 5: iload_1
 6: bipush 10
 8: if_icmplt 2  <span class="token operator">/</span><span class="token operator">/</span> 判断  a 是否 &lt; 10，如果是，跳转到2号指令
11: <span class="token keyword">return</span>
</code></pre> 
<ul><li>再来看看 for 循环</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_6</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>字节码是：</p> 
<pre><code class="prism language-powershell">0: iconst_0
1: istore_1
2: iload_1
3: bipush 10
5: if_icmpge 14
8: iinc 1<span class="token punctuation">,</span> 1
11: goto 2
14: <span class="token keyword">return</span>
</code></pre> 
<p>比较 while 和 for 的字节码，发现一摸一样，疏通也能同归。</p> 
<h4><a id="25____513"></a>2.5 练习 - 判断结果</h4> 
<p>为啥 <code> x = 0, x = x ++</code>后 <code>x = 0</code>?</p> 
<p><code>x=0</code>执行完之后，局部变量表中位置 x 的数是 0，然后再执行 <code>iload_x</code>指令将局部变量表中 位置 x 的 0 复制到操作数栈中，然后再执行 <code>linc x 1</code>指令，将局部变量表中位置 x 的数加 1，然后再执行 <code>istore1</code>指令将操作数栈中的 0 放入到局部变量表位置 x 中，此时 x 的值还是 0。</p> 
<h4><a id="26__521"></a>2.6 构造方法</h4> 
<ol><li>()V</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_3</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编译器会按从上至下的顺序，收集所有 static 静态代码块和静态成员复制的代码，合并为一个特殊的方法 <code>&lt;cinit&gt;()V</code>。</p> 
<pre><code class="prism language-shell"><span class="token number">0</span>: bipush <span class="token number">10</span>
<span class="token number">2</span>: putstatic <span class="token comment">#2 // Field i:I</span>
<span class="token number">5</span>: bipush <span class="token number">20</span>
<span class="token number">7</span>: putstatic <span class="token comment">#2 // Field i:I</span>
<span class="token number">10</span>: bipush <span class="token number">30</span>
<span class="token number">12</span>: putstatic <span class="token comment">#2 // Field i:I</span>
<span class="token number">15</span>: <span class="token builtin class-name">return</span>
</code></pre> 
<p><code>&lt;cinit&gt;()V</code>方法会在类加载的初始化阶段被调用。</p> 
<ol><li>()V</li></ol> 
<p>代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_8_2</span> <span class="token punctuation">{<!-- --></span>


    <span class="token keyword">private</span> <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">"s1"</span><span class="token punctuation">;</span>

    <span class="token punctuation">{<!-- --></span>
        b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token punctuation">{<!-- --></span>
        a <span class="token operator">=</span> <span class="token string">"s2"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Demo3_8_2</span><span class="token punctuation">(</span><span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Demo3_8_2</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo3_8_2</span><span class="token punctuation">(</span><span class="token string">"s3"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编译器会按从上至下的顺序，收集所有 { } 代码块和成员变量赋值的代码，形成新的构造方法，但原始构造方法内的代码总是在最后。</p> 
<pre><code class="prism language-powershell">public cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>t3<span class="token punctuation">.</span>bytecode<span class="token punctuation">.</span>Demo3_8_2<span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">,</span> int<span class="token punctuation">)</span><span class="token punctuation">;</span>
  descriptor: <span class="token punctuation">(</span>Ljava/lang/String<span class="token punctuation">;</span>I<span class="token punctuation">)</span>V
  flags: ACC_PUBLIC
  Code:
    stack=2<span class="token punctuation">,</span> locals=3<span class="token punctuation">,</span> args_size=3
       0: aload_0                           <span class="token operator">/</span><span class="token operator">/</span> 将堆中的this对象加载到操作数栈中
       1: invokespecial <span class="token comment">#1                  // 调用父类构造方法  // Method java/lang/Object."&lt;init&gt;":()V</span>
       4: aload_0													
       5: ldc           <span class="token comment">#2                  // String s1   将常量池中的"s1"对象加载到堆栈中</span>
       7: putfield      <span class="token comment">#3                  // Field a:Ljava/lang/String;  // 将"s1"赋值给属性a的</span>
      10: aload_0
      11: bipush        20
      13: putfield      <span class="token comment">#4                  // Field b:I</span>
      16: aload_0
      17: bipush        10
      19: putfield      <span class="token comment">#4                  // Field b:I</span>
      22: aload_0
      23: ldc           <span class="token comment">#5                  // String s2</span>
      25: putfield      <span class="token comment">#3                  // Field a:Ljava/lang/String;</span>
      28: aload_0
      29: aload_1
      30: putfield      <span class="token comment">#3                  // Field a:Ljava/lang/String;</span>
      33: aload_0
      34: iload_2
      35: putfield      <span class="token comment">#4                  // Field b:I</span>
      38: <span class="token keyword">return</span>
</code></pre> 
<h4><a id="27__635"></a>2.7 方法调用</h4> 
<p>我们来看一下不同的方法调用对应的字节码指令。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_9</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">Demo3_9</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Demo3_9</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo3_9</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d<span class="token punctuation">.</span><span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d<span class="token punctuation">.</span><span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d<span class="token punctuation">.</span><span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d<span class="token punctuation">.</span><span class="token function">test4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Demo3_9</span><span class="token punctuation">.</span><span class="token function">test4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-powershell">public static void main<span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  descriptor: <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
  flags: ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
  Code:
    stack=2<span class="token punctuation">,</span> locals=2<span class="token punctuation">,</span> args_size=1
       0: new           <span class="token comment">#3                  // class cn/itcast/jvm/t3/bytecode/Demo3_9</span>
       3: dup
       4: invokespecial <span class="token comment">#4                  // Method "&lt;init&gt;":()V</span>
       7: astore_1
       8: aload_1
       9: invokespecial <span class="token comment">#5                  // Method test1:()V</span>
      12: aload_1
      13: invokespecial <span class="token comment">#6                  // Method test2:()V</span>
      16: aload_1
      17: invokevirtual <span class="token comment">#7                  // Method test3:()V</span>
      20: aload_1
      21: pop
      22: invokestatic  <span class="token comment">#8                  // Method test4:()V</span>
      25: invokestatic  <span class="token comment">#8                  // Method test4:()V</span>
      28: aload_1
      29: invokevirtual <span class="token comment">#9                  // Method toString:()Ljava/lang/String;</span>
      32: pop
      33: <span class="token keyword">return</span>
</code></pre> 
<ul><li>new 是创建【对象】，给对象分配堆内存，执行成功会将【对象引用】压入栈中。</li><li><code>dup</code>是赋值操作数栈栈顶的内容，本例为【对象引用】，为什么需要两份引用呢？一个是配合 <code>invokespecial</code>调用该对象的构造方法 <code>&lt;init&gt;()V</code>（会消耗掉栈顶一个引用），另一个要配合 <code>astore_1</code>赋值给局部变量。</li><li>最终方法、私有方法、构造方法都是由 <code>invokespecial</code>指令来调用，属于静态绑定。</li><li>普通成员方法是由 <code>invokevirtual</code>调用，属于动态绑定，即支持多态。</li><li>成员方法和静态方法调用的另一个区别就是：执行方法钱是否需要【对象引用】</li><li>比较有意思的是 <code>d.teat4()</code>是通过【对象引用】调用一个静态方法，可以看到在调用 <code>invokestatic</code>之前执行了 <code>pop</code>指令，把【对象引用】从操作数栈中弹出了。</li><li>还有一个执 <code>invokespecial</code>的情况是通过 <code>super</code>调用了父类方法。</li></ul> 
<h4><a id="29__715"></a>2.9 多态的原理</h4> 
<p>源代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 演示多态原理，注意加上下面的 JVM 参数，禁用指针压缩
 * -XX:-UseCompressedOops -XX:-UseCompressedClassPointers
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_10</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">Animal</span> animal<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        animal<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>animal<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"我是"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token keyword">extends</span> <span class="token class-name">Animal</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"啃骨头"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Cat</span> <span class="token keyword">extends</span> <span class="token class-name">Animal</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"吃鱼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里没有听明白，之后再回来弄</p> 
<h4><a id="210__772"></a>2.10 异常处理</h4> 
<ul><li>try-catch</li></ul> 
<p>源代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_11_1</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-powershell">public static void main<span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
    Code:
      stack=1<span class="token punctuation">,</span> locals=3<span class="token punctuation">,</span> args_size=1
         0: iconst_0             <span class="token operator">/</span><span class="token operator">/</span> 将整数0压入操作数栈
         1: istore_1						 <span class="token operator">/</span><span class="token operator">/</span> 将0赋值给局部变量表中的位置1
         2: bipush        10     
         4: istore_1
         5: goto          12     <span class="token operator">/</span><span class="token operator">/</span> 如果在 2 <span class="token operator">-</span> 5行指令中没有发生异常，直接跳转到12行指令
         8: astore_2
         9: bipush        20
        11: istore_1
        12: <span class="token keyword">return</span>
      Exception table:
         <span class="token keyword">from</span>    to  target <span class="token function">type</span>
             2     5     8   <span class="token keyword">Class</span> java/lang/Exception
      LineNumberTable: <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      LocalVariableTable:
      <span class="token function">Start</span> Length Slot Name Signature
      9 3 2 e Ljava/lang/Exception<span class="token punctuation">;</span>
      0 13 0 args <span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span>
      2 11 1 i I
      StackMapTable: <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      MethodParameters: <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<ol><li>可以看到多出来一个 <code>Exception table</code>的结构，[form,to] 是前闭后开的检测范围，一旦这个范围内的字节码执行出现异常，则通过 type 来匹配异常类型，如果一直，进入 target 所指示行号。</li><li>8 行的字节码指令 <code>astore_2</code>是将异常对象引用存入局部变量表的 slot 2 位置。</li></ol> 
<ul><li>多个 single catch 块</li></ul> 
<p>源代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_11_2</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArithmeticException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NullPointerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">public static void main<span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      descriptor: <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
      flags: ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
      Code:
        stack=1<span class="token punctuation">,</span> locals=3<span class="token punctuation">,</span> args_size=1
        0: iconst_0
        1: istore_1
        2: bipush 10
        4: istore_1
        5: goto 26
        8: astore_2
        9: bipush 30
       11: istore_1
       12: goto 26
       15: astore_2
       16: bipush 40
       18: istore_1
       19: goto 26
       22: astore_2
       23: bipush 50
       25: istore_1
       26: <span class="token keyword">return</span>
      Exception table:
      <span class="token keyword">from</span> to target <span class="token function">type</span>
      2 5 8 <span class="token keyword">Class</span> java/lang/ArithmeticException
      2 5 15 <span class="token keyword">Class</span> java/lang/NullPointerException
      2 5 22 <span class="token keyword">Class</span> java/lang/Exception
      LineNumberTable: <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      LocalVariableTable:
      <span class="token function">Start</span> Length Slot Name Signature
        9 3 2 e Ljava/lang/ArithmeticException<span class="token punctuation">;</span>
        16 3 2 e Ljava/lang/NullPointerException<span class="token punctuation">;</span>
        23 3 2 e Ljava/lang/Exception<span class="token punctuation">;</span>
        0 27 0 args <span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span>
      2 25 1 i I
      StackMapTable: <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      MethodParameters: <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<ol><li>因为异常出现时，只能进入 Exception table 中的一个分支，所以局部变量表 slot 2 位置被共用。</li></ol> 
<p>multi-catch 的情况</p> 
<p>源代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_11_3</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Method</span> test <span class="token operator">=</span> <span class="token class-name">Demo3_11_3</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            test<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> <span class="token operator">|</span> <span class="token class-name">IllegalAccessException</span> <span class="token operator">|</span> <span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-powershell">public static void main<span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
    Code:
      stack=3<span class="token punctuation">,</span> locals=2<span class="token punctuation">,</span> args_size=1
         0: ldc           <span class="token comment">#2                  // class cn/itcast/jvm/t3/bytecode/Demo3_11_3</span>
         2: ldc           <span class="token comment">#3                  // String test</span>
         4: iconst_0
         5: anewarray     <span class="token comment">#4                  // class java/lang/Class</span>
         8: invokevirtual <span class="token comment">#5                  // Method java/lang/Class.getMethod:(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;</span>
        11: astore_1
        12: aload_1
        13: aconst_null
        14: iconst_0
        15: anewarray     <span class="token comment">#6                  // class java/lang/Object</span>
        18: invokevirtual <span class="token comment">#7                  // Method java/lang/reflect/Method.invoke:(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; </span>
        21: pop
        22: goto          30
        25: astore_1                          <span class="token operator">/</span><span class="token operator">/</span> 将异常对象存储到局部变量表的位置1中
        26: aload_1
        27: invokevirtual <span class="token comment">#11                 // Method java/lang/ReflectiveOperationException.printStackTrace:()V</span>
        30: <span class="token keyword">return</span>
      Exception table:
         <span class="token keyword">from</span>    to  target <span class="token function">type</span>
             0    22    25   <span class="token keyword">Class</span> java/lang/NoSuchMethodException
             0    22    25   <span class="token keyword">Class</span> java/lang/IllegalAccessException
             0    22    25   <span class="token keyword">Class</span> java/lang/reflect/InvocationTargetException
<span class="token punctuation">}</span>
</code></pre> 
<p>只要在执行【0，22）的过程中出现给定的任何异常中的一种，都会进入 catch 块中。</p> 
<p>finally</p> 
<p>源代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_11_4</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-powershell">  public static void main<span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
    Code:
      stack=1<span class="token punctuation">,</span> locals=4<span class="token punctuation">,</span> args_size=1
         0: iconst_0 
         1: istore_1                <span class="token operator">/</span><span class="token operator">/</span> 0 <span class="token operator">-</span>&gt; i
         2: bipush        10  			<span class="token operator">/</span><span class="token operator">/</span> 执行<span class="token keyword">try</span>: 10 <span class="token operator">-</span>&gt; 操作数栈
         4: istore_1								<span class="token operator">/</span><span class="token operator">/</span> 操作数栈的10 <span class="token operator">-</span>&gt; 局slot1中
         5: bipush        30				<span class="token operator">/</span><span class="token operator">/</span> 执行<span class="token keyword">finally</span> ：30 <span class="token operator">-</span>&gt; 操作数栈
         7: istore_1								<span class="token operator">/</span><span class="token operator">/</span> 操作数栈的10 <span class="token operator">-</span>&gt; slot 1中
         8: goto          27        <span class="token operator">/</span><span class="token operator">/</span> 退出
        11: astore_2								<span class="token operator">/</span><span class="token operator">/</span> 执行<span class="token keyword">catch</span>：如果在<span class="token keyword">try</span>流程执行的过程中出现了Exception异常，异常对象 <span class="token operator">-</span>&gt; slot2 
        12: bipush        20				<span class="token operator">/</span><span class="token operator">/</span> 20 <span class="token operator">-</span>&gt; 操作数栈
        14: istore_1								<span class="token operator">/</span><span class="token operator">/</span> 操作数栈20 <span class="token operator">-</span>&gt; slot1
        15: bipush        30				<span class="token operator">/</span><span class="token operator">/</span> 30 <span class="token operator">-</span>&gt; 操作数栈
        17: istore_1								<span class="token operator">/</span><span class="token operator">/</span> 操作数栈的30 <span class="token operator">-</span>&gt; slot1
        18: goto          27				<span class="token operator">/</span><span class="token operator">/</span> 退出
        21: astore_3								<span class="token operator">/</span><span class="token operator">/</span> 如果在<span class="token keyword">catch</span>块中出现了任何异常，将异常对象 <span class="token operator">-</span>&gt; slot3
        22: bipush        30        <span class="token operator">/</span><span class="token operator">/</span> 30 <span class="token operator">-</span>&gt; 操作数栈	
        24: istore_1								<span class="token operator">/</span><span class="token operator">/</span> 操作数栈的30 <span class="token operator">-</span>&gt; slot1
        25: aload_3									<span class="token operator">/</span><span class="token operator">/</span> slot3 <span class="token operator">-</span>&gt; 操作数栈
        26: athrow									<span class="token operator">/</span><span class="token operator">/</span> 抛出异常对象
        27: <span class="token keyword">return</span>
      Exception table:
         <span class="token keyword">from</span>    to  target <span class="token function">type</span>
             2     5    11   <span class="token keyword">Class</span> java/lang/Exception
             2     5    21   any
            11    15    21   any
</code></pre> 
<ul><li>可见 finally 中的代码被复制了三分，分别放入了 try 流程，catch 流程，以及 catch 剩余的异常类型流程。</li></ul> 
<h4><a id="211_finally__1033"></a>2.11 练习：finally 面试题</h4> 
<ul><li><strong>finally 出现了 return</strong></li></ul> 
<p>先问问自己，下面的题目输出什么？</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_12_1</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-powershell">public static int test<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">)</span>I
    flags: ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
    Code:
      stack=1<span class="token punctuation">,</span> locals=2<span class="token punctuation">,</span> args_size=0
         0: bipush        10          <span class="token operator">/</span><span class="token operator">/</span> 10 <span class="token operator">-</span>&gt; 操作数栈
         2: istore_0									<span class="token operator">/</span><span class="token operator">/</span> 10 <span class="token operator">-</span>&gt; slot 0
         3: bipush        20					<span class="token operator">/</span><span class="token operator">/</span> 20 <span class="token operator">-</span>&gt; 操作数栈
         5: ireturn										<span class="token operator">/</span><span class="token operator">/</span> 20 <span class="token operator">-</span>&gt; 作为方法返回值返回
         6: astore_1									<span class="token operator">/</span><span class="token operator">/</span> 当<span class="token keyword">try</span>中出现任何异常时<span class="token punctuation">,</span>异常对象<span class="token operator">-</span>&gt;slot1
         7: bipush        20					<span class="token operator">/</span><span class="token operator">/</span> 20 <span class="token operator">-</span>&gt; 操作数栈
         9: ireturn										<span class="token operator">/</span><span class="token operator">/</span> 20 <span class="token operator">-</span>&gt; 作为方法返回值返回
      Exception table:
         <span class="token keyword">from</span>    to  target <span class="token function">type</span>
             0     3     6   any
</code></pre> 
<ul><li>由于 finally 中的被插入了所有可能的流程，因此返回结果肯定以 finally 的为准</li><li>当 try 中的 10 要返回之前，被先存放到了局部变量表中，然后去执行 finally 块，fianlly 中也返回了值，导致之前存放在局部变量表中的 10 没能被返回。</li><li>跟上例中的 finally 相比，发现没有 athrow 了，这告诉我们：如哦在 finally 中出现了 return，会吞掉一次。可以试一下下面的代码：</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_12_1</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行的结果中并没有抛出异常。</p> 
<ul><li><strong>finally 对返回值影响</strong></li></ul> 
<p>同样问问自己，下面的题目输出什么？</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_12_2</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            i <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-powershell"> public static int test<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">)</span>I
    flags: ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
    Code:
      stack=1<span class="token punctuation">,</span> locals=3<span class="token punctuation">,</span> args_size=0
         0: bipush        10      <span class="token operator">/</span><span class="token operator">/</span> 10 <span class="token operator">-</span>&gt; 栈顶
         2: istore_0							<span class="token operator">/</span><span class="token operator">/</span> 10 <span class="token operator">-</span>&gt; slot 0
         3: iload_0								<span class="token operator">/</span><span class="token operator">/</span> i<span class="token punctuation">(</span>10<span class="token punctuation">)</span> <span class="token operator">-</span>&gt; 栈顶
         4: istore_1							<span class="token operator">/</span><span class="token operator">/</span> 10 <span class="token operator">-</span>&gt; slot 1<span class="token punctuation">,</span>暂存在slot 1，目的是为了固定返回值
         5: bipush        20			<span class="token operator">/</span><span class="token operator">/</span> 20 <span class="token operator">-</span>&gt; 栈顶
         7: istore_0							<span class="token operator">/</span><span class="token operator">/</span> 20 <span class="token operator">-</span>&gt; slot 0
         8: iload_1								<span class="token operator">/</span><span class="token operator">/</span> 10 <span class="token operator">-</span>&gt; 栈顶
         9: ireturn								<span class="token operator">/</span><span class="token operator">/</span> 返回栈顶的10
        10: astore_2
        11: bipush        20
        13: istore_0
        14: aload_2
        15: athrow
      Exception table:
         <span class="token keyword">from</span>    to  target <span class="token function">type</span>
             3     5    10   any
</code></pre> 
<h4><a id="212_synchronized_1164"></a>2.12 synchronized</h4> 
<p>理解加锁原理：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_13</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>字节码：</p> 
<pre><code class="prism language-powershell"> public static void main<span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
    Code:
      stack=2<span class="token punctuation">,</span> locals=4<span class="token punctuation">,</span> args_size=1
         0: new           <span class="token comment">#2                  // class java/lang/Object 创建一个新对象</span>
         3: dup																<span class="token operator">/</span><span class="token operator">/</span> 复制lock对象
         4: invokespecial <span class="token comment">#1                  // Method java/lang/Object."&lt;init&gt;":()V   调用构造方法</span>
         7: astore_1													<span class="token operator">/</span><span class="token operator">/</span> lock <span class="token operator">-</span>&gt; slot 1
         8: aload_1														<span class="token operator">/</span><span class="token operator">/</span> lock <span class="token operator">-</span>&gt; 栈顶 <span class="token punctuation">(</span>加锁开始<span class="token punctuation">)</span>
         9: dup																<span class="token operator">/</span><span class="token operator">/</span> 复制lock对象
        10: astore_2													<span class="token operator">/</span><span class="token operator">/</span> 将lock_2 <span class="token operator">-</span>&gt; slot 2 <span class="token punctuation">(</span>后续解锁使用<span class="token punctuation">)</span>
        11: monitorenter											<span class="token operator">/</span><span class="token operator">/</span> lock开启monitor线程
        12: getstatic     <span class="token comment">#3                  // Field java/lang/System.out:Ljava/io/PrintStream;   </span>
        15: ldc           <span class="token comment">#4                  // String ok</span>
        17: invokevirtual <span class="token comment">#5                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
        20: aload_2                           <span class="token operator">/</span><span class="token operator">/</span> lock_2 <span class="token operator">-</span>&gt; 栈顶
        21: monitorexit												<span class="token operator">/</span><span class="token operator">/</span> lock的monitor线程结束
        22: goto          30									<span class="token operator">/</span><span class="token operator">/</span> 退出
        25: astore_3													<span class="token operator">/</span><span class="token operator">/</span> 如果在锁期间发生任何异常<span class="token punctuation">,</span>异常对象 <span class="token operator">-</span>&gt; slot 3
        26: aload_2														<span class="token operator">/</span><span class="token operator">/</span> lock <span class="token operator">-</span>&gt; 栈顶
        27: monitorexit												<span class="token operator">/</span><span class="token operator">/</span> 结束 lock 的 monitor线程
        28: aload_3														<span class="token operator">/</span><span class="token operator">/</span> 异常对象 <span class="token operator">-</span>&gt; 栈顶
        29: athrow														<span class="token operator">/</span><span class="token operator">/</span> 抛出异常
        30: <span class="token keyword">return</span>
      Exception table:
         <span class="token keyword">from</span>    to  target <span class="token function">type</span>
            12    22    25   any
            25    28    25   any
</code></pre> 
<h3><a id="_1220"></a>三、编译器处理</h3> 
<p>所谓的语法糖，其实就是指 Java 编译器把 <code>*.java</code>源码编译为 <code>*.class</code>字节码的过程中，自动生成和转换的一些代码，主要是为了减轻程序员的负担，算是 Java 编译器给我们的一个额外福利。</p> 
<p>注意，以下代码的分析，借助了 javap 工具，idea 的反编译功能，idea 插件 jclasslib 等工具。另外，编译器转换的结果直接就是 class 字节码，只是为了阅读方便，给出了几乎等价的 Java 源码方式，并不是编译器还会转换出中间的 Java 源码。</p> 
<h4><a id="31__1230"></a>3.1 默认构造器</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy1</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编译成 class 后的代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy1</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 这个无参构造是编译器帮助我们加上的</span>
    <span class="token keyword">public</span> <span class="token class-name">Candy1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 即调用父类 Object 的无参构造方法，即调用 java/lang/Object."&lt;init&gt;":()V</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="32__1254"></a>3.2 自动拆装箱</h4> 
<p>这个特性是 <code>JDK 5</code>开始加入的，代码片段 1：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy2</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Integer</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> y <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这段代码在 <code>JDK 5</code>之前是无法编译通过的，必须改写为代码片段 2：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy2</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Integer</span> x <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> y <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>显然之前的版本的代码太麻烦了，需要在基本类型和包装类之间来回转换（尤其是集合类中的操作的都是包装类型），因此这些转换的事情在 <code>JDK 5</code>以后都由编译器在编译阶段完成。即编译代码 1 都会在编译阶段被转换为代码片段 2。</p> 
<h4><a id="33__1284"></a>3.3 泛型集合取值</h4> 
<p>泛型也是在 <code>JDK 5</code>开始加入的特性，但 Java 在编译泛型代码后会执行 <code>泛型擦除 </code>的动作，即泛型在编译为字节码之后就丢失了，实际的类型都当作了 Object 类型来处理：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy3</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实际调用的是 List.add(Object e)</span>
        <span class="token class-name">Integer</span> x <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实际调用的是 Object obj = List.get(int index);</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>所以在取值时，编译器真正生成的字节码中，还要额外做一个类型转换的操作。</p> 
<pre><code class="prism language-java"><span class="token comment">// 需要将 Object 转换为 Integer</span>
<span class="token class-name">Integer</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>如果前面的 x 变量类型修改为 int 基本类型那么最终生成的字节码是：</p> 
<pre><code class="prism language-java"><span class="token comment">// 需要将Object转换为Integer，并执行拆箱操作</span>
<span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>擦除的是字节码上的泛型信息，可以看到 LocalVariableTypeTable 仍然保留了方法参数泛型的信息。</p> 
<pre><code class="prism language-powershell">public cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>t3<span class="token punctuation">.</span>candy<span class="token punctuation">.</span>Candy3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
descriptor: <span class="token punctuation">(</span><span class="token punctuation">)</span>V
flags: ACC_PUBLIC
Code:
stack=1<span class="token punctuation">,</span> locals=1<span class="token punctuation">,</span> args_size=1
0: aload_0
1: invokespecial <span class="token comment">#1 // Method java/lang/Object."</span>
&lt;init&gt;<span class="token string">":()V
4: return
LineNumberTable:
line 6: 0
LocalVariableTable:
Start Length Slot Name Signature
0 5 0 this Lcn/itcast/jvm/t3/candy/Candy3;
public static void main(java.lang.String[]);
descriptor: ([Ljava/lang/String;)V
flags: ACC_PUBLIC, ACC_STATIC
Code:
stack=2, locals=3, args_size=1
0: new #2 // class java/util/ArrayList
3: dup
4: invokespecial #3 // Method java/util/ArrayList."</span>
&lt;init&gt;":<span class="token punctuation">(</span><span class="token punctuation">)</span>V
7: astore_1
8: aload_1
9: bipush 10
11: invokestatic <span class="token comment">#4 // Method</span>
java/lang/Integer<span class="token punctuation">.</span>valueOf:<span class="token punctuation">(</span>I<span class="token punctuation">)</span>Ljava/lang/Integer<span class="token punctuation">;</span>
14: invokeinterface <span class="token comment">#5, 2 // InterfaceMethod</span>
java/util/List<span class="token punctuation">.</span>add:<span class="token punctuation">(</span>Ljava/lang/Object<span class="token punctuation">;</span><span class="token punctuation">)</span>Z
19: pop
20: aload_1
21: iconst_0
22: invokeinterface <span class="token comment">#6, 2 // InterfaceMethod</span>
java/util/List<span class="token punctuation">.</span>get:<span class="token punctuation">(</span>I<span class="token punctuation">)</span>Ljava/lang/Object<span class="token punctuation">;</span>
27: checkcast <span class="token comment">#7 // class java/lang/Integer</span>
30: astore_2
31: <span class="token keyword">return</span>
LineNumberTable:
line 8: 0
line 9: 8
line 10: 20
line 11: 31
LocalVariableTable:
<span class="token function">Start</span> Length Slot Name Signature
0 32 0 args <span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span>
8 24 1 list Ljava/util/List<span class="token punctuation">;</span>
LocalVariableTypeTable:
<span class="token function">Start</span> Length Slot Name Signature
8 24 1 list Ljava/util/List&lt;Ljava/lang/Integer<span class="token punctuation">;</span>&gt;<span class="token punctuation">;</span>
</code></pre> 
<p>使用反射，仍然能够获得这些 参数泛型 信息：</p> 
<pre><code class="prism language-java"> <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token class-name">Method</span> test <span class="token operator">=</span> <span class="token class-name">Candy3</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">getGenericParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> type <span class="token operator">:</span> types<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token keyword">instanceof</span> <span class="token class-name">ParameterizedType</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ParameterizedType</span> parameterizedType <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ParameterizedType</span><span class="token punctuation">)</span> type<span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"原始类型 - "</span> <span class="token operator">+</span> parameterizedType<span class="token punctuation">.</span><span class="token function">getRawType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arguments <span class="token operator">=</span> parameterizedType<span class="token punctuation">.</span><span class="token function">getActualTypeArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"泛型参数[%d] - %s\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-powershell">原始类型 <span class="token operator">-</span> interface java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List
泛型参数<span class="token punctuation">[</span>0<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token keyword">class</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String
原始类型 <span class="token operator">-</span> interface java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map
泛型参数<span class="token punctuation">[</span>0<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token keyword">class</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Integer
泛型参数<span class="token punctuation">[</span>1<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token keyword">class</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object
</code></pre> 
<h4><a id="34__1404"></a>3.4 可变参数</h4> 
<p>可变参数也是 JDK 5 加入的新特性：</p> 
<p>例如：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy4</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> args<span class="token punctuation">;</span> <span class="token comment">// 直接赋值</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">foo</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可变参数 <code>String... args</code>其实是一个 <code>String[] args</code>,从代码的赋值语句就能看出来。同样 Java 编译器会在编译期间将上诉代码变换为：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy4</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> args<span class="token punctuation">;</span> <span class="token comment">// 直接赋值</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果调用了 <code>foo()</code>相当于代码为 <code>foo(new String[]{})</code>，创建了一个空的数组，而不会传递 <code>null</code>进去。</p> 
<h4><a id="35_foreach__1440"></a>3.5 foreach 循环</h4> 
<p>仍是 JDK 5 开始引入的语法糖，数组的循环：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy5_1</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 数组赋初值的简化写法也是语法糖哦</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> e <span class="token operator">:</span> array<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>会被编译器转换为：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy5_1</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 数组赋初值的简化写法也是语法糖哦</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">&lt;</span> array<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> e <span class="token operator">=</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>而集合的循环：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy5_2</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> i <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>会被编译器转换为：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy5_2</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span> iter <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Integer</span> e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span>ter<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>foreach 循环写法，能够配合数组，以及所有实现了 <code>Iterable</code>接口的集合类一起使用，其中 <code>Iterable</code>用来获取集合的迭代器 <code>Iterator</code>。</p> 
<h4><a id="36_switch__1503"></a>3.6 switch 字符串</h4> 
<p>从 JDK 7 开始，switch 可以作用域字符串和枚举类，这个功能其实也是语法糖，例如：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy6_1</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token string">"hello"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> <span class="token string">"world"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意： switch 配合 String 和枚举使用时，变量不能为 null。</p> 
<p>会被编译器变转换为：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy6_1</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">Candy6_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">byte</span> x <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token number">99162322</span><span class="token operator">:</span> <span class="token comment">// hello 的 hashCode</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">113318802</span><span class="token operator">:</span> <span class="token comment">// world 的 hashCode</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        	<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
        	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，执行了两边 switch，第一遍是根据字符串的 hashCode 和 equals 将字符串转换为相应 byte 类型，第二遍才是利用 byte 进行比较。</p> 
<p>为什么第一遍时必须即比较 hashCode，又利用 equals 比较呢？</p> 
<p>hashCode 是为了提高效率，减少可能的比较；而 equals 是为了防止 hashCode 冲突，例如 <code>BM</code>和 <code>C.</code>。这两个字符串的 hashCode 值都是 <code>2123</code>，如果有如下代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy6_2</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token string">"BM"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> <span class="token string">"C."</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>会被编译器转换为：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy6_2</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">Candy6_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">byte</span> x <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token number">2123</span><span class="token operator">:</span> <span class="token comment">// hashCode 值可能相同，需要进一步用 equals 比较</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"C."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"BM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">switch</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span>
   	    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="37_switch__1609"></a>3.7 switch 枚举</h4> 
<p>代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">enum</span> <span class="token class-name">Sex</span> <span class="token punctuation">{<!-- --></span>
    <span class="token constant">MALE</span><span class="token punctuation">,</span> <span class="token constant">FEMALE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy7</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token class-name">Sex</span> sex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>sex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token constant">MALE</span><span class="token operator">:</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"男"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">FEMALE</span><span class="token operator">:</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"女"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>转换后代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy7</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
    * 定义一个合成类（仅 jvm 使用，对我们不可见）
    * 用来映射枚举的 ordinal 与数组元素的关系
    * 枚举的 ordinal 表示枚举对象的序号，从 0 开始
    * 即 MALE 的 ordinal()=0，FEMALE 的 ordinal()=1
    */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> $<span class="token constant">MAP</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 数组大小即为枚举元素个数，里面存储case用来对比的数字</span>
        <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        map<span class="token punctuation">[</span><span class="token class-name">Sex</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        map<span class="token punctuation">[</span><span class="token class-name">Sex</span><span class="token punctuation">.</span><span class="token constant">FEMALE</span><span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token class-name">Sex</span> sex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> $<span class="token constant">MAP</span><span class="token punctuation">.</span>map<span class="token punctuation">[</span>sex<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"男"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"女"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           	 	<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="38__1666"></a>3.8 枚举类</h4> 
<p>JDK 7 新增加了枚举类，以前面的性别枚举为例：</p> 
<pre><code class="prism language-java"><span class="token keyword">enum</span> <span class="token class-name">Sex</span><span class="token punctuation">{<!-- --></span>
    <span class="token constant">MALE</span><span class="token punctuation">,</span> <span class="token constant">FEMALE</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>转换后的代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Sex</span> <span class="token keyword">extends</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sex</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Sex</span> <span class="token constant">MALE</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Sex</span> <span class="token constant">FEMALE</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Sex</span><span class="token punctuation">[</span><span class="token punctuation">]</span> $<span class="token constant">VALUES</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">MALE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sex</span><span class="token punctuation">(</span><span class="token string">"MALE"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">FEMALE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sex</span><span class="token punctuation">(</span><span class="token string">"FEMALE"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $<span class="token constant">VALUES</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sex</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token constant">MALE</span><span class="token punctuation">,</span> <span class="token constant">FEMALE</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
    * Sole constructor. Programmers cannot invoke this constructor.
    * It is for use by code emitted by the compiler in response to
    * enum type declarations.
    *
    * @param name - The name of this enum constant, which is the identifier
    * used to declare it.
    * @param ordinal - The ordinal of this enumeration constant (its position
    * in the enum declaration, where the initial constant is
    assigned
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">Sex</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> ordinal<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> ordinal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Sex</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">return</span> $<span class="token constant">VALUES</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Sex</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">return</span> <span class="token class-name">Enum</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">Sex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="39_trywithresources_1715"></a>3.9 try-with-resources</h4> 
<p>JDK 7 开始新增了对需要关闭的资源处理的特殊语法：<code>try-with-resources</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">try</span><span class="token punctuation">(</span>资源变量 <span class="token operator">=</span> 创建资源对象）<span class="token punctuation">{<!-- --></span>
    
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p>之前我们如果要关闭资源的话还要写一个 finally 块用来写关闭资源的那一部分代码。</p> 
<p>其中资源对象需要实现 <code>AutoCloseable</code>接口，例如 <code>InputStream</code>、<code>OutputStream</code>等接口都实现了该接口，使用 <code>try-catch-resources</code>可以不用写 <code>finally</code>语句块，编译器会帮助生成关闭资源代码，例如：</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy9</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"d:\\1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>会被转换为：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy9</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">Candy9</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"d:\\1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Throwable</span> t <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// t 是我们代码出现的异常</span>
                t <span class="token operator">=</span> e1<span class="token punctuation">;</span>
                <span class="token keyword">throw</span> e1<span class="token punctuation">;</span>  <span class="token comment">// 抛出异常对象会再finally执行完之后再抛出。</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 判断了资源不为空</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>is <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 如果我们代码有异常</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            is<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							<span class="token comment">// 如果 close 出现异常，作为被压制异常添加</span>
                            t<span class="token punctuation">.</span><span class="token function">addSuppressed</span><span class="token punctuation">(</span>e2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 如果我们代码没有异常，close 出现的异常就是最后 catch 块中的 e</span>
                        is<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>为什么要设计一个 <code>addSuppressed(Throwable e)</code>（添加被压制异常）的方法呢？**<br> **<strong>addSuppressed</strong> 是 Java 编程语言中 <strong>Throwable</strong> 类的一个方法，用于将一个异常添加到另一个异常的抑制异常列表中。抑制异常是在处理主异常时可能抛出的次要异常。这个方法的目的是让程序员能够跟踪多个相关的异常，以便更好地调试问题。</p> 
<p>在 Java 中，异常是通过 <strong>throw</strong> 语句抛出的。当一个异常发生时，通常会创建一个 <strong>Throwable</strong> 类型的对象，然后将其抛出。在异常处理的过程中，可能会有多个异常发生，但只能捕获和处理一个。为了保存其他的异常信息，Java 引入了抑制异常的概念。</p> 
<p>是为了防止异常信息的丢失（想想 try-with-resources 生成的 finally 中如果抛出了异常）:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test6</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">MyResource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">MyResource</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"close 异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-powershell">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ArithmeticException: <span class="token operator">/</span> by zero
  at test<span class="token punctuation">.</span>Test6<span class="token punctuation">.</span>main<span class="token punctuation">(</span>Test6<span class="token punctuation">.</span>java:7<span class="token punctuation">)</span>
  Suppressed: java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Exception: close 异常
    at test<span class="token punctuation">.</span>MyResource<span class="token punctuation">.</span>close<span class="token punctuation">(</span>Test6<span class="token punctuation">.</span>java:18<span class="token punctuation">)</span>
    at test<span class="token punctuation">.</span>Test6<span class="token punctuation">.</span>main<span class="token punctuation">(</span>Test6<span class="token punctuation">.</span>java:6<span class="token punctuation">)</span>
</code></pre> 
<p>如以上代码所示，两个异常信息都不会丢。</p> 
<h4><a id="310__1825"></a>3.10 方法重写时的桥接方法</h4> 
<p>桥接方法：子类重写的方法的返回值可以是父类方法的返回值的子类。</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">Number</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
	<span class="token comment">// 子类 m 方法的返回值是 Integer 是父类 m 方法返回值 Number 的子类</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于重写的方法返回值类型不一致，Java 编译器会生成一个桥接方法来保持一致。</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 此方法才是真正重写了父类 public Number m() 方法</span>
    <span class="token keyword">public</span> synthetic bridge <span class="token class-name">Number</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// 调用 public Integer m()</span>
        <span class="token keyword">return</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中桥接方法比较特殊，仅对 java 虚拟机可见，并且与原来的 <code>public Integer m()</code>没有命名冲突，可以用下面反射代码来验证：</p> 
<pre><code class="prism language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> m <span class="token operator">:</span> <span class="token class-name">B</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>会输出：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Integer</span> <span class="token class-name"><span class="token namespace">test<span class="token punctuation">.</span>candy<span class="token punctuation">.</span></span>B</span><span class="token punctuation">.</span><span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Number</span> <span class="token class-name"><span class="token namespace">test<span class="token punctuation">.</span>candy<span class="token punctuation">.</span></span>B</span><span class="token punctuation">.</span><span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="311__1878"></a>3.11 匿名内部类</h4> 
<p>源代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy11</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>转换后代码：</p> 
<pre><code class="prism language-java"><span class="token comment">// 额外生成的类</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Candy11</span>$<span class="token number">1</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Candy11</span>$<span class="token function">1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy11</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Candy11</span>$<span class="token function">1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>引用局部变量的匿名内部类，源代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy11</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok:"</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>转换后代码：</p> 
<pre><code class="prism language-java"><span class="token comment">// 额外生成的类</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Candy11</span>$<span class="token number">1</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> val$x<span class="token punctuation">;</span>
    <span class="token class-name">Candy11</span>$<span class="token function">1</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>val$x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok:"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>val$x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy11</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Candy11</span>$<span class="token function">1</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意：这同时解释了为什么匿名内部类引用局部变量时，局部变量必须是 final 的：因为再创建 <code>Candy11$1</code>对象时，将 x 的值赋值给了 <code>Candy11$1</code>对象的 <code>val$x</code>属性，所以 x 不应该再发生变换了，如果变化，那么 <code>Val$x</code>属性没有机会再跟着一起变化，因为只有在创建对象时变化这一个入口。</p> 
<h3><a id="_1957"></a>四、类加载阶段</h3> 
<h4><a id="41__1959"></a>4.1 类的生命周期</h4> 
<p>类从被加载到虚拟机内存中开始到卸载出内存位置，它的整个生命周期可以简单概括为 7 个阶段：加载、验证、准备、解析、初始化、使用、卸载。其中，验证、准备和解析这三个阶段可以统称为连接。</p> 
<p><img src="https://images2.imgbox.com/de/e4/SpkZCDBC_o.png" alt="img"></p> 
<h4><a id="42__1969"></a>4.2 类加载过程</h4> 
<p>在Java中，类的加载是Java虚拟机（JVM）执行的一个重要步骤。类的加载过程包括加载（Loading）、验证（Verification）、准备（Preparation）、解析（Resolution）、初始化（Initialization）、使用（Using）和卸载（Unloading）七个阶段，其中验证、准备、解析这三个阶段统称为连接（Linking）阶段。</p> 
<p>以下是Java类加载的基本过程：</p> 
<ol><li><strong>加载（Loading）：</strong></li></ol> 
<ul><li>类加载的第一步是加载类的字节码。</li><li>加载阶段完成后，字节码被存储在方法区中。</li></ul> 
<ol><li><strong>验证（Verification）：</strong></li></ol> 
<ul><li>在这个阶段，验证被加载的类的字节码是否符合JVM规范，防止恶意代码对JVM的破坏。</li><li>这个过程包括文件格式验证、元数据验证、字节码验证和符号引用验证。</li></ul> 
<ol><li><strong>准备（Preparation）：</strong></li></ol> 
<ul><li>在准备阶段，JVM 为类的静态变量分配内存，并设置默认初始值。</li><li>这里不包括实例变量，实例变量会在对象实例化时随着对象一起分配在堆中。</li></ul> 
<ol><li><strong>解析（Resolution）：</strong></li></ol> 
<ul><li>解析阶段是将类、接口、字段和方法的符号引用转化为直接引用的过程。</li><li>符号引用是一组符号来描述所引用的目标，而直接引用可以是直接指向目标的指针、相对偏移量或者一个能够间接定位到目标的句柄。</li></ul> 
<ol><li><strong>初始化（Initialization）：</strong></li></ol> 
<ul><li>初始化阶段是类加载的最后一步，也是执行类构造器()方法的过程。</li><li>类构造器是由编译器自动收集类中所有静态变量的赋值动作和静态代码块中的语句合并产生的。</li></ul> 
<ol><li><strong>使用（Using）：</strong></li></ol> 
<ul><li>在这个阶段，已经加载、验证、准备、解析并初始化了类，可以开始执行类的方法。</li></ul> 
<ol><li><strong>卸载（Unloading）：</strong></li></ol> 
<ul><li>卸载阶段是指当类在内存中已经不再需要，并且可以被垃圾收集器回收时，卸载类。</li></ul> 
<p>需要注意的是，这些阶段并不是一成不变的，某些阶段的操作可能会在其他阶段之后或之前发生，具体实现取决于JVM的具体实现。</p> 
<p>Class 文件需要加载到虚拟机中之后才能运行和使用，那么虚拟机是如何加载这些 Class 文件呢？</p> 
<p>系统加载 Class 类型的文件主要三步：加载-&gt;连接-&gt;初始化。连接过程又可分为三步：验证-&gt;准备-&gt;解析。</p> 
<p><img src="https://images2.imgbox.com/ea/dd/rSV1WQzE_o.png" alt="img"></p> 
<p>加载</p> 
<p>类加载过程的第一步，主要完成下面 3 件事情：</p> 
<ol><li>通过全类名获取定义此类的二进制字节流。</li><li>将字节流所代表的静态存储结构转换为方法区的运行时数据结构。</li><li>在内存中生成一个代表该类的 Class 对象，作为方法区这些数据的访问入口。</li></ol> 
<p>加载这一步主要是通过后面要讲到的 <strong>类加载器</strong> 完成的。类加载器有很多种，当我们想要加载一个类的时候，具体是哪个类加载器加载由 <strong>双亲委派模型</strong> 决定的。</p> 
<p>每个 Java 类都有一个引用指向加载它的 <code>ClassLoader</code>。不过，数组类不是通过 <code>ClassLoader</code>创建的，而是 JVM 在需要的时候自动创建的，数组类通过 <code>getClassLoader()</code>方法获取 <code>ClassLoader</code>的时候和该数组的元素类型的 <code>ClassLoader</code>是一致的。</p> 
<p>一个非数组类的加载阶段（加载阶段获取类的二进制字节流的动作）是可控性最强的阶段，这一步我们可以去完成还可以自定义类加载器去控制字节流的获取方式（重写一个类加载器的 <code>loadClass()</code>方法）。</p> 
<p>加载阶段与连接阶段的部分动作（如一部分字节码文件格式验证动作）是交叉进行的，加载阶段尚未结束，连接阶段可能就已经开始了。</p> 
<p>验证</p> 
<p>验证是连接阶段的第一步，这一阶段的目的是确保 Class 文件的字节流中包含的信息符合《Java 虚拟机规范》的全部约束要求，保证这些信息被当作代码运行后不会危害虚拟机自身的安全。</p> 
<p>验证阶段这一步在整个加载过程中耗费的资源还是相对较多的，但很有必要，可以防止恶意代码的执行。任何时候，程序安全都是第一位的。</p> 
<p>不过，验证阶段也不是必须要执行的阶段。如果程序运行的全部代码（包括自己编写的、第三方包中的、从外部加载的、动态生成的等所有代码）都已经被反复使用和验证过，在生产环境的实施阶段就可以关闭大部分的类验证措施，以缩短虚拟机类加载的时间。</p> 
<p>验证阶段主要由四个检验阶段组成：</p> 
<ol><li>文件格式验证（Class 文件格式检查）</li><li>元数据验证（字节码语义检查）</li><li>字节码验证（程序语义检查）</li><li>符号引用验证（类的正确性检查）</li></ol> 
<p><img src="https://images2.imgbox.com/87/5b/kdK5cpSq_o.png" alt="img"></p> 
<p>文件格式验证这一阶段是基于该类的二进制字节流进行的，主要目的是保证输入的字节流能正确地解析并存储于方法区之内，格式上符合描述一个 Java 类型信息的要求。除了这一阶段之外，其余三个验证阶段都是基于方法区的存储结构上进行的，不会再直接读取、操作字节流了。</p> 
<p>方法区属于 JVM 运行时数据区域的一块逻辑区域，是各个线程共享的内存区域。当虚拟机要使用一个类时，它需要读取并解析 Class 文件获取相关信息，再将信息存入方法区。方法区会存储已被虚拟机加载的类信息、字段信息、方法信息、常量、静态变量、即使编译器 编译后的代码缓存等数据。</p> 
<p>符号引用验证发生再类加载过程中的解析阶段，具体点说时 JVM 将符号引用转换为直接引用的时候。</p> 
<p>符号引用验证的主要目的是确保解析阶段能正常执行，如果无法通过符号引用验证，JVM 会抛出异常。比如：</p> 
<ul><li><code>java.lang.IllegalAccessError</code>：当类试图访问或修改它没有权限访问的字段，或调用它没有权限访问的方法时，抛出该异常。</li><li><code>java.lang.NoSuchFieldError</code>：当类试图访问或修改一个指定的对象字段，而该对象不再包含该字段时，抛出该异常</li></ul> 
<p>准备</p> 
<p>准备阶段是正式为类变量分配内存并设置类变量初始值的阶段，这些内存都将再方法区中分配。对于该阶段有一下几点需要注意：</p> 
<ol><li>这时候进行内存分配的仅包括类变量（即静态变量），而不包括实例变量。实例变量会在对象实例化时随着对象一块分配在 Java 堆中。</li><li>从概念上讲，类变量所使用的内存都应当在方法区中进行分配。不过有一点需要主义的是：JDK 7 之前，HotSpot 使用永久代来实现方法区的时候，实现是完全符合这种逻辑概念的。而在 JDK 7 之后，HotSpot 已经把原本放在永久代的字符串常量池、静态变量等移动到堆中，这个时候类变量则会随着 Class 对象一起存放在 Java 堆中。</li><li>这里所设置的初始值”通常情况下“是数据类型默认的零值（如 0，0L，null，false 等），比如我们定义了 <code>public static int value = 111</code>，那么 value 变量在准备阶段的初始值就是 0 而不是 111（初始化阶段才会赋值）。特殊情况：比如给 value 变量加上了 final 关键字 <code>public static final int value = 111 </code>，那么准备阶段 value 的值就会赋值为 111。如果 static 变量是 final 的，但属于引用类型，那么赋值也会在初始化阶段完成。</li></ol> 
<pre><code class="prism language-java"><span class="token comment">// 演示 final 对静态变量的影响</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Load8</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">static</span> <span class="token keyword">int</span> a<span class="token punctuation">;</span>   <span class="token comment">//准备阶段设默认值</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">// 初始化阶段赋值</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token comment">// 准备阶段赋值</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> d <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span><span class="token comment">// 准备阶段赋值</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化阶段赋值</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>解析</p> 
<p>解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程。解析阶段主要针对类或接口、字段、类方法、接口方法、方法句柄和调用限定符 7 类符号引用进行。</p> 
<p>符号引用：符号引用以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只要使用时能无歧义地定位到目标即可。</p> 
<p>直接引用：直接引用时可以直接指向目标地指针、相对偏移量或者是一个能简介定位到目标地句柄。</p> 
<p>举个例子：在程序指向方法时，系统需要明确知道这个方法所在的位置。Java 虚拟机为每个类都准备了一张方法表来存放类中所有的方法。当需要调用一个类的方法的时候，只要知道这个方法在放发表中的偏移量就可以直接调用该方法了。通过解析操作符号引用就可以直接转变为目标方法在类中方法表的位置，从而使得方法可以被调用。</p> 
<p>综上，解析阶段时虚拟机将常量池内的符号引用替换为直接引用的过程，也就是得到类或字段、方法在内存中的指针或者偏移量。</p> 
<p>初始化</p> 
<p>初始化阶段是执行初始化方法 <code>&lt;clinit&gt;()</code>方法的过程，是类加载的最后一步，这一步 JVM 才开始真正执行类中定义的 Java 程序代码（字节码）。</p> 
<p>说明：<code>&lt;clinit&gt;()</code>方法是编译之后自动生成的。</p> 
<p>类构造器是比由编译器自动收集类中所有静态变量的赋值动作和静态代码块中的语句合并产生的。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Load3</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//        // 1. 静态常量不会触发初始化</span>
<span class="token comment">//        System.out.println(B.b);</span>
<span class="token comment">//        // 2. 类对象.class 不会触发初始化</span>
<span class="token comment">//        System.out.println(B.class);</span>
<span class="token comment">//        // 3. 创建该类的数组不会触发初始化</span>
<span class="token comment">//        System.out.println(new B[0]);</span>
        <span class="token comment">// 4. 不会初始化类 B，但会加载 B、A</span>
        <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cl<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"cn.itcast.jvm.t3.load.B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        // 5. 不会初始化类 B，但会加载 B、A</span>
<span class="token comment">//        ClassLoader c2 = Thread.currentThread().getContextClassLoader();</span>
<span class="token comment">//        Class.forName("cn.itcast.jvm.t3.load.B", false, c2);</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//        // 1. 首次访问这个类的静态变量或静态方法时</span>
<span class="token comment">//        System.out.println(A.a);</span>
<span class="token comment">//        // 2. 子类初始化，如果父类还没初始化，会引发</span>
<span class="token comment">//        System.out.println(B.c);</span>
<span class="token comment">//        // 3. 子类访问父类静态变量，只触发父类初始化</span>
<span class="token comment">//        System.out.println(B.a);</span>
<span class="token comment">//        // 4. 会初始化类 B，并先初始化类 A</span>
<span class="token comment">//        Class.forName("cn.itcast.jvm.t3.load.B");</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">double</span> b <span class="token operator">=</span> <span class="token number">5.0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">boolean</span> c <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"b init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>对于初始换阶段，虚拟机规范了有且只有 6 中情况下，必须对类进行初始化（只有主动去使用类才会初始化类）：</p> 
<p>分析 1：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Load4</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 会在准备阶段加载</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 准备阶段加载</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 初始化阶段加载</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">E</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> c <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>  <span class="token comment">// Integer.valueOf(20)</span>
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"init E"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>分析 2：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Load9</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//        Singleton.test();  // 执行该方法，Singleton中的内部静态类并不会被初始化</span>
        <span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只有调用该方法时，LazyHolder才会初始化，并创建一个单例对象，而且这个对象只会被创建一次</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LazyHolder</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Singleton</span> <span class="token constant">SINGLETON</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"lazy holder init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">LazyHolder</span><span class="token punctuation">.</span><span class="token constant">SINGLETON</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="43___2261"></a>4.3 类卸载</h4> 
<p>卸载即将该类的 Class 对象被 GC。</p> 
<p>卸载类需要满足 3 个要求：</p> 
<ol><li>该类的所有实例对象都已被 GC，也就是说堆中不存在该类的实例对象。</li><li>该类没有在其他任何地方被引用。</li><li>该类的类加载器的实例已被 GC。</li></ol> 
<p>所以，在 JVM 生命周期内，由 JVM 自带的类加载器加载的类是不会被卸载的。。但是由我们自定义的类加载器加载的类是可能被卸载的。一些 JDK 自带的负责加载 JDK 提供的类，所以它们（类加载器的实例）肯定不会被回收。而我们自定义的类加载器的实例是可以被回收的，所以使用我们自定义加载器加载的类是可以被卸载掉的。</p> 
<h4><a id="44__2277"></a>4.4 类加载器</h4> 
<p>类加载器负责将类的字节码加载到内存中，并转换成运行时数据结构。JVM 支持多个类加载器，每个加载器都有自己的加载范围和加载顺序。</p> 
<ul><li>类加载器是一个负责加载类的对象，用于实现类加载过程中的加载这一步。</li><li>每个 Java 类都有一个引用指向加载它的 ClassLoader</li><li>数组类不是通过 <code>ClassLoader</code>创建的（数组类没有对应的二进制字节流），是由 JVM 直接生成的。</li></ul> 
<p>类加载器主要分为三个层次：</p> 
<ol><li> <p>启动类加载器：</p> </li><li> <p>是最顶层的类加载器，负责加载 Java 的核心类库，位于 <code>&lt;JAVA_HOME&gt;/lib</code>目录下。</p> </li><li> <p>由 C++实现，不是 Java 类</p> </li><li> <p>在 JVM 启动时被启动，是其他类加载器对的父加载器，自己没有父加载器。</p> </li><li> <p>扩展类加载器</p> </li><li> <p>位于 <code>&lt;JAVA_HOME&gt;/lib/ext</code>目录下</p> </li><li> <p>主要负责加载 Java 的扩展类库，可以通过 <code>java.ext.dirs</code>指定扩展类库的目录。</p> </li><li> <p>父加载器为启动类加载器</p> </li><li> <p>应用程序类加载器</p> </li><li> <p>也称为系统类加载器，负责加载应用程序类路径上指定的类库。</p> </li><li> <p>是最常用的类加载器，也是默认的类加载器。</p> </li><li> <p>父加载器为扩展类加载器。</p> </li></ol> 
<p>自定义类加载器：用户可以通过继承 <code>java.lang.ClassLoader</code>类来实现自定义的类加载器，以满足特定的加载需求。</p> 
<p>类加载器加载规则：</p> 
<p>JVM 启动的时候，并不会一次性加载所有的类，而是根据需要去动态加载。也就是说，大部分类在具体用到的时候才回去加载，这样对内存更加友好。</p> 
<p>对于已经加载的类会放在 <code>ClassLoader</code>中。在类加载的时候，系统会首先判断当前类是否被加载过。已经被加载的类会直接返回，否则才会尝试加载。也就是说，对于一个类加载器来说，相同二进制名称的类只会被加载一次。</p> 
<h4><a id="45__2323"></a>4.5 双亲委派模型</h4> 
<p>双亲委派模型是 Java 类加载器采用的一种加载机制，用于保证类的唯一性和避免重复加载。该模型通过层次化的类加载器结果，将类加载请求委派给父加载器。只有在父加载器无法完成加载时，才由子加载器尝试加载。</p> 
<p>这种模型的基本思想是：</p> 
<ol><li>当一个类加载器收到加载类的请求时，首先不会尝试自己去加载，而是委派给父加载器去加载。</li><li>如果父加载器还存在父加载器（除了启动类加载器之外的所有加载器都有父加载器），则进一步委派给父加载器的父加载器。</li><li>最终，请求一致传递到最顶层的启动类加载器。</li><li>如果父加载器无法加载，子加载器才会尝试加载。</li></ol> 
<p>这种层次化的加载机制有几个优势：</p> 
<ul><li>类的唯一性：通过委派机制，当父加载器已经加载了一个类，自家在其就不再重复加载，确保了类的唯一性。</li><li>安全性：避免了恶意类的加载，因为恶意类可能会放在某个父加载器的搜索路径中，但由于双亲委派模型，它们无法绕过父加载器直接被子加载器加载。</li><li>共享类：父加载器加载的类对子加载器可见，而子加载器加载的类对父加载器不可以见，因此可以实现类的共享。</li></ul> 
<p>这种层次结构保证了类的唯一性和避免了类的重复加载。</p> 
<p>双亲委派模型保证了 Java 程序的稳定运行，可以避免类的重复加载（JVM 区分不同类的方式不仅仅根据类名，相同的类文件被不同的类加载器加载产生的是两个不同的类），也保证了 Java 的核心 API 不被篡改。</p> 
<p>如果没有使用双亲委派模型，而是每个类加载器加载自己的话就会出现一些问题，比如我们编写一个称为 <code>java.lang.Object</code>类的话，那么程序运行的时候，系统就会出现了两个不同的 <code>Object</code>类。 但如果使用双亲委派模型可以保证加载的是 JRE 里的那个 <code>Object</code>类，而不是你写的 <code>Object</code>类。这是因为 <code>AppClassLoader</code>在加载你的 Object 类时，会委托给 <code>ExtClassLoader</code>去加载，而 <code>ExtClassLoader</code>又会委托给 <code>BootstrapClassLoader</code>,此时自动类加载器发现自己已经加载过了 <code>Object</code>类，会直接返回，不会去加载你写的 <code>Object</code>类。</p> 
<p>双亲委派模型的执行流程：</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//首先，检查该类是否已经加载过</span>
        <span class="token class-name">Class</span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果 c 为 null，则说明该类没有被加载过</span>
            <span class="token keyword">long</span> t0 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//当父类的加载器不为空，则通过父类的loadClass来加载该类</span>
                    c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//当父类的加载器为空，则调用启动类加载器来加载该类</span>
                    c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//非空父类的类加载器无法找到相应的类，则抛出异常</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//当父类加载器无法加载时，则调用findClass方法来加载该类</span>
                <span class="token comment">//用户可通过覆写该方法，来自定义类加载器</span>
                <span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//用于统计类加载器相关的信息</span>
                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//对类进行link操作</span>
            <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结合上面的源码，简单总结一下双亲委派模型的执行流程：</p> 
<ol><li>在类加载的时候，系统会首先判断当前类是否被加载过。已经被加载的类会直接返回，否则才会尝试加载（每个父类加载器都会走一遍这个流程）。</li><li>类加载器在执行类加载的时候，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成（调用父加载器 <code>loadClass()</code>方法来加载类）。这样的话，所有的请求最终都会传送到顶层的启动类加载器 <code>BootstrapClassLoader</code>中。</li><li>只有当父加载器反馈自己无法完成这个加载请求（它的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载（调用自己的 <code>findClass()</code>方法来加载类）。</li><li>如果子类加载器也无法加载这个类，那么它会抛出一个 <code>ClassNotFoundException</code>异常。</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f0661f0cf45ee36459a126209cb9af71/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mysql间隙锁demo分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4ddd92fc388d1c5cc7e40b06afc7ef80/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">操作系统(Operator System)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>