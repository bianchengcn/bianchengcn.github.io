<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>如何用Python将普通视频变成动漫视频 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="如何用Python将普通视频变成动漫视频" />
<meta property="og:description" content="文章目录 容我废话一下一、思路流程二、图像转动漫三、视频帧读取与视频帧写入 容我废话一下 最近几个月，毒教材被曝光引发争议，那些编写度教材的人着实可恶。咱程序员也没有手绘插画能力，但咱可以借助强大的深度学习模型将视频转动漫。所以今天的目标是让任何具有python语言基本能力的程序员，实现短视频转动漫效果。
效果展示
一、思路流程 读取视频帧将每一帧图像转为动漫帧将转换后的动漫帧转为视频 难点在于如何将图像转为动漫效果。这里我们使用基于深度学习的动漫效果转换模型，考虑到许多读者对这块不了解，因此我这边准备好了源码和模型，直接调用即可。不想看文章细节的可以直接拖到文章末尾，获取源码。
二、图像转动漫 为了让大家不关心深度学习模型，已经为大家准备好了转换后的onnx类型模型。接下来按顺序介绍运行onnx模型流程。
安装onnxruntime库
pip install onnxruntime 如果想要用GPU加速，可以安装GPU版本的onnxruntime:
pip install onnxruntime-gpu 需要注意的是：
onnxruntime-gpu的版本跟CUDA有关联，具体对应关系如下：
当然，如果用CPU运行，那就不需要考虑那么多了。考虑到通用性，本文全部以CPU版本onnxruntime。
运行模型
先导入onnxruntime库，创建InferenceSession对象，调用run函数。
如下所示
import onnxruntime as rt sess = rt.InferenceSession(MODEL_PATH) inp_name = sess.get_inputs()[0].name out = sess.run(None, {inp_name: inp_image}) 具体到我们这里的动漫效果，实现细节如下：
import cv2 import numpy as np import onnxruntime as rt # MODEL = &#34;models/anime_1.onnx&#34; MODEL = &#34;models/anime_2.onnx&#34; sess = rt.InferenceSession(MODEL) inp_name = sess.get_inputs()[0].name def infer(rgb): rgb = np.expand_dims(rgb, 0) rgb = rgb * 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/51a6cb7fa8eb86d5ebecb8451e165ca9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-13T15:51:15+08:00" />
<meta property="article:modified_time" content="2022-08-13T15:51:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何用Python将普通视频变成动漫视频</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">容我废话一下</a></li><li><a href="#_9" rel="nofollow">一、思路流程</a></li><li><a href="#_17" rel="nofollow">二、图像转动漫</a></li><li><a href="#_93" rel="nofollow">三、视频帧读取与视频帧写入</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>容我废话一下</h2> 
<p>最近几个月，毒教材被曝光引发争议，那些编写度教材的人着实可恶。咱程序员也没有手绘插画能力，但咱可以借助强大的深度学习模型将视频转动漫。所以今天的目标是让任何具有python语言基本能力的程序员，实现短视频转动漫效果。</p> 
<p><strong>效果展示</strong></p> 
<p><img src="https://images2.imgbox.com/6e/de/QhD41MyO_o.gif" alt="在这里插入图片描述"></p> 
<h2><a id="_9"></a>一、思路流程</h2> 
<ol><li>读取视频帧</li><li>将每一帧图像转为动漫帧</li><li>将转换后的动漫帧转为视频</li></ol> 
<p>难点在于如何将图像转为动漫效果。这里我们使用基于深度学习的动漫效果转换模型，考虑到许多读者对这块不了解，因此我这边准备好了源码和模型，直接调用即可。不想看文章细节的可以<strong>直接拖到文章末尾，获取源码。</strong></p> 
<h2><a id="_17"></a>二、图像转动漫</h2> 
<p>为了让大家不关心深度学习模型，已经为大家准备好了转换后的onnx类型模型。接下来按顺序介绍运行onnx模型流程。</p> 
<p><strong>安装onnxruntime库</strong></p> 
<pre><code class="prism language-python">pip install onnxruntime
</code></pre> 
<p>如果想要用GPU加速，可以安装GPU版本的onnxruntime:</p> 
<pre><code class="prism language-python">pip install onnxruntime<span class="token operator">-</span>gpu
</code></pre> 
<p>需要注意的是：</p> 
<p>onnxruntime-gpu的版本跟CUDA有关联，具体对应关系如下：</p> 
<p><img src="https://images2.imgbox.com/e0/3c/yrVLsu2h_o.png" alt="在这里插入图片描述"><br> 当然，如果用CPU运行，那就不需要考虑那么多了。考虑到通用性，本文全部以CPU版本onnxruntime。</p> 
<p><strong>运行模型</strong></p> 
<p>先导入onnxruntime库，创建InferenceSession对象，调用run函数。</p> 
<p>如下所示</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> onnxruntime <span class="token keyword">as</span> rt 
sess <span class="token operator">=</span> rt<span class="token punctuation">.</span>InferenceSession<span class="token punctuation">(</span>MODEL_PATH<span class="token punctuation">)</span>
inp_name <span class="token operator">=</span> sess<span class="token punctuation">.</span>get_inputs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name
out <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>inp_name<span class="token punctuation">:</span> inp_image<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>具体到我们这里的动漫效果，实现细节如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> onnxruntime <span class="token keyword">as</span> rt 

<span class="token comment"># MODEL = "models/anime_1.onnx"</span>
MODEL <span class="token operator">=</span> <span class="token string">"models/anime_2.onnx"</span>

sess <span class="token operator">=</span> rt<span class="token punctuation">.</span>InferenceSession<span class="token punctuation">(</span>MODEL<span class="token punctuation">)</span>
inp_name <span class="token operator">=</span> sess<span class="token punctuation">.</span>get_inputs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name


<span class="token keyword">def</span> <span class="token function">infer</span><span class="token punctuation">(</span>rgb<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rgb <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>rgb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    rgb <span class="token operator">=</span> rgb <span class="token operator">*</span>  <span class="token number">2.0</span> <span class="token operator">/</span> <span class="token number">255.0</span> <span class="token operator">-</span> <span class="token number">1</span> 
    rgb <span class="token operator">=</span>  rgb<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> 
    out <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>inp_name<span class="token punctuation">:</span> rgb<span class="token punctuation">}</span><span class="token punctuation">)</span>
    out <span class="token operator">=</span> out<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    out <span class="token operator">=</span> <span class="token punctuation">(</span>out<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">255</span>
    out <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    <span class="token keyword">return</span> out

<span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>rgb<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pad_w <span class="token operator">=</span> <span class="token number">0</span>
    pad_h <span class="token operator">=</span> <span class="token number">0</span>
    h<span class="token punctuation">,</span>w<span class="token punctuation">,</span>__ <span class="token operator">=</span> rgb<span class="token punctuation">.</span>shape
    N <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">3</span>
    <span class="token keyword">if</span> h<span class="token operator">%</span>N<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
        pad_h<span class="token operator">=</span><span class="token punctuation">(</span>h<span class="token operator">//</span>N<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>N<span class="token operator">-</span>h
    <span class="token keyword">if</span> w<span class="token operator">%</span><span class="token number">2</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
        pad_w<span class="token operator">=</span><span class="token punctuation">(</span>w<span class="token operator">//</span>N<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>N<span class="token operator">-</span>w
    <span class="token comment"># print(pad_w, pad_h, w, h)</span>
    rgb <span class="token operator">=</span> np<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>rgb<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>pad_h<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pad_w<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"reflect"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> rgb<span class="token punctuation">,</span> pad_w<span class="token punctuation">,</span> pad_h
</code></pre> 
<p>其中, preprocess函数确保输入图像的宽高是8的整数倍。这里主要是因为考虑到深度学习模型有下采样，确保每次下采样能被2整除。</p> 
<p><strong>单帧效果展示</strong></p> 
<p><img src="https://images2.imgbox.com/f6/01/EnFLZimA_o.png" alt=""><br> <img src="https://images2.imgbox.com/f3/07/c1ecOt61_o.png" alt=""><br> <img src="https://images2.imgbox.com/aa/db/CrzEA5yB_o.png" alt=""></p> 
<h2><a id="_93"></a>三、视频帧读取与视频帧写入</h2> 
<p>这里使用Opencv库，提取视频中每一帧并调用回调函数将视频帧回传。在将图片转视频过程中，通过定义VideoWriter类型变量WRITE确保唯一性。具体实现代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

WRITER <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token keyword">def</span> <span class="token function">write_frame</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> out_path<span class="token punctuation">,</span> fps<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> WRITER
    <span class="token keyword">if</span> WRITER <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        size <span class="token operator">=</span> frame<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        WRITER <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoWriter<span class="token punctuation">(</span>
            out_path<span class="token punctuation">,</span>
            cv2<span class="token punctuation">.</span>VideoWriter_fourcc<span class="token punctuation">(</span><span class="token operator">*</span><span class="token string">'mp4v'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 编码器</span>
            fps<span class="token punctuation">,</span>
            size<span class="token punctuation">)</span>
    WRITER<span class="token punctuation">.</span>write<span class="token punctuation">(</span>frame<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">extract_frames</span><span class="token punctuation">(</span>video_path<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">:</span>
    video <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>video_path<span class="token punctuation">)</span>
    num_frames <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_COUNT<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>num_frames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        _<span class="token punctuation">,</span> frame <span class="token operator">=</span> video<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> frame <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            callback<span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
</code></pre> 
<p>完整源码获取点击下方微信名片获取哟~</p> 
<p>给大家推荐一套爬虫教程，涵盖常见大部分案例，非常实用！</p> 
<p><a href="https://www.bilibili.com/video/BV1SA4y1976A" rel="nofollow">代码总是学完就忘记？100个爬虫实战项目！让你沉迷学习丨学以致用丨下一个Python大神就是你！<br> </a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/84a8afa6bf7a5ac86666e1ca3b45c6f8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微信小程序天气预报功能实现(支持自动定位,附源码)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/352a211680490518073f503efdd7d2dd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python使用代理时报错ssl.SSLEOFError: EOF occurred in violation of protocol (_ssl.c:1129)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>