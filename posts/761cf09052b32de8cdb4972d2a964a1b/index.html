<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>文件上传至公有云Nos及对接CDN - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="文件上传至公有云Nos及对接CDN" />
<meta property="og:description" content="项目开发中，需要将图片文件上传至网易公有云的Nos,并且结合CDN做加速服务，记录一下开发过程。 流程图：
1. 文件上传到公有云Nos 网易对象存储服务（Netease Object Storage，简称NOS）是网易数帆提供的高可用、高可靠、高性能的云端存储服务。
本次项目由于是和外部企业合作，上传文件是上传到公有云Nos，但和部门之前上传到私有云Nos的方式一样。都是采用计算token的方式，前端直传。(私有云和公有云签名计算方式一样)
需要注意的点有：
而公有云的上传请求地址是：https://nosup-eastchina1.126.net，与私有云上传地址不同。如果请求地址不对的话，则会一直返回&#34;AccessDenied&#34;。
配置桶名及ak_sk的时候，一定要仔细检查，是否有错误，例如多个空格啥的。这种也会返回错误信息&#34;AccessDenied&#34;。
2. 认识CDN 内容分发网络（Content Delivery Network，简称CDN）是建立并覆盖在承载网之上，由分布在不同区域的边缘节点服务器群组成的分布式网络。一般应用场景在于：网页、小文件加速；大文件下载加速；视频点播加速等。
可以这样理解，cdn的作用就是将源站内容发布到不同区域的边缘节点，这样在不同地方的用户请求都能被分配最适合他的节点，就近获取节点上缓存的资源。
一方面防止每个用户请求都访问源站，避免造成网络拥塞、缓解源站压力。
另一方面，使用户可以以最快的速度取得他所需的内容，解决网络带宽小、用户访问量大、网点分布不均等问题，提高用户访问的响应速度。
3. 接入CDN 关于对接网易cdn，基本参考官方文档：https://sf.163.com/help/documents/68827624361873408。
首先是在控制台配置好加速域名，回源地址等信息；
其次由于此次项目中不仅是想完成回源访问，更想着主动预热到cdn各节点，所以需要在代码里，调用CDN提供的接口。
CDN接口功能介绍：
刷新：把CDN所有节点上对应的缓存资源标记为失效，当用户再次请求时，CDN会直接回源站获取对应的资源并返回给用户，同时将资源重新缓存到CDN节点。刷新功能会降低缓存命中率。预热：源站主动将对应的资源缓存到CDN节点，当您首次请求资源时，即可直接从CDN节点获取到最新的资源，无需再回源站获取。预热功能会提高缓存命中率。调用接口肯定需要鉴权， 这次开发中，在签名认证上花了较多时间，官方文档上没有示例，所以在格式上耽误了许久，下面给出签名格式代码：
import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Value; import org.springframework.stereotype.Service; import javax.annotation.Resource; import javax.crypto.Mac; import javax.crypto.spec.SecretKeySpec; import java.io.UnsupportedEncodingException; import java.nio.charset.StandardCharsets; import java.security.InvalidKeyException; import java.security.NoSuchAlgorithmException; import java.text.SimpleDateFormat; import java.util.*; @Service @Slf4j public class CdnAuthorizationServiceImpl implements CdnAuthorizationService { @Value(&#34;${cdn.config.accessId}&#34;) private String accessId; @Value(&#34;${cdn.config.secretKey}&#34;) private String secretKey; @Value(&#34;${cdn.config.domainName}&#34;) private String domainName; @Resource private CdnAuthorizationService cdnAuthorizationService; @Override public String getAuthorization(String signature) { return &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/761cf09052b32de8cdb4972d2a964a1b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-02T13:37:28+08:00" />
<meta property="article:modified_time" content="2023-06-02T13:37:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">文件上传至公有云Nos及对接CDN</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <pre><code>项目开发中，需要将图片文件上传至网易公有云的Nos,并且结合CDN做加速服务，记录一下开发过程。
</code></pre> 
<p>流程图：<br> <img src="https://images2.imgbox.com/c1/b1/IinQVle9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1_Nos_5"></a>1. 文件上传到公有云Nos</h3> 
<blockquote> 
 <p>网易对象存储服务（Netease Object Storage，简称NOS）是网易数帆提供的高可用、高可靠、高性能的云端存储服务。</p> 
 <p>本次项目由于是和外部企业合作，上传文件是上传到公有云Nos，但和部门之前上传到私有云Nos的方式一样。都是采用计算token的方式，前端直传。(私有云和公有云签名计算方式一样)</p> 
</blockquote> 
<p>需要注意的点有：</p> 
<p>而公有云的上传请求地址是：https://nosup-eastchina1.126.net，与私有云上传地址不同。如果请求地址不对的话，则会一直返回"AccessDenied"。</p> 
<p>配置桶名及ak_sk的时候，一定要仔细检查，是否有错误，例如多个空格啥的。这种也会返回错误信息"AccessDenied"。</p> 
<h3><a id="2_CDN_18"></a>2. 认识CDN</h3> 
<blockquote> 
 <p>内容分发网络（Content Delivery Network，简称CDN）是建立并覆盖在承载网之上，由分布在不同区域的边缘节点服务器群组成的分布式网络。一般应用场景在于：网页、小文件加速；大文件下载加速；视频点播加速等。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/69/07/3dk07ldF_o.png" alt="在这里插入图片描述"></p> 
<p>可以这样理解，cdn的作用就是将源站内容发布到不同区域的边缘节点，这样在不同地方的用户请求都能被分配最适合他的节点，就近获取节点上缓存的资源。</p> 
<p>一方面防止每个用户请求都访问源站，避免造成网络拥塞、缓解源站压力。</p> 
<p>另一方面，使用户可以以最快的速度取得他所需的内容，解决网络带宽小、用户访问量大、网点分布不均等问题，提高用户访问的响应速度。</p> 
<h3><a id="3_CDN_31"></a>3. 接入CDN</h3> 
<blockquote> 
 <p>关于对接网易cdn，基本参考官方文档：https://sf.163.com/help/documents/68827624361873408。<br> 首先是在控制台配置好加速域名，回源地址等信息；<br> 其次由于此次项目中不仅是想完成回源访问，更想着主动预热到cdn各节点，所以需要在代码里，调用CDN提供的接口。</p> 
</blockquote> 
<p>CDN接口功能介绍：</p> 
<ul><li>刷新：把CDN所有节点上对应的缓存资源标记为失效，当用户再次请求时，CDN会直接回源站获取对应的资源并返回给用户，同时将资源重新缓存到CDN节点。刷新功能会降低缓存命中率。</li><li>预热：源站主动将对应的资源缓存到CDN节点，当您首次请求资源时，即可直接从CDN节点获取到最新的资源，无需再回源站获取。预热功能会提高缓存命中率。调用接口肯定需要鉴权，</li></ul> 
<p>这次开发中，在签名认证上花了较多时间，官方文档上没有示例，所以在格式上耽误了许久，下面给出签名格式代码：</p> 
<pre><code class="prism language-import">import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import java.io.UnsupportedEncodingException;
import java.nio.charset.StandardCharsets;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.text.SimpleDateFormat;
import java.util.*;

@Service
@Slf4j
public class CdnAuthorizationServiceImpl implements CdnAuthorizationService {

    @Value("${cdn.config.accessId}")
    private String accessId;

    @Value("${cdn.config.secretKey}")
    private String secretKey;

    @Value("${cdn.config.domainName}")
    private String domainName;

    @Resource
    private CdnAuthorizationService cdnAuthorizationService;

    @Override
    public String getAuthorization(String signature) {
        return "NCDN " + accessId + ":" + signature;
    }

    @Override
    public String getSignnature(String httpVerb, String contentMd5, String contentType, String date, String canonicalizedResource) throws NoSuchAlgorithmException, InvalidKeyException {
        Mac sha256_HMAC = Mac.getInstance("HmacSHA256");
        SecretKeySpec secret_key = new SecretKeySpec(secretKey.getBytes(StandardCharsets.UTF_8), "HmacSHA256");
        sha256_HMAC.init(secret_key);
        String message = httpVerb + "\n" + contentMd5 + "\n" + contentType + "\n" + date + "\n" + canonicalizedResource;
        byte[] bytes = sha256_HMAC.doFinal(message.getBytes(StandardCharsets.UTF_8));
        return java.util.Base64.getEncoder().encodeToString(bytes);
    }

    @Override
    public String getRfctime() {
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat("EEE, dd MMM yyyy HH:mm:ss z", Locale.US);
        simpleDateFormat.setTimeZone(TimeZone.getTimeZone("GMT"));
        return simpleDateFormat.format(new Date());
    }

    @Override
    public String getPreheatAuthorization() throws UnsupportedEncodingException, NoSuchAlgorithmException, InvalidKeyException {
        String canonicalizedResource = "/domain/" + domainName;
        String rfctime = cdnAuthorizationService.getRfctime();
        String signnature = cdnAuthorizationService.getSignnature("PUT", "", "application/json", rfctime, canonicalizedResource);
        return cdnAuthorizationService.getAuthorization(signnature);
    }

    @Override
    public String getPreheatResultAuthorization(String orderType, Integer pageNum, Integer pageSize, String status) throws UnsupportedEncodingException, NoSuchAlgorithmException, InvalidKeyException {
        String canonicalizedResource = "/domain/" + domainName + "?orderType=" + orderType + "&amp;pageNum=" + pageNum + "&amp;pageSize=" + pageSize + "&amp;status=" + status;
        String rfctime = cdnAuthorizationService.getRfctime();
        String signnature = cdnAuthorizationService.getSignnature("GET", "", "application/json", rfctime, canonicalizedResource);
        return cdnAuthorizationService.getAuthorization(signnature);
    }
}
</code></pre> 
<p>注意点：</p> 
<ol><li>每个接口调用时，所需要的Authorization中内容是不同的，要看文档去分别改动签名计算内容。</li><li>获取预热结果列表接口，Authorization里的参数需要和调用接口时的参数保持一致，否则会返回签名不匹配的报错信息。</li><li>头信息除了Authorization之外，还需要Content-Type以及Date。注意Content-Type也要与签名里的Signnature保持一致。Date也要保持格式的统一。</li></ol> 
<p>鉴权通过后，就可以调用接口了，这里给出调用成功后的返回信息。</p> 
<p>预热接口调用成功后会返回prehot-id：<br> <img src="https://images2.imgbox.com/bf/52/loslWhX1_o.png" alt="在这里插入图片描述"><br> 预热结果列表调用成功后会返回全部预热个数以及每个预热url的结果：</p> 
<p><img src="https://images2.imgbox.com/1c/ff/1D9XMucn_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2bb78f9ad1534a2c26321c746c0f894e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">wpf 往richtextbox里追加不同颜色的文本，并滚动到最底部</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5236ae7f2f60d17950f2e47dc2bee357/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用rundll32.exe运行dll函数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>