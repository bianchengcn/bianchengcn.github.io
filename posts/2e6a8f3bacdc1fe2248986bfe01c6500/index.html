<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【强化学习】深度Q网络(DQN)求解倒立摆问题 &#43; Pytorch代码实战 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【强化学习】深度Q网络(DQN)求解倒立摆问题 &#43; Pytorch代码实战" />
<meta property="og:description" content="文章目录 一、倒立摆问题介绍二、深度Q网络简介三、详细资料四、Python代码实战4.1 运行前配置4.2 主要代码4.3 运行结果展示4.4 关于可视化的设置 一、倒立摆问题介绍 Agent 必须在两个动作之间做出决定 - 向左或向右移动推车 - 以使连接到它的杆保持直立。
二、深度Q网络简介 上图所示为一般的深度 Q \mathrm{Q} Q 网络算法。
深度 Q \mathrm{Q} Q 网络算法是这样的，我们初始化两个网络 ：估计网络 Q Q Q 和 目标网络 Q ^ ， Q ^ \hat{Q} ， \hat{Q} Q^​，Q^​ 就等于 Q Q Q ，一开始 目标网络 Q ^ \hat{Q} Q^​ 与原来的 Q Q Q 网络是一样的。
在每一个回合中，我们用演员与环境交互，在每一次交互的过程中，都会得到一个 状态 s t s_t st​ ，会采取某一个动作 a t 。 a_{t 。} at。​ 怎么知道采取哪一个动作 a t a_t at​ 呢?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2e6a8f3bacdc1fe2248986bfe01c6500/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-25T20:49:36+08:00" />
<meta property="article:modified_time" content="2022-10-25T20:49:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【强化学习】深度Q网络(DQN)求解倒立摆问题 &#43; Pytorch代码实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_3" rel="nofollow">一、倒立摆问题介绍</a></li><li><a href="#Q_6" rel="nofollow">二、深度Q网络简介</a></li><li><a href="#_27" rel="nofollow">三、详细资料</a></li><li><a href="#Python_36" rel="nofollow">四、Python代码实战</a></li><li><ul><li><a href="#41__37" rel="nofollow">4.1 运行前配置</a></li><li><a href="#42__43" rel="nofollow">4.2 主要代码</a></li><li><a href="#43__351" rel="nofollow">4.3 运行结果展示</a></li><li><a href="#44__408" rel="nofollow">4.4 关于可视化的设置</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_3"></a>一、倒立摆问题介绍</h2> 
<p><strong>Agent 必须在两个动作之间做出决定 - 向左或向右移动推车 - 以使连接到它的杆保持直立。</strong><br> <img src="https://images2.imgbox.com/15/6a/ceCxAlya_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Q_6"></a>二、深度Q网络简介</h2> 
<p><img src="https://images2.imgbox.com/7b/41/3jPSyTZo_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p><strong>上图所示为一般的深度 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           Q 
          
         
        
          \mathrm{Q} 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathrm">Q</span></span></span></span></span> 网络算法。</strong></p> 
</blockquote> 
<p>深度 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Q 
        
       
      
        \mathrm{Q} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathrm">Q</span></span></span></span></span> 网络算法是这样的，我们初始化两个网络 ：估计网络 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Q 
        
       
      
        Q 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span></span> 和 目标网络 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          Q 
         
        
          ^ 
         
        
       
         ， 
        
        
        
          Q 
         
        
          ^ 
         
        
       
      
        \hat{Q} ， \hat{Q} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1412em; vertical-align: -0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9468em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">Q</span></span><span class="" style="top: -3.2523em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span class=""></span></span></span></span></span><span class="mord cjk_fallback">，</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9468em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">Q</span></span><span class="" style="top: -3.2523em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span class=""></span></span></span></span></span></span></span></span></span> 就等于 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Q 
        
       
      
        Q 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span></span> ，<strong>一开始 目标网络 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           Q 
          
         
           ^ 
          
         
        
       
         \hat{Q} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1412em; vertical-align: -0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9468em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">Q</span></span><span class="" style="top: -3.2523em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span class=""></span></span></span></span></span></span></span></span></span> 与原来的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          Q 
         
        
       
         Q 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span></span> 网络是一样的</strong>。</p> 
<p>在每一个回合中，我们用演员与环境交互，在每一次交互的过程中，都会得到一个 状态 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          s 
         
        
          t 
         
        
       
      
        s_t 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> ，会采取某一个动作 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          a 
         
         
         
           t 
          
         
           。 
          
         
        
       
      
        a_{t 。} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord cjk_fallback mtight">。</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 怎么知道采取哪一个动作 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          a 
         
        
          t 
         
        
       
      
        a_t 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 呢? 我们就根据现在的 Q函数，但是要有探索的机制。比如 我们用玻尔兹曼探索或是 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ε 
        
       
      
        \varepsilon 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">ε</span></span></span></span></span>-贪心探索，接下来得到奖励 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          r 
         
        
          t 
         
        
       
      
        r_t 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> ，进入状态 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          s 
         
         
         
           t 
          
         
           + 
          
         
           1 
          
         
        
       
      
        s_{t+1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 。</p> 
<p>所以现在收集到一笔数据 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
        
        
          s 
         
        
          t 
         
        
       
         、 
        
        
        
          a 
         
        
          t 
         
        
       
         、 
        
        
        
          r 
         
        
          t 
         
        
       
         、 
        
        
        
          s 
         
         
         
           t 
          
         
           + 
          
         
           1 
          
         
        
       
         ) 
        
       
      
        \left(s_t 、 a_t 、 r_t 、 s_{t+1}\right) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span></span> ，我们将其放到回放缓冲区里面。如果回放缓冲区满了，我们就把一些旧的数据丢掉。</p> 
<p>接下来我们就从回放缓冲区里面去采样数据，采样到的是 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
        
        
          s 
         
        
          i 
         
        
       
         、 
        
        
        
          a 
         
        
          i 
         
        
       
         、 
        
        
        
          r 
         
        
          i 
         
        
       
         、 
        
        
        
          s 
         
         
         
           i 
          
         
           + 
          
         
           1 
          
         
        
       
         ) 
        
       
      
        \left(s_i 、 a_i 、 r_i 、 s_{i+1}\right) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span></span> 。这笔数据与刚放进去的不一定是同一笔，我们可能抽到旧的。要注意的是， <strong>我们采样出来不是一笔数据，采样出来的是一个批量的数据</strong>，采样一些经验出来。</p> 
<p>接下来就是计算目标。假设我们采样出 一笔数据，根据这笔数据去计算目标。目标要用目标网络 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          Q 
         
        
          ^ 
         
        
       
      
        \hat{Q} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1412em; vertical-align: -0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9468em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">Q</span></span><span class="" style="top: -3.2523em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span class=""></span></span></span></span></span></span></span></span></span> 来计算。目标是:<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          y 
         
        
          = 
         
         
         
           r 
          
         
           i 
          
         
        
          + 
         
         
          
          
            max 
           
          
            ⁡ 
           
          
         
           a 
          
         
         
         
           Q 
          
         
           ^ 
          
         
         
         
           ( 
          
          
          
            s 
           
           
           
             i 
            
           
             + 
            
           
             1 
            
           
          
         
           , 
          
         
           a 
          
         
           ) 
          
         
        
       
         y=r_i+\max _a \hat{Q}\left(s_{i+1}, a\right) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.6468em; vertical-align: -0.7em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.4306em;"><span class="" style="top: -2.4em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9468em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">Q</span></span><span class="" style="top: -3.2523em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">a</span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span></span></span><br> 其中， <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         a 
        
       
      
        a 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span></span> 是让 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          Q 
         
        
          ^ 
         
        
       
      
        \hat{Q} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1412em; vertical-align: -0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9468em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">Q</span></span><span class="" style="top: -3.2523em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span class=""></span></span></span></span></span></span></span></span></span> 值最大的动作。因为我们在状态 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          s 
         
         
         
           i 
          
         
           + 
          
         
           1 
          
         
        
       
      
        s_{i+1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 会采取的动作 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         a 
        
       
      
        a 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span></span> 就是可以让 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          Q 
         
        
          ^ 
         
        
       
      
        \hat{Q} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1412em; vertical-align: -0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9468em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">Q</span></span><span class="" style="top: -3.2523em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span class=""></span></span></span></span></span></span></span></span></span> 值最大的那一个动作。接下来我们要 更新 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Q 
        
       
      
        \mathrm{Q} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathrm">Q</span></span></span></span></span> 值，就把它当作一个回归问题。我们希望 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Q 
        
        
        
          ( 
         
         
         
           s 
          
         
           i 
          
         
        
          , 
         
         
         
           a 
          
         
           i 
          
         
        
          ) 
         
        
       
      
        Q\left(s_i, a_i\right) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span></span> 与目标越接近越好。</p> 
<p>假设已经更新了一定的次数，比如 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         C 
        
       
      
        C 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0715em;">C</span></span></span></span></span> 次， 设 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         C 
        
       
         = 
        
       
         100 
        
       
      
        C=100 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0715em;">C</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">100</span></span></span></span></span> ，那我们就把 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          Q 
         
        
          ^ 
         
        
       
      
        \hat{Q} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1412em; vertical-align: -0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9468em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">Q</span></span><span class="" style="top: -3.2523em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span class=""></span></span></span></span></span></span></span></span></span> 设成 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Q 
        
       
      
        Q 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span></span> ，这就是深度Q网络算法。</p> 
<h2><a id="_27"></a>三、详细资料</h2> 
<blockquote> 
 <p><strong>关于更加详细的深度Q网络的介绍，请看我之前发的博客：<a href="https://blog.csdn.net/weixin_51545953/article/details/127461022?spm=1001.2014.3001.5501">【EasyRL学习笔记】第六章 DQN 深度Q网络（基本概念）</a></strong></p> 
</blockquote> 
<blockquote> 
 <p><strong>在学习深度Q网络前你最好能了解以下知识点：</strong></p> 
 <ul><li><strong>全连接神经网络</strong></li><li><strong>神经网络求解分类问题</strong></li><li><strong>神经网络基本工作原理</strong></li><li><strong>Q-Learning算法</strong></li></ul> 
</blockquote> 
<h2><a id="Python_36"></a>四、Python代码实战</h2> 
<h3><a id="41__37"></a>4.1 运行前配置</h3> 
<blockquote> 
 <p><strong>准备好一个RL_Utils.py文件，文件内容可以从我的一篇里博客获取：<a href="https://blog.csdn.net/weixin_51545953/article/details/127427661?spm=1001.2014.3001.5501">【RL工具类】强化学习常用函数工具类（Python代码）</a></strong></p> 
</blockquote> 
<blockquote> 
 <p><strong>这一步很重要，后面需要引入该RL_Utils.py文件</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/29/ce/MKI0MJL1_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="42__43"></a>4.2 主要代码</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> argparse
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> time
<span class="token keyword">import</span> math
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">import</span> gym
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn

<span class="token comment"># 这里需要改成自己的RL_Utils.py文件的路径</span>
<span class="token keyword">from</span> Python<span class="token punctuation">.</span>ReinforcementLearning<span class="token punctuation">.</span>EasyRL<span class="token punctuation">.</span>RL_Utils <span class="token keyword">import</span> <span class="token operator">*</span>


<span class="token comment"># Q网络（3层全连接网络）</span>
<span class="token keyword">class</span> <span class="token class-name">MLP</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span> output_dim<span class="token punctuation">,</span> hidden_dim<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 初始化q网络，为全连接网络
            input_dim: 输入的特征数即环境的状态维度
            output_dim: 输出的动作维度
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MLP<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>  <span class="token comment"># 输入层</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>  <span class="token comment"># 隐藏层</span>
        self<span class="token punctuation">.</span>fc3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> output_dim<span class="token punctuation">)</span>  <span class="token comment"># 输出层</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 各层对应的激活函数</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>fc3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>


<span class="token comment"># 经验回放缓存区</span>
<span class="token keyword">class</span> <span class="token class-name">ReplayBuffer</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity  <span class="token comment"># 经验回放的容量</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 缓冲区</span>
        self<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">push</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_state<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 缓冲区是一个队列，容量超出时去掉开始存入的转移(transition)
        '''</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>capacity<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>position<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_state<span class="token punctuation">,</span> done<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>position <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>capacity

    <span class="token keyword">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>  <span class="token comment"># 随机采出小批量转移</span>
        state<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_state<span class="token punctuation">,</span> done <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>batch<span class="token punctuation">)</span>  <span class="token comment"># 解压成状态，动作等</span>
        <span class="token keyword">return</span> state<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_state<span class="token punctuation">,</span> done

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' 返回当前存储的量
        '''</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>


<span class="token comment"># DQN智能体对象</span>
<span class="token keyword">class</span> <span class="token class-name">DQN</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> memory<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>

        self<span class="token punctuation">.</span>n_actions <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'n_actions'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span>cfg<span class="token punctuation">[</span><span class="token string">'device'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'gamma'</span><span class="token punctuation">]</span>
        <span class="token comment">## e-greedy 探索策略参数</span>
        self<span class="token punctuation">.</span>sample_count <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 采样次数</span>
        self<span class="token punctuation">.</span>epsilon <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'epsilon_start'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>sample_count <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>epsilon_start <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'epsilon_start'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>epsilon_end <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'epsilon_end'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>epsilon_decay <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'epsilon_decay'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>batch_size <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'batch_size'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>policy_net <span class="token operator">=</span> model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>target_net <span class="token operator">=</span> model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        <span class="token comment"># 初始化的时候，目标Q网络和估计Q网络相等，将策略网络的参数复制给目标网络</span>
        self<span class="token punctuation">.</span>target_net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>policy_net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>policy_net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>cfg<span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>memory <span class="token operator">=</span> memory
        self<span class="token punctuation">.</span>update_flag <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token comment"># 训练过程采样：e-greedy policy</span>
    <span class="token keyword">def</span> <span class="token function">sample_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>sample_count <span class="token operator">+=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>epsilon <span class="token operator">=</span> self<span class="token punctuation">.</span>epsilon_end <span class="token operator">+</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>epsilon_start <span class="token operator">-</span> self<span class="token punctuation">.</span>epsilon_end<span class="token punctuation">)</span> <span class="token operator">*</span> \
                       math<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>sample_count <span class="token operator">/</span> self<span class="token punctuation">.</span>epsilon_decay<span class="token punctuation">)</span>
        <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>epsilon<span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>predict_action<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_actions<span class="token punctuation">)</span>
        <span class="token keyword">return</span> action

    <span class="token comment"># 测试过程：以最大Q值选取动作</span>
    <span class="token keyword">def</span> <span class="token function">predict_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            state <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>state<span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            q_values <span class="token operator">=</span> self<span class="token punctuation">.</span>policy_net<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            action <span class="token operator">=</span> q_values<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> action

    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 当经验缓存区没有满的时候，不进行更新</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>memory<span class="token punctuation">)</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>batch_size<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>update_flag<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Begin to update!"</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>update_flag <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token comment"># 从经验缓存区随机取出一个batch的数据</span>
        state_batch<span class="token punctuation">,</span> action_batch<span class="token punctuation">,</span> reward_batch<span class="token punctuation">,</span> next_state_batch<span class="token punctuation">,</span> done_batch <span class="token operator">=</span> self<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span>
        <span class="token comment"># 将数据转化成Tensor格式</span>
        state_batch <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>state_batch<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">,</span>
                                   dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>  <span class="token comment"># shape(batchsize,n_states)</span>
        action_batch <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>action_batch<span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># shape(batchsize,1)</span>
        reward_batch <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>reward_batch<span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>
            <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># shape(batchsize,1)</span>
        next_state_batch <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>next_state_batch<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">,</span>
                                        dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>  <span class="token comment"># shape(batchsize,n_states)</span>
        done_batch <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span>done_batch<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># shape(batchsize,1)</span>
        <span class="token comment"># 计算Q估计</span>
        q_value_batch <span class="token operator">=</span> self<span class="token punctuation">.</span>policy_net<span class="token punctuation">(</span>state_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>gather<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                                                            index<span class="token operator">=</span>action_batch<span class="token punctuation">)</span>  <span class="token comment"># shape(batchsize,1),requires_grad=True</span>
        next_max_q_value_batch <span class="token operator">=</span> self<span class="token punctuation">.</span>target_net<span class="token punctuation">(</span>next_state_batch<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 计算Q现实</span>
        expected_q_value_batch <span class="token operator">=</span> reward_batch <span class="token operator">+</span> self<span class="token punctuation">.</span>gamma <span class="token operator">*</span> next_max_q_value_batch <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> done_batch<span class="token punctuation">)</span>
        <span class="token comment"># 计算损失函数MSE（Q估计，Q现实）</span>
        loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>q_value_batch<span class="token punctuation">,</span> expected_q_value_batch<span class="token punctuation">)</span>
        <span class="token comment"># 梯度下降</span>
        self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 限制梯度的范围，以避免梯度爆炸</span>
        <span class="token keyword">for</span> param <span class="token keyword">in</span> self<span class="token punctuation">.</span>policy_net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            param<span class="token punctuation">.</span>grad<span class="token punctuation">.</span>data<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">save_model</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>target_net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>path<span class="token punctuation">}</span></span><span class="token string">/checkpoint.pt"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">load_model</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>target_net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>path<span class="token punctuation">}</span></span><span class="token string">/checkpoint.pt"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> target_param<span class="token punctuation">,</span> param <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>target_net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>policy_net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            param<span class="token punctuation">.</span>data<span class="token punctuation">.</span>copy_<span class="token punctuation">(</span>target_param<span class="token punctuation">.</span>data<span class="token punctuation">)</span>


<span class="token comment"># 训练函数</span>
<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>arg_dict<span class="token punctuation">,</span> env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 开始计时</span>
    startTime <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"环境名: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>arg_dict<span class="token punctuation">[</span><span class="token string">'env_name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">, 算法名: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>arg_dict<span class="token punctuation">[</span><span class="token string">'algo_name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">, Device: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>arg_dict<span class="token punctuation">[</span><span class="token string">'device'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始训练智能体......"</span><span class="token punctuation">)</span>
    rewards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    steps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i_ep <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>arg_dict<span class="token punctuation">[</span><span class="token string">"train_eps"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ep_reward <span class="token operator">=</span> <span class="token number">0</span>
        ep_step <span class="token operator">=</span> <span class="token number">0</span>
        state <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>arg_dict<span class="token punctuation">[</span><span class="token string">'ep_max_steps'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 画图</span>
            <span class="token keyword">if</span> arg_dict<span class="token punctuation">[</span><span class="token string">'train_render'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
            ep_step <span class="token operator">+=</span> <span class="token number">1</span>
            action <span class="token operator">=</span> agent<span class="token punctuation">.</span>sample_action<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            next_state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            agent<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>push<span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span>
                              next_state<span class="token punctuation">,</span> done<span class="token punctuation">)</span>
            state <span class="token operator">=</span> next_state
            agent<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>
            ep_reward <span class="token operator">+=</span> reward
            <span class="token keyword">if</span> done<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        <span class="token comment"># 目标网络更新</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i_ep <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> arg_dict<span class="token punctuation">[</span><span class="token string">"target_update"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            agent<span class="token punctuation">.</span>target_net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>agent<span class="token punctuation">.</span>policy_net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        steps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ep_step<span class="token punctuation">)</span>
        rewards<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ep_reward<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i_ep <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Episode: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i_ep <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>arg_dict<span class="token punctuation">[</span><span class="token string">"train_eps"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">, Reward: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ep_reward<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">: Epislon: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>agent<span class="token punctuation">.</span>epsilon<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'训练结束 , 用时: '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" s"</span><span class="token punctuation">)</span>
    <span class="token comment"># 关闭环境</span>
    env<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">'episodes'</span><span class="token punctuation">:</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>rewards<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'rewards'</span><span class="token punctuation">:</span> rewards<span class="token punctuation">}</span>


<span class="token comment"># 测试函数</span>
<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>arg_dict<span class="token punctuation">,</span> env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    startTime <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始测试智能体......"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"环境名: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>arg_dict<span class="token punctuation">[</span><span class="token string">'env_name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">, 算法名: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>arg_dict<span class="token punctuation">[</span><span class="token string">'algo_name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">, Device: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>arg_dict<span class="token punctuation">[</span><span class="token string">'device'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    rewards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    steps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i_ep <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>arg_dict<span class="token punctuation">[</span><span class="token string">'test_eps'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ep_reward <span class="token operator">=</span> <span class="token number">0</span>
        ep_step <span class="token operator">=</span> <span class="token number">0</span>
        state <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>arg_dict<span class="token punctuation">[</span><span class="token string">'ep_max_steps'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 画图</span>
            <span class="token keyword">if</span> arg_dict<span class="token punctuation">[</span><span class="token string">'test_render'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
            ep_step <span class="token operator">+=</span> <span class="token number">1</span>
            action <span class="token operator">=</span> agent<span class="token punctuation">.</span>predict_action<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            next_state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            state <span class="token operator">=</span> next_state
            ep_reward <span class="token operator">+=</span> reward
            <span class="token keyword">if</span> done<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        steps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ep_step<span class="token punctuation">)</span>
        rewards<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ep_reward<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Episode: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i_ep <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>arg_dict<span class="token punctuation">[</span><span class="token string">'test_eps'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">，Reward: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ep_reward<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"测试结束 , 用时: "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" s"</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">'episodes'</span><span class="token punctuation">:</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>rewards<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'rewards'</span><span class="token punctuation">:</span> rewards<span class="token punctuation">}</span>


<span class="token comment"># 创建环境和智能体</span>
<span class="token keyword">def</span> <span class="token function">create_env_agent</span><span class="token punctuation">(</span>arg_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建环境</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span>arg_dict<span class="token punctuation">[</span><span class="token string">'env_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># 设置随机种子</span>
    all_seed<span class="token punctuation">(</span>env<span class="token punctuation">,</span> seed<span class="token operator">=</span>arg_dict<span class="token punctuation">[</span><span class="token string">"seed"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># 获取状态数</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        n_states <span class="token operator">=</span> env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>n
    <span class="token keyword">except</span> AttributeError<span class="token punctuation">:</span>
        n_states <span class="token operator">=</span> env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 获取动作数</span>
    n_actions <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>n
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"状态数: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>n_states<span class="token punctuation">}</span></span><span class="token string">, 动作数: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>n_actions<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token comment"># 将状态数和动作数加入算法参数字典</span>
    arg_dict<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"n_states"</span><span class="token punctuation">:</span> n_states<span class="token punctuation">,</span> <span class="token string">"n_actions"</span><span class="token punctuation">:</span> n_actions<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment"># 实例化智能体对象</span>
    <span class="token comment"># Q网络模型</span>
    model <span class="token operator">=</span> MLP<span class="token punctuation">(</span>n_states<span class="token punctuation">,</span> n_actions<span class="token punctuation">,</span> hidden_dim<span class="token operator">=</span>arg_dict<span class="token punctuation">[</span><span class="token string">"hidden_dim"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># 回放缓存区对象</span>
    memory <span class="token operator">=</span> ReplayBuffer<span class="token punctuation">(</span>arg_dict<span class="token punctuation">[</span><span class="token string">"memory_capacity"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># 智能体</span>
    agent <span class="token operator">=</span> DQN<span class="token punctuation">(</span>model<span class="token punctuation">,</span> memory<span class="token punctuation">,</span> arg_dict<span class="token punctuation">)</span>
    <span class="token comment"># 返回环境，智能体</span>
    <span class="token keyword">return</span> env<span class="token punctuation">,</span> agent


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 防止报错 OMP: Error #15: Initializing libiomp5md.dll, but found libiomp5md.dll already initialized.</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"KMP_DUPLICATE_LIB_OK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"TRUE"</span>
    <span class="token comment"># 获取当前路径</span>
    curr_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 获取当前时间</span>
    curr_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y_%m_%d-%H_%M_%S"</span><span class="token punctuation">)</span>
    <span class="token comment"># 相关参数设置</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"hyper parameters"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--algo_name'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'DQN'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"name of algorithm"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--env_name'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'CartPole-v0'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"name of environment"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--train_eps'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"episodes of training"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--test_eps'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"episodes of testing"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--ep_max_steps'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"steps per episode, much larger value can simulate infinite steps"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--gamma'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"discounted factor"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--epsilon_start'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"initial value of epsilon"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--epsilon_end'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"final value of epsilon"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--epsilon_decay'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"decay rate of epsilon, the higher value, the slower decay"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--lr'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"learning rate"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--memory_capacity'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"memory capacity"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--batch_size'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--target_update'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--hidden_dim'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--device'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"cpu or cuda"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--seed'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">520</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"seed"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--show_fig'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"if show figure or not"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--save_fig'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"if save figure or not"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--train_render'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">bool</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Whether to render the environment during training"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--test_render'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">bool</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Whether to render the environment during testing"</span><span class="token punctuation">)</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    default_args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'result_path'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>curr_path<span class="token punctuation">}</span></span><span class="token string">/outputs/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>args<span class="token punctuation">.</span>env_name<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>curr_time<span class="token punctuation">}</span></span><span class="token string">/results/"</span></span><span class="token punctuation">,</span>
                    <span class="token string">'model_path'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>curr_path<span class="token punctuation">}</span></span><span class="token string">/outputs/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>args<span class="token punctuation">.</span>env_name<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>curr_time<span class="token punctuation">}</span></span><span class="token string">/models/"</span></span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span>
    <span class="token comment"># 将参数转化为字典 type(dict)</span>
    arg_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">**</span><span class="token builtin">vars</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">**</span>default_args<span class="token punctuation">}</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"算法参数字典:"</span><span class="token punctuation">,</span> arg_dict<span class="token punctuation">)</span>

    <span class="token comment"># 创建环境和智能体</span>
    env<span class="token punctuation">,</span> agent <span class="token operator">=</span> create_env_agent<span class="token punctuation">(</span>arg_dict<span class="token punctuation">)</span>
    <span class="token comment"># 传入算法参数、环境、智能体，然后开始训练</span>
    res_dic <span class="token operator">=</span> train<span class="token punctuation">(</span>arg_dict<span class="token punctuation">,</span> env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"算法返回结果字典:"</span><span class="token punctuation">,</span> res_dic<span class="token punctuation">)</span>
    <span class="token comment"># 保存相关信息</span>
    agent<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span>path<span class="token operator">=</span>arg_dict<span class="token punctuation">[</span><span class="token string">'model_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    save_args<span class="token punctuation">(</span>arg_dict<span class="token punctuation">,</span> path<span class="token operator">=</span>arg_dict<span class="token punctuation">[</span><span class="token string">'result_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    save_results<span class="token punctuation">(</span>res_dic<span class="token punctuation">,</span> tag<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">,</span> path<span class="token operator">=</span>arg_dict<span class="token punctuation">[</span><span class="token string">'result_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plot_rewards<span class="token punctuation">(</span>res_dic<span class="token punctuation">[</span><span class="token string">'rewards'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arg_dict<span class="token punctuation">,</span> path<span class="token operator">=</span>arg_dict<span class="token punctuation">[</span><span class="token string">'result_path'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tag<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">)</span>

    <span class="token comment"># =================================================================================================</span>
    <span class="token comment"># 创建新环境和智能体用来测试</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">300</span><span class="token punctuation">)</span>
    env<span class="token punctuation">,</span> agent <span class="token operator">=</span> create_env_agent<span class="token punctuation">(</span>arg_dict<span class="token punctuation">)</span>
    <span class="token comment"># 加载已保存的智能体</span>
    agent<span class="token punctuation">.</span>load_model<span class="token punctuation">(</span>path<span class="token operator">=</span>arg_dict<span class="token punctuation">[</span><span class="token string">'model_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    res_dic <span class="token operator">=</span> test<span class="token punctuation">(</span>arg_dict<span class="token punctuation">,</span> env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span>
    save_results<span class="token punctuation">(</span>res_dic<span class="token punctuation">,</span> tag<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">,</span> path<span class="token operator">=</span>arg_dict<span class="token punctuation">[</span><span class="token string">'result_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plot_rewards<span class="token punctuation">(</span>res_dic<span class="token punctuation">[</span><span class="token string">'rewards'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arg_dict<span class="token punctuation">,</span> path<span class="token operator">=</span>arg_dict<span class="token punctuation">[</span><span class="token string">'result_path'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tag<span class="token operator">=</span><span class="token string">"test"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="43__351"></a>4.3 运行结果展示</h3> 
<blockquote> 
 <p><strong>由于有些输出太长，下面仅展示部分输出</strong></p> 
</blockquote> 
<pre><code class="prism language-python">状态数<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> 动作数<span class="token punctuation">:</span> <span class="token number">2</span>
环境名<span class="token punctuation">:</span> CartPole<span class="token operator">-</span>v0<span class="token punctuation">,</span> 算法名<span class="token punctuation">:</span> DQN<span class="token punctuation">,</span> Device<span class="token punctuation">:</span> cpu
开始训练智能体<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Begin to update!
Episode<span class="token punctuation">:</span> <span class="token number">10</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">16.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.649</span>
Episode<span class="token punctuation">:</span> <span class="token number">20</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">12.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.473</span>
Episode<span class="token punctuation">:</span> <span class="token number">30</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">10.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.358</span>
Episode<span class="token punctuation">:</span> <span class="token number">40</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">17.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.272</span>
Episode<span class="token punctuation">:</span> <span class="token number">50</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">18.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.212</span>
Episode<span class="token punctuation">:</span> <span class="token number">60</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">139.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.049</span>
Episode<span class="token punctuation">:</span> <span class="token number">70</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">200.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.011</span>
Episode<span class="token punctuation">:</span> <span class="token number">80</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">200.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">90</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">200.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">100</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">200.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">110</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">200.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">120</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">200.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">130</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">169.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">140</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">200.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">150</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">179.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">160</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">200.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">170</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">170.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">180</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">200.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">190</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">200.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
Episode<span class="token punctuation">:</span> <span class="token number">200</span><span class="token operator">/</span><span class="token number">200</span><span class="token punctuation">,</span> Reward<span class="token punctuation">:</span> <span class="token number">165.00</span><span class="token punctuation">:</span> Epislon<span class="token punctuation">:</span> <span class="token number">0.010</span>
训练结束 <span class="token punctuation">,</span> 用时<span class="token punctuation">:</span> <span class="token number">100.28473830223083</span> s
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
状态数<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> 动作数<span class="token punctuation">:</span> <span class="token number">2</span>
开始测试智能体<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
环境名<span class="token punctuation">:</span> CartPole<span class="token operator">-</span>v0<span class="token punctuation">,</span> 算法名<span class="token punctuation">:</span> DQN<span class="token punctuation">,</span> Device<span class="token punctuation">:</span> cpu
Episode<span class="token punctuation">:</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">2</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">3</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">4</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">5</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">6</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">7</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">8</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">9</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">10</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">11</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">12</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">198.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">13</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">14</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">15</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">16</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">18</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">179.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">19</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
Episode<span class="token punctuation">:</span> <span class="token number">20</span><span class="token operator">/</span><span class="token number">20</span>，Reward<span class="token punctuation">:</span> <span class="token number">200.00</span>
测试结束 <span class="token punctuation">,</span> 用时<span class="token punctuation">:</span> <span class="token number">30.37125039100647</span> s
</code></pre> 
<p><img src="https://images2.imgbox.com/c1/75/5orC2DFD_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/77/57/E0bivrRz_o.gif" alt="在这里插入图片描述"></p> 
<h3><a id="44__408"></a>4.4 关于可视化的设置</h3> 
<blockquote> 
 <p><strong>如果你觉得可视化比较耗时，你可以进行设置，取消可视化。<br> 或者你想看看训练过程的可视化，也可以进行相关设置</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/0b/6e/k7OvJrbe_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/abab942072e157a42748aae3934e89c4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Mybatis-Plus】Mybatis-Plus的入门运用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2ffd0a138ce59a3e9efd74f02f8c9045/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">宿主机无法访问docker内flask服务</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>