<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ã€Sa-Tokenã€‘SpringBoot æ•´åˆ Sa-Token å¿«é€Ÿå®ç° API æ¥å£ç­¾åå®‰å…¨æ ¡éªŒ - ç¼–ç¨‹ä¸­å›½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ã€Sa-Tokenã€‘SpringBoot æ•´åˆ Sa-Token å¿«é€Ÿå®ç° API æ¥å£ç­¾åå®‰å…¨æ ¡éªŒ" />
<meta property="og:description" content="åœ¨æ¶‰åŠè·¨ç³»ç»Ÿæ¥å£è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å®¹æ˜“ç¢°åˆ°ä»¥ä¸‹å®‰å…¨é—®é¢˜ï¼š
è¯·æ±‚èº«ä»½è¢«ä¼ªé€ è¯·æ±‚å‚æ•°è¢«ç¯¡æ”¹è¯·æ±‚è¢«æŠ“åŒ…ï¼Œç„¶åé‡æ”¾æ”»å‡» sa-token api-sign æ¨¡å—å°†å¸®ä½ è½»æ¾è§£å†³ä»¥ä¸Šéš¾é¢˜ã€‚ï¼ˆæ­¤æ’ä»¶æ˜¯å†…åµŒåˆ° sa-token-core
æ ¸å¿ƒåŒ…ä¸­çš„æ¨¡å—ï¼Œå¼€å‘è€…æ— éœ€å†æ¬¡å¼•å…¥å…¶å®ƒä¾èµ–ï¼Œæ’ä»¶ç›´æ¥å¯ç”¨ï¼‰
å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹ä¸šåŠ¡éœ€æ±‚ï¼š
ç”¨æˆ·åœ¨ A ç³»ç»Ÿå‚ä¸æ´»åŠ¨æˆåŠŸåï¼Œæ´»åŠ¨å¥–åŠ±ä»¥ä½™é¢çš„å½¢å¼ä¸‹å‘åˆ° B ç³»ç»Ÿã€‚
1. åˆå§‹æ–¹æ¡ˆï¼šç›´æ¥è£¸å¥” åœ¨ä¸è€ƒè™‘å®‰å…¨é—®é¢˜çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å®Œæˆè¿™ä¸ªéœ€æ±‚ï¼š
1ã€åœ¨ B ç³»ç»Ÿå¼€æ”¾ä¸€ä¸ªæ¥å£
@RestController @RequestMapping(&#34;/sign&#34;) public class SignController { @PostMapping(&#34;/addMoney&#34;) public String addMoney(Long userId, Long money) { // TODO å¤„ç†ä¸šåŠ¡... return &#34;ADD SUCCESS&#34;; } } 2ã€åœ¨ A ç³»ç»Ÿä½¿ç”¨ http å·¥å…·ç±»è°ƒç”¨è¿™ä¸ªæ¥å£
@RestController @RequestMapping(&#34;/activity&#34;) public class ActivityController { @PostMapping(&#34;/join&#34;) public String join() { // å‚åŠ å®Œæ´»åŠ¨åï¼Œå‘é€ä½™é¢ Long userId = 1L; Long money = 100L; Map&lt;String, Object&gt; params = new HashMap&lt;&gt;(); params." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/473720ef599066ef03a25c7f33f5be01/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-31T11:00:00+08:00" />
<meta property="article:modified_time" content="2024-01-31T11:00:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹ä¸­å›½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹ä¸­å›½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ã€Sa-Tokenã€‘SpringBoot æ•´åˆ Sa-Token å¿«é€Ÿå®ç° API æ¥å£ç­¾åå®‰å…¨æ ¡éªŒ</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>åœ¨æ¶‰åŠè·¨ç³»ç»Ÿæ¥å£è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å®¹æ˜“ç¢°åˆ°ä»¥ä¸‹å®‰å…¨é—®é¢˜ï¼š</p> 
<ul><li>è¯·æ±‚èº«ä»½è¢«ä¼ªé€ </li><li>è¯·æ±‚å‚æ•°è¢«ç¯¡æ”¹</li><li>è¯·æ±‚è¢«æŠ“åŒ…ï¼Œç„¶åé‡æ”¾æ”»å‡»</li></ul> 
<p><code>sa-token api-sign</code> æ¨¡å—å°†å¸®ä½ è½»æ¾è§£å†³ä»¥ä¸Šéš¾é¢˜ã€‚ï¼ˆæ­¤æ’ä»¶æ˜¯å†…åµŒåˆ° sa-token-core<br> æ ¸å¿ƒåŒ…ä¸­çš„æ¨¡å—ï¼Œå¼€å‘è€…æ— éœ€å†æ¬¡å¼•å…¥å…¶å®ƒä¾èµ–ï¼Œæ’ä»¶ç›´æ¥å¯ç”¨ï¼‰</p> 
<p>å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹ä¸šåŠ¡éœ€æ±‚ï¼š</p> 
<blockquote> 
 <p>ç”¨æˆ·åœ¨ A ç³»ç»Ÿå‚ä¸æ´»åŠ¨æˆåŠŸåï¼Œæ´»åŠ¨å¥–åŠ±ä»¥ä½™é¢çš„å½¢å¼ä¸‹å‘åˆ° B ç³»ç»Ÿã€‚</p> 
</blockquote> 
<h3><a id="1__13"></a>1. åˆå§‹æ–¹æ¡ˆï¼šç›´æ¥è£¸å¥”</h3> 
<p>åœ¨ä¸è€ƒè™‘å®‰å…¨é—®é¢˜çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å®Œæˆè¿™ä¸ªéœ€æ±‚ï¼š</p> 
<p>1ã€åœ¨ B ç³»ç»Ÿå¼€æ”¾ä¸€ä¸ªæ¥å£</p> 
<pre><code>@RestController
@RequestMapping("/sign")
public class SignController {

    @PostMapping("/addMoney")
    public String addMoney(Long userId, Long money) {
        // TODO å¤„ç†ä¸šåŠ¡...

        return "ADD SUCCESS";
    }

}
</code></pre> 
<p>2ã€åœ¨ A ç³»ç»Ÿä½¿ç”¨ http å·¥å…·ç±»è°ƒç”¨è¿™ä¸ªæ¥å£</p> 
<pre><code>@RestController
@RequestMapping("/activity")
public class ActivityController {

    @PostMapping("/join")
    public String join() {
        
        // å‚åŠ å®Œæ´»åŠ¨åï¼Œå‘é€ä½™é¢
        Long userId = 1L;
        Long money = 100L;
        Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();
        params.put("userId", userId);
        params.put("money", money);
        String url = "http://localhost:8079/sign/addMoney";
        String result = HttpUtil.post(url, params);
        return "join";
    }

}
</code></pre> 
<p>ä¸Šè¿°ä»£ç ç®€å•çš„å®Œæˆäº†éœ€æ±‚ï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾å®ƒæœ‰ä¸€ä¸ªå®‰å…¨é—®é¢˜ï¼š<br> B ç³»ç»Ÿå¼€æ”¾çš„æ¥å£ä¸ä»…å¯ä»¥è¢« A ç³»ç»Ÿè°ƒç”¨ï¼Œè¿˜å¯ä»¥è¢«å…¶å®ƒä»»ä½•äººè°ƒç”¨ï¼Œç”šè‡³åˆ«äººå¯ä»¥æœ¬åœ°è·‘ä¸€ä¸ª for å¾ªç¯è°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œä¸ºè‡ªå·±æ— é™å……å€¼é‡‘é¢</p> 
<h3><a id="2__secretKey__63"></a>2. æ–¹æ¡ˆå‡çº§ï¼šå¢åŠ  secretKey æ ¡éªŒ</h3> 
<p>ä¸ºé˜²æ­¢ B ç³»ç»Ÿå¼€æ”¾çš„æ¥å£è¢«é™Œç”Ÿäººä»»æ„è°ƒç”¨ï¼Œæˆ‘ä»¬å¢åŠ ä¸€ä¸ª secretKey å‚æ•°</p> 
<pre><code>@PostMapping("/addMoney")
public String addMoney(Long userId, Long money, String secretKey) {
    // æ ¡éªŒ secretKey
    if (!check(secretKey)) {
        throw new RuntimeException("æ— æ•ˆ secretKeyï¼Œæ— æ³•å“åº”è¯·æ±‚");
    }
    // TODO å¤„ç†ä¸šåŠ¡...

    return "ADD SUCCESS";
}
</code></pre> 
<p>ç”±äº A ç³»ç»Ÿæ˜¯æˆ‘ä»¬ â€œè‡ªå·±äººâ€ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ‹¿ç€ secretKey è¿›è¡Œåˆæ³•è¯·æ±‚ï¼š</p> 
<pre><code>@PostMapping("/join")
public String join() {
    // å‚åŠ å®Œæ´»åŠ¨åï¼Œå‘é€ä½™é¢
    Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();
    params.put("userId", userId);
    params.put("money", money);
    params.put("secretKey", "Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—");
    String url = "http://localhost:8079/sign/addMoney";
    String result = HttpUtil.post(url, params);
    return "join";
}
</code></pre> 
<p>ç°åœ¨ï¼Œå³ä½¿ B ç³»ç»Ÿçš„æ¥å£è¢«æš´éœ²äº†ï¼Œä¹Ÿä¸ä¼šè¢«é™Œç”Ÿäººä»»æ„è°ƒç”¨äº†ï¼Œå®‰å…¨æ€§å¾—åˆ°äº†ä¸€å®šçš„ä¿è¯ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p> 
<ol><li>å¦‚æœè¯·æ±‚è¢«æŠ“åŒ…ï¼ŒsecretKey å°±ä¼šæ³„éœ²ï¼Œå› ä¸ºæ¯æ¬¡è¯·æ±‚éƒ½åœ¨ url ä¸­æ˜æ–‡ä¼ è¾“äº† secretKey å‚æ•°ã€‚</li><li>å¦‚æœè¯·æ±‚è¢«æŠ“åŒ…ï¼Œè¯·æ±‚çš„å…¶å®ƒå‚æ•°å°±å¯ä»¥è¢«ä»»æ„ä¿®æ”¹ï¼Œä¾‹å¦‚å¯ä»¥å°† money å‚æ•°ä¿®æ”¹ä¸º 9999999ï¼ŒBç³»ç»Ÿæ— æ³•ç¡®å®šå‚æ•°æ˜¯å¦è¢«ä¿®æ”¹è¿‡ã€‚</li></ol> 
<h3><a id="3_103"></a>3.æ–¹æ¡ˆå†å‡çº§ï¼šä½¿ç”¨æ‘˜è¦ç®—æ³•ç”Ÿæˆå‚æ•°ç­¾å</h3> 
<p>é¦–å…ˆï¼Œåœ¨ A ç³»ç»Ÿä¸è¦ç›´æ¥å‘èµ·è¯·æ±‚ï¼Œè€Œæ˜¯å…ˆè®¡ç®—ä¸€ä¸ª sign å‚æ•°ï¼š</p> 
<pre><code>@PostMapping("/join")
public String join() {
    // å‚åŠ å®Œæ´»åŠ¨åï¼Œå‘é€ä½™é¢
    Long userId = 1L;
    Long money = 100L;
    String secretKey = "Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—";
    // è®¡ç®— sign
    String sign = md5("money=" + money + "&amp;userId=" + userId + "&amp;key=" + secretKey);
    Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();
    params.put("userId", userId);
    params.put("money", money);
    params.put("sign", sign);
    String url = "http://localhost:8079/sign/addMoney";
    String result = HttpUtil.post(url, params);
    return "join";
}
</code></pre> 
<p>æ³¨æ„ï¼šæ­¤å¤„è®¡ç®—ç­¾åæ—¶ï¼Œéœ€è¦å°†æ‰€æœ‰å‚æ•°æŒ‰ç…§å­—å…¸é¡ºåºä¾æ¬¡æ’åˆ—ï¼ˆkeyé™¤å¤–ï¼ŒæŒ‚åœ¨æœ€åé¢ï¼‰</p> 
<p>ç„¶ååœ¨ B ç³»ç»Ÿæ¥æ”¶è¯·æ±‚æ—¶ï¼Œä½¿ç”¨åŒæ ·çš„ç®—æ³•ã€åŒæ ·çš„ç§˜é’¥ï¼Œç”Ÿæˆ sign å­—ç¬¦ä¸²ï¼Œä¸å‚æ•°ä¸­ sign å€¼è¿›è¡Œæ¯”è¾ƒï¼š</p> 
<pre><code>@PostMapping("/addMoney")
public String addMoney(Long userId, Long money, String sign) {
    // åœ¨ B ç³»ç»Ÿï¼Œä½¿ç”¨åŒæ ·çš„ç®—æ³•ã€åŒæ ·çš„å¯†é’¥ï¼Œè®¡ç®—å‡º sign2ï¼Œä¸ä¼ å…¥çš„ sign è¿›è¡Œæ¯”å¯¹
    String sign2 = md5("money=" + money + "&amp;userId=" + userId + "&amp;key=" + secretKey);
    if (!sign2.equals(sign)) {
        return "æ— æ•ˆ signï¼Œæ— æ³•å“åº”è¯·æ±‚";
    }
    // TODO å¤„ç†ä¸šåŠ¡...

    return "ADD SUCCESS";
}
</code></pre> 
<p>å› ä¸º sign çš„å€¼æ˜¯ç”± userIdã€moneyã€secretKey ä¸‰ä¸ªå‚æ•°å…±åŒå†³å®šçš„ï¼Œæ‰€ä»¥åªè¦æœ‰ä¸€ä¸ªå‚æ•°ä¸ä¸€è‡´ï¼Œå°±ä¼šé€ æˆæœ€ç»ˆç”Ÿæˆ sign<br> ä¹Ÿæ˜¯ä¸ä¸€è‡´çš„ï¼Œæ‰€ä»¥ï¼Œæ ¹æ®æ¯”å¯¹ç»“æœï¼š</p> 
<ul><li>å¦‚æœ sign ä¸€è‡´ï¼Œè¯´æ˜è¿™æ˜¯ä¸ªåˆæ³•è¯·æ±‚ã€‚</li><li>å¦‚æœ sign ä¸ä¸€è‡´ï¼Œè¯´æ˜å‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯ç§˜é’¥ä¸æ­£ç¡®ï¼Œæˆ–è€…è¯·æ±‚å‚æ•°è¢«ç¯¡æ”¹è¿‡ï¼Œæ˜¯ä¸ªä¸åˆæ³•è¯·æ±‚ã€‚</li></ul> 
<p>æ­¤æ–¹æ¡ˆä¼˜ç‚¹ï¼š</p> 
<ul><li>ä¸åœ¨ url ä¸­ç›´æ¥ä¼ é€’ secretKey å‚æ•°äº†ï¼Œé¿å…äº†æ³„éœ²é£é™©ã€‚</li><li>ç”±äº sign å‚æ•°çš„é™åˆ¶ï¼Œè¯·æ±‚ä¸­çš„å‚æ•°ä¹Ÿä¸å¯è¢«ç¯¡æ”¹ï¼ŒB ç³»ç»Ÿå¯æ”¾å¿ƒçš„ä½¿ç”¨è¿™äº›å‚æ•°ã€‚</li></ul> 
<p>æ­¤æ–¹æ¡ˆä»ç„¶å­˜åœ¨ä»¥ä¸‹ç¼ºé™·ï¼š</p> 
<ul><li> <p>è¢«æŠ“åŒ…åï¼Œè¯·æ±‚å¯ä»¥è¢«æ— é™é‡æ”¾ï¼ŒB ç³»ç»Ÿæ— æ³•åˆ¤æ–­è¯·æ±‚æ˜¯çœŸæ­£æ¥è‡ªäº A ç³»ç»Ÿå‘å‡ºçš„ï¼Œè¿˜æ˜¯è¢«æŠ“åŒ…åé‡æ”¾çš„ã€‚</p> <p>@PostMapping(â€œ/joinâ€)<br> public String join() {<!-- --><br> // å‚åŠ å®Œæ´»åŠ¨åï¼Œå‘é€ä½™é¢<br> Long userId = 1L;<br> Long money = 100L;<br> String nonce = SaFoxUtil.getRandomString(32); // éšæœº32ä½å­—ç¬¦ä¸²<br> String secretKey = â€œÃ—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—â€;<br> // è®¡ç®— sign<br> String sign = md5(â€œmoney=â€ + money + â€œ&amp;nonce=â€ + nonce + â€œ&amp;userId=â€ + userId + â€œ&amp;key=â€ + secretKey);<br> Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();<br> params.put(â€œuserIdâ€, userId);<br> params.put(â€œmoneyâ€, money);<br> params.put(â€œnonceâ€, nonce);<br> params.put(â€œsignâ€, sign);<br> String url = â€œhttp://localhost:8079/sign/addMoneyâ€;<br> String result = HttpUtil.post(url, params);<br> return â€œjoinâ€;<br> }</p> </li></ul> 
<h3><a id="4__nonce__183"></a>4. æ–¹æ¡ˆå†å†å‡çº§ï¼šè¿½åŠ  nonce éšæœºå­—ç¬¦ä¸²</h3> 
<p>é¦–å…ˆï¼Œåœ¨ A ç³»ç»Ÿå‘èµ·è°ƒç”¨å‰ï¼Œè¿½åŠ ä¸€ä¸ª nonce å‚æ•°ï¼Œä¸€èµ·å‚ä¸åˆ°ç­¾åä¸­ï¼š</p> 
<pre><code>public String join() {
   // å‚åŠ å®Œæ´»åŠ¨åï¼Œå‘é€ä½™é¢
   Long userId = 1L;
   Long money = 100L;
   String nonce = SaFoxUtil.getRandomString(32); // éšæœº32ä½å­—ç¬¦ä¸²
   String secretKey = "Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—";
   // è®¡ç®— sign
   String sign = md5("money=" + money + "&amp;nonce=" + nonce + "&amp;userId=" + userId + "&amp;key=" + secretKey);
   Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();
   params.put("userId", userId);
   params.put("money", money);
   params.put("nonce", nonce);
   params.put("sign", sign);
   String url = "http://localhost:8079/sign/addMoney";
   String result = HttpUtil.post(url, params);
   return "join";
}
</code></pre> 
<p>ç„¶ååœ¨ B ç³»ç»Ÿæ¥æ”¶è¯·æ±‚æ—¶ï¼Œä¹ŸæŠŠ nonce å‚æ•°åŠ è¿›å»ç”Ÿæˆ sign å­—ç¬¦ä¸²ï¼Œè¿›è¡Œæ¯”è¾ƒï¼š</p> 
<pre><code>public String addMoney(Long userId, Long money, String nonce,String sign) {
    // æ£€æŸ¥æ­¤ nonce æ˜¯å¦å·²è¢«ä½¿ç”¨è¿‡äº†
    if (Objects.nonNull(CacheUtil.get("nonce_" + nonce))) {
        return "æ­¤ nonce å·²è¢«ä½¿ç”¨è¿‡äº†ï¼Œè¯·æ±‚æ— æ•ˆ";
    }
    // åœ¨ B ç³»ç»Ÿï¼Œä½¿ç”¨åŒæ ·çš„ç®—æ³•ã€åŒæ ·çš„å¯†é’¥ï¼Œè®¡ç®—å‡º sign2ï¼Œä¸ä¼ å…¥çš„ sign è¿›è¡Œæ¯”å¯¹
    String sign2 = md5("money=" + money + "&amp;nonce=" + nonce + "&amp;userId=" + userId + "&amp;key=" + secretKey);
    if (!sign2.equals(sign)) {
        return "æ— æ•ˆ signï¼Œæ— æ³•å“åº”è¯·æ±‚";
    }
    // å­˜å…¥ç¼“å­˜
    CacheUtil.set("nonce_" + nonce, "1");
    // TODO å¤„ç†ä¸šåŠ¡...

    return "ADD SUCCESS";
}
</code></pre> 
<p>ä»£ç åˆ†æï¼š</p> 
<ol><li>ä¸ºæ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬å…ˆçœ‹ç¬¬ 3 æ­¥ï¼šæ­¤å¤„åœ¨æ ¡éªŒç­¾åæˆåŠŸåï¼Œå°† nonce éšæœºå­—ç¬¦ä¸²è®°å…¥ç¼“å­˜ä¸­ã€‚</li><li>å†çœ‹ç¬¬ 1 æ­¥ï¼šæ¯æ¬¡è¯·æ±‚è¿›æ¥ï¼Œå…ˆæŸ¥çœ‹ä¸€ä¸‹ç¼“å­˜ä¸­æ˜¯å¦å·²ç»è®°å½•äº†è¿™ä¸ªéšæœºå­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç«‹å³è¿”å›ï¼šæ— æ•ˆè¯·æ±‚ã€‚</li></ol> 
<p>è¿™ä¸¤æ­¥çš„ç»„åˆï¼Œä¿è¯äº†ä¸€ä¸ª nonce éšæœºå­—ç¬¦ä¸²åªèƒ½è¢«ä½¿ç”¨ä¸€æ¬¡ï¼Œå¦‚æœè¯·æ±‚è¢«æŠ“åŒ…åé‡æ”¾ï¼Œæ˜¯æ— æ³•é€šè¿‡ nonce æ ¡éªŒçš„ã€‚</p> 
<p>è‡³æ­¤ï¼Œé—®é¢˜ä¼¼ä¹å·²è¢«è§£å†³äº† â€¦â€¦ å—ï¼Ÿ</p> 
<p>åˆ«æ€¥ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ²¡æœ‰è€ƒè™‘ï¼šè¿™ä¸ª nonce åœ¨å­—ç¬¦ä¸²åœ¨ç¼“å­˜åº”è¯¥è¢«ä¿å­˜å¤šä¹…å‘¢ï¼Ÿ</p> 
<ul><li>ä¿å­˜ 15 åˆ†é’Ÿï¼Ÿé‚£æŠ“åŒ…çš„äººåªéœ€è¦ç­‰å¾… 15 åˆ†é’Ÿï¼Œä½ çš„ nonce è®°å½•åœ¨ç¼“å­˜ä¸­æ¶ˆå¤±ï¼Œè¯·æ±‚å°±å¯ä»¥è¢«é‡æ”¾äº†ã€‚</li><li>é‚£ä¿å­˜ 24 å°æ—¶ï¼Ÿä¿å­˜ä¸€å‘¨ï¼Ÿä¿å­˜åŠä¸ªæœˆï¼Ÿå¥½åƒæ— è®ºä¿å­˜å¤šä¹…ï¼Œéƒ½æ— æ³•ä»æ ¹æœ¬ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</li></ul> 
<p>ä½ å¯èƒ½ä¼šæƒ³åˆ°ï¼Œé‚£æˆ‘æ°¸ä¹…ä¿å­˜å§ã€‚è¿™æ ·ç¡®å®èƒ½è§£å†³é—®é¢˜ï¼Œä½†æ˜¾ç„¶æœåŠ¡å™¨æ‰¿è½½ä¸äº†è¿™ä¹ˆåšï¼Œå³ä½¿å†å¾®å°çš„æ•°æ®é‡ï¼Œåœ¨æ—¶é—´çš„ç´¯åŠ ä¸‹ï¼Œä¹Ÿæ€»ä¸€å¤©ä¼šè¶…å‡ºæœåŠ¡å™¨èƒ½å¤Ÿæ‰¿è½½çš„ä¸Šé™ã€‚</p> 
<h3><a id="5__timestamp__246"></a>5. æ–¹æ¡ˆå†å†å†å‡çº§ï¼šè¿½åŠ  timestamp æ—¶é—´æˆ³</h3> 
<p>æˆ‘ä»¬å¯ä»¥å†è¿½åŠ ä¸€ä¸ª timestamp æ—¶é—´æˆ³å‚æ•°ï¼Œå°†è¯·æ±‚çš„æœ‰æ•ˆæ€§é™å®šåœ¨ä¸€ä¸ªæœ‰é™æ—¶é—´èŒƒå›´å†…ï¼Œä¾‹å¦‚ 15åˆ†é’Ÿã€‚</p> 
<p>é¦–å…ˆï¼Œåœ¨ A ç³»ç»Ÿè¿½åŠ  timestamp å‚æ•°ï¼š</p> 
<pre><code>public String join() {
    // å‚åŠ å®Œæ´»åŠ¨åï¼Œå‘é€ä½™é¢
    Long userId = 1L;
    Long money = 100L;
    Long timestamp = System.currentTimeMillis();
    String nonce = SaFoxUtil.getRandomString(32); // éšæœº32ä½å­—ç¬¦ä¸²
    String secretKey = "Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—";
    // è®¡ç®— sign
    String sign = md5("money=" + money + "&amp;nonce=" + nonce + "&amp;timestamp=" + timestamp + "&amp;userId=" + userId + "&amp;key=" + secretKey);
    Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();
    params.put("userId", userId);
    params.put("money", money);
    params.put("nonce", nonce);
    params.put("timestamp", timestamp);
    params.put("sign", sign);
    String url = "http://localhost:8079/sign/addMoney";
    String result = HttpUtil.post(url, params);
    return "join";
}
</code></pre> 
<p>åœ¨ B ç³»ç»Ÿæ£€æµ‹è¿™ä¸ª timestamp æ˜¯å¦è¶…å‡ºäº†å…è®¸çš„èŒƒå›´</p> 
<pre><code>public String addMoney(Long userId, Long money, Long timestamp, String nonce,String sign) {
    // 1ã€æ£€æŸ¥ timestamp æ˜¯å¦è¶…å‡ºå…è®¸çš„èŒƒå›´ï¼ˆæ­¤å¤„å‡å®šæœ€å¤§å…è®¸15åˆ†é’Ÿå·®è·ï¼‰
    long timestampDisparity = System.currentTimeMillis() - timestamp; // å®é™…çš„æ—¶é—´å·®
    if(timestampDisparity &gt; 1000 * 60 * 15) {
        return "timestamp æ—¶é—´å·®è¶…å‡ºå…è®¸çš„èŒƒå›´ï¼Œè¯·æ±‚æ— æ•ˆ";
    }
    // æ£€æŸ¥æ­¤ nonce æ˜¯å¦å·²è¢«ä½¿ç”¨è¿‡äº†
    if (Objects.nonNull(CacheUtil.get("nonce_" + nonce))) {
        return "æ­¤ nonce å·²è¢«ä½¿ç”¨è¿‡äº†ï¼Œè¯·æ±‚æ— æ•ˆ";
    }
    // åœ¨ B ç³»ç»Ÿï¼Œä½¿ç”¨åŒæ ·çš„ç®—æ³•ã€åŒæ ·çš„å¯†é’¥ï¼Œè®¡ç®—å‡º sign2ï¼Œä¸ä¼ å…¥çš„ sign è¿›è¡Œæ¯”å¯¹
    String sign2 = md5("money=" + money + "&amp;nonce=" + nonce + "&amp;userId=" + userId + "&amp;key=" + secretKey);
    if (!sign2.equals(sign)) {
        return "æ— æ•ˆ signï¼Œæ— æ³•å“åº”è¯·æ±‚";
    }
    // å°† nonce è®°å…¥ç¼“å­˜ï¼Œttl æœ‰æ•ˆæœŸå’Œ allowDisparity å…è®¸æ—¶é—´å·®ä¸€è‡´ 
    CacheUtil.set("nonce_" + nonce, "1", 1000 * 60 * 15);
    // TODO å¤„ç†ä¸šåŠ¡...

    return "ADD SUCCESS";
}
</code></pre> 
<p>è‡³æ­¤ï¼ŒæŠ“åŒ…è€…ï¼š</p> 
<ul><li>å¦‚æœåœ¨ 15 åˆ†é’Ÿå†…é‡æ”¾æ”»å‡»ï¼Œnonce å‚æ•°ä¸ç­”åº”ï¼šç¼“å­˜ä¸­å¯ä»¥æŸ¥å‡º nonce å€¼ï¼Œç›´æ¥æ‹’ç»å“åº”è¯·æ±‚ã€‚</li><li>å¦‚æœåœ¨ 15 åˆ†é’Ÿåé‡æ”¾æ”»å‡»ï¼Œtimestamp å‚æ•°ä¸ç­”åº”ï¼šè¶…å‡ºäº†å…è®¸çš„ timestamp æ—¶é—´å·®ï¼Œç›´æ¥æ‹’ç»å“åº”è¯·æ±‚ã€‚</li></ul> 
<h3><a id="6__307"></a>6. æœåŠ¡å™¨çš„æ—¶é’Ÿå·®å¼‚é€ æˆå®‰å…¨é—®é¢˜</h3> 
<p>ä»¥ä¸Šçš„ä»£ç ï¼Œå‡å‡è®¾ A ç³»ç»ŸæœåŠ¡å™¨ä¸ B ç³»ç»ŸæœåŠ¡å™¨çš„æ—¶é’Ÿä¸€è‡´ï¼Œæ‰å¯ä»¥æ­£å¸¸å®Œæˆå®‰å…¨æ ¡éªŒï¼Œä½†åœ¨å®é™…çš„å¼€å‘åœºæ™¯ä¸­ï¼Œæœ‰äº›æœåŠ¡å™¨ä¼šå­˜åœ¨æ—¶é’Ÿä¸å‡†ç¡®çš„é—®é¢˜ã€‚</p> 
<p>å‡è®¾ A æœåŠ¡å™¨ä¸ B æœåŠ¡å™¨çš„æ—¶é’Ÿå·®å¼‚ä¸º 10 åˆ†é’Ÿï¼Œå³ï¼šåœ¨ A æœåŠ¡å™¨ä¸º 8:00 çš„æ—¶å€™ï¼ŒB æœåŠ¡å™¨ä¸º 7:50ã€‚</p> 
<ol><li>A ç³»ç»Ÿå‘èµ·è¯·æ±‚ï¼Œå…¶ç”Ÿæˆçš„æ—¶é—´æˆ³ä¹Ÿæ˜¯ä»£è¡¨ 8:00ã€‚</li><li>B ç³»ç»Ÿæ¥å—åˆ°è¯·æ±‚åï¼Œå®Œæˆä¸šåŠ¡å¤„ç†ï¼Œæ­¤æ—¶ nonce çš„ ttl ä¸º 15åˆ†é’Ÿï¼Œåˆ°æœŸæ—¶é—´ä¸º 7:50 + 15åˆ† = 8:05ã€‚</li><li>8.05 åï¼Œnonce ç¼“å­˜æ¶ˆå¤±ï¼ŒæŠ“åŒ…è€…é‡æ”¾è¯·æ±‚æ”»å‡»ï¼š<br> * timestamp æ ¡éªŒé€šè¿‡ï¼šå› ä¸ºæ—¶é—´æˆ³å·®è·ä»…æœ‰ 8.05 - 8.00 = 5åˆ†é’Ÿï¼Œå°äº 15 åˆ†é’Ÿï¼Œæ ¡éªŒé€šè¿‡ã€‚<br> * -nonce æ ¡éªŒé€šè¿‡ï¼šå› ä¸ºæ­¤æ—¶ nonce ç¼“å­˜å·²ç»æ¶ˆå¤±ï¼Œå¯ä»¥é€šè¿‡æ ¡éªŒã€‚<br> * sign æ ¡éªŒé€šè¿‡ï¼šå› ä¸ºè¿™æœ¬æ¥å°±æ˜¯ç”± A ç³»ç»Ÿæ„å»ºçš„ä¸€ä¸ªåˆæ³•ç­¾åã€‚<br> * æ”»å‡»å®Œæˆã€‚</li></ol> 
<p>è¦è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š</p> 
<ul><li>æ–¹æ¡ˆä¸€ï¼šä¿®æ”¹æœåŠ¡å™¨æ—¶é’Ÿï¼Œä½¿ä¸¤ä¸ªæœåŠ¡å™¨æ—¶é’Ÿä¿æŒä¸€è‡´ã€‚</li><li>æ–¹æ¡ˆäºŒï¼šåœ¨ä»£ç å±‚é¢å…¼å®¹æ—¶é’Ÿä¸ä¸€è‡´çš„åœºæ™¯ã€‚</li></ul> 
<p>è¦é‡‡ç”¨æ–¹æ¡ˆä¸€çš„åŒå­¦å¯è‡ªè¡Œæœç´¢ä¸€ä¸‹åŒæ­¥æ—¶é’Ÿçš„æ–¹æ³•ï¼Œåœ¨æ­¤æš‚ä¸èµ˜è¿°ï¼Œæ­¤å¤„è¯¦ç»†é˜è¿°ä¸€ä¸‹æ–¹æ¡ˆäºŒã€‚</p> 
<p>æˆ‘ä»¬åªéœ€ç®€å•ä¿®æ”¹ä¸€ä¸‹ï¼ŒB ç³»ç»Ÿæ ¡éªŒå‚æ•°çš„ä»£ç å³å¯ï¼š</p> 
<pre><code>public String addMoney(Long userId, Long money, Long timestamp, String nonce,String sign) {
    // 1ã€æ£€æŸ¥ timestamp æ˜¯å¦è¶…å‡ºå…è®¸çš„èŒƒå›´ ï¼ˆé‡ç‚¹ä¸€ï¼šæ­¤å¤„éœ€è¦å–ç»å¯¹å€¼ï¼‰
    long timestampDisparity = Math.abs(System.currentTimeMillis() - timestamp);
    if(timestampDisparity &gt; 1000 * 60 * 15) {
        return "timestamp æ—¶é—´å·®è¶…å‡ºå…è®¸çš„èŒƒå›´ï¼Œè¯·æ±‚æ— æ•ˆ";
    }
    // æ£€æŸ¥æ­¤ nonce æ˜¯å¦å·²è¢«ä½¿ç”¨è¿‡äº†
    if (Objects.nonNull(CacheUtil.get("nonce_" + nonce))) {
        return "æ­¤ nonce å·²è¢«ä½¿ç”¨è¿‡äº†ï¼Œè¯·æ±‚æ— æ•ˆ";
    }
    // åœ¨ B ç³»ç»Ÿï¼Œä½¿ç”¨åŒæ ·çš„ç®—æ³•ã€åŒæ ·çš„å¯†é’¥ï¼Œè®¡ç®—å‡º sign2ï¼Œä¸ä¼ å…¥çš„ sign è¿›è¡Œæ¯”å¯¹
    String sign2 = md5("money=" + money + "&amp;nonce=" + nonce + "&amp;userId=" + userId + "&amp;key=" + secretKey);
    if (!sign2.equals(sign)) {
        return "æ— æ•ˆ signï¼Œæ— æ³•å“åº”è¯·æ±‚";
    }
    // å°† nonce è®°å…¥ç¼“å­˜ï¼Œé˜²æ­¢é‡å¤ä½¿ç”¨ï¼ˆé‡ç‚¹äºŒï¼šæ­¤å¤„éœ€è¦å°† ttl è®¾å®šä¸ºå…è®¸ timestamp æ—¶é—´å·®çš„å€¼ x 2 ï¼‰
    CacheUtil.set("nonce_" + nonce, "1", (1000 * 60 * 15) * 2;
    // TODO å¤„ç†ä¸šåŠ¡...

    return "ADD SUCCESS";
}
</code></pre> 
<h3><a id="8__SaToken__API__355"></a>8. ä½¿ç”¨ Sa-Token æ¡†æ¶å®Œæˆ API å‚æ•°ç­¾å</h3> 
<p>æ¥ä¸‹æ¥æ­¥å…¥æ­£é¢˜ï¼Œä½¿ç”¨ Sa-Token å†…ç½®çš„ sign æ¨¡å—ï¼Œæ–¹ä¾¿çš„å®Œæˆ API ç­¾ååˆ›å»ºã€æ ¡éªŒç­‰æ­¥éª¤ï¼š</p> 
<ul><li>ä¸é™åˆ¶è¯·æ±‚çš„å‚æ•°æ•°é‡ï¼Œæ–¹ä¾¿ç»„ç»‡ä¸šåŠ¡éœ€æ±‚ä»£ç ã€‚</li><li>è‡ªåŠ¨è¡¥å…¨ nonceã€timestamp å‚æ•°ï¼Œçœæ—¶çœåŠ›ã€‚</li><li>è‡ªåŠ¨æ„å»ºç­¾åï¼Œå¹¶åºåˆ—åŒ–å‚æ•°ä¸ºå­—ç¬¦ä¸²ã€‚</li><li>ä¸€å¥ä»£ç å®Œæˆ nonceã€timestampã€sign çš„æ ¡éªŒï¼Œé˜²ä¼ªé€ è¯·æ±‚è°ƒç”¨ã€é˜²å‚æ•°ç¯¡æ”¹ã€é˜²é‡æ”¾æ”»å‡»ã€‚</li></ul> 
<h4><a id="81__364"></a>8.1 å¼•å…¥ä¾èµ–</h4> 
<p>api-sign æ¨¡å—å·²å†…åµŒåˆ°æ ¸å¿ƒåŒ…ï¼Œåªéœ€è¦å¼•å…¥ sa-token æœ¬èº«ä¾èµ–å³å¯ï¼šï¼ˆè¯·æ±‚å‘èµ·ç«¯å’Œæ¥æ”¶ç«¯éƒ½éœ€è¦å¼•å…¥ï¼‰</p> 
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;cn.dev33&lt;/groupId&gt;
    &lt;artifactId&gt;sa-token-spring-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;1.35.0.RC&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> 
<h4><a id="82__377"></a>8.2 é…ç½®å¯†é’¥</h4> 
<p>è¯·æ±‚å‘èµ·ç«¯å’Œæ¥æ”¶ç«¯éœ€è¦é…ç½®ä¸€ä¸ªç›¸åŒçš„ç§˜é’¥ï¼Œåœ¨ application.yml ä¸­é…ç½®ï¼š</p> 
<pre><code>sa-token: 
    sign:
        # API æ¥å£ç­¾åç§˜é’¥ ï¼ˆéšä¾¿ä¹±æ‘å‡ ä¸ªå­—æ¯å³å¯ï¼‰
        secret-key: kQwIOrYvnXmSDkwEiFngrKidMcdrgKor
</code></pre> 
<h4><a id="83__389"></a>8.3 è¯·æ±‚å‘èµ·ç«¯æ„å»ºç­¾å</h4> 
<pre><code>public String join() {
    // å‚åŠ å®Œæ´»åŠ¨åï¼Œå‘é€ä½™é¢
    Long userId = 1L;
    Long money = 100L;
    Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();
    params.put("userId", userId);
    params.put("money", money);
    SaSignUtil.addSignParamsAndJoin(params);
    String url = "http://localhost:8079/sign/addMoney";
    return HttpUtil.post(url, params);
}
</code></pre> 
<h4><a id="84__406"></a>8.4 è¯·æ±‚æ¥å—ç«¯æ ¡éªŒç­¾å</h4> 
<pre><code>public String addMoney(Long userId, Long money) {
    // 1ã€æ ¡éªŒè¯·æ±‚ä¸­çš„ç­¾å
    SaSignUtil.checkRequest(SaHolder.getRequest());

    // 2ã€æ ¡éªŒé€šè¿‡ï¼Œå¤„ç†ä¸šåŠ¡
    System.out.println("userId=" + userId);
    System.out.println("money=" + money);

    return "ADD SUCCESS";
}
</code></pre> 
<p>å¦‚ä¸Šä»£ç ä¾¿å¯ç®€å•æ–¹ä¾¿çš„å®Œæˆ API æ¥å£å‚æ•°ç­¾åæ ¡éªŒï¼Œå½“è¯·æ±‚ç«¯çš„ç§˜é’¥ä¸å¯¹ï¼Œæˆ–è€…è¯·æ±‚å‚æ•°è¢«ç¯¡æ”¹ã€è¯·æ±‚è¢«é‡æ”¾æ—¶ï¼Œå‡æ— æ³•é€šè¿‡<br> SaSignUtil.checkRequest æ ¡éªŒ</p> 
<h4><a id="85__425"></a>8.5 åŸç†åˆ†æ</h4> 
<h5><a id="851__427"></a>8.5.1 æ„å»ºç­¾å</h5> 
<p><code>SaSignUtil#addSignParamsAndJoin(params);</code>ï¼š</p> 
<pre><code>public static String addSignParamsAndJoin(Map&lt;String, Object&gt; paramsMap) {
    return SaManager.getSaSignTemplate().addSignParamsAndJoin(paramsMap);
}
</code></pre> 
<p>ä¼šè°ƒç”¨ <code>SaSignTemplate</code> ç±»ä¸­çš„æ–¹æ³•</p> 
<p><code>SaSignTemplate#addSignParamsAndJoin() æ–¹æ³•</code></p> 
<pre><code>public String addSignParamsAndJoin(Map&lt;String, Object&gt; paramsMap) {
	// 1.æ·»åŠ å‚æ•°ï¼štimestampã€nonceã€sign
    paramsMap = this.addSignParams(paramsMap);
    // 2.å°† map ä½¿ç”¨ &amp; è½¬åŒ–ä¸ºString
    return this.joinParams(paramsMap);
}
</code></pre> 
<p>è¿™ä¸ªæ–¹æ³•æœ‰ä¸¤ä¸ªé€»è¾‘ï¼š</p> 
<ol><li>æ·»åŠ å‚æ•°ï¼štimestampã€nonceã€sign</li><li>å°† map ä½¿ç”¨ &amp; è½¬åŒ–ä¸ºString</li></ol> 
<p><code>SaSignTemplate#addSignParams() æ–¹æ³•</code></p> 
<pre><code>public Map&lt;String, Object&gt; addSignParams(Map&lt;String, Object&gt; paramsMap) {
    paramsMap.put(timestamp, String.valueOf(System.currentTimeMillis()));
    paramsMap.put(nonce, SaFoxUtil.getRandomString(32));
    paramsMap.put(sign, this.createSign(paramsMap));
    return paramsMap;
}
</code></pre> 
<p><code>SaSignTemplate#createSign() æ–¹æ³•</code>ï¼šç”Ÿæˆç­¾å</p> 
<pre><code>public String createSign(Map&lt;String, ?&gt; paramsMap) {
    String secretKey = this.getSecretKey();
    SaSignException.throwByNull(secretKey, "å‚ä¸å‚æ•°ç­¾åçš„ç§˜é’¥ä¸å¯ä¸ºç©º", 12201);
    if (((Map)paramsMap).containsKey(sign)) {
        paramsMap = new TreeMap((Map)paramsMap);
        ((Map)paramsMap).remove(sign);
    }
	// æŒ‰ç…§æ•°æ®å­—å…¸è¿›è¡Œæ’åºï¼Œå¹¶å°† map ä½¿ç”¨ &amp; è½¬åŒ–ä¸ºString
    String paramsStr = this.joinParamsDictSort((Map)paramsMap);
    String fullStr = paramsStr + "&amp;" + key + "=" + secretKey;
    // md5
    return this.abstractStr(fullStr);
}

public String abstractStr(String fullStr) {
    return SaSecureUtil.md5(fullStr);
}
</code></pre> 
<p>è¿™ä¸ªæ–¹æ³•æœ‰ä¸¤ä¸ªé€»è¾‘ï¼š</p> 
<ol><li>æŒ‰ç…§æ•°æ®å­—å…¸è¿›è¡Œæ’åºï¼Œå¹¶å°† map ä½¿ç”¨ &amp; è½¬åŒ–ä¸ºString</li><li>ä½¿ç”¨ md5 æ‘˜è¦ç®—æ³•</li></ol> 
<h5><a id="852__497"></a>8.5.2 éªŒè¯ç­¾å</h5> 
<p><code>SaSignUtil.checkRequest(SaHolder.getRequest());</code>ï¼š</p> 
<pre><code>public static void checkRequest(SaRequest request) {
    SaManager.getSaSignTemplate().checkRequest(request);
}
</code></pre> 
<p>è¿˜æ˜¯ä¼šè°ƒç”¨ <code>SaSignTemplate</code> ç±»ä¸­çš„æ–¹æ³•</p> 
<p><code>SaSignTemplate#checkParamMap() æ–¹æ³•</code>ï¼šæ ¡éªŒè¯·æ±‚å‚æ•°</p> 
<pre><code>public void checkRequest(SaRequest request) {
    this.checkParamMap(request.getParamMap());
}

public void checkParamMap(Map&lt;String, String&gt; paramMap) {
    String timestampValue = (String)paramMap.get(timestamp);
    String nonceValue = (String)paramMap.get(nonce);
    String signValue = (String)paramMap.get(sign);
    // 1.æ ¡éªŒæ—¶é—´æˆ³
    this.checkTimestamp(Long.parseLong(timestampValue));
    // 2.æ ¡éªŒéšæœºæ•°
    if (this.getSignConfigOrGlobal().getIsCheckNonce()) {
        this.checkNonce(nonceValue);
    }
	// 3.æ ¡éªŒç­¾å
    this.checkSign(paramMap, signValue);
}
</code></pre> 
<p>è¿™ä¸ªæ–¹æ³•æœ‰ä¸‰ä¸ªé€»è¾‘ï¼š</p> 
<ol><li>æ ¡éªŒæ—¶é—´æˆ³ï¼šåˆ¤æ–­æ˜¯å¦åœ¨æ—¶é—´å·®èŒƒå›´å†…</li><li>æ ¡éªŒéšæœºæ•°ï¼šåˆ¤æ–­æ­¤éšæœºæ•°æ˜¯å¦å·²ä½¿ç”¨</li><li>æ ¡éªŒç­¾åï¼šåˆ¤æ–­åŸç­¾åå’Œç°åœ¨ç”Ÿæˆçš„ç­¾åæ˜¯å¦ä¸€è‡´</li></ol> 
<p><code>SaSignTemplate#checkNonce() æ–¹æ³•ï¼š</code>æ ¡éªŒéšæœºæ•°</p> 
<pre><code>public void checkNonce(String nonce) {
    if (SaFoxUtil.isEmpty(nonce)) {
        throw new SaSignException("nonce ä¸ºç©ºï¼Œæ— æ•ˆ");
    } else {
        String key = this.splicingNonceSaveKey(nonce);
        if (SaManager.getSaTokenDao().get(key) != null) {
            throw new SaSignException("æ­¤ nonce å·²è¢«ä½¿ç”¨è¿‡ï¼Œä¸å¯é‡å¤ä½¿ç”¨ï¼š" + nonce);
        } else {
            SaManager.getSaTokenDao().set(key, nonce, this.getSignConfigOrGlobal().getSaveNonceExpire() * 2L + 2L);
        }
    }
}
</code></pre> 
<h6><a id="SaToken__557"></a>SaToken å­˜å‚¨</h6> 
<p><code>SaTokenDao</code> æ˜¯å­˜å‚¨æ¥å£ï¼Œé»˜è®¤å®ç°æ˜¯ç”¨çš„æ˜¯ <code>SaTokenDaoDefaultImpl</code>ã€‚<code>SaTokenDaoDefaultImpl</code><br> å­˜å‚¨æ•°æ®ï¼Œä¸»è¦æ˜¯é€šè¿‡ <code>ConcurrentHashMap</code> å­˜æ”¾åœ¨æœ¬åœ°å†…å­˜ä¸­ã€‚</p> 
<p><code>SaManager#getSaTokenDao() æ–¹æ³•ï¼š</code></p> 
<pre><code>public static SaTokenDao getSaTokenDao() {
    if (saTokenDao == null) {
        Class var0 = SaManager.class;
        synchronized(SaManager.class) {
            if (saTokenDao == null) {
                setSaTokenDaoMethod(new SaTokenDaoDefaultImpl());
            }
        }
    }
    return saTokenDao;
}
</code></pre> 
<p><code>SaTokenDaoDefaultImpl </code>ï¼š</p> 
<pre><code>public class SaTokenDaoDefaultImpl implements SaTokenDao {
	// æ•°æ®é›†åˆ 
    public Map&lt;String, Object&gt; dataMap = new ConcurrentHashMap();
    // è¿‡æœŸæ—¶é—´é›†åˆ (å•ä½: æ¯«ç§’) , è®°å½•æ‰€æœ‰keyçš„åˆ°æœŸæ—¶é—´ [æ³¨æ„ä¸æ˜¯å‰©ä½™å­˜æ´»æ—¶é—´] 
    public Map&lt;String, Long&gt; expireMap = new ConcurrentHashMap();
    public Thread refreshThread;
    public volatile boolean refreshFlag;

    public SaTokenDaoDefaultImpl() {
    	// å®šæ—¶æ¸…ç†è¿‡æœŸæ•°æ®
        this.initRefreshThread();
    }

    public String get(String key) {
        this.clearKeyByTimeout(key);
        return (String)this.dataMap.get(key);
    }

    public void set(String key, String value, long timeout) {
        if (timeout != 0L &amp;&amp; timeout &gt; -2L) {
            this.dataMap.put(key, value);
            this.expireMap.put(key, timeout == -1L ? -1L : System.currentTimeMillis() + timeout * 1000L);
        }
    }
	
	public void initRefreshThread() {
        if (SaManager.getConfig().getDataRefreshPeriod() &gt; 0) {
            this.refreshFlag = true;
            this.refreshThread = new Thread(() -&gt; {
                while(true) {
                    try {
                        try {
                            if (!this.refreshFlag) {
                                return;
                            }

                            this.refreshDataMap();
                        } catch (Exception var2) {
                            var2.printStackTrace();
                        }

                        int dataRefreshPeriod = SaManager.getConfig().getDataRefreshPeriod();
                        if (dataRefreshPeriod &lt;= 0) {
                            dataRefreshPeriod = 1;
                        }

                        Thread.sleep((long)dataRefreshPeriod * 1000L);
                    } catch (Exception var3) {
                        var3.printStackTrace();
                    }
                }
            });
            this.refreshThread.start();
        }
    }
}
</code></pre> 
<p>å¦‚æœä»…ä»…å­˜æ”¾åœ¨æœ¬åœ°å†…å­˜ä¸­ï¼Œæ¶‰åŠåˆ°å¤šä¸ªé¡¹ç›®ï¼Œå¯èƒ½æ•°æ®æ— æ³•å…±äº«ã€‚</p> 
<p>å¼•å…¥ä»“åº“ <code>sa-token-dao-redis-jackson</code></p> 
<pre><code>&lt;!-- Sa-Token æ•´åˆ Redis ï¼ˆä½¿ç”¨ jackson åºåˆ—åŒ–æ–¹å¼ï¼‰ --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;cn.dev33&lt;/groupId&gt;
    &lt;artifactId&gt;sa-token-redis-jackson&lt;/artifactId&gt;
    &lt;version&gt;1.35.0.RC&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- æä¾›Redisè¿æ¥æ±  --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
    &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre> 
<p><code>SaTokenDaoRedisJackson</code> ä½¿ç”¨ Redis ä½œä¸ºå­˜å‚¨æ•°æ®çš„åœ°æ–¹</p> 
<p><code>SaBeanInject#setSaTokenDao</code>ï¼Œ<code>SaBeanInject</code> æ˜¯è‡ªåŠ¨é…ç½®çš„ã€‚å½“ç³»ç»Ÿä¸­å­˜åœ¨ <code>SaTokenDao</code>çš„ Bean<br> å®ä¾‹ï¼Œåˆ™è®¾ç½®<code>SaTokenDao</code> å®ä¾‹</p> 
<pre><code>public class SaBeanInject {
    @Autowired(
        required = false
    )
    public void setSaTokenDao(SaTokenDao saTokenDao) {
        SaManager.setSaTokenDao(saTokenDao);
    }
}
</code></pre> 
<p>å‚è€ƒï¼š<br> <a href="https://sa-token.cc/doc.html#/plugin/api-sign" rel="nofollow">API æ¥å£å‚æ•°ç­¾å</a><br> <a href="https://blog.csdn.net/qq_42985872/article/details/131453413">ã€å¼€æºé¡¹ç›®ã€‘ä½¿ç”¨Sa-<br> Tokenæ¡†æ¶å®ŒæˆAPIå‚æ•°ç­¾å</a></p> 
<p><strong>å­¦ä¹ ç½‘ç»œå®‰å…¨æŠ€æœ¯çš„æ–¹æ³•æ— éä¸‰ç§:</strong></p> 
<p>ç¬¬ä¸€ç§æ˜¯æŠ¥ç½‘ç»œå®‰å…¨ä¸“ä¸šï¼Œç°åœ¨å«ç½‘ç»œç©ºé—´å®‰å…¨ä¸“ä¸šï¼Œä¸»è¦ä¸“ä¸šè¯¾ç¨‹:ç¨‹åºè®¾è®¡ã€è®¡ç®—æœºç»„æˆåŸç†åŸç†ã€æ•°æ®ç»“æ„ã€æ“ä½œç³»ç»ŸåŸç†ã€æ•°æ®åº“ç³»ç»Ÿã€ è®¡ç®—æœºç½‘ç»œã€äººå·¥æ™ºèƒ½ã€è‡ªç„¶è¯­è¨€å¤„ç†ã€ç¤¾ä¼šè®¡ç®—ã€ç½‘ç»œå®‰å…¨æ³•å¾‹æ³•è§„ã€ç½‘ç»œå®‰å…¨ã€å†…å®¹å®‰å…¨ã€æ•°å­—å–è¯ã€æœºå™¨å­¦ä¹ ï¼Œå¤šåª’ä½“æŠ€æœ¯ï¼Œä¿¡æ¯æ£€ç´¢ã€èˆ†æƒ…åˆ†æç­‰ã€‚</p> 
<p>ç¬¬äºŒç§æ˜¯è‡ªå­¦ï¼Œå°±æ˜¯åœ¨ç½‘ä¸Šæ‰¾èµ„æºã€æ‰¾æ•™ç¨‹ï¼Œæˆ–è€…æ˜¯æƒ³åŠæ³•è®¤è¯†ä¸€-äº›å¤§ä½¬ï¼ŒæŠ±ç´§å¤§è…¿ï¼Œä¸è¿‡è¿™ç§æ–¹æ³•å¾ˆè€—æ—¶é—´ï¼Œè€Œä¸”å­¦ä¹ æ²¡æœ‰è§„åˆ’ï¼Œå¯èƒ½å¾ˆé•¿ä¸€æ®µæ—¶é—´æ„Ÿè§‰è‡ªå·±æ²¡æœ‰è¿›æ­¥ï¼Œå®¹æ˜“åŠé€€ã€‚</p> 
<p>å¦‚æœä½ å¯¹ç½‘ç»œå®‰å…¨å…¥é—¨æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆä½ éœ€è¦çš„è¯å¯ä»¥ç‚¹å‡»è¿™é‡Œ<strong>ğŸ‘‰</strong><a href="https://mp.weixin.qq.com/s/BWb9OzaB-gVGVpkm161PMw" rel="nofollow">ç½‘ç»œå®‰å…¨é‡ç£…ç¦åˆ©ï¼šå…¥é—¨&amp;è¿›é˜¶å…¨å¥—282Gå­¦ä¹ èµ„æºåŒ…å…è´¹åˆ†äº«ï¼</a></p> 
<p>ç¬¬ä¸‰ç§å°±æ˜¯å»æ‰¾åŸ¹è®­ã€‚</p> 
<p><img src="https://images2.imgbox.com/59/43/jSy9L9oI_o.png" alt="image.png"></p> 
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šæ•™ä½ é›¶åŸºç¡€å…¥é—¨å¿«é€Ÿå…¥é—¨ä¸Šæ‰‹ç½‘ç»œå®‰å…¨ã€‚</p> 
<p>ç½‘ç»œå®‰å…¨å…¥é—¨åˆ°åº•æ˜¯å…ˆå­¦ç¼–ç¨‹è¿˜æ˜¯å…ˆå­¦è®¡ç®—æœºåŸºç¡€ï¼Ÿè¿™æ˜¯ä¸€ä¸ªäº‰è®®æ¯”è¾ƒå¤§çš„é—®é¢˜ï¼Œæœ‰çš„äººä¼šå»ºè®®å…ˆå­¦ç¼–ç¨‹ï¼Œè€Œæœ‰çš„äººä¼šå»ºè®®å…ˆå­¦è®¡ç®—æœºåŸºç¡€ï¼Œå…¶å®è¿™éƒ½æ˜¯è¦å­¦çš„ã€‚è€Œä¸”è¿™äº›å¯¹å­¦ä¹ ç½‘ç»œå®‰å…¨æ¥è¯´éå¸¸é‡è¦ã€‚ä½†æ˜¯å¯¹äºå®Œå…¨é›¶åŸºç¡€çš„äººæ¥è¯´åˆæˆ–è€…æ€¥äºè½¬è¡Œçš„äººæ¥è¯´ï¼Œå­¦ä¹ ç¼–ç¨‹æˆ–è€…è®¡ç®—æœºåŸºç¡€å¯¹ä»–ä»¬æ¥è¯´éƒ½æœ‰ä¸€å®šçš„éš¾åº¦ï¼Œå¹¶ä¸”èŠ±è´¹æ—¶é—´å¤ªé•¿ã€‚</p> 
<h4><a id="_46_698"></a>ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å‡†å¤‡ 4å‘¨~6å‘¨</h4> 
<p>è¿™ä¸ªé˜¶æ®µæ˜¯æ‰€æœ‰å‡†å¤‡è¿›å…¥å®‰å…¨è¡Œä¸šå¿…å­¦çš„éƒ¨åˆ†ï¼Œä¿—è¯è¯´ï¼šåŸºç¡€ä¸åŠ³ï¼Œåœ°åŠ¨å±±æ‘‡<br> <img src="https://images2.imgbox.com/f6/2f/U4PLVvOL_o.png" alt="image.png"></p> 
<h4><a id="web_703"></a>ç¬¬äºŒé˜¶æ®µï¼šwebæ¸—é€</h4> 
<p><strong>å­¦ä¹ åŸºç¡€ æ—¶é—´ï¼š1å‘¨ ~ 2å‘¨ï¼š</strong></p> 
<p>â‘  äº†è§£åŸºæœ¬æ¦‚å¿µï¼šï¼ˆSQLæ³¨å…¥ã€XSSã€ä¸Šä¼ ã€CSRFã€ä¸€å¥è¯æœ¨é©¬ã€ç­‰ï¼‰ä¸ºä¹‹åçš„WEBæ¸—é€æµ‹è¯•æ‰“ä¸‹åŸºç¡€ã€‚<br> â‘¡ æŸ¥çœ‹ä¸€äº›è®ºå›çš„ä¸€äº›Webæ¸—é€ï¼Œå­¦ä¸€å­¦æ¡ˆä¾‹çš„æ€è·¯ï¼Œæ¯ä¸€ä¸ªç«™ç‚¹éƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æ€è·¯æ˜¯ä¸»è¦çš„ã€‚<br> â‘¢ å­¦ä¼šæé—®çš„è‰ºæœ¯ï¼Œå¦‚æœé‡åˆ°ä¸æ‡‚å¾—è¦å–„äºæé—®ã€‚<br> <img src="https://images2.imgbox.com/d0/56/4sM1o1n7_o.png" alt="image.png"></p> 
<p><strong>é…ç½®æ¸—é€ç¯å¢ƒ æ—¶é—´ï¼š3å‘¨ ~ 4å‘¨ï¼š</strong></p> 
<p>â‘  äº†è§£æ¸—é€æµ‹è¯•å¸¸ç”¨çš„å·¥å…·ï¼Œä¾‹å¦‚ï¼ˆAWVSã€SQLMAPã€NMAPã€BURPã€ä¸­å›½èœåˆ€ç­‰ï¼‰ã€‚<br> â‘¡ ä¸‹è½½è¿™äº›å·¥å…·æ— åé—¨ç‰ˆæœ¬å¹¶ä¸”å®‰è£…åˆ°è®¡ç®—æœºä¸Šã€‚<br> â‘¢ äº†è§£è¿™äº›å·¥å…·çš„ä½¿ç”¨åœºæ™¯ï¼Œæ‡‚å¾—åŸºæœ¬çš„ä½¿ç”¨ï¼Œæ¨èåœ¨Googleä¸ŠæŸ¥æ‰¾ã€‚</p> 
<h4><a id="_6_718"></a><strong>æ¸—é€å®æˆ˜æ“ä½œ æ—¶é—´ï¼šçº¦6å‘¨ï¼š</strong></h4> 
<p>â‘  åœ¨ç½‘ä¸Šæœç´¢æ¸—é€å®æˆ˜æ¡ˆä¾‹ï¼Œæ·±å…¥äº†è§£SQLæ³¨å…¥ã€æ–‡ä»¶ä¸Šä¼ ã€è§£ææ¼æ´ç­‰åœ¨å®æˆ˜ä¸­çš„ä½¿ç”¨ã€‚<br> â‘¡ è‡ªå·±æ­å»ºæ¼æ´ç¯å¢ƒæµ‹è¯•ï¼Œæ¨èDWVAï¼ŒSQLi-labsï¼ŒUpload-labsï¼ŒbWAPPã€‚<br> â‘¢ æ‡‚å¾—æ¸—é€æµ‹è¯•çš„é˜¶æ®µï¼Œæ¯ä¸€ä¸ªé˜¶æ®µéœ€è¦åšé‚£äº›åŠ¨ä½œï¼šä¾‹å¦‚PTESæ¸—é€æµ‹è¯•æ‰§è¡Œæ ‡å‡†ã€‚<br> â‘£ æ·±å…¥ç ”ç©¶æ‰‹å·¥SQLæ³¨å…¥ï¼Œå¯»æ‰¾ç»•è¿‡wafçš„æ–¹æ³•ï¼Œåˆ¶ä½œè‡ªå·±çš„è„šæœ¬ã€‚<br> â‘¤ ç ”ç©¶æ–‡ä»¶ä¸Šä¼ çš„åŸç†ï¼Œå¦‚ä½•è¿›è¡Œæˆªæ–­ã€åŒé‡åç¼€æ¬ºéª—(IISã€PHP)ã€è§£ææ¼æ´åˆ©ç”¨ï¼ˆIISã€Nignixã€Apacheï¼‰ç­‰ï¼Œå‚ç…§ï¼šä¸Šä¼ æ”»å‡»æ¡†æ¶ã€‚<br> â‘¥ äº†è§£XSSå½¢æˆåŸç†å’Œç§ç±»ï¼Œåœ¨DWVAä¸­è¿›è¡Œå®è·µï¼Œä½¿ç”¨ä¸€ä¸ªå«æœ‰XSSæ¼æ´çš„cmsï¼Œå®‰è£…å®‰å…¨ç‹—ç­‰è¿›è¡Œæµ‹è¯•ã€‚<br> â‘¦ äº†è§£ä¸€å¥è¯æœ¨é©¬ï¼Œå¹¶å°è¯•ç¼–å†™è¿‡ç‹—ä¸€å¥è¯ã€‚<br> â‘§ ç ”ç©¶åœ¨Windowså’ŒLinuxä¸‹çš„æå‡æƒé™ï¼ŒGoogleå…³é”®è¯ï¼šææƒ<br> <img src="https://images2.imgbox.com/f8/5b/2GVNgLR7_o.png" alt="image.png"><br> ä»¥ä¸Šå°±æ˜¯å…¥é—¨é˜¶æ®µ</p> 
<h4><a id="_731"></a>ç¬¬ä¸‰é˜¶æ®µï¼šè¿›é˜¶</h4> 
<p>å·²ç»å…¥é—¨å¹¶ä¸”æ‰¾åˆ°å·¥ä½œä¹‹ååˆè¯¥æ€ä¹ˆè¿›é˜¶ï¼Ÿè¯¦æƒ…çœ‹ä¸‹å›¾<br> <img src="https://images2.imgbox.com/88/62/ANsdRKW2_o.png" alt="image.png"></p> 
<p>ç»™æ–°æ‰‹å°ç™½çš„å…¥é—¨å»ºè®®ï¼š<br> æ–°æ‰‹å…¥é—¨å­¦ä¹ æœ€å¥½è¿˜æ˜¯ä»è§†é¢‘å…¥æ‰‹è¿›è¡Œå­¦ä¹ ï¼Œè§†é¢‘çš„æµ…æ˜¾æ˜“æ‡‚ç›¸æ¯”èµ·æ™¦æ¶©çš„æ–‡å­—è€Œè¨€æ›´å®¹æ˜“å¸æ”¶ï¼Œè¿™é‡Œæˆ‘ç»™å¤§å®¶å‡†å¤‡äº†ä¸€å¥—ç½‘ç»œå®‰å…¨ä»å…¥é—¨åˆ°ç²¾é€šçš„è§†é¢‘å­¦ä¹ èµ„æ–™åŒ…å…è´¹é¢†å–å“¦ï¼</p> 
<p>å¦‚æœä½ å¯¹ç½‘ç»œå®‰å…¨å…¥é—¨æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆä½ éœ€è¦çš„è¯å¯ä»¥ç‚¹å‡»è¿™é‡Œ<strong>ğŸ‘‰</strong><a href="https://mp.weixin.qq.com/s/BWb9OzaB-gVGVpkm161PMw" rel="nofollow">ç½‘ç»œå®‰å…¨é‡ç£…ç¦åˆ©ï¼šå…¥é—¨&amp;è¿›é˜¶å…¨å¥—282Gå­¦ä¹ èµ„æºåŒ…å…è´¹åˆ†äº«ï¼</a></p> 
<img src="https://images2.imgbox.com/7b/7f/NolQ6ZTD_o.jpg"> 
<p><img src="https://images2.imgbox.com/b8/e1/MEYW3rsn_o.png" alt=""></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/74066413b0f5a4722018d0743b2a2ece/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">jsä¸­ window.top , window.parent , window.self è¯¦è§£</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9db5fb257433846520b7511362dfadc5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">java å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ spring booté¡¹ç›®</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹ä¸­å›½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>