<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>gitee开源程序kkFileView踩坑及解决方案 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="gitee开源程序kkFileView踩坑及解决方案" />
<meta property="og:description" content="目录
前言
一、依赖选择
二、环境部署安装
2.1解压
2.2启动程序
2.3踩坑--------office.home配置有误
2.4踩坑问题解决
三、踩坑-------OFFICE组件不可用
3.1确认是否是office组件的问题
3.2验证office组件是否不可用
3.3验证office组件是否可用
四、踩坑-------officeHome must exist and be a directory
五、程序优化
5.1无法打开dox文件，使用KFV程序转义成pdf时会报500，体验感很糟糕，我这里通过异常捕获，返回I‘m sorry图像
5.2文件无法打开，报404
5.3解决文件编译乱码问题
​总结
前言 提示：本人从2021年7月份开始使用开源框架kkFileView到现在已经过去了5个多月了，总提来讲kkFileView的功能很强大，由于需要集成依赖第三方软件openboffice或liberoffice,不可避免的会给开发人员或者使用部署人员带来很多兼容性和环境配置问题，我在这里踩了很多坑，这里做个总结,下面的kkFileView就简称KFV了
提示：以下是本篇文章正文内容，下面案例可供参考
一、依赖选择 示例：kkFileView需要第三方软件的功能支撑，因此如果选择的软件不符合程序能够接受的范围就会带来冲突，下面附上官方说明：
Java: 1.8&#43; Maven：3.4&#43; OpenOffice或LiberOffice(Windows下已内置，CentOS或Ubuntu下会自动下载安装，MacOS下需要自行安装) 不过这些提示并不精确，查看类OfficeUtils中getDefaultOfficeHome方法后定位到更精准范围，如下图：
windows下KFV自带完美兼容的windows-office，这里就不做说明了；
linux下可以选择openoffice4，而libreoffice可以选择使用libreoffice6.0-7.2版本；
作者这里选择的是libreoffice7.1版本的软件来兼容的KFV，下载地址如下：
https://downloadarchive.documentfoundation.org/libreoffice/old/7.1.4.2/rpm/x86_64/LibreOffice_7.1.4.2_Linux_x86-64_rpm.tar.gz
https://downloadarchive.documentfoundation.org/libreoffice/old/7.1.4.2/rpm/x86_64/LibreOffice_7.1.4.2_Linux_x86-64_rpm_langpack_zh-CN.tar.gz
这两个分别下载LibreOffice_7.1.4.2_Linux_x86-64_rpm.tar.gz 和LibreOffice_7.1.4.2_Linux_x86-64_rpm_langpack_zh-CN.tar.gz文件，前面提供启动程序，后面提供中文语言包
第三个需要下载的是KFV官网的linux能运行的jar包下载地址如下：（https://kkfileview.keking.cn）
https://kkfileview.keking.cn/kkFileView-4.0.0.tar.gz
二、环境部署安装 2.1解压 将下载好的程序传到某个目录下，我这里的文件目录是
/export/server/LibreOffice_7.1.4.2_Linux_x86-64_rpm.tar.gz /export/server/LibreOffice_7.1.4.2_Linux_x86-64_rpm_langpack_zh-CN.tar.gz /export/server/kkFileView-4.0.0.tar.gz 接下来需要解压文件：
使用命令如下：
#进入解压文件位置后
tar -zxvf /export/server/LibreOffice_7.1.4.2_Linux_x86-64_rpm.tar.gz tar -zxvf /export/server/LibreOffice_7.1.4.2_Linux_x86-64_rpm_langpack_zh-CN.tar.gz tar -zxvf /export/server/kkFileView-4.0.0.tar.gz 2.2启动程序 解压后目录结构如图所示;
进入 cd ./kkFileView4.0.0/bin ，然后执行命令sh ./startup.sh sh ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/ef7175d64f25a6826e68f64eb1b6b233/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-21T16:49:40+08:00" />
<meta property="article:modified_time" content="2021-12-21T16:49:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">gitee开源程序kkFileView踩坑及解决方案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E5%89%8D%E8%A8%80-toc" style="margin-left:0px;"><a href="#%E5%89%8D%E8%A8%80" rel="nofollow" title="前言">前言</a></p> 
<p id="%E4%B8%80%E3%80%81%E4%BE%9D%E8%B5%96%E9%80%89%E6%8B%A9-toc" style="margin-left:0px;"><a href="#%E4%B8%80%E3%80%81%E4%BE%9D%E8%B5%96%E9%80%89%E6%8B%A9" rel="nofollow" title="一、依赖选择">一、依赖选择</a></p> 
<p id="%E4%BA%8C%E3%80%81%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85-toc" style="margin-left:0px;"><a href="#%E4%BA%8C%E3%80%81%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85" rel="nofollow" title="二、环境部署安装">二、环境部署安装</a></p> 
<p id="2.1%E8%A7%A3%E5%8E%8B-toc" style="margin-left:40px;"><a href="#2.1%E8%A7%A3%E5%8E%8B" rel="nofollow" title="2.1解压">2.1解压</a></p> 
<p id="2.2%E5%90%AF%E5%8A%A8%E7%A8%8B%E5%BA%8F-toc" style="margin-left:40px;"><a href="#2.2%E5%90%AF%E5%8A%A8%E7%A8%8B%E5%BA%8F" rel="nofollow" title="2.2启动程序">2.2启动程序</a></p> 
<p id="2.3%E8%B8%A9%E5%9D%91--------office.home%E9%85%8D%E7%BD%AE%E6%9C%89%E8%AF%AF-toc" style="margin-left:40px;"><a href="#2.3%E8%B8%A9%E5%9D%91--------office.home%E9%85%8D%E7%BD%AE%E6%9C%89%E8%AF%AF" rel="nofollow" title="2.3踩坑--------office.home配置有误">2.3踩坑--------office.home配置有误</a></p> 
<p id="%C2%A02.4%E8%B8%A9%E5%9D%91%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3-toc" style="margin-left:40px;"><a href="#%C2%A02.4%E8%B8%A9%E5%9D%91%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3" rel="nofollow" title="2.4踩坑问题解决">2.4踩坑问题解决</a></p> 
<p id="%E4%B8%89%E3%80%81%E8%B8%A9%E5%9D%91-------OFFICE%E7%BB%84%E4%BB%B6%E4%B8%8D%E5%8F%AF%E7%94%A8-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81%E8%B8%A9%E5%9D%91-------OFFICE%E7%BB%84%E4%BB%B6%E4%B8%8D%E5%8F%AF%E7%94%A8" rel="nofollow" title="三、踩坑-------OFFICE组件不可用">三、踩坑-------OFFICE组件不可用</a></p> 
<p id="3.1%E7%A1%AE%E8%AE%A4%E6%98%AF%E5%90%A6%E6%98%AFoffice%E7%BB%84%E4%BB%B6%E7%9A%84%E9%97%AE%E9%A2%98-toc" style="margin-left:40px;"><a href="#3.1%E7%A1%AE%E8%AE%A4%E6%98%AF%E5%90%A6%E6%98%AFoffice%E7%BB%84%E4%BB%B6%E7%9A%84%E9%97%AE%E9%A2%98" rel="nofollow" title="3.1确认是否是office组件的问题">3.1确认是否是office组件的问题</a></p> 
<p id="3.2%E9%AA%8C%E8%AF%81office%E7%BB%84%E4%BB%B6%E6%98%AF%E5%90%A6%E4%B8%8D%E5%8F%AF%E7%94%A8-toc" style="margin-left:40px;"><a href="#3.2%E9%AA%8C%E8%AF%81office%E7%BB%84%E4%BB%B6%E6%98%AF%E5%90%A6%E4%B8%8D%E5%8F%AF%E7%94%A8" rel="nofollow" title="3.2验证office组件是否不可用">3.2验证office组件是否不可用</a></p> 
<p id="3.3%E9%AA%8C%E8%AF%81office%E7%BB%84%E4%BB%B6%E6%98%AF%E5%90%A6%E5%8F%AF%E7%94%A8-toc" style="margin-left:40px;"><a href="#3.3%E9%AA%8C%E8%AF%81office%E7%BB%84%E4%BB%B6%E6%98%AF%E5%90%A6%E5%8F%AF%E7%94%A8" rel="nofollow" title="3.3验证office组件是否可用">3.3验证office组件是否可用</a></p> 
<p id="%E5%9B%9B%E3%80%81%E8%B8%A9%E5%9D%91-------officeHome%20must%20exist%20and%20be%20a%20directory-toc" style="margin-left:0px;"><a href="#%E5%9B%9B%E3%80%81%E8%B8%A9%E5%9D%91-------officeHome%20must%20exist%20and%20be%20a%20directory" rel="nofollow" title="四、踩坑-------officeHome must exist and be a directory">四、踩坑-------officeHome must exist and be a directory</a></p> 
<p id="%E4%BA%94%E3%80%81%E7%A8%8B%E5%BA%8F%E4%BC%98%E5%8C%96-toc" style="margin-left:0px;"><a href="#%E4%BA%94%E3%80%81%E7%A8%8B%E5%BA%8F%E4%BC%98%E5%8C%96" rel="nofollow" title="五、程序优化">五、程序优化</a></p> 
<p id="5.1%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80dox%E6%96%87%E4%BB%B6%EF%BC%8C%E4%BD%BF%E7%94%A8KFV%E7%A8%8B%E5%BA%8F%E8%BD%AC%E4%B9%89%E6%88%90pdf%E6%97%B6%E4%BC%9A%E6%8A%A5500%EF%BC%8C%E4%BD%93%E9%AA%8C%E6%84%9F%E5%BE%88%E7%B3%9F%E7%B3%95%EF%BC%8C%E6%88%91%E8%BF%99%E9%87%8C%E9%80%9A%E8%BF%87%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7%EF%BC%8C%E8%BF%94%E5%9B%9EI%E2%80%98m%20sorry%E5%9B%BE%E5%83%8F-toc" style="margin-left:40px;"><a href="#5.1%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80dox%E6%96%87%E4%BB%B6%EF%BC%8C%E4%BD%BF%E7%94%A8KFV%E7%A8%8B%E5%BA%8F%E8%BD%AC%E4%B9%89%E6%88%90pdf%E6%97%B6%E4%BC%9A%E6%8A%A5500%EF%BC%8C%E4%BD%93%E9%AA%8C%E6%84%9F%E5%BE%88%E7%B3%9F%E7%B3%95%EF%BC%8C%E6%88%91%E8%BF%99%E9%87%8C%E9%80%9A%E8%BF%87%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7%EF%BC%8C%E8%BF%94%E5%9B%9EI%E2%80%98m%20sorry%E5%9B%BE%E5%83%8F" rel="nofollow" title="5.1无法打开dox文件，使用KFV程序转义成pdf时会报500，体验感很糟糕，我这里通过异常捕获，返回I‘m sorry图像">5.1无法打开dox文件，使用KFV程序转义成pdf时会报500，体验感很糟糕，我这里通过异常捕获，返回I‘m sorry图像</a></p> 
<p id="5.2%E6%96%87%E4%BB%B6%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%EF%BC%8C%E6%8A%A5404-toc" style="margin-left:40px;"><a href="#5.2%E6%96%87%E4%BB%B6%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%EF%BC%8C%E6%8A%A5404" rel="nofollow" title="5.2文件无法打开，报404">5.2文件无法打开，报404</a></p> 
<p id="5.3%E8%A7%A3%E5%86%B3%E6%96%87%E4%BB%B6%E7%BC%96%E8%AF%91%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98-toc" style="margin-left:40px;"><a href="#5.3%E8%A7%A3%E5%86%B3%E6%96%87%E4%BB%B6%E7%BC%96%E8%AF%91%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98" rel="nofollow" title="5.3解决文件编译乱码问题">5.3解决文件编译乱码问题</a></p> 
<p id="%E2%80%8B%E6%80%BB%E7%BB%93-toc" style="margin-left:0px;"><a href="#%E2%80%8B%E6%80%BB%E7%BB%93" rel="nofollow" title="​总结">​总结</a></p> 
<hr id="hr-toc"> 
<h2 id="%E5%89%8D%E8%A8%80">前言</h2> 
<p>       提示：本人从2021年7月份开始使用开源框架kkFileView到现在已经过去了5个多月了，总提来讲kkFileView的功能很强大，由于需要集成依赖第三方软件openboffice或liberoffice,不可避免的会给开发人员或者使用部署人员带来很多兼容性和环境配置问题，我在这里踩了很多坑，这里做个总结,下面的kkFileView就简称KFV了</p> 
<p>提示：以下是本篇文章正文内容，下面案例可供参考</p> 
<h2 id="%E4%B8%80%E3%80%81%E4%BE%9D%E8%B5%96%E9%80%89%E6%8B%A9">一、依赖选择</h2> 
<p>        示例：kkFileView需要第三方软件的功能支撑，因此如果选择的软件不符合程序能够接受的范围就会带来冲突，下面附上官方说明：</p> 
<pre><code>Java: 1.8+
Maven：3.4+
OpenOffice或LiberOffice(Windows下已内置，CentOS或Ubuntu下会自动下载安装，MacOS下需要自行安装)</code></pre> 
<p>不过这些提示并不精确，查看类OfficeUtils中getDefaultOfficeHome方法后定位到更精准范围，如下图：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/0b/e9/CVwq4XPb_o.png"></p> 
<p>windows下KFV自带完美兼容的windows-office，这里就不做说明了；<br> linux下可以选择openoffice4，而libreoffice可以选择使用libreoffice6.0-7.2版本；<br> 作者这里选择的是libreoffice7.1版本的软件来兼容的KFV，下载地址如下：</p> 
<p><a class="link-info" href="https://downloadarchive.documentfoundation.org/libreoffice/old/7.1.4.2/rpm/x86_64/LibreOffice_7.1.4.2_Linux_x86-64_rpm.tar.gz" rel="nofollow">https://downloadarchive.documentfoundation.org/libreoffice/old/7.1.4.2/rpm/x86_64/LibreOffice_7.1.4.2_Linux_x86-64_rpm.tar.gz</a></p> 
<p><a class="link-info" href="https://downloadarchive.documentfoundation.org/libreoffice/old/7.1.4.2/rpm/x86_64/LibreOffice_7.1.4.2_Linux_x86-64_rpm_langpack_zh-CN.tar.gz" rel="nofollow">https://downloadarchive.documentfoundation.org/libreoffice/old/7.1.4.2/rpm/x86_64/LibreOffice_7.1.4.2_Linux_x86-64_rpm_langpack_zh-CN.tar.gz</a></p> 
<p>这两个分别下载LibreOffice_7.1.4.2_Linux_x86-64_rpm.tar.gz 和LibreOffice_7.1.4.2_Linux_x86-64_rpm_langpack_zh-CN.tar.gz文件，前面提供启动程序，后面提供中文语言包</p> 
<p>第三个需要下载的是KFV官网的linux能运行的jar包下载地址如下：（https://kkfileview.keking.cn）</p> 
<p><a class="link-info" href="https://kkfileview.keking.cn/kkFileView-4.0.0.tar.gz" rel="nofollow">https://kkfileview.keking.cn/kkFileView-4.0.0.tar.gz</a></p> 
<h2 id="%E4%BA%8C%E3%80%81%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85">二、环境部署安装</h2> 
<h3 id="2.1%E8%A7%A3%E5%8E%8B">2.1解压</h3> 
<p>将下载好的程序传到某个目录下，我这里的文件目录是</p> 
<pre><code>/export/server/LibreOffice_7.1.4.2_Linux_x86-64_rpm.tar.gz
/export/server/LibreOffice_7.1.4.2_Linux_x86-64_rpm_langpack_zh-CN.tar.gz
/export/server/kkFileView-4.0.0.tar.gz</code></pre> 
<p>接下来需要解压文件：<br> 使用命令如下：</p> 
<p>#进入解压文件位置后</p> 
<pre><code> tar -zxvf  /export/server/LibreOffice_7.1.4.2_Linux_x86-64_rpm.tar.gz 
 tar -zxvf  /export/server/LibreOffice_7.1.4.2_Linux_x86-64_rpm_langpack_zh-CN.tar.gz
 tar -zxvf  /export/server/kkFileView-4.0.0.tar.gz</code></pre> 
<h3 id="2.2%E5%90%AF%E5%8A%A8%E7%A8%8B%E5%BA%8F">2.2启动程序</h3> 
<p><br> 解压后目录结构如图所示;</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/c0/c3/1tGTVL3V_o.png"></p> 
<p> 进入 cd ./kkFileView4.0.0/bin ，然后执行命令sh ./startup.sh sh ./showlog.sh<br>  这个时候你就会发现第一个坑：office.home配置有误</p> 
<h3 id="2.3%E8%B8%A9%E5%9D%91--------office.home%E9%85%8D%E7%BD%AE%E6%9C%89%E8%AF%AF">2.3踩坑--------office.home配置有误</h3> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/b8/5c/DJYKlmna_o.png"></p> 
<p>这个是由于KFV的加载程序找不到office.home,在OfficePluginManager类的，startOfficeManager方法下，源码截图：</p> 
<p><img alt="" src="https://images2.imgbox.com/44/6d/VoHlpQnQ_o.png"><br> OfficeUtils.getDefaultHome()方法是获取 配置文件application.properties的office.home的加载位置，这个不配置的话，在linux中有启动程序会扫描openoffice、libreoffice文件夹自动获取并加载，因此不是导致office.home出现的主要原因，主要原因是上面我们下载的2个程序并没有编译生成可被KFV扫描的程序。</p> 
<h3 id="%C2%A02.4%E8%B8%A9%E5%9D%91%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3">2.4踩坑问题解决</h3> 
<p>编译LibreOffice_7.1.4.2_Linux_x86-64_rpm和LibreOffice_7.1.4.2_Linux_x86-64_rpm_langpack_zh-CN文件，命令如下：<br>  </p> 
<pre><code>#进入到/export/server目录
sudo yum install -y  ./LibreOffice_7.1.4.2_Linux_x86-64_rpm/RPMS/*.rpm
#然后再执行
sudo yum install -y  ./LibreOffice_7.1.4.2_Linux_x86-64_rpm_langpack_zh-CN/RPMS/*.rpm</code></pre> 
<p><br> 这里还要很多命令，如卸载libreoffice程序语句：<br> sudo yum remove libreoffice7.1-*<br> 这里的7.1是版本号</p> 
<p>这个时候我们再执行启动程序./startip.sh突然发现程序启动成功，这是由于我们编译后会在<br> 目录/opt下创建了libreoffice7.1文件，如图所示:</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/cf/45/YM2l6P4X_o.png"></p> 
<p> 到这里我们初步成功似乎很完美了，接下来我为你表演各种坑，如下：</p> 
<h2 id="%E4%B8%89%E3%80%81%E8%B8%A9%E5%9D%91-------OFFICE%E7%BB%84%E4%BB%B6%E4%B8%8D%E5%8F%AF%E7%94%A8">三、踩坑-------OFFICE组件不可用</h2> 
<h3 id="3.1%E7%A1%AE%E8%AE%A4%E6%98%AF%E5%90%A6%E6%98%AFoffice%E7%BB%84%E4%BB%B6%E7%9A%84%E9%97%AE%E9%A2%98">3.1确认是否是office组件的问题</h3> 
<p>大部分office组件不可用是由于未关闭office程序导致的，先验证office程序是否关闭：</p> 
<pre><code>ps -ef |grep office</code></pre> 
<p>如果有就说明，office程序未关闭，我这里提供了一个./shutdown.sh脚本，可用拿着用，替换KFV的./shutdown.sh即可</p> 
<pre><code>#!/bin/bash
FIDS=`ps -ef|grep kkFileView-4.0.0.jar|awk '{print $2}'`
PIDS=`ps -ef|grep office|awk '{print $2}'`

if [ -z "$FIDS" ]; then
    echo "ERROR: The kkFileView does not started!"
    exit 1
fi
for FID in $FIDS ; do
    kill -9 $FID
done
echo "OK!"
echo "FID: $FIDS"

if [ -z "$PIDS" ]; then
    echo "ERROR: The office does not started!"
    exit 1
fi
for PID in $PIDS ; do
    kill -9 $PID
done
echo "OK!"
echo "PID: $PIDS"

</code></pre> 
<p><br> 如果你发现office已经关闭了还是出现以上问题，接下来你需要注释掉如下代码，再编译上传到Linux运行加载判断是否是KFV的office监听程序异常导致的。我测试的时候，发现绝大部分office.home报错都是这个检测程序导致的。</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/43/7d/aIijgRuT_o.png"></p> 
<p> </p> 
<p>如图所示，注释掉OfficeProcess.java程序start方法下的，用来判断soffice.bin程序是否存在，注释掉后如果程序还是启动不起来，就说明是office组件的问题了，不过一般都不是组件的问题，下面是来检测组件是否存在问题的步骤3：</p> 
<h3 id="3.2%E9%AA%8C%E8%AF%81office%E7%BB%84%E4%BB%B6%E6%98%AF%E5%90%A6%E4%B8%8D%E5%8F%AF%E7%94%A8">3.2验证office组件是否不可用</h3> 
<p>第一步验证文件是否安装成功<br> 执行以下命令：</p> 
<pre><code>/opt/libreoffice7.1/program/soffice -help</code></pre> 
<p>截图如下：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/84/66/wiw9l2T7_o.png"></p> 
<p> </p> 
<p>这里讲解以下为什么需要执行这条语句，主要是验证soffice.exe程序是否可用，KFV这里有对该程序的启动代码，如下所示：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/e0/65/TjXg0LcP_o.png"></p> 
<p>也就是说程序启动时会获取soffice.bin程序和启动配置文件application.properyies的office.plugin.server.ports = 2001,2002端口号进行加载，<br> 这也就是starting process with acceptString ‘%s’ and profileDir '%s’等等提示语句该类为OfficeProcess。 </p> 
<p>当我们发现-help语句执行成功后，等于程序成功编译完成了，接下来我们需要判断程序是否能用</p> 
<h3 id="3.3%E9%AA%8C%E8%AF%81office%E7%BB%84%E4%BB%B6%E6%98%AF%E5%90%A6%E5%8F%AF%E7%94%A8">3.3验证office组件是否可用</h3> 
<p>上传一个excel文件one.xlsx到/opt,通过libreoffice程序转换成pdf文件，</p> 
<p>#准备一个文件夹做输出文件夹output，我这里的是rh</p> 
<pre><code>#准备一个文件夹做输出文件夹output，我这里的是rh
 /opt/libreoffice7.1/program/soffice --headless --convert-to pdf:writer_pdf_Export /opt/one.xlsx --outdir /opt/rh/
</code></pre> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/50/f9/vZlt3DBS_o.png"></p> 
<p> </p> 
<p>在浏览器打开，如图所示：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/47/0c/kGxT3g4J_o.png"></p> 
<p> </p> 
<p>发现office程序没问题了，以上流程只要有一出流程加载有问题就可能导致office组件真的存在问题，所以只要程序出错，我建议删除–重装大法。</p> 
<p>为了保险起见我建议配置环境变量，操作如下</p> 
<pre><code>vi /etc/profile

export PATH=$PATH:/opt/libreoffice7.1/program

#保存退出
source /etc/profile

#执行成功代表配置完成
soffice --version
</code></pre> 
<p><br> 到这一步后为避免程序出现office组件不可用的情况，需要进行如下操作</p> 
<pre><code>#进入kkFileView目录
cd conf/
vi application.properties
#修改office.home
office.home=/opt/liberoffice7.1
</code></pre> 
<p>然后重新启动，接下来有惊喜</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/4c/b3/joVXBLs3_o.png"></p> 
<p> </p> 
<h2 id="%E5%9B%9B%E3%80%81%E8%B8%A9%E5%9D%91-------officeHome%20must%20exist%20and%20be%20a%20directory">四、踩坑-------officeHome must exist and be a directory</h2> 
<p>如图所示：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/e5/aa/adh5QDNv_o.png"></p> 
<p>出现这个bug的原因是我们配置office.home时office.home=/opt/liberoffice7.1的后面有空格即占位符，导致程序并不是访问的指定路径，删除掉空格后即可成功，如图：（空格导致的程序报错）</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/a8/2a/GVIdjUYP_o.png"> </p> 
<p>至此程序导致的office.home原因完美解决</p> 
<h2 id="%E4%BA%94%E3%80%81%E7%A8%8B%E5%BA%8F%E4%BC%98%E5%8C%96">五、程序优化</h2> 
<h3 id="5.1%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80dox%E6%96%87%E4%BB%B6%EF%BC%8C%E4%BD%BF%E7%94%A8KFV%E7%A8%8B%E5%BA%8F%E8%BD%AC%E4%B9%89%E6%88%90pdf%E6%97%B6%E4%BC%9A%E6%8A%A5500%EF%BC%8C%E4%BD%93%E9%AA%8C%E6%84%9F%E5%BE%88%E7%B3%9F%E7%B3%95%EF%BC%8C%E6%88%91%E8%BF%99%E9%87%8C%E9%80%9A%E8%BF%87%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7%EF%BC%8C%E8%BF%94%E5%9B%9EI%E2%80%98m%20sorry%E5%9B%BE%E5%83%8F">5.1无法打开dox文件，使用KFV程序转义成pdf时会报500，体验感很糟糕，我这里通过异常捕获，返回I‘m sorry图像</h3> 
<p>代码如下：</p> 
<p><img alt="" src="https://images2.imgbox.com/87/ca/tJo3hbOi_o.png"><br> 位置：OfficeFilePreviewImpl.class<br> 步骤：第一步添加日志程序：</p> 
<pre><code>  private final Logger logger = LoggerFactory.getLogger(OfficeFilePreviewImpl.class);

##########################
  try {
                    officeToPdfService.openOfficeToPDF(filePath, outFilePath);
                    if (isHtml) {
                        // 对转换后的文件进行操作(改变编码方式)
                        fileHandlerService.doActionConvertedFile(outFilePath);
                    }
                    if (ConfigConstants.isCacheEnabled()) {
                        // 加入缓存
                        fileHandlerService.addConvertedFile(pdfName, fileHandlerService.getRelativePath(outFilePath));
                    }
                }catch (Exception e){
                    logger.error("文件解析异常，请检测文件是否可用，file name is {} and error is {}",fileName,e.getMessage());
                    String errorMsg = "文件解析异常，请检测文件是否可用";
                    return otherFilePreview.notSupportedFile(model, errorMsg);
                }
</code></pre> 
<p><br> 其它位置需要捕获的同理。</p> 
<h3 id="5.2%E6%96%87%E4%BB%B6%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%EF%BC%8C%E6%8A%A5404">5.2文件无法打开，报404</h3> 
<p>这是由于通过缓存的</p> 
<p><img alt="" src="https://images2.imgbox.com/c3/d9/mnzEoCgS_o.png"><br> 方式进行的判断，可以是redis，也可以是Map等等，但是这些严格意义上来讲没错，但是实际上缺并不好用，<br> 我这里修改成最简单的文件判断，如下：</p> 
<pre><code>File file = new File(outFilePath);
if(!file.exists){
}
</code></pre> 
<h3 id="5.3%E8%A7%A3%E5%86%B3%E6%96%87%E4%BB%B6%E7%BC%96%E8%AF%91%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98">5.3解决文件编译乱码问题</h3> 
<p>上面的one.xlsx文件转换成one.pdf后发现有部分数据已经出现了乱码，而KFV提供了很强的帮助来针对文件乱码问题。步骤如下：<br> fonts文件的来源：windows下的C:\Windows\Fonts下文件拷贝就行了，然后放到chinese目录下。</p> 
<pre><code>cd /usr/share/fonts

mkdir chinese

chmod -R 755 /usr/share/fonts/chinese

vi /etc/fonts/fonts.conf

&lt;dir&gt;/usr/share/fonts/chinese&lt;/dir&gt;
</code></pre> 
<pre><code>6、按 esc键进入安全模式，输出 :wq 保存更改推出，如下图

7、fc-cache   更新更改生效 刷新缓存

8、fc-list   查看是否成功
</code></pre> 
<p>如图所示：</p> 
<h2 id="%E2%80%8B%E6%80%BB%E7%BB%93"><img alt="" src="https://images2.imgbox.com/0c/e8/YecqxN1e_o.png"><br> 总结</h2> 
<p>提示：这里对文章进行总结：<br> 如果后面还遇到一些坑，也会继续补充的。<br><br> ————————————————<br> 版权声明：本文为CSDN博主「墨绳」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br> 原文链接：https://blog.csdn.net/weixin_43206536/article/details/121676962</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3de5aabfa3aa2eb6f95e1e1e996d3c4a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Unity渲染(一):Shader着色器基础入门之纯色Shader</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6705cc6aa3e12a408aea91b965d9d5bf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【R作图基本图形 - 核密度图，箱线图，点图】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>