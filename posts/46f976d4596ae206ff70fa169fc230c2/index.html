<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>第10章 FreeRTOS - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="第10章 FreeRTOS" />
<meta property="og:description" content="ESP32 FREERTOS 打印ESP32任务 menuconfig中，打开FreeRTOS的trace打印功能
menuconfig中，增加app_main主任务的栈大小
测试代码
ESP32最小工程 #include &lt;stdio.h&gt; #include &#34;freertos/FreeRTOS.h&#34; #include &#34;freertos/task.h&#34; static void print_task(void) { char buffer[512] = {0}; printf(&#34;%s\t\t%s\t%s\t%s\t%s\t%s\n&#34;, &#34;任务名&#34;, &#34;状态&#34;, &#34;优先级&#34;, &#34;堆栈&#34;, &#34;序号&#34;, &#34;CPU&#34;); vTaskList(buffer); printf(&#34;%s&#34;, buffer); } void app_main(void) { print_task(); } 运行结果
ESP32最小工程的任务：
WIFI扫描工程
在WIFI扫描功能最后打印FreeRTOS任务 #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &#34;freertos/FreeRTOS.h&#34; #include &#34;freertos/task.h&#34; #include &#34;esp_log.h&#34; #include &#34;nvs.h&#34; #include &#34;nvs_flash.h&#34; #include &#34;esp_wifi.h&#34; #include &#34;esp_event.h&#34; #define MAX_SCAN_NUM 20 const char *TAG = &#34;WIFI&#34;; void print_task(void) { char buffer[512] = {0}; printf(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/46f976d4596ae206ff70fa169fc230c2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-16T22:47:47+08:00" />
<meta property="article:modified_time" content="2023-01-16T22:47:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">第10章 FreeRTOS</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="ESP32_FREERTOS_0"></a>ESP32 FREERTOS</h2> 
<h3><a id="ESP32_1"></a>打印ESP32任务</h3> 
<ol><li>menuconfig中，打开FreeRTOS的trace打印功能<br> <img src="https://images2.imgbox.com/89/c0/m9JRAf0o_o.jpg" alt="menuconfig中配置trace"></li><li>menuconfig中，增加app_main主任务的栈大小<br> <img src="https://images2.imgbox.com/af/3e/F8IEagEA_o.jpg" alt="menuconfig中配置主任务堆栈"></li><li>测试代码<br> <strong>ESP32最小工程</strong></li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/FreeRTOS.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/task.h"</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">print_task</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\t\t%s\t%s\t%s\t%s\t%s\n"</span><span class="token punctuation">,</span> <span class="token string">"任务名"</span><span class="token punctuation">,</span> <span class="token string">"状态"</span><span class="token punctuation">,</span> <span class="token string">"优先级"</span><span class="token punctuation">,</span> <span class="token string">"堆栈"</span><span class="token punctuation">,</span> <span class="token string">"序号"</span><span class="token punctuation">,</span> <span class="token string">"CPU"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vTaskList</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">app_main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">print_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>运行结果<br> <strong>ESP32最小工程的任务：</strong><br> <img src="https://images2.imgbox.com/fa/0f/UMUteOjN_o.jpg" alt="打印全部任务信息"></li><li>WIFI扫描工程<br> 在WIFI扫描功能最后打印FreeRTOS任务</li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/FreeRTOS.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/task.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"esp_log.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"nvs.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"nvs_flash.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"esp_wifi.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"esp_event.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_SCAN_NUM</span>    <span class="token expression"><span class="token number">20</span></span></span>

<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>TAG <span class="token operator">=</span> <span class="token string">"WIFI"</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">print_task</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\t\t%s\t%s\t%s\t%s\t%s\n"</span><span class="token punctuation">,</span> <span class="token string">"任务名"</span><span class="token punctuation">,</span> <span class="token string">"状态"</span><span class="token punctuation">,</span> <span class="token string">"优先级"</span><span class="token punctuation">,</span> <span class="token string">"堆栈"</span><span class="token punctuation">,</span> <span class="token string">"序号"</span><span class="token punctuation">,</span> <span class="token string">"CPU"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vTaskList</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">app_main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"0. 初始化NVS存储"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">nvs_flash_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"1. WiFi初始化阶段"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_netif_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_event_loop_create_default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_netif_create_default_wifi_sta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">wifi_init_config_t</span> wifi_config <span class="token operator">=</span> <span class="token function">WIFI_INIT_CONFIG_DEFAULT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wifi_config<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"2. WiFi配置阶段"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_set_mode</span><span class="token punctuation">(</span>WIFI_MODE_STA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    

    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"3. WiFi启动阶段"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"4. WiFi扫描阶段"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">wifi_country_t</span> ccode_config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>cc <span class="token operator">=</span> <span class="token string">"CN"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>schan <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>nchan <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>policy <span class="token operator">=</span> WIFI_COUNTRY_POLICY_AUTO<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WiFi scan start...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_set_country</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ccode_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_start</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">uint16_t</span> ap_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_get_ap_num</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ap_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> number <span class="token operator">=</span> MAX_SCAN_NUM<span class="token punctuation">;</span>
    <span class="token class-name">wifi_ap_record_t</span> ap_records<span class="token punctuation">[</span>MAX_SCAN_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>ap_records<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ap_records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_get_ap_records</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>number<span class="token punctuation">,</span> ap_records<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-5s %-30s %-10s %-5s %-5s\n"</span><span class="token punctuation">,</span> <span class="token string">"seq"</span><span class="token punctuation">,</span> <span class="token string">"ssid"</span><span class="token punctuation">,</span> <span class="token string">"channel"</span><span class="token punctuation">,</span> <span class="token string">"rssi"</span><span class="token punctuation">,</span> <span class="token string">"mac"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-5d %-30s %-10d %-5d %02x:%02x:%02x:%02x:%02x:%02x\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ssid<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>primary<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>rssi<span class="token punctuation">,</span>
            ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WiFi scan done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">print_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行结果：<br> <img src="https://images2.imgbox.com/f0/19/BPXsYBoh_o.jpg" alt="扫描任务"></p> 
<h4><a id="_104"></a>文档和代码的对应关系</h4> 
<ol><li>任务对应<br> <img src="https://images2.imgbox.com/ed/13/Qmhv7jeO_o.jpg" alt="任务与文档对应关系"></li><li>时序对应<br> <img src="https://images2.imgbox.com/de/ed/cU73d6Gi_o.jpg" alt="任务与文档对应的启动流程"></li></ol> 
<h4><a id="ESP32_EventLoop_109"></a>ESP32 EventLoop</h4> 
<p><a href="https://docs.espressif.com/projects/esp-idf/zh_CN/v4.4.3/esp32s3/api-reference/system/esp_event.html" rel="nofollow">EventLoop官方文档链接</a></p> 
<ol><li>常用的API<br> <img src="https://images2.imgbox.com/4a/8a/TyRrQJPS_o.jpg" alt="EventLoop API"></li><li>官方文档中给出了参考示例</li></ol> 
<pre><code class="prism language-c"><span class="token comment">// 1. Define the event handler</span>
<span class="token keyword">void</span> <span class="token function">run_on_event</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> handler_arg<span class="token punctuation">,</span> <span class="token class-name">esp_event_base_t</span> base<span class="token punctuation">,</span> <span class="token class-name">int32_t</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> event_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Event handler logic</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>使用<code>esp_event_handler_register()</code>函数，来执行WIFI扫描。这里有两个特别值得注意的宏定义：<br> esp_event_base.h</li></ol> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>  <span class="token class-name">esp_event_base_t</span><span class="token punctuation">;</span> <span class="token comment">/**&lt; unique pointer to a subsystem that exposes events */</span>

<span class="token comment">// Defines for registering/unregistering event handlers</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESP_EVENT_ANY_BASE</span>     <span class="token expression"><span class="token constant">NULL</span>             </span><span class="token comment">/**&lt; register handler for any event base */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESP_EVENT_ANY_ID</span>       <span class="token expression"><span class="token operator">-</span><span class="token number">1</span>               </span><span class="token comment">/**&lt; register handler for any event id */</span></span>
</code></pre> 
<p>测试代码中打印了EVENT事件base和id</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/FreeRTOS.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/task.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"esp_log.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"nvs.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"nvs_flash.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"esp_wifi.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"esp_event.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_SCAN_NUM</span>    <span class="token expression"><span class="token number">20</span></span></span>

<span class="token keyword">void</span> <span class="token function">run_on_event</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> handler_arg<span class="token punctuation">,</span> <span class="token class-name">esp_event_base_t</span> base<span class="token punctuation">,</span> <span class="token class-name">int32_t</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> event_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">ESP_LOGE</span><span class="token punctuation">(</span><span class="token string">"EVENT_HANDLE"</span><span class="token punctuation">,</span> <span class="token string">"base:%s id:%d"</span><span class="token punctuation">,</span> base<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">app_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span><span class="token string">"APP_TASK"</span><span class="token punctuation">,</span> <span class="token string">"APP TASK创建完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_event_handler_register</span><span class="token punctuation">(</span>ESP_EVENT_ANY_BASE<span class="token punctuation">,</span> ESP_EVENT_ANY_ID<span class="token punctuation">,</span> run_on_event<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">/</span> portTICK_PERIOD_MS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">app_main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span><span class="token string">"MAIN_TASK"</span><span class="token punctuation">,</span> <span class="token string">"0. 初始化NVS存储"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">nvs_flash_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span><span class="token string">"MAIN_TASK"</span><span class="token punctuation">,</span> <span class="token string">"1. WiFi初始化阶段"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_netif_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_event_loop_create_default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_netif_create_default_wifi_sta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">wifi_init_config_t</span> wifi_config <span class="token operator">=</span> <span class="token function">WIFI_INIT_CONFIG_DEFAULT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wifi_config<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">xTaskCreate</span><span class="token punctuation">(</span>app_task<span class="token punctuation">,</span> <span class="token string">"app_task"</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span><span class="token string">"MAIN_TASK"</span><span class="token punctuation">,</span> <span class="token string">"2. WiFi配置阶段"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_set_mode</span><span class="token punctuation">(</span>WIFI_MODE_STA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span><span class="token string">"MAIN_TASK"</span><span class="token punctuation">,</span> <span class="token string">"3. WiFi启动阶段"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span><span class="token string">"MAIN_TASK"</span><span class="token punctuation">,</span> <span class="token string">"4. WiFi扫描阶段"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">wifi_country_t</span> ccode_config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>cc <span class="token operator">=</span> <span class="token string">"CN"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>schan <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>nchan <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>policy <span class="token operator">=</span> WIFI_COUNTRY_POLICY_AUTO<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WiFi scan start...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_set_country</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ccode_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_start</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">uint16_t</span> ap_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_get_ap_num</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ap_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> number <span class="token operator">=</span> MAX_SCAN_NUM<span class="token punctuation">;</span>
    <span class="token class-name">wifi_ap_record_t</span> ap_records<span class="token punctuation">[</span>MAX_SCAN_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>ap_records<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ap_records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_get_ap_records</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>number<span class="token punctuation">,</span> ap_records<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-5s %-30s %-10s %-5s %-5s\n"</span><span class="token punctuation">,</span> <span class="token string">"seq"</span><span class="token punctuation">,</span> <span class="token string">"ssid"</span><span class="token punctuation">,</span> <span class="token string">"channel"</span><span class="token punctuation">,</span> <span class="token string">"rssi"</span><span class="token punctuation">,</span> <span class="token string">"mac"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-5d %-30s %-10d %-5d %02x:%02x:%02x:%02x:%02x:%02x\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ssid<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>primary<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>rssi<span class="token punctuation">,</span>
            ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WiFi scan done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">vTaskDelete</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>打印事件的base和id。可以看到<font color="red">图中红字部分</font>打印的base为字符串WIFI_EVENT，id分别为2和1。<br> <img src="https://images2.imgbox.com/c5/e5/TCZuf1bx_o.jpg" alt="打印Event事件base和id"><br> <strong><font color="red">这里的字符串WIFI_EVENT和ID=2 ID:1表示什么意思?</font></strong><br> <img src="https://images2.imgbox.com/08/3c/v7uAFQeZ_o.jpg" alt="WIFI启动过程"><br> 参考官方给出的启动过程，打印WiFi启动阶段后，打印了ID:2，猜测ID:2应该是WIFI_EVENT_STA_START；而在打印了WiFi scan start后，打印了ID:1，猜测ID:1应该是完成扫描。<br> <font color="red">我们的猜测对不对？要看官方文档</font><br> 3. 官方文档中的事件描述<br> <a href="https://docs.espressif.com/projects/esp-idf/zh_CN/v4.4.3/esp32s3/api-guides/wifi.html?highlight=wifi_event_sta_start#wifi-event-sta-start" rel="nofollow">官网事件描述链接</a><br> 官网给出的WIFI事件<br> <img src="https://images2.imgbox.com/e4/9f/VnFUqwNy_o.jpg" alt="WIFI事件"><br> 对应的代码：<code>esp_wifi_types.h</code></p> 
<pre><code class="prism language-c"><span class="token comment">/** WiFi event declarations */</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
    WIFI_EVENT_WIFI_READY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>           <span class="token comment">/**&lt; ESP32 WiFi ready */</span>
    WIFI_EVENT_SCAN_DONE<span class="token punctuation">,</span>                <span class="token comment">/**&lt; ESP32 finish scanning AP */</span>
    WIFI_EVENT_STA_START<span class="token punctuation">,</span>                <span class="token comment">/**&lt; ESP32 station start */</span>
    WIFI_EVENT_STA_STOP<span class="token punctuation">,</span>                 <span class="token comment">/**&lt; ESP32 station stop */</span>
    WIFI_EVENT_STA_CONNECTED<span class="token punctuation">,</span>            <span class="token comment">/**&lt; ESP32 station connected to AP */</span>
    WIFI_EVENT_STA_DISCONNECTED<span class="token punctuation">,</span>         <span class="token comment">/**&lt; ESP32 station disconnected from AP */</span>
    WIFI_EVENT_STA_AUTHMODE_CHANGE<span class="token punctuation">,</span>      <span class="token comment">/**&lt; the auth mode of AP connected by ESP32 station changed */</span>

    WIFI_EVENT_STA_WPS_ER_SUCCESS<span class="token punctuation">,</span>       <span class="token comment">/**&lt; ESP32 station wps succeeds in enrollee mode */</span>
    WIFI_EVENT_STA_WPS_ER_FAILED<span class="token punctuation">,</span>        <span class="token comment">/**&lt; ESP32 station wps fails in enrollee mode */</span>
    WIFI_EVENT_STA_WPS_ER_TIMEOUT<span class="token punctuation">,</span>       <span class="token comment">/**&lt; ESP32 station wps timeout in enrollee mode */</span>
    WIFI_EVENT_STA_WPS_ER_PIN<span class="token punctuation">,</span>           <span class="token comment">/**&lt; ESP32 station wps pin code in enrollee mode */</span>
    WIFI_EVENT_STA_WPS_ER_PBC_OVERLAP<span class="token punctuation">,</span>   <span class="token comment">/**&lt; ESP32 station wps overlap in enrollee mode */</span>

    WIFI_EVENT_AP_START<span class="token punctuation">,</span>                 <span class="token comment">/**&lt; ESP32 soft-AP start */</span>
    WIFI_EVENT_AP_STOP<span class="token punctuation">,</span>                  <span class="token comment">/**&lt; ESP32 soft-AP stop */</span>
    WIFI_EVENT_AP_STACONNECTED<span class="token punctuation">,</span>          <span class="token comment">/**&lt; a station connected to ESP32 soft-AP */</span>
    WIFI_EVENT_AP_STADISCONNECTED<span class="token punctuation">,</span>       <span class="token comment">/**&lt; a station disconnected from ESP32 soft-AP */</span>
    WIFI_EVENT_AP_PROBEREQRECVED<span class="token punctuation">,</span>        <span class="token comment">/**&lt; Receive probe request packet in soft-AP interface */</span>

    WIFI_EVENT_FTM_REPORT<span class="token punctuation">,</span>               <span class="token comment">/**&lt; Receive report of FTM procedure */</span>

    <span class="token comment">/* Add next events after this only */</span>
    WIFI_EVENT_STA_BSS_RSSI_LOW<span class="token punctuation">,</span>         <span class="token comment">/**&lt; AP's RSSI crossed configured threshold */</span>
    WIFI_EVENT_ACTION_TX_STATUS<span class="token punctuation">,</span>         <span class="token comment">/**&lt; Status indication of Action Tx operation */</span>
    WIFI_EVENT_ROC_DONE<span class="token punctuation">,</span>                 <span class="token comment">/**&lt; Remain-on-Channel operation complete */</span>

    WIFI_EVENT_STA_BEACON_TIMEOUT<span class="token punctuation">,</span>       <span class="token comment">/**&lt; ESP32 station beacon timeout */</span>

    WIFI_EVENT_MAX<span class="token punctuation">,</span>                      <span class="token comment">/**&lt; Invalid WiFi event ID */</span>
<span class="token punctuation">}</span> <span class="token class-name">wifi_event_t</span><span class="token punctuation">;</span>
</code></pre> 
<p>可以看到，与我们的之前的猜测一致。ID=2表示WIFI_EVENT_STA_START，ID=1表示WIFI_EVENT_SCAN_DONE。<br> 我们在event_handler中打印事件id，代码如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">run_on_event</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> handler_arg<span class="token punctuation">,</span> <span class="token class-name">esp_event_base_t</span> base<span class="token punctuation">,</span> <span class="token class-name">int32_t</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> event_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> WIFI_EVENT_SCAN_DONE<span class="token operator">:</span>
            <span class="token function">ESP_LOGE</span><span class="token punctuation">(</span><span class="token string">"EVENT_HANDLE"</span><span class="token punctuation">,</span> <span class="token string">"WIFI_EVENT_SCAN_DONE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> WIFI_EVENT_STA_START<span class="token operator">:</span>
            <span class="token function">ESP_LOGE</span><span class="token punctuation">(</span><span class="token string">"EVENT_HANDLE"</span><span class="token punctuation">,</span> <span class="token string">"WIFI_EVENT_STA_START"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行结果：<br> <img src="https://images2.imgbox.com/1b/d2/6odGSJev_o.jpg" alt="打印事件"><br> 4. 能不能在event_handler中，收到WIFI_EVENT_STA_START后执行WIFI扫描?<br> 测试代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">wifi_scan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">wifi_country_t</span> ccode_config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>cc <span class="token operator">=</span> <span class="token string">"CN"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>schan <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>nchan <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>policy <span class="token operator">=</span> WIFI_COUNTRY_POLICY_AUTO<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WiFi scan start...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_set_country</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ccode_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_start</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">uint16_t</span> ap_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_get_ap_num</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ap_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> number <span class="token operator">=</span> MAX_SCAN_NUM<span class="token punctuation">;</span>
    <span class="token class-name">wifi_ap_record_t</span> ap_records<span class="token punctuation">[</span>MAX_SCAN_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>ap_records<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ap_records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_get_ap_records</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>number<span class="token punctuation">,</span> ap_records<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Scan %d AP\n"</span><span class="token punctuation">,</span> ap_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-5s %-30s %-10s %-5s %-5s\n"</span><span class="token punctuation">,</span> <span class="token string">"seq"</span><span class="token punctuation">,</span> <span class="token string">"ssid"</span><span class="token punctuation">,</span> <span class="token string">"channel"</span><span class="token punctuation">,</span> <span class="token string">"rssi"</span><span class="token punctuation">,</span> <span class="token string">"mac"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-5d %-30s %-10d %-5d %02x:%02x:%02x:%02x:%02x:%02x\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ssid<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>primary<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>rssi<span class="token punctuation">,</span>
            ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WiFi scan done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">run_on_event</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> handler_arg<span class="token punctuation">,</span> <span class="token class-name">esp_event_base_t</span> base<span class="token punctuation">,</span> <span class="token class-name">int32_t</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> event_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> WIFI_EVENT_SCAN_DONE<span class="token operator">:</span>
            <span class="token function">ESP_LOGE</span><span class="token punctuation">(</span><span class="token string">"EVENT_HANDLE"</span><span class="token punctuation">,</span> <span class="token string">"WIFI_EVENT_SCAN_DONE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> WIFI_EVENT_STA_START<span class="token operator">:</span>
            <span class="token function">ESP_LOGE</span><span class="token punctuation">(</span><span class="token string">"EVENT_HANDLE"</span><span class="token punctuation">,</span> <span class="token string">"WIFI_EVENT_STA_START"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">wifi_scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行结果：可以看到，在收到WIFI_EVENT_STA_START执行wifi_scan，在sys_evt任务中产生了栈溢出。为什么?<br> 看下之前打印的任务堆栈，sys_ent只剩下1170字节，所以我们不能在event中处理比较复杂的工作。<br> <img src="https://images2.imgbox.com/c8/73/7aRIBXPd_o.jpg" alt="event_task栈溢出"><br> sys_evt默认堆栈配置：<br> <img src="https://images2.imgbox.com/ba/d5/BDSUs9Hr_o.jpg" alt="sys_event menuconfig"><br> 5. EVENT转任务<br> 5.1 直接临时创建任务，执行完之后删除</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">wifi_scan_start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">wifi_country_t</span> ccode_config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>cc <span class="token operator">=</span> <span class="token string">"CN"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>schan <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>nchan <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>policy <span class="token operator">=</span> WIFI_COUNTRY_POLICY_AUTO<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WiFi scan start...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_set_country</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ccode_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_start</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">wifi_scan_result</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint16_t</span> ap_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_get_ap_num</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ap_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> number <span class="token operator">=</span> MAX_SCAN_NUM<span class="token punctuation">;</span>
    <span class="token class-name">wifi_ap_record_t</span> ap_records<span class="token punctuation">[</span>MAX_SCAN_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>ap_records<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ap_records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp_wifi_scan_get_ap_records</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>number<span class="token punctuation">,</span> ap_records<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Scan %d AP\n"</span><span class="token punctuation">,</span> ap_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-5s %-30s %-10s %-5s %-5s\n"</span><span class="token punctuation">,</span> <span class="token string">"seq"</span><span class="token punctuation">,</span> <span class="token string">"ssid"</span><span class="token punctuation">,</span> <span class="token string">"channel"</span><span class="token punctuation">,</span> <span class="token string">"rssi"</span><span class="token punctuation">,</span> <span class="token string">"mac"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-5d %-30s %-10d %-5d %02x:%02x:%02x:%02x:%02x:%02x\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>ssid<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>primary<span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>rssi<span class="token punctuation">,</span>
            ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ap_records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bssid<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WiFi scan done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">scan_start_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">wifi_scan_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vTaskDelete</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">scan_result_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">wifi_scan_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vTaskDelete</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">run_on_event</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> handler_arg<span class="token punctuation">,</span> <span class="token class-name">esp_event_base_t</span> base<span class="token punctuation">,</span> <span class="token class-name">int32_t</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> event_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> WIFI_EVENT_SCAN_DONE<span class="token operator">:</span>
            <span class="token function">ESP_LOGE</span><span class="token punctuation">(</span><span class="token string">"EVENT_HANDLE"</span><span class="token punctuation">,</span> <span class="token string">"WIFI_EVENT_SCAN_DONE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">xTaskCreate</span><span class="token punctuation">(</span>scan_result_task<span class="token punctuation">,</span> <span class="token string">"scan_result_task"</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> WIFI_EVENT_STA_START<span class="token operator">:</span>
            <span class="token function">ESP_LOGE</span><span class="token punctuation">(</span><span class="token string">"EVENT_HANDLE"</span><span class="token punctuation">,</span> <span class="token string">"WIFI_EVENT_STA_START"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">xTaskCreate</span><span class="token punctuation">(</span>scan_start_task<span class="token punctuation">,</span> <span class="token string">"scan_start_task"</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行结果：<br> <img src="https://images2.imgbox.com/e8/4a/vaKERS9a_o.jpg" alt="WIFI扫描任务"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/389ef3f88eddcc98a5886d8c50d26444/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CKEditor 5 图片上传配置和图片上传返回参介绍</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/581416ddf844251699c480bf122581ac/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">第11章 EVENT</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>