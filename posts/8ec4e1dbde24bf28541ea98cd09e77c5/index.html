<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>php 实现stripe支付流程 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="php 实现stripe支付流程" />
<meta property="og:description" content="1.申请账号获取密钥key
2.申请创建商品，创建价格，创建支付，
//创建商品 public function create_product(){ $_key = self::STRIPE_KEY; $stripe = new \Stripe\StripeClient($_key); $arr = $stripe-&gt;products-&gt;create([ &#39;name&#39; =&gt; $goods_name, ]); // print_r($arr-&gt;id);die; $this-&gt;create_price($arr-&gt;id,$order_id,$is_source); } //创建价格 public function create_price($product_id,$order_id,$is_source){ //获取订单对应的商品价格 $goods_price = \db(&#39;order&#39;)-&gt;where(&#39;id&#39;,$order_id)-&gt;value(&#39;pay_money&#39;); $_key = self::STRIPE_KEY; $stripe = new \Stripe\StripeClient($_key); $price_arr = $stripe-&gt;prices-&gt;create([ &#39;unit_amount&#39; =&gt; $goods_price*100, //&#39;unit_amount&#39; =&gt; 1*100, &#39;currency&#39; =&gt; &#39;usd&#39;, &#39;tax_behavior&#39; =&gt; &#39;exclusive&#39;, //&#39;recurring&#39; =&gt; [&#39;interval&#39; =&gt; &#39;day&#39;], &#39;product&#39; =&gt; $product_id, ]); //print_r($price_arr-&gt;id);die; $this-&gt;actionStripe($price_arr-&gt;id,$order_id,$is_source); } /** * 创建stripe支付 */ public function actionStripe($price_id,$order_id,$is_source) { $_key = self::STRIPE_KEY; $domain = $this-&gt;request-&gt;domain(); //如果是AI订阅和AI作品打样的话 if ($is_source == 8 || $is_source == 9){ $cancel_url = &#39;https://ai." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/8ec4e1dbde24bf28541ea98cd09e77c5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-12T09:09:03+08:00" />
<meta property="article:modified_time" content="2023-09-12T09:09:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">php 实现stripe支付流程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>1.申请账号获取密钥key</p> 
<p></p> 
<p>2.申请创建商品，创建价格，创建支付，</p> 
<pre>//创建商品
public function create_product(){  
    $_key = self::STRIPE_KEY;
    $stripe = new \Stripe\StripeClient($_key);
    $arr =  $stripe-&gt;products-&gt;create([
        'name' =&gt; $goods_name,
    ]);
    //  print_r($arr-&gt;id);die;
    $this-&gt;create_price($arr-&gt;id,$order_id,$is_source);
}</pre> 
<pre>//创建价格
public function create_price($product_id,$order_id,$is_source){
    //获取订单对应的商品价格
    $goods_price = \db('order')-&gt;where('id',$order_id)-&gt;value('pay_money');
  
    $_key = self::STRIPE_KEY;
    $stripe = new \Stripe\StripeClient($_key);
    $price_arr = $stripe-&gt;prices-&gt;create([
       'unit_amount' =&gt; $goods_price*100,
        //'unit_amount' =&gt; 1*100,
        'currency' =&gt; 'usd',
        'tax_behavior' =&gt; 'exclusive',
        //'recurring' =&gt; ['interval' =&gt; 'day'],
        'product' =&gt; $product_id,
    ]);
    //print_r($price_arr-&gt;id);die;
    $this-&gt;actionStripe($price_arr-&gt;id,$order_id,$is_source);
}</pre> 
<pre>/**
 * 创建stripe支付
 */
public function actionStripe($price_id,$order_id,$is_source)
{
    $_key = self::STRIPE_KEY;

    $domain = $this-&gt;request-&gt;domain();

    //如果是AI订阅和AI作品打样的话
     if ($is_source == 8 || $is_source == 9){
         $cancel_url = 'https://ai.jewelryhunt.net/index/aimobile/mobile_list';
         $success_url = 'https://ai.jewelryhunt.net/index/aimobile/order';
     }else{
         $cancel_url = $domain.'/index/user/orders';
         $success_url = $domain . '/index/stripepay/success_info';
     }
    // stripe 生成订单

    \Stripe\Stripe::setApiKey($_key);
    $checkout_session = \Stripe\Checkout\Session::create([
        'line_items' =&gt; [[
            'price' =&gt; $price_id, // 产品id
            'quantity' =&gt; 1,
        ]],
        'mode' =&gt; 'payment',
        'success_url' =&gt; $success_url,
        'cancel_url' =&gt; $cancel_url,
        'automatic_tax' =&gt; [
            'enabled' =&gt; true,
        ],
        'metadata' =&gt; [
            'order_id' =&gt; $order_id,
        ],
    ]);
    header("HTTP/1.1 303 See Other");
    header("Location: " . $checkout_session-&gt;url);</pre> 
<p>}</p> 
<p></p> 
<p>4.配置回调事件</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/9c/45/57qcv7WW_o.png"></p> 
<p style="text-align:center;"></p> 
<p>5.</p> 
<pre>/**
 * stripe支付回调
 */
public function actionNotify()
{
    \think\Log::record('支付进来了', 'info');
    $_key = self::STRIPE_KEY;
    \Stripe\Stripe::setApiKey($_key);
    $payload = @file_get_contents('php://input');
    $event = null;
    try {
        $event = \Stripe\Event::constructFrom(
            json_decode($payload, true)
        );
    } catch(\UnexpectedValueException $e) {
        // Invalid payload
        http_response_code(400);
        exit();
    }
    // Handle the event
    \think\Log::record('event12333333' . var_export($event-&gt;type, true), 'info');
    switch ($event-&gt;type) {
        case 'checkout.session.completed':
            $succeeded = $event-&gt;data-&gt;object;
            $content = "=========".date('Y-m-d H:i:s',time())."==========\r\n";
            $content .= json_encode($succeeded);
            \think\Log::record('content=======' . var_export($content, true), 'info');
            $token = input('token', '');

            if ($succeeded-&gt;status == 'complete') {
                $order_id = $succeeded-&gt;metadata-&gt;order_id;
                $pay_type = input('pay_type', 1);
      
            }
            break;
        case 'checkout.session.async_payment_failed':
            \think\Log::record('pay is failed', 'info');
            break;
        default:
            echo 'Received unknown event type ' . $event-&gt;type;
            break;
    }
    \think\Log::record('done', 'info');
    return true;
}</pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/da0430d80d21dd2a24de6eff8b387be3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python文件读写模式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1797d6de7c728e8c8fad555f711e0373/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Unity动画☀️一、创建普通动画</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>