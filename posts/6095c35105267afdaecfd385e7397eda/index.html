<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>循环展开的方法--国科大体系结构 期末必考题 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="循环展开的方法--国科大体系结构 期末必考题" />
<meta property="og:description" content="如何进行循环展开，是胡老师体系结构课的一个重点，也是必考点。根据20年的经验，在助教汪老师的精心准备下，成功让很多小伙伴没有拿到分数，希望接下来的同学们加油。
听说 LoongArch 出了，我是不是白写了。。。
循环展开的意义 写在前面，我会在指令前加序号，同时在分析时直接用序号来描述指令。
进行循环展开，是为了尽量避免指令相关造成的流水线等待。
直奔题目而言，是通过将多次（大于等于两次）的循环指令展开为一次的循环指令，从而将数据相关消除。不考虑结构相关。
如
// 注： L.D S.D有时候写成 LDC1 SDC1 1 L.D F2, 0(R1) 2 MUL.D F4, F2, F0 // 第二条指令使用了第一条LD指令取数寄存器F2 3 L.D F6, 0(R2)	4 ADD.D F6, F4, F6 // 第四条指令使用了第三条LD指令取数寄存器F6，以及第二条指令的运算结果寄存器F4 5 S.D 0(R2), F6	// 第五条指令使用了第四条LD指令的运算结果寄存器F6 可以看到存在四组数据相关
1 和 2
2 和 4
3 和 4
4 和 5
按照课本中的延迟
延迟为n，两条相关指令中需要间隔n-1条不相关的指令才算达到循环展开的目的：消除数据相关。
即：
1 和 2 延迟为2，之间需要加上 1 条不相关指令
2 和 4 延迟为4，之间需要加上 2 条不相关指令" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/6095c35105267afdaecfd385e7397eda/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-29T12:03:10+08:00" />
<meta property="article:modified_time" content="2022-12-29T12:03:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">循环展开的方法--国科大体系结构 期末必考题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><em>如何进行循环展开，是胡老师体系结构课的一个重点，也是必考点。根据20年的经验，在助教汪老师的精心准备下，成功让很多小伙伴没有拿到分数，希望接下来的同学们加油。</em><br> <em>听说 LoongArch 出了，我是不是白写了。。。</em></p> 
<h3><a id="_3"></a>循环展开的意义</h3> 
<p><em>写在前面，我会在指令前加序号，同时在分析时直接用序号来描述指令。</em></p> 
<p>进行循环展开，是为了尽量避免指令相关造成的流水线等待。<br> 直奔题目而言，是通过将多次（大于等于两次）的循环指令展开为一次的循环指令，从而将数据相关消除。不考虑结构相关。<br> 如</p> 
<pre><code class="prism language-c"><span class="token comment">// 注： L.D S.D有时候写成 LDC1 SDC1</span>
<span class="token number">1</span>  L<span class="token punctuation">.</span>D    F2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 
<span class="token number">2</span>  MUL<span class="token punctuation">.</span>D  F4<span class="token punctuation">,</span> F2<span class="token punctuation">,</span> F0  <span class="token comment">// 第二条指令使用了第一条LD指令取数寄存器F2</span>
<span class="token number">3</span>  L<span class="token punctuation">.</span>D    F6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		
<span class="token number">4</span>  ADD<span class="token punctuation">.</span>D  F6<span class="token punctuation">,</span> F4<span class="token punctuation">,</span> F6  <span class="token comment">// 第四条指令使用了第三条LD指令取数寄存器F6，以及第二条指令的运算结果寄存器F4</span>
<span class="token number">5</span>  S<span class="token punctuation">.</span>D    <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F6	  <span class="token comment">// 第五条指令使用了第四条LD指令的运算结果寄存器F6</span>
</code></pre> 
<p>可以看到存在四组数据相关<br> 1 和 2<br> 2 和 4<br> 3 和 4<br> 4 和 5<br> 按照课本中的延迟<br> <img src="https://images2.imgbox.com/44/40/j0EhXaSY_o.png" alt="在这里插入图片描述"></p> 
<p><strong>延迟为n，两条相关指令中需要间隔n-1条不相关的指令</strong>才算达到循环展开的目的：消除数据相关。<br> 即：<br> 1 和 2 延迟为2，之间需要加上 1 条不相关指令<br> 2 和 4 延迟为4，之间需要加上 2 条不相关指令<br> 3 和 4 延迟为2，之间需要加上 1 条不相关指令<br> 4 和 5 延迟为3，之间需要加上 2 条不相关指令</p> 
<p>接下来我会讲解两种循环展开的方法来避免流水线等待。</p> 
<h3><a id="_35"></a>循环展开的暴力方法</h3> 
<p>按照刚刚的分析，对于刚刚的指令段(如下)，需要通过循环展开来避免流水线等待（资源浪费）。</p> 
<pre><code class="prism language-c"><span class="token number">1</span>  L<span class="token punctuation">.</span>D    F2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 
<span class="token number">2</span>  MUL<span class="token punctuation">.</span>D  F4<span class="token punctuation">,</span> F2<span class="token punctuation">,</span> F0  <span class="token comment">// 第二条指令使用了第一条LD指令取数寄存器F2</span>
<span class="token number">3</span>  L<span class="token punctuation">.</span>D    F6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		
<span class="token number">4</span>  ADD<span class="token punctuation">.</span>D  F6<span class="token punctuation">,</span> F4<span class="token punctuation">,</span> F6  <span class="token comment">// 第四条指令使用了第三条LD指令取数寄存器F6，以及第二条指令的运算结果寄存器F4</span>
<span class="token number">5</span>  S<span class="token punctuation">.</span>D    <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F6	  <span class="token comment">// 第五条指令使用了第四条LD指令的运算结果寄存器F6</span>
</code></pre> 
<p>从最简单的方法开始（<strong>这个方法20年不给分</strong>，我想以后大概率也是，不过可以用来帮助理解）。<br> 为了方便理解指令段作用，这里加入题目要求，同时我修改了加下来的注释。<br> 题目可以理解为：高斯消元法的核心操作是一个循环，可以概括为 Y = a*X + Y，我们假设循环共 100次，循环变量每次增加 8 位，假设从 0 位开始，到 800 结束（<strong>792 是末尾元素地址</strong>）。且假设 R1、R2 存放数组 X、Y 的首地址，F0 存储浮点常量a的值。<br> 于是指令段增加如下</p> 
<pre><code class="prism language-c">bar：
	<span class="token number">1</span>  L<span class="token punctuation">.</span>D    F2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i]</span>
	<span class="token number">2</span>  MUL<span class="token punctuation">.</span>D  F4<span class="token punctuation">,</span> F2<span class="token punctuation">,</span> F0 	 <span class="token comment">// 计算a*X[i]</span>
	<span class="token number">3</span>  L<span class="token punctuation">.</span>D    F6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i]</span>
	<span class="token number">4</span>  ADD<span class="token punctuation">.</span>D  F6<span class="token punctuation">,</span> F4<span class="token punctuation">,</span> F6 	 <span class="token comment">// a*X[i] + Y[i]</span>
	<span class="token number">5</span>  S<span class="token punctuation">.</span>D    <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F6	 	 <span class="token comment">// 存Y[i]</span>
	<span class="token number">6</span>  DADDIU R1<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">8</span>	 <span class="token comment">// X的下标+1</span>
	<span class="token number">7</span>  DADDIU R2<span class="token punctuation">,</span> R2<span class="token punctuation">,</span> #<span class="token number">8</span>	 <span class="token comment">// Y的下标+1</span>
	<span class="token number">8</span>  DSGEIU R3<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">800</span>	 <span class="token comment">// 测试循环是否结束</span>
	<span class="token number">9</span>  BEQZ   R3<span class="token punctuation">,</span> bar		 <span class="token comment">// 如果循环没有结束，程序跳转到bar位置</span>
	<span class="token number">10</span> NOP
</code></pre> 
<p>为了方便理解指令段作用，我修改了注释。<br> 然后我们使用一个暴力方法来解决所有的流水线等待问题。<br> 根据之前的分析，我们需要在</p> 
<p>1 和 2 延迟为2，之间需要加上 1 条不相关指令<br> 2 和 4 延迟为4，之间需要加上 2 条不相关指令<br> 3 和 4 延迟为2，之间需要加上 1 条不相关指令<br> 4 和 5 延迟为3，之间需要加上 2 条不相关指令</p> 
<p>那么一次循环同时进行多次运算就可以达到插入不相关指令的目的了，解释一下，就是之前我们每轮循环只对当前的下标进行了一次高斯消元操作，如只进行了 Y[i] = aX[i] + Y[i]；现在我们打算每轮循环对<strong>两个</strong>下标进行高斯消元操作，也就是循环展开<strong>两次</strong>，如 Y[i] = aX[i] + Y[i]，Y[i+1] = aX[i+1] + Y[i+1]。就是说之前循环需要执行<strong>100</strong>轮，现在只需执行<strong>50</strong>轮。<br> 于是，先对之前的指令循环展开<strong>两次</strong>，如下</p> 
<pre><code class="prism language-c">bar：
	<span class="token number">1</span>  L<span class="token punctuation">.</span>D    F2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i]</span>
	<span class="token number">2</span>  L<span class="token punctuation">.</span>D    F3<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i+1] 	</span>
	<span class="token number">3</span>  MUL<span class="token punctuation">.</span>D  F4<span class="token punctuation">,</span> F2<span class="token punctuation">,</span> F0 	 <span class="token comment">// 计算a*X[i]</span>
	<span class="token number">4</span>  MUL<span class="token punctuation">.</span>D  F5<span class="token punctuation">,</span> F3<span class="token punctuation">,</span> F0	 <span class="token comment">// 计算a*X[i+1]</span>
	<span class="token number">5</span>  L<span class="token punctuation">.</span>D    F6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i]</span>
	<span class="token number">6</span>  L<span class="token punctuation">.</span>D    F7<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i+1]</span>
	<span class="token number">7</span>  ADD<span class="token punctuation">.</span>D  F6<span class="token punctuation">,</span> F4<span class="token punctuation">,</span> F6 	 <span class="token comment">// a*X[i] + Y[i]</span>
	<span class="token number">8</span>  ADD<span class="token punctuation">.</span>D  F7<span class="token punctuation">,</span> F5<span class="token punctuation">,</span> F7 	 <span class="token comment">// a*X[i+1] + Y[i+1]</span>
	<span class="token number">9</span>  S<span class="token punctuation">.</span>D    <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F6	 	 <span class="token comment">// 存Y[i]</span>
	<span class="token number">10</span> S<span class="token punctuation">.</span>D    <span class="token number">8</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F7	 	 <span class="token comment">// 存Y[i+1]</span>
	<span class="token number">11</span> DADDIU R1<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">16</span>	 <span class="token comment">// X的下标+2</span>
	<span class="token number">12</span> DADDIU R2<span class="token punctuation">,</span> R2<span class="token punctuation">,</span> #<span class="token number">16</span>	 <span class="token comment">// Y的下标+2</span>
	<span class="token number">13</span> DSGEIU R3<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">800</span>	 <span class="token comment">// 测试循环是否结束</span>
	<span class="token number">14</span> BEQZ   R3<span class="token punctuation">,</span> bar		 <span class="token comment">// 如果循环没有结束，程序跳转到bar位置</span>
	<span class="token number">15</span> NOP 
</code></pre> 
<p>可以看到，这样进行循环展开只需要对主要的指令重复写一次就可以了，只用注意<strong>寄存器的正确使用和下标的变换</strong>即可，简单暴力。<br> 如何使用寄存器？对于做题而言，我觉得 F1 至 F9 够用了，你只用像我刚才那样，把寄存器想象成一个变量，需要存储值时使用，当该值不再使用后可以用它存储新值。如加法指令 7 和 8，F6/F7 在运算前存的是之前的 Y 值，运算后存了新的 Y 值，这样可以少用几个寄存器，方便整理思路。<br> 但每轮循环对两个下标进行高斯消元操作仍然有流水线等待问题，分析如下</p> 
<p>1 和 3 延迟为2，不需要等待<br> 2 和 4 延迟为2，不需要等待<br> 3 和 7 延迟为4，不需要等待<br> 4 和 8 延迟为4，不需要等待<br> 5 和 7 延迟为2，不需要等待<br> 6 和 8 延迟为2，不需要等待<br> 7 和 9 延迟为3，之间需要加上 1 条不相关指令<br> 8 和 10 延迟为3，之间需要加上 1 条不相关指令</p> 
<p>所以展开两次是不够的，需要更多次的展开。<br> 那么显然，循环展开三次一定是够的，<strong>但是</strong>循环展开三次，第三十三轮循环结束时，按照之前的规定</p> 
<blockquote> 
 <p>循环共 100 次，循环变量每次增加8位，假设从 0 位开始，到 800 结束（<strong>792 是末尾元素地址</strong>）</p> 
</blockquote> 
<p>此时下标在 784 位，循环仍未结束，所以还要再执行第三十四轮循环，明显会多执行两次，执行完后下标在 808，这样就发生了不合理的访问越界行为。<br> 为了避免这种情况发生，切记<strong>循环展开次数一定要可以整除循环次数</strong>，如 2 可以整除 100，可以展开两次；3 不可以整除 100，不可以展开三次。<br> 显然，展开四次一定是够的，太费篇幅我就不写了。<br> 算了写一下吧。送佛送到西，这个方法写作业应该不扣分吧。</p> 
<pre><code class="prism language-c">bar：
	<span class="token number">1</span>  L<span class="token punctuation">.</span>D    F1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i]</span>
	<span class="token number">2</span>  L<span class="token punctuation">.</span>D    F2<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i+1] 	</span>
	<span class="token number">3</span>  L<span class="token punctuation">.</span>D    F3<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span>	 <span class="token comment">// 取X[i+2]</span>
	<span class="token number">4</span>  L<span class="token punctuation">.</span>D    F4<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i+3] </span>
	<span class="token number">5</span>  MUL<span class="token punctuation">.</span>D  F1<span class="token punctuation">,</span> F1<span class="token punctuation">,</span> F0 	 <span class="token comment">// 计算a*X[i]</span>
	<span class="token number">6</span>  MUL<span class="token punctuation">.</span>D  F2<span class="token punctuation">,</span> F2<span class="token punctuation">,</span> F0	 <span class="token comment">// 计算a*X[i+1]</span>
	<span class="token number">7</span>  MUL<span class="token punctuation">.</span>D  F3<span class="token punctuation">,</span> F3<span class="token punctuation">,</span> F0 	 <span class="token comment">// 计算a*X[i+2]</span>
	<span class="token number">8</span>  MUL<span class="token punctuation">.</span>D  F4<span class="token punctuation">,</span> F4<span class="token punctuation">,</span> F0	 <span class="token comment">// 计算a*X[i+3]</span>
	<span class="token number">9</span>  L<span class="token punctuation">.</span>D    F5<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i]</span>
	<span class="token number">10</span> L<span class="token punctuation">.</span>D    F6<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i+1]</span>
	<span class="token number">11</span> L<span class="token punctuation">.</span>D    F7<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>	 <span class="token comment">// 取Y[i+2]</span>
	<span class="token number">12</span> L<span class="token punctuation">.</span>D    F8<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>	 <span class="token comment">// 取Y[i+3]</span>
	<span class="token number">13</span> ADD<span class="token punctuation">.</span>D  F5<span class="token punctuation">,</span> F1<span class="token punctuation">,</span> F5 	 <span class="token comment">// a*X[i] + Y[i]</span>
	<span class="token number">14</span> ADD<span class="token punctuation">.</span>D  F6<span class="token punctuation">,</span> F2<span class="token punctuation">,</span> F6 	 <span class="token comment">// a*X[i+1] + Y[i+1]</span>
	<span class="token number">15</span> ADD<span class="token punctuation">.</span>D  F7<span class="token punctuation">,</span> F3<span class="token punctuation">,</span> F7 	 <span class="token comment">// a*X[i+2] + Y[i+2]</span>
	<span class="token number">16</span> ADD<span class="token punctuation">.</span>D  F8<span class="token punctuation">,</span> F4<span class="token punctuation">,</span> F8 	 <span class="token comment">// a*X[i+3] + Y[i+3]</span>
	<span class="token number">17</span> S<span class="token punctuation">.</span>D    <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F5	 	 <span class="token comment">// 存Y[i]</span>
	<span class="token number">18</span> S<span class="token punctuation">.</span>D    <span class="token number">8</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F6	 	 <span class="token comment">// 存Y[i+1]</span>
	<span class="token number">19</span> S<span class="token punctuation">.</span>D   <span class="token number">16</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F7 	 <span class="token comment">// 存Y[i+2]</span>
	<span class="token number">20</span> S<span class="token punctuation">.</span>D   <span class="token number">24</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F8 	 <span class="token comment">// 存Y[i+3]</span>
	<span class="token number">21</span> DADDIU R1<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">32</span>	 <span class="token comment">// X的下标+4</span>
	<span class="token number">22</span> DADDIU R2<span class="token punctuation">,</span> R2<span class="token punctuation">,</span> #<span class="token number">32</span>	 <span class="token comment">// Y的下标+4</span>
	<span class="token number">23</span> DSGEIU R3<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">800</span>	 <span class="token comment">// 测试循环是否结束</span>
	<span class="token number">24</span> BEQZ   R3<span class="token punctuation">,</span> bar		 <span class="token comment">// 如果循环没有结束，程序跳转到bar位置</span>
	<span class="token number">25</span> NOP 
</code></pre> 
<h3><a id="_143"></a>循环展开的合理方法</h3> 
<p>接下来才是应该掌握和使用的循环展开方法，所以我愿意称之为合理方法。<br> 其实，只用对之前循环两次的指令进行小小的修改即可。按照之前的规定</p> 
<blockquote> 
 <p>高斯消元法的核心操作是一个循环，可以概括为 Y = a*X + Y，我们假设循环共 100 次，循环变量每次增加 8 位，假设从0位开始，到800结束（<strong>792 是末尾元素地址</strong>）。且假设R1、R2存放数组X、Y的首地址，F0 存储浮点常量a的值。</p> 
</blockquote> 
<p>然后对如下指令段进行循环展开消除流水线等待。</p> 
<pre><code class="prism language-c">bar：
	<span class="token number">1</span>  L<span class="token punctuation">.</span>D    F2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i]</span>
	<span class="token number">2</span>  MUL<span class="token punctuation">.</span>D  F4<span class="token punctuation">,</span> F2<span class="token punctuation">,</span> F0 	 <span class="token comment">// 计算a*X[i]</span>
	<span class="token number">3</span>  L<span class="token punctuation">.</span>D    F6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i]</span>
	<span class="token number">4</span>  ADD<span class="token punctuation">.</span>D  F6<span class="token punctuation">,</span> F4<span class="token punctuation">,</span> F6 	 <span class="token comment">// a*X[i] + Y[i]</span>
	<span class="token number">5</span>  S<span class="token punctuation">.</span>D    <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F6	 	 <span class="token comment">// 存Y[i]</span>
	<span class="token number">6</span>  DADDIU R1<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">8</span>	 <span class="token comment">// X的下标+1</span>
	<span class="token number">7</span>  DADDIU R2<span class="token punctuation">,</span> R2<span class="token punctuation">,</span> #<span class="token number">8</span>	 <span class="token comment">// Y的下标+1</span>
	<span class="token number">8</span>  DSGEIU R3<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">800</span>	 <span class="token comment">// 测试循环是否结束</span>
	<span class="token number">9</span>  BEQZ   R3<span class="token punctuation">,</span> bar		 <span class="token comment">// 如果循环没有结束，程序跳转到bar位置</span>
	<span class="token number">10</span> NOP
</code></pre> 
<p>之前的循环展开两次（不合格）：</p> 
<pre><code class="prism language-c">bar：
	<span class="token number">1</span>  L<span class="token punctuation">.</span>D    F2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i]</span>
	<span class="token number">2</span>  L<span class="token punctuation">.</span>D    F3<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i+1] 	</span>
	<span class="token number">3</span>  MUL<span class="token punctuation">.</span>D  F4<span class="token punctuation">,</span> F2<span class="token punctuation">,</span> F0 	 <span class="token comment">// 计算a*X[i]</span>
	<span class="token number">4</span>  MUL<span class="token punctuation">.</span>D  F5<span class="token punctuation">,</span> F3<span class="token punctuation">,</span> F0	 <span class="token comment">// 计算a*X[i+1]</span>
	<span class="token number">5</span>  L<span class="token punctuation">.</span>D    F6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i]</span>
	<span class="token number">6</span>  L<span class="token punctuation">.</span>D    F7<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i+1]</span>
	<span class="token number">7</span>  ADD<span class="token punctuation">.</span>D  F6<span class="token punctuation">,</span> F4<span class="token punctuation">,</span> F6 	 <span class="token comment">// a*X[i] + Y[i]</span>
	<span class="token number">8</span>  ADD<span class="token punctuation">.</span>D  F7<span class="token punctuation">,</span> F5<span class="token punctuation">,</span> F7 	 <span class="token comment">// a*X[i+1] + Y[i+1]</span>
	<span class="token number">9</span>  S<span class="token punctuation">.</span>D    <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F6	 	 <span class="token comment">// 存Y[i]</span>
	<span class="token number">10</span> S<span class="token punctuation">.</span>D    <span class="token number">8</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F7	 	 <span class="token comment">// 存Y[i+1]</span>
	<span class="token number">11</span> DADDIU R1<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">16</span>	 <span class="token comment">// X的下标+2</span>
	<span class="token number">12</span> DADDIU R2<span class="token punctuation">,</span> R2<span class="token punctuation">,</span> #<span class="token number">16</span>	 <span class="token comment">// Y的下标+2</span>
	<span class="token number">13</span> DSGEIU R3<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">800</span>	 <span class="token comment">// 测试循环是否结束</span>
	<span class="token number">14</span> BEQZ   R3<span class="token punctuation">,</span> bar		 <span class="token comment">// 如果循环没有结束，程序跳转到bar位置</span>
	<span class="token number">15</span> NOP 
</code></pre> 
<p>修改部分指令次序后循环展开两次：</p> 
<pre><code class="prism language-c">bar：
	<span class="token number">1</span>  L<span class="token punctuation">.</span>D    F2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i]</span>
	<span class="token number">2</span>  L<span class="token punctuation">.</span>D    F3<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i+1] 	</span>
	<span class="token number">3</span>  MUL<span class="token punctuation">.</span>D  F4<span class="token punctuation">,</span> F2<span class="token punctuation">,</span> F0 	 <span class="token comment">// 计算a*X[i]</span>
	<span class="token number">4</span>  MUL<span class="token punctuation">.</span>D  F5<span class="token punctuation">,</span> F3<span class="token punctuation">,</span> F0	 <span class="token comment">// 计算a*X[i+1]</span>
	<span class="token number">5</span>  L<span class="token punctuation">.</span>D    F6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i]</span>
	<span class="token number">6</span>  L<span class="token punctuation">.</span>D    F7<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i+1]</span>
	<span class="token number">7</span>  ADD<span class="token punctuation">.</span>D  F6<span class="token punctuation">,</span> F4<span class="token punctuation">,</span> F6 	 <span class="token comment">// a*X[i] + Y[i]</span>
	<span class="token number">8</span>  ADD<span class="token punctuation">.</span>D  F7<span class="token punctuation">,</span> F5<span class="token punctuation">,</span> F7 	 <span class="token comment">// a*X[i+1] + Y[i+1]</span>
	<span class="token number">9</span>  DADDIU R1<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">16</span>	 <span class="token comment">// X的下标+2</span>
	<span class="token number">10</span> S<span class="token punctuation">.</span>D    <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F6	 	 <span class="token comment">// 存Y[i]</span>
	<span class="token number">11</span> S<span class="token punctuation">.</span>D    <span class="token number">8</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F7	 	 <span class="token comment">// 存Y[i+1]</span>
	<span class="token number">12</span> DSGEIU R3<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">800</span>	 <span class="token comment">// 测试循环是否结束</span>
	<span class="token number">13</span> BEQZ   R3<span class="token punctuation">,</span> bar		 <span class="token comment">// 如果循环没有结束，程序跳转到bar位置</span>
	<span class="token number">14</span> DADDIU R2<span class="token punctuation">,</span> R2<span class="token punctuation">,</span> #<span class="token number">16</span>	 <span class="token comment">// Y的下标+2</span>
</code></pre> 
<p>前六条指令之前已经分析过，是没有流水线等待的，现在分析修改后的7至11条指令。<br> 显然，<br> 7 和 10 延迟为3，不需要等待<br> 8 和 11 延迟为3，不需要等待</p> 
<p>这样就是一个正确的答案了。<br> 可以看到，我只修改了两条指令的位置，其一是 <em>X的下标+2</em> 的第 9 条指令（原第 11 条），将其插在加法指令和 Store 指令（S.D）之间，避免了 ADD 之后 Store 的流水线等待；其二是 <em>Y的下标+2</em> 的第 14 条指令（原第12条），我将其作为延迟槽指令，既避免了修改 Store 指令的<strong>偏移量下标</strong>，也合理使用了延迟槽。<br> 同样，我的方法只是答案的一种，当然也可以将 Store 指令放入延迟槽，不过都要保证偏移量下标的合理。</p> 
<p>如 20 年大题，之前的条件都一样，但是修改了流水线延迟，如下<br> <img src="https://images2.imgbox.com/6b/f3/7JQKPdQH_o.png" alt="在这里插入图片描述"><br> 也是循环展开两次就可以解决的。</p> 
<pre><code class="prism language-c">bar：
	<span class="token number">1</span>  L<span class="token punctuation">.</span>D    F1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i]</span>
	<span class="token number">2</span>  L<span class="token punctuation">.</span>D    F2<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span>R1<span class="token punctuation">)</span> 	 <span class="token comment">// 取X[i+1] </span>
	<span class="token number">3</span>  L<span class="token punctuation">.</span>D    F3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i]</span>
	<span class="token number">4</span>  L<span class="token punctuation">.</span>D    F4<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span>		 <span class="token comment">// 取Y[i+1]	</span>
	<span class="token number">5</span>  MUL<span class="token punctuation">.</span>D  F1<span class="token punctuation">,</span> F1<span class="token punctuation">,</span> F0 	 <span class="token comment">// 计算a*X[i]</span>
	<span class="token number">6</span>  MUL<span class="token punctuation">.</span>D  F2<span class="token punctuation">,</span> F2<span class="token punctuation">,</span> F0	 <span class="token comment">// 计算a*X[i+1]</span>
	<span class="token number">7</span>  DADDIU R1<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">16</span>	 <span class="token comment">// X的下标+2</span>
	<span class="token number">8</span>  ADD<span class="token punctuation">.</span>D  F5<span class="token punctuation">,</span> F1<span class="token punctuation">,</span> F3 	 <span class="token comment">// a*X[i] + Y[i]</span>
	<span class="token number">9</span>  ADD<span class="token punctuation">.</span>D  F6<span class="token punctuation">,</span> F2<span class="token punctuation">,</span> F4 	 <span class="token comment">// a*X[i+1] + Y[i+1]</span>
	<span class="token number">10</span> DADDIU R2<span class="token punctuation">,</span> R2<span class="token punctuation">,</span> #<span class="token number">16</span>	 <span class="token comment">// Y的下标+2</span>
	<span class="token number">11</span> DSGEIU R3<span class="token punctuation">,</span> R1<span class="token punctuation">,</span> #<span class="token number">800</span>	 <span class="token comment">// 测试循环是否结束</span>
	<span class="token number">12</span> S<span class="token punctuation">.</span>D    <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F5	 <span class="token comment">// 存Y[i]</span>
	<span class="token number">13</span> BEQZ   R3<span class="token punctuation">,</span> bar		 <span class="token comment">// 如果循环没有结束，程序跳转到bar位置</span>
	<span class="token number">14</span> S<span class="token punctuation">.</span>D    <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span class="token punctuation">,</span> F6	 <span class="token comment">// 存Y[i+1]</span>
</code></pre> 
<p>注意，这里因为先对 <em>Y的下标加2</em> ，所以 Store 指令的偏移量也跟着修改。<br> 如有错误欢迎指正~<br> 我应该还会写一篇<a href="https://blog.csdn.net/csdn_muxin/article/details/114491152">软流水</a>吧~<br> 喜欢了赏个赞吧！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/72adf6cf9904c2e028b6e87cc6a57daf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">通过指针消除字符串重复项</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5a87f7dbb542bf1d46ec636b1f8488d1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">内网安全-横向移动-IPC&amp;AT&amp;atexec</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>