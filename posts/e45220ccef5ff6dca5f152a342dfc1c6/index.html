<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>简单自定义协议的封包和解包 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="简单自定义协议的封包和解包" />
<meta property="og:description" content="简单自定义协议的封包和解包 一、通信协议1 百度百科的解释2 过于简单的通信协议引发的问题3 通信协议常见内容1.帧头2.设备地址/类型3.命令/指令4.命令类型/功能码5.数据长度6.数据7.帧尾8.校验码 4 通信协议代码实现（DGUS串口屏的例子）1.消息数据发送2.消息数据接收 5 最后最后强调两点： 二、怎样用串口发送结构体-简单协议的封包和解包定义要发送的结构体下位机封包发送1、拆分2、封包3、发送 上位机接收数据并解包1、读取数据2、找到一个完整的数据包3、解析数据 三、嵌入式硬件通信接口协议-UART（五）数据包设计与解析应用层数据包设计思路项目案例常规解析过程构建查表方式解析 四、DL-T 645协议格式或者DL-T 698协议格式的数据帧的串口解析思路串口解析思路 五、Qt 实现数据协议控制--组帧、组包、解析帧、解析包数据传输中的组帧和组包一、数据帧，数据包的概念二、 程序实现：2.1、frame(帧)类的实现： 六、如何用串口解析出协议帧，并解决分包，组包，粘包问题？七、串口协议包的接收及解析处理 原文链接：https://blog.csdn.net/sinat_16643223/article/details/118830297
一、通信协议 有一些初学者总觉得通信协议是一个很复杂的知识，把它想的很高深，导致不知道该怎么学。
同时，偶尔有读者问关于串口自定义通信协议相关的问题，今天就来写写串口通信协议，并不是你想想中的那么难？
1什么通信协议？
通信协议不难理解，就是两个（或多个）设备之间进行通信，必须要遵循的一种协议。
1 百度百科的解释 通信协议是指双方实体完成通信或服务所必须遵循的规则和约定。通过通信信道和设备互连起来的多个不同地理位置的数据通信系统，要使其能协同工作实现信息交换和资源共享，它们之间必须具有共同的语言。交流什么、怎样交流及何时交流，都必须遵循某种互相都能接受的规则。这个规则就是通信协议。
相应该有很多读者都买过一些基于串口通信的模块，市面上很多基于串口通信的模块都是自定义通信协议，有的比较简单，有的相对复杂一点。
举一个很简单的串口通信协议的例子：比如只传输一个温度值，只有三个字节的通信协议：
这种看起来是不是很简单？它也是一种通信协议。
只是说这种通信协议应用的场合相对比较简单（一对一两个设备之间），同时，它存在很多弊端。
2 过于简单的通信协议引发的问题 上面那种只有三个字节的通信协议，相信大家都看明白了。虽然它也能通信，也能传输数据，但它存在一系列的问题。
比如：多个设备连接在一条总线（比如485）上，怎么判断传输给谁？（没有设备信息）
还比如：处于一个干扰环境，你能保障传输数据正确吗？（没有校验信息）
再比如：我想传输多个不确定长度的数据，该怎么办？（没有长度信息）。
上面这一系列问题，相信做过自定义通信的朋友都了解。
所以，在通信协议里面要约定更多的“协议信息”，这样才能保证通信的完整。
3 通信协议常见内容 基于串口的通信协议通常不能太复杂，因为串口通信速率、抗干扰能力以及其他各方面原因，相对于TCP/IP这种通信协议，是一种很轻量级的通信协议。
所以，基于串口的通信，除了一些通用的通信协议（比如：Modubs、MAVLink）之外，很多时候，工程师都会根据自己项目情况，自定义通信协议。
下面简单描述下常见自定义通信协议的一些要点内容。
（这是一些常见的协议内容，可能不同情况，其协议内容不同）
1.帧头 帧头，就是一帧通信数据的开头。
有的通信协议帧头只有一个，有的有两个，比如：5A、A5作为帧头。
2.设备地址/类型 设备地址或者设备类型，通常是用于多种设备之间，为了方便区分不同设备。
这种情况，需要在协议或者附录中要描述各种设备类型信息，方便开发者编码查询。
当然，有些固定的两种设备之间通信，可能没有这个选项。
3.命令/指令 命令/指令比较常见，一般是不同的操作，用不同的命令来区分。
举例：温度：0x01；湿度：0x02；
4.命令类型/功能码 这个选项对命令进一步补充。比如：读、写操作。
举例：读Flash：0x01； 写Flash：0x02；
5.数据长度 数据长度这个选项，可能有的协议会把该选项提到前面设备地址位置，把命令这些信息算在“长度”里面。
这个主要是方便协议（接收）解析的时候，统计接收数据长度。
比如：有时候传输一个有效数据，有时候要传输多个有效数据，甚至传输一个数组的数据。这个时候，传输的一帧数据就是不定长数据，就必须要有【数据长度】来约束。
有的长度是一个字节，其范围：0x01 ~ 0xFF，有的可能要求一次性传输更多，就用两个字节表示，其范围0x0001 ~ 0xFFFFF。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/e45220ccef5ff6dca5f152a342dfc1c6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-05T09:58:47+08:00" />
<meta property="article:modified_time" content="2022-03-05T09:58:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">简单自定义协议的封包和解包</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>简单自定义协议的封包和解包</h4> 
 <ul><li><a href="#_6" rel="nofollow">一、通信协议</a></li><li><ul><li><a href="#1__14" rel="nofollow">1 百度百科的解释</a></li><li><a href="#2__26" rel="nofollow">2 过于简单的通信协议引发的问题</a></li><li><a href="#3__39" rel="nofollow">3 通信协议常见内容</a></li><li><ul><li><a href="#1_48" rel="nofollow">1.帧头</a></li><li><a href="#2_54" rel="nofollow">2.设备地址/类型</a></li><li><a href="#3_62" rel="nofollow">3.命令/指令</a></li><li><a href="#4_68" rel="nofollow">4.命令类型/功能码</a></li><li><a href="#5_74" rel="nofollow">5.数据长度</a></li><li><a href="#6_86" rel="nofollow">6.数据</a></li><li><a href="#7_90" rel="nofollow">7.帧尾</a></li><li><a href="#8_94" rel="nofollow">8.校验码</a></li></ul> 
   </li><li><a href="#4_DGUS_104" rel="nofollow">4 通信协议代码实现（DGUS串口屏的例子）</a></li><li><ul><li><a href="#1_111" rel="nofollow">1.消息数据发送</a></li><li><a href="#2_248" rel="nofollow">2.消息数据接收</a></li></ul> 
   </li><li><a href="#5__330" rel="nofollow">5 最后</a></li><li><a href="#_337" rel="nofollow">最后强调两点：</a></li></ul> 
  </li><li><a href="#_344" rel="nofollow">二、怎样用串口发送结构体-简单协议的封包和解包</a></li><li><ul><li><a href="#_347" rel="nofollow">定义要发送的结构体</a></li><li><a href="#_386" rel="nofollow">下位机封包发送</a></li><li><ul><li><a href="#1_410" rel="nofollow">1、拆分</a></li><li><a href="#2_441" rel="nofollow">2、封包</a></li><li><a href="#3_500" rel="nofollow">3、发送</a></li></ul> 
   </li><li><a href="#_536" rel="nofollow">上位机接收数据并解包</a></li><li><ul><li><a href="#1_562" rel="nofollow">1、读取数据</a></li><li><a href="#2_612" rel="nofollow">2、找到一个完整的数据包</a></li><li><a href="#3_663" rel="nofollow">3、解析数据</a></li></ul> 
  </li></ul> 
  </li><li><a href="#UART_685" rel="nofollow">三、嵌入式硬件通信接口协议-UART（五）数据包设计与解析</a></li><li><ul><li><a href="#_688" rel="nofollow">应用层数据包设计思路</a></li><li><a href="#_705" rel="nofollow">项目案例</a></li><li><ul><li><a href="#_708" rel="nofollow">常规解析过程</a></li><li><a href="#_722" rel="nofollow">构建查表方式解析</a></li></ul> 
  </li></ul> 
  </li><li><a href="#DLT_645DLT_698_764" rel="nofollow">四、DL-T 645协议格式或者DL-T 698协议格式的数据帧的串口解析思路</a></li><li><ul><li><a href="#_781" rel="nofollow">串口解析思路</a></li></ul> 
  </li><li><a href="#Qt__1379" rel="nofollow">五、Qt 实现数据协议控制--组帧、组包、解析帧、解析包</a></li><li><ul><li><a href="#_1382" rel="nofollow">数据传输中的组帧和组包</a></li><li><a href="#_1383" rel="nofollow">一、数据帧，数据包的概念</a></li><li><a href="#__1407" rel="nofollow">二、 程序实现：</a></li><li><ul><li><a href="#21frame_1410" rel="nofollow">2.1、frame(帧)类的实现：</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_1988" rel="nofollow">六、如何用串口解析出协议帧，并解决分包，组包，粘包问题？</a></li><li><a href="#_2116" rel="nofollow">七、串口协议包的接收及解析处理</a></li></ul> 
</div> 
<p></p> 
<p>原文链接：<a href="https://blog.csdn.net/sinat_16643223/article/details/118830297">https://blog.csdn.net/sinat_16643223/article/details/118830297</a></p> 
<h2><a id="_6"></a>一、通信协议</h2> 
<p>有一些初学者总觉得通信协议是一个很复杂的知识，把它想的很高深，导致不知道该怎么学。</p> 
<p>同时，偶尔有读者问关于串口自定义通信协议相关的问题，今天就来写写串口通信协议，并不是你想想中的那么难？</p> 
<p>1什么通信协议？<br> 通信协议不难理解，就是两个（或多个）设备之间进行通信，必须要遵循的一种协议。</p> 
<h3><a id="1__14"></a>1 百度百科的解释</h3> 
<p>通信协议是指双方实体完成通信或服务所必须遵循的规则和约定。通过通信信道和设备互连起来的多个不同地理位置的数据通信系统，要使其能协同工作实现信息交换和资源共享，它们之间必须具有共同的语言。交流什么、怎样交流及何时交流，都必须遵循某种互相都能接受的规则。这个规则就是通信协议。</p> 
<p>相应该有很多读者都买过一些基于串口通信的模块，市面上很多基于串口通信的模块都是自定义通信协议，有的比较简单，有的相对复杂一点。</p> 
<p>举一个很简单的串口通信协议的例子：比如只传输一个温度值，只有三个字节的通信协议：<br> <img src="https://images2.imgbox.com/e4/30/1SL45Fwj_o.jpg" alt="在这里插入图片描述"><br> 这种看起来是不是很简单？它也是一种通信协议。</p> 
<p>只是说这种通信协议应用的场合相对比较简单（一对一两个设备之间），同时，它存在很多弊端。</p> 
<h3><a id="2__26"></a>2 过于简单的通信协议引发的问题</h3> 
<p>上面那种只有三个字节的通信协议，相信大家都看明白了。虽然它也能通信，也能传输数据，但它存在一系列的问题。</p> 
<p>比如：多个设备连接在一条总线（比如485）上，怎么判断传输给谁？（没有设备信息）</p> 
<p>还比如：处于一个干扰环境，你能保障传输数据正确吗？（没有校验信息）</p> 
<p>再比如：我想传输多个不确定长度的数据，该怎么办？（没有长度信息）。</p> 
<p>上面这一系列问题，相信做过自定义通信的朋友都了解。</p> 
<p>所以，在通信协议里面要约定更多的“协议信息”，这样才能保证通信的完整。</p> 
<h3><a id="3__39"></a>3 通信协议常见内容</h3> 
<p>基于串口的通信协议通常不能太复杂，因为串口通信速率、抗干扰能力以及其他各方面原因，相对于TCP/IP这种通信协议，是一种很轻量级的通信协议。</p> 
<p>所以，基于串口的通信，除了一些通用的通信协议（比如：Modubs、MAVLink）之外，很多时候，工程师都会根据自己项目情况，自定义通信协议。</p> 
<p>下面简单描述下常见自定义通信协议的一些要点内容。<br> <img src="https://images2.imgbox.com/56/24/ZEEtmuxS_o.png" alt="在这里插入图片描述"><br> （这是一些常见的协议内容，可能不同情况，其协议内容不同）</p> 
<h4><a id="1_48"></a>1.帧头</h4> 
<p>帧头，就是一帧通信数据的开头。</p> 
<p>有的通信协议帧头只有一个，有的有两个，比如：5A、A5作为帧头。<br> <img src="https://images2.imgbox.com/a9/0a/TLgLHu3M_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="2_54"></a>2.设备地址/类型</h4> 
<p>设备地址或者设备类型，通常是用于多种设备之间，为了方便区分不同设备。<br> <img src="https://images2.imgbox.com/20/fe/hnziLpD8_o.jpg" alt="在这里插入图片描述"><br> 这种情况，需要在协议或者附录中要描述各种设备类型信息，方便开发者编码查询。</p> 
<p>当然，有些固定的两种设备之间通信，可能没有这个选项。</p> 
<h4><a id="3_62"></a>3.命令/指令</h4> 
<p>命令/指令比较常见，一般是不同的操作，用不同的命令来区分。<br> <img src="https://images2.imgbox.com/cb/0a/xtd0MFW4_o.jpg" alt="在这里插入图片描述"><br> 举例：温度：0x01；湿度：0x02；</p> 
<h4><a id="4_68"></a>4.命令类型/功能码</h4> 
<p>这个选项对命令进一步补充。比如：读、写操作。<br> <img src="https://images2.imgbox.com/85/e7/xWqiiOfQ_o.jpg" alt="在这里插入图片描述"><br> 举例：读Flash：0x01； 写Flash：0x02；</p> 
<h4><a id="5_74"></a>5.数据长度</h4> 
<p>数据长度这个选项，可能有的协议会把该选项提到前面设备地址位置，把命令这些信息算在“长度”里面。</p> 
<p>这个主要是方便协议（接收）解析的时候，统计接收数据长度。<br> <img src="https://images2.imgbox.com/1f/65/VqQO51vC_o.jpg" alt="在这里插入图片描述"><br> 比如：有时候传输一个有效数据，有时候要传输多个有效数据，甚至传输一个数组的数据。这个时候，传输的一帧数据就是不定长数据，就必须要有【数据长度】来约束。</p> 
<p>有的长度是一个字节，其范围：0x01 ~ 0xFF，有的可能要求一次性传输更多，就用两个字节表示，其范围0x0001 ~ 0xFFFFF。</p> 
<p>当然，有的通信长度是固定的长度（比如固定只传输、温度、湿度这两个数据），其协议可能没有这个选项。</p> 
<h4><a id="6_86"></a>6.数据</h4> 
<p>数据就不用描述了，就是你传输的实实在在的数据，比如温度：25℃。</p> 
<h4><a id="7_90"></a>7.帧尾</h4> 
<p>有些协议可能没有帧尾，这个应该是可有可无的一个选项。</p> 
<h4><a id="8_94"></a>8.校验码</h4> 
<p>校验码是一个比较重要的内容，一般正规一点的通信协议都有这个选项，原因很简单，通信很容易受到干扰，或者其他原因，导致传输数据出错。</p> 
<p>如果有校验码，就能比较有效避免数据传输出错的的情况。<br> <img src="https://images2.imgbox.com/34/85/ZzZdEdp2_o.jpg" alt="在这里插入图片描述"><br> 校验码的方式有很多，校验和、CRC校验算是比较常见的，用于自定义协议中的校验方式。</p> 
<p>还有一点，有的协议可能把校验码放在倒数第二，帧尾放在最后位置。</p> 
<h3><a id="4_DGUS_104"></a>4 通信协议代码实现（DGUS串口屏的例子）</h3> 
<p>自定义通信协议，代码实现的方式有很多种，怎么说呢，“条条大路通罗马”你只需要按照你协议要写实现代码就行。</p> 
<p>当然，实现的同时，需要考虑你项目实际情况，比如通信数据比较多，要用消息队列（FIFO），还比如，如果协议复杂，最好封装结构体等。</p> 
<p>下面分享一些以前用到的代码，可能没有描述更多细节，但一些思想可以借鉴。</p> 
<h4><a id="1_111"></a>1.消息数据发送</h4> 
<p><mark>a.通过串口直接发送每一个字节</mark></p> 
<p>这种对于新手来说都能理解，这里分享一个之前DGUS串口屏的例子：</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">define</span> DGUS_FRAME_HEAD1          0xA5                     </span><span class="token comment">//DGUS屏帧头1</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_FRAME_HEAD2          0x5A                     </span><span class="token comment">//DGUS屏帧头2</span>


<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_CMD_W_REG            0x80                     </span><span class="token comment">//DGUS写寄存器指令</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_CMD_R_REG            0x81                     </span><span class="token comment">//DGUS读寄存器指令</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_CMD_W_DATA           0x82                     </span><span class="token comment">//DGUS写数据指令</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_CMD_R_DATA           0x83                     </span><span class="token comment">//DGUS读数据指令</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_CMD_W_CURVE          0x85                     </span><span class="token comment">//DGUS写曲线指令</span>


<span class="token comment">/* DGUS寄存器地址 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_REG_VERSION          0x00                     </span><span class="token comment">//DGUS版本</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_REG_LED_NOW          0x01                     </span><span class="token comment">//LED背光亮度</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_REG_BZ_TIME          0x02                     </span><span class="token comment">//蜂鸣器时长</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_REG_PIC_ID           0x03                     </span><span class="token comment">//显示页面ID</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_REG_TP_FLAG          0x05                     </span><span class="token comment">//触摸坐标更新标志</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_REG_TP_STATUS        0x06                     </span><span class="token comment">//坐标状态</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_REG_TP_POSITION      0x07                     </span><span class="token comment">//坐标位置</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_REG_TPC_ENABLE       0x0B                     </span><span class="token comment">//触控使能</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DGUS_REG_RTC_NOW          0x20                     </span><span class="token comment">//当前RTCS</span>


<span class="token comment">//往DGDS屏指定寄存器写一字节数据</span>
<span class="token keyword">void</span> <span class="token function">DGUS_REG_WriteWord</span><span class="token punctuation">(</span>uint8_t RegAddr<span class="token punctuation">,</span> uint16_t Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span>DGUS_FRAME_HEAD1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span>DGUS_FRAME_HEAD2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span>DGUS_CMD_W_REG<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//指令</span>
  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span>RegAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">//地址</span>


  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>Data<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">//数据</span>
  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>Data<span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//往DGDS屏指定地址写一字节数据</span>
<span class="token keyword">void</span> <span class="token function">DGUS_DATA_WriteWord</span><span class="token punctuation">(</span>uint16_t DataAddr<span class="token punctuation">,</span> uint16_t Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span>DGUS_FRAME_HEAD1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span>DGUS_FRAME_HEAD2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span>DGUS_CMD_W_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//指令</span>


  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>DataAddr<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//地址</span>
  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>DataAddr<span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>Data<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">//数据</span>
  <span class="token function">DGUS_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>Data<span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><mark>b.通过消息队列发送</mark></p> 
<p>在上面基础上，用一个buf装下消息，然后“打包”到消息队列，通过消息队列的方式（FIFO）发送出去。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> uint8_t  sDGUS_SendBuf<span class="token punctuation">[</span>DGUS_PACKAGE_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token comment">//往DGDS屏指定寄存器写一字节数据</span>
<span class="token keyword">void</span> <span class="token function">DGUS_REG_WriteWord</span><span class="token punctuation">(</span>uint8_t RegAddr<span class="token punctuation">,</span> uint16_t Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> DGUS_FRAME_HEAD1<span class="token punctuation">;</span>           <span class="token comment">//帧头</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> DGUS_FRAME_HEAD2<span class="token punctuation">;</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x06</span><span class="token punctuation">;</span>                       <span class="token comment">//长度</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> DGUS_CMD_W_CTRL<span class="token punctuation">;</span>            <span class="token comment">//指令</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> RegAddr<span class="token punctuation">;</span>                    <span class="token comment">//地址</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>Data<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//数据</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>Data<span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">DGUS_CRC16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sDGUS_CRC_H<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sDGUS_CRC_L<span class="token punctuation">)</span><span class="token punctuation">;</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> sDGUS_CRC_H<span class="token punctuation">;</span>                <span class="token comment">//校验</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> sDGUS_CRC_L<span class="token punctuation">;</span>


  <span class="token function">DGUSSend_Packet_ToQueue</span><span class="token punctuation">(</span>sDGUS_SendBuf<span class="token punctuation">,</span> sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//往DGDS屏指定地址写一字节数据</span>
<span class="token keyword">void</span> <span class="token function">DGUS_DATA_WriteWord</span><span class="token punctuation">(</span>uint16_t DataAddr<span class="token punctuation">,</span> uint16_t Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> DGUS_FRAME_HEAD1<span class="token punctuation">;</span>           <span class="token comment">//帧头</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> DGUS_FRAME_HEAD2<span class="token punctuation">;</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x07</span><span class="token punctuation">;</span>                       <span class="token comment">//长度</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> DGUS_CMD_W_DATA<span class="token punctuation">;</span>            <span class="token comment">//指令</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>DataAddr<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//地址</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>DataAddr<span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>Data<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//数据</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">(</span>Data<span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">DGUS_CRC16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sDGUS_CRC_H<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sDGUS_CRC_L<span class="token punctuation">)</span><span class="token punctuation">;</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> sDGUS_CRC_H<span class="token punctuation">;</span>                <span class="token comment">//校验</span>
  sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> sDGUS_CRC_L<span class="token punctuation">;</span>


  <span class="token function">DGUSSend_Packet_ToQueue</span><span class="token punctuation">(</span>sDGUS_SendBuf<span class="token punctuation">,</span> sDGUS_SendBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><mark>c.用“结构体”代替“数组SendBuf”方式</mark></p> 
<p>结构体对数组更方便引用，也方便管理，所以，结构体方式相比数组buf更高级，也更实用。（当然，如果成员比较多，如果用临时变量方式也会导致占用过多堆栈的情况）</p> 
<p>比如：</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
  uint8_t  Head1<span class="token punctuation">;</span>                 <span class="token comment">//帧头1</span>
  uint8_t  Head2<span class="token punctuation">;</span>                 <span class="token comment">//帧头2</span>
  uint8_t  Len<span class="token punctuation">;</span>                   <span class="token comment">//长度</span>
  uint8_t  Cmd<span class="token punctuation">;</span>                   <span class="token comment">//命令</span>
  uint8_t  Data<span class="token punctuation">[</span>DGUS_DATA_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//数据</span>
  uint16_t CRC16<span class="token punctuation">;</span>                 <span class="token comment">//CRC校验</span>
<span class="token punctuation">}</span>DGUS_PACKAGE_TypeDef<span class="token punctuation">;</span>
</code></pre> 
<p><mark>d.其他更多</mark></p> 
<p>串口发送数据的方式有很多，比如用DMA的方式替代消息队列的方式。</p> 
<h4><a id="2_248"></a>2.消息数据接收</h4> 
<p>串口消息接收，通常串口中断接收的方式居多，当然，也有很少情况用轮询的方式接收数据。</p> 
<p><mark>a.常规中断接收</mark></p> 
<p>还是以DGUS串口屏为例，描述一种简单又常见的中断接收方式：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">DGUS_ISRHandler</span><span class="token punctuation">(</span>uint8_t Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">static</span> uint8_t sDgus_RxNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token comment">//数量</span>
  <span class="token keyword">static</span> uint8_t sDgus_RxBuf<span class="token punctuation">[</span>DGUS_PACKAGE_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> portBASE_TYPE xHigherPriorityTaskWoken <span class="token operator">=</span> pdFALSE<span class="token punctuation">;</span>


  sDgus_RxBuf<span class="token punctuation">[</span>gDGUS_RxCnt<span class="token punctuation">]</span> <span class="token operator">=</span> Data<span class="token punctuation">;</span>
  gDGUS_RxCnt<span class="token operator">++</span><span class="token punctuation">;</span>


  <span class="token comment">/* 判断帧头 */</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>sDgus_RxBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> DGUS_FRAME_HEAD1<span class="token punctuation">)</span>       <span class="token comment">//接收到帧头1</span>
  <span class="token punctuation">{<!-- --></span>
    gDGUS_RxCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">==</span> gDGUS_RxCnt<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sDgus_RxBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> DGUS_FRAME_HEAD2<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    gDGUS_RxCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token comment">/* 确定一帧数据长度 */</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>gDGUS_RxCnt <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    sDgus_RxNum <span class="token operator">=</span> sDgus_RxBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token comment">/* 接收完一帧数据 */</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">&lt;=</span> gDGUS_RxCnt<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sDgus_RxNum <span class="token operator">&lt;=</span> gDGUS_RxCnt<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    gDGUS_RxCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>


    <span class="token keyword">if</span><span class="token punctuation">(</span>xDGUSRcvQueue <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>                    <span class="token comment">//解析成功, 加入队列</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">xQueueSendFromISR</span><span class="token punctuation">(</span>xDGUSRcvQueue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sDgus_RxBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>xHigherPriorityTaskWoken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">portEND_SWITCHING_ISR</span><span class="token punctuation">(</span>xHigherPriorityTaskWoken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><mark>b.增加超时检测</mark></p> 
<p>接收数据有可能存在接收了一半，中断因为某种原因中断了，这时候，超时检测也很有必要。</p> 
<p>比如：用多余的MCU定时器做一个超时计数的处理，接收到一个数据，开始计时，超过1ms没有接收到下一个数据，就丢掉这一包（前面接收的）数据。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DGUS_TimingAndUpdate</span><span class="token punctuation">(</span>uint16_t Nms<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  sDGUSTiming_Nms_Num <span class="token operator">=</span> Nms<span class="token punctuation">;</span>
  <span class="token function">TIM_SetCounter</span><span class="token punctuation">(</span>DGUS_TIM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//设置计数值为0</span>
  <span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>DGUS_TIM<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//启动定时器</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">DGUS_COM_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DGUS_COM<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> USART_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> USART_FLAG_RXNE<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">DGUS_TimingAndUpdate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//更新定时(防止超时)</span>
    <span class="token function">DGUS_ISRHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>DGUS_COM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><mark>c.更多</mark></p> 
<p>接收和发送一样，实现方法有很多种，比如接收同样也可以用结构体方式。但有一点，都需要结合你实际需求来编码。</p> 
<h3><a id="5__330"></a>5 最后</h3> 
<p>以上自定义协议内容仅供参考，最终用哪些、占用几个字节都与你实际需求有关。</p> 
<p>基于串口的自定义通信协议，有千差万别，比如：MCU处理能力、设备多少、通信内容等都与你自定义协议有关。</p> 
<p>有的可能只需要很简单的通信协议就能满足要求。有的可能需要更复杂的协议才能满足。</p> 
<h3><a id="_337"></a>最后强调两点：</h3> 
<p>1.以上举例并不是完整的代码（有些细节没有描述出来），主要是供大家学习这种编程思想，或者实现方式。</p> 
<p>2.一份好的通信协议代码，必定有一定容错处理，比如：发送完成检测、接收超时检测、数据出错检测等等。所以说，以上代码并不是完整的代码。</p> 
<h2><a id="_344"></a>二、怎样用串口发送结构体-简单协议的封包和解包</h2> 
<p><a href="https://blog.csdn.net/qq_33904382/article/details/112718948">https://blog.csdn.net/qq_33904382/article/details/112718948</a></p> 
<h3><a id="_347"></a>定义要发送的结构体</h3> 
<pre><code class="prism language-c"><span class="token comment">/**
	@part 通信数据结构
*/</span>

<span class="token comment">/* 加速度信息结构体-XYZ三分量 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> CSModuleInfo_ACC<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">float</span> _acc_X<span class="token punctuation">;</span>
	<span class="token keyword">float</span> _acc_Y<span class="token punctuation">;</span>	
	<span class="token keyword">float</span> _acc_Z<span class="token punctuation">;</span>
<span class="token punctuation">}</span>CSInfo_Acc<span class="token punctuation">;</span>

<span class="token comment">/* 经纬度信息结构体-经纬两分量 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> CSmouduleInfo_LL<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">float</span> _latitude<span class="token punctuation">;</span>
	<span class="token keyword">float</span> _longitude<span class="token punctuation">;</span>
<span class="token punctuation">}</span>CSInfo_LL<span class="token punctuation">;</span>

<span class="token comment">/* 测控站信息结构体 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> CSInfoStrcutre CSInfoS<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> CSInfoStrcutre<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* 核心温度 MCU温度 */</span>
	<span class="token keyword">float</span> _temp_O_MCU<span class="token punctuation">;</span>
	<span class="token comment">/* 气温 */</span>
	<span class="token keyword">float</span> _temp_env<span class="token punctuation">;</span>
	<span class="token comment">/* 气压 */</span>
	<span class="token keyword">float</span> _gp<span class="token punctuation">;</span>
	<span class="token comment">/* 加速度 */</span>
	CSInfo_Acc _acc<span class="token punctuation">;</span>
	<span class="token comment">/* 经纬度 */</span>
	CSInfo_LL _ll<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token operator">*</span> ptrCSInfo<span class="token punctuation">;</span>
</code></pre> 
<p>为了保证本文能符合大伙的需求，咱搞一个结构体嵌套，并且把数据类型都定义浮点数。意在说明我们这种传输结构体的方式不受结构体类型的限制，也不受浮点数的存储方式的限制，请放心学习使用。</p> 
<p>注：代码中/* 测控站信息结构体 */部分的ptrCSInfo是这个大结构体的指针类型，CSInfoS是这个结构体的别名，这种写法是C语言的语法规则所允许的，不用感到奇怪。</p> 
<h3><a id="_386"></a>下位机封包发送</h3> 
<p>封包发送的过程可以用下面的代码实现：</p> 
<pre><code class="prism language-c"><span class="token comment">/**
* @brief  将数据打包并发送到上位机
  * @param  
			ptrInfoStructure 指向一个装填好信息的infoStructure的指针
  * @retval 无
  */</span>

<span class="token keyword">void</span> <span class="token function">CSInfo_PackAndSend</span><span class="token punctuation">(</span>ptrCSInfo ptrInfoStructure<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	uint8_t infoArray<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	uint8_t infoPackage<span class="token punctuation">[</span><span class="token number">38</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token function">CSInfo_2Array_uint8</span><span class="token punctuation">(</span>ptrInfoStructure<span class="token punctuation">,</span>infoArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CSInfo_Pack</span><span class="token punctuation">(</span>infoPackage<span class="token punctuation">,</span>infoArray<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>infoArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CSInfo_SendPack</span><span class="token punctuation">(</span>infoPackage<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>infoPackage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>向这个函数传入一个装有数据的结构体的指针ptrInfoStructure，依次调用CSInfo_2Array_uint8、CSInfo_Pack、CSInfo_SendPack这三个自定义函数，即可通过串口将结构体发送出去。</p> 
<p>这三个函数分别对应着擦拆分结构体、按照协议/规则封包和发送数据三个过程，具体说明和代码如下：</p> 
<h4><a id="1_410"></a>1、拆分</h4> 
<p>文章开头我们已经说了，先要把结构体拆分成8位无符号整型(uint8_t)的数据：</p> 
<pre><code class="prism language-c"><span class="token comment">/**
  * @brief  将数据段（CSInfoStructure）重组为uint8类型的数组
  * @param  
		infoSeg 指向一个CSInfoStructure的指针
	    infoArray 由数据段重组的uint8类型数组			
  * @retval 无
  */</span>
<span class="token keyword">void</span> <span class="token function">CSInfo_2Array_uint8</span><span class="token punctuation">(</span>ptrCSInfo infoSeg<span class="token punctuation">,</span>uint8_t<span class="token operator">*</span> infoArray<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> ptr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>uint8_t 
	<span class="token operator">*</span>infoElem<span class="token operator">=</span><span class="token punctuation">(</span>uint8_t<span class="token operator">*</span><span class="token punctuation">)</span>infoSeg<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>ptr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ptr<span class="token operator">&lt;</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>CSInfoS<span class="token punctuation">)</span><span class="token punctuation">;</span>ptr<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		infoArray<span class="token punctuation">[</span>ptr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>infoElem<span class="token operator">+</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>传入一个结构体的指针，并传入一个对应大小(uint8_t)类型的数组，用来装结构体拆分出来的元素。</p> 
<p>那么数组需要多大呢？我们知道8位(bit)就是一个字节(Byte)，所以这个数组理论上只需要和这个结构体的字节数一样大就可以了！也就是：</p> 
<pre><code class="prism language-c"><span class="token keyword">sizeof</span><span class="token punctuation">(</span>CSInfoS<span class="token punctuation">)</span>
</code></pre> 
<p>的返回值。这里我们也可以口算一下，结构体中总共有8个float类型的数据，也就是8×32bit=8×4Byte=32Byte。结构体的大小也就是32字节，所以可以拆分成32个unit8_t类型的元素，数组大小也就需要32。</p> 
<p>注意：传入的数组需要足够的大小，不要整个空指针或者不够大的数组进去。当然，你也可以返回一个数组，但我喜欢这种隐式返回的风格。</p> 
<h4><a id="2_441"></a>2、封包</h4> 
<p>选定一组特定的数据作为数据包的头部，选定另一组特定的数据作为数据包的尾部，方便我们在上位机接收数据后找到每一组数据的开始和结尾。</p> 
<p>这里我们选定:</p> 
<pre><code class="prism language-c"><span class="token number">0x80</span> <span class="token number">0x81</span> <span class="token number">0x82</span>
</code></pre> 
<p>作为数据包的头部，同时选定：</p> 
<pre><code class="prism language-c"><span class="token number">0x82</span> <span class="token number">0x81</span> <span class="token number">0x80</span>
</code></pre> 
<p>作为数据包的尾部。所以我们向上位机发送的单个数据包都是如下形式的：</p> 
<pre><code class="prism language-c"><span class="token comment">/**
	@part 通信协议
	@Protocol
    ------------------------------------------------------------
         头       |            信息              |      尾
	------------------------------------------------------------
	0x80|0x81|0x82|         CSInfoStrcutre       |0x82|0x81|0x80                 
	------------------------------------------------------------
	    3Byte     |            32Byte            |     3Byte 
    ------------------------------------------------------------
*/</span>
</code></pre> 
<p>上面|CSInfoStrcutre|的位置就是我们在上一步获得的uint8_t类型的数组infoArray，内容是CSInfoStrcutre中的数据。</p> 
<p>封包的过程如下面的代码所示：</p> 
<pre><code class="prism language-c"><span class="token comment">/**
  * @brief  按协议打包
  * @param  
		package 打包结果，按协议结果为3+32+3=38字节 （38*8bit）
	    infoArray 由数据段重组的uint8类型数组 | 结果	
		infoSize 数据段的大小--占用内存字节数（协议规定为32Byte）
  * @retval 无
  */</span>
<span class="token keyword">void</span> <span class="token function">CSInfo_Pack</span><span class="token punctuation">(</span>uint8_t<span class="token operator">*</span> infopackage<span class="token punctuation">,</span>uint8_t<span class="token operator">*</span> infoArray<span class="token punctuation">,</span>uint8_t infoSize<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	uint8_t ptr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	infopackage<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> HEAD1<span class="token punctuation">;</span>
	infopackage<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> HEAD2<span class="token punctuation">;</span>
	infopackage<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> HEAD3<span class="token punctuation">;</span>
	
	
	<span class="token comment">/* 将信息封如入数据包中 */</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>ptr<span class="token operator">&lt;</span>infoSize<span class="token punctuation">;</span>ptr<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		infopackage<span class="token punctuation">[</span>ptr<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> infoArray<span class="token punctuation">[</span>ptr<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	infopackage<span class="token punctuation">[</span>ptr<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> TAIL1<span class="token punctuation">;</span>
	infopackage<span class="token punctuation">[</span>ptr<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> TAIL2<span class="token punctuation">;</span>
	infopackage<span class="token punctuation">[</span>ptr<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> TAIL3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3_500"></a>3、发送</h4> 
<p>接着，我们将把这个玩意儿(infopackage)通过串口发送出去：</p> 
<pre><code class="prism language-c"><span class="token comment">/**
* @brief  将数据包发送到上位机
  * @param  
			infoPackage 数据包
			packSize 数据包的大小--占用内存字节数（协议规定为38Byte）
  * @retval 无
  */</span>
<span class="token keyword">void</span> <span class="token function">CSInfo_SendPack</span><span class="token punctuation">(</span>uint8_t<span class="token operator">*</span> infoPackage<span class="token punctuation">,</span>uint8_t packSize<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> ptr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>ptr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ptr<span class="token operator">&lt;</span>packSize<span class="token punctuation">;</span>ptr<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">USART_SendByte</span><span class="token punctuation">(</span>infoPackage<span class="token punctuation">[</span>ptr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意，为了方便使用，这里我们用到了一个名为USART_SendByte的自定义函数，其定义如下：</p> 
<pre><code class="prism language-c"> <span class="token comment">/**
  * @brief  通过USART通道向上位机发送一个字节（8bit）的数据
  * @param  byte 要发送的8位数据
  * @retval 无
  */</span>
<span class="token keyword">void</span> <span class="token function">USART_SendByte</span><span class="token punctuation">(</span>uint8_t byte<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* 发送一个字节数据到串口 */</span>
	<span class="token function">USART_SendData</span><span class="token punctuation">(</span>DEBUG_USARTx<span class="token punctuation">,</span>byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 等待发送完毕 */</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>DEBUG_USARTx<span class="token punctuation">,</span> USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>		
<span class="token punctuation">}</span>
</code></pre> 
<p>到这里，我们就了解完了下位机打包发送的部分，接下来我们转到上位机视角，看一下咋个接收数据，咋个解析数据，也就是咋个把数据又装回一个结构体里，方便我们引用。</p> 
<h3><a id="_536"></a>上位机接收数据并解包</h3> 
<p>回顾一下文章开头，我们说上位机的这部分工作的流程是这样的：</p> 
<pre><code class="prism language-bash">1、把串口里的数据读取出来
2、找到包头，
3、把数据包中对应数据的部分按顺序装填到结构体中
</code></pre> 
<p>大致流程如下面的代码所示：</p> 
<pre><code class="prism language-c">    <span class="token comment">/* 读取数据 */</span>
    uint8_t packages<span class="token punctuation">[</span>INFOSIZE<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> numHasRead <span class="token operator">=</span> <span class="token function">readInfoFromSerialport</span><span class="token punctuation">(</span>packages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 解析数据 */</span>
    uint8_t infoArray<span class="token punctuation">[</span>INFOSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/* 提取数据包 */</span>
    bool readable <span class="token operator">=</span> <span class="token function">CSInfo_GetInfoArrayInpackages</span><span class="token punctuation">(</span>infoArray<span class="token punctuation">,</span>packages<span class="token punctuation">,</span>numHasRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 解包 */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>readable<span class="token punctuation">)</span>
        <span class="token function">CSInfo_InfoArray2CSInfoS</span><span class="token punctuation">(</span>infoArray<span class="token punctuation">,</span>this<span class="token operator">-&gt;</span>_ptrCSInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>也即是依次调用readInfoFromSerialport、CSInfo_GetInfoArrayInpackages、CSInfo_InfoArray2CSInfoS在这三个函数，从串口缓冲区的一堆数据里找到一个完整的数据包并把它装填到结构体里。</p> 
<p>下面详细介绍这三个自定义函数：</p> 
<h4><a id="1_562"></a>1、读取数据</h4> 
<p>你可以用你所知的任何方法从串口的缓冲区读取出来，只要你能把它们放到一个方便后续的解包操作访问的地方。</p> 
<p>这里我使用Qt开发的上位机界面，故而也顺带使用Qt提供的serialport类中的方法来读取，具体可以参考Qt的帮助文档，这里只做简要说明：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
  * @brief  把当前serialport缓冲区的数据全部读取到一个uint8类型的数组中
  * @param
        packages 从串口读取到的包含数据包的数据
  * @retval
  *     numHasRead 从缓冲区读取到的字节数
  */</span>
<span class="token keyword">int</span> <span class="token function">readInfoFromSerialport</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span> packages<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> <span class="token function">numHasRead</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 没有可用的串口设备则中止读取操作 退出函数 */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>QSerialPortInfo<span class="token operator">::</span><span class="token function">availablePorts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    _port <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QSerialPort</span><span class="token punctuation">(</span>QSerialPortInfo<span class="token operator">::</span><span class="token function">availablePorts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _port<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setPort</span><span class="token punctuation">(</span>QSerialPortInfo<span class="token operator">::</span><span class="token function">availablePorts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>_port<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">open</span><span class="token punctuation">(</span>QIODevice<span class="token operator">::</span>ReadWrite<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">goto</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        _port<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setParity</span><span class="token punctuation">(</span>QSerialPort<span class="token operator">::</span>NoParity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _port<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setBaudRate</span><span class="token punctuation">(</span>QSerialPort<span class="token operator">::</span>Baud115200<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _port<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setDataBits</span><span class="token punctuation">(</span>QSerialPort<span class="token operator">::</span>Data8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _port<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setStopBits</span><span class="token punctuation">(</span>QSerialPort<span class="token operator">::</span>OneStop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _port<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setFlowControl</span><span class="token punctuation">(</span>QSerialPort<span class="token operator">::</span>NoFlowControl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 开始从serialport读取数据 */</span>
        <span class="token comment">/* 读取串口缓冲区所有的数据到CSInfo的缓冲区infoArray */</span>
        _port<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">waitForReadyRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        QByteArray dataArray <span class="token operator">=</span> _port<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numHasRead <span class="token operator">=</span> dataArray<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>INFOSIZE<span class="token operator">*</span><span class="token number">3</span><span class="token operator">&lt;</span>numHasRead<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>INFOSIZE<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span><span class="token punctuation">(</span>packages<span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> dataArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    next<span class="token operator">:</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span>  _port<span class="token punctuation">;</span>
    <span class="token keyword">return</span> numHasRead<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述代码首先获取了一个serialport类的对象_port，然后通过一系列的setxxx函数配置了必要的参数。接着调用readAll把串口中所有的数据读取到dataArray（readAll()的返回值就是一个QByteArray类型的容器），然后把大小等同于三个infoStructure的数据放到packages中，预备进行下一步的解包操作。</p> 
<p>注意，之所以要读取三个基数，是为了保证至少包含一个完整的数据包。</p> 
<h4><a id="2_612"></a>2、找到一个完整的数据包</h4> 
<pre><code class="prism language-bash">前面提到了，我们设定每个数据包的头部是0x80<span class="token operator">|</span>0x81<span class="token operator">|</span>0x82,而数据包的尾部则反过来。根据这个特征：
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">/**
	@part 通信协议
	@Protocol
    ------------------------------------------------------------
         头       |            信息              |      尾
	------------------------------------------------------------
	0x80|0x81|0x82|         CSInfoStrcutre       |0x82|0x81|0x80                 
	------------------------------------------------------------
	    3Byte     |            32Byte            |     3Byte 
    ------------------------------------------------------------
*/</span>
</code></pre> 
<p>我们可以先在上一步获得的packages中找到一个数据包的头部，以确定一个数据包的开始位置：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
  * @brief  在串口读取到的数据中提取出一个数据包的数据段（CSInfoStructure对应的部分）
  * 转存到infoArray中，供后续解析为CSInfoStructure.
  * @param
        infoArray 转存CSInfo的数组
        packages 从串口读取到的包含数据包的数据
        sizepackages 从串口读取到的字节数（packages的大小）
  * @retval 无
  */</span>
<span class="token keyword">bool</span> <span class="token function">CSInfo_GetInfoArrayInpackages</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span> infoArray<span class="token punctuation">,</span><span class="token keyword">uint8_t</span><span class="token operator">*</span> packages<span class="token punctuation">,</span><span class="token keyword">int</span> sizepackages<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ptr<span class="token punctuation">;</span><span class="token keyword">bool</span> <span class="token function">readable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sizepackages<span class="token operator">&lt;</span>INFOSIZE<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        readable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> readable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>ptr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ptr<span class="token operator">&lt;</span>INFOSIZE<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">;</span>ptr<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// or: for(ptr=0;ptr&lt;sizepackages-3;ptr++){ */</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packages<span class="token punctuation">[</span>ptr<span class="token punctuation">]</span><span class="token operator">==</span>HEAD1<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>packages<span class="token punctuation">[</span>ptr<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>HEAD2<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>packages<span class="token punctuation">[</span>ptr<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span>HEAD3<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ptr <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>INFOSIZE<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        infoArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> packages<span class="token punctuation">[</span>ptr<span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> readable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过调用这个函数，我们把packages中的一个完整的数据包的InfoStructure部分放到了infoArray中。接下看第三步，我们将把这个结构体的数据写入一个结构体中，真正还原它在下位机中的样子：</p> 
<h4><a id="3_663"></a>3、解析数据</h4> 
<p>直接把结构体当成一个数组，把数据依次填写进去就ok了</p> 
<pre><code class="prism language-c"><span class="token comment">/**
  * @brief  把存有一个数据段的数组解析为一个CSInfoStructure,结果存到参数2对应的地址
  * @param
        infoArray 存有一个数据段的uint8类型的数组
        infoStrc 从串口读取到的字节数（packages的大小）
  * @retval 无
  */</span>
<span class="token keyword">void</span> <span class="token function">CSInfo_InfoArray2CSInfoS</span><span class="token punctuation">(</span>uint8_t<span class="token operator">*</span> <span class="token keyword">const</span> infoArray<span class="token punctuation">,</span>ptrCSInfo infoStrc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    uint8_t<span class="token operator">*</span> u8PtrOStrc <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t<span class="token operator">*</span><span class="token punctuation">)</span>infoStrc<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>INFOSIZE<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>u8PtrOStrc<span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> infoArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>到这里，我们就完成了使用串口发送结构体的任务，而且了解了封包和解包的基本思路。</p> 
<p>我把上位机的源代码链接放到这里，需要的可以单击自取。读取和解析的代码分别在Sources/CSInfoReader.c和Sources/CSInfoParser.c文件中。</p> 
<h2><a id="UART_685"></a>三、嵌入式硬件通信接口协议-UART（五）数据包设计与解析</h2> 
<p><a href="https://blog.csdn.net/DigCore/article/details/85710462">https://blog.csdn.net/DigCore/article/details/85710462</a></p> 
<h3><a id="_688"></a>应用层数据包设计思路</h3> 
<p>回到工程本身，帧结构中的数据包才是应用程序最终需要解析使用的，且与具体的业务需求有关。</p> 
<p>这篇文章将简单介绍，在数据包里如何设计应用层的交互指令，从而实现具体的业务需求。分享个思路，就当抛砖引玉了。</p> 
<p>类似于帧结构，在设计数据包时，根据交互逻辑的具体需求，同样采用逐字节组成字段，字段组成数据包，从而完成指令交互。</p> 
<p>具体到项目中，一般地有目标地址、源地址、指令类型、传输方向、级联序号、参数ID、参数值等等。</p> 
<p>字段的定义因项目需求而定，以上提及的字段可能存在且不限于此。</p> 
<p>以下介绍在具体项目中，对数据包设计与解析思路。工程实践中方法众多，相信很多经验娴熟的老工程师肯定都有各自巧妙的编程思路，欢迎在本页留言交流。</p> 
<h3><a id="_705"></a>项目案例</h3> 
<p>基于nRF51822的BLE终端设备，与上位机使用UART通信，物理线路使用USB转UART。</p> 
<h4><a id="_708"></a>常规解析过程</h4> 
<p>解析函数，一般地会把输入参数的 *indata，利用一个新的结构体指针指向该输入参数，之后的解析使用结构体指针来对数据处理，增强代码可读性！<br> 常规的判断处理，多采用switch(){case :}联合if(…){;}else(…){;}判断逻辑，这个模式的判断处理架构如下：</p> 
<p><mark><strong>以上的做法，依次去判断类型type、参数名para，然后直接处理。当这两个字段的枚举成员数量少，倒还可以这么判断；但是如果工程需要扩展、业务有了新的需求，那么if(…){;}else(…){;}的逐一判断将会使得解析函数里的代码量巨大！</strong></mark></p> 
<p><strong>总结有这几个缺点：</strong><br> <mark><strong>1.业务需求有多少个类型或者其他分支，就需要多少个这样的判断逻辑，对于编写代码变成个体力活；<br> 2.在代码查看、维护时，面对的还是罗列了一大堆的switch(){case :}和if(…){;}else(…){;}语句；<br> 3.增删功能时，需要找到代码中具体的判断位置，然后小心翼翼给注释或者修改掉。</strong></mark></p> 
<p>这里已经没有任何的技术含量，基本上就是复制粘贴判断语句、修改判断对象，说到底也就是个查表的过程！</p> 
<h4><a id="_722"></a>构建查表方式解析</h4> 
<p>既然要查表，当然是有个while()循环，然后递增某一变量来查表的过程。在这里，数据包结构体中定义的类型type、参数名para，都可以作为查表的对象，该如何选择？</p> 
<p>假设：<br> <mark><strong>1.以类型作为查表对象，假如查表后类型等于查询参数，那么参数名仍然是个多个分支的情况，要么继续查表要么继续采用switch(){case :}或者if(…){;}else(…){;}来判断众多不同的参数名；<br> 2.以参数名作为查表对象，假如查表后参数名等于设备运行状态，那么类型需要做最多三种判断：查询、设置、其他。</strong></mark></p> 
<p>对比以上两种，必然是第2个更能提高编程效率、缕清逻辑框架。</p> 
<p>要查表就要建表，建表的结构体，以参数名para作为被查对象，并且以回调函数的形式执行查表结果。建表如下：</p> 
<p>在执行数据包解析的时候，查表的思路是：</p> 
<p><mark><strong>1.先创建一个表结构的指针<em>ptable指向表的开始位置，也就是指向数组内第一个元素{ECHO, dcapp_dev_echo}<br> 2.再创建一个数据包结构的指针</em>pbuf指向输入数据首地址<br> 3.通过递增ptable指针，对ptable与pbuf的参数名成员进行比对<br> 4.最后执行ptable指针对应回调函数</strong></mark></p> 
<p>以上的思路，放到代码中，仅仅数行就可以实现对输入数据包参数名的解析！高效、清晰！</p> 
<p>另外，建表时，把无效参数名对应的值和对应的回调函数放在最后，这样做的好处是查完整个表，无需区分是否找到对应的参数名，而直接执行指针对应的回调函数即可。</p> 
<p>这样即使是未找到参数名，也会执行表中最后一个元素，就是错误解析的回调函数dcapp_parser_err()。</p> 
<p>有了这样一个查表的处理方式，增删指令功能就变得简单太多了！增加功能，只需要在表中添加参数名和对应的回调函数，删除某功能，也是回到表中找到对应的参数名和回调函数即可！</p> 
<p>总结一下，虽然查表方式非常清晰，但是对应的回调函数内部，需要独自处理和实现，并且每个参数名都需要单独处理。相比于采用switch(){case :}联合if(…){;}else(…){;}判断逻辑，确实清晰很多。</p> 
<p>以上的查表思路，来源于经历的项目，同时还参考了</p> 
<p>《STM32CubeExpansion_MEMSMIC1_V1.1》</p> 
<p>这个ST官方的数字麦克风开源项目示例，作为USB音频设备时，类似的回调函数方式：</p> 
<h2><a id="DLT_645DLT_698_764"></a>四、DL-T 645协议格式或者DL-T 698协议格式的数据帧的串口解析思路</h2> 
<p><a href="https://blog.csdn.net/weixin_40872563/article/details/95076982">https://blog.csdn.net/weixin_40872563/article/details/95076982</a></p> 
<p>题目要求如下：</p> 
<p>用C语言写一个程序，此程序持续从串口读取数据（串口速率是115200，偶校验），串口数据有可能包含DL-T 645协议格式或者DL-T 698协议格式的数据帧（协议见word文档）。<br> 要求把收到的符合以上两种格式的数据帧检出来。<br> 附加要求：注意程序的可扩展性（如果以后此程序再支持其他协议数据解析，要容易扩展）。*<br> 由于文档比较内容繁琐，特贴出来，协议格式</p> 
<p>DL-T 645协议格式<br> (以下简称协议A)</p> 
<p><img src="https://images2.imgbox.com/97/5a/MQ35zEFO_o.png" alt="在这里插入图片描述"><br> DL-T 698协议格式<br> (以下简称协议B)<br> <img src="https://images2.imgbox.com/2f/7e/jrbb26iO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_781"></a>串口解析思路</h3> 
<pre><code class="prism language-bash"> - 一、串口数据接收： 	
 		定义一个1024字节的buf，将串口接收到的数据依次追加到此buf中； 
 - 二、解析串口数据流程：
 		1、从buf中检索起始字符0x68的位置，-<span class="token operator">&gt;</span>2
 		2、去匹配是否符合协议A，会有三种解析结果
 			a.解析到完整的一帧数据，-<span class="token operator">&gt;</span>5
 			b.数据未接收完 -<span class="token operator">&gt;</span>3
 			c.解析不满足规则 -<span class="token operator">&gt;</span>3
 		3、去匹配是否符合协议B，会有三种解析结果
 			a.解析到完整的一帧数据， -<span class="token operator">&gt;</span>5
 			b.数据未接收完 -<span class="token operator">&gt;</span>6
 			c.解析不满足规则
 				协议A也不满足规则 -<span class="token operator">&gt;</span>7
 				协议A未接收完 -<span class="token operator">&gt;</span>6
 		5、解析到完整的一帧数据，-<span class="token operator">&gt;</span>10
 		6、协议匹配未接收完 -<span class="token operator">&gt;</span>9
 		7、两个协议解析都不满足，-<span class="token operator">&gt;</span>8
 		8、从1中的位置继续寻找下一个0x68的位置
 			a.找到0x68    -<span class="token operator">&gt;</span>1
 			b.未找到0x68 -<span class="token operator">&gt;</span>6
 		9、继续循环，等待串口数据过来
 		10、解析完成，将buf中剩余数据前移到位置0，
</code></pre> 
<p>代码如下：<br> 先定义两种协议对应的结构体</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dl_t_698
<span class="token punctuation">{<!-- --></span>
    uint8_t st_byte<span class="token punctuation">;</span><span class="token comment">//起始字符</span>
    uint16_t data_length<span class="token punctuation">;</span><span class="token comment">//长度域--此处注意大小端的问题</span>
    uint8_t control_byte<span class="token punctuation">;</span><span class="token comment">//控制域</span>
    uint8_t address_bytes<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//地址域</span>
    uint16_t frame_head_hcs<span class="token punctuation">;</span><span class="token comment">//帧头校验</span>
    uint8_t user_data<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//用户数据</span>
    uint16_t frame_crc_fcs<span class="token punctuation">;</span><span class="token comment">//帧校验</span>
    uint8_t end_byte<span class="token punctuation">;</span><span class="token comment">//结束字符</span>
<span class="token punctuation">}</span>dlt_698_frame_body<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> dl_t_645
<span class="token punctuation">{<!-- --></span>
    uint8_t st_byte<span class="token punctuation">;</span><span class="token comment">//帧起始符</span>
    uint8_t address_bytes<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//地址欲</span>
    uint8_t mid_st_byte<span class="token punctuation">;</span><span class="token comment">//帧起始符</span>
    uint8_t control_byte<span class="token punctuation">;</span><span class="token comment">//控制码</span>
    uint16_t data_length<span class="token punctuation">;</span><span class="token comment">//长度域--此处注意大小端的问题-- 前面字符长度为10</span>
    uint8_t user_data<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//数据data</span>
    uint16_t frame_crc_cs<span class="token punctuation">;</span><span class="token comment">//校验</span>
    uint8_t end_byte<span class="token punctuation">;</span><span class="token comment">//结束字符</span>
<span class="token punctuation">}</span>dlt_645_frame_body<span class="token punctuation">;</span>

<span class="token comment">//解析到一帧数据可能出现的情况</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span> frame_result
<span class="token punctuation">{<!-- --></span>
    UNKNOWN<span class="token punctuation">,</span>
    OK<span class="token punctuation">,</span>               <span class="token comment">//成功找到一帧</span>
    UNFINISHED<span class="token punctuation">,</span><span class="token comment">//未接收完成</span>
    ERROR<span class="token punctuation">,</span>        <span class="token comment">//不满足此协议</span>
<span class="token punctuation">}</span> frame_result_t<span class="token punctuation">;</span>

<span class="token comment">//定义协议类型</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span> protocol_type <span class="token punctuation">{<!-- --></span>
    PROTOCOL_UNKNOWN<span class="token punctuation">,</span>
    PROTOCOL_DL_T_698<span class="token punctuation">,</span>
    PROTOCOL_DL_T_645<span class="token punctuation">,</span>
    PROTOCOL_OTHER<span class="token punctuation">,</span>
<span class="token punctuation">}</span>protocol_type_t<span class="token punctuation">;</span>

<span class="token keyword">char</span> uart_rcvd_buf<span class="token punctuation">[</span>UART_BUFFER_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//接收串口发送过来的数据</span>
<span class="token keyword">char</span> frame_buf<span class="token punctuation">[</span>FRAME_BUFFER_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//用来存取一帧数据</span>
uint16_t uart_rcvd_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//当前buf接收到的数据长度</span>

dlt_698_frame_body s_dlt_698_frame_body<span class="token punctuation">;</span>
dlt_645_frame_body s_dlt_645_frame_body<span class="token punctuation">;</span>

<span class="token comment">/*
 * 功能:接收串口过来的数据
 **/</span>
<span class="token comment">/*void uart_rev_data(uint8_t data)
{
    uart_rcvd_buf[uart_rcvd_len] = data;
    uart_rcvd_len++; 

    if (uart_rcvd_len &gt;= UART_BUFFER_LEN) {
        //清空所有命令
        uart_rcvd_len = 0;
        //my_memset(uart_rcvd_buf,0,sizeof(uart_rcvd_buf));
    } 
}*/</span>

<span class="token comment">/*
 * 该函数由库函数调用
 **/</span>
<span class="token comment">/*void UART_INT_Func(void)
{
    uint8_t u8TempData=0;

    if(1 == M0P_UART1-&gt;ISR_f.RI)
    {    
        u8TempData = M0P_UART1-&gt;SBUF_f.SBUF; 
        uart_rev_data(u8TempData);          
        
        M0P_UART1-&gt;ICR_f.RICLR = 0;
    }    
}*/</span>

<span class="token comment">/*
 * 功能:检索一帧数据将值赋给结构体       
 * 校验OK return 1;
 **/</span>
uint8_t <span class="token function">parse_dlt645_frame</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p_frame<span class="token punctuation">,</span> uint16_t frame_len<span class="token punctuation">,</span> dlt_645_frame_body<span class="token operator">*</span> sframe_body<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    uint16_t temp16_t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//一帧数据的总长度</span>
    uint16_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//计算校验码</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> frame_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        temp16_t <span class="token operator">+</span><span class="token operator">=</span> p_frame<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>temp16_t <span class="token operator">==</span> p_frame<span class="token punctuation">[</span>frame_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|</span> p_frame<span class="token punctuation">[</span>frame_len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        sframe_body<span class="token operator">-&gt;</span>st_byte <span class="token operator">=</span> p_frame<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sframe_body<span class="token operator">-&gt;</span>address_bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p_frame<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">+</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        sframe_body<span class="token operator">-&gt;</span>mid_st_byte <span class="token operator">=</span> p_frame<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sframe_body<span class="token operator">-&gt;</span>control_byte <span class="token operator">=</span> p_frame<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        temp16_t <span class="token operator">=</span> <span class="token punctuation">(</span>p_frame<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span>p_frame<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sframe_body<span class="token operator">-&gt;</span>data_length <span class="token operator">=</span> temp16_t<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> temp16_t<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sframe_body<span class="token operator">-&gt;</span>user_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p_frame<span class="token punctuation">[</span><span class="token number">11</span> <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sframe_body<span class="token operator">-&gt;</span>frame_crc_cs <span class="token operator">=</span> p_frame<span class="token punctuation">[</span>frame_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|</span> p_frame<span class="token punctuation">[</span>frame_len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sframe_body<span class="token operator">-&gt;</span>end_byte <span class="token operator">=</span> p_frame<span class="token punctuation">[</span>frame_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token comment">/*
 * 功能:检索一帧数据将值赋给结构体               
 **/</span>
uint8_t <span class="token function">parse_dlt698_frame</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>p_frame<span class="token punctuation">,</span> uint16_t frame_len<span class="token punctuation">,</span> dlt_698_frame_body<span class="token operator">*</span> sframe_body<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    uint16_t temp16_t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//一帧数据的总长度</span>
    uint16_t adr_temp16_t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//地址域的地址长度</span>
    uint16_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//校验</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> frame_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        temp16_t <span class="token operator">+</span><span class="token operator">=</span> p_frame<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>temp16_t <span class="token operator">==</span> p_frame<span class="token punctuation">[</span>frame_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|</span> p_frame<span class="token punctuation">[</span>frame_len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        
        sframe_body<span class="token operator">-&gt;</span>st_byte <span class="token operator">=</span> p_frame<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        temp16_t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p_frame<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span>p_frame<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3FFF</span><span class="token punctuation">;</span>
        sframe_body<span class="token operator">-&gt;</span>data_length <span class="token operator">=</span> temp16_t<span class="token punctuation">;</span>
        sframe_body<span class="token operator">-&gt;</span>control_byte <span class="token operator">=</span> p_frame<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sframe_body<span class="token operator">-&gt;</span>address_bytes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p_frame<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//地址域第一个字节</span>
        adr_temp16_t <span class="token operator">=</span> p_frame<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> adr_temp16_t<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sframe_body<span class="token operator">-&gt;</span>address_bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p_frame<span class="token punctuation">[</span><span class="token number">5</span> <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sframe_body<span class="token operator">-&gt;</span>frame_head_hcs <span class="token operator">=</span> <span class="token punctuation">(</span>p_frame<span class="token punctuation">[</span><span class="token number">6</span> <span class="token operator">+</span> adr_temp16_t <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> p_frame<span class="token punctuation">[</span><span class="token number">6</span> <span class="token operator">+</span> adr_temp16_t<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> temp16_t<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sframe_body<span class="token operator">-&gt;</span>user_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p_frame<span class="token punctuation">[</span>adr_temp16_t <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sframe_body<span class="token operator">-&gt;</span>frame_crc_fcs <span class="token operator">=</span> p_frame<span class="token punctuation">[</span>frame_len <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|</span> p_frame<span class="token punctuation">[</span>frame_len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sframe_body<span class="token operator">-&gt;</span>end_byte <span class="token operator">=</span> p_frame<span class="token punctuation">[</span>frame_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token comment">/*
 * 功能:从缓存区buf中检索dlt645帧数据
 * 将一帧数据读取到frame_buf中     
 * line:缓存区0x68开头的数据
 * out:将捡出来的帧复制到该数组中
 * frame_len:捡出来的帧的长度，
 * line_len:缓存区buf中0x68开头的数据长度
 **/</span>
frame_result_t <span class="token function">find_dlt645_frame</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> line<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> out<span class="token punctuation">,</span> uint16_t<span class="token operator">*</span> frame_len<span class="token punctuation">,</span> uint16_t line_len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    uint16_t frame_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//一帧数据的总长度</span>
    uint16_t temp_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>line_len <span class="token operator">&lt;</span> DLT_645_LEAST_LEN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> UNFINISHED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//判断第七位</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0x68</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    frame_length <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span><span class="token comment">/*帧起始符+地址域+帧起始符+控制域*/</span>
    temp_len <span class="token operator">=</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span>line<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//数据data的长度</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"645 data len = %d\n"</span><span class="token punctuation">,</span> temp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    frame_length <span class="token operator">=</span> frame_length <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> temp_len<span class="token punctuation">;</span><span class="token comment">/*2-长度域占的字节*/</span>
    frame_length <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">/*校验码和结束符*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_length <span class="token operator">&gt;</span> FRAME_BUFFER_LEN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//超过单包缓存区的最大长度</span>
        <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_length <span class="token operator">&lt;=</span> line_len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span>frame_length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x16</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//检到一帧数据                </span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>temp_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> temp_len <span class="token operator">&lt;</span> frame_length<span class="token punctuation">;</span> temp_len <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    out<span class="token punctuation">[</span>temp_len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>line<span class="token punctuation">;</span>
                    line<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token operator">*</span>frame_len <span class="token operator">=</span> frame_length<span class="token punctuation">;</span>
                <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//不满足此协议的0x16结束符</span>
                <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//数据还没接收完整</span>
            <span class="token keyword">return</span> UNFINISHED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> UNKNOWN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 功能:从缓存区buf中检索dlt698帧数据
 * 将一帧数据读取到frame_buf中     
 * line:缓存区0x68开头的数据
 * out:将捡出来的帧复制到该数组中
 * frame_len:捡出来的帧的长度，
 * line_len:缓存区buf中0x68开头的数据长度
 **/</span>
frame_result_t <span class="token function">find_dlt698_frame</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> line<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> out<span class="token punctuation">,</span> uint16_t<span class="token operator">*</span> frame_len<span class="token punctuation">,</span> uint16_t line_len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    uint16_t frame_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//一帧数据的总长度</span>
    uint16_t temp_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>line_len <span class="token operator">&lt;</span> DLT_698_LEAST_LEN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> UNFINISHED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    frame_length <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">/*起始符+长度域+控制域*/</span>
    <span class="token comment">//地址域</span>
    temp_len <span class="token operator">=</span> line<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">;</span>
    <span class="token comment">//printf("698 address len = %d\n", temp_len);    </span>
    frame_length <span class="token operator">=</span> frame_length <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> temp_len<span class="token punctuation">;</span>
    <span class="token comment">//帧头校验</span>
    frame_length <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">//用户数据长度</span>
    temp_len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3FFF</span><span class="token punctuation">;</span>
    <span class="token comment">//printf("698 data len = %d\n", temp_len);</span>
    frame_length <span class="token operator">+</span><span class="token operator">=</span> temp_len<span class="token punctuation">;</span><span class="token comment">//data长度</span>
    <span class="token comment">//</span>
    frame_length <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//帧校验+结束符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_length <span class="token operator">&gt;</span> FRAME_BUFFER_LEN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//超过单包缓存区的最大长度</span>
        <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_length <span class="token operator">&lt;=</span> line_len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span>frame_length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x16</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//检到一帧数据                </span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>temp_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> temp_len <span class="token operator">&lt;</span> frame_length<span class="token punctuation">;</span> temp_len <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    out<span class="token punctuation">[</span>temp_len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>line<span class="token punctuation">;</span>
                    line<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token operator">*</span>frame_len <span class="token operator">=</span> frame_length<span class="token punctuation">;</span>
                <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//不满足此协议的0x16结束符</span>
                <span class="token keyword">return</span> ERROR<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//数据还没接收完整        </span>
            <span class="token keyword">return</span> UNFINISHED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> UNKNOWN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 功能:协议数据解析
 **/</span>
<span class="token keyword">void</span> parse_buf <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    uint16_t frame_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//一帧数据的总长度</span>
    uint16_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> temp_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    uint8_t has_content <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//buf中是否有数据</span>
    uint8_t frame_error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//缓存区当前的数据对所有协议都不满足</span>
    <span class="token keyword">char</span><span class="token operator">*</span> p_buf<span class="token punctuation">;</span>
    protocol_type_t protl_type <span class="token operator">=</span> PROTOCOL_UNKNOWN<span class="token punctuation">;</span>
    frame_result_t find_frame_re <span class="token operator">=</span> UNKNOWN<span class="token punctuation">;</span>

    <span class="token comment">//用来保存每个协议解析后的结果 </span>
    <span class="token comment">//frame_results[0] 保存PROTOCOL_DL_T_645协议解析结果</span>
    <span class="token comment">//frame_results[1] 保存PROTOCOL_DL_T_698协议解析结果</span>
    frame_result_t frame_results<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>UNKNOWN<span class="token punctuation">,</span> UNKNOWN<span class="token punctuation">}</span><span class="token punctuation">;</span> 

    has_content <span class="token operator">=</span> uart_rcvd_pos <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>has_content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        p_buf <span class="token operator">=</span> uart_rcvd_buf<span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p_buf = %#x\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>p_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//检索0x68开头的数据</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p_buf <span class="token operator">!=</span> <span class="token number">0x68</span> <span class="token operator">&amp;&amp;</span> p_buf <span class="token operator">&lt;</span> uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            p_buf <span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p_buf <span class="token operator">==</span> uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//检索当前包数据，都不包含，清空</span>
            uart_rcvd_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//uart_rcvd_buf中剩余的数据长度</span>
        temp_len <span class="token operator">=</span> uart_rcvd_pos <span class="token operator">-</span> <span class="token punctuation">(</span>p_buf <span class="token operator">-</span> uart_rcvd_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"while start has_content uart_rcvd_pos - (p_buf - uart_rcvd_buf) = %d\n"</span><span class="token punctuation">,</span> temp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//以下处理不包含校验</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>protl_type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> PROTOCOL_UNKNOWN<span class="token punctuation">:</span>
                <span class="token function">memset</span><span class="token punctuation">(</span>frame_buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>frame_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                find_frame_re <span class="token operator">=</span> UNKNOWN<span class="token punctuation">;</span>
                frame_error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                frame_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    frame_results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> UNKNOWN<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
            <span class="token keyword">case</span> PROTOCOL_DL_T_645<span class="token punctuation">:</span>
                find_frame_re <span class="token operator">=</span> <span class="token function">find_dlt645_frame</span><span class="token punctuation">(</span>p_buf<span class="token punctuation">,</span> frame_buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame_length<span class="token punctuation">,</span> temp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                frame_results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> find_frame_re<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>find_frame_re <span class="token operator">==</span> OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nfind dlt_645 OK frame_buf = %s, frame_length = %d\n"</span><span class="token punctuation">,</span> frame_buf<span class="token punctuation">,</span> frame_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    
                    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s_dlt_645_frame_body<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parse_dlt645_frame</span><span class="token punctuation">(</span>frame_buf<span class="token punctuation">,</span> frame_length<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s_dlt_645_frame_body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//解析到一包有效数据</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
            <span class="token keyword">case</span> PROTOCOL_DL_T_698<span class="token punctuation">:</span>
                find_frame_re <span class="token operator">=</span> <span class="token function">find_dlt698_frame</span><span class="token punctuation">(</span>p_buf<span class="token punctuation">,</span> frame_buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame_length<span class="token punctuation">,</span> temp_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                frame_results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> find_frame_re<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>find_frame_re <span class="token operator">==</span> OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nfind dlt_698 OK frame_buf = %s, frame_length = %d\n"</span><span class="token punctuation">,</span> frame_buf<span class="token punctuation">,</span> frame_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s_dlt_698_frame_body<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_698_frame_body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token keyword">case</span> PROTOCOL_OTHER<span class="token punctuation">:</span>
                <span class="token comment">//此处添加其他协议解析</span>
                <span class="token comment">//break;</span>
                
            <span class="token keyword">default</span> <span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> ERROR <span class="token operator">&amp;&amp;</span> frame_results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//缓存区的数据不满足现有协议的解析</span>
                    <span class="token comment">//继续找下一个0x68起始符</span>
                    p_buf <span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//跳过当前的0x68</span>
                    <span class="token comment">//检索0x68开头的数据</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p_buf <span class="token operator">!=</span> <span class="token number">0x68</span> <span class="token operator">&amp;&amp;</span> p_buf <span class="token operator">&lt;</span> uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        p_buf <span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>p_buf <span class="token operator">==</span> uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//检索当前包数据，都不包含，清空</span>
                        uart_rcvd_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">//找到下一条0x68开头的数据帧</span>
                    frame_error <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">//当成功检索到一帧数据或缓存区的数据不满足现有协议的解析</span>
        <span class="token comment">//buf中剩余的有效数据前移</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>find_frame_re <span class="token operator">==</span> OK <span class="token operator">||</span> frame_error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//uart_rcvd_buf剩余的数据长度</span>
            temp_len <span class="token operator">=</span> uart_rcvd_pos <span class="token operator">-</span> <span class="token punctuation">(</span>p_buf <span class="token operator">-</span> uart_rcvd_buf<span class="token punctuation">)</span> <span class="token operator">-</span> frame_length<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>temp_len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//当前uart_rcvd_buf中剩余的数据前移</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> temp_len<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    uart_rcvd_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>p_buf <span class="token operator">+</span> frame_length <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">*</span><span class="token punctuation">(</span>p_buf <span class="token operator">+</span> frame_length <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                has_content <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//继续循环解析</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//解析过的位清空</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>p_buf <span class="token operator">-</span> uart_rcvd_buf<span class="token punctuation">)</span> <span class="token operator">+</span> frame_length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    uart_rcvd_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                has_content <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            uart_rcvd_pos <span class="token operator">=</span> temp_len<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            has_content <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"while end has_content = %d, uart_rcvd_pos = %d\n"</span><span class="token punctuation">,</span> has_content<span class="token punctuation">,</span> uart_rcvd_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    uint16_t timer<span class="token punctuation">;</span>

    <span class="token comment">//RCH 24MHz 使用内部时钟</span>
    <span class="token function">Clk_SwitchTo</span><span class="token punctuation">(</span>ClkRCL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Clk_SetRCHFreq</span><span class="token punctuation">(</span>ClkFreq24Mhz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Clk_SwitchTo</span><span class="token punctuation">(</span>ClkRCH<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//enable module clk</span>
    M0P_CLOCK<span class="token operator">-&gt;</span>PERI_CLKEN_f<span class="token punctuation">.</span>GPIO <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//打开GPIO的clk</span>
    M0P_CLOCK<span class="token operator">-&gt;</span>PERI_CLKEN_f<span class="token punctuation">.</span>BASETIM <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    M0P_CLOCK<span class="token operator">-&gt;</span>PERI_CLKEN_f<span class="token punctuation">.</span>UART1   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    M0P_CLOCK<span class="token operator">-&gt;</span>PERI_CLKEN_f<span class="token punctuation">.</span>I2C   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">//UART init    </span>
    <span class="token function">Gpio_SetFunc_UART1TX_P23</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Gpio_SetFunc_UART1RX_P24</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    

    M0P_UART1<span class="token operator">-&gt;</span>SCON_f<span class="token punctuation">.</span>DBAUD <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">//双倍波特率</span>
    timer <span class="token operator">=</span> <span class="token number">0x10000</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">24000000</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//单倍波特率，定时器配置</span>
    <span class="token comment">//使用basetimer1作为串口的波特率产生器   </span>
    M0P_BT1<span class="token operator">-&gt;</span>CR_f<span class="token punctuation">.</span>GATE_P <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>
    M0P_BT1<span class="token operator">-&gt;</span>CR_f<span class="token punctuation">.</span>GATE   <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>
    M0P_BT1<span class="token operator">-&gt;</span>CR_f<span class="token punctuation">.</span>PRS    <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>
    M0P_BT1<span class="token operator">-&gt;</span>CR_f<span class="token punctuation">.</span>TOG_EN <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>
    M0P_BT1<span class="token operator">-&gt;</span>CR_f<span class="token punctuation">.</span>CT     <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span>         <span class="token comment">//定时器模式</span>
    M0P_BT1<span class="token operator">-&gt;</span>CR_f<span class="token punctuation">.</span>MD     <span class="token operator">=</span> <span class="token number">1u</span><span class="token punctuation">;</span>         <span class="token comment">//重载模式</span>
    M0P_BT1<span class="token operator">-&gt;</span>ARR_f<span class="token punctuation">.</span>ARR <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    M0P_BT1<span class="token operator">-&gt;</span>CNT_f<span class="token punctuation">.</span>CNT <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    M0P_BT1<span class="token operator">-&gt;</span>CR_f<span class="token punctuation">.</span>TR <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>

    M0P_UART1<span class="token operator">-&gt;</span>SCON_f<span class="token punctuation">.</span>SM01 <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>     <span class="token comment">//模式1</span>
    M0P_UART1<span class="token operator">-&gt;</span>SCON_f<span class="token punctuation">.</span>SM2  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">//多主机通信disable</span>

    <span class="token function">EnableNvic</span><span class="token punctuation">(</span>UART1_IRQn<span class="token punctuation">,</span> <span class="token number">3u</span><span class="token punctuation">,</span> TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    M0P_UART1<span class="token operator">-&gt;</span>SCON_f<span class="token punctuation">.</span>TIEN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    M0P_UART1<span class="token operator">-&gt;</span>SCON_f<span class="token punctuation">.</span>RIEN <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    
    M0P_UART1<span class="token operator">-&gt;</span>ICR_f<span class="token punctuation">.</span>RICLR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    M0P_UART1<span class="token operator">-&gt;</span>ICR_f<span class="token punctuation">.</span>TICLR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    
    M0P_UART1<span class="token operator">-&gt;</span>SCON_f<span class="token punctuation">.</span>REN <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

</code></pre> 
<p>测试代码</p> 
<pre><code class="prism language-c"><span class="token keyword">char</span><span class="token operator">*</span> p_temp<span class="token punctuation">;</span>
    uint8_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> dlt_645_frame_msg<span class="token punctuation">[</span><span class="token number">38</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span> 
                                                                    <span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">,</span> 
                                                                    <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span> 
                                                                    <span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> dlt_698_frame_msg<span class="token punctuation">[</span><span class="token number">34</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span>
                                                                    <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">0x0F</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">,</span>
                                                                    <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span>
                                                                    <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">0x0F</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0x16</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">char</span> error_frame_msg<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> 
                                                <span class="token number">0x16</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">}</span><span class="token punctuation">;</span>


    <span class="token keyword">char</span> dlt_645_frame_msg_half_st<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span> 
                                                                    <span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">,</span> 
                                                                    <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> dlt_645_frame_msg_half_end<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    
    p_temp <span class="token operator">=</span> uart_rcvd_buf<span class="token punctuation">;</span>


<span class="token comment">//DLT_645 TEST</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt 645 start ******\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//stpcpy(uart_rcvd_buf, dlt_645_frame_msg);</span>
    <span class="token comment">//strcat(uart_rcvd_buf, end_byte);</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uart_rcvd_buf<span class="token punctuation">,</span> dlt_645_frame_msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uart_rcvd_pos <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main start 645 msg uart_rcvd_buf = %s, uart_rcvd_pos = %d\n"</span><span class="token punctuation">,</span> uart_rcvd_buf<span class="token punctuation">,</span> uart_rcvd_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">parse_buf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt 645 end ******\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>


<span class="token comment">//DLT_698 TEST</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt 698 start ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uart_rcvd_buf<span class="token punctuation">,</span> dlt_698_frame_msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_698_frame_msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uart_rcvd_pos <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_698_frame_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main start 698 msg uart_rcvd_buf = %s, uart_rcvd_pos = %d\n"</span><span class="token punctuation">,</span> uart_rcvd_buf<span class="token punctuation">,</span> uart_rcvd_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">parse_buf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt 698 end ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>


<span class="token comment">//ALL TEST</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt 698 and 645 start ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">,</span> dlt_698_frame_msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_698_frame_msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uart_rcvd_pos <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_698_frame_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">,</span> dlt_645_frame_msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uart_rcvd_pos <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main start 698 and 645 msg uart_rcvd_buf = %s, uart_rcvd_pos = %d\n"</span><span class="token punctuation">,</span> uart_rcvd_buf<span class="token punctuation">,</span> uart_rcvd_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//parse_buf();</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt 698 and 645 end ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token comment">//Error msg TEST</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 1</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt error msg start ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">,</span> error_frame_msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>error_frame_msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uart_rcvd_pos <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>error_frame_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main start error msg uart_rcvd_buf = %s, uart_rcvd_pos = %d\n"</span><span class="token punctuation">,</span> uart_rcvd_buf<span class="token punctuation">,</span> uart_rcvd_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//parse_buf();</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt error msg end ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>


<span class="token comment">//Half test</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 1</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt 645 half start ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">,</span> dlt_645_frame_msg_half_st<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg_half_st<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uart_rcvd_pos <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg_half_st<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">parse_buf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt 645 half middle +++ ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">,</span> dlt_645_frame_msg_half_end<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg_half_end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uart_rcvd_pos <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg_half_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main start 645 half msg uart_rcvd_buf = %s, uart_rcvd_pos = %d\n"</span><span class="token punctuation">,</span> uart_rcvd_buf<span class="token punctuation">,</span> uart_rcvd_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt 645 half end ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token comment">//ALL TEST</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 1</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt 698 and 645 start ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">,</span> dlt_645_frame_msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uart_rcvd_pos <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">,</span> dlt_698_frame_msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_698_frame_msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uart_rcvd_pos <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_698_frame_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">,</span> dlt_645_frame_msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uart_rcvd_pos <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dlt_645_frame_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main start 698 and 645 msg uart_rcvd_buf = %s, uart_rcvd_pos = %d\n"</span><span class="token punctuation">,</span> uart_rcvd_buf<span class="token punctuation">,</span> uart_rcvd_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt 698 and 645 end ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token comment">//Error msg TEST</span>
<span class="token macro property">#<span class="token directive keyword">if</span> 1</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt error msg start ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>uart_rcvd_buf <span class="token operator">+</span> uart_rcvd_pos<span class="token punctuation">,</span> error_frame_msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>error_frame_msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uart_rcvd_pos <span class="token operator">+</span><span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>error_frame_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main start error msg uart_rcvd_buf = %s, uart_rcvd_pos = %d\n"</span><span class="token punctuation">,</span> uart_rcvd_buf<span class="token punctuation">,</span> uart_rcvd_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//parse_buf();</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n ****** dlt error msg end ******\n "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token function">parse_buf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main end msg uart_rcvd_buf = %s, uart_rcvd_pos = %d\n"</span><span class="token punctuation">,</span> uart_rcvd_buf<span class="token punctuation">,</span> uart_rcvd_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="Qt__1379"></a>五、Qt 实现数据协议控制–组帧、组包、解析帧、解析包</h2> 
<p><a href="https://blog.csdn.net/qq_21291397/article/details/109641476">https://blog.csdn.net/qq_21291397/article/details/109641476</a></p> 
<h3><a id="_1382"></a>数据传输中的组帧和组包</h3> 
<h3><a id="_1383"></a>一、数据帧，数据包的概念</h3> 
<p><strong>数据帧</strong><br> 数据传输往往都有一定的协议，通过CRC校验来验证数据的可靠性。数据帧包含三部分，帧头、数据部分、帧尾。其中帧头和帧尾包含一些必要的控制信息，比如同步信息，地址信息、差错控制信息等等。</p> 
<p><strong>组包</strong><br> 多个数据帧可以捆在一起，添加包头信息，就可以组包。组包可以使得多帧的数据同时发送，提高通信的效率。</p> 
<p>数据的帧包可以提高数据传输的可靠性。</p> 
<p>下面来介绍一种数据帧和包的封装：</p> 
<p><strong>组帧格式：</strong></p> 
<p><img src="https://images2.imgbox.com/e9/77/9rtcGE75_o.png" alt="在这里插入图片描述"><br> 为了保证数据的可靠性，我们在帧结构中的长度，指令类型，数据，校验和数据包含5A556A69时需要转义，接收时也需要转义，以防止帧解析出现异常。</p> 
<p>一帧数据只有一个指令。指令用于控制设备的状态等</p> 
<p><strong>组包格式：</strong><br> <img src="https://images2.imgbox.com/2e/7e/yszBJ8Nb_o.png" alt="在这里插入图片描述"><br> 这里我们将包头内容包含 版本信息和帧数据的长度信息。</p> 
<p>按照该协议，我们可以串口传输，SOCKET TCP传输中来实现数据的发送和接收。</p> 
<h3><a id="__1407"></a>二、 程序实现：</h3> 
<p>这里我们讨论上位机SOCKET端的组帧和组包，以及解析帧和解包。我们下Qt中编写测试代码。</p> 
<h4><a id="21frame_1410"></a>2.1、frame(帧)类的实现：</h4> 
<ol><li>新建一个frame类，命名为frame。 在frame.h中我们如下设计</li></ol> 
<p><strong>第一步：</strong><br> 设置数据区格式：</p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> INT8U unsigned char</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INT32U unsigned int</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INT16U unsigned short  </span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_MSG_LEN 128     </span>
      
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> _Msg_
<span class="token punctuation">{<!-- --></span>
    INT8U   length<span class="token punctuation">;</span>
    INT8U		crc<span class="token punctuation">;</span>
    INT8U		data<span class="token punctuation">[</span>MAX_MSG_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>Msg<span class="token punctuation">,</span><span class="token operator">*</span>pMsg<span class="token punctuation">;</span>
</code></pre> 
<p><strong>第二步：</strong><br> 设计组帧和解析帧</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token function">PackFrame</span><span class="token punctuation">(</span>Msg src<span class="token punctuation">,</span> INT8U <span class="token operator">*</span> dst<span class="token punctuation">,</span> INT8U <span class="token operator">*</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//组包</span>
INT8U <span class="token function">UnpackFrame</span><span class="token punctuation">(</span>INT8U ch<span class="token punctuation">,</span> Msg <span class="token operator">*</span>pmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//解包</span>
</code></pre> 
<p><strong>第三步：</strong><br> 因为我们还要实现对帧中的帧长度，数据区，校验中实现转义，于是我们定义两个函数：</p> 
<pre><code class="prism language-cpp">INT8U <span class="token function">protocol_convert</span><span class="token punctuation">(</span>INT8U ch<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//转义</span>
INT8U <span class="token function">protocol_deconvert</span><span class="token punctuation">(</span>INT8U ch<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//反转义</span>
</code></pre> 
<p>最后，我们添加校验函数</p> 
<pre><code class="prism language-cpp">INT8U <span class="token function">CRC8</span><span class="token punctuation">(</span> INT8U<span class="token operator">*</span>buffer<span class="token punctuation">,</span> INT8U len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>因为在数据转义中，需要对帧的格式进行判断，我们这里设计一个枚举结构</p> 
<pre><code class="prism language-cpp"><span class="token keyword">enum</span> FRAME_STATE
<span class="token punctuation">{<!-- --></span>undefined
F_ERROR <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
F_HEADER_H<span class="token punctuation">,</span>
F_HEADER_L<span class="token punctuation">,</span>
F_LENGTH<span class="token punctuation">,</span>
F_DATA<span class="token punctuation">,</span>
F_CRC<span class="token punctuation">,</span>
F_END_H<span class="token punctuation">,</span>
F_END_L<span class="token punctuation">,</span>
F_OVER<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>frame.h 预览如下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">ifndef</span> FRAME_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FRAME_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"encrypt/type.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"encrypt/encrypt.h"</span></span>

<span class="token macro property"># <span class="token directive keyword">define</span> MAX_MSG_LEN 128</span>

<span class="token macro property">#<span class="token directive keyword">pragma</span> pack(1)</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> _Msg_
<span class="token punctuation">{<!-- --></span>
    INT8U   length<span class="token punctuation">;</span>
    INT8U		crc<span class="token punctuation">;</span>
    INT8U		data<span class="token punctuation">[</span>MAX_MSG_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>Msg<span class="token punctuation">,</span><span class="token operator">*</span>pMsg<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> pack()</span>


<span class="token keyword">class</span> <span class="token class-name">Frame</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> <span class="token function">PackFrame</span><span class="token punctuation">(</span>Msg src<span class="token punctuation">,</span> INT8U <span class="token operator">*</span> dst<span class="token punctuation">,</span> INT8U <span class="token operator">*</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//组包</span>
    INT8U <span class="token function">UnpackFrame</span><span class="token punctuation">(</span>INT8U ch<span class="token punctuation">,</span> Msg <span class="token operator">*</span>pmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//解包</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">enum</span> FRAME_STATE
    <span class="token punctuation">{<!-- --></span>
        F_ERROR <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        F_HEADER_H<span class="token punctuation">,</span>
        F_HEADER_L<span class="token punctuation">,</span>
        F_LENGTH<span class="token punctuation">,</span>
        F_DATA<span class="token punctuation">,</span>
        F_CRC<span class="token punctuation">,</span>
        F_END_H<span class="token punctuation">,</span>
        F_END_L<span class="token punctuation">,</span>
        F_OVER<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    Encrypt <span class="token operator">*</span>_encrypt<span class="token punctuation">;</span>    <span class="token comment">//加密对象</span>

    <span class="token keyword">int</span> converter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> data_point <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    FRAME_STATE frame_state<span class="token punctuation">;</span>

    INT8U <span class="token function">protocol_convert</span><span class="token punctuation">(</span>INT8U ch<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//转义</span>
    INT8U <span class="token function">protocol_deconvert</span><span class="token punctuation">(</span>INT8U ch<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//反转义</span>
    INT8U <span class="token function">CRC8</span><span class="token punctuation">(</span> INT8U<span class="token operator">*</span>buffer<span class="token punctuation">,</span> INT8U len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">// FRAME_H</span>
</code></pre> 
<p>2、frame.cpp 设计如下：<br> 校验：<br> 这里我们通过加密类中的CRC来返回一个CRC校验值，当然我们也一个自定义一个CRC计算的算法来实现</p> 
<pre><code class="prism language-cpp">INT8U Frame<span class="token operator">::</span><span class="token function">CRC8</span><span class="token punctuation">(</span> INT8U<span class="token operator">*</span>buffer<span class="token punctuation">,</span> INT8U len<span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">return</span> _encrypt<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">CRC8</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>转义：</p> 
<pre><code class="prism language-cpp"> INT8U Frame<span class="token operator">::</span><span class="token function">protocol_convert</span><span class="token punctuation">(</span>INT8U ch<span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>converter <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token number">0xA5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         converter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         ch <span class="token operator">=</span> <span class="token number">0x5A</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>converter <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token number">0x66</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         converter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         ch <span class="token operator">=</span> <span class="token number">0x99</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>converter <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token number">0x95</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         converter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         ch <span class="token operator">=</span> <span class="token number">0x6A</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>converter <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         frame_state <span class="token operator">=</span> F_ERROR<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> ch<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>反转义：</p> 
<pre><code class="prism language-cpp">INT8U Frame<span class="token operator">::</span><span class="token function">protocol_deconvert</span><span class="token punctuation">(</span>INT8U ch<span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     INT8U rtn <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">switch</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">case</span> <span class="token number">0x5A</span><span class="token operator">:</span>
                 rtn <span class="token operator">=</span> <span class="token number">0xA5</span><span class="token punctuation">;</span>
                 <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">0x99</span><span class="token operator">:</span>
                 rtn <span class="token operator">=</span> <span class="token number">0x66</span><span class="token punctuation">;</span>
                 <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">0x6A</span><span class="token operator">:</span>
                 rtn <span class="token operator">=</span> <span class="token number">0x95</span><span class="token punctuation">;</span>
                 <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token keyword">default</span><span class="token operator">:</span>
                 rtn <span class="token operator">=</span> ch<span class="token punctuation">;</span>
                 <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> rtn<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>组帧和解析帧：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> Frame<span class="token operator">::</span><span class="token function">PackFrame</span><span class="token punctuation">(</span>Msg src<span class="token punctuation">,</span> INT8U <span class="token operator">*</span> dst<span class="token punctuation">,</span> INT8U <span class="token operator">*</span>len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

     <span class="token comment">// 增加CRC校验</span>
     src<span class="token punctuation">.</span>crc <span class="token operator">=</span> <span class="token function">CRC8</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>data<span class="token punctuation">,</span> src<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

     dst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x5A</span><span class="token punctuation">;</span>
     dst<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x55</span><span class="token punctuation">;</span>
     <span class="token keyword">int8_t</span> j <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
     <span class="token comment">// lenth</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token function">protocol_deconvert</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         dst<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">else</span>
     <span class="token punctuation">{<!-- --></span>
         dst<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x99</span><span class="token punctuation">;</span>
         dst<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">protocol_deconvert</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token comment">//data</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> src<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token function">protocol_deconvert</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">{<!-- --></span>
             dst<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span>
         <span class="token punctuation">{<!-- --></span>
             dst<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x99</span><span class="token punctuation">;</span>
             dst<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">protocol_deconvert</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
     <span class="token comment">//crc</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span>crc <span class="token operator">==</span> <span class="token function">protocol_deconvert</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>crc<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         dst<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">.</span>crc<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">else</span>
     <span class="token punctuation">{<!-- --></span>
         dst<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x99</span><span class="token punctuation">;</span>
         dst<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">protocol_deconvert</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>crc<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     dst<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6A</span><span class="token punctuation">;</span> <span class="token comment">//packet tail1</span>
     dst<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x69</span><span class="token punctuation">;</span> <span class="token comment">//packet tail2</span>
     <span class="token punctuation">(</span><span class="token operator">*</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>

     <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>


INT8U Frame<span class="token operator">::</span><span class="token function">UnpackFrame</span><span class="token punctuation">(</span>INT8U ch<span class="token punctuation">,</span> Msg <span class="token operator">*</span>pmsg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token number">0x5a</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>frame_state <span class="token operator">!=</span> F_HEADER_H<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>frame_state <span class="token operator">!=</span> F_CRC<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      frame_state <span class="token operator">=</span> F_HEADER_H<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token number">0x6a</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>frame_state <span class="token operator">!=</span> F_END_H<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>frame_state <span class="token operator">!=</span> F_CRC<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      frame_state <span class="token operator">=</span> F_ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_state <span class="token operator">==</span> F_HEADER_H<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token number">0x5A</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
          data_point <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          frame_state <span class="token operator">=</span> F_HEADER_L<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{<!-- --></span>
          frame_state <span class="token operator">=</span> F_ERROR<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_state <span class="token operator">==</span> F_HEADER_L<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token number">0x55</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
          frame_state <span class="token operator">=</span> F_LENGTH<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{<!-- --></span>
          frame_state <span class="token operator">=</span> F_ERROR<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_state <span class="token operator">==</span> F_LENGTH<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token number">0x99</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
          converter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      pmsg<span class="token operator">-</span><span class="token operator">&gt;</span>length <span class="token operator">=</span> <span class="token function">protocol_convert</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>pmsg<span class="token operator">-</span><span class="token operator">&gt;</span>length <span class="token operator">&gt;</span> MAX_MSG_LEN<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
          frame_state <span class="token operator">=</span> F_ERROR<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{<!-- --></span>
          frame_state <span class="token operator">=</span> F_DATA<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_state <span class="token operator">==</span> F_DATA<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>pmsg<span class="token operator">-</span><span class="token operator">&gt;</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//没有数据区</span>
      <span class="token punctuation">{<!-- --></span>
          frame_state <span class="token operator">=</span> F_CRC<span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token number">0x99</span><span class="token punctuation">)</span>    <span class="token comment">//转义</span>
      <span class="token punctuation">{<!-- --></span>
          converter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      pmsg<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span>data_point<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">protocol_convert</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      data_point<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data_point <span class="token operator">==</span> pmsg<span class="token operator">-</span><span class="token operator">&gt;</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
          data_point <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          frame_state <span class="token operator">=</span> F_CRC<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_state <span class="token operator">==</span> F_CRC<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token number">0x99</span><span class="token punctuation">)</span>    <span class="token comment">//转义</span>
      <span class="token punctuation">{<!-- --></span>
          converter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      pmsg<span class="token operator">-</span><span class="token operator">&gt;</span>crc <span class="token operator">=</span> <span class="token function">protocol_convert</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      frame_state <span class="token operator">=</span> F_END_H<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_state <span class="token operator">==</span> F_END_H<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token number">0x6A</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
          frame_state <span class="token operator">=</span> F_ERROR<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{<!-- --></span>
          frame_state <span class="token operator">=</span> F_END_L<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_state <span class="token operator">==</span> F_END_L<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token number">0x69</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
          frame_state <span class="token operator">=</span> F_ERROR<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// frame_state = FRAME_STATE.F_HEADER_H;</span>
          <span class="token comment">//CRC success</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pmsg<span class="token operator">-</span><span class="token operator">&gt;</span>crc <span class="token operator">==</span> <span class="token function">CRC8</span><span class="token punctuation">(</span>pmsg<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">,</span> pmsg<span class="token operator">-</span><span class="token operator">&gt;</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
              frame_state <span class="token operator">=</span> F_HEADER_H<span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">else</span>
          <span class="token punctuation">{<!-- --></span>
              frame_state <span class="token operator">=</span> F_ERROR<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>frame_state <span class="token operator">==</span> F_ERROR<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      frame_state <span class="token operator">=</span> F_HEADER_H<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在解析帧的过程中，我们用frame_state 作为协议状态机的转换状态，用于确定当前字节处于一帧数据中的那个部位，在数据包接收完的同时也进行了校验的比较。<br> 接收过程中，只要哪一步收到的数据不是预期值，则直接将状态机复位，用于下一帧数据的判断，因此系统出现状态死锁的情况非常少，系统比较稳定。</p> 
<p>2.2、Pack(包)类的实现：<br> packer.h</p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">ifndef</span> PACKER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PACKER_H</span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;QList&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"protocal/frame.h"</span></span>

<span class="token keyword">const</span> <span class="token keyword">int</span> packVersion  <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Packer</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Packer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Frame <span class="token operator">*</span>ptc<span class="token punctuation">;</span>  <span class="token comment">//帧对象指针</span>
    QList<span class="token operator">&lt;</span>Msg<span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span>lstMsg<span class="token punctuation">;</span><span class="token comment">// 解包后的通讯数据</span>

    QByteArray  <span class="token function">Pack</span><span class="token punctuation">(</span>QList<span class="token operator">&lt;</span>Msg<span class="token operator">&gt;</span> lstMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//组包</span>
    QList<span class="token operator">&lt;</span>Msg<span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token function">UnPack</span><span class="token punctuation">(</span>INT8U <span class="token operator">*</span> data<span class="token punctuation">,</span> INT16U packLen<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//解包</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">// PACKER_H</span>
</code></pre> 
<p>packer.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"packer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;QDebug&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;QString&gt;</span></span>

Packer<span class="token operator">::</span><span class="token function">Packer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

   ptc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   lstMsg <span class="token operator">=</span> <span class="token keyword">new</span> QList<span class="token operator">&lt;</span>Msg<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


QByteArray Packer<span class="token operator">::</span> <span class="token function">Pack</span><span class="token punctuation">(</span>QList<span class="token operator">&lt;</span>Msg<span class="token operator">&gt;</span> lstMsg<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>

    QByteArray pack<span class="token punctuation">;</span>
    pack<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pack<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packVersion <span class="token operator">&amp;</span> <span class="token number">0xff00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packVersion <span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    pack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

    Msg msg<span class="token punctuation">;</span>

    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">foreach</span><span class="token punctuation">(</span> msg <span class="token punctuation">,</span> lstMsg<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      INT8U dst<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      INT8U len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      ptc<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">PackFrame</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span>  dst<span class="token punctuation">,</span>  <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
      INT8U pre_len <span class="token operator">=</span> pack<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      INT8U cur_len <span class="token operator">=</span> pack<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> len<span class="token punctuation">;</span>
      pack<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span> cur_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> pre_len<span class="token punctuation">;</span> j<span class="token operator">&lt;</span>cur_len<span class="token punctuation">;</span>j<span class="token operator">++</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
         pack<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> dst<span class="token punctuation">[</span>j<span class="token operator">-</span>pre_len<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span>

<span class="token comment">//      char * p_buf= new char[128]();</span>
<span class="token comment">//      std::memcpy(p_buf,dst,len);</span>
<span class="token comment">//      pack.append(p_buf);</span>
      pos <span class="token operator">+</span><span class="token operator">=</span> len<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pos <span class="token operator">=</span> pos <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span>
    pack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pos <span class="token operator">&amp;</span> <span class="token number">0xff00</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pack<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pos <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pack<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

 QList<span class="token operator">&lt;</span>Msg<span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span>Packer<span class="token operator">::</span><span class="token function">UnPack</span><span class="token punctuation">(</span>INT8U <span class="token operator">*</span> data<span class="token punctuation">,</span> INT16U packLen<span class="token punctuation">)</span>   <span class="token comment">//packLen: 数据区的长度</span>
  <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
              <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"数据为空！"</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">int</span> version <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token operator">|</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">// 版本异常</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">!=</span> packVersion<span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
              <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"协议版本不正确!"</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">int</span> len <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token operator">|</span> data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">//数据长度异常</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">&gt;</span> packLen<span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
              <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>  <span class="token string">"数据截断异常!"</span> <span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">&lt;</span> packLen<span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
              <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>  <span class="token string">"数据过长异常!"</span> <span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          Msg <span class="token operator">*</span>pmsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          packLen <span class="token operator">=</span> <span class="token punctuation">(</span>INT16U<span class="token punctuation">)</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> packLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
              INT8U ch <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
              INT8U result <span class="token operator">=</span> ptc<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">UnpackFrame</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> pmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
              <span class="token punctuation">{<!-- --></span>
                  lstMsg<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">append</span><span class="token punctuation">(</span>pmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  pmsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">return</span> lstMsg<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre> 
<p>三、测试<br> 我们在main() 函数中添加如下代码 进行测试：</p> 
<pre><code class="prism language-cpp">    <span class="token comment">//解析帧测试</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> destdata<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x1b</span><span class="token punctuation">,</span><span class="token number">0x5A</span><span class="token punctuation">,</span><span class="token number">0x55</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0x81</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span>
                         <span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xD8</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x4E</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">,</span><span class="token number">0x36</span><span class="token punctuation">,</span><span class="token number">0x25</span><span class="token punctuation">,</span><span class="token number">0x39</span><span class="token punctuation">,</span>
                         <span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0xF7</span><span class="token punctuation">,</span><span class="token number">0xFD</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0x23</span><span class="token punctuation">,</span><span class="token number">0x51</span><span class="token punctuation">,</span><span class="token number">0x09</span><span class="token punctuation">,</span>
                         <span class="token number">0xEF</span><span class="token punctuation">,</span><span class="token number">0x0A</span><span class="token punctuation">,</span><span class="token number">0x6A</span><span class="token punctuation">,</span><span class="token number">0x69</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

     QList<span class="token operator">&lt;</span>Msg<span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span>testlist<span class="token punctuation">;</span>

     Packer <span class="token operator">*</span>testpacker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Packer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     testlist <span class="token operator">=</span> testpacker<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">UnPack</span><span class="token punctuation">(</span>destdata<span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


     QList<span class="token operator">&lt;</span>Msg<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">::</span>iterator i<span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> testlist<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> testlist<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>

     <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>length<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>
         <span class="token punctuation">{<!-- --></span>
             <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>QString<span class="token operator">::</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>

   <span class="token comment">//组包测试</span>


     Msg testmsg<span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">21</span><span class="token punctuation">;</span>


     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x81</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x31</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xD8</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x05</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x4E</span><span class="token punctuation">;</span>

     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x56</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x33</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x36</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x25</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x39</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x22</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x43</span><span class="token punctuation">;</span>

     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x72</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xF7</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xFD</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x30</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x23</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x51</span><span class="token punctuation">;</span>

     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x09</span><span class="token punctuation">;</span>
     testmsg<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xEF</span><span class="token punctuation">;</span>

      QList<span class="token operator">&lt;</span>Msg<span class="token operator">&gt;</span> lstMsg <span class="token punctuation">;</span>
      lstMsg<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>testmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

     QByteArray ba<span class="token punctuation">;</span>

     ba <span class="token operator">=</span> testpacker<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Pack</span><span class="token punctuation">(</span>lstMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>ba<span class="token punctuation">.</span><span class="token function">toHex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-bash">输出：
jjjj
“81”
“31”
“ff”
“d8”
“5”
“4e”
“56”
“33”
“36”
“25”
“39”
“22”
“43”
“72”
“f7”
“fd”
“30”
“23”
“51”
“9”
“ef”
“0001001b5a55158131ffd8054e5633362539224372f7fd30235109ef0a6a69”
</code></pre> 
<h2><a id="_1988"></a>六、如何用串口解析出协议帧，并解决分包，组包，粘包问题？</h2> 
<p>原文链接：<a href="https://blog.csdn.net/qq_32166779/article/details/99943574">https://blog.csdn.net/qq_32166779/article/details/99943574</a></p> 
<p>生产者（4个）：</p> 
<p>硬件：串口一； 串口二； 串口三； 串口四；采用普通接受中断</p> 
<p>软件： 中断时以字节传入到 ringbuffer，建立ringbuffer数组[4]，分别在四个中断里存入</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token function">ring_buffer_write_byte_forced</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RingBuffer<span class="token punctuation">[</span>UART_1<span class="token punctuation">]</span><span class="token punctuation">,</span> DeviceList<span class="token punctuation">[</span>UART_1<span class="token punctuation">]</span><span class="token punctuation">.</span>handle<span class="token operator">-&gt;</span>DR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>消费者（4个）：</p> 
<p>软件：</p> 
<p>第一步：</p> 
<p>保证事件独立开</p> 
<p>如果是前后台程序</p> 
<pre><code class="prism language-c"><span class="token keyword">while</span>（<span class="token number">1</span>）
			<span class="token punctuation">{<!-- --></span>

				串口一事件；

				串口二事件；

				串口三事件；

				串口四事件；

			<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-c"><span class="token comment">//rtos程序</span>

<span class="token keyword">while</span>（<span class="token number">1</span>）

<span class="token punctuation">{<!-- --></span>undefined

<span class="token comment">//串口一事件；</span>

<span class="token punctuation">}</span>

<span class="token keyword">while</span>（<span class="token number">2</span>）

<span class="token punctuation">{<!-- --></span>undefined

<span class="token comment">//串口二事件；</span>

<span class="token punctuation">}</span>

…
</code></pre> 
<p>第二步：建立 解析库 cmd_parser（&amp;CmdParser, buffer, bufferLen）函数</p> 
<p>解析库作用：</p> 
<p>消费任何ringbuffer的内容，放到解析库中，如果消费内容不够，则继续消费，如果消费内容过多，用长度来控制需要消费的完整帧，进行下一步解析。</p> 
<p>虽然每个协议获取整帧的长度方法不一样，但是几乎都是head + datalen+taildata 的方法</p> 
<p>1，AT指令head是“+IPD”， datalen在其后</p> 
<p>2，modbus（RTU）的head是address，datalen在其后，taildata是crc校验数据</p> 
<p>3，如果没有head和datalen，则直接获取固定长度</p> 
<p>第三步：建立数据结构</p> 
<p>建立协议需要的数据结构</p> 
<p>struct</p> 
<p>{undefined</p> 
<p>1，processFunc解析函数指针，因为每个串口解析函数不一样，所以在每个串口事件中，增加相关回调函数</p> 
<p>2，第二步 中的会用到的一些变量，比如head，datalen，u8 *buffer;等</p> 
<p>}cmdParser</p> 
<p>第四步：</p> 
<p>建立自己的解析函数，process_parser（）,这里的形参和cmdParser里的processFunc的形参是一样的，</p> 
<p>这个函数就是在获取完整帧之后，接下来处理的函数。</p> 
<p>第五步：</p> 
<p>当获取完整帧之后，把整帧buff提取出来，调用cmdParser.processFunc（buff，bufflen）相当于调用process_parser（），这里为什么要这样做？ 因为调用这个函数时还在解析库cmd_parser（&amp;CmdParser, buffer, bufferLen）函数内，为了做到多串口通用性，用这个cmdParser.processFunc（buff，bufflen）代替所有自己生成的process_parser（）函数。</p> 
<p>如何使用？</p> 
<p>拿串口一事件举例子</p> 
<p>串口一事件函数</p> 
<pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span>
    ui8 buffer<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    si32 bufferLen<span class="token punctuation">;</span>
    cmdParser<span class="token punctuation">.</span>processFunc <span class="token operator">=</span> process_parser（）；

    bufferLen<span class="token operator">=</span> <span class="token function">ring_buffer_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RingBuffer<span class="token punctuation">[</span>UART_1<span class="token punctuation">]</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>bufferLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">cmd_parser</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CmdParser<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> bufferLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><mark><strong>难点： cmd_parser（&amp;CmdParser, buffer, bufferLen） 如何实现？</strong></mark></p> 
<p>根据公司的多种协议帧 实现，用状态机 保证 各个情况，比如校验函数，解密函数，计算数据长度函数等等，如果做到了高鲁棒性，那么 这个库可以封装好不动了。</p> 
<h2><a id="_2116"></a>七、串口协议包的接收及解析处理</h2> 
<p><a href="https://blog.csdn.net/xiaoyuanwuhui/article/details/104775612">https://blog.csdn.net/xiaoyuanwuhui/article/details/104775612</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/576a4fb6a2d607c9e7c3156e590cc6d2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于FPGA的多功能引脚(multi-function pin)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f4e3325e16ba82a234c33dea4f2d4050/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">子进程、僵尸进程、孤儿进程(个人总结)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>