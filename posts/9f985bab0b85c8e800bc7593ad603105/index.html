<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nRF51822：在 macOS 下使用 SEGGER Embedded Studio（SES）搭建开发环境 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nRF51822：在 macOS 下使用 SEGGER Embedded Studio（SES）搭建开发环境" />
<meta property="og:description" content="系统环境
系统：macOS 10.13.6（Windows 和 Linux 同样适用）网络：联网 软件环境（只能保证这个版本环境好用）
编译器环境：SEGGER Embedded Studio v3.40（SES）仿真器驱动：J-Link Software and Documentation Pack v6.32i软件开发包：nRF5 SDK v12.3.0（最后一个支持 nRF51 系列芯片的版本） 硬件环境
开发板：nRF51 DK v1.2.0开发板：青风 nRF51822 开发板仿真器：J-Link v9.2（淘宝版）（实测第三方 J-Link for ARM OB v7 不能长时间仿真） 导入 Keil µVersion 工程
尽管 SES（SEGGER Embedded Studio）已经成为 Nordic 官方推荐的免费跨平台开发环境，但是首个获得官方支持带有 SES 工程的 SDK 版本是 v14.1.0，并不包括 nRF51 系列代码。因此对于 nRF51 系列来说，需要通过简单的操作将 Keil 工程转换为 SES 工程。打开 SES，在菜单栏选择“Tool -&gt; Package Manager”，然后安装“CMSIS-CORE Support Package”和“nRF CPU Support Package”。 在菜单栏，选择“File -&gt; Import Project -&gt; Import Keil MDK Project…”；导航到 nRF5 SDK 的位置，在路径“examples/ble_peripheral/ble_app_hrs/”中选择一个工程，例如：“pca10028/s130/arm5_no_packs/ble_app_hrs_pca10028_s130." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/9f985bab0b85c8e800bc7593ad603105/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-06-17T22:56:51+08:00" />
<meta property="article:modified_time" content="2018-06-17T22:56:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nRF51822：在 macOS 下使用 SEGGER Embedded Studio（SES）搭建开发环境</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>系统环境</strong></p> 
<ul><li>系统：macOS 10.13.6（Windows 和 Linux 同样适用）</li><li>网络：联网</li></ul> 
<p><strong>软件环境<span style="color:#f33b45;">（只能保证这个版本环境好用）</span></strong></p> 
<ul><li>编译器环境：SEGGER Embedded Studio v3.40（SES）</li><li>仿真器驱动：J-Link Software and Documentation Pack v6.32i</li><li>软件开发包：nRF5 SDK v12.3.0（最后一个支持 nRF51 系列芯片的版本）</li></ul> 
<p><strong>硬件环境</strong></p> 
<ul><li>开发板：nRF51 DK v1.2.0</li><li>开发板：青风 nRF51822 开发板</li><li>仿真器：J-Link v9.2（淘宝版）（实测第三方 J-Link for ARM OB v7 不能长时间仿真）</li></ul> 
<p><strong>导入 Keil µVersion 工程</strong></p> 
<ul><li>尽管 SES（SEGGER Embedded Studio）已经成为 Nordic 官方推荐的免费跨平台开发环境，但是首个获得官方支持带有 SES 工程的 SDK 版本是 v14.1.0，并不包括 nRF51 系列代码。因此对于 nRF51 系列来说，需要通过简单的操作将 Keil 工程转换为 SES 工程。</li><li>打开 SES，在菜单栏选择“Tool -&gt; Package Manager”，然后安装“CMSIS-CORE Support Package”和“nRF CPU Support Package”。</li></ul> 
<p style="text-align:center;"><img alt="" class="has" height="398" src="https://images2.imgbox.com/3d/57/GGUQHJm7_o.png" width="450"></p> 
<ul><li>在菜单栏，选择“File -&gt; Import Project -&gt; Import Keil MDK Project…”；</li><li>导航到 nRF5 SDK 的位置，在路径“examples/ble_peripheral/ble_app_hrs/”中选择一个工程，例如：“pca10028/s130/arm5_no_packs/ble_app_hrs_pca10028_s130.uvprojx”。</li><li>选中后，“Import Build Configuration”窗口会弹出，基于完全使用 SES 的目的，此处选择“Internal Toolchain (GCC/Clang)”，点击“OK”按钮，工程将被导入。</li></ul> 
<p style="text-align:center;"><img alt="" class="has" height="242" src="https://images2.imgbox.com/21/c5/cEsA0bOC_o.png" width="300"></p> 
<p><strong>调整工程配置</strong></p> 
<ul><li>右键点击左侧导航窗口中的工程名，选择弹出菜单中的“Build Configurations…”；</li><li>在“Public Configurations”栏录下选中“flash_s130_nrf51_2.0.1_softdevice”；</li></ul> 
<p style="text-align:center;"><img alt="" class="has" height="290" src="https://images2.imgbox.com/6b/0f/v2ZpZsL4_o.png" width="300"></p> 
<ul><li>点击右上方的“-”号删除这个配置并确定，此时导航栏上方将只剩“nrf51422_xxac”这一个配置。</li></ul> 
<p style="text-align:center;"><img alt="" class="has" height="290" src="https://images2.imgbox.com/7b/49/KMnUlLVR_o.png" width="300"></p> 
<p><strong>添加 nRF5 MDK 文件</strong></p> 
<ul><li>Keil µVersion 使用“Device Packs”用于系统启动文件，包含如系统启动汇编文件“arm_startup_nrf51.s”和系统设置文件“system_nrf51.c”，在 SES 中需要手动添加这些文件。下载文件“<a href="https://devzone.nordicsemi.com/cfs-file/__key/communityserver-blogs-components-weblogfiles/00-00-00-00-04-DZ-1032/3324.ses_5F00_nrf51_5F00_startup.s" rel="nofollow">ses_nrf51_startup.s</a>”（CSDN 国内路径<a href="https://download.csdn.net/download/bht890811/10485092">资源</a>）；</li><li>在 SDK 目录中，找到路径“components/toolchain/”，在这里新建文件夹“ses”，然后将下载好的“ses_nrf51_startup.s”文件放置在“ses”文件夹中；</li><li>回到 SES 界面，在导航窗口中找到“Internal Files”目录，删除该目录下的“Cortex_M_Startup.s”文件（右键点击该文件并选择“Remove”）；</li><li>选中“Internal Files”目录，点击右键弹出菜单，选择“Add Existing File…”，通过这种方式分别添加 SDK 路径下的“components/toolchain/system_nrf51.c”和“components/toolchain/ses/ses_nrf51_startup.s”两个文件。</li></ul> 
<p style="text-align:center;"><img alt="" class="has" height="471" src="https://images2.imgbox.com/e0/dd/LZ0luk9f_o.png" width="850"></p> 
<ul><li>在导航窗口选中工程名，点击右键弹出菜单选择“Edit Options…”，然后选择“Preprocessor”选项卡；</li><li>找到“User Include Directories”项目，将路径“../../../../../../components/device”添加进去；</li></ul> 
<p style="text-align:center;"><img alt="" class="has" height="420" src="https://images2.imgbox.com/25/91/MfuHJKT7_o.png" width="400"></p> 
<p><strong>配对管理器暨 FLASH 存储器调整</strong></p> 
<ul><li>在 SDK 目录中找到工程目录“examples/ble_peripheral/ble_app_hrs/pca10028/s130/arm5_no_packs”，在该目录下用文本编辑器创建文件“flash_placement.xml”；</li><li>回到 SES 界面，在导航窗口中点击右键弹出菜单，选择“Import Section placement”选项，此时弹出警告窗口，选择“Yes”，再“Yes”，在文件中输入如下内容并保存：</li></ul> 
<pre class="has"><code class="language-html">&lt;!DOCTYPE Linker_Placement_File&gt;
&lt;Root name="Flash Section Placement"&gt;
  &lt;MemorySegment name="$(FLASH_NAME:FLASH)"&gt;
    &lt;ProgramSection alignment="0x100" load="Yes" name=".vectors" start="$(FLASH_START:)" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" name=".init" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" name=".init_rodata" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" name=".text" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" name=".dtors" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" name=".ctors" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" name=".rodata" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" name=".ARM.exidx" address_symbol="__exidx_start" end_symbol="__exidx_end" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" runin=".fast_run" name=".fast" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" runin=".data_run" name=".data" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" runin=".tdata_run" name=".tdata" /&gt;
    &lt;ProgramSection alignment="4" keep="Yes" load="Yes" runin=".fs_data_run" name=".fs_data" /&gt;
  &lt;/MemorySegment&gt;
  &lt;MemorySegment name="$(RAM_NAME:RAM);SRAM"&gt;
    &lt;ProgramSection alignment="0x100" load="No" name=".vectors_ram" start="$(RAM_START:$(SRAM_START:))" /&gt;
    &lt;ProgramSection alignment="4" load="No" name=".fast_run" /&gt;
    &lt;ProgramSection alignment="4" load="No" name=".data_run" /&gt;
    &lt;ProgramSection alignment="4" load="No" name=".tdata_run" /&gt;
    &lt;ProgramSection alignment="4" load="No" keep="Yes" name=".fs_data_run" address_symbol="__start_fs_data" end_symbol="__stop_fs_data" /&gt;
    &lt;ProgramSection alignment="4" load="No" name=".bss" /&gt;
    &lt;ProgramSection alignment="4" load="No" name=".tbss" /&gt;
    &lt;ProgramSection alignment="4" load="No" name=".non_init" /&gt;
    &lt;ProgramSection alignment="4" size="__HEAPSIZE__" load="No" name=".heap" /&gt;
    &lt;ProgramSection alignment="8" size="__STACKSIZE__" load="No" place_from_segment_end="Yes" name=".stack" /&gt;
    &lt;ProgramSection alignment="8" size="__STACKSIZE_PROCESS__" load="No" name=".stack_process" /&gt;
  &lt;/MemorySegment&gt;
  &lt;MemorySegment name="$(FLASH2_NAME:FLASH2)"&gt;
    &lt;ProgramSection alignment="4" load="Yes" name=".text2" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" name=".rodata2" /&gt;
    &lt;ProgramSection alignment="4" load="Yes" runin=".data2_run" name=".data2" /&gt;
  &lt;/MemorySegment&gt;
  &lt;MemorySegment name="$(RAM2_NAME:RAM2)"&gt;
    &lt;ProgramSection alignment="4" load="No" name=".data2_run" /&gt;
    &lt;ProgramSection alignment="4" load="No" name=".bss2" /&gt;
  &lt;/MemorySegment&gt;
&lt;/Root&gt;
</code></pre> 
<ul><li>在导航窗口中，找到“Internal Files”目录下的“thumb_crt0.s”，在“tdata”字段后加入“fs_data”字段：</li></ul> 
<pre class="has"><code class="language-plain language-python">ldr r2, =__tdata_end__
bl memory_copy
# ADD HERE ... 
ldr r0, =__fs_data_load_start__
ldr r1, =__fs_data_start__
ldr r2, =__fs_data_end__
bl memory_copy
# TO HERE ...</code></pre> 
<p><strong>构造（Building）</strong></p> 
<ul><li>现在可以构造成功了，右键点击工程名，在弹出菜单中选择“Build”，构造成功如下：</li></ul> 
<p style="text-align:center;"><img alt="" class="has" src="https://images2.imgbox.com/df/e7/Wls5XPGr_o.png" width="850"></p> 
<ul><li>此时 FLASH 和 SRAM 的起始还都是0地址，而 SoftDevice 的空间需要被留出来，所以需要配置空间。还是在导航窗口的工程名中右键选择“Edit Options…”，找到“Linker”选项卡；</li><li>找到“Section Placement Macros”选项，添加宏定义（SRAM起始地址可调）：</li></ul> 
<pre class="has"><code class="language-plain language-python">FLASH_START=0x1B000
SRAM_START=0x20002A10</code></pre> 
<ul><li>右键点击工程名，在弹出菜单中选择“Rebuild”，重构成功如下：</li></ul> 
<p style="text-align:center;"><img alt="" class="has" height="471" src="https://images2.imgbox.com/53/87/rT1psDLl_o.png" width="850"></p> 
<p><strong>微调</strong></p> 
<ul><li>在导航窗口选中工程名，点击右键弹出菜单选择“Edit Options…”，然后选择“Preprocessor”选项卡；</li><li>找到“Preprocessor Definitions”选项，添加宏定义“NO_VTOR_CONFIG”（这是为了告知 SES 为 SoftDevice 预留向量表的位置）；</li></ul> 
<p style="text-align:center;"><img alt="" class="has" height="420" src="https://images2.imgbox.com/d8/02/4tMBF3sh_o.png" width="400"></p> 
<p><strong>连同应用烧录 SoftDevice</strong></p> 
<ul><li>在导航窗口选中工程名，点击右键弹出菜单选择“Edit Options…”，然后选择“Loader”选项卡；</li><li>找到“Additional Load File[0]”选项，添加 SoftDevice 的相对路径“../../../../../../components/softdevice/s130/hex/s130_nrf51_2.0.1_softdevice.hex”；</li><li>再次运行重构。</li></ul> 
<p><strong>运行</strong></p> 
<ul><li>使用 nRF51-DK 的话不需要更改设置，如果使用其他板子，如我正用的青风电子的板子上的芯片是 nRF51822QFAA，因此要在设置中更改芯片配置，否则无法运行；</li><li>在导航窗口选中工程名，点击右键弹出菜单选择“Edit Options…”，然后选择“Debugger”选项卡；</li><li>找到“Target Device”选项，选择自己正在使用的芯片，此处选择“nRF51822_xxAA”；</li></ul> 
<p style="text-align:center;"><img alt="" class="has" src="https://images2.imgbox.com/7d/b0/WRqIvQSI_o.png" width="500"></p> 
<ul><li>将 nRF51 DK 或自己的板子通过 J-Link 连接到 Mac，确保板子电源供电正常；</li><li>在菜单栏，选择“Build -&gt; Build and Run”，可以看到板子灯亮了，确认已经在运行。</li></ul> 
<p style="text-align:center;"><img alt="" class="has" src="https://images2.imgbox.com/08/ac/Crbb6muA_o.jpg" width="500"></p> 
<ul><li>通过手机软件 nRF Connect 也能搜索到来自开发板的信号，说明开发板确实在工作了。</li></ul> 
<p style="text-align:center;"><img alt="" class="has" src="https://images2.imgbox.com/58/4b/3ZeJEFa6_o.png" width="300"></p> 
<p><strong>调试</strong></p> 
<ul><li>在菜单栏，选择“Debug -&gt; Go”，SES 界面变为调试状态，点击左上方的运行按钮，即可开始调试。</li></ul> 
<p style="text-align:center;"><img alt="" class="has" src="https://images2.imgbox.com/f3/ff/antqni4e_o.png" width="800"></p> 
<ul><li>在行号旁边点击，可以添加断点。SES 是配套 J-Link 的官方调试软件，所以其他专业软件有的功能 SES 都能做到，至此，环境搭建完成。</li></ul> 
<p style="text-align:center;"><img alt="" class="has" src="https://images2.imgbox.com/1d/11/TMQi1azn_o.png" width="800"></p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f5aadc29f3ef098a012f3a2d159c7f20/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ConnectionRefused报错总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2d6edc73f8d71b2e3e3fdb554a1f826a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于Findbugs的一些常见报错的翻译和处理方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>