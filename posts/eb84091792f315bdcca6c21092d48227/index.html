<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python进阶(1) | 使用VScode写单元测试 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Python进阶(1) | 使用VScode写单元测试" />
<meta property="og:description" content="Python进阶(1) | 单元测试 2024.01.28
VSCode: 1.85.1
Linux(ubuntu 22.04)
文章目录 Python进阶(1) | 单元测试1. 目的2. Python Profile3. 单元测试框架3.1 什么是单元测试3.2 选一个单元测试框架3.3 编写 Python 单元测试代码3.4 在 VSCode 里发现单元测试3.5 再写一个单元和测试: IoU 的计算 4. 总结5. References 1. 目的 使用 Python 实现一些小工具、库的时候，增加单元测试来保证正确性。
重读 VSCode 的 Python 官方文档， 更新个人的 Python 开发效率。
2. Python Profile VSCode 提供了定制 profile 的功能， 个人目前理解为类似于 vim/emacs 里的模式的升级版。以前我只是配置VSCode的全局配置和当前工程配置， 而 Profile 则是建立了不同的配置，每个打开的VSCode工程都可以在不同的 profile 之间切换。
举例： 分别设置 C&#43;&#43; Profile 和 Python profile， 在 Python profile 和 C&#43;&#43; profile 中使用不同的快捷键、不同的UI布局等。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/eb84091792f315bdcca6c21092d48227/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-28T14:59:58+08:00" />
<meta property="article:modified_time" content="2024-01-28T14:59:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python进阶(1) | 使用VScode写单元测试</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Python1___0"></a>Python进阶(1) | 单元测试</h2> 
<p>2024.01.28<br> VSCode: 1.85.1<br> Linux(ubuntu 22.04)</p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Python1___0" rel="nofollow">Python进阶(1) | 单元测试</a></li><li><ul><li><a href="#1__7" rel="nofollow">1. 目的</a></li><li><a href="#2_Python_Profile_13" rel="nofollow">2. Python Profile</a></li><li><a href="#3__24" rel="nofollow">3. 单元测试框架</a></li><li><ul><li><a href="#31__26" rel="nofollow">3.1 什么是单元测试</a></li><li><a href="#32__47" rel="nofollow">3.2 选一个单元测试框架</a></li><li><a href="#33__Python__53" rel="nofollow">3.3 编写 Python 单元测试代码</a></li><li><a href="#34__VSCode__93" rel="nofollow">3.4 在 VSCode 里发现单元测试</a></li><li><a href="#35__IoU__120" rel="nofollow">3.5 再写一个单元和测试: IoU 的计算</a></li></ul> 
   </li><li><a href="#4__263" rel="nofollow">4. 总结</a></li><li><a href="#5_References_271" rel="nofollow">5. References</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1__7"></a>1. 目的</h3> 
<p>使用 Python 实现一些小工具、库的时候，增加单元测试来保证正确性。</p> 
<p>重读 VSCode 的 Python 官方文档， 更新个人的 Python 开发效率。</p> 
<h3><a id="2_Python_Profile_13"></a>2. Python Profile</h3> 
<p>VSCode 提供了定制 profile 的功能， 个人目前理解为类似于 vim/emacs 里的模式的升级版。以前我只是配置VSCode的全局配置和当前工程配置， 而 Profile 则是建立了不同的配置，每个打开的VSCode工程都可以在不同的 profile 之间切换。</p> 
<p>举例： 分别设置 C++ Profile 和 Python profile， 在 Python profile 和 C++ profile 中使用不同的快捷键、不同的UI布局等。</p> 
<p>关于 profile 的完整文档在 https://code.visualstudio.com/docs/editor/profiles</p> 
<p>官方提供了 Python 的profile，可以根据这个预定义的 profile， 继承它，创建一个自己的 Python profile:<br> https://code.visualstudio.com/docs/editor/profiles#_python-profile-template</p> 
<h3><a id="3__24"></a>3. 单元测试框架</h3> 
<h4><a id="31__26"></a>3.1 什么是单元测试</h4> 
<blockquote> 
 <p>A unit is a specific piece of code to be tested, such as a function or a class. Unit tests are then other pieces of code that specifically exercise the code unit with a full range of different inputs, including boundary and edge cases. Both the unittest and pytest frameworks can be used to write unit tests.</p> 
</blockquote> 
<p>所谓单元，指的是一段特定的要被测试的代码，比如说一个函数、一个类。<br> 所谓测试，指的是被测试代码A之外的代码B， 也就是说B这部分代码存在的意义，就是测试A这部分代码。<br> 测试代码通常需要包含各种不同的输入，包括边界情况。<br> 单元测试仅仅关注输入 和 输出， 不关注代码实现的细节。</p> 
<p>因此，所谓单元测试，首先需要划分出单元，然后针对每个单元（或者仅对于关注的单元），编写测试代码。</p> 
<blockquote> 
 <p>For each input, you then define the function’s expected return value (or values).</p> 
</blockquote> 
<p>对于被测试的代码的每一种输入，你需要定义它的预期结果。</p> 
<blockquote> 
 <p>With all the arguments and expected return values in hand, you now write the tests themselves, which are pieces of code that call the function with a particular input, then compare the actual return value with the expected return value (this comparison is called an assertion):</p> 
</blockquote> 
<p>然后调用被测试的代码A： 给它传入输入， 获得它的输出结果， 并且和你预设的结果进行比对，结果一样则成功，不一样则报告失败。</p> 
<p>https://code.visualstudio.com/docs/python/testing</p> 
<h4><a id="32__47"></a>3.2 选一个单元测试框架</h4> 
<p>Python 最常用的单元测试框架: unittest 和 pytest.</p> 
<p>unittest 是 Python 标准库的模块， 也就是 Python 安装后自带的。 pytest 则需要自行安装: <code>pip install pytest</code>.</p> 
<h4><a id="33__Python__53"></a>3.3 编写 Python 单元测试代码</h4> 
<p>首先，是被测试的单元的代码, <code>inc_dec.py</code>:</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">increment</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">1</span>

<span class="token keyword">def</span> <span class="token function">decrement</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x <span class="token operator">-</span> <span class="token number">1</span>
</code></pre> 
<p>然后， 是编写测试代码. 先用 unittest 写一遍：<code>test_unittest.py</code></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> inc_dec
<span class="token keyword">import</span> unittest

<span class="token keyword">class</span> <span class="token class-name">Test_TestIncrementDecrement</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_increment</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>inc_dec<span class="token punctuation">.</span>increment<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 这个测试用例一定会失败，是刻意做的</span>
    <span class="token keyword">def</span> <span class="token function">test_decrement</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>inc_dec<span class="token punctuation">.</span>decrement<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    unittest<span class="token punctuation">.</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>再用 pytest 写一遍， 写法更简单:</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> inc_dec

<span class="token keyword">def</span> <span class="token function">test_increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> inc_dec<span class="token punctuation">.</span>increment<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span>

<span class="token comment"># 这个测试用例一定会失败，是刻意做的</span>
<span class="token keyword">def</span> <span class="token function">test_decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> inc_dec<span class="token punctuation">.</span>decrement<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span>
</code></pre> 
<h4><a id="34__VSCode__93"></a>3.4 在 VSCode 里发现单元测试</h4> 
<p>首先在 VSCode 里点击左侧的 Testing 按钮， 创建测试相关的配置:<br> <img src="https://images2.imgbox.com/04/d1/hBGawbHz_o.png" alt="在这里插入图片描述"></p> 
<p>它对应到 .vscode/setting.json 里的内容:</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"python.testing.pytestArgs"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"."</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"python.testing.unittestEnabled"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string">"python.testing.pytestEnabled"</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后点击 Testing 视图中的测试用例中最上方的按钮， 会自动发现和执行所有的测试用例：<br> <img src="https://images2.imgbox.com/f5/16/eOsOBKdq_o.png" alt="在这里插入图片描述"></p> 
<p>在 Testing 界面中点击到 “失败” （红色） 的case， 会看到失败的具体测试代码。我们发现是测试代码本身写错， 于是改掉， 然后重新在 Testing 界面中执行测试：<br> <img src="https://images2.imgbox.com/a3/22/r7fcEjJv_o.png" alt="在这里插入图片描述"></p> 
<p>最终，我们看到 Testing 界面中的每一项都是绿色， 表示都成功了：<br> <img src="https://images2.imgbox.com/ad/6e/wzuyJnnC_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="35__IoU__120"></a>3.5 再写一个单元和测试: IoU 的计算</h4> 
<p>前面给出的 inc_dec.py 的代码太简单， 测试代码也不太符合预期解决的问题。</p> 
<p>单元测试的预期目的，是发现单元中的bug。这次写一个经典的计算两个Box的IoU的函数，并且故意缺少处理非法box长度的情况。</p> 
<p>bbox.py:</p> 
<pre><code class="prism language-python"><span class="token comment"># define Box class</span>
<span class="token keyword">class</span> <span class="token class-name">Box</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x
        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y
        self<span class="token punctuation">.</span>w <span class="token operator">=</span> w
        self<span class="token punctuation">.</span>h <span class="token operator">=</span> h
        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score
    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Box(x=%f, y=%f, w=%f, h=%f, score=%f)'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">,</span> self<span class="token punctuation">.</span>w<span class="token punctuation">,</span> self<span class="token punctuation">.</span>h<span class="token punctuation">,</span> self<span class="token punctuation">.</span>score<span class="token punctuation">)</span>

<span class="token comment"># calculate IoU of two boxes</span>
<span class="token keyword">def</span> <span class="token function">box_iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># get coordinates of intersecting rectangle</span>
    x_left <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>x<span class="token punctuation">)</span>
    y_top <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>y<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    x_right <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>x <span class="token operator">+</span> box1<span class="token punctuation">.</span>w<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>x <span class="token operator">+</span> box2<span class="token punctuation">.</span>w<span class="token punctuation">)</span>
    y_bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>y <span class="token operator">+</span> box1<span class="token punctuation">.</span>h<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>y <span class="token operator">+</span> box2<span class="token punctuation">.</span>h<span class="token punctuation">)</span>
    <span class="token comment"># if x_right &lt; x_left or y_bottom &lt; y_top:</span>
    <span class="token comment">#     return 0.0</span>
    <span class="token comment"># intersection area</span>
    intersection_area <span class="token operator">=</span> <span class="token punctuation">(</span>x_right <span class="token operator">-</span> x_left<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y_bottom <span class="token operator">-</span> y_top<span class="token punctuation">)</span>
    <span class="token comment"># union area</span>
    box1_area <span class="token operator">=</span> box1<span class="token punctuation">.</span>w <span class="token operator">*</span> box1<span class="token punctuation">.</span>h
    box2_area <span class="token operator">=</span> box2<span class="token punctuation">.</span>w <span class="token operator">*</span> box2<span class="token punctuation">.</span>h
    union_area <span class="token operator">=</span> box1_area <span class="token operator">+</span> box2_area <span class="token operator">-</span> intersection_area
    <span class="token keyword">return</span> intersection_area <span class="token operator">/</span> union_area
</code></pre> 
<p>test_bbox.py:</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> bbox

<span class="token keyword">def</span> <span class="token function">test_box_iou</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    box1 <span class="token operator">=</span> bbox<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
    box2 <span class="token operator">=</span> bbox<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> bbox<span class="token punctuation">.</span>box_iou<span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1.0</span>

<span class="token keyword">def</span> <span class="token function">test_box_iou2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    box1 <span class="token operator">=</span> bbox<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
    box2 <span class="token operator">=</span> bbox<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> bbox<span class="token punctuation">.</span>box_iou<span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">test_box_iou3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 这个例子是边界case，很容易失败</span>
    box1 <span class="token operator">=</span> bbox<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
    box2 <span class="token operator">=</span> bbox<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> bbox<span class="token punctuation">.</span>box_iou<span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
</code></pre> 
<p>上述代码在 test_box_iou3() 时失败了, 错误类型是出现了除0错误。显然，除非两个 box 大小都是0，否则不会出现除以0的情况。于是很偷懒的改了一下：</p> 
<pre><code class="prism language-python"><span class="token comment"># calculate IoU of two boxes</span>
<span class="token keyword">def</span> <span class="token function">box_iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># get coordinates of intersecting rectangle</span>
    x_left <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>x<span class="token punctuation">)</span>
    y_top <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>y<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    x_right <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>x <span class="token operator">+</span> box1<span class="token punctuation">.</span>w<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>x <span class="token operator">+</span> box2<span class="token punctuation">.</span>w<span class="token punctuation">)</span>
    y_bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>y <span class="token operator">+</span> box1<span class="token punctuation">.</span>h<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>y <span class="token operator">+</span> box2<span class="token punctuation">.</span>h<span class="token punctuation">)</span>
    <span class="token comment"># if x_right &lt; x_left or y_bottom &lt; y_top:</span>
    <span class="token comment">#     return 0.0</span>
    <span class="token comment"># intersection area</span>
    intersection_area <span class="token operator">=</span> <span class="token punctuation">(</span>x_right <span class="token operator">-</span> x_left<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y_bottom <span class="token operator">-</span> y_top<span class="token punctuation">)</span>
    <span class="token comment"># union area</span>
    box1_area <span class="token operator">=</span> box1<span class="token punctuation">.</span>w <span class="token operator">*</span> box1<span class="token punctuation">.</span>h
    box2_area <span class="token operator">=</span> box2<span class="token punctuation">.</span>w <span class="token operator">*</span> box2<span class="token punctuation">.</span>h
    union_area <span class="token operator">=</span> box1_area <span class="token operator">+</span> box2_area <span class="token operator">-</span> intersection_area
    <span class="token keyword">if</span> union_area <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">return</span> intersection_area <span class="token operator">/</span> union_area
</code></pre> 
<p>再增加一个侧测试用例：当box本身的宽度或高度为负值时，预期结果我们设置为0. 测试代码是：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">test_box_iou4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    box1 <span class="token operator">=</span> bbox<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
    box2 <span class="token operator">=</span> bbox<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
    iou <span class="token operator">=</span> bbox<span class="token punctuation">.</span>box_iou<span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> iou <span class="token operator">==</span> <span class="token number">0</span>
</code></pre> 
<p>IoU的实现代码，仍然是用很偷懒的修改：</p> 
<pre><code class="prism language-python"><span class="token comment"># calculate IoU of two boxes</span>
<span class="token keyword">def</span> <span class="token function">box_iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># get coordinates of intersecting rectangle</span>
    x_left <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>x<span class="token punctuation">)</span>
    y_top <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>y<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    x_right <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>x <span class="token operator">+</span> box1<span class="token punctuation">.</span>w<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>x <span class="token operator">+</span> box2<span class="token punctuation">.</span>w<span class="token punctuation">)</span>
    y_bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>y <span class="token operator">+</span> box1<span class="token punctuation">.</span>h<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>y <span class="token operator">+</span> box2<span class="token punctuation">.</span>h<span class="token punctuation">)</span>
    <span class="token comment"># if x_right &lt; x_left or y_bottom &lt; y_top:</span>
    <span class="token comment">#     return 0.0</span>
    <span class="token comment"># intersection area</span>
    intersection_area <span class="token operator">=</span> <span class="token punctuation">(</span>x_right <span class="token operator">-</span> x_left<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y_bottom <span class="token operator">-</span> y_top<span class="token punctuation">)</span>
    <span class="token comment"># union area</span>
    box1_area <span class="token operator">=</span> box1<span class="token punctuation">.</span>w <span class="token operator">*</span> box1<span class="token punctuation">.</span>h
    box2_area <span class="token operator">=</span> box2<span class="token punctuation">.</span>w <span class="token operator">*</span> box2<span class="token punctuation">.</span>h
    union_area <span class="token operator">=</span> box1_area <span class="token operator">+</span> box2_area <span class="token operator">-</span> intersection_area
    <span class="token comment"># if union_area == 0:</span>
    <span class="token comment">#     return 0</span>
    <span class="token comment"># if box1.w &lt; 0 or box1.h &lt; 0 or box2.w &lt; 0 or box2.h &lt; 0:</span>
    <span class="token comment">#     return 0</span>
    <span class="token keyword">return</span> intersection_area <span class="token operator">/</span> union_area
</code></pre> 
<p>此时的测试仍然不够完备。再补充一个:</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">test_box_iou5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    box1 <span class="token operator">=</span> bbox<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
    box2 <span class="token operator">=</span> bbox<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
    iou <span class="token operator">=</span> bbox<span class="token punctuation">.</span>box_iou<span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> iou <span class="token operator">==</span> <span class="token number">0</span>
</code></pre> 
<p>现在，把包含了补丁的 box_iou() 重构一番，得到：</p> 
<pre><code class="prism language-python"><span class="token comment"># calculate IoU of two boxes</span>
<span class="token keyword">def</span> <span class="token function">box_iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># get coordinates of intersecting rectangle</span>
    x_left <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>x<span class="token punctuation">)</span>
    y_top <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>y<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    x_right <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>x <span class="token operator">+</span> box1<span class="token punctuation">.</span>w<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>x <span class="token operator">+</span> box2<span class="token punctuation">.</span>w<span class="token punctuation">)</span>
    y_bottom <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>box1<span class="token punctuation">.</span>y <span class="token operator">+</span> box1<span class="token punctuation">.</span>h<span class="token punctuation">,</span> box2<span class="token punctuation">.</span>y <span class="token operator">+</span> box2<span class="token punctuation">.</span>h<span class="token punctuation">)</span>
    <span class="token keyword">if</span> x_right <span class="token operator">&lt;=</span> x_left <span class="token keyword">or</span> y_bottom <span class="token operator">&lt;=</span> y_top<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0.0</span>
    <span class="token comment"># intersection area</span>
    intersection_area <span class="token operator">=</span> <span class="token punctuation">(</span>x_right <span class="token operator">-</span> x_left<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y_bottom <span class="token operator">-</span> y_top<span class="token punctuation">)</span>
    <span class="token comment"># union area</span>
    box1_area <span class="token operator">=</span> box1<span class="token punctuation">.</span>w <span class="token operator">*</span> box1<span class="token punctuation">.</span>h
    box2_area <span class="token operator">=</span> box2<span class="token punctuation">.</span>w <span class="token operator">*</span> box2<span class="token punctuation">.</span>h
    union_area <span class="token operator">=</span> box1_area <span class="token operator">+</span> box2_area <span class="token operator">-</span> intersection_area
    <span class="token keyword">return</span> intersection_area <span class="token operator">/</span> union_area
</code></pre> 
<h3><a id="4__263"></a>4. 总结</h3> 
<p>VSCode 的 Testing 视图，改善了运行单元测试的交互界面。传统的 C/C++ 中， gtest 框架通过传入 --gtest_filter=xxx 来过滤测试， 在 VSCode 面前仍然落后。</p> 
<p>至于单元测试代码是否够好， 一个标准是覆盖率的高低， 就像 IoU 的例子， 第一次用 ChatGPT 生成代码时，虽然看似正确， 但其实 test_box_iou5() 这个测试用例（两个box的大小都是0，并且重合）是无法通过的。</p> 
<p>因此， VSCode 的 Testing 界面仅仅是锦上添花， 单元测试的编写仍然需要考虑周全。</p> 
<h3><a id="5_References_271"></a>5. References</h3> 
<ul><li>https://code.visualstudio.com/docs/editor/profiles#_python-profile-template</li><li>https://code.visualstudio.com/docs/python/testing</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aef4d720296fb7f92bf17968e3bdad7e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ABC338(A-C)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5728d24d93b9791b62824883d1399e48/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">跟着cherno手搓游戏引擎【13】着色器（shader）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>