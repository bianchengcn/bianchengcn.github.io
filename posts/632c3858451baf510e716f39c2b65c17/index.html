<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>关于three.js在使用transformControl后的卡顿问题 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="关于three.js在使用transformControl后的卡顿问题" />
<meta property="og:description" content="关于three.js在使用transformControl后的卡顿问题 问题描述问题分析找到问题,分析为什么会造成这个问题?问题解决 问题描述 变换控制器( O r b i t C o n t r o l s OrbitControls OrbitControls)与轨道控制器( T r a n s f o r m C o n t r o l s TransformControls TransformControls)之争
为什么在执行完transformControl.attach(object);后,
轨道控制器就变的卡顿,即使我用 transformControl.detach();之后,
还是卡顿异常 问题分析 关于这个 three.js 中遇到的问题，即在使用 TransformControl.attach(object) 之后 OrbitControl 变得卡顿，可能是由于几个潜在的原因引起的。考虑到我们已经在 dragging-changed 事件中禁用了 OrbitControl,
即,
transformControl.addEventListener(&#39;dragging-changed&#39;, function (event) { controls.enabled = !event.value; }); ，这个问题可能不完全是由事件处理冲突导致的。以下是一些可能导致这种行为的原因及解决方案：
性能问题 复杂的场景渲染：如果您的场景非常复杂（许多物体或高多边形计数），那么在进行交互操作（如变换控制）时，性能可能会受到影响。解决方案：优化场景，减少渲染负担，例如通过减少场景中物体的数量或细节。 过度渲染(经过九牛二虎之力,终于找到了问题的关键,就是过度渲染!!!) 频繁更新：render() 函数可能被频繁调用，尤其是在您的 transformControl 的 ‘change’ 事件监听器中。解决方案：确保 render() 函数仅在必要时调用，或使用 requestAnimationFrame 来管理渲染循环。 资源未正确释放 资源管理：在使用 transformControl." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/632c3858451baf510e716f39c2b65c17/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-26T17:14:01+08:00" />
<meta property="article:modified_time" content="2024-01-26T17:14:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">关于three.js在使用transformControl后的卡顿问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>关于three.js在使用transformControl后的卡顿问题</h4> 
 <ul><li><a href="#_1" rel="nofollow">问题描述</a></li><li><a href="#_6" rel="nofollow">问题分析</a></li><li><a href="#_35" rel="nofollow">找到问题,分析为什么会造成这个问题?</a></li><li><a href="#_59" rel="nofollow">问题解决</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>问题描述</h2> 
<ul><li>变换控制器(<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          O 
         
        
          r 
         
        
          b 
         
        
          i 
         
        
          t 
         
        
          C 
         
        
          o 
         
        
          n 
         
        
          t 
         
        
          r 
         
        
          o 
         
        
          l 
         
        
          s 
         
        
       
         OrbitControls 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right: 0.0715em;">tC</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">s</span></span></span></span></span>)与轨道控制器(<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          T 
         
        
          r 
         
        
          a 
         
        
          n 
         
        
          s 
         
        
          f 
         
        
          o 
         
        
          r 
         
        
          m 
         
        
          C 
         
        
          o 
         
        
          n 
         
        
          t 
         
        
          r 
         
        
          o 
         
        
          l 
         
        
          s 
         
        
       
         TransformControls 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord mathnormal">an</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal" style="margin-right: 0.0278em;">or</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right: 0.0715em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">s</span></span></span></span></span>)之争<br> 为什么在执行完<code>transformControl.attach(object);</code>后,<br> <code>轨道控制器</code>就变的卡顿,即使我用 <code>transformControl.detach();</code>之后,<br> 还是卡顿异常</li></ul> 
<h2><a id="_6"></a>问题分析</h2> 
<p>关于这个 three.js 中遇到的问题，即在使用 TransformControl.attach(object) 之后 OrbitControl 变得卡顿，可能是由于几个潜在的原因引起的。<mark>考虑到我们已经在 dragging-changed 事件中禁用了 OrbitControl</mark>,<br> 即,</p> 
<pre><code class="prism language-js">transformControl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragging-changed'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  controls<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token operator">!</span>event<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>，这个问题<mark>可能不完全是由事件处理冲突导致的</mark>。以下是<mark>一些可能导致这种行为的原因及解决方案</mark>：</p> 
<ol><li><mark>性能问题</mark></li></ol> 
<ul><li>复杂的场景渲染：如果您的场景非常复杂（许多物体或高多边形计数），那么在进行交互操作（如变换控制）时，性能可能会受到影响。</li><li>解决方案：优化场景，减少渲染负担，例如通过减少场景中物体的数量或细节。</li></ul> 
<ol start="2"><li><mark>过度渲染</mark>(<font color="red">经过九牛二虎之力,终于找到了问题的关键,就是过度渲染!!!</font>)</li></ol> 
<ul><li>频繁更新：render() 函数可能被频繁调用，尤其是在您的 transformControl 的 ‘change’ 事件监听器中。</li><li>解决方案：确保 render() 函数仅在必要时调用，或使用 requestAnimationFrame 来管理渲染循环。</li></ul> 
<ol start="3"><li><mark>资源未正确释放</mark></li></ol> 
<ul><li>资源管理：在使用 transformControl.detach() 后，某些资源可能没有被正确释放或重置。</li><li>解决方案：检查是否有任何未处理的资源或状态需要在分离操作后清理或重置。</li></ul> 
<ol start="4"><li><mark>内存泄漏</mark></li></ol> 
<ul><li>事件监听器：如果在使用过程中不断添加事件监听器而没有适当移除，可能会导致内存泄漏。</li><li>解决方案：确保添加的事件监听器在不需要时被移除，避免内存泄漏。</li></ul> 
<ol start="5"><li><mark>GPU/CPU 负载</mark></li></ol> 
<ul><li>硬件限制：如果您的设备的 GPU 或 CPU 资源受限，可能会影响渲染性能。</li><li>解决方案：在不同的硬件上测试您的应用，查看问题是否依旧存在，以确认是否为硬件限制问题。</li></ul> 
<ol start="6"><li><mark>浏览器或框架兼容性问题</mark></li></ol> 
<ul><li>兼容性：可能存在浏览器或 three.js 版本的兼容性问题。</li><li>解决方案：尝试在不同的浏览器中运行您的应用，检查 three.js 是否是最新版本，或者是否有已知的兼容性问题。</li></ul> 
<h2><a id="_35"></a>找到问题,分析为什么会造成这个问题?</h2> 
<p>卡顿的代码是这样的:</p> 
<pre><code class="prism language-js"><span class="token keyword">let</span> transformControl<span class="token punctuation">;</span><span class="token comment">//变换控制器</span>
<span class="token comment">//创建一个 TransformControls 实例(将相机 camera 和渲染器的 DOM 元素 renderer.domElement 作为参数传递进去)</span>
transformControl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformControls</span><span class="token punctuation">(</span>camera<span class="token punctuation">,</span> renderer<span class="token punctuation">.</span>domElement<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//接下来，我们添加了两个事件监听器</span>
<span class="token comment">//1.当 TransformControls 的变换发生变化时，即用户交互操作导致物体进行平移、旋转或缩放时，触发 animate 函数重新渲染场景。</span>
<span class="token comment">//即,模型改变=&gt;重新渲染</span>
transformControl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> render<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//2.当用户开始或停止拖拽物体时，通过 event.value 判断拖拽状态，</span>
<span class="token comment">//如果拖拽开始（event.value 为 true），则禁用其他的控制器（如鼠标控制器 controls），</span>
<span class="token comment">//以防止在拖拽过程中出现与 TransformControls 的冲突。</span>
transformControl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragging-changed'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 controls<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token operator">!</span>event<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//添加到场景中</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>transformControl<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在three.js中,<code>remove</code>,<code>detach</code>等类似的这些函数,仅仅只是在表面上移除可模型,但是仍旧存在于内存中.只是你在场景中看不到了而已.</p> 
<blockquote> 
 <p>也就是说,当你用detach移除变换控制器后,变换控制器只是你看不到了也点不到了,但是他依旧存在于整个内存中,其中有一个语句 <code>transformControl.addEventListener('change', render);</code>,他是在变换控制器附着的模型有平移、旋转或缩放操作时,会被调用,所以当你取消对模型的附着,也就是调用transformControl.detach();后,表面上变换控制器没有附着在模型上了,但是实际上还在他在幕后监听着一些东西!<br> 当你用detach()使得变换控制器消失后,它依旧监视着这个牙齿,所以之后你再用轨道控制器对整个场景进行平移、旋转或缩放操作时,这个颗之前被<code>transformControl</code>附着的牙齿也属于场景中的一分子,所以,<code>transformControl.addEventListener('change', render);</code>还是会被触发.so,<mark>频繁的调用render是场景卡顿的罪魁祸首!!!</mark></p> 
</blockquote> 
<h2><a id="_59"></a>问题解决</h2> 
<p>其实把<code>transformControl.addEventListener('change', render);</code>这一行注释掉就好,防止重复渲染整个场景</p> 
<pre><code class="prism language-js"><span class="token comment">/**********
 * 转换控制器
 */</span>
<span class="token keyword">const</span> pointer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//客户端坐标转化为设备坐标</span>
<span class="token comment">// const onDownPosition = new THREE.Vector2();//鼠标按下的客户端坐标</span>
<span class="token comment">// const onUpPosition = new THREE.Vector2();//鼠标抬起的客户端坐标</span>
<span class="token keyword">let</span> transformControl<span class="token punctuation">;</span><span class="token comment">//变换控制器</span>
<span class="token comment">//创建一个 TransformControls 实例(将相机 camera 和渲染器的 DOM 元素 renderer.domElement 作为参数传递进去)</span>
transformControl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformControls</span><span class="token punctuation">(</span>camera<span class="token punctuation">,</span> renderer<span class="token punctuation">.</span>domElement<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//接下来，我们添加了两个事件监听器</span>
<span class="token comment">//1.当 TransformControls 的变换发生变化时，即用户交互操作导致物体进行平移、旋转或缩放时，触发 animate 函数重新渲染场景。</span>
<span class="token comment">//即,模型改变=&gt;重新渲染</span>
<span class="token comment">//transformControl.addEventListener('change', render);</span>

<span class="token comment">//2.当用户开始或停止拖拽物体时，通过 event.value 判断拖拽状态，</span>
<span class="token comment">//如果拖拽开始（event.value 为 true），则禁用其他的控制器（如鼠标控制器 controls），</span>
<span class="token comment">//以防止在拖拽过程中出现与 TransformControls 的冲突。</span>
transformControl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragging-changed'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  controls<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token operator">!</span>event<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//添加到场景中</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>transformControl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// document.addEventListener('pointerdown', onPointerDown);</span>
<span class="token comment">// document.addEventListener('pointerup', onPointerUp);</span>
<span class="token comment">// document.addEventListener('pointermove', onPointerMove);</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> onClick<span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"keydown"</span><span class="token punctuation">,</span> handleKeyDown<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  pointer<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>clientX <span class="token operator">/</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  pointer<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>clientY <span class="token operator">/</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  raycaster<span class="token punctuation">.</span><span class="token function">setFromCamera</span><span class="token punctuation">(</span>pointer<span class="token punctuation">,</span> camera<span class="token punctuation">)</span><span class="token punctuation">;</span>
  intersects <span class="token operator">=</span> raycaster<span class="token punctuation">.</span><span class="token function">intersectObjects</span><span class="token punctuation">(</span>objects<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>intersects<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> object <span class="token operator">=</span> intersects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>object<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">!==</span> transformControl<span class="token punctuation">.</span>object<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      transformControl<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      transformControl<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
      transformControl<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//controls.enabled = false;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">handleKeyDown</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token string">'q'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>transformControl<span class="token punctuation">.</span>object<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      transformControl<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      transformControl<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//controls.enabled = true;</span>
      <span class="token comment">//render();</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8f5b7af8bdfc6773e3b633c7a1bab703/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">禁用windows update服务</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9e73fc778f17c93a2c1261a8633bbfce/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何在 Ubuntu 20.04 上安装 MySQL</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>