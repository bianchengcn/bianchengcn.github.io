<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>springboot整合支付宝沙箱支付 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="springboot整合支付宝沙箱支付" />
<meta property="og:description" content="springboot整合支付宝沙箱支付 1.简介 支付宝开发平台地址：https://open.alipay.com/develop/sandbox/app
对于学生来说，目前网上确实没有比较统一而且质量好的支付教程。因为支付对个人开发者尤其是学生来说不太友好。因此，自己折腾两天，算是整理了一篇关于支付宝沙箱支付的文章。况且个人是不能申请支付（wx和alipay）都一样。幸亏有支付宝沙箱这个环境。其实跟正式环境差不多，就换下配置即可。
整体流程
2.配置说明 要记住这几个重要的配置
appId 这个是appIdprivateKey 商户私钥publicKey 支付宝公钥, 即对应APPID下的支付宝公钥notifyUrl 支付成功后异步回调地址(注意是必须是公网地址)returnUrl #支付后回调地址signType 签名类型 一般写 RSA2charset utf-8format json#网关地址 在支付宝开发平台复制拷贝下来gatewayUrl: https://openapi.alipaydev.com/gateway.dologPath: F:\ 日志路径 3.springboot整合支付宝沙箱支付代码 需要导入依赖
&lt;dependency&gt; &lt;groupId&gt;com.alipay.sdk&lt;/groupId&gt; &lt;artifactId&gt;alipay-sdk-java&lt;/artifactId&gt; &lt;version&gt;4.33.39.ALL&lt;/version&gt; &lt;/dependency&gt; 3.1 配置类 package com.hjt.config; import lombok.Data; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.cloud.context.config.annotation.RefreshScope; import org.springframework.context.annotation.Configuration; import org.springframework.context.annotation.PropertySource; @RefreshScope @Configuration @ConfigurationProperties(prefix = &#34;alipay&#34;) @Data /*** * @author: hjt * @Date: 2020/11/13/19:19 * @Description: 支付宝配置类(读取配置文件) */ public class MyAliPayConfig { /** * APPID */ private String appId; /** * 商户私钥, 即PKCS8格式RSA2私钥 */ private String privateKey; /** * 支付宝公钥 */ private String publicKey; /** * 服务器异步通知页面路径,需http://格式的完整路径 * 踩坑:不能加?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/a08365969762370be129a2c5221c232a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-11T09:22:41+08:00" />
<meta property="article:modified_time" content="2022-10-11T09:22:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">springboot整合支付宝沙箱支付</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="springboot_1"></a>springboot整合支付宝沙箱支付</h2> 
<h3><a id="1_3"></a>1.简介</h3> 
<p>支付宝开发平台地址：https://open.alipay.com/develop/sandbox/app</p> 
<p>对于学生来说，目前网上确实没有比较统一而且质量好的支付教程。因为支付对个人开发者尤其是学生来说不太友好。因此，自己折腾两天，算是整理了一篇关于支付宝沙箱支付的文章。况且个人是不能申请支付（wx和alipay）都一样。幸亏有支付宝沙箱这个环境。其实跟正式环境差不多，就换下配置即可。</p> 
<p>整体流程</p> 
<p><img src="https://images2.imgbox.com/57/56/e3nkolFy_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_16"></a>2.配置说明</h3> 
<p>要记住这几个重要的配置</p> 
<ul><li><code>appId</code> 这个是appId</li><li><code>privateKey</code> 商户私钥</li><li><code>publicKey </code> 支付宝公钥, 即对应APPID下的支付宝公钥</li><li><code>notifyUrl</code> 支付成功后异步回调地址(注意是必须是公网地址)</li><li><code>returnUrl</code> #支付后回调地址</li><li><code>signType</code> 签名类型 一般写 RSA2</li><li><code>charset</code> utf-8</li><li><code>format</code> json</li><li>#网关地址 在支付宝开发平台复制拷贝下来</li><li><code>gatewayUrl</code>: https://openapi.alipaydev.com/gateway.do</li><li><code>logPath</code>: F:\ 日志路径</li></ul> 
<pre><code class="prism language-java">
</code></pre> 
<p><img src="https://images2.imgbox.com/83/71/gsj5AN6k_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-8CwUNj9q-1665450970482)(springboot%E6%95%B4%E5%90%88%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E6%94%AF%E4%BB%98.assets/image-20220919171644335.png)]"></p> 
<p><img src="https://images2.imgbox.com/c6/30/rdhOCDso_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-e0OD2JA1-1665450970482)(springboot%E6%95%B4%E5%90%88%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E6%94%AF%E4%BB%98.assets/image-20220919172243239.png)]"></p> 
<h3><a id="3springboot_48"></a>3.springboot整合支付宝沙箱支付代码</h3> 
<p>需要导入依赖</p> 
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sdk&lt;/groupId&gt;
    &lt;artifactId&gt;alipay-sdk-java&lt;/artifactId&gt;
    &lt;version&gt;4.33.39.ALL&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> 
<h3><a id="31__62"></a>3.1 配置类</h3> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hjt<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>context<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RefreshScope</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PropertySource</span><span class="token punctuation">;</span>



<span class="token annotation punctuation">@RefreshScope</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"alipay"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token comment">/***
 * @author: hjt
 * @Date: 2020/11/13/19:19
 * @Description: 支付宝配置类(读取配置文件)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAliPayConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * APPID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appId<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 商户私钥, 即PKCS8格式RSA2私钥
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> privateKey<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 支付宝公钥
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> publicKey<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 服务器异步通知页面路径,需http://格式的完整路径
     * 踩坑:不能加?type=abc这类自定义参数
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> notifyUrl<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 页面跳转同步通知页面路径,需http://格式的完整路径
     * 踩坑:不能加?type=abc这类自定义参数
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> returnUrl<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 签名方式
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> signType<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 字符编码格式
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> charset<span class="token punctuation">;</span>

    <span class="token comment">/***
     * 参数编码格式  json
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> format<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 支付宝网关
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> gatewayUrl<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 日志打印地址
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> logPath<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="32_java_139"></a>3.2 生成订单信息（以java为例,官网例子）</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span>   doPost <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpRequest<span class="token punctuation">,</span>
                      <span class="token class-name">HttpServletResponse</span> httpResponse<span class="token punctuation">)</span>   <span class="token keyword">throws</span>  <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span>  <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">AlipayClient</span> alipayClient <span class="token operator">=</span>  <span class="token keyword">new</span>  <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span> <span class="token string">"https://openapi.alipay.com/gateway.do"</span> <span class="token punctuation">,</span> APP_ID<span class="token punctuation">,</span> APP_PRIVATE_KEY<span class="token punctuation">,</span> FORMAT<span class="token punctuation">,</span> CHARSET<span class="token punctuation">,</span> ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span> SIGN_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获得初始化的AlipayClient </span>
    <span class="token class-name">AlipayTradePagePayRequest</span> alipayRequest <span class="token operator">=</span>  <span class="token keyword">new</span>  <span class="token class-name">AlipayTradePagePayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建API对应的request </span>
    alipayRequest<span class="token punctuation">.</span><span class="token function">setReturnUrl</span><span class="token punctuation">(</span> <span class="token string">"http://domain.com/CallBack/return_url.jsp"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    alipayRequest<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span> <span class="token string">"http://domain.com/CallBack/notify_url.jsp"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//在公共参数中设置回跳和通知地址 </span>
    alipayRequest<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span> <span class="token string">"{"</span>  <span class="token operator">+</span>
         <span class="token string">"    \"out_trade_no\":\"20150320010101001\","</span>  <span class="token operator">+</span>
         <span class="token string">"    \"product_code\":\"FAST_INSTANT_TRADE_PAY\","</span>  <span class="token operator">+</span>
         <span class="token string">"    \"total_amount\":88.88,"</span>  <span class="token operator">+</span>
         <span class="token string">"    \"subject\":\"Iphone6 16G\","</span>  <span class="token operator">+</span> 
         <span class="token string">"    \"body\":\"Iphone6 16G\","</span>  <span class="token operator">+</span>
         <span class="token string">"    \"passback_params\":\"merchantBizType%3d3C%26merchantBizNo%3d2016010101111\","</span>  <span class="token operator">+</span>
         <span class="token string">"    \"extend_params\":{"</span>  <span class="token operator">+</span>
         <span class="token string">"    \"sys_service_provider_id\":\"2088511833207846\""</span>  <span class="token operator">+</span>
         <span class="token string">"    }"</span> <span class="token operator">+</span>
         <span class="token string">"  }"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//填充业务参数 </span>
    <span class="token class-name">String</span> form<span class="token operator">=</span> <span class="token string">""</span> <span class="token punctuation">;</span>
     <span class="token keyword">try</span>  <span class="token punctuation">{<!-- --></span>
        form <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>alipayRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//调用SDK生成表单 </span>
    <span class="token punctuation">}</span>  <span class="token keyword">catch</span>  <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span> <span class="token string">"text/html;charset="</span>  <span class="token operator">+</span> CHARSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//直接将完整的表单html输出到页面 </span>
    httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以下是我自己业务代码的例子</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token class-name">PayInfoDto</span> payInfoDTO<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*查询订单id是否存在*/</span>
    <span class="token class-name">Long</span> orderId <span class="token operator">=</span> payInfoDTO<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*商品名称*/</span>
    <span class="token class-name">String</span> subject <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token comment">/*判断订单是否存在*/</span>
    <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orderInfo <span class="token operator">=</span> remoteOrderService<span class="token punctuation">.</span><span class="token function">getOrderInfo</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token class-name">PayException</span><span class="token punctuation">.</span>ORDER_ERROR_PAY_ORDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> orderInfo<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//订单总金额</span>
    <span class="token class-name">BigDecimal</span> total <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> proId <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getProId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*商品名称以,分割*/</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> proId<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> split<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> productInfo <span class="token operator">=</span> remoteOrderService<span class="token punctuation">.</span><span class="token function">getProductInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>productInfo<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token class-name">PayException</span><span class="token punctuation">.</span>ORDER_ERROR_PAY_PRODUCT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Product</span> product <span class="token operator">=</span> productInfo<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subject <span class="token operator">=</span> subject <span class="token operator">+</span> product<span class="token punctuation">.</span><span class="token function">getProTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//进行支付宝支付</span>
    <span class="token class-name">AlipayOrder</span> alipayOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//商户订单号</span>
    alipayOrder<span class="token punctuation">.</span><span class="token function">setOut_trade_no</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//订单名称</span>
    alipayOrder<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    alipayOrder<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//订单总金额</span>
    alipayOrder<span class="token punctuation">.</span><span class="token function">setTotal_amount</span><span class="token punctuation">(</span>total<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*进行支付*/</span>
    <span class="token class-name">String</span> payBody <span class="token operator">=</span> alipayUtil<span class="token punctuation">.</span><span class="token function">payByAlipay</span><span class="token punctuation">(</span>alipayOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"-----------支付信息实体---------{}"</span><span class="token punctuation">,</span>payBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//并把消息推送到mq查询是否支付成功</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>payBody<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token class-name">PayException</span><span class="token punctuation">.</span>ORDER_ERROR_PAY_BODY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*把支付信息写到html网页中*/</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/html;charset="</span> <span class="token operator">+</span> CHARSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 直接将完整的表单html输出到页面</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>payBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="33_227"></a>3.3支付成功后的异步通知</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">payNotifyUrl</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlipayApiException</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"-----------开始进行支付后的异步通知回调-------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*接收参数*/</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">exchangeParams</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> payContent <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"---------接收的参数--- -----{}"</span><span class="token punctuation">,</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*验证签名（支付宝公钥） 调用SDK验证签名*/</span>
    <span class="token keyword">boolean</span>  signVerified <span class="token operator">=</span> <span class="token class-name">AlipaySignature</span><span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> aliPayConfig<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> aliPayConfig<span class="token punctuation">.</span><span class="token function">getCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> aliPayConfig<span class="token punctuation">.</span><span class="token function">getSignType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>signVerified<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*收到支付宝异步通知,返回success,支付宝不再通知 否则会通知你三天三夜*/</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"-----验签成功-----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*应该马上返回"success",另起线程执行自己的业务逻辑*/</span>
        <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">ExecutorBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setWorkQueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//TODO 幂等性问题后续也要考虑</span>
                <span class="token comment">/*支付状态*/</span>
                <span class="token class-name">String</span> trade_status <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trade_status"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/*订单id*/</span>
                <span class="token class-name">String</span> out_trade_no <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/*支付成功*/</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PayConstant</span><span class="token punctuation">.</span>TRADE_FINISHED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">PayConstant</span><span class="token punctuation">.</span>TRADE_SUCCESS<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                    <span class="token class-name">Long</span> orderId <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">/*把对于的订单id改为已支付状态*/</span>
                    <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> order <span class="token operator">=</span> remoteOrderService<span class="token punctuation">.</span><span class="token function">updateOrderById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token class-name">PayConstant</span><span class="token punctuation">.</span>CODE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token class-name">PayException</span><span class="token punctuation">.</span>ORDER_ERROR_PAY_ORDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">/*存对于的支付信息*/</span>
                    <span class="token class-name">PayInfo</span> payInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    payInfo <span class="token operator">=</span> <span class="token class-name">PayInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">orderIds</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">callbackContent</span><span class="token punctuation">(</span>payContent<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">callbackTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">tradeStatus</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">tradeNo</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">buyerId</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"buyer_id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">totalAmount</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">sellerId</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"seller_id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">receiptAmount</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"receipt_amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">gmtCreate</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"gmt_create"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">gmtPayment</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"gmt_payment"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">fundBillList</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"fund_bill_list"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    payInfoMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>payInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"-----支付信息插入成功-------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/* 支付失败 */</span>
                <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"-------支付失败, 订单id：------{}"</span><span class="token punctuation">,</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token class-name">PayException</span><span class="token punctuation">.</span>ORDER_ERROR_PAY_BODY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO 验签成功后，按照支付结果异步通知中的描述，对支付结果中的业务内容进行二次校验，校验成功后在response中返回success并继续商家自身业务处理，校验失败返回failure</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"-----验签失败-----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"failure"</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO 验签失败则记录异常日志，并在response中返回failure.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意！！！异步通知的地址必须是公网地址，这里我采用的是frp内网穿透到本地的地址</p> 
<p>需要注意的是，异步通知必须要严格进行验签。</p> 
<p>运行效果图：</p> 
<p>先生成订单</p> 
<p><img src="https://images2.imgbox.com/9f/82/kcusLNCw_o.png" alt="​	[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-yirrvFNv-1665450970482)(springboot%E6%95%B4%E5%90%88%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E6%94%AF%E4%BB%98.assets/image-20220920093254760.png)]"></p> 
<p>然后再浏览器直接调用接口</p> 
<p>http://localhost:4401/pay/api/v1/pay-info/pay?Authorization=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.YWRtaW4.VaJOloHfQLjacnm6-__pSaeNZ1JbLAdlgeJT3JEptos&amp;orderId=769532559209283584</p> 
<p>会直接跳转到支付支付界面</p> 
<p><img src="https://images2.imgbox.com/d0/af/U01Q5gWZ_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-eMXbDidW-1665450970483)(springboot%E6%95%B4%E5%90%88%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E6%94%AF%E4%BB%98.assets/image-20220920093241376.png)]"></p> 
<p>账号密码都是可以在你沙箱账号看得到</p> 
<p><img src="https://images2.imgbox.com/b3/31/YXHC4imZ_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-YutI7SJJ-1665450970483)(springboot%E6%95%B4%E5%90%88%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E6%94%AF%E4%BB%98.assets/image-20220920093431990.png)]"></p> 
<p>支付成功后可见已经回调到我们异步通知自定义的接口了</p> 
<p>即我们在这配置的路径</p> 
<p><code>notifyUrl</code> 支付成功后异步回调地址(注意是必须是公网地址)</p> 
<p><img src="https://images2.imgbox.com/f2/32/X6vGbfwm_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-rmjvXjJF-1665450970483)(springboot%E6%95%B4%E5%90%88%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E6%94%AF%E4%BB%98.assets/image-20220920093533071.png)]"></p> 
<h3><a id="34_337"></a>3.4退款操作</h3> 
<table><thead><tr><th>参数</th><th>类型</th><th>是否必填</th><th>最大长度</th><th>描述</th><th>示例值</th></tr></thead><tbody><tr><td>trade_no</td><td>String</td><td>特殊可选</td><td>64</td><td>支付宝交易号。 和商户订单号不能同时为空</td><td>2021081722001419121412730660</td></tr><tr><td>out_trade_no</td><td>String</td><td>特殊可选</td><td>64</td><td>商户订单号。 订单支付时传入的商户订单号,和支付宝交易号不能同时为空。 trade_no,out_trade_no如果同时存在优先取trade_no</td><td>2014112611001004680073956707</td></tr><tr><td>out_request_no</td><td>String</td><td>必选</td><td>64</td><td>退款请求号。 请求退款接口时，传入的退款请求号，如果在退款请求时未传入，则该值为创建交易时的商户订单号。</td><td>HZ01RF001</td></tr><tr><td>query_options</td><td>String[]</td><td>可选</td><td>1024</td><td>查询选项，商户通过上送该参数来定制同步需要额外返回的信息字段，数组格式。枚举支持： refund_detail_item_list：本次退款使用的资金渠道； gmt_refund_pay：退款执行成功的时间； deposit_back_info：银行卡冲退信息；</td><td>refund_detail_item_list</td></tr></tbody></table> 
<p>商户可使用该接口查询自已通过alipay.trade.refund提交的退款请求是否执行成功。</p> 
<p>注意：1. 该接口的返回码10000，仅代表本次查询操作成功，不代表退款成功，当接口返回的refund_status值为REFUND_SUCCESS时表示退款成功，否则表示退款没有执行成功。<br> \2. 如果退款未成功，商户可以调用退款接口重试，重试时请务必保证退款请求号和退款金额一致，防止重复退款。<br> \3. 发起退款查询接口的时间不能离退款请求时间太短，建议之间间隔10秒以上。</p> 
<p>个人搭建项目代码地址：<br> <a href="https://github.com/hongjiatao/spring-boot-anyDemo">https://github.com/hongjiatao/spring-boot-anyDemo</a></p> 
<p>欢迎收藏点赞三连。谢谢！有问题可以留言博主会24小时内无偿回复。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7f147811ff8a1f1621e012687888abb0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java Web入门之Ajax的用法详解(附代码和实战）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/adb2f136e86c78b11b37ebe1256dc5d4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Qt&#43;FFmpeg】解码播放本地视频（一）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>