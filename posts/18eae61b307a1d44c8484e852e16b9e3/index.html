<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql insert插入时实现如果数据表中主键重复则更新，没有重复则插入的四种方法 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql insert插入时实现如果数据表中主键重复则更新，没有重复则插入的四种方法" />
<meta property="og:description" content="mysql insert插入时实现如果数据表中主键重复则更新，没有重复则插入的四种方法 1、replace语句：替换已有的行 replace语句是insert语句的一个变种 当添加新行时 1）如果主键值重复，那么覆盖表中已有的行 2）如果没有主键值重复，则插入该行 2、ignore insert语句可以使用ignore选项来当insert语句出现错误时，不显示错误信息，但是insert语句不执行。 insert ignore into 。。。。。 3、可以采用异常抓捕的方式来实现handler，相当于sqlserver中的try catch 4、如果在INSERT语句末尾指定了ON DUPLICATE KEY UPDATE，并且插入行后会导致在一个UNIQUE索引或PRIMARY KEY中出现重复值， 则在出现重复值的行执行UPDATE；如果不会导致唯一值列重复的问题，则插入新行。 四个方法分步解析： 操作表test表结构如下 1、replace语法 select * from test; 现在插入(1,’xiaohong’)数据，发现出现错误，错误提示（主键重复输入’1’），证明当insert插入相同主键时是会报错的。 现在我们来replace语句测试一下会不会不报错，执行成功 查询一下我们的表信息，发现之前的记录(1,’xiaozhang’)已经被替换成(1,’xiaohong’), 证明我们插入相同的主键信息，replace会替换原有信息。 replace语法执行和数据库中主键重复的数据会替换原有信息，那么执行不同的信息会有怎么样的操作呢？（发现执行和数据库中没有主键重复的数据，则执行插入操作） 2、ignore 这里我们应用insert ignore执行插入(1,’xiaoplan’),运行成功，但是数据没有插入到test表中。 insert ignore 和update联合使用（发现主键为’1’的’xiaohong’被更新为’xiaolan’） 运行结果图 3、可以采用异常抓捕的方式来实现handler，相当于sqlserver中的try catch handler是mysql的自定义异常处理。
定义异常处理语法 DECLARE handler_type HANDLER FOR condition_value sp_statement 语法解析 handler_type：为异常的处理方式，也就是当发生异常时怎么处理，有三个参数 1）exit ，表示遇到异常马上退出 2）continue ，表示遇到异常不处理，继续执行sql代码 3）undo ，mysql不支持，是一个回滚操作 condition_value:表示错误类型 1)SQLSTATE [VALUE] sqlstate_value 为包含5个字符的字符串错误值 2）SQLWARNING 匹配所有以01开头的SQLSTATE错误代码 3）NOT FOUND 匹配所有以02开头的SQLSTATE错误代码 4）SQLEXCEPTION 匹配所有没有被SQLWARNING或NOT FOUND捕获的SQLSTATE错误代码 5）mysql_error_code 匹配数值类型错误代码 condition_name：标志定义错误的名称 异常定义引用：https://www." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/18eae61b307a1d44c8484e852e16b9e3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-11-17T11:19:54+08:00" />
<meta property="article:modified_time" content="2017-11-17T11:19:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql insert插入时实现如果数据表中主键重复则更新，没有重复则插入的四种方法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3 id="mysql-insert插入时实现如果数据表中主键重复则更新没有重复则插入的四种方法"><strong>mysql insert插入时实现如果数据表中主键重复则更新，没有重复则插入的四种方法</strong></h3> 
<pre><code>1、replace语句：替换已有的行
    replace语句是insert语句的一个变种
    当添加新行时
        1）如果主键值重复，那么覆盖表中已有的行
        2）如果没有主键值重复，则插入该行
2、ignore
    insert语句可以使用ignore选项来当insert语句出现错误时，不显示错误信息，但是insert语句不执行。
    insert ignore into 。。。。。    
3、可以采用异常抓捕的方式来实现handler，相当于sqlserver中的try catch
4、如果在INSERT语句末尾指定了ON DUPLICATE KEY UPDATE，并且插入行后会导致在一个UNIQUE索引或PRIMARY KEY中出现重复值，
则在出现重复值的行执行UPDATE；如果不会导致唯一值列重复的问题，则插入新行。
</code></pre> 
<p>四个方法分步解析： <br> 操作表test表结构如下 <br> <img src="https://images2.imgbox.com/12/16/3fhPP4Ec_o.png" alt="这里写图片描述" title=""></p> 
<pre><code>1、replace语法
    select * from test;
</code></pre> 
<p><img src="https://images2.imgbox.com/eb/f4/YlTz68Pq_o.png" alt="这里写图片描述" title=""> <br> 现在插入(1,’xiaohong’)数据，发现出现错误，错误提示（主键重复输入’1’），证明当insert插入相同主键时是会报错的。 <br> <img src="https://images2.imgbox.com/ad/6c/H1XGDy0X_o.png" alt="这里写图片描述" title=""> <br> 现在我们来replace语句测试一下会不会不报错，执行成功 <br> <img src="https://images2.imgbox.com/e6/3d/z8GYyKyR_o.png" alt="这里写图片描述" title=""> <br> 查询一下我们的表信息，发现之前的记录(1,’xiaozhang’)已经被替换成(1,’xiaohong’), <br> 证明我们插入相同的主键信息，replace会替换原有信息。 <br> <img src="https://images2.imgbox.com/45/a2/pJQ6NCOz_o.png" alt="这里写图片描述" title=""> <br> replace语法执行和数据库中主键重复的数据会替换原有信息，那么执行不同的信息会有怎么样的操作呢？（发现执行和数据库中没有主键重复的数据，则执行插入操作） <br> <img src="https://images2.imgbox.com/5f/a8/jomKbdlh_o.png" alt="这里写图片描述" title=""><img src="https://images2.imgbox.com/3b/9b/UluybTJS_o.png" alt="这里写图片描述" title=""></p> 
<p>2、ignore <br> 这里我们应用insert ignore执行插入(1,’xiaoplan’),运行成功，但是数据没有插入到test表中。 <br> <img src="https://images2.imgbox.com/15/b1/D0PptUn2_o.png" alt="这里写图片描述" title=""> <br> <img src="https://images2.imgbox.com/a9/8a/yC0sUCP0_o.png" alt="这里写图片描述" title=""> <br> insert ignore 和update联合使用（发现主键为’1’的’xiaohong’被更新为’xiaolan’） <br> <img src="https://images2.imgbox.com/67/c0/06mJtSR3_o.png" alt="这里写图片描述" title=""> <br> 运行结果图 <br> 3、可以采用异常抓捕的方式来实现handler，相当于sqlserver中的try catch <br> handler是mysql的自定义异常处理。</p> 
<pre><code>        定义异常处理语法
        DECLARE handler_type HANDLER FOR condition_value sp_statement
        语法解析
        handler_type：为异常的处理方式，也就是当发生异常时怎么处理，有三个参数
            1）exit ，表示遇到异常马上退出
            2）continue ，表示遇到异常不处理，继续执行sql代码
            3）undo ，mysql不支持，是一个回滚操作
        condition_value:表示错误类型
            1)SQLSTATE [VALUE] sqlstate_value  为包含5个字符的字符串错误值
            2）SQLWARNING  匹配所有以01开头的SQLSTATE错误代码
            3）NOT FOUND  匹配所有以02开头的SQLSTATE错误代码
            4）SQLEXCEPTION  匹配所有没有被SQLWARNING或NOT FOUND捕获的SQLSTATE错误代码
            5）mysql_error_code  匹配数值类型错误代码
        condition_name：标志定义错误的名称
</code></pre> 
<p>异常定义引用：<a href="https://www.2cto.com/database/201410/341132.html" rel="nofollow">https://www.2cto.com/database/201410/341132.html</a>想深入了解可以查看</p> 
<p>这边我们要实现插入时如果主键重复则更新，主键不重复则插入的效果，所以我们要先了解主键重复的异常是什么，然后抓捕异常，将异常处理类型定义为continue，然后执行我们的update操作 <br> 先找出主键重复错误的异常编号，标号为’1062’ <br> <img src="https://images2.imgbox.com/5a/57/1yOckojP_o.png" alt="这里写图片描述" title=""> <br> 直接上代码</p> 
<pre><code>    drop procedure if exists test;
    create procedure test()         #创建存储过程
    BEGIN
    DECLARE done INT default 0 ;  #定义变量

        #定义主键重复异常发生时将done赋值为1；同时异常的处理方式是continue，异常发生继续执行 
        DECLARE CONTINUE HANDLER for 1062 SET done=1;  

        #执行插入操作，插入过程中可能发生主键重复，如果主键重复那么done被赋值为1
        insert into test(id,name) values(1,'xiaowang'); 

        #如果done的值为1的话，实现更新原有数据
        if done = 1 then 
            update test set name='xiaowang' where id=1;
        end if;
    END
</code></pre> 
<p>执行存储过程后结果截图（各位可以尝试建表操作），功能实现 <br> <img src="https://images2.imgbox.com/10/5f/fnu60mhs_o.png" alt="这里写图片描述" title=""></p> 
<p>4、如果在insert语句末尾指定了on duplicate key update</p> 
<pre><code>insert into test(id,name) values(1,'如来') on duplicate key update name=values(name);      #on duplicate key update 后面加入如果主键重复更新的列和更新的值，这里面更新test表的name列，更新的值是values('如来')，但是要写成values(name).
</code></pre> 
<p>运行截图，实现将已有数据更新的效果 <br> <img src="https://images2.imgbox.com/a0/98/jskGwZxx_o.png" alt="这里写图片描述" title=""> <br> 插入不同数据，如果主键不同，则插入 <br> <img src="https://images2.imgbox.com/70/ca/XHd0mkW7_o.png" alt="这里写图片描述" title=""> <br> 看一下主键相同情况是否可以更新多列，（可以执行） <br> <img src="https://images2.imgbox.com/cd/3d/QG34kCRa_o.png" alt="这里写图片描述" title=""></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a5d5d3c0babbca9c79358ac8d0f3cdbc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">EasyTouch物体的旋转缩放</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7a57229f22dc7e5a49c7baff7dcfa86d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">笔记 rgba属性值</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>