<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>libcurl使用示例 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="libcurl使用示例" />
<meta property="og:description" content="简要说明：C&#43;&#43;使用libcurl访问&#34;www.baidu.com&#34;，获取返回码和打印出http文件
/* * @ libcurl使用示例 * @ 2014.04.29 * @ g&#43;&#43; -o LibCurlFunc LibCurlFunc.cpp -lcurl */ #include &lt;iostream&gt; #include &lt;string.h&gt; #include &lt;curl/curl.h&gt; using namespace std; /* Http请求结束的回调函数 @ 会被调用多次，有下载到数据(http文件)就回调，直到下载完 */ static size_t WriteFunction(void *input, size_t uSize, size_t uCount, void *avg) { /* cout &lt;&lt; &#34;[WriteFunction]:&#34; &lt;&lt; endl &lt;&lt; &#34;input=&#34; &lt;&lt; (char*)input &lt;&lt; endl &lt;&lt; &#34;elementSize=&#34; &lt;&lt; uSize &lt;&lt; endl &lt;&lt; &#34;elementCount=&#34; &lt;&lt; uCount &lt;&lt; endl;*/ // 将请求返回数据input拷贝到avg中(avg为一开始curl_easy_setopt设置的参) size_t uLen = uSize*uCount; // string &amp;sBuffer = *reinterpret_cast&lt;string *&gt;(avg); // sBuffer." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/25b78d7bbb172c61ead3bc4d4a656f4c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2014-04-30T10:49:54+08:00" />
<meta property="article:modified_time" content="2014-04-30T10:49:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">libcurl使用示例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>简要说明：C++使用libcurl访问"www.baidu.com"，获取返回码和打印出http文件</p> 
<p></p> 
<pre><code class="language-cpp">/*
 * @ libcurl使用示例
 * @ 2014.04.29
 * @ g++ -o LibCurlFunc LibCurlFunc.cpp -lcurl
 */
#include &lt;iostream&gt;
#include &lt;string.h&gt;
#include &lt;curl/curl.h&gt;
using namespace std;

/* 
	Http请求结束的回调函数
	@ 会被调用多次，有下载到数据(http文件)就回调，直到下载完
 */
static size_t WriteFunction(void *input, size_t uSize, size_t uCount, void *avg)
{
	/* cout &lt;&lt; "[WriteFunction]:" &lt;&lt; endl
		 &lt;&lt; "input=" &lt;&lt; (char*)input &lt;&lt; endl
		 &lt;&lt; "elementSize=" &lt;&lt; uSize &lt;&lt; endl
		 &lt;&lt; "elementCount=" &lt;&lt; uCount &lt;&lt; endl;*/
		 
	// 将请求返回数据input拷贝到avg中(avg为一开始curl_easy_setopt设置的参)
	size_t uLen = uSize*uCount;
	// string &amp;sBuffer = *reinterpret_cast&lt;string *&gt;(avg);
	// sBuffer.append(reinterpret_cast&lt;const char *&gt;(input), uLen);
	string *pStr = (string *)(avg);
	pStr-&gt;append((char *)(input), uLen);
	
	// 只有返回uSize*uCount才会返回成功
	return uLen;
}

int main()
{
	CURL *pCurl = NULL;
	CURLcode code;
	
	/* CURLcode curl_global_init(long flags)
	   @ 初始化libcurl，全局只需调一次
	   @ flags:	CURL_GLOBAL_DEFAULT 	// 等同于CURL_GLOBAL_ALL 
				CURL_GLOBAL_ALL     	// 初始化所有的可能的调用
				CURL_GLOBAL_SSL     	// 初始化支持安全套接字层
				CURL_GLOBAL_WIN32   	// 初始化win32套接字库
              	CURL_GLOBAL_NOTHING 	// 没有额外的初始化
			    ......
	 */
	code = curl_global_init(CURL_GLOBAL_DEFAULT);
	if (code != CURLE_OK) {
		cout &lt;&lt; "curl_global_init() Err" &lt;&lt; endl;
		return -1;
	}
	
	/* CURL *curl_easy_init()
	   @ 初始化curl生成CURL *curl指针
	 */
	pCurl = curl_easy_init();
	if (pCurl == NULL) {
		cout &lt;&lt; "curl_easy_init() Err" &lt;&lt; endl;
		return -1;
	}
	
	string sUrl = "www.baidu.com";
	curl_slist *pHeaders = NULL;
	string sBuffer;
	
	/* struct curl_slist *curl_slist_append(struct curl_slist * list, const char * string);
	   @ 添加Http消息头
	   @ 属性string：形式为name+": "+contents
	 */
	string header = "username: andyawang";
	pHeaders = curl_slist_append(pHeaders, header.c_str());
	
	/* CURLcode curl_easy_setopt(CURL *handle, CURLoption option, parameter);
	   @ 设置下载属性及常用参数
	 */
	curl_easy_setopt(pCurl, CURLOPT_URL, "www.baidu.com"); 	// 访问的URL
	curl_easy_setopt(pCurl, CURLOPT_HTTPHEADER, pHeaders);  // 属性头部(要不pHeader就没用了)
	curl_easy_setopt(pCurl, CURLOPT_TIMEOUT, 20); 			// 超时(单位S)
	curl_easy_setopt(pCurl, CURLOPT_HEADER, 1); 			// 下载数据包括HTTP头部
	
	curl_easy_setopt(pCurl, CURLOPT_WRITEFUNCTION, &amp;WriteFunction);	// !数据回调函数
	curl_easy_setopt(pCurl, CURLOPT_WRITEDATA, &amp;sBuffer);			// !数据回调函数的参，一般为Buffer或文件fd
	
	/* CURLcode curl_easy_perform(CURL *handle);
	   @ 开始下载
	 */
	code = curl_easy_perform(pCurl);
	if (code != CURLE_OK) {
		cout &lt;&lt; "curl_easy_perform() Err" &lt;&lt; endl;
		return -1;
	}
	
	/* CURLcode curl_easy_getinfo(CURL *curl, CURLINFO info, ... );
	   @ 获取下载完的相关信息
	   @ info：CURLINFO_RESPONSE_CODE  	// 获取返回的Http码
			   CURLINFO_TOTAL_TIME  	// 获取总的请求下载时间
			   CURLINFO_SIZE_DOWNLOAD  	// 获取下载的文件大小
			   ......
	 */
	long retCode = 0;
	code = curl_easy_getinfo(pCurl, CURLINFO_RESPONSE_CODE , &amp;retCode); 
	if (code != CURLE_OK) {
		cout &lt;&lt; "curl_easy_perform() Err" &lt;&lt; endl;
		return -1;
	}
	cout &lt;&lt; "[Http Return Code] : " &lt;&lt; retCode &lt;&lt; endl;
	cout &lt;&lt; "[Http Context] : " &lt;&lt; endl &lt;&lt; sBuffer &lt;&lt; endl;
	
	/* void curl_easy_cleanup(CURL * handle);
	   @ 释放CURL *curl指针
	 */		
	curl_easy_cleanup(pCurl);
	
	/* void curl_global_cleanup(void);
	   @ 初始化libcurl，全局也只需调一次
	 */		
	curl_global_cleanup();
}</code></pre> 
<p>运行结果：</p> 
<p></p> 
<pre><code class="language-cpp">gapp_devnet_1:/data/home/andyawang/code/Components/Http # g++ -o LibCurlFunc LibCurlFunc.cpp -lcurl
gapp_devnet_1:/data/home/andyawang/code/Components/Http # ./LibCurlFunc 
[Http Return Code] : 200
[Http Context] : 
HTTP/1.0 200 OK
Date: Wed, 30 Apr 2014 02:41:35 GMT
Content-Type: text/html; charset=utf-8
Vary: Accept-Encoding
Set-Cookie: BAIDUID=8DD8F93E631536AD6CDC010E1A52507C:FG=1; expires=Thu, 31-Dec-37 23:55:55 GMT; max-age=2147483647; path=/; domain=.baidu.com
Set-Cookie: BDSVRTM=0; path=/
Set-Cookie: H_PS_PSSID=5695_1428_5225_6024_4760_6018_6256_6311_6269; path=/; domain=.baidu.com
P3P: CP=" OTI DSP COR IVA OUR IND COM "
Cache-Control: private
Expires: Wed, 30 Apr 2014 02:41:33 GMT
X-Powered-By: HPHP
Server: BWS/1.1
BDPAGETYPE: 1
BDQID: 0x9fcc512a0001374f
BDUSERID: 0
X-Cache: MISS from qplus_wanproxy_pub_fy1
Via: 1.0 qplus_wanproxy_pub_fy1 (squid/3.1.18)
Connection: close

&lt;!DOCTYPE html&gt;&lt;!--STATUS OK--&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv="content-type" content="text/html;charset=utf-8"&gt;&lt;link rel="dns-prefetch" href="//s1.bdstatic.com"/&gt;&lt;link rel="dns-prefetch" href="//t1.baidu.com"/&gt;&lt;link rel="dns-prefetch" href="//t2.baidu.com"/&gt;&lt;link rel="dns-prefetch" href="//t3.baidu.com"/&gt;&lt;link rel="dns-prefetch" href="//t10.baidu.com"/&gt;&lt;link rel="dns-prefetch" href="//t11.baidu.com"/&gt;&lt;link rel="dns-prefetch" href="//t12.baidu.com"/&gt;&lt;title&gt;百度一下，你就知道&lt;/title&gt;&lt;style &gt;html,body{height:100%}html{overflow-y:auto}#wrapper{position:relative;_position:;min-height:100%}#content{padding-bottom:100px;text-align:center}#ftCon{height:100px;position:absolute;bottom:44px;text-align:center;width:100%;margin:0 auto;
......</code></pre> 
<br> 
<br> 
<p></p> 
<p><br> </p> 
<p></p> 
<p><br> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/77920b7937fc48a1c1563c8fbeedbaf8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">用pygame写个简单的贪吃蛇游戏</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/23a306b50e20473778736596ca4e4d43/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CSS网模板</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>