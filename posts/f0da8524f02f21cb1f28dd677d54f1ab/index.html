<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Fluid Engine Development PIC/FLIP 代码分析 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Fluid Engine Development PIC/FLIP 代码分析" />
<meta property="og:description" content="目录 AnimationPhysicsAnimation初始化固定子步骤数量自适应子步骤数量 GridFluidSolver3初始化步进 求解框架前处理 后处理外部力粘性力 压力平流自适应子步骤数量SDF边界条件外插Grid 的尺寸 Builder构造函数 AdvectionSolverSemiLagrangianforEachIndex parallelForEachIndexsampler GridDiffusionSolverGridForwardEulerDiffusionSolverGridBackwardEulerDiffusionSolver系数矩阵的意义邻居数量 k边界条件系数矩阵的非对角线元素 迭代算法雅可比高斯赛德尔 GridPressureSolverGridSinglePhasePressureSolverGridFractionalSinglePhasePressureSolverA Fast Variational Framework for Accurate Solid-Fluid Coupling基于最小化动能的观点来解释速度投影由动能最小化推出泊松方程边界处压强的计算？ GridBoundaryConditionSolverPicSolver构造函数onBeginAdvanceTimeStepupdateParticleEmittertransferFromParticlesToGridsbuildSignedDistanceField computeAdvection FlipSolvertransferFromParticlesToGridstransferFromGridsToParticles 把 Fluid Engine Development 看完了，但是仍然感觉不懂
https://github.com/doyubkim/fluid-engine-dev
感觉还是应该了解整体代码怎么写的，所以做个总结
看着看着，感觉还是从底层开始看起
从底层重新开始看的时候，感觉就来了
而且作者也有很多注释，感觉能够体会到别人的思路
他这里也有很多内容，我选择从 PIC/FLIP 开始看起
然后我选择它的 hybrid_liquid_sim 工程
它的 main 文件就很容易找到了，在 src\examples\hybrid_liquid_sim\main.cpp
Animation Animation 类里面提供了 update 函数，update 函数里面调用了虚函数 onUpdate
虚函数 onUpdate 用于给子类提供具体的实现的
这就完成了第一层的抽象，就是把所有的动画都视为一个可以随时间更新的东西
那么我们用户统一地使用 update 函数去更新它
具体怎么更新，那就是程序员怎么在子类中实现虚函数 onUpdate 的事情了
也就是下层（怎么实现虚函数 onUpdate）对上层（用户调用 update）透明
例如，在 src\examples\hybrid_liquid_sim\main.cpp 中，有不同的求解器和情景可供选择，PIC，FLIP，APIC 等
最后这些求解器都进入函数 runSimulation，在其中，求解器的更新都是只需要一句 solver-&gt;update(frame);" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/f0da8524f02f21cb1f28dd677d54f1ab/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-28T23:58:41+08:00" />
<meta property="article:modified_time" content="2024-01-28T23:58:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Fluid Engine Development PIC/FLIP 代码分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#Animation_20" rel="nofollow">Animation</a></li><li><a href="#PhysicsAnimation_40" rel="nofollow">PhysicsAnimation</a></li><li><ul><li><a href="#_57" rel="nofollow">初始化</a></li><li><a href="#_95" rel="nofollow">固定子步骤数量</a></li><li><a href="#_116" rel="nofollow">自适应子步骤数量</a></li></ul> 
   </li><li><a href="#GridFluidSolver3_147" rel="nofollow">GridFluidSolver3</a></li><li><ul><li><a href="#_155" rel="nofollow">初始化</a></li><li><a href="#__178" rel="nofollow">步进 求解框架</a></li><li><a href="#__193" rel="nofollow">前处理 后处理</a></li><li><a href="#_220" rel="nofollow">外部力</a></li><li><a href="#__261" rel="nofollow">粘性力 压力</a></li><li><a href="#_267" rel="nofollow">平流</a></li><li><a href="#_301" rel="nofollow">自适应子步骤数量</a></li><li><a href="#SDF_311" rel="nofollow">SDF</a></li><li><a href="#_319" rel="nofollow">边界条件</a></li><li><ul><li><a href="#_321" rel="nofollow">外插</a></li><li><a href="#Grid__361" rel="nofollow">Grid 的尺寸</a></li></ul> 
    </li><li><a href="#Builder_429" rel="nofollow">Builder</a></li><li><a href="#_451" rel="nofollow">构造函数</a></li></ul> 
   </li><li><a href="#AdvectionSolver_474" rel="nofollow">AdvectionSolver</a></li><li><ul><li><a href="#SemiLagrangian_488" rel="nofollow">SemiLagrangian</a></li><li><a href="#forEachIndex_parallelForEachIndex_552" rel="nofollow">forEachIndex parallelForEachIndex</a></li><li><a href="#sampler_608" rel="nofollow">sampler</a></li></ul> 
   </li><li><a href="#GridDiffusionSolver_636" rel="nofollow">GridDiffusionSolver</a></li><li><ul><li><a href="#GridForwardEulerDiffusionSolver_640" rel="nofollow">GridForwardEulerDiffusionSolver</a></li><li><a href="#GridBackwardEulerDiffusionSolver_674" rel="nofollow">GridBackwardEulerDiffusionSolver</a></li><li><ul><li><a href="#_726" rel="nofollow">系数矩阵的意义</a></li><li><a href="#_k_783" rel="nofollow">邻居数量 k</a></li><li><a href="#_902" rel="nofollow">边界条件</a></li><li><a href="#_1016" rel="nofollow">系数矩阵的非对角线元素</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_1059" rel="nofollow">迭代算法</a></li><li><ul><li><a href="#_1063" rel="nofollow">雅可比</a></li><li><a href="#_1111" rel="nofollow">高斯赛德尔</a></li></ul> 
   </li><li><a href="#GridPressureSolver_1148" rel="nofollow">GridPressureSolver</a></li><li><ul><li><a href="#GridSinglePhasePressureSolver_1158" rel="nofollow">GridSinglePhasePressureSolver</a></li><li><a href="#GridFractionalSinglePhasePressureSolver_1219" rel="nofollow">GridFractionalSinglePhasePressureSolver</a></li><li><a href="#A_Fast_Variational_Framework_for_Accurate_SolidFluid_Coupling_1241" rel="nofollow">A Fast Variational Framework for Accurate Solid-Fluid Coupling</a></li><li><ul><li><a href="#_1245" rel="nofollow">基于最小化动能的观点来解释速度投影</a></li><li><a href="#_1257" rel="nofollow">由动能最小化推出泊松方程</a></li><li><a href="#_1347" rel="nofollow">边界处压强的计算？</a></li></ul> 
   </li></ul> 
   </li><li><a href="#GridBoundaryConditionSolver_1441" rel="nofollow">GridBoundaryConditionSolver</a></li><li><a href="#PicSolver_1611" rel="nofollow">PicSolver</a></li><li><ul><li><a href="#_1613" rel="nofollow">构造函数</a></li><li><a href="#onBeginAdvanceTimeStep_1625" rel="nofollow">onBeginAdvanceTimeStep</a></li><li><ul><li><a href="#updateParticleEmitter_1646" rel="nofollow">updateParticleEmitter</a></li><li><a href="#transferFromParticlesToGrids_1656" rel="nofollow">transferFromParticlesToGrids</a></li><li><a href="#buildSignedDistanceField_1773" rel="nofollow">buildSignedDistanceField</a></li></ul> 
    </li><li><a href="#computeAdvection_1806" rel="nofollow">computeAdvection</a></li></ul> 
   </li><li><a href="#FlipSolver_1875" rel="nofollow">FlipSolver</a></li><li><ul><li><a href="#transferFromParticlesToGrids_1886" rel="nofollow">transferFromParticlesToGrids</a></li><li><a href="#transferFromGridsToParticles_1890" rel="nofollow">transferFromGridsToParticles</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>把 Fluid Engine Development 看完了，但是仍然感觉不懂</p> 
<p><a href="https://github.com/doyubkim/fluid-engine-dev">https://github.com/doyubkim/fluid-engine-dev</a></p> 
<p>感觉还是应该了解整体代码怎么写的，所以做个总结</p> 
<p>看着看着，感觉还是从底层开始看起</p> 
<p>从底层重新开始看的时候，感觉就来了</p> 
<p>而且作者也有很多注释，感觉能够体会到别人的思路</p> 
<p>他这里也有很多内容，我选择从 PIC/FLIP 开始看起</p> 
<p>然后我选择它的 hybrid_liquid_sim 工程</p> 
<p>它的 main 文件就很容易找到了，在 src\examples\hybrid_liquid_sim\main.cpp</p> 
<h3><a id="Animation_20"></a>Animation</h3> 
<p>Animation 类里面提供了 <code>update</code> 函数，<code>update</code> 函数里面调用了虚函数 <code>onUpdate</code></p> 
<p>虚函数 <code>onUpdate</code> 用于给子类提供具体的实现的</p> 
<p>这就完成了第一层的抽象，就是把所有的动画都视为一个可以随时间更新的东西</p> 
<p>那么我们用户统一地使用 <code>update</code> 函数去更新它</p> 
<p>具体怎么更新，那就是程序员怎么在子类中实现虚函数 <code>onUpdate</code> 的事情了</p> 
<p>也就是下层（怎么实现虚函数 <code>onUpdate</code>）对上层（用户调用 <code>update</code>）透明</p> 
<p>例如，在 src\examples\hybrid_liquid_sim\main.cpp 中，有不同的求解器和情景可供选择，PIC，FLIP，APIC 等</p> 
<p>最后这些求解器都进入函数 <code>runSimulation</code>，在其中，求解器的更新都是只需要一句 <code>solver-&gt;update(frame);</code></p> 
<p>就很优雅</p> 
<h3><a id="PhysicsAnimation_40"></a>PhysicsAnimation</h3> 
<p>继承 Animation</p> 
<p>这个类主要实现了把某一帧拆分成若干个子步骤的功能</p> 
<p>具体实现方法就是它 final 重写了虚函数 <code>onUpdate</code>，限定死了怎么处理某一个帧的</p> 
<p>因为他一定要保证他自己这个拆分子步骤的功能嘛，所以是 final</p> 
<p>具体内容就是，只有帧数实参大于类中存储的当前帧号时，才说明这个类要沿时间推进</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span>index <span class="token operator">&gt;</span> _currentFrame<span class="token punctuation">.</span>index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h4><a id="_57"></a>初始化</h4> 
<p>推进的具体办法是，帧号 &lt; 0 时调用函数 <code>initialize</code> 进行初始化，</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>_currentFrame<span class="token punctuation">.</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>这里涉及到了初始化函数，是因为初始化函数的调用跟帧号有关，所以必须在这里给一个钩子，才能在这个正确的时间调用初始化</p> 
<p>每个算法的初始化肯定是不一样的，所以如果我们对初始化的时间没有要求的话，我们肯定不用这么麻烦，但是就是因为他是跟帧号相关，所以才要提早到这里</p> 
<p>那么自然地，这个初始化函数应该是一个虚函数</p> 
<p>但是它这里的 <code>initialize</code> 还不是虚函数。反而，<code>initialize</code> 里面调用了虚函数 <code>onInitialize</code>，它的设计是让子类去重写这个虚函数</p> 
<p>可能这是它自己的设计哲学吧，没懂为什么要额外一层</p> 
<p>如果不用初始化，那么就统计要前进的帧数，对每一帧都调用 <code>advanceTimeStep</code>。也就是说，对于每一帧，都尝试拆分子步骤</p> 
<p>其实这个函数名和 update 也很像，其实不用纠结，他就是为了完成拆分子步骤</p> 
<pre><code class="prism language-cpp"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">int32_t</span> numberOfFrames <span class="token operator">=</span> frame<span class="token punctuation">.</span>index <span class="token operator">-</span> _currentFrame<span class="token punctuation">.</span>index<span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numberOfFrames<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">advanceTimeStep</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>timeIntervalInSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

_currentFrame <span class="token operator">=</span> frame<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_95"></a>固定子步骤数量</h4> 
<p>具体他是怎么实现拆分子步骤的呢？也很简单</p> 
<p>如果你设置了固定子步骤数量 n，那么就把这帧的时间平均分为 frame time/n 份，对每份都执行虚函数 <code>onAdvanceTimeStep</code> 也就是相当于把实际每一步的流体求解又推迟到这个 <code>onAdvanceTimeStep</code> 函数中了</p> 
<pre><code class="prism language-cpp"><span class="token keyword">const</span> <span class="token keyword">double</span> actualTimeInterval <span class="token operator">=</span>
    timeIntervalInSeconds <span class="token operator">/</span>
    <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>_numberOfFixedSubTimeSteps<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _numberOfFixedSubTimeSteps<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">onAdvanceTimeStep</span><span class="token punctuation">(</span>actualTimeInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _currentTime <span class="token operator">+=</span> actualTimeInterval<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>为什么说是推迟呢？想象一下如果我们始终不知道要拆分子步骤这件事，那么流体求解部分应该在子类中重写 <code>Animation</code> 类的虚函数 <code>onUpdate</code></p> 
<p>但是现在的话，我们的流体求解部分要放到在 <code>PhysicsAnimation</code> 的子类对虚函数 <code>onAdvanceTimeStep</code> 的重写中了，所以是，我觉得这就像推迟了一个函数</p> 
<h4><a id="_116"></a>自适应子步骤数量</h4> 
<p>如果你没有设置固定子步骤数量，那就是你要是用自适应子步骤数量。但是自适应算法应该是有不同的实现的，所以这里给出一个虚函数 <code>numberOfSubTimeSteps</code> 允许子类实现这个自适应的算法</p> 
<p>虚函数 <code>numberOfSubTimeSteps</code> 接受剩余的时间作为参数，这应该是自适应算法的常规输入吧</p> 
<p>获取了自适应的子步骤数量 n 之后，当前子步骤的时间步是 remaining time/n</p> 
<p>剩余的时间 remaining time 最初是 frame time</p> 
<p>执行了一步之后是 remaining time -= remaining time/n</p> 
<p>执行完一步之后，下一次将 remaining time 输入到虚函数 <code>numberOfSubTimeSteps</code> 获得下次的子步骤数量 n2，下一次的子步骤的时间步就是 remaining time/n2</p> 
<p>所以每一个子步骤的时间步可能是不一样的</p> 
<pre><code class="prism language-cpp"><span class="token keyword">double</span> remainingTime <span class="token operator">=</span> timeIntervalInSeconds<span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>remainingTime <span class="token operator">&gt;</span> kEpsilonD<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> numSteps <span class="token operator">=</span> <span class="token function">numberOfSubTimeSteps</span><span class="token punctuation">(</span>remainingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> actualTimeInterval <span class="token operator">=</span>
        remainingTime <span class="token operator">/</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>numSteps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token function">onAdvanceTimeStep</span><span class="token punctuation">(</span>actualTimeInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>

    remainingTime <span class="token operator">-=</span> actualTimeInterval<span class="token punctuation">;</span>
    _currentTime <span class="token operator">+=</span> actualTimeInterval<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h3><a id="GridFluidSolver3_147"></a>GridFluidSolver3</h3> 
<p>这里开始加入了很多东西</p> 
<p>我觉得应该从他对虚函数的重写开始看起</p> 
<p>其他的他自己定义的函数，看上去像是为了实现它对虚函数的重写中的逻辑，而创建的</p> 
<h4><a id="_155"></a>初始化</h4> 
<p>初始化函数中，要初始化边界条件，边界条件就包括了碰撞体和粒子发射器</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">GridFluidSolver3</span><span class="token operator">::</span><span class="token function">onInitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">updateCollider</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">updateEmitter</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这两个更新函数，就很简单，就是调用各自的 <code>update</code> 而已</p> 
<pre><code class="prism language-cpp">_collider<span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
_emitter<span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我觉得具体的可以之后再看，比如碰撞体那部分的类是怎么样的</p> 
<p>还是回到 <code>GridFluidSolver3</code></p> 
<p>对初始化函数的重写就是这些了，那么下一个是步进函数，对虚函数 <code>onAdvanceTimeStep</code> 的重写</p> 
<h4><a id="__178"></a>步进 求解框架</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">GridFluidSolver3</span><span class="token operator">::</span><span class="token function">onAdvanceTimeStep</span><span class="token punctuation">(</span><span class="token keyword">double</span> timeIntervalInSeconds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">beginAdvanceTimeStep</span><span class="token punctuation">(</span>timeIntervalInSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">computeExternalForces</span><span class="token punctuation">(</span>timeIntervalInSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">computeViscosity</span><span class="token punctuation">(</span>timeIntervalInSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">computePressure</span><span class="token punctuation">(</span>timeIntervalInSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">computeAdvection</span><span class="token punctuation">(</span>timeIntervalInSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">endAdvanceTimeStep</span><span class="token punctuation">(</span>timeIntervalInSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>	
</code></pre> 
<p>这个结构就很清晰，这就是求解 NS 方程要做的事情</p> 
<h4><a id="__193"></a>前处理 后处理</h4> 
<p>前后的 <code>beginAdvanceTimeStep</code> <code>endAdvanceTimeStep</code> 分别包括了对虚函数 <code>onBeginAdvanceTimeStep</code> <code>onEndAdvanceTimeStep</code> 的调用，为更具体的流体算法子类提供虚函数接口</p> 
<p>额外的是，<code>beginAdvanceTimeStep</code> 里面还有更新碰撞体和发射器，然后还要调用 <code>GridBoundaryConditionSolver</code> 的更新 <code>updateCollider</code> 和速度约束函数 <code>constrainVelocity</code></p> 
<p>当你想要看一下这个 <code>GridBoundaryConditionSolver</code> 是啥的时候，跳到定义，你就会看到他是又是一个类的指针，顺便也看到求解平流、扩散（粘性力）、压力的方法也是调用别的类的指针</p> 
<pre><code class="prism language-cpp">AdvectionSolver3Ptr _advectionSolver<span class="token punctuation">;</span>
GridDiffusionSolver3Ptr _diffusionSolver<span class="token punctuation">;</span>
GridPressureSolver3Ptr _pressureSolver<span class="token punctuation">;</span>
GridBoundaryConditionSolver3Ptr _boundaryConditionSolver<span class="token punctuation">;</span>
</code></pre> 
<p>这和碰撞体和发射器也是一样的</p> 
<pre><code class="prism language-cpp">GridSystemData3Ptr _grids<span class="token punctuation">;</span>
Collider3Ptr _collider<span class="token punctuation">;</span>
GridEmitter3Ptr _emitter<span class="token punctuation">;</span>
</code></pre> 
<p>所以现在对于 <code>GridFluidSolver3</code> 就有一个大概的印象了，它定义了求解 NS 方程的大概框架，分解了求解步骤（外部力、粘性力、压力）但是在每个力的具体计算，实际上还是依赖更进一步的定义。这通过提供工具类的示例来实现。比如确定怎么求解压力的话，需要给 <code>GridPressureSolver3Ptr _pressureSolver</code> 赋值。或者说这是一种依赖注入的思路。</p> 
<blockquote> 
 <p>有点突然理解了依赖注入！主要是，概念很容易理解，就是调用方需要的东西，由别人来提供。主要是我觉得我似乎理解了为什么要这么做，为什么调用方要的东西要别人来给？因为调用方只知道算法流程，但是具体怎么实现还是要看子类的，或者别的类之类……？总之就是有种老板提方案员工负责执行的感觉</p> 
</blockquote> 
<h4><a id="_220"></a>外部力</h4> 
<p>然后是 <code>computeExternalForces</code>。里面只有一个处理重力的函数 <code>computeGravity</code></p> 
<p>这个函数是第一个涉及到具体怎么计算物理量的函数</p> 
<p>因为所有的变量都是 auto，所以理论上应该不用管类型也很容易理解代码</p> 
<p>实际上也是这样的，获取速度场，从速度场获取访问器</p> 
<p>速度场是有一个遍历所有元素的函数 <code>forEachUIndex</code>，这个函数可以输入一个 lambda 函数，在这个匿名函数里，访问器就相当于物理量，用它来实现物理公式就好了</p> 
<pre><code class="prism language-cpp"><span class="token keyword">auto</span> vel <span class="token operator">=</span> _grids<span class="token operator">-&gt;</span><span class="token function">velocity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">auto</span> u <span class="token operator">=</span> vel<span class="token operator">-&gt;</span><span class="token function">uAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">auto</span> v <span class="token operator">=</span> vel<span class="token operator">-&gt;</span><span class="token function">vAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">auto</span> w <span class="token operator">=</span> vel<span class="token operator">-&gt;</span><span class="token function">wAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vel<span class="token operator">-&gt;</span><span class="token function">forEachUIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">u</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+=</span> timeIntervalInSeconds <span class="token operator">*</span> _gravity<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vel<span class="token operator">-&gt;</span><span class="token function">forEachVIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">v</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+=</span> timeIntervalInSeconds <span class="token operator">*</span> _gravity<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vel<span class="token operator">-&gt;</span><span class="token function">forEachWIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">w</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+=</span> timeIntervalInSeconds <span class="token operator">*</span> _gravity<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>这里确实是需要知道一下“场”这个类的概念，才有这种直观的认识。但是既然都过了一遍书本了，基本的印象还是有的。</p> 
<p>然后就是要调用一下 <code>applyBoundaryCondition</code> 函数</p> 
<p>观察发现，其他计算力的函数后面都有这个</p> 
<p>因为 <code>applyBoundaryCondition</code> 里面是使用约束的那个工具类来约束速度，所以我们可以知道它的设计目的就是，每一次更新速度之后，都要约束一下速度。</p> 
<h4><a id="__261"></a>粘性力 压力</h4> 
<p>在 <code>computeViscosity</code> 和 <code>computePressure</code> 里面，单纯是对 <code>_diffusionSolver</code> 和 <code>_pressureSolver</code> 的 <code>solve</code> 调用</p> 
<p>那么它的设计目的就是，粘性力和压力的计算也是根据具体算法来的</p> 
<h4><a id="_267"></a>平流</h4> 
<p>在 <code>computeAdvection</code> 也是单纯对各个变量的 <code>solve</code> 的调用</p> 
<p>他看上去复杂，只是因为他要考虑所有标量，所有定义在网格中心的向量 <code>CollocatedVectorGrid3</code> 和定义在网格面上的向量 <code>FaceCenteredGrid3</code></p> 
<p>它把所有向量场都保存在一个列表中，以向量场的基类保存，所以你在遍历这个列表的时候不知道每个元素是 <code>CollocatedVectorGrid3</code> 还是 <code>FaceCenteredGrid3</code>，所以他这里做了两次 cast，把指向基类的指针 cast 到指向子类的指针，指针不为 null 表示这个示例确实是这个子类。</p> 
<p>那么现在对这两个子类有不同的处理情况，平流求解器 <code>_advectionSolver</code> 是需要知道场的类型的（表现在函数重载上），但是我们可以把这两种处理情况串行写在一起。因为如果是子类 A 就不会是子类 B，所以实际上只会执行其中一个</p> 
<pre><code class="prism language-cpp"><span class="token keyword">auto</span> collocated <span class="token operator">=</span>
    std<span class="token operator">::</span>dynamic_pointer_cast<span class="token operator">&lt;</span>CollocatedVectorGrid3<span class="token operator">&gt;</span><span class="token punctuation">(</span>grid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">auto</span> collocated0 <span class="token operator">=</span>
    std<span class="token operator">::</span>dynamic_pointer_cast<span class="token operator">&lt;</span>CollocatedVectorGrid3<span class="token operator">&gt;</span><span class="token punctuation">(</span>grid0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>collocated <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _advectionSolver<span class="token operator">-&gt;</span><span class="token function">advect</span><span class="token punctuation">(</span><span class="token operator">*</span>collocated0<span class="token punctuation">,</span> <span class="token operator">*</span>vel<span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">auto</span> faceCentered <span class="token operator">=</span>
    std<span class="token operator">::</span>dynamic_pointer_cast<span class="token operator">&lt;</span>FaceCenteredGrid3<span class="token operator">&gt;</span><span class="token punctuation">(</span>grid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">auto</span> faceCentered0 <span class="token operator">=</span>
    std<span class="token operator">::</span>dynamic_pointer_cast<span class="token operator">&lt;</span>FaceCenteredGrid3<span class="token operator">&gt;</span><span class="token punctuation">(</span>grid0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>faceCentered <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> faceCentered0 <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _advectionSolver<span class="token operator">-&gt;</span><span class="token function">advect</span><span class="token punctuation">(</span><span class="token operator">*</span>faceCentered0<span class="token punctuation">,</span> <span class="token operator">*</span>vel<span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后还有速度要平流自己</p> 
<p>这里还有另外一个设计就是，如果更新了速度，比如这里平流了速度，那么之后就要跟上对速度的约束 <code>applyBoundaryCondition</code>；如果是更新了标量场或者是向量场，那么之后就要跟上对这个场的外插 <code>extrapolateIntoCollider</code>，这都是为了保证每一步之后，每个场，包括标量场、向量场、速度场都是正确的（不是指没有耗散，我指的是，逻辑上是正确的，更新后的值，不会出现那种新值与旧值并存的情况）</p> 
<h4><a id="_301"></a>自适应子步骤数量</h4> 
<p>这里的逻辑也很简单，就是算当前的 CFL 条件数</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          max 
         
        
          ⁡ 
         
        
          V 
         
        
          ) 
         
        
          Δ 
         
        
          t 
         
        
          / 
         
        
          Δ 
         
        
          x 
         
        
       
         (\max{V})\Delta t/\Delta x 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mop">max</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.2222em;">V</span></span><span class="mclose">)</span><span class="mord">Δ</span><span class="mord mathnormal">t</span><span class="mord">/Δ</span><span class="mord mathnormal">x</span></span></span></span></span></span></p> 
<p>这个东西最直观的意义就是速度最快的粒子单位时间走过的格子的数量，希望他不要太大</p> 
<p>所以如果他太大的话，就用一个约定的最大值去除，比如你速度最大会走 10 个格子，但是我约定只能走 5 个，所以我就拆成两个子步骤</p> 
<h4><a id="SDF_311"></a>SDF</h4> 
<p>传给 <code>_diffusionSolver</code> <code>_pressureSolver</code> <code>_advectionSolver</code> 的碰撞体的 SDF 和碰撞体的速度都是从边界条件工具类 <code>_boundaryConditionSolver</code> 中得来</p> 
<p>也就是这个工具类来负责</p> 
<p>而流体的 SDF，在这个 <code>GridFluidSolver3</code> 里面是调用了一个虚函数 <code>fluidSdf</code> 这表示子类来负责流体的 SDF 怎么算</p> 
<h4><a id="_319"></a>边界条件</h4> 
<h5><a id="_321"></a>外插</h5> 
<p>边界条件这里的怎么约束速度的方法在工具类里面，暂时看不到</p> 
<p>但是将值外推到边界外的方法 <code>extrapolateIntoCollider</code> 在这里定义</p> 
<p>它定义了三个重载，分别处理不同类型的值，<code>ScalarGrid3</code> <code>CollocatedVectorGrid3</code> <code>FaceCenteredGrid3</code> 的</p> 
<p>三种情况的逻辑都是一样的，新建一个标记数组 <code>marker</code>，它的大小和要外插值的网格的大小相当</p> 
<p>然后对每一个格子，都基于碰撞体的 SDF 判断这个点在不在碰撞体内，将结果记入 <code>marker</code></p> 
<p>然后得到的 <code>marker</code> 和要插值的值都输入到函数 <code>extrapolateToRegion</code> 中，这是一个更一般的工具函数。因为 <code>marker</code> 一旦构建了，他就可以表示任意边界，不一定是碰撞体的边界，还可以是流体的边界等等，所以需要这么一个工具函数</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">GridFluidSolver3</span><span class="token operator">::</span><span class="token function">extrapolateIntoCollider</span><span class="token punctuation">(</span>CollocatedVectorGrid3<span class="token operator">*</span> grid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Array3<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">&gt;</span> <span class="token function">marker</span><span class="token punctuation">(</span>grid<span class="token operator">-&gt;</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> pos <span class="token operator">=</span> grid<span class="token operator">-&gt;</span><span class="token function">dataPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    marker<span class="token punctuation">.</span><span class="token function">parallelForEachIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInsideSdf</span><span class="token punctuation">(</span><span class="token function">colliderSdf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">sample</span><span class="token punctuation">(</span><span class="token function">pos</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">marker</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">marker</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> depth <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">ceil</span><span class="token punctuation">(</span>_maxCfl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">extrapolateToRegion</span><span class="token punctuation">(</span>grid<span class="token operator">-&gt;</span><span class="token function">constDataAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> marker<span class="token punctuation">,</span> depth<span class="token punctuation">,</span>
                        grid<span class="token operator">-&gt;</span><span class="token function">dataAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在这个工具函数中，指定迭代次数</p> 
<p>每一次迭代，都遍历 marker 中的所有元素，对于那些 flag 为 0 的位置，尝试从他上下左右前后 6 个邻居中找 flag 为 1 的元素，如果找到了就把邻居的值统计平均赋给当前位置，并且置当前位置的 flag 为 1</p> 
<p>这样的话，刚好在边界外一格远的位置，有可能获得插值，如果是在边界外很远的地方，它的邻居都不在边界内，那么这次迭代之后他依然也不会获得插值</p> 
<p>也就是，每一次迭代，都会把边界整体往外拓展一格（如果空间允许的话）</p> 
<h5><a id="Grid__361"></a>Grid 的尺寸</h5> 
<p>现在我们看完了 <code>extrapolateToRegion</code>。我们知道了 <code>extrapolateToRegion</code> 只需要知道怎么访问数据就行了，也就是得到 <code>dataAccessor</code> 就行了，<code>dataAccessor</code> 的类型与 <code>ScalarGrid3</code> <code>CollocatedVectorGrid3</code> <code>FaceCenteredGrid3</code> 无关，那么这里为什么要分三种情况呢</p> 
<p>因为实际上不同类型的 Grid 的尺寸是不一样的，而获取正确的 <code>dataAccessor</code> 需要 <code>Array</code> 具有正确的尺寸</p> 
<p>这里展示不同的类定义了不同的尺寸的 getter</p> 
<pre><code class="prism language-cpp">Size3 <span class="token class-name">CellCenteredScalarGrid3</span><span class="token operator">::</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// The size of the data should be the same as the grid resolution.</span>
    <span class="token keyword">return</span> <span class="token function">resolution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Size3 <span class="token class-name">VertexCenteredScalarGrid3</span><span class="token operator">::</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">resolution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">Size3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">resolution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">Size3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">Size3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>怎么从这个 getter 到实际存储数据的类的尺寸？</p> 
<p>查找 <code>dataSize</code> 的引用，发现它在 <code>onResize</code> 中被用到，并且这个函数是在 <code>CollocatedVectorGrid3</code> 中被定义的</p> 
<p>进一步发现这个 <code>onResize</code> 是 <code>CollocatedVectorGrid3</code> <code>FaceCenteredGrid3</code> 这一个层级的</p> 
<p>对比就发现，这两个类的区别就在于 <code>CollocatedVectorGrid3</code> 是直接定义一个 Vector 作为 data 了，但是 <code>FaceCenteredGrid3</code> 因为把速度的不同分量定义在不同的面，所以现在速度的不同分量的位置不同了，就不能组成一个 vector 了（组成 vector 就说明三个分量在同一个位置）所以速度要存在三个不同的数组里面</p> 
<p>所以 <code>CollocatedVectorGrid3</code> 就只用 <code>resize</code> 一个数组，而 <code>FaceCenteredGrid3</code> 需要 <code>resize</code> 三个数组</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">CollocatedVectorGrid3</span><span class="token operator">::</span><span class="token function">onResize</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> Size3<span class="token operator">&amp;</span> resolution<span class="token punctuation">,</span>
    <span class="token keyword">const</span> Vector3D<span class="token operator">&amp;</span> gridSpacing<span class="token punctuation">,</span>
    <span class="token keyword">const</span> Vector3D<span class="token operator">&amp;</span> origin<span class="token punctuation">,</span>
    <span class="token keyword">const</span> Vector3D<span class="token operator">&amp;</span> initialValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _data<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initialValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">FaceCenteredGrid3</span><span class="token operator">::</span><span class="token function">onResize</span><span class="token punctuation">(</span><span class="token keyword">const</span> Size3<span class="token operator">&amp;</span> resolution<span class="token punctuation">,</span>
                                 <span class="token keyword">const</span> Vector3D<span class="token operator">&amp;</span> gridSpacing<span class="token punctuation">,</span>
                                 <span class="token keyword">const</span> Vector3D<span class="token operator">&amp;</span> origin<span class="token punctuation">,</span>
                                 <span class="token keyword">const</span> Vector3D<span class="token operator">&amp;</span> initialValue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolution <span class="token operator">!=</span> <span class="token function">Size3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _dataU<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>resolution <span class="token operator">+</span> <span class="token function">Size3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initialValue<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _dataV<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>resolution <span class="token operator">+</span> <span class="token function">Size3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initialValue<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _dataW<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>resolution <span class="token operator">+</span> <span class="token function">Size3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initialValue<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        _dataU<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token function">Size3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _dataV<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token function">Size3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _dataW<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token function">Size3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>这里可能一开始有点陌生，因为我们是顺着 solver 看过来的，没有从数据结构看过来，所以对数据结构可能有点陌生，但是看过了书的话应该有点印象</p> 
</blockquote> 
<p><code>CollocatedVectorGrid3</code> 和 <code>FaceCenteredGrid3</code> 的 <code>onResize</code> 都是对基类 <code>VectorGrid3</code> 的重写</p> 
<p><code>VectorGrid3</code> 在自己的 <code>resize</code> 中调用了 <code>onResize</code>，说明 <code>onResize</code> 只是一个钩子</p> 
<p>之后，<code>VertexCenteredVectorGrid3</code> <code>CellCenteredVectorGrid3</code> <code>FaceCenteredGrid3</code> 在自己的构造函数中都会调用 <code>resize</code>，这就实现了最终对 Array 的 resize 的调用</p> 
<h4><a id="Builder_429"></a>Builder</h4> 
<p>感觉现在已经知道大概的逻辑了，但是回到 main 开始看的话，他这里创建求解器是使用一个 <code>builder</code></p> 
<p>看了一下，感觉他这思路就是，创建一个 builder 类，这个类提供一些函数用于配置默认参数，最后返回一个实例的共享指针</p> 
<pre><code class="prism language-cpp"><span class="token keyword">auto</span> solver <span class="token operator">=</span>
    <span class="token class-name">PicSolver3</span><span class="token operator">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withResolution</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>resolutionX<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> resolutionX<span class="token punctuation">,</span> resolutionX<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withDomainSizeX</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">makeShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>因为 B 和 C 都是继承自 A，所以只要 B 和 C 的 builder 都是继承自 A 的 builder，那么 B 和 C 配置默认参数的方法就会非常类似</p> 
<p>这样子设计，应该是为了初始化配置上的相似性？</p> 
<p>因为实际上 B 和 C 也没有什么自己的独特的要初始化的参数，要初始化的全都在基类 A 中定义好了</p> 
<p>话又说回来，正是因为这样，才需要继承关系，B 和 C 只需要基类 A 定义的初始化函数，应该是理想的完美继承关系吧</p> 
<h4><a id="_451"></a>构造函数</h4> 
<p>然后我打算再看 <code>GridFluidSolver</code> 的构造函数</p> 
<pre><code class="prism language-cpp"><span class="token class-name">GridFluidSolver3</span><span class="token operator">::</span><span class="token function">GridFluidSolver3</span><span class="token punctuation">(</span><span class="token keyword">const</span> Size3<span class="token operator">&amp;</span> resolution<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> Vector3D<span class="token operator">&amp;</span> gridSpacing<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> Vector3D<span class="token operator">&amp;</span> gridOrigin<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _grids <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>GridSystemData3<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _grids<span class="token operator">-&gt;</span><span class="token function">resize</span><span class="token punctuation">(</span>resolution<span class="token punctuation">,</span> gridSpacing<span class="token punctuation">,</span> gridOrigin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setAdvectionSolver</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>CubicSemiLagrangian3<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setDiffusionSolver</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>GridBackwardEulerDiffusionSolver3<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setPressureSolver</span><span class="token punctuation">(</span>
        std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>GridFractionalSinglePhasePressureSolver3<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setIsUsingFixedSubTimeSteps</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>因为这里前面看的都是 <code>GridFluidSolver</code> 求解 NS 方程的框架，实际上具体的求解逻辑还是要看工具类，而构造函数这里就是给出了怎么配置这些工具类</p> 
<p>之后的类如果是继承 <code>GridFluidSolver</code>，比如 <code>PicSolver</code>，那么因为是继承嘛，所以父类构造函数也会被调用，也就相当于这些工具类的配置在 <code>GridFluidSolver</code> 这里就是默认值了</p> 
<h3><a id="AdvectionSolver_474"></a>AdvectionSolver</h3> 
<p><code>AdvectionSolver</code> 的虚函数 <code>advect</code> 有三个重载，分别处理 <code>ScalarGrid3</code> <code>CollocatedVectorGrid3</code> <code>FaceCenteredGrid3</code></p> 
<p>这个虚函数确定了输入的场，输出的场，速度场，还有边界 sdf</p> 
<p>感觉看到这里的话，就知道这个代码里面大部分都用 sdf 来表示边界了</p> 
<p>就很统一</p> 
<p>然后把边界作为参数，就是说明一定是要考虑边界</p> 
<p>给人感觉就是规范了怎么求解</p> 
<h4><a id="SemiLagrangian_488"></a>SemiLagrangian</h4> 
<p>同样地，<code>CollocatedVectorGrid3</code> 和 <code>FaceCenteredGrid3</code> 的区别就是前者只是一个场做向后追踪，而后者是三个分量都要分别做向后追踪</p> 
<p>向后追踪的时候，也要拆分若干个子步骤，也是跟之前一样，根据 CFL 的物理意义来拆分，也就是所谓的自适应子步骤。算出了子步骤的数量之后，当前子步骤的 dt 也是用 remaining time / n 来算</p> 
<pre><code class="prism language-cpp"><span class="token comment">// Adaptive time-stepping</span>
Vector3D vel0 <span class="token operator">=</span> flow<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span>pt0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> numSubSteps
    <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">ceil</span><span class="token punctuation">(</span>vel0<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> remainingT <span class="token operator">/</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dt <span class="token operator">=</span> remainingT <span class="token operator">/</span> numSubSteps<span class="token punctuation">;</span>
</code></pre> 
<p>然后找点用的是中点法</p> 
<pre><code class="prism language-cpp"><span class="token comment">// Mid-point rule</span>
Vector3D midPt <span class="token operator">=</span> pt0 <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> dt <span class="token operator">*</span> vel0<span class="token punctuation">;</span>
Vector3D midVel <span class="token operator">=</span> flow<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span>midPt<span class="token punctuation">)</span><span class="token punctuation">;</span>
pt1 <span class="token operator">=</span> pt0 <span class="token operator">-</span> dt <span class="token operator">*</span> midVel<span class="token punctuation">;</span>
</code></pre> 
<p>然后要考虑边界问题，通过两个点的 SDF 值相乘是否 &lt; 0 来判断这两个点是否是一个在边界外一个在边界内</p> 
<p>如果是的话，那就说明向后追踪的时候追到外面去了，那么就要把点钳制在边界上</p> 
<p>这里通过线性插值把点定位在边界上</p> 
<p>如果遇到了这种跨过边界的情况，那么钳制之后就直接结束循环了，不用继续执行剩下的子步骤了</p> 
<pre><code class="prism language-cpp"><span class="token keyword">double</span> phi0 <span class="token operator">=</span> boundarySdf<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span>pt0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> phi1 <span class="token operator">=</span> boundarySdf<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span>pt1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>phi0 <span class="token operator">*</span> phi1 <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">double</span> w <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">fabs</span><span class="token punctuation">(</span>phi1<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">fabs</span><span class="token punctuation">(</span>phi0<span class="token punctuation">)</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">fabs</span><span class="token punctuation">(</span>phi1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pt1 <span class="token operator">=</span> w <span class="token operator">*</span> pt0 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> w<span class="token punctuation">)</span> <span class="token operator">*</span> pt1<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这就是向后追踪的过程了</p> 
<p>最后把向后追踪得到的位置是一个三维世界坐标，不是网格序号，所以要用 <code>sampler</code>，这个 <code>inputSamplerFunc</code> 返回的就是网格的 <code>sampler</code></p> 
<pre><code class="prism language-cpp"><span class="token keyword">auto</span> outputDataPos <span class="token operator">=</span> output<span class="token operator">-&gt;</span><span class="token function">dataPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">auto</span> outputDataAcc <span class="token operator">=</span> output<span class="token operator">-&gt;</span><span class="token function">dataAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">auto</span> inputDataPos <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">dataPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

output<span class="token operator">-&gt;</span><span class="token function">parallelForEachDataPointIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>boundarySdf<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span><span class="token function">inputDataPos</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Vector3D pt <span class="token operator">=</span> <span class="token function">backTrace</span><span class="token punctuation">(</span>
            flow<span class="token punctuation">,</span> dt<span class="token punctuation">,</span> h<span class="token punctuation">,</span> <span class="token function">outputDataPos</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">,</span> boundarySdf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">outputDataAcc</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">inputSamplerFunc</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里就可以看出来 <code>sampler</code> 和 <code>accessor</code> 的区别</p> 
<p><code>sampler</code> 是根据世界坐标来获得值的，而 <code>accessor</code> 是根据网格的编号直接访问数组元素</p> 
<h4><a id="forEachIndex_parallelForEachIndex_552"></a>forEachIndex parallelForEachIndex</h4> 
<p>我突然很好奇的就是，这样子直接 foreach 的话，如果传入的 <code>input</code> 和 <code>output</code> 是同一个的话，又没有做缓存，那么应该会出现数据相关的问题吧</p> 
<p>我主要是想确认一下他这里面确实没有更深一层东西来解决数据相关的问题，于是看了一下 <code>forEachIndex</code></p> 
<p>Grid 的 <code>forEachIndex</code> 实际上是调用的 Array 的 <code>ArrayAccessor</code> 的 <code>forEachIndex</code></p> 
<p>最终看 Accessor 的 <code>forEachIndex</code> 发现他这个就是一个单纯的串行的多层循环，用模板把不同层循环都封装成一个了</p> 
<p>看到这里的时候也要注意他这个是列优先存储</p> 
<pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Callback</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ArrayAccessor</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">forEachIndex</span><span class="token punctuation">(</span>Callback func<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Callback</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ArrayAccessor</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">forEachIndex</span><span class="token punctuation">(</span>Callback func<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> _size<span class="token punctuation">.</span>y<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _size<span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Callback</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">ArrayAccessor</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">forEachIndex</span><span class="token punctuation">(</span>Callback func<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> _size<span class="token punctuation">.</span>z<span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> _size<span class="token punctuation">.</span>y<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _size<span class="token punctuation">.</span>x<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>那么更进一步，查看 <code>ArrayAccessor</code> 的 <code>parallelForEachIndex</code> 的话，可以看到它们最终都是调用 <code>parallelFor</code></p> 
<p>同样的，<code>parallelForEachIndex</code> 不同的变体只是为了处理不同的维度</p> 
<p>最终可以找到 <code>parallelFor</code> 里面有各种方法实现的多线程并行计算</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">parallelFor</span><span class="token punctuation">(</span>IndexType start<span class="token punctuation">,</span> IndexType end<span class="token punctuation">,</span> <span class="token keyword">const</span> Function<span class="token operator">&amp;</span> func<span class="token punctuation">,</span>
                 ExecutionPolicy policy<span class="token punctuation">)</span>
</code></pre> 
<p>至于这个 <code>parallelRangeFor</code> 输入三个维度的范围，最终居然只拆分 z 维度的范围，很神奇</p> 
<h4><a id="sampler_608"></a>sampler</h4> 
<p>因为平流那里涉及到了 <code>sampler</code>，所以想看一些具体是怎么做的</p> 
<p><code>CubicSemiLagrangian</code> 与 <code>SemiLagrangian3</code> 的差别也就只在于这个采样器的配置</p> 
<p>虽然我知道这里面有插值</p> 
<p>记得看书的时候也看到过，一开始书上讲的是线性插值然后讲三次样条插值</p> 
<p><code>ScalarGrid3</code> <code>CollocatedVectorGrid3</code> <code>FaceCenteredGrid3</code> 都是默认的 <code>LinearArraySampler</code></p> 
<p>插值方法都要把世界坐标用网格中心和网格单元尺寸进行归一化</p> 
<p>这让我突然想到了，其实这里所有的坐标都是在物体坐标系的，如果你这个流体模拟外部还有别的坐标系，跟这个也无关的</p> 
<p>所以才没有别的什么额外的归一化操作，比如处理整个 box 的旋转啊什么的，没有，因为 box 自己是一个物体坐标系</p> 
<p>然后他这个求重心坐标的方法我还真看不懂</p> 
<p>对于线性插值来说，在 i, j, k 和 i+1, j+1, k+1 之间这八个块内三线性插值</p> 
<p>对于三次样条插值，在 i-1 i i+1 i+2 之间这 64 个块内做单调 Catmull-Rom 插值</p> 
<p>这个单调 Catmull-Rom 在书中也有讲，搜了一下，这个也是可以做文章的，就是说具体怎么设计这个插值函数</p> 
<p>但是具体单调 Catmull-Rom 怎么做的还没看懂……看书的时候就没看懂，估计之后要找文章来对应地看</p> 
<h3><a id="GridDiffusionSolver_636"></a>GridDiffusionSolver</h3> 
<p><code>GridDiffusionSolver</code> 也就是提供了虚函数，确定了形参</p> 
<h4><a id="GridForwardEulerDiffusionSolver_640"></a>GridForwardEulerDiffusionSolver</h4> 
<p><code>GridForwardEulerDiffusionSolver3</code> 更简单，因为是前向的，所以不用算矩阵求解，直接逐项更新就好了</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">GridForwardEulerDiffusionSolver3</span><span class="token operator">::</span><span class="token function">solve</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> ScalarGrid3<span class="token operator">&amp;</span> source<span class="token punctuation">,</span>
    <span class="token keyword">double</span> diffusionCoefficient<span class="token punctuation">,</span>
    <span class="token keyword">double</span> timeIntervalInSeconds<span class="token punctuation">,</span>
    ScalarGrid3<span class="token operator">*</span> dest<span class="token punctuation">,</span>
    <span class="token keyword">const</span> ScalarField3<span class="token operator">&amp;</span> boundarySdf<span class="token punctuation">,</span>
    <span class="token keyword">const</span> ScalarField3<span class="token operator">&amp;</span> fluidSdf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> src <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">constDataAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Vector3D h <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">gridSpacing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> pos <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">dataPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">buildMarkers</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">resolution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pos<span class="token punctuation">,</span> boundarySdf<span class="token punctuation">,</span> fluidSdf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    source<span class="token punctuation">.</span><span class="token function">parallelForEachDataPointIndex</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_markers</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">(</span><span class="token operator">*</span>dest<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
                    <span class="token operator">=</span> <span class="token function">source</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
                    <span class="token operator">+</span> diffusionCoefficient
                    <span class="token operator">*</span> timeIntervalInSeconds
                    <span class="token operator">*</span> <span class="token function">laplacian</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> _markers<span class="token punctuation">,</span> h<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">(</span><span class="token operator">*</span>dest<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">source</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="GridBackwardEulerDiffusionSolver_674"></a>GridBackwardEulerDiffusionSolver</h4> 
<p><code>GridBackwardEulerDiffusionSolver</code> 用了后向方法，所以就要求解矩阵了</p> 
<p>因为是求解矩阵，所以可以看到多了构建系数矩阵和列向量的步骤，也就是 Ax=b 中的 A 和 b</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">GridBackwardEulerDiffusionSolver3</span><span class="token operator">::</span><span class="token function">solve</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> ScalarGrid3<span class="token operator">&amp;</span> source<span class="token punctuation">,</span>
    <span class="token keyword">double</span> diffusionCoefficient<span class="token punctuation">,</span>
    <span class="token keyword">double</span> timeIntervalInSeconds<span class="token punctuation">,</span>
    ScalarGrid3<span class="token operator">*</span> dest<span class="token punctuation">,</span>
    <span class="token keyword">const</span> ScalarField3<span class="token operator">&amp;</span> boundarySdf<span class="token punctuation">,</span>
    <span class="token keyword">const</span> ScalarField3<span class="token operator">&amp;</span> fluidSdf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> pos <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">dataPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Vector3D h <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">gridSpacing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Vector3D c <span class="token operator">=</span> timeIntervalInSeconds <span class="token operator">*</span> diffusionCoefficient <span class="token operator">/</span> <span class="token punctuation">(</span>h <span class="token operator">*</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">buildMarkers</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pos<span class="token punctuation">,</span> boundarySdf<span class="token punctuation">,</span> fluidSdf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">buildMatrix</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">buildVectors</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">constDataAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_systemSolver <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Solve the system</span>
        _systemSolver<span class="token operator">-&gt;</span><span class="token function">solve</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_system<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Assign the solution</span>
        source<span class="token punctuation">.</span><span class="token function">parallelForEachDataPointIndex</span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">(</span><span class="token operator">*</span>dest<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> _system<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>构建矩阵和列向量的思路在书上确实讲了</p> 
<p>书上先讲了一个一维的例子，然后再说，推广到多维也很简单，就是把多维线性化。对于 i j k 的循环，最内层会算出线性化的序号，对于每个点，点的中心是 kc+1，点的邻居是 -c</p> 
<p>其实一开始我看这个的话，只是对着书上那个二维例子对照着看，但是没有真正理解三维情况下是什么状况</p> 
<p>书上的例子：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           [ 
          
          
           
            
             
              
              
                c 
               
              
                + 
               
              
                1 
               
              
             
            
            
             
              
              
                − 
               
              
                c 
               
              
             
            
            
             
             
               0 
              
             
            
            
             
              
              
                . 
               
              
                . 
               
              
                . 
               
              
             
            
            
             
             
               0 
              
             
            
            
             
             
               0 
              
             
            
           
           
            
             
              
              
                − 
               
              
                c 
               
              
             
            
            
             
              
              
                2 
               
              
                c 
               
              
                + 
               
              
                1 
               
              
             
            
            
             
              
              
                − 
               
              
                c 
               
              
             
            
            
             
              
              
                . 
               
              
                . 
               
              
                . 
               
              
             
            
            
             
             
               0 
              
             
            
            
             
             
               0 
              
             
            
           
           
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
             
               ⋱ 
              
             
            
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
              
             
            
           
           
            
             
             
               0 
              
             
            
            
             
             
               0 
              
             
            
            
             
              
              
                . 
               
              
                . 
               
              
                . 
               
              
             
            
            
             
              
              
                − 
               
              
                c 
               
              
             
            
            
             
              
              
                c 
               
              
                + 
               
              
                1 
               
              
             
            
           
          
         
           ] 
          
         
        
          ⋅ 
         
         
         
           f 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           n 
          
         
        
       
         \begin{bmatrix} c+1 &amp; -c &amp; 0 &amp; ... &amp; 0 &amp; 0 \\ -c &amp; 2c+1 &amp; -c &amp; ... &amp; 0 &amp; 0 \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots &amp; \\ 0 &amp; 0 &amp; ... &amp; -c &amp; c+1 \end{bmatrix} \cdot f^{n+1} = f^n 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 5.46em; vertical-align: -2.48em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95em;"><span class="" style="top: -4.95em;"><span class="pstrut" style="height: 7.4em;"></span><span class="" style="width: 0.667em; height: 5.4em;"> 
              <svg width="0.667em" height="5.400em" viewbox="0 0 667 5400"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathnormal">c</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathnormal">c</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.64em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mord">0</span></span></span><span class="" style="top: -4.44em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathnormal">c</span></span></span><span class="" style="top: -2.58em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span class="" style="top: -1.38em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mord">...</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">−</span><span class="mord mathnormal">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.64em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mord">0</span></span></span><span class="" style="top: -4.44em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mord">0</span></span></span><span class="" style="top: -2.58em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.28em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95em;"><span class="" style="top: -4.95em;"><span class="pstrut" style="height: 7.4em;"></span><span class="" style="width: 0.667em; height: 5.4em;"> 
              <svg width="0.667em" height="5.400em" viewbox="0 0 667 5400"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1800 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45em;"><span class=""></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.0585em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9088em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>这里可能有很多坑……或者只是我个人的问题</p> 
<h5><a id="_726"></a>系数矩阵的意义</h5> 
<p>第一个是没有注意到线性化的话，或者是没有注意看书的话，那么就会想着，这个矩阵是在表示二维情况，会以为这个矩阵和网格坐标有这样的对应关系</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           [ 
          
          
           
            
             
              
              
                ( 
               
              
                0 
               
              
                , 
               
              
                0 
               
              
                ) 
               
              
             
            
            
             
              
              
                ( 
               
              
                0 
               
              
                , 
               
              
                1 
               
              
                ) 
               
              
             
            
            
             
              
              
                ( 
               
              
                0 
               
              
                , 
               
              
                2 
               
              
                ) 
               
              
             
            
            
             
              
              
                . 
               
              
                . 
               
              
                . 
               
              
             
            
            
             
              
              
                ( 
               
              
                0 
               
              
                , 
               
              
                n 
               
              
                − 
               
              
                1 
               
              
                ) 
               
              
             
            
           
           
            
             
              
              
                ( 
               
              
                1 
               
              
                , 
               
              
                0 
               
              
                ) 
               
              
             
            
            
             
              
              
                ( 
               
              
                1 
               
              
                , 
               
              
                1 
               
              
                ) 
               
              
             
            
            
             
              
              
                ( 
               
              
                1 
               
              
                , 
               
              
                2 
               
              
                ) 
               
              
             
            
            
             
              
              
                . 
               
              
                . 
               
              
                . 
               
              
             
            
            
             
              
              
                ( 
               
              
                1 
               
              
                , 
               
              
                n 
               
              
                − 
               
              
                1 
               
              
                ) 
               
              
             
            
           
           
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
             
               ⋱ 
              
             
            
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
              
             
            
           
           
            
             
              
              
                ( 
               
              
                n 
               
              
                − 
               
              
                1 
               
              
                , 
               
              
                0 
               
              
                ) 
               
              
             
            
            
             
              
              
                ( 
               
              
                n 
               
              
                − 
               
              
                1 
               
              
                , 
               
              
                1 
               
              
                ) 
               
              
             
            
            
             
              
              
                ( 
               
              
                n 
               
              
                − 
               
              
                1 
               
              
                , 
               
              
                2 
               
              
                ) 
               
              
             
            
            
             
              
              
                . 
               
              
                . 
               
              
                . 
               
              
             
            
            
             
              
              
                ( 
               
              
                n 
               
              
                − 
               
              
                1 
               
              
                , 
               
              
                n 
               
              
                − 
               
              
                1 
               
              
                ) 
               
              
             
            
           
          
         
           ] 
          
         
        
          ⋅ 
         
         
         
           f 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           n 
          
         
        
       
         \begin{bmatrix} (0,0) &amp; (0,1) &amp; (0,2) &amp; ... &amp; (0,n-1) \\ (1,0) &amp; (1,1) &amp; (1,2) &amp; ... &amp; (1,n-1) \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots &amp; \\ (n-1,0) &amp; (n-1,1) &amp; (n-1,2) &amp; ... &amp; (n-1,n-1) \end{bmatrix} \cdot f^{n+1} = f^n 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 5.46em; vertical-align: -2.48em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95em;"><span class="" style="top: -4.95em;"><span class="pstrut" style="height: 7.4em;"></span><span class="" style="width: 0.667em; height: 5.4em;"> 
              <svg width="0.667em" height="5.400em" viewbox="0 0 667 5400"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.64em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span><span class="" style="top: -4.44em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span><span class="" style="top: -2.58em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span class="" style="top: -1.38em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.58em;"><span class="" style="top: -2.58em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.28em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95em;"><span class="" style="top: -4.95em;"><span class="pstrut" style="height: 7.4em;"></span><span class="" style="width: 0.667em; height: 5.4em;"> 
              <svg width="0.667em" height="5.400em" viewbox="0 0 667 5400"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1800 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45em;"><span class=""></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.0585em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9088em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>然后自己递推到三维的话，就会以为要用到三维矩阵，比如把一些二维矩阵堆叠起来的这种形式……</p> 
<p>比如系数矩阵的第一层是</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          [ 
         
         
          
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               0 
              
             
               , 
              
             
               0 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               0 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               0 
              
             
               , 
              
             
               2 
              
             
               ) 
              
             
            
           
           
            
             
             
               . 
              
             
               . 
              
             
               . 
              
             
            
           
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               0 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               ) 
              
             
            
           
          
          
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               2 
              
             
               ) 
              
             
            
           
           
            
             
             
               . 
              
             
               . 
              
             
               . 
              
             
            
           
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               ) 
              
             
            
           
          
          
           
            
             
             
               ⋮ 
              
              
               
              
             
            
           
           
            
             
             
               ⋮ 
              
              
               
              
             
            
           
           
            
            
              ⋱ 
             
            
           
           
            
             
             
               ⋮ 
              
              
               
              
             
            
           
           
            
             
             
               ⋮ 
              
              
               
              
             
            
           
           
            
             
            
           
          
          
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               , 
              
             
               2 
              
             
               ) 
              
             
            
           
           
            
             
             
               . 
              
             
               . 
              
             
               . 
              
             
            
           
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               ) 
              
             
            
           
          
         
        
          ] 
         
        
       
         \begin{bmatrix} (0,0,0) &amp; (0,0,1) &amp; (0,0,2) &amp; ... &amp; (0,0,n-1) \\ (0,1,0) &amp; (0,1,1) &amp; (0,1,2) &amp; ... &amp; (0,1,n-1) \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots &amp; \\ (0,n-1,0) &amp; (0,n-1,1) &amp; (0,n-1,2) &amp; ... &amp; (0,n-1,n-1) \end{bmatrix} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 5.46em; vertical-align: -2.48em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95em;"><span class="" style="top: -4.95em;"><span class="pstrut" style="height: 7.4em;"></span><span class="" style="width: 0.667em; height: 5.4em;"> 
              <svg width="0.667em" height="5.400em" viewbox="0 0 667 5400"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.64em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span><span class="" style="top: -4.44em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span><span class="" style="top: -2.58em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span class="" style="top: -1.38em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.58em;"><span class="" style="top: -2.58em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.28em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95em;"><span class="" style="top: -4.95em;"><span class="pstrut" style="height: 7.4em;"></span><span class="" style="width: 0.667em; height: 5.4em;"> 
              <svg width="0.667em" height="5.400em" viewbox="0 0 667 5400"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1800 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>第二层是</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          [ 
         
         
          
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               , 
              
             
               0 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               , 
              
             
               2 
              
             
               ) 
              
             
            
           
           
            
             
             
               . 
              
             
               . 
              
             
               . 
              
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               ) 
              
             
            
           
          
          
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               2 
              
             
               ) 
              
             
            
           
           
            
             
             
               . 
              
             
               . 
              
             
               . 
              
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               ) 
              
             
            
           
          
          
           
            
             
             
               ⋮ 
              
              
               
              
             
            
           
           
            
             
             
               ⋮ 
              
              
               
              
             
            
           
           
            
            
              ⋱ 
             
            
           
           
            
             
             
               ⋮ 
              
              
               
              
             
            
           
           
            
             
             
               ⋮ 
              
              
               
              
             
            
           
           
            
             
            
           
          
          
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               , 
              
             
               2 
              
             
               ) 
              
             
            
           
           
            
             
             
               . 
              
             
               . 
              
             
               . 
              
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               , 
              
             
               n 
              
             
               − 
              
             
               1 
              
             
               ) 
              
             
            
           
          
         
        
          ] 
         
        
       
         \begin{bmatrix} (1,0,0) &amp; (1,0,1) &amp; (1,0,2) &amp; ... &amp; (1,0,n-1) \\ (1,1,0) &amp; (1,1,1) &amp; (1,1,2) &amp; ... &amp; (1,1,n-1) \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots &amp; \\ (1,n-1,0) &amp; (1,n-1,1) &amp; (1,n-1,2) &amp; ... &amp; (1,n-1,n-1) \end{bmatrix} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 5.46em; vertical-align: -2.48em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95em;"><span class="" style="top: -4.95em;"><span class="pstrut" style="height: 7.4em;"></span><span class="" style="width: 0.667em; height: 5.4em;"> 
              <svg width="0.667em" height="5.400em" viewbox="0 0 667 5400"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.64em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span><span class="" style="top: -4.44em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span><span class="" style="top: -2.58em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span class="" style="top: -1.38em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.58em;"><span class="" style="top: -2.58em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.28em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95em;"><span class="" style="top: -4.95em;"><span class="pstrut" style="height: 7.4em;"></span><span class="" style="width: 0.667em; height: 5.4em;"> 
              <svg width="0.667em" height="5.400em" viewbox="0 0 667 5400"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1800 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>如此堆叠起来</p> 
<p>实际上不是的……如果认真看书的话，这个矩阵实际上是描述一维情况下的矩阵</p> 
<p>实际上的位置对应关系是这样的，对角线对应一个一维的坐标，其他位置的元素，只是反应一维坐标两两之间的相关性，我这里用 cov 代指</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           [ 
          
          
           
            
             
              
              
                x 
               
              
                = 
               
              
                0 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                . 
               
              
                . 
               
              
                . 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
           
           
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                x 
               
              
                = 
               
              
                1 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                . 
               
              
                . 
               
              
                . 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
           
           
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
             
               ⋱ 
              
             
            
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
              
              
                ⋮ 
               
               
                
               
              
             
            
            
             
              
             
            
           
           
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                . 
               
              
                . 
               
              
                . 
               
              
             
            
            
             
              
              
                x 
               
              
                = 
               
              
                n 
               
              
                − 
               
              
                1 
               
              
             
            
           
          
         
           ] 
          
         
        
          ⋅ 
         
         
         
           f 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           n 
          
         
        
       
         \begin{bmatrix} x=0 &amp; cov &amp; cov &amp; ... &amp; cov \\ cov &amp; x=1 &amp; cov &amp; ... &amp; cov \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots &amp; \\ cov &amp; cov &amp; cov &amp; ... &amp; x=n-1 \end{bmatrix} \cdot f^{n+1} = f^n 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 5.46em; vertical-align: -2.48em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95em;"><span class="" style="top: -4.95em;"><span class="pstrut" style="height: 7.4em;"></span><span class="" style="width: 0.667em; height: 5.4em;"> 
              <svg width="0.667em" height="5.400em" viewbox="0 0 667 5400"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">0</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">1</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.64em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -4.44em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -2.58em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span class="" style="top: -1.38em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">...</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.98em;"><span class="" style="top: -5.8275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -4.6275em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -2.7675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span class="" style="top: -1.5675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.48em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.58em;"><span class="" style="top: -2.58em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.28em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.95em;"><span class="" style="top: -4.95em;"><span class="pstrut" style="height: 7.4em;"></span><span class="" style="width: 0.667em; height: 5.4em;"> 
              <svg width="0.667em" height="5.400em" viewbox="0 0 667 5400"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1800 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.45em;"><span class=""></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.0585em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9088em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>实际上，自始自终都是，只用这个矩阵就可以代表任意维度的空间的，只要线性化就好了</p> 
<p>比如对于 2*2 的空间</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           [ 
          
          
           
            
             
              
              
                ( 
               
              
                0 
               
              
                , 
               
              
                0 
               
              
                ) 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
           
           
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                ( 
               
              
                0 
               
              
                , 
               
              
                1 
               
              
                ) 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
           
           
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                ( 
               
              
                1 
               
              
                , 
               
              
                0 
               
              
                ) 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
           
           
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                c 
               
              
                o 
               
              
                v 
               
              
             
            
            
             
              
              
                ( 
               
              
                1 
               
              
                , 
               
              
                1 
               
              
                ) 
               
              
             
            
           
          
         
           ] 
          
         
        
          ⋅ 
         
         
         
           f 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           n 
          
         
        
       
         \begin{bmatrix} (0,0) &amp; cov &amp; cov &amp; cov \\ cov &amp; (0,1) &amp; cov &amp; cov \\ cov &amp; cov &amp; (1,0) &amp; cov \\ cov &amp; cov &amp; cov &amp; (1,1) \end{bmatrix} \cdot f^{n+1} = f^n 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 4.8em; vertical-align: -2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.65em;"><span class="" style="top: -4.65em;"><span class="pstrut" style="height: 6.8em;"></span><span class="" style="width: 0.667em; height: 4.8em;"> 
              <svg width="0.667em" height="4.800em" viewbox="0 0 667 4800"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.65em;"><span class="" style="top: -4.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.65em;"><span class="" style="top: -4.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.65em;"><span class="" style="top: -4.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.65em;"><span class="" style="top: -4.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.15em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.65em;"><span class="" style="top: -4.65em;"><span class="pstrut" style="height: 6.8em;"></span><span class="" style="width: 0.667em; height: 4.8em;"> 
              <svg width="0.667em" height="4.800em" viewbox="0 0 667 4800"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1200 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.15em;"><span class=""></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.0585em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9088em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>对于 n<em>n</em>n 也是同理</p> 
<h5><a id="_k_783"></a>邻居数量 k</h5> 
<p>第二个问题是这个 k 的问题</p> 
<p>一开始我还以为是，在这个矩阵里面，某个对角线元素周围有多少个值不为 0 的非对角元素</p> 
<p>当然这个想法稍微判断一下就知道是错的</p> 
<p>之后才想懂，应该指的是，实际网格中，某个格子上下左右前后有多少个流体邻居</p> 
<p>比如 3d 网格中，上下左右前后有 6 个邻居，那么就去查看这 6 个邻居在不在范围内，在的话就邻居数 + 1，也就是 k++，也就是在代码上直接加上一个 c 就可以了</p> 
<p>那么对于非对角线元素的赋值也是一样的</p> 
<pre><code class="prism language-cpp"><span class="token comment">// Initialize</span>
row<span class="token punctuation">.</span>center <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
row<span class="token punctuation">.</span>right <span class="token operator">=</span> row<span class="token punctuation">.</span>up <span class="token operator">=</span> row<span class="token punctuation">.</span>front <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    row<span class="token punctuation">.</span>center <span class="token operator">+=</span> c<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
	row<span class="token punctuation">.</span>right <span class="token operator">-=</span>  c<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    row<span class="token punctuation">.</span>center <span class="token operator">+=</span> c<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    row<span class="token punctuation">.</span>center <span class="token operator">+=</span> c<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    row<span class="token punctuation">.</span>up <span class="token operator">-=</span>  c<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    row<span class="token punctuation">.</span>center <span class="token operator">+=</span> c<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>这里是只关注上对角矩阵，因为系数矩阵是对称的。所以这里判断 <code>i + 1 &lt; size.x</code> 的时候有给 <code>right</code> 更新，但是判断 <code>i &gt; 0</code> 的时候没有给 <code>left</code> 更新，因为没有保存 <code>left</code> 等下对角的值</p> 
<p>对于边界的情况，如果我们知道是 Dirichlet 边界，或者说是第一类边界条件，那么这个边界条件意味着我们知道边界上的函数值</p> 
<p>如果是 Neumann 边界，第二类边界条件，也即是知道边界上的导数值</p> 
<p>书上说的是，如果是 Neumann 边界，就把边界内的值外推到边界外，比如 f2 在边界内，f3 在边界外，f3 是 x 的最后一个元素，那么就直接令 f3 = f2</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           [ 
          
          
           
            
             
             
               2 
              
             
            
            
             
              
              
                − 
               
              
                1 
               
              
             
            
            
             
             
               0 
              
             
            
           
           
            
             
              
              
                − 
               
              
                1 
               
              
             
            
            
             
             
               3 
              
             
            
            
             
              
              
                − 
               
              
                1 
               
              
             
            
           
           
            
             
             
               0 
              
             
            
            
             
              
              
                − 
               
              
                1 
               
              
             
            
            
             
             
               2 
              
             
            
           
          
         
           ] 
          
         
        
          ⋅ 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                2 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                3 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
          
         
           ] 
          
         
        
          = 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
              
                n 
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                2 
               
              
                n 
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                3 
               
              
                n 
               
              
             
            
           
          
         
           ] 
          
         
        
       
         \begin{bmatrix} 2 &amp; -1 &amp; 0 \\ -1 &amp; 3 &amp; -1 \\ 0 &amp; -1 &amp; 2 \end{bmatrix} \cdot \begin{bmatrix} f_1^{n+1} \\ f_2^{n+1} \\ f_3^{n+1} \\ \end{bmatrix} =\begin{bmatrix} f_1^{n} \\ f_2^{n} \\ f_3^{n} \\ \end{bmatrix} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 3.6em; vertical-align: -1.55em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.05em;"><span class="pstrut" style="height: 5.6em;"></span><span class="" style="width: 0.667em; height: 3.6em;"> 
              <svg width="0.667em" height="3.600em" viewbox="0 0 667 3600"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span class="" style="top: -1.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">3</span></span></span><span class="" style="top: -1.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">0</span></span></span><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span class="" style="top: -1.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.05em;"><span class="pstrut" style="height: 5.6em;"></span><span class="" style="width: 0.667em; height: 3.6em;"> 
              <svg width="0.667em" height="3.600em" viewbox="0 0 667 3600"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 3.6427em; vertical-align: -1.5714em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.05em;"><span class="pstrut" style="height: 5.6em;"></span><span class="" style="width: 0.667em; height: 3.6em;"> 
              <svg width="0.667em" height="3.600em" viewbox="0 0 667 3600"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.0714em;"><span class="" style="top: -4.2171em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.0029em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -1.7886em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.5714em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.05em;"><span class="pstrut" style="height: 5.6em;"></span><span class="" style="width: 0.667em; height: 3.6em;"> 
              <svg width="0.667em" height="3.600em" viewbox="0 0 667 3600"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.6em; vertical-align: -1.55em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.05em;"><span class="pstrut" style="height: 5.6em;"></span><span class="" style="width: 0.667em; height: 3.6em;"> 
              <svg width="0.667em" height="3.600em" viewbox="0 0 667 3600"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -1.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.05em;"><span class="pstrut" style="height: 5.6em;"></span><span class="" style="width: 0.667em; height: 3.6em;"> 
              <svg width="0.667em" height="3.600em" viewbox="0 0 667 3600"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>那么就会可以消去矩阵 A 的最后一行和列向量 b 的最后一个元素了</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           [ 
          
          
           
            
             
             
               2 
              
             
            
            
             
              
              
                − 
               
              
                1 
               
              
             
            
           
           
            
             
              
              
                − 
               
              
                1 
               
              
             
            
            
             
             
               2 
              
             
            
           
          
         
           ] 
          
         
        
          ⋅ 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                2 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
          
         
           ] 
          
         
        
          = 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
              
                n 
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                2 
               
              
                n 
               
              
             
            
           
          
         
           ] 
          
         
        
       
         \begin{bmatrix} 2 &amp; -1 \\ -1 &amp; 2 \end{bmatrix} \cdot \begin{bmatrix} f_1^{n+1} \\ f_2^{n+1} \end{bmatrix} =\begin{bmatrix} f_1^{n} \\ f_2^{n} \end{bmatrix} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.4285em; vertical-align: -0.9642em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4642em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.3958em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.9642em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></span></p> 
<p>这里是因为 f3 = f2 所以 3 变成 2 了，因为减去了一个 f2</p> 
<p>如果是 Dirichlet 边界，我们假设边界上的值都是已经满足了这个边界条件的，从代码上来说，就是我们认为我们已经在求解之前调用了 <code>applyBoundaryCondition</code>。</p> 
<p>那么实际上就有 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          f 
         
        
          3 
         
        
          n 
         
        
       
         = 
        
        
        
          f 
         
        
          3 
         
         
         
           n 
          
         
           + 
          
         
           1 
          
         
        
       
      
        f_3^{n} = f_3^{n+1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9425em; vertical-align: -0.2481em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2663em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p>那么我们仍然是遵循之前的思路，把这一行给消去，但是我们现在没有 f2 = f3 这种事</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           [ 
          
          
           
            
             
             
               2 
              
             
            
            
             
              
              
                − 
               
              
                1 
               
              
             
            
           
           
            
             
              
              
                − 
               
              
                1 
               
              
             
            
            
             
             
               3 
              
             
            
           
          
         
           ] 
          
         
        
          ⋅ 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
           
            
             
              
               
               
                 f 
                
               
                 2 
                
                
                
                  n 
                 
                
                  + 
                 
                
                  1 
                 
                
               
              
                + 
               
               
               
                 f 
                
               
                 3 
                
               
                 n 
                
               
              
             
            
           
          
         
           ] 
          
         
        
          = 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
              
                n 
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                2 
               
              
                n 
               
              
             
            
           
          
         
           ] 
          
         
        
       
         \begin{bmatrix} 2 &amp; -1 \\ -1 &amp; 3 \end{bmatrix} \cdot \begin{bmatrix} f_1^{n+1} \\ f_2^{n+1} + f_3^{n} \end{bmatrix} =\begin{bmatrix} f_1^{n} \\ f_2^{n} \end{bmatrix} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.4285em; vertical-align: -0.9642em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4642em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.3958em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.9642em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></span></p> 
<p>那么现在矩阵中 2 对应位置的对角线元素还是 3</p> 
<p>现在转换到代码的话，要知道什么时候在 center 加 c，那么根据上面的边界条件的分析，分析中 2 号对应位置的对角线元素是 3 的话，说明这种边界下也要 +c</p> 
<p>实际写代码的时候还要避免那个地方是空气，所以条件判断是 <code>isDirichlet &amp;&amp; _markers(i + 1, j, k) != kAir</code></p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>isDirichlet <span class="token operator">&amp;&amp;</span> <span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">!=</span> kAir<span class="token punctuation">)</span>
         <span class="token operator">||</span> <span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        row<span class="token punctuation">.</span>center <span class="token operator">+=</span> c<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        row<span class="token punctuation">.</span>right <span class="token operator">-=</span>  c<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span>
    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>isDirichlet <span class="token operator">&amp;&amp;</span> <span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">!=</span> kAir<span class="token punctuation">)</span>
        <span class="token operator">||</span> <span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    row<span class="token punctuation">.</span>center <span class="token operator">+=</span> c<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_902"></a>边界条件</h5> 
<p>还有他这个边界条件是，一旦确定就应用在所有边界上的。就是说，所有边界都是，要不是 Dirichlet，要不是 Neumann</p> 
<p>但是我感觉他这里是不是写错了，或者说我还是没有理解他是怎么消去矩阵的最后一行的</p> 
<p>比如这个例子中，我觉得最下面两行是</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          − 
         
         
         
           f 
          
         
           1 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          + 
         
        
          3 
         
         
         
           f 
          
         
           2 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          − 
         
         
         
           f 
          
         
           3 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           2 
          
         
           n 
          
         
        
       
         -f_1^{n+1}+3f_2^{n+1}-f_3^{n+1} = f_2^{n} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">3</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9614em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -2.453em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          − 
         
         
         
           f 
          
         
           2 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          + 
         
        
          2 
         
         
         
           f 
          
         
           3 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           3 
          
         
           n 
          
         
        
       
         -f_2^{n+1}+2f_3^{n+1} = f_3^{n} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9614em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -2.453em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>那么上下两式相加得到</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          − 
         
         
         
           f 
          
         
           1 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          + 
         
        
          2 
         
         
         
           f 
          
         
           2 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          + 
         
         
         
           f 
          
         
           3 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           2 
          
         
           n 
          
         
        
          + 
         
         
         
           f 
          
         
           3 
          
         
           n 
          
         
        
       
         -f_1^{n+1}+2f_2^{n+1}+f_3^{n+1} = f_2^{n} + f_3^{n} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9614em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -2.453em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.9614em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -2.453em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>我觉得应该一直要这么算</p> 
<p>那么对于 Neumann 的话，外推之后得到 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          f 
         
        
          3 
         
         
         
           n 
          
         
           + 
          
         
           1 
          
         
        
       
         = 
        
        
        
          f 
         
        
          2 
         
         
         
           n 
          
         
           + 
          
         
           1 
          
         
        
       
      
        f_3^{n+1}=f_2^{n+1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2663em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2663em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，那么应该是有</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          − 
         
         
         
           f 
          
         
           1 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          + 
         
        
          3 
         
         
         
           f 
          
         
           2 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           2 
          
         
           n 
          
         
        
          + 
         
         
         
           f 
          
         
           3 
          
         
           n 
          
         
        
       
         -f_1^{n+1}+3f_2^{n+1} = f_2^{n} + f_3^{n} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">3</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9614em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -2.453em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.9614em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -2.453em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>实际上还不是这样的</p> 
<p>因为他这里还不是一直都是有这两个方程</p> 
<p>我再看了一下，他说的 Neumann 边界条件消去矩阵最后一行，不是因为两式联立之后，得到的式子做变化之后，相当于消去矩阵最后一行</p> 
<p>当然这是操作上这么说……实际上就是多了边界条件之后，这两个方程就线性相关了，所以可以消去一个</p> 
<p>他不是用线性相关的原理消去最后一行的，而是因为现在 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          f 
         
        
          3 
         
        
       
      
        f_3 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 不是变量了，所以这个方程直接不需要了，不用解变量了嘛</p> 
<p>那再看 Dirichlet 的话，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          f 
         
        
          3 
         
        
          n 
         
        
       
         = 
        
        
        
          f 
         
        
          3 
         
         
         
           n 
          
         
           + 
          
         
           1 
          
         
        
       
      
        f_3^{n} = f_3^{n+1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9425em; vertical-align: -0.2481em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2663em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，所以我觉得式子变成</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          − 
         
         
         
           f 
          
         
           1 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          + 
         
        
          2 
         
         
         
           f 
          
         
           2 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           2 
          
         
           n 
          
         
        
       
         -f_1^{n+1}+2f_2^{n+1} = f_2^{n} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9614em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -2.453em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>才对，也就是我觉得矩阵应该变为</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           [ 
          
          
           
            
             
             
               2 
              
             
            
            
             
              
              
                − 
               
              
                1 
               
              
             
            
           
           
            
             
              
              
                − 
               
              
                1 
               
              
             
            
            
             
             
               2 
              
             
            
           
          
         
           ] 
          
         
        
          ⋅ 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                2 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
          
         
           ] 
          
         
        
          = 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
              
                n 
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                2 
               
              
                n 
               
              
             
            
           
          
         
           ] 
          
         
        
       
         \begin{bmatrix} 2 &amp; -1 \\ -1 &amp; 2 \end{bmatrix} \cdot \begin{bmatrix} f_1^{n+1} \\ f_2^{n+1} \end{bmatrix} =\begin{bmatrix} f_1^{n} \\ f_2^{n} \end{bmatrix} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.4285em; vertical-align: -0.9642em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4642em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.3958em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.9642em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></span></p> 
<p>但是实际上，代码里面，在判断到 Dirichlet 条件之后，会给 center + c，也会给对应位置的 b + c * f3</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>_boundaryType <span class="token operator">==</span> Dirichlet <span class="token operator">&amp;&amp;</span> <span class="token function">_markers</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> <span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kBoundary<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _system<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+=</span> c<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token function">f</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kBoundary<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _system<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+=</span> c<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token function">f</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>这里的 f3 代指边界外的 f</p> 
<p>所以我就在想，是不是书上所谓的“把 f3 从左边移动到右边”指的是，同样是把 f3 不认为是变量，直接删去最后一行，然后现在剩下</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           [ 
          
          
           
            
             
             
               2 
              
             
            
            
             
              
              
                − 
               
              
                1 
               
              
             
            
            
             
             
               0 
              
             
            
           
           
            
             
              
              
                − 
               
              
                1 
               
              
             
            
            
             
             
               3 
              
             
            
            
             
              
              
                − 
               
              
                1 
               
              
             
            
           
          
         
           ] 
          
         
        
          ⋅ 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                2 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
          
         
           ] 
          
         
        
          = 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
              
                n 
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                2 
               
              
                n 
               
              
             
            
           
          
         
           ] 
          
         
        
       
         \begin{bmatrix} 2 &amp; -1 &amp; 0 \\ -1 &amp; 3 &amp; -1 \end{bmatrix} \cdot \begin{bmatrix} f_1^{n+1} \\ f_2^{n+1} \end{bmatrix} =\begin{bmatrix} f_1^{n} \\ f_2^{n} \end{bmatrix} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">0</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.4285em; vertical-align: -0.9642em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4642em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.3958em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.9642em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></span></p> 
<p>那么第二行写成方程就是</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          − 
         
         
         
           f 
          
         
           1 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          + 
         
        
          3 
         
         
         
           f 
          
         
           2 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          − 
         
         
         
           f 
          
         
           3 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           2 
          
         
           n 
          
         
        
       
         -f_1^{n+1}+3f_2^{n+1}-f_3^{n+1} = f_2^{n} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">3</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9614em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -2.453em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>将 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          f 
         
        
          3 
         
         
         
           n 
          
         
           + 
          
         
           1 
          
         
        
       
      
        f_3^{n+1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2663em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 从左边移动到右边就是</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          − 
         
         
         
           f 
          
         
           1 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          + 
         
        
          3 
         
         
         
           f 
          
         
           2 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           2 
          
         
           n 
          
         
        
          + 
         
         
         
           f 
          
         
           3 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
       
         -f_1^{n+1}+3f_2^{n+1} = f_2^{n}+f_3^{n+1} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">3</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9614em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -2.453em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>然后根据边界条件，代入 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          f 
         
        
          3 
         
        
          n 
         
        
       
         = 
        
        
        
          f 
         
        
          3 
         
         
         
           n 
          
         
           + 
          
         
           1 
          
         
        
       
      
        f_3^{n} = f_3^{n+1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9425em; vertical-align: -0.2481em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2663em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，得</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          − 
         
         
         
           f 
          
         
           1 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          + 
         
        
          3 
         
         
         
           f 
          
         
           2 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           2 
          
         
           n 
          
         
        
          + 
         
         
         
           f 
          
         
           3 
          
         
           n 
          
         
        
       
         -f_1^{n+1}+3f_2^{n+1} = f_2^{n}+f_3^{n} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1205em; vertical-align: -0.2564em;"></span><span class="mord">3</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.4436em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2564em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9614em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -2.453em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.9614em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -2.453em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>写成矩阵就是</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           [ 
          
          
           
            
             
             
               2 
              
             
            
            
             
              
              
                − 
               
              
                1 
               
              
             
            
           
           
            
             
              
              
                − 
               
              
                1 
               
              
             
            
            
             
             
               3 
              
             
            
           
          
         
           ] 
          
         
        
          ⋅ 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
           
            
             
              
              
                f 
               
              
                2 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
            
           
          
         
           ] 
          
         
        
          = 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                1 
               
              
                n 
               
              
             
            
           
           
            
             
              
               
               
                 f 
                
               
                 2 
                
               
                 n 
                
               
              
                + 
               
               
               
                 f 
                
               
                 3 
                
               
                 n 
                
               
              
             
            
           
          
         
           ] 
          
         
        
       
         \begin{bmatrix} 2 &amp; -1 \\ -1 &amp; 3 \end{bmatrix} \cdot \begin{bmatrix} f_1^{n+1} \\ f_2^{n+1} \end{bmatrix} =\begin{bmatrix} f_1^{n} \\ f_2^{n} + f_3^{n} \end{bmatrix} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.4285em; vertical-align: -0.9642em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4642em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.3958em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8542em;"><span class="" style="top: -2.4337em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.1031em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2663em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.9642em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4519em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2481em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></span></p> 
<p>书上的 3.43 就是错的</p> 
<p>所以我之前想的那种，用线性相关来解释的想法，一开始就不对……不管是什么类型的边界条件，都是边界值不是变量，所以直接删去那一行</p> 
<p>之后我才看到作者的纠错列表</p> 
<p><a href="https://fluidenginedevelopment.org/errata/" rel="nofollow">https://fluidenginedevelopment.org/errata/</a></p> 
<p>这里确实是我想的那样是错的</p> 
<h5><a id="_1016"></a>系数矩阵的非对角线元素</h5> 
<p>假设以 x 方向为例</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_markers</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>isDirichlet <span class="token operator">&amp;&amp;</span> <span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">!=</span> kAir<span class="token punctuation">)</span>
             <span class="token operator">||</span> <span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            row<span class="token punctuation">.</span>center <span class="token operator">+=</span> c<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            row<span class="token punctuation">.</span>right <span class="token operator">-=</span>  c<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span>
        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>isDirichlet <span class="token operator">&amp;&amp;</span> <span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">!=</span> kAir<span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token function">_markers</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        row<span class="token punctuation">.</span>center <span class="token operator">+=</span> c<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>我一开始看的时候，我有一种感觉是，代码的意思是两个三维点在系数矩阵中有三个相关的非对角线位置，但是我看这个二维矩阵，我觉得两个线性化之后的点只会有一个相关的非对角线的位置（都是只考虑上对角）</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           [ 
          
          
           
            
             
              
              
                ( 
               
              
                0 
               
              
                , 
               
              
                0 
               
              
                , 
               
              
                0 
               
              
                ) 
               
              
             
            
           
           
            
             
              
             
            
            
             
              
              
                ( 
               
              
                0 
               
              
                , 
               
              
                0 
               
              
                , 
               
              
                1 
               
              
                ) 
               
              
             
            
           
           
            
             
              
             
            
            
             
              
             
            
            
             
              
              
                ( 
               
              
                0 
               
              
                , 
               
              
                0 
               
              
                , 
               
              
                2 
               
              
                ) 
               
              
             
            
           
           
            
             
              
             
            
            
             
              
             
            
            
             
              
             
            
            
             
              
              
                ( 
               
              
                0 
               
              
                , 
               
              
                1 
               
              
                , 
               
              
                0 
               
              
                ) 
               
              
             
            
           
           
            
             
              
             
            
            
             
              
             
            
            
             
              
             
            
            
             
              
             
            
            
             
             
               ⋱ 
              
             
            
           
          
         
           ] 
          
         
        
          ⋅ 
         
         
         
           f 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           f 
          
         
           n 
          
         
        
       
         \begin{bmatrix} (0,0,0) \\ &amp; (0,0,1) \\ &amp; &amp; (0,0,2) \\ &amp; &amp; &amp; (0,1,0) \\ &amp; &amp; &amp; &amp; \ddots \end{bmatrix} \cdot f^{n+1} = f^n 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 6em; vertical-align: -2.75em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.25em;"><span class="" style="top: -5.25em;"><span class="pstrut" style="height: 8em;"></span><span class="" style="width: 0.667em; height: 6em;"> 
              <svg width="0.667em" height="6.000em" viewbox="0 0 667 6000"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v2400 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v2400 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.75em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.25em;"><span class="" style="top: -5.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -4.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -1.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.75em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -1.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.75em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.85em;"><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span><span class="" style="top: -1.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.75em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist"><span class="" style="top: -1.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -0.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.75em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist"><span class="" style="top: -0.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="minner">⋱</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.75em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.25em;"><span class="" style="top: -5.25em;"><span class="pstrut" style="height: 8em;"></span><span class="" style="width: 0.667em; height: 6em;"> 
              <svg width="0.667em" height="6.000em" viewbox="0 0 667 6000"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v2400 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v2400 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.75em;"><span class=""></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.0585em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9088em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7144em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>那他现在是不是 up right front 就是三个了，就多了</p> 
<p>之后我才发现，原来是 i j k 和三个不同方向的邻居啊，和 (i+1, j, k) (i, j+1, k) (i, j, k+1)</p> 
<p>就是三组点，所以有三个位置</p> 
<p>然后因为对于每一个点，都是找序号增加的方向，所以其实不会记录重复的互相关</p> 
<p>因为一般来说，比如 0 1 2 3 4，0 与 1 之间有两个位置，分别在上三角和下三角，但是我现在对每个点都是找序号增加的方向，也就是从 0 开始找 1，从 1 开始找 2，不会往回找，所以我找到的位置都是在上三角，但是实际上每一个</p> 
<h3><a id="_1059"></a>迭代算法</h3> 
<p>理解了这些之后，看矩阵求解就更容易了</p> 
<h4><a id="_1063"></a>雅可比</h4> 
<p>于是我从雅可比开始看起，主要是一开始不懂怎么乘系数</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">FdmJacobiSolver3</span><span class="token operator">::</span><span class="token function">relax</span><span class="token punctuation">(</span><span class="token keyword">const</span> FdmMatrix3<span class="token operator">&amp;</span> A<span class="token punctuation">,</span> <span class="token keyword">const</span> FdmVector3<span class="token operator">&amp;</span> b<span class="token punctuation">,</span>
                             FdmVector3<span class="token operator">*</span> x_<span class="token punctuation">,</span> FdmVector3<span class="token operator">*</span> xTemp_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Size3 size <span class="token operator">=</span> A<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FdmVector3<span class="token operator">&amp;</span> x <span class="token operator">=</span> <span class="token operator">*</span>x_<span class="token punctuation">;</span>
    FdmVector3<span class="token operator">&amp;</span> xTemp <span class="token operator">=</span> <span class="token operator">*</span>xTemp_<span class="token punctuation">;</span>

    A<span class="token punctuation">.</span><span class="token function">parallelForEachIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> r <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>right <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>right <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>j <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>up <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>up <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>front <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>front <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">xTemp</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">-</span> r<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>center<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>因为这里写的是 <code>A(i - 1, j, k)</code> 的 right 和 <code>x(i - 1, j, k)</code> 相乘，看上去好像是 i-1 和 i-1 匹配，但是看别的又不是，所以直觉上不知道怎么理解</p> 
<p>之后我觉得还是看那个系数矩阵更容易理解</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          [ 
         
         
          
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               0 
              
             
               , 
              
             
               0 
              
             
               ) 
              
             
            
           
          
          
           
            
             
            
           
           
            
            
              ⋱ 
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
             
               ( 
              
             
               0 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
               . 
              
             
               r 
              
             
               i 
              
             
               g 
              
             
               h 
              
             
               t 
              
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
            
              ⋱ 
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
               . 
              
             
               u 
              
             
               p 
              
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
            
              ⋱ 
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               0 
              
             
               ) 
              
             
               . 
              
             
               f 
              
             
               r 
              
             
               o 
              
             
               n 
              
             
               t 
              
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
               . 
              
             
               f 
              
             
               r 
              
             
               o 
              
             
               n 
              
             
               t 
              
             
            
           
           
            
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
               . 
              
             
               u 
              
             
               p 
              
             
            
           
           
            
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
               . 
              
             
               r 
              
             
               i 
              
             
               g 
              
             
               h 
              
             
               t 
              
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               2 
              
             
               ) 
              
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
            
              ⋱ 
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
             
               ( 
              
             
               1 
              
             
               , 
              
             
               2 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
            
              ⋱ 
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
             
               ( 
              
             
               2 
              
             
               , 
              
             
               1 
              
             
               , 
              
             
               1 
              
             
               ) 
              
             
            
           
          
          
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
             
            
           
           
            
            
              ⋱ 
             
            
           
          
         
        
          ] 
         
        
       
         \begin{bmatrix} (0,0,0) \\ &amp; \ddots \\ &amp; &amp; (0,1,1) &amp; &amp; &amp; &amp; &amp; (0,1,1).right \\ &amp; &amp; &amp; \ddots \\ &amp; &amp; &amp; &amp; (1,0,1) &amp; &amp; &amp; (1,0,1).up \\ &amp; &amp; &amp; &amp; &amp; \ddots \\ &amp; &amp; &amp; &amp; &amp; &amp; (1,1,0) &amp; (1,1,0).front \\ &amp; &amp; &amp; &amp; &amp; &amp; &amp; (1,1,1) &amp; (1,1,1).front &amp; &amp; (1,1,1).up &amp; &amp; (1,1,1).right \\ &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; (1,1,2) \\ &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; \ddots \\ &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; (1,2,1) \\ &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; \ddots \\ &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; (2,1,1) \\ &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; \ddots \end{bmatrix} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 16.8001em; vertical-align: -8.1501em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 8.6499em;"><span class="" style="top: -10.6499em;"><span class="pstrut" style="height: 18.8em;"></span><span class="" style="width: 0.667em; height: 16.8em;"> 
              <svg width="0.667em" height="16.800em" viewbox="0 0 667 16800"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v13200 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v13200 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.1501em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 8.65em;"><span class="" style="top: -10.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -9.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -7.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -6.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -4.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 1.19em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 7.45em;"><span class="" style="top: -9.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span class="" style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -7.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -6.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -4.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 1.19em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 6.25em;"><span class="" style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -7.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -6.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -4.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 1.19em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 6.25em;"><span class="" style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -7.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span class="" style="top: -6.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -4.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 1.19em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 6.25em;"><span class="" style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -6.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -4.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 1.19em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 6.25em;"><span class="" style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -6.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -4.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 1.19em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 6.25em;"><span class="" style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -6.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 1.19em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 6.25em;"><span class="" style="top: -8.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span></span></span><span class="" style="top: -6.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span></span></span><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 1.19em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.25em;"><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span></span></span><span class="" style="top: -1.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span><span class="" style="top: -0.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 1.19em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.25em;"><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: -0.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span class="" style="top: 1.19em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.25em;"><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span></span></span><span class="" style="top: 1.19em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.25em;"><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 2.39em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.25em;"><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span></span></span><span class="" style="top: 3.59em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist"><span class="" style="top: 4.79em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="minner">⋱</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.15em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 8.6499em;"><span class="" style="top: -10.6499em;"><span class="pstrut" style="height: 18.8em;"></span><span class="" style="width: 0.667em; height: 16.8em;"> 
              <svg width="0.667em" height="16.800em" viewbox="0 0 667 16800"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v13200 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v13200 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 8.1501em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>这样写出来就知道了……比如对于 (1,1,1)，他所在的这行，在下三角的部分有 (0,1,1).right, (1,0,1).up, (1,1,0).front，在上三角部分有 (1,1,1).front, (1,1,1).up, (1,1,1).right 对应乘哪个 x 也很清楚了</p> 
<h4><a id="_1111"></a>高斯赛德尔</h4> 
<p>高斯赛德尔的话，一开始这个 <code>parallelRangeFor</code> 还跟之前的 foreach 不一样，这个是会自己确定线程个数，然后拆分你输入的范围，拆分成各个子区域分别执行，所以回调函数里面要接受 i j k 的起始和终止范围</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">FdmGaussSeidelSolver3</span><span class="token operator">::</span><span class="token function">relax</span><span class="token punctuation">(</span><span class="token keyword">const</span> FdmMatrix3<span class="token operator">&amp;</span> A<span class="token punctuation">,</span> <span class="token keyword">const</span> FdmVector3<span class="token operator">&amp;</span> b<span class="token punctuation">,</span>
                                  <span class="token keyword">double</span> sorFactor<span class="token punctuation">,</span> FdmVector3<span class="token operator">*</span> x_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Size3 size <span class="token operator">=</span> A<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FdmVector3<span class="token operator">&amp;</span> x <span class="token operator">=</span> <span class="token operator">*</span>x_<span class="token punctuation">;</span>

    A<span class="token punctuation">.</span><span class="token function">forEachIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> r <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>right <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>right <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>j <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>up <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>up <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>front <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>front <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> sorFactor<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+</span>
                     sorFactor <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">-</span> r<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">.</span>center<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个形式虽然看上去跟雅可比没有区别，但是雅可比那里是把结果都存到 xTemp，而这里是计算完就写回 x</p> 
<p>所以就符合了公式中的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         L 
        
        
        
          x 
         
         
         
           n 
          
         
           + 
          
         
           1 
          
         
        
       
      
        Lx^{n+1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord mathnormal">L</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span> 也就是高斯赛德尔了</p> 
<p>这里还加了一个超松弛的设置，是不是因为不想再专门写一个 SOR 的类啊hhh</p> 
<p>毕竟超松弛和高斯赛德尔之间的区别就只在这个系数的话，确实这样也方便</p> 
<p>至于红黑高斯赛德尔迭代……之后再看吧</p> 
<p>其他的迭代算法也是之后再看吧</p> 
<h3><a id="GridPressureSolver_1148"></a>GridPressureSolver</h3> 
<p><code>solve</code> 函数表明了约定</p> 
<p>边界 SDF 的负值表示固体</p> 
<p>流体 SDF 的正值表示流体，负值表示空气</p> 
<p>这个约定感觉没有什么规律啊</p> 
<h4><a id="GridSinglePhasePressureSolver_1158"></a>GridSinglePhasePressureSolver</h4> 
<p>构建矩阵这里还加多了一些判断，用到了 MultiGrid 之类的</p> 
<p>跳转到 <code>buildSingleSystem</code> 才跟书上的一样了</p> 
<p>这下构造矩阵的思路跟之前那个扩散方程的系数矩阵的构建思路就一样了</p> 
<p>都是如果有上下左右的邻居的话，那么就给自己加 1</p> 
<p>同时对每一个元素都只记录 right up front 有的话就记为 -1</p> 
<p>压缩矩阵或者子网格，他们两个的矩阵构建和求解方法都跟普通的不一样</p> 
<p>普通的矩阵构建就是我上面说的，然后求解方法就是常见的那些迭代法，雅可比啊高斯赛德尔啊，共轭梯度啊</p> 
<p>然后他在最后把压力应用回速度这里，用的是加上压力梯度</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">GridSinglePhasePressureSolver3</span><span class="token operator">::</span><span class="token function">applyPressureGradient</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> FaceCenteredGrid3<span class="token operator">&amp;</span> input<span class="token punctuation">,</span> FaceCenteredGrid3<span class="token operator">*</span> output<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Size3 size <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">resolution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> u <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">uConstAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> v <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">vConstAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> w <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">wConstAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> u0 <span class="token operator">=</span> output<span class="token operator">-&gt;</span><span class="token function">uAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> v0 <span class="token operator">=</span> output<span class="token operator">-&gt;</span><span class="token function">vAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> w0 <span class="token operator">=</span> output<span class="token operator">-&gt;</span><span class="token function">wAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> x <span class="token operator">=</span> <span class="token function">pressure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Vector3D invH <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> input<span class="token punctuation">.</span><span class="token function">gridSpacing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    x<span class="token punctuation">.</span><span class="token function">parallelForEachIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_markers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> _markers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">!=</span> kBoundary<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">u0</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span>
                    <span class="token function">u</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+</span> invH<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>y <span class="token operator">&amp;&amp;</span> _markers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">!=</span> kBoundary<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">v0</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span>
                    <span class="token function">v</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+</span> invH<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>z <span class="token operator">&amp;&amp;</span> _markers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> kBoundary<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">w0</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span>
                    <span class="token function">w</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> invH<span class="token punctuation">.</span>z <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>他是在实现 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          u 
         
         
         
           n 
          
         
           + 
          
         
           1 
          
         
        
       
         = 
        
        
        
          u 
         
        
          n 
         
        
       
         − 
        
       
         Δ 
        
       
         t 
        
        
         
          
          
            ∇ 
           
          
            p 
           
          
         
           ρ 
          
         
        
       
      
        \mathbf{u}^{n+1} = \mathbf{u}^{n} - \Delta t\dfrac{\nabla p}{\rho} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord"><span class="mord mathbf">u</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7477em; vertical-align: -0.0833em;"></span><span class="mord"><span class="mord mathbf">u</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.2408em; vertical-align: -0.8804em;"></span><span class="mord">Δ</span><span class="mord mathnormal">t</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">∇</span><span class="mord mathnormal">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p> 
<p>我在想压力梯度前面不是符号吗？</p> 
<p>我觉得是因为他之前构造矩阵的时候是给所有压强前面加了一个负号的，来使得对角线元素为正。而求解的过程不变，这样的话，求解出来的压强相当于带一个额外的负号，最终应用到速度的公式中往压强前面加一个负号就可以补回来了</p> 
<p>然后之所以对于 (i,j,k) 这个点，更新的反而是 (i+1,j,k) (i,j+1,k) (i,j,k+1) 的原因，我觉得是因为计算 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ∇ 
        
       
         p 
        
       
      
        \nabla p 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord">∇</span><span class="mord mathnormal">p</span></span></span></span></span> 时候至少要用到两个点，所以最终更新速度的时候就选择了其中一个</p> 
<p>就比如说用到了 (i,j,k) 和 (i+1,j,k) 的压强，那么你可以更新 (i,j,k) 或者 (i+1,j,k) 的压强，他选择更新 (i+1,j,k)</p> 
<h4><a id="GridFractionalSinglePhasePressureSolver_1219"></a>GridFractionalSinglePhasePressureSolver</h4> 
<p>一开始就要构建权重，书上没有详细展开，其实还是有点复杂</p> 
<p>每个方向都有一套网格来存储权重</p> 
<p>对每一个方向，都要遍历权重网格，对网格的每一个单元，都要计算一次对应位置的权重</p> 
<p>计算权重的具体方法是，采样与这个速度方向垂直的四边形面上的四个顶点的 SDF 值，根据这四个值来判断这个网格被占据了多少，最终给出一个占比数字，这个数值就代表流体权重了</p> 
<p>具体权重的计算……看不懂……</p> 
<p>矩阵的计算……看不懂……</p> 
<p>他提到的这个论文 C. Batty, F. Bertails, and R. Bridson. A fast variational framework for accurate solid-fluid coupling 我去看了，将流固耦合的，说是把问题转化成了最小能量的问题</p> 
<p>说实话第一眼没看懂，上网搜的话感觉也搜不到讲解</p> 
<p>求解的时候没有变化，仍然是普通迭代，压缩矩阵，多重网格三个选择</p> 
<p>然后最终应用压强也看不懂</p> 
<h4><a id="A_Fast_Variational_Framework_for_Accurate_SolidFluid_Coupling_1241"></a>A Fast Variational Framework for Accurate Solid-Fluid Coupling</h4> 
<p>之后发现好像很多人都在用，这似乎是一个通用的方法，然后一看谷歌学术上它显示的引用数这么多，所以还是硬着头皮看下去</p> 
<h5><a id="_1245"></a>基于最小化动能的观点来解释速度投影</h5> 
<p><img src="https://images2.imgbox.com/dc/06/eNNaMScs_o.png" alt="在这里插入图片描述"></p> 
<p>别人说从能量的角度，泊松方程就是一个最小化相对于压力的动能的方程</p> 
<p>求这个最小化动能的过程，又可以理解为投影：压强求解是计算速度在无散度空间和边界条件空间的交集的投影，而投影又是一个在空间中找距离自己最近的点的过程，而如何定义这个最近的点的方法就是通过最小化动能的方法。</p> 
<p>这个问题也是拉格朗日约束问题（无散度和边界条件是约束条件？）压强就是拉格朗日约束中的乘子。</p> 
<p>感觉说的很有道理……</p> 
<h5><a id="_1257"></a>由动能最小化推出泊松方程</h5> 
<p>更新速度的公式：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           u 
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           u 
          
         
           ~ 
          
         
        
          − 
         
         
          
          
            Δ 
           
          
            t 
           
          
         
           ρ 
          
         
        
          G 
         
        
          p 
         
        
       
         \mathbf{u}^{n+1} = \widetilde{\mathbf{u}}-\dfrac{\Delta t}{\rho}\mathbf{G}\mathbf{p} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8641em;"></span><span class="mord"><span class="mord mathbf">u</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7878em; vertical-align: -0.0833em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7044em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathbf">u</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4444em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
            <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
             <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
            </svg></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.2408em; vertical-align: -0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">Gp</span></span></span></span></span></span></p> 
<p>其中 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         u 
        
       
      
        \mathbf{u} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4444em;"></span><span class="mord mathbf">u</span></span></span></span></span> 是流体速度，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ρ 
        
       
      
        \rho 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span></span> 是流体密度，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Δ 
        
       
         t 
        
       
      
        \Delta t 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span></span> 是单步时间，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         p 
        
       
      
        \mathbf{p} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.1944em;"></span><span class="mord mathbf">p</span></span></span></span></span> 是流体压强，矩阵 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         G 
        
       
      
        \mathbf{G} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6861em;"></span><span class="mord mathbf">G</span></span></span></span></span> 是压强的有限差分算子</p> 
<p>那么系统的动能可以计算为</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
             
             
               K 
              
             
               E 
              
             
            
              F 
             
             
             
               n 
              
             
               + 
              
             
               1 
              
             
            
           
          
          
           
            
             
            
              = 
             
             
             
               1 
              
             
               2 
              
             
             
             
               u 
              
              
              
                n 
               
              
                + 
               
              
                1 
               
              
             
               T 
              
             
             
             
               M 
              
             
               F 
              
             
             
             
               u 
              
              
              
                n 
               
              
                + 
               
              
                1 
               
              
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
             
             
               1 
              
             
               2 
              
             
            
              ( 
             
             
             
               u 
              
             
               ~ 
              
             
            
              − 
             
             
              
              
                Δ 
               
              
                t 
               
              
             
               ρ 
              
             
            
              G 
             
            
              p 
             
             
             
               ) 
              
             
               T 
              
             
             
             
               M 
              
             
               F 
              
             
            
              ( 
             
             
             
               u 
              
             
               ~ 
              
             
            
              − 
             
             
              
              
                Δ 
               
              
                t 
               
              
             
               ρ 
              
             
            
              G 
             
            
              p 
             
            
              ) 
             
            
           
          
         
        
       
         \begin{align*} \mathrm{KE}_F^{n+1} &amp; = \dfrac{1}{2}\mathbf{u}_{n+1}^T \mathbf{M}_F \mathbf{u}_{n+1} \\ &amp; = \dfrac{1}{2}(\widetilde{\mathbf{u}}-\dfrac{\Delta t}{\rho}\mathbf{G}\mathbf{p})^T \mathbf{M}_F (\widetilde{\mathbf{u}}-\dfrac{\Delta t}{\rho}\mathbf{G}\mathbf{p}) \end{align*} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 4.8482em; vertical-align: -2.1741em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.6741em;"><span class="" style="top: -4.713em;"><span class="pstrut" style="height: 3.3603em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">KE</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8873em;"><span class="" style="top: -2.4396em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span><span class="" style="top: -3.1362em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2604em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.3667em;"><span class="pstrut" style="height: 3.3603em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.1741em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.6741em;"><span class="" style="top: -4.713em;"><span class="pstrut" style="height: 3.3603em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathbf">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3053em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.3667em;"><span class="pstrut" style="height: 3.3603em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7044em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathbf">u</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4444em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
                    <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
                     <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
                    </svg></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">Gp</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7044em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathbf">u</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4444em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
                    <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
                     <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
                    </svg></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">Gp</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.1741em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>其中矩阵 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          M 
         
        
          F 
         
        
       
      
        \mathbf{M}_F 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8361em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 是质量对角阵</p> 
<p>因为我们已经分析出来了我们要最小化动能，所以对这个动能求最小值，就是常用的求偏导等于 0 的过程</p> 
<p>根据矩阵分析，矩阵运算中求导的规律有</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            ∂ 
           
           
           
             ( 
            
            
            
              x 
             
            
              T 
             
            
           
             A 
            
           
             x 
            
           
          
            ) 
           
          
          
          
            ∂ 
           
          
            x 
           
          
         
        
          = 
         
         
         
           x 
          
         
           T 
          
         
        
          ( 
         
        
          A 
         
        
          + 
         
         
         
           A 
          
         
           T 
          
         
        
          ) 
         
        
       
         \dfrac{\partial{(\mathbf{x}^T \mathbf{A} \mathbf{x}})}{\partial{\mathbf{x}}} = \mathbf{x}^T (\mathbf{A}+\mathbf{A}^T) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.2043em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.5183em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mord mathbf">x</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mord mathbf">Ax</span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.1413em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">A</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1413em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathbf">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            ∂ 
           
           
           
             ( 
            
           
             A 
            
           
             x 
            
           
          
            ) 
           
          
          
          
            ∂ 
           
          
            x 
           
          
         
        
          = 
         
        
          A 
         
        
       
         \dfrac{\partial{(\mathbf{A} \mathbf{x}})}{\partial{\mathbf{x}}} = \mathbf{A} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.113em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mord mathbf">x</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mopen">(</span><span class="mord mathbf">Ax</span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6861em;"></span><span class="mord mathbf">A</span></span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            ∂ 
           
           
           
             ( 
            
            
            
              x 
             
            
              T 
             
            
           
             A 
            
           
             x 
            
           
          
            ) 
           
          
          
          
            ∂ 
           
          
            z 
           
          
         
        
          = 
         
         
         
           x 
          
         
           T 
          
         
        
          ( 
         
        
          A 
         
        
          + 
         
         
         
           A 
          
         
           T 
          
         
        
          ) 
         
         
          
          
            ∂ 
           
          
            x 
           
          
          
          
            ∂ 
           
          
            z 
           
          
         
        
       
         \dfrac{\partial{(\mathbf{x}^T \mathbf{A} \mathbf{x}})}{\partial{\mathbf{z}}} = \mathbf{x}^T (\mathbf{A}+\mathbf{A}^T)\dfrac{\partial\mathbf{x}}{\partial\mathbf{z}} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.2043em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.5183em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mord mathbf">z</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mord mathbf">Ax</span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.1413em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">A</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.0574em; vertical-align: -0.686em;"></span><span class="mord"><span class="mord mathbf">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3714em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord mathbf">z</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord mathbf">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p>其中 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
         , 
        
       
         z 
        
       
      
        \mathbf{x},\mathbf{z} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.1944em;"></span><span class="mord mathbf">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathbf">z</span></span></span></span></span> 是 n*1 列向量，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         A 
        
       
      
        \mathbf{A} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6861em;"></span><span class="mord mathbf">A</span></span></span></span></span> 是 n*n 矩阵</p> 
<p>那么动能的偏导为 0 即</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
             
             
               ∂ 
              
              
               
               
                 K 
                
               
                 E 
                
               
              
                F 
               
               
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
              
             
             
             
               ∂ 
              
             
               p 
              
             
            
           
          
          
           
            
             
            
              = 
             
             
              
              
                ∂ 
               
               
                
                
                  K 
                 
                
                  E 
                 
                
               
                 F 
                
                
                
                  n 
                 
                
                  + 
                 
                
                  1 
                 
                
               
              
              
              
                ∂ 
               
               
               
                 ( 
                
                
                
                  u 
                 
                
                  ~ 
                 
                
               
                 − 
                
                
                 
                 
                   Δ 
                  
                 
                   t 
                  
                 
                
                  ρ 
                 
                
               
                 G 
                
               
                 p 
                
               
                 ) 
                
               
              
             
             
              
              
                ∂ 
               
               
               
                 ( 
                
                
                
                  u 
                 
                
                  ~ 
                 
                
               
                 − 
                
                
                 
                 
                   Δ 
                  
                 
                   t 
                  
                 
                
                  ρ 
                 
                
               
                 G 
                
               
                 p 
                
               
                 ) 
                
               
              
              
              
                ∂ 
               
              
                p 
               
              
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
             
             
               1 
              
             
               2 
              
             
            
              ( 
             
             
             
               u 
              
             
               ~ 
              
             
            
              − 
             
             
              
              
                Δ 
               
              
                t 
               
              
             
               ρ 
              
             
            
              G 
             
            
              p 
             
             
             
               ) 
              
             
               T 
              
             
            
              ( 
             
             
             
               M 
              
             
               F 
              
             
            
              + 
             
             
             
               M 
              
             
               F 
              
             
               T 
              
             
            
              ) 
             
            
              ( 
             
            
              − 
             
             
              
              
                Δ 
               
              
                t 
               
              
             
               ρ 
              
             
            
              G 
             
            
              ) 
             
            
           
          
         
        
       
         \begin{align*} \dfrac{\partial{\mathrm{KE}_F^{n+1}}}{\partial{\mathbf{p}}} &amp; = \dfrac{\partial{\mathrm{KE}_F^{n+1}}}{\partial{(\widetilde{\mathbf{u}}-\dfrac{\Delta t}{\rho}\mathbf{G}\mathbf{p})}}\dfrac{\partial{(\widetilde{\mathbf{u}}-\dfrac{\Delta t}{\rho}\mathbf{G}\mathbf{p})}}{\partial{\mathbf{p}}} \\ &amp; = \dfrac{1}{2}(\widetilde{\mathbf{u}}-\dfrac{\Delta t}{\rho}\mathbf{G}\mathbf{p})^T(\mathbf{M}_F + \mathbf{M}_F^T)(-\dfrac{\Delta t}{\rho}\mathbf{G}) \end{align*} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 7.6023em; vertical-align: -3.5512em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.0512em;"><span class="" style="top: -6.0512em;"><span class="pstrut" style="height: 4.6308em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.5643em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mord mathbf">p</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">KE</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8873em;"><span class="" style="top: -2.4396em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span><span class="" style="top: -3.1362em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2604em;"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class="" style="top: -2.2601em;"><span class="pstrut" style="height: 4.6308em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 3.5512em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.0512em;"><span class="" style="top: -6.0512em;"><span class="pstrut" style="height: 4.6308em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.5643em;"><span class="" style="top: -2.11em;"><span class="pstrut" style="height: 3.3603em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7044em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathbf">u</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4444em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
                            <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
                             <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
                            </svg></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">Gp</span><span class="mclose">)</span></span></span></span><span class="" style="top: -3.5903em;"><span class="pstrut" style="height: 3.3603em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -4.0373em;"><span class="pstrut" style="height: 3.3603em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">KE</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8873em;"><span class="" style="top: -2.4396em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span><span class="" style="top: -3.1362em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2604em;"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.1308em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.6308em;"><span class="" style="top: -2.6743em;"><span class="pstrut" style="height: 3.3603em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mord mathbf">p</span></span></span></span><span class="" style="top: -3.5903em;"><span class="pstrut" style="height: 3.3603em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -4.6308em;"><span class="pstrut" style="height: 3.3603em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7044em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathbf">u</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4444em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
                            <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
                             <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
                            </svg></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">Gp</span><span class="mclose">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class="" style="top: -2.2601em;"><span class="pstrut" style="height: 4.6308em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7044em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathbf">u</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4444em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
                    <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
                     <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
                    </svg></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">Gp</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">G</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 3.5512em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>因为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          M 
         
        
          F 
         
        
       
      
        \mathbf{M}_F 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8361em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 是对角阵，所以 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          M 
         
        
          F 
         
        
       
         = 
        
        
        
          M 
         
        
          F 
         
        
          T 
         
        
       
      
        \mathbf{M}_F = \mathbf{M}_F^T 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8361em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.1167em; vertical-align: -0.2753em;"></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -2.4247em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2753em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，所以原式变为</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            ∂ 
           
           
            
            
              K 
             
            
              E 
             
            
           
             F 
            
            
            
              n 
             
            
              + 
             
            
              1 
             
            
           
          
          
          
            ∂ 
           
          
            p 
           
          
         
        
          = 
         
        
          ( 
         
         
         
           u 
          
         
           ~ 
          
         
        
          − 
         
         
          
          
            Δ 
           
          
            t 
           
          
         
           ρ 
          
         
        
          G 
         
        
          p 
         
         
         
           ) 
          
         
           T 
          
         
         
         
           M 
          
         
           F 
          
         
        
          ( 
         
        
          − 
         
         
          
          
            Δ 
           
          
            t 
           
          
         
           ρ 
          
         
        
          G 
         
        
          ) 
         
        
          = 
         
        
          0 
         
        
       
         \dfrac{\partial{\mathrm{KE}_F^{n+1}}}{\partial{\mathbf{p}}} = (\widetilde{\mathbf{u}}-\dfrac{\Delta t}{\rho}\mathbf{G}\mathbf{p})^T \mathbf{M}_F (-\dfrac{\Delta t}{\rho}\mathbf{G}) = 0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.4448em; vertical-align: -0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.5643em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mord mathbf">p</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord" style="margin-right: 0.0556em;">∂</span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathrm">KE</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8873em;"><span class="" style="top: -2.4396em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span><span class="" style="top: -3.1362em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2604em;"><span class=""></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7044em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathbf">u</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4444em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
            <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
             <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
            </svg></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.2408em; vertical-align: -0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">Gp</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">G</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span></span></p> 
<p>化简得</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
         
         
           u 
          
         
           ~ 
          
         
        
          − 
         
         
          
          
            Δ 
           
          
            t 
           
          
         
           ρ 
          
         
        
          G 
         
        
          p 
         
         
         
           ) 
          
         
           T 
          
         
         
         
           M 
          
         
           F 
          
         
        
          G 
         
        
          = 
         
        
          0 
         
        
       
         (\widetilde{\mathbf{u}}-\dfrac{\Delta t}{\rho}\mathbf{G}\mathbf{p})^T \mathbf{M}_F \mathbf{G} = 0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7044em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathbf">u</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4444em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
            <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
             <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
            </svg></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.2408em; vertical-align: -0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">Gp</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathbf">G</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span></span></p> 
<p>两边同时转置，得</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           G 
          
         
           T 
          
         
         
         
           M 
          
         
           F 
          
         
        
          ( 
         
         
         
           u 
          
         
           ~ 
          
         
        
          − 
         
         
          
          
            Δ 
           
          
            t 
           
          
         
           ρ 
          
         
        
          G 
         
        
          p 
         
        
          ) 
         
        
          = 
         
        
          0 
         
        
       
         \mathbf{G}^T \mathbf{M}_F (\widetilde{\mathbf{u}}-\dfrac{\Delta t}{\rho}\mathbf{G}\mathbf{p}) = 0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1413em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathbf">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7044em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathbf">u</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4444em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
            <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
             <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
            </svg></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.2408em; vertical-align: -0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">Gp</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span></span></p> 
<p>拆开括号，得</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           G 
          
         
           T 
          
         
         
         
           M 
          
         
           F 
          
         
         
         
           u 
          
         
           ~ 
          
         
        
          − 
         
         
         
           G 
          
         
           T 
          
         
         
         
           M 
          
         
           F 
          
         
         
          
          
            Δ 
           
          
            t 
           
          
         
           ρ 
          
         
        
          G 
         
        
          p 
         
        
          = 
         
        
          0 
         
        
       
         \mathbf{G}^T \mathbf{M}_F \widetilde{\mathbf{u}}- \mathbf{G}^T \mathbf{M}_F \dfrac{\Delta t}{\rho}\mathbf{G}\mathbf{p}= 0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0413em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathbf">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7044em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathbf">u</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4444em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
            <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
             <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
            </svg></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.2408em; vertical-align: -0.8804em;"></span><span class="mord"><span class="mord mathbf">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathbf">Gp</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span></span></p> 
<p>再整理，就是论文中的式 (6)</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            Δ 
           
          
            t 
           
          
          
          
            ρ 
           
          
            2 
           
          
         
         
         
           G 
          
         
           T 
          
         
         
         
           M 
          
         
           F 
          
         
        
          G 
         
        
          p 
         
        
          = 
         
         
         
           1 
          
         
           ρ 
          
         
         
         
           G 
          
         
           T 
          
         
         
         
           M 
          
         
           F 
          
         
         
         
           u 
          
         
           ~ 
          
         
        
       
         \dfrac{\Delta t}{\rho^2} \mathbf{G}^T \mathbf{M}_F \mathbf{G}\mathbf{p} = \dfrac{1}{\rho}\mathbf{G}^T \mathbf{M}_F \widetilde{\mathbf{u}} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.2408em; vertical-align: -0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathbf">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathbf">Gp</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.2019em; vertical-align: -0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathbf">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7044em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathbf">u</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4444em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
            <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
             <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
            </svg></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>这就是一种，带上了质量的泊松方程？</p> 
<p>但是论文怎么直接从 (6) 式得到这个 (7) 式的，感觉很跳跃</p> 
<p><img src="https://images2.imgbox.com/2e/ad/135ZqZRX_o.png" alt="在这里插入图片描述"></p> 
<p>感觉他没有解释清楚这个差分算子 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         G 
        
       
      
        \mathbf{G} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6861em;"></span><span class="mord mathbf">G</span></span></span></span></span> 和这个质量矩阵 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          M 
         
        
          F 
         
        
       
      
        \mathbf{M}_F 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8361em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 的意义</p> 
<p>因为现在我感觉质量矩阵 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          M 
         
        
          F 
         
        
       
      
        \mathbf{M}_F 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8361em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 中的元素就是定义在面上了，但是压强还是定义在网格中心的。然后 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         G 
        
       
      
        \mathbf{G} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6861em;"></span><span class="mord mathbf">G</span></span></span></span></span> 又能直接适用于这两个定义在不同位置的物理量？</p> 
<p>如果你说 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         G 
        
       
      
        \mathbf{G} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6861em;"></span><span class="mord mathbf">G</span></span></span></span></span> 就是跟我之前那种简单的泊松方程里面的系数矩阵一样的矩阵的话，那倒是可以稍微理解一点</p> 
<p>比如 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         G 
        
       
         p 
        
       
         = 
        
        
        
          [ 
         
         
          
           
            
            
              2 
             
            
           
           
            
             
             
               − 
              
             
               1 
              
             
            
           
          
          
           
            
             
             
               − 
              
             
               1 
              
             
            
           
           
            
            
              2 
             
            
           
          
         
        
          ] 
         
        
        
        
          [ 
         
         
          
           
            
             
             
               p 
              
             
               0 
              
             
            
           
          
          
           
            
             
             
               p 
              
             
               1 
              
             
            
           
          
         
        
          ] 
         
        
       
      
        \mathbf{G}\mathbf{p} = \begin{bmatrix} 2 &amp; -1 \\ -1 &amp; 2 \end{bmatrix}\begin{bmatrix} p_0 \\ p_1 \end{bmatrix} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8805em; vertical-align: -0.1944em;"></span><span class="mord mathbf">Gp</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         G 
        
        
        
          M 
         
        
          F 
         
        
       
         = 
        
        
        
          [ 
         
         
          
           
            
            
              2 
             
            
           
           
            
             
             
               − 
              
             
               1 
              
             
            
           
          
          
           
            
             
             
               − 
              
             
               1 
              
             
            
           
           
            
            
              2 
             
            
           
          
         
        
          ] 
         
        
        
        
          [ 
         
         
          
           
            
             
             
               m 
              
             
               0 
              
             
            
           
          
          
           
            
             
             
               m 
              
             
               1 
              
             
            
           
          
         
        
          ] 
         
        
       
      
        \mathbf{G}\mathbf{M}_F = \begin{bmatrix} 2 &amp; -1 \\ -1 &amp; 2 \end{bmatrix}\begin{bmatrix} m_0 \\ m_1 \end{bmatrix} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8361em; vertical-align: -0.15em;"></span><span class="mord mathbf">G</span><span class="mord"><span class="mord mathbf">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.45em;"><span class="" style="top: -3.61em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.95em;"><span class=""></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p> 
<p>然后对于点 (i,j,k) 压强的 (i+1,j,k) 对应质量的 (i+1/2,j,k) ，速度的 (i+1/2,j,k) 对应质量的 (i+1/2,j,k)</p> 
<p>他论文这个公式 (7) 也是把系数矩阵中的负号提到了右边，使得系数矩阵中的对角线上的元素为正</p> 
<p>所以我们可以延续 <code>GridSinglePhasePressureSolver</code> 中的操作</p> 
<p>虽然我觉得 <code>buildSingleSystem</code> 中的 <code>term</code> 是比较符合论文中的公式的</p> 
<h5><a id="_1347"></a>边界处压强的计算？</h5> 
<p>但是他这个在边界处的处理为什么是算一个分数 <code>theta</code> 然后再去除，有点不理解</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    term <span class="token operator">=</span> <span class="token function">uWeights</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> invHSqr<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">double</span> rightPhi <span class="token operator">=</span> <span class="token function">fluidSdf</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInsideSdf</span><span class="token punctuation">(</span>rightPhi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        row<span class="token punctuation">.</span>center <span class="token operator">+=</span> term<span class="token punctuation">;</span>
        row<span class="token punctuation">.</span>right <span class="token operator">-=</span> term<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> theta <span class="token operator">=</span> <span class="token function">fractionInsideSdf</span><span class="token punctuation">(</span>centerPhi<span class="token punctuation">,</span> rightPhi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        theta <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span>theta<span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        row<span class="token punctuation">.</span>center <span class="token operator">+=</span> term <span class="token operator">/</span> theta<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+=</span>
        <span class="token function">uWeights</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> input<span class="token punctuation">.</span><span class="token function">u</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> invH<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">(</span><span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+=</span> input<span class="token punctuation">.</span><span class="token function">u</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> invH<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    term <span class="token operator">=</span> <span class="token function">uWeights</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> invHSqr<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">double</span> leftPhi <span class="token operator">=</span> <span class="token function">fluidSdf</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInsideSdf</span><span class="token punctuation">(</span>leftPhi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        row<span class="token punctuation">.</span>center <span class="token operator">+=</span> term<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> theta <span class="token operator">=</span> <span class="token function">fractionInsideSdf</span><span class="token punctuation">(</span>centerPhi<span class="token punctuation">,</span> leftPhi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        theta <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span>theta<span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        row<span class="token punctuation">.</span>center <span class="token operator">+=</span> term <span class="token operator">/</span> theta<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">-=</span> <span class="token function">uWeights</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> input<span class="token punctuation">.</span><span class="token function">u</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> invH<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">(</span><span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">-=</span> input<span class="token punctuation">.</span><span class="token function">u</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> invH<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>我觉得唯一相关的就是论文中提到的对于自由面使用了二阶虚压强边界条件</p> 
<p>我记得我看 Fluid Simulation For Computer Graphics 的时候记了对于自由面的处理</p> 
<p>假设 (i,j,k) 是流体，(i+1,j,k) 是空气，那么设空气的位置的压强为虚压强 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          p 
         
         
         
           i 
          
         
           + 
          
         
           1 
          
         
           , 
          
         
           j 
          
         
           , 
          
         
           k 
          
         
        
          G 
         
        
       
      
        p^G_{i+1,j,k} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.2605em; vertical-align: -0.4192em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -2.4169em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">G</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4192em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p>那么这两个位置的压强之间应该满足自由面上的压强为 0 的条件</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          1 
         
        
          − 
         
        
          θ 
         
        
          ) 
         
         
         
           p 
          
          
          
            i 
           
          
            , 
           
          
            j 
           
          
            , 
           
          
            k 
           
          
         
        
          + 
         
        
          θ 
         
         
         
           p 
          
          
          
            i 
           
          
            + 
           
          
            1 
           
          
            , 
           
          
            j 
           
          
            , 
           
          
            k 
           
          
         
           G 
          
         
        
          = 
         
        
          0 
         
        
       
         (1-\theta)p_{i,j,k}+\theta p^G_{i+1,j,k} = 0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.2744em; vertical-align: -0.3831em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">G</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3831em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span></span></p> 
<p>使用 SDF 来衡量两者对于边界的距离，可以算出系数 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         θ 
        
       
      
        \theta 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          θ 
         
        
          = 
         
         
          
          
            ϕ 
           
           
           
             i 
            
           
             , 
            
           
             j 
            
           
             , 
            
           
             k 
            
           
          
          
           
           
             ϕ 
            
            
            
              i 
             
            
              , 
             
            
              j 
             
            
              , 
             
            
              k 
             
            
           
          
            − 
           
           
           
             ϕ 
            
            
            
              i 
             
            
              + 
             
            
              1 
             
            
              , 
             
            
              j 
             
            
              , 
             
            
              k 
             
            
           
          
         
        
       
         \theta = \dfrac{\phi_{i,j,k}}{\phi_{i,j,k} - \phi_{i+1,j,k}} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.3435em; vertical-align: -0.9721em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3714em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.9721em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p>解得 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          p 
         
         
         
           i 
          
         
           + 
          
         
           1 
          
         
           , 
          
         
           j 
          
         
           , 
          
         
           k 
          
         
        
          G 
         
        
       
      
        p^G_{i+1,j,k} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.2605em; vertical-align: -0.4192em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -2.4169em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">G</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4192em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           p 
          
          
          
            i 
           
          
            + 
           
          
            1 
           
          
            , 
           
          
            j 
           
          
            , 
           
          
            k 
           
          
         
           G 
          
         
        
          = 
         
         
          
          
            ( 
           
          
            θ 
           
          
            − 
           
          
            1 
           
          
            ) 
           
           
           
             p 
            
            
            
              i 
             
            
              , 
             
            
              j 
             
            
              , 
             
            
              k 
             
            
           
          
         
           θ 
          
         
        
       
         p^G_{i+1,j,k} = \dfrac{(\theta-1)p_{i,j,k}}{\theta} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.2744em; vertical-align: -0.3831em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">G</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3831em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.113em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p>如果应用压强的更新式是</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           u 
          
          
          
            i 
           
          
            + 
           
          
            1 
           
          
            / 
           
          
            2 
           
          
            , 
           
          
            j 
           
          
            , 
           
          
            k 
           
          
          
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          = 
         
         
         
           u 
          
          
          
            i 
           
          
            + 
           
          
            1 
           
          
            / 
           
          
            2 
           
          
            , 
           
          
            j 
           
          
            , 
           
          
            k 
           
          
         
        
          − 
         
         
          
          
            Δ 
           
          
            t 
           
          
          
          
            ρ 
           
           
           
             i 
            
           
             + 
            
           
             1 
            
           
             / 
            
           
             2 
            
           
             , 
            
           
             j 
            
           
             , 
            
           
             k 
            
           
          
         
         
          
           
           
             p 
            
            
            
              i 
             
            
              + 
             
            
              1 
             
            
              , 
             
            
              j 
             
            
              , 
             
            
              k 
             
            
           
          
            − 
           
           
           
             p 
            
            
            
              i 
             
            
              , 
             
            
              j 
             
            
              , 
             
            
              k 
             
            
           
          
          
          
            Δ 
           
          
            x 
           
          
         
        
       
         u_{i+1/2,j,k}^{n+1} = u_{i+1/2,j,k} - \dfrac{\Delta t}{\rho_{i+1/2,j,k}}\dfrac{p_{i+1,j,k}-p_{i,j,k}}{\Delta x} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.3694em; vertical-align: -0.5053em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.3697em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1/2</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.5053em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9385em; vertical-align: -0.3552em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.5198em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1/2</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.4015em; vertical-align: -1.0412em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.5198em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1/2</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.0412em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.2603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">x</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p>代入得</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
            
              u 
             
             
             
               i 
              
             
               + 
              
             
               1 
              
             
               / 
              
             
               2 
              
             
               , 
              
             
               j 
              
             
               , 
              
             
               k 
              
             
             
             
               n 
              
             
               + 
              
             
               1 
              
             
            
           
          
          
           
            
             
            
              = 
             
             
             
               u 
              
              
              
                i 
               
              
                + 
               
              
                1 
               
              
                / 
               
              
                2 
               
              
                , 
               
              
                j 
               
              
                , 
               
              
                k 
               
              
             
            
              − 
             
             
              
              
                Δ 
               
              
                t 
               
              
              
              
                ρ 
               
               
               
                 i 
                
               
                 + 
                
               
                 1 
                
               
                 / 
                
               
                 2 
                
               
                 , 
                
               
                 j 
                
               
                 , 
                
               
                 k 
                
               
              
             
             
              
               
                
                
                  ( 
                 
                
                  θ 
                 
                
                  − 
                 
                
                  1 
                 
                
                  ) 
                 
                 
                 
                   p 
                  
                  
                  
                    i 
                   
                  
                    , 
                   
                  
                    j 
                   
                  
                    , 
                   
                  
                    k 
                   
                  
                 
                
               
                 θ 
                
               
              
                − 
               
               
               
                 p 
                
                
                
                  i 
                 
                
                  , 
                 
                
                  j 
                 
                
                  , 
                 
                
                  k 
                 
                
               
              
              
              
                Δ 
               
              
                x 
               
              
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
             
             
               u 
              
              
              
                i 
               
              
                + 
               
              
                1 
               
              
                / 
               
              
                2 
               
              
                , 
               
              
                j 
               
              
                , 
               
              
                k 
               
              
             
            
              + 
             
             
              
              
                Δ 
               
              
                t 
               
              
             
               ρ 
              
             
             
             
               1 
              
             
               θ 
              
             
             
              
              
                p 
               
               
               
                 i 
                
               
                 , 
                
               
                 j 
                
               
                 , 
                
               
                 k 
                
               
              
              
              
                Δ 
               
              
                x 
               
              
             
            
           
          
         
        
       
         \begin{align*} u_{i+1/2,j,k}^{n+1} &amp; = u_{i+1/2,j,k} - \dfrac{\Delta t}{\rho_{i+1/2,j,k}}\dfrac{\dfrac{(\theta-1)p_{i,j,k}}{\theta}-p_{i,j,k}}{\Delta x} \\ &amp; = u_{i+1/2,j,k} + \dfrac{\Delta t}{\rho}\dfrac{1}{\theta}\dfrac{p_{i,j,k}}{\Delta x} \end{align*} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 6.385em; vertical-align: -2.9425em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.4425em;"><span class="" style="top: -5.4425em;"><span class="pstrut" style="height: 4.503em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.3697em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1/2</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.5053em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -2.741em;"><span class="pstrut" style="height: 4.503em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.9425em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.4425em;"><span class="" style="top: -5.4425em;"><span class="pstrut" style="height: 4.503em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.5198em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1/2</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.5198em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1/2</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.0412em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.503em;"><span class="" style="top: -2.741em;"><span class="pstrut" style="height: 3.427em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">x</span></span></span><span class="" style="top: -3.657em;"><span class="pstrut" style="height: 3.427em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -4.503em;"><span class="pstrut" style="height: 3.427em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class="" style="top: -2.741em;"><span class="pstrut" style="height: 4.503em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.5198em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1/2</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">ρ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.1076em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathnormal">x</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.9425em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>但是我现在看他这个构建矩阵的时候，比如考虑右侧，给 center 加上了 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          m 
         
         
         
           i 
          
         
           + 
          
         
           1 
          
         
           / 
          
         
           2 
          
         
           , 
          
         
           j 
          
         
           , 
          
         
           k 
          
         
        
       
         / 
        
       
         Δ 
        
        
        
          x 
         
        
          2 
         
        
       
         / 
        
       
         θ 
        
       
      
        m_{i+1/2,j,k} / \Delta x^2 / \theta 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1693em; vertical-align: -0.3552em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.5198em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1/2</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span class=""></span></span></span></span></span></span><span class="mord">/Δ</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span></span></span></span></span>，这个跟我所知道的虚压强的式子有一点相似，但是好像又不是</p> 
<p>然后他应用梯度也是莫名其妙的</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> _uWeights<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token function">isInsideSdf</span><span class="token punctuation">(</span>centerPhi<span class="token punctuation">)</span> <span class="token operator">||</span>
     <span class="token function">isInsideSdf</span><span class="token punctuation">(</span>_fluidSdf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">double</span> rightPhi <span class="token operator">=</span> _fluidSdf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> theta <span class="token operator">=</span> <span class="token function">fractionInsideSdf</span><span class="token punctuation">(</span>centerPhi<span class="token punctuation">,</span> rightPhi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    theta <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span>theta<span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">u0</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token function">u</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">+</span> invH<span class="token punctuation">.</span>x <span class="token operator">/</span> theta <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">x</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>假设什么都不想的话，他似乎就是在正常的公式上，遇到边界的时候除以一个 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         θ 
        
       
      
        \theta 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span></span></span></span></span></p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         θ 
        
       
      
        \theta 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span></span></span></span></span> 的最小值限制为 0.01</p> 
<p>原论文发布的程序就是这样，会除以这个 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         θ 
        
       
      
        \theta 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span></span></span></span></span> 的，我觉得是不是 Fluid Engine Development 就直接把他抄过来了</p> 
<p>算了，不管了</p> 
<h3><a id="GridBoundaryConditionSolver_1441"></a>GridBoundaryConditionSolver</h3> 
<p>因为 <code>GridFractionalSinglePhasePressureSolver</code> 建议的 <code>GridBoundaryConditionSolver</code> 是 <code>GridFractionalBoundaryConditionSolver3</code>，所以我在想会不会那个论文我有遗漏的地方，所以看了一下这个边界条件求解器的代码</p> 
<p>之后发现 <code>GridFractionalBoundaryConditionSolver3</code> 跟那个论文的关系似乎不大？</p> 
<p><code>GridBlockedBoundaryConditionSolver3</code> 是简单的边界处理，首先有一个标记数组，标记哪个网格是固体哪个是液体。对于每一个固体，查找他上下左右前后是否是液体，如果是的话，就给这个液体邻居赋自己在这个轴的方向上的速度</p> 
<pre><code class="prism language-cpp">_marker<span class="token punctuation">.</span><span class="token function">forEachIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_marker</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kCollider<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">_marker</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Vector3D colliderVel <span class="token operator">=</span> <span class="token function">collider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">velocityAt</span><span class="token punctuation">(</span><span class="token function">uPos</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">u</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> colliderVel<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> size<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">_marker</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">==</span> kFluid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Vector3D colliderVel
                <span class="token operator">=</span> <span class="token function">collider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">velocityAt</span><span class="token punctuation">(</span><span class="token function">uPos</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">u</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> colliderVel<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>但是 <code>GridFractionalBoundaryConditionSolver3</code> 就复杂很多了</p> 
<p>首先先根据碰撞体 SDF 值判断 (i,j,k) 在三个方向上是不是固体。具体的来说，要取网格在这个方向的两个面上的中点处的碰撞体 SDF 值。只有两个点都在碰撞体内时，才把 markder 置为 0，并且赋碰撞体的速度，其他情况都判断为流体</p> 
<pre><code class="prism language-cpp"><span class="token comment">// Assign collider's velocity first and initialize markers</span>
velocity<span class="token operator">-&gt;</span><span class="token function">parallelForEachUIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Vector3D pt <span class="token operator">=</span> <span class="token function">uPos</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> phi0 <span class="token operator">=</span> _colliderSdf<span class="token operator">-&gt;</span><span class="token function">sample</span><span class="token punctuation">(</span>pt <span class="token operator">-</span> <span class="token function">Vector3D</span><span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token operator">*</span> h<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> phi1 <span class="token operator">=</span> _colliderSdf<span class="token operator">-&gt;</span><span class="token function">sample</span><span class="token punctuation">(</span>pt <span class="token operator">+</span> <span class="token function">Vector3D</span><span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token operator">*</span> h<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> frac <span class="token operator">=</span> <span class="token function">fractionInsideSdf</span><span class="token punctuation">(</span>phi0<span class="token punctuation">,</span> phi1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    frac <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token function">clamp</span><span class="token punctuation">(</span>frac<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>frac <span class="token operator">&gt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">uMarker</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        Vector3D colliderVel <span class="token operator">=</span> <span class="token function">collider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">velocityAt</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">u</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> colliderVel<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token function">uMarker</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>因为要满足自由滑行条件，所以要外插速度到固体内，这里就用到了刚刚判断过的 markder 数组</p> 
<pre><code class="prism language-cpp"><span class="token comment">// Free-slip: Extrapolate fluid velocity into the collider</span>
<span class="token function">extrapolateToRegion</span><span class="token punctuation">(</span>
    velocity<span class="token operator">-&gt;</span><span class="token function">uConstAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uMarker<span class="token punctuation">,</span> extrapolationDepth<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">extrapolateToRegion</span><span class="token punctuation">(</span>
    velocity<span class="token operator">-&gt;</span><span class="token function">vConstAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vMarker<span class="token punctuation">,</span> extrapolationDepth<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">extrapolateToRegion</span><span class="token punctuation">(</span>
    velocity<span class="token operator">-&gt;</span><span class="token function">wConstAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wMarker<span class="token punctuation">,</span> extrapolationDepth<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我觉得之所以外插也有一部分原因是为了满足半拉格朗日法的后向追踪的需求，如果他追踪到了故体内的速度，这个速度也应该是正确的外插之后的速度</p> 
<p>而要使得速度满足只剩下切线方向的话，还需要进一步操作</p> 
<p>接下来就是获取切线方向的速度，加上碰撞体的速度，就是边界的速度</p> 
<pre><code class="prism language-cpp"><span class="token comment">// No-flux: project the extrapolated velocity to the collider's surface</span>
<span class="token comment">// normal</span>
velocity<span class="token operator">-&gt;</span><span class="token function">parallelForEachUIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Vector3D pt <span class="token operator">=</span> <span class="token function">uPos</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInsideSdf</span><span class="token punctuation">(</span>_colliderSdf<span class="token operator">-&gt;</span><span class="token function">sample</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Vector3D colliderVel <span class="token operator">=</span> <span class="token function">collider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">velocityAt</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Vector3D vel <span class="token operator">=</span> velocity<span class="token operator">-&gt;</span><span class="token function">sample</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Vector3D g <span class="token operator">=</span> _colliderSdf<span class="token operator">-&gt;</span><span class="token function">gradient</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">lengthSquared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Vector3D n <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Vector3D velr <span class="token operator">=</span> vel <span class="token operator">-</span> colliderVel<span class="token punctuation">;</span>
            Vector3D velt <span class="token operator">=</span> <span class="token function">projectAndApplyFriction</span><span class="token punctuation">(</span>
                velr<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token function">collider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">frictionCoefficient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Vector3D velp <span class="token operator">=</span> velt <span class="token operator">+</span> colliderVel<span class="token punctuation">;</span>
            <span class="token function">uTemp</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> velp<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">uTemp</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> colliderVel<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">uTemp</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">u</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>一开始让我迷惑的是，他为什么要把 project 投影 理解成求垂向分量而不是切向分量</p> 
<p>在这个注释里面，写的是进行 project</p> 
<p>然后函数名写的也是 <code>projectAndApplyFriction</code>，变量名 <code>velt</code> 也是按照切向来命名</p> 
<p>这个函数内部获取垂向分量的函数名也是 <code>projected</code>，变量名 <code>velt</code> 也是按照切向来命名</p> 
<pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span>size_t N<span class="token operator">&gt;</span>
<span class="token keyword">inline</span> Vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> N<span class="token operator">&gt;</span> <span class="token function">projectAndApplyFriction</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> Vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> N<span class="token operator">&gt;</span><span class="token operator">&amp;</span> vel<span class="token punctuation">,</span>
    <span class="token keyword">const</span> Vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> N<span class="token operator">&gt;</span><span class="token operator">&amp;</span> normal<span class="token punctuation">,</span>
    <span class="token keyword">double</span> frictionCoefficient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> N<span class="token operator">&gt;</span> velt <span class="token operator">=</span> vel<span class="token punctuation">.</span><span class="token function">projected</span><span class="token punctuation">(</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>velt<span class="token punctuation">.</span><span class="token function">lengthSquared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> veln <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">-</span>vel<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        velt <span class="token operator">*=</span> std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> frictionCoefficient <span class="token operator">*</span> veln <span class="token operator">/</span> velt<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> velt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>等到 <code>projected</code> 内部写的就真的是获取垂向分量了</p> 
<pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
Vector<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">Vector</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">projected</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> normal<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// this - this.n n</span>
    <span class="token keyword">return</span> <span class="token function">sub</span><span class="token punctuation">(</span>normal<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>之后我才反应过来，这里是获取的法向量的垂向分量</p> 
<p>所以其实就是获取切向分量</p> 
<p>所以这个函数名还真的没有起错，投影是为了投影到切向分量上去，但是输入的只有法向量，所以获取某向量相对于一个给定法向量的垂向分量就是投影到切向</p> 
<p>其实他一开始把梯度输入到 project 函数里面我就应该反应到不对了</p> 
<p>现在理解了，为什么要输入梯度，因为要把梯度作为垂向，去求速度在切向上的投影</p> 
<p>求出来了之后加上碰撞体的速度就是边界的绝对速度</p> 
<p>如果梯度的长度为 0，说明 SDF 域在这一点是均匀的，一个均匀的碰撞体 SDF 表示了这是在碰撞体内部，所以现在速度只有碰撞体的速度</p> 
<p>因为算切向速度的时候需要从速度场采样，所以算出来的，边界上的，被修正到只剩下切向速度的速度，在算的时候不能直接赋给数组，这样会破坏旧值的物理意义</p> 
<p>所以用了 temp 来存，算完之后再把 temp 赋值回去</p> 
<pre><code class="prism language-cpp"><span class="token comment">// Transfer results</span>
u<span class="token punctuation">.</span><span class="token function">parallelForEachIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">u</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">uTemp</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
v<span class="token punctuation">.</span><span class="token function">parallelForEachIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">v</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">vTemp</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
w<span class="token punctuation">.</span><span class="token function">parallelForEachIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">w</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">wTemp</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>最后就是判断模拟域的边界上速度是否要钳制到 0</p> 
<pre><code class="prism language-cpp"><span class="token comment">// No-flux: Project velocity on the domain boundary if closed</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">closedDomainBoundaryFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> kDirectionLeft<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> u<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z<span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> u<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">u</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>总的来说看得很爽……虽然原理简单，但是还是需要理解代码的</p> 
<p>那么到现在的话，普通的基于网格的计算方法就算是看完了，不考虑压缩矩阵和多重网格的话</p> 
<h3><a id="PicSolver_1611"></a>PicSolver</h3> 
<h4><a id="_1613"></a>构造函数</h4> 
<p>如果你看 <code>GridFluidSolver</code> 的 <code>fluidSdf</code> 函数的话，你会发现他就是直接返回一个全为负的 SDF</p> 
<p>这就是作为父类，把细节提供给子类实现</p> 
<p>所以很多继承 <code>GridFluidSolver</code> 的类的构造函数开头都会给自己的 <code>GridSystemData</code> 中添加一个标量场，作为流体 SDF</p> 
<p>然后子类对 <code>fluidSdf</code> 的实现就会是返回这个自己的流体 SDF 场</p> 
<p>然后因为要用粒子，所以还要创建一个 <code>ParticleSystemData</code></p> 
<h4><a id="onBeginAdvanceTimeStep_1625"></a>onBeginAdvanceTimeStep</h4> 
<p><code>GridFluidSolver</code> 通过 <code>onAdvanceTimeStep</code> 确定好了求解 NS 方程的步骤，<code>GridFluidSolver</code> 的子类就不用再重写 <code>onAdvanceTimeStep</code> 了</p> 
<p>额外的自定义操作应该看钩子</p> 
<p>首先是 <code>onBeginAdvanceTimeStep</code></p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">PicSolver3</span><span class="token operator">::</span><span class="token function">onBeginAdvanceTimeStep</span><span class="token punctuation">(</span><span class="token keyword">double</span> timeIntervalInSeconds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">updateParticleEmitter</span><span class="token punctuation">(</span>timeIntervalInSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token function">transferFromParticlesToGrids</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">buildSignedDistanceField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">extrapolateVelocityToAir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">applyBoundaryCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="updateParticleEmitter_1646"></a>updateParticleEmitter</h5> 
<p>update <code>particleEmitter</code> 就是让他每帧添加粒子到 <code>ParticleSystemData</code> 中而已</p> 
<p>看来他这个类的功能就是很匹配他的名字，说是 emit，就只能发射粒子，不能对粒子做其他操作</p> 
<p>UE 的 Emitter 相当于是控制了粒子的整个生命周期了</p> 
<p>果然还是 Emitter 只负责发射粒子比较好</p> 
<h5><a id="transferFromParticlesToGrids_1656"></a>transferFromParticlesToGrids</h5> 
<p>这个 <code>transferFromParticlesToGrids</code> 就是用线性距离来计算权重的。把粒子定位到一个格子里面，然后把粒子的物理量加权平均到这个格子的八个角点上。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numberOfParticles<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token operator">::</span>array<span class="token operator">&lt;</span>Point3UI<span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">&gt;</span> indices<span class="token punctuation">;</span>
    std<span class="token operator">::</span>array<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">&gt;</span> weights<span class="token punctuation">;</span>

    uSampler<span class="token punctuation">.</span><span class="token function">getCoordinatesAndWeights</span><span class="token punctuation">(</span>positions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>indices<span class="token punctuation">,</span> <span class="token operator">&amp;</span>weights<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">u</span><span class="token punctuation">(</span>indices<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+=</span> velocities<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">*</span> weights<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">uWeight</span><span class="token punctuation">(</span>indices<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+=</span> weights<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">_uMarkers</span><span class="token punctuation">(</span>indices<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>具体的权重的计算可以看 <code>getCoordinatesAndWeights</code></p> 
<pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">R</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token class-name">LinearArraySampler3</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> R<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">getCoordinatesAndWeights</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> Vector3<span class="token operator">&lt;</span>R<span class="token operator">&gt;</span><span class="token operator">&amp;</span> x<span class="token punctuation">,</span>
    std<span class="token operator">::</span>array<span class="token operator">&lt;</span>Point3UI<span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">&gt;</span><span class="token operator">*</span> indices<span class="token punctuation">,</span>
    std<span class="token operator">::</span>array<span class="token operator">&lt;</span>R<span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">&gt;</span><span class="token operator">*</span> weights<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    ssize_t i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">;</span>
    R fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> fz<span class="token punctuation">;</span>

    <span class="token function">JET_ASSERT</span><span class="token punctuation">(</span>
        _gridSpacing<span class="token punctuation">.</span>x <span class="token operator">&gt;</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span> _gridSpacing<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span> _gridSpacing<span class="token punctuation">.</span>z <span class="token operator">&gt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> Vector3<span class="token operator">&lt;</span>R<span class="token operator">&gt;</span> normalizedX <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> _origin<span class="token punctuation">)</span> <span class="token operator">*</span> _invGridSpacing<span class="token punctuation">;</span>

    <span class="token keyword">const</span> ssize_t iSize <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>ssize_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>_accessor<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ssize_t jSize <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>ssize_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>_accessor<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ssize_t kSize <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>ssize_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>_accessor<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">getBarycentric</span><span class="token punctuation">(</span>normalizedX<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> iSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getBarycentric</span><span class="token punctuation">(</span>normalizedX<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> jSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>j<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getBarycentric</span><span class="token punctuation">(</span>normalizedX<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> kSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>k<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> ssize_t ip1 <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> iSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ssize_t jp1 <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> jSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ssize_t kp1 <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> kSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>indices<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Point3UI</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>indices<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Point3UI</span><span class="token punctuation">(</span>ip1<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>indices<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Point3UI</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> jp1<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>indices<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Point3UI</span><span class="token punctuation">(</span>ip1<span class="token punctuation">,</span> jp1<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>indices<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Point3UI</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> kp1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>indices<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Point3UI</span><span class="token punctuation">(</span>ip1<span class="token punctuation">,</span> j<span class="token punctuation">,</span> kp1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>indices<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Point3UI</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> jp1<span class="token punctuation">,</span> kp1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>indices<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Point3UI</span><span class="token punctuation">(</span>ip1<span class="token punctuation">,</span> jp1<span class="token punctuation">,</span> kp1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>weights<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fy<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>weights<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> fx <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fy<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>weights<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fx<span class="token punctuation">)</span> <span class="token operator">*</span> fy <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>weights<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> fx <span class="token operator">*</span> fy <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>weights<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fy<span class="token punctuation">)</span> <span class="token operator">*</span> fz<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>weights<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> fx <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fy<span class="token punctuation">)</span> <span class="token operator">*</span> fz<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>weights<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> fx<span class="token punctuation">)</span> <span class="token operator">*</span> fy <span class="token operator">*</span> fz<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>weights<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> fx <span class="token operator">*</span> fy <span class="token operator">*</span> fz<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>一开始要把输入坐标转化为网格中的正则化坐标 <code>normalizedX</code>，就是 [0, iSize-1] 这种</p> 
<p>这个 <code>getBarycentric</code> 的作用只是把网格坐标输出为一个钳制之后的 floor 的坐标，还有网格坐标的小数部分</p> 
<p>虽然它的命名是获取重心坐标，但是我感觉他这获取的就是一个数的整数和小数部分，跟三角形的重心坐标这种几何上的意义似乎没什么关系</p> 
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">getBarycentric</span><span class="token punctuation">(</span>
    T x<span class="token punctuation">,</span>
    ssize_t iLow<span class="token punctuation">,</span>
    ssize_t iHigh<span class="token punctuation">,</span>
    ssize_t<span class="token operator">*</span> i<span class="token punctuation">,</span>
    T<span class="token operator">*</span> f<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    T s <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">floor</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>i <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>ssize_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ssize_t offset <span class="token operator">=</span> <span class="token operator">-</span>iLow<span class="token punctuation">;</span>
    iLow <span class="token operator">+=</span> offset<span class="token punctuation">;</span>
    iHigh <span class="token operator">+=</span> offset<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>iLow <span class="token operator">==</span> iHigh<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>i <span class="token operator">=</span> iLow<span class="token punctuation">;</span>
        <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>i <span class="token operator">&lt;</span> iLow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>i <span class="token operator">=</span> iLow<span class="token punctuation">;</span>
        <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>i <span class="token operator">&gt;</span> iHigh <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>i <span class="token operator">=</span> iHigh <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">(</span>x <span class="token operator">-</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>i <span class="token operator">-=</span> offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后之后那个 <code>weights</code> 一看就是计算九个体积而已，因为边长是 0 到 1 的，并且是互补为 1 的，所以最终算出来的值刚好相当于分母除以 1，也就是算出来的体积刚好就可以作为权重</p> 
<p>因为是对于每个粒子都要把自己的物理量分到角点上，所以最后肯定要对网格点上的物理量进行归一化，不然就会得到很大的值，并且也没有物理意义了</p> 
<p>一般来说我们再把东西分给别人的时候，别人只会存自己得到的值，这里他还存了每次的权重累加起来，最后用自己的物理量除以权重就是归一化后的值了</p> 
<pre><code class="prism language-cpp">uWeight<span class="token punctuation">.</span><span class="token function">parallelForEachIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">uWeight</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">u</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">/=</span> <span class="token function">uWeight</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="buildSignedDistanceField_1773"></a>buildSignedDistanceField</h5> 
<p><code>buildSignedDistanceField</code> 也就是遍历 SDF 每一个点，查找给定搜索半径内的粒子，取到最近的那个粒子的距离，用于计算 SDF，之后的操作就是线性的了，比如 <code>minDist - radius</code></p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">PicSolver3</span><span class="token operator">::</span><span class="token function">buildSignedDistanceField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> sdf <span class="token operator">=</span> <span class="token function">signedDistanceField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> sdfPos <span class="token operator">=</span> sdf<span class="token operator">-&gt;</span><span class="token function">dataPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> maxH <span class="token operator">=</span> <span class="token function">max3</span><span class="token punctuation">(</span>
        sdf<span class="token operator">-&gt;</span><span class="token function">gridSpacing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> sdf<span class="token operator">-&gt;</span><span class="token function">gridSpacing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span> sdf<span class="token operator">-&gt;</span><span class="token function">gridSpacing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> radius <span class="token operator">=</span> <span class="token number">1.2</span> <span class="token operator">*</span> maxH <span class="token operator">/</span> std<span class="token operator">::</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> sdfBandRadius <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">*</span> radius<span class="token punctuation">;</span>

    _particles<span class="token operator">-&gt;</span><span class="token function">buildNeighborSearcher</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> searcher <span class="token operator">=</span> _particles<span class="token operator">-&gt;</span><span class="token function">neighborSearcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sdf<span class="token operator">-&gt;</span><span class="token function">parallelForEachDataPointIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Vector3D pt <span class="token operator">=</span> <span class="token function">sdfPos</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> minDist <span class="token operator">=</span> sdfBandRadius<span class="token punctuation">;</span>
        searcher<span class="token operator">-&gt;</span><span class="token function">forEachNearbyPoint</span><span class="token punctuation">(</span>
            pt<span class="token punctuation">,</span> sdfBandRadius<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3D<span class="token operator">&amp;</span> x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                minDist <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>minDist<span class="token punctuation">,</span> pt<span class="token punctuation">.</span><span class="token function">distanceTo</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>sdf<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> minDist <span class="token operator">-</span> radius<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">extrapolateIntoCollider</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这很合理，但是有点刷新的我的印象。我之前一直以为 SDF 域一定要完美地满足函数表达式就是距离函数。</p> 
<p>假设粒子均匀分布在一个球体里面，并且足够密集，那么我本来以为一定要求出一个等值面都是完美的球面的 SDF，并且等值面要一直满足距离函数。比如半径为 10，那么表面上的 SDF 为 0，球心附近的 SDF 值应该为 -10 左右才对。但是实际上，这里根据邻居粒子求出的 SDF 不一定是准确的，并且 SDF 的值有一定的范围，并不是无限延伸的。从代码上看，<code>minDist</code> 的范围是 <code>[0, 2.0 * radius]</code>，那么 SDF 的范围就是 <code>[-radius, radius]</code>，也就是深入到液体内部一定程度之后，SDF 会被钳制到一个负数不会再继续减小，外部也是同理</p> 
<h4><a id="computeAdvection_1806"></a>computeAdvection</h4> 
<p>它不是通过重写 <code>onEndAdvanceTimeStep</code> 而是通过重写 <code>computeAdvection</code> 来实现后处理的</p> 
<p>或许是因为它不需要对网格上的速度平流，而是要对速度平流，所以就直接把所有都写到 <code>computeAdvection</code> 了</p> 
<p>因为 <code>GridFluidSolver</code> 的 <code>computeAdvection</code> 定义处理自己的标量场、向量场的平流</p> 
<p>现在他直接覆盖的话，就是完全不处理这些场的平流了</p> 
<p>这应该是一个特殊的情况吧，因为物理量是由粒子携带的，所以 PIC 还真就不需要平流自己的场</p> 
<p>虽然 PIC 也有自己定义 SDF 场，但是这个场是在 PIC 的每次平流函数被调用时的预处理中被重建的。也就是说他是每帧被重建的，并不用平流</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">PicSolver3</span><span class="token operator">::</span><span class="token function">computeAdvection</span><span class="token punctuation">(</span><span class="token keyword">double</span> timeIntervalInSeconds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">extrapolateVelocityToAir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">applyBoundaryCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">transferFromGridsToParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">moveParticles</span><span class="token punctuation">(</span>timeIntervalInSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从网格到粒子的计算非常简单，直接从网格里面采样粒子位置的速度，赋给粒子</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">PicSolver3</span><span class="token operator">::</span><span class="token function">transferFromGridsToParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> flow <span class="token operator">=</span> <span class="token function">gridSystemData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">velocity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> positions <span class="token operator">=</span> _particles<span class="token operator">-&gt;</span><span class="token function">positions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> velocities <span class="token operator">=</span> _particles<span class="token operator">-&gt;</span><span class="token function">velocities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t numberOfParticles <span class="token operator">=</span> _particles<span class="token operator">-&gt;</span><span class="token function">numberOfParticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">parallelFor</span><span class="token punctuation">(</span>kZeroSize<span class="token punctuation">,</span> numberOfParticles<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        velocities<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> flow<span class="token operator">-&gt;</span><span class="token function">sample</span><span class="token punctuation">(</span>positions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最终移动粒子也很简单，就是前向使用中点法</p> 
<pre><code class="prism language-cpp"><span class="token function">parallelFor</span><span class="token punctuation">(</span>kZeroSize<span class="token punctuation">,</span> numberOfParticles<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Vector3D pt0 <span class="token operator">=</span> positions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    Vector3D pt1 <span class="token operator">=</span> pt0<span class="token punctuation">;</span>
    Vector3D vel <span class="token operator">=</span> velocities<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Adaptive time-stepping</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> numSubSteps
        <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">maxCfl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> dt <span class="token operator">=</span> timeIntervalInSeconds <span class="token operator">/</span> numSubSteps<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> t <span class="token operator">&lt;</span> numSubSteps<span class="token punctuation">;</span> <span class="token operator">++</span>t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Vector3D vel0 <span class="token operator">=</span> flow<span class="token operator">-&gt;</span><span class="token function">sample</span><span class="token punctuation">(</span>pt0<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Mid-point rule</span>
        Vector3D midPt <span class="token operator">=</span> pt0 <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> dt <span class="token operator">*</span> vel0<span class="token punctuation">;</span>
        Vector3D midVel <span class="token operator">=</span> flow<span class="token operator">-&gt;</span><span class="token function">sample</span><span class="token punctuation">(</span>midPt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pt1 <span class="token operator">=</span> pt0 <span class="token operator">+</span> dt <span class="token operator">*</span> midVel<span class="token punctuation">;</span>

        pt0 <span class="token operator">=</span> pt1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>之后就是钳制到边界，还有调用 collider 去解算碰撞</p> 
<h3><a id="FlipSolver_1875"></a>FlipSolver</h3> 
<p>因为其实 PIC 和 FLIP 的区别仅仅在于 FLIP 是更新变量的 Delta，而 PIC 是直接更新整个变量</p> 
<p>PIC 先定义好了从粒子到网格，从网格到例子，平流粒子的接口，FLIP 的求解器继承 PIC 的求解器确实可以</p> 
<p>现在 FLIP 只需要重载 <code>transferFromParticlesToGrids</code> 和 <code>transferFromGridsToParticles</code> 就好了</p> 
<p>又因为 FLIP 还比 PIC 多一套网格，它需要新旧两套网格来计算 Delta</p> 
<p>所以 FLIP 作为子类更合理，而不是 PIC 作为子类</p> 
<h4><a id="transferFromParticlesToGrids_1886"></a>transferFromParticlesToGrids</h4> 
<p>首先调用了 PIC 的 <code>transferFromParticlesToGrids</code>，然后把结果保存在 FLIP 类的三个存储 delta 的数组中</p> 
<h4><a id="transferFromGridsToParticles_1890"></a>transferFromGridsToParticles</h4> 
<p>网格上的速度经过压力投影之后会存储在 <code>GridSystemData</code>，这就是新值</p> 
<p>然后三个为了存储 delta 的数组，现在存储的还是速度的旧值</p> 
<p>所以现在有两套速度了，可以算出 delta 了</p> 
<pre><code class="prism language-cpp"><span class="token comment">// Compute delta</span>
flow<span class="token operator">-&gt;</span><span class="token function">parallelForEachUIndex</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">,</span> size_t j<span class="token punctuation">,</span> size_t k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">_uDelta</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>flow<span class="token operator">-&gt;</span><span class="token function">u</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">_uDelta</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>然后就是直接算出更新后的速度，并且和 PIC 混合了</p> 
<pre><code class="prism language-cpp"><span class="token keyword">auto</span> sampler <span class="token operator">=</span> <span class="token punctuation">[</span>uSampler<span class="token punctuation">,</span> vSampler<span class="token punctuation">,</span> wSampler<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector3D<span class="token operator">&amp;</span> x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span> xf <span class="token operator">=</span> x<span class="token punctuation">.</span>castTo<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> u <span class="token operator">=</span> <span class="token function">uSampler</span><span class="token punctuation">(</span>xf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> v <span class="token operator">=</span> <span class="token function">vSampler</span><span class="token punctuation">(</span>xf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> w <span class="token operator">=</span> <span class="token function">wSampler</span><span class="token punctuation">(</span>xf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Vector3D</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Transfer delta to the particles</span>
<span class="token function">parallelFor</span><span class="token punctuation">(</span>kZeroSize<span class="token punctuation">,</span> numberOfParticles<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Vector3D flipVel <span class="token operator">=</span> velocities<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token function">sampler</span><span class="token punctuation">(</span>positions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_picBlendingFactor <span class="token operator">&gt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Vector3D picVel <span class="token operator">=</span> flow<span class="token operator">-&gt;</span><span class="token function">sample</span><span class="token punctuation">(</span>positions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        flipVel <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>flipVel<span class="token punctuation">,</span> picVel<span class="token punctuation">,</span> _picBlendingFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    velocities<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> flipVel<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>差不多这些吧，单单看书和代码，感觉好像花了一周……感觉速度太慢了</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/47f98ab8a8f714b13f3a332862c083a6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">OpenAI、斯坦福大学提出Meta-Prompting，有效提升语言模型的性能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7063af0ee9fa1464c38a08eae483c1ec/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Nginx负载均衡下的webshell连接</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>