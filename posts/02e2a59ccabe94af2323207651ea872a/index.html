<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Pytorch-Center Loss在图像分类上的应用 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Pytorch-Center Loss在图像分类上的应用" />
<meta property="og:description" content="最近在测试Center Loss在图像分类上的性能，以此记录一下学习历程。
Center Loss论文：Wen et al. A Discriminative Feature Learning Approach for Deep Face Recognition. ECCV 2016.
pytorh版本地址：https://github.com/KaiyangZhou/pytorch-center-loss
我使用的图像分类算法是EfficientNet-V2-L版本，使用SoftMax&#43;Center Loss进行图像分类。具体代码为：
1、模型结构 efficient_v2_model.py
from collections import OrderedDict from functools import partial from typing import Callable, Optional import torch.nn as nn import torch from torch import Tensor def drop_path(x, drop_prob: float = 0., training: bool = False): &#34;&#34;&#34; Drop paths (Stochastic Depth) per sample (when applied in main path of residual blocks)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/02e2a59ccabe94af2323207651ea872a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-17T17:22:27+08:00" />
<meta property="article:modified_time" content="2021-07-17T17:22:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Pytorch-Center Loss在图像分类上的应用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>          最近在测试Center Loss在图像分类上的性能，以此记录一下学习历程。</p> 
<p>Center Loss论文：<a href="https://ydwen.github.io/papers/WenECCV16.pdf" rel="nofollow">Wen et al. A Discriminative Feature Learning Approach for Deep Face Recognition. ECCV 2016.</a><br> pytorh版本地址：<a href="https://github.com/KaiyangZhou/pytorch-center-loss">https://github.com/KaiyangZhou/pytorch-center-loss</a></p> 
<p>我使用的图像分类算法是EfficientNet-V2-L版本，使用SoftMax+Center Loss进行图像分类。具体代码为：</p> 
<h3><a id="1_7"></a>1、模型结构</h3> 
<p>efficient_v2_model.py</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> collections <span class="token keyword">import</span> OrderedDict
<span class="token keyword">from</span> functools <span class="token keyword">import</span> partial
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Callable<span class="token punctuation">,</span> Optional

<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> Tensor


<span class="token keyword">def</span> <span class="token function">drop_path</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> drop_prob<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> training<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Drop paths (Stochastic Depth) per sample (when applied in main path of residual blocks).
    "Deep Networks with Stochastic Depth", https://arxiv.org/pdf/1603.09382.pdf
    This function is taken from the rwightman.
    It can be seen here:
    https://github.com/rwightman/pytorch-image-models/blob/master/timm/models/layers/drop.py#L140
    """</span>
    <span class="token keyword">if</span> drop_prob <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">.</span> <span class="token keyword">or</span> <span class="token keyword">not</span> training<span class="token punctuation">:</span>
        <span class="token keyword">return</span> x
    keep_prob <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> drop_prob
    shape <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>ndim <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># work with diff dim tensors, not just 2D ConvNets</span>
    random_tensor <span class="token operator">=</span> keep_prob <span class="token operator">+</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>x<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>x<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
    random_tensor<span class="token punctuation">.</span>floor_<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># binarize</span>
    output <span class="token operator">=</span> x<span class="token punctuation">.</span>div<span class="token punctuation">(</span>keep_prob<span class="token punctuation">)</span> <span class="token operator">*</span> random_tensor
    <span class="token keyword">return</span> output


<span class="token keyword">class</span> <span class="token class-name">DropPath</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Drop paths (Stochastic Depth) per sample  (when applied in main path of residual blocks).
    "Deep Networks with Stochastic Depth", https://arxiv.org/pdf/1603.09382.pdf
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> drop_prob<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DropPath<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>drop_prob <span class="token operator">=</span> drop_prob

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> drop_path<span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>drop_prob<span class="token punctuation">,</span> self<span class="token punctuation">.</span>training<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">ConvBNAct</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 in_planes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 out_planes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 kernel_size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
                 stride<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
                 groups<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
                 norm_layer<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
                 activation_layer<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ConvBNAct<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        padding <span class="token operator">=</span> <span class="token punctuation">(</span>kernel_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>
        <span class="token keyword">if</span> norm_layer <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            norm_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d
        <span class="token keyword">if</span> activation_layer <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            activation_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>SiLU  <span class="token comment"># alias Swish  (torch&gt;=1.7)</span>

        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token operator">=</span>in_planes<span class="token punctuation">,</span>
                              out_channels<span class="token operator">=</span>out_planes<span class="token punctuation">,</span>
                              kernel_size<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span>
                              stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
                              padding<span class="token operator">=</span>padding<span class="token punctuation">,</span>
                              groups<span class="token operator">=</span>groups<span class="token punctuation">,</span>
                              bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>bn <span class="token operator">=</span> norm_layer<span class="token punctuation">(</span>out_planes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act <span class="token operator">=</span> activation_layer<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>bn<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>result<span class="token punctuation">)</span>

        <span class="token keyword">return</span> result


<span class="token keyword">class</span> <span class="token class-name">SqueezeExcite</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 input_c<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>   <span class="token comment"># block input channel</span>
                 expand_c<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>  <span class="token comment"># block expand channel</span>
                 se_ratio<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SqueezeExcite<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        squeeze_c <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>input_c <span class="token operator">*</span> se_ratio<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv_reduce <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>expand_c<span class="token punctuation">,</span> squeeze_c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>SiLU<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># alias Swish</span>
        self<span class="token punctuation">.</span>conv_expand <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>squeeze_c<span class="token punctuation">,</span> expand_c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
        scale <span class="token operator">=</span> x<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        scale <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_reduce<span class="token punctuation">(</span>scale<span class="token punctuation">)</span>
        scale <span class="token operator">=</span> self<span class="token punctuation">.</span>act1<span class="token punctuation">(</span>scale<span class="token punctuation">)</span>
        scale <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_expand<span class="token punctuation">(</span>scale<span class="token punctuation">)</span>
        scale <span class="token operator">=</span> self<span class="token punctuation">.</span>act2<span class="token punctuation">(</span>scale<span class="token punctuation">)</span>
        <span class="token keyword">return</span> scale <span class="token operator">*</span> x


<span class="token keyword">class</span> <span class="token class-name">MBConv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 kernel_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 input_c<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 out_c<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 expand_ratio<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 stride<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 se_ratio<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
                 drop_rate<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
                 norm_layer<span class="token punctuation">:</span> Callable<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MBConv<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> stride <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"illegal stride value."</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>has_shortcut <span class="token operator">=</span> <span class="token punctuation">(</span>stride <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">and</span> input_c <span class="token operator">==</span> out_c<span class="token punctuation">)</span>

        activation_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>SiLU  <span class="token comment"># alias Swish</span>
        expanded_c <span class="token operator">=</span> input_c <span class="token operator">*</span> expand_ratio

        <span class="token comment"># 在EfficientNetV2中，MBConv中不存在expansion=1的情况所以conv_pw肯定存在</span>
        <span class="token keyword">assert</span> expand_ratio <span class="token operator">!=</span> <span class="token number">1</span>
        <span class="token comment"># Point-wise expansion</span>
        self<span class="token punctuation">.</span>expand_conv <span class="token operator">=</span> ConvBNAct<span class="token punctuation">(</span>input_c<span class="token punctuation">,</span>
                                     expanded_c<span class="token punctuation">,</span>
                                     kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                                     norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">,</span>
                                     activation_layer<span class="token operator">=</span>activation_layer<span class="token punctuation">)</span>

        <span class="token comment"># Depth-wise convolution</span>
        self<span class="token punctuation">.</span>dwconv <span class="token operator">=</span> ConvBNAct<span class="token punctuation">(</span>expanded_c<span class="token punctuation">,</span>
                                expanded_c<span class="token punctuation">,</span>
                                kernel_size<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span>
                                stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
                                groups<span class="token operator">=</span>expanded_c<span class="token punctuation">,</span>
                                norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">,</span>
                                activation_layer<span class="token operator">=</span>activation_layer<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>se <span class="token operator">=</span> SqueezeExcite<span class="token punctuation">(</span>input_c<span class="token punctuation">,</span> expanded_c<span class="token punctuation">,</span> se_ratio<span class="token punctuation">)</span> <span class="token keyword">if</span> se_ratio <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> nn<span class="token punctuation">.</span>Identity<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Point-wise linear projection</span>
        self<span class="token punctuation">.</span>project_conv <span class="token operator">=</span> ConvBNAct<span class="token punctuation">(</span>expanded_c<span class="token punctuation">,</span>
                                      out_planes<span class="token operator">=</span>out_c<span class="token punctuation">,</span>
                                      kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                                      norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">,</span>
                                      activation_layer<span class="token operator">=</span>nn<span class="token punctuation">.</span>Identity<span class="token punctuation">)</span>  <span class="token comment"># 注意这里没有激活函数，所有传入Identity</span>

        self<span class="token punctuation">.</span>out_channels <span class="token operator">=</span> out_c

        <span class="token comment"># 只有在使用shortcut连接时才使用dropout层</span>
        self<span class="token punctuation">.</span>drop_rate <span class="token operator">=</span> drop_rate
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>has_shortcut <span class="token keyword">and</span> drop_rate <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> DropPath<span class="token punctuation">(</span>drop_rate<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>expand_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>dwconv<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>se<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>project_conv<span class="token punctuation">(</span>result<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>has_shortcut<span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>drop_rate <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                result <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
            result <span class="token operator">+=</span> x

        <span class="token keyword">return</span> result


<span class="token keyword">class</span> <span class="token class-name">FusedMBConv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 kernel_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 input_c<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 out_c<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 expand_ratio<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 stride<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 se_ratio<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
                 drop_rate<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
                 norm_layer<span class="token punctuation">:</span> Callable<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>FusedMBConv<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">assert</span> stride <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token keyword">assert</span> se_ratio <span class="token operator">==</span> <span class="token number">0</span>

        self<span class="token punctuation">.</span>has_shortcut <span class="token operator">=</span> stride <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">and</span> input_c <span class="token operator">==</span> out_c
        self<span class="token punctuation">.</span>drop_rate <span class="token operator">=</span> drop_rate

        self<span class="token punctuation">.</span>has_expansion <span class="token operator">=</span> expand_ratio <span class="token operator">!=</span> <span class="token number">1</span>

        activation_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>SiLU  <span class="token comment"># alias Swish</span>
        expanded_c <span class="token operator">=</span> input_c <span class="token operator">*</span> expand_ratio

        <span class="token comment"># 只有当expand ratio不等于1时才有expand conv</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>has_expansion<span class="token punctuation">:</span>
            <span class="token comment"># Expansion convolution</span>
            self<span class="token punctuation">.</span>expand_conv <span class="token operator">=</span> ConvBNAct<span class="token punctuation">(</span>input_c<span class="token punctuation">,</span>
                                         expanded_c<span class="token punctuation">,</span>
                                         kernel_size<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span>
                                         stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
                                         norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">,</span>
                                         activation_layer<span class="token operator">=</span>activation_layer<span class="token punctuation">)</span>

            self<span class="token punctuation">.</span>project_conv <span class="token operator">=</span> ConvBNAct<span class="token punctuation">(</span>expanded_c<span class="token punctuation">,</span>
                                          out_c<span class="token punctuation">,</span>
                                          kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                                          norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">,</span>
                                          activation_layer<span class="token operator">=</span>nn<span class="token punctuation">.</span>Identity<span class="token punctuation">)</span>  <span class="token comment"># 注意没有激活函数</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 当只有project_conv时的情况</span>
            self<span class="token punctuation">.</span>project_conv <span class="token operator">=</span> ConvBNAct<span class="token punctuation">(</span>input_c<span class="token punctuation">,</span>
                                          out_c<span class="token punctuation">,</span>
                                          kernel_size<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span>
                                          stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
                                          norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">,</span>
                                          activation_layer<span class="token operator">=</span>activation_layer<span class="token punctuation">)</span>  <span class="token comment"># 注意有激活函数</span>

        self<span class="token punctuation">.</span>out_channels <span class="token operator">=</span> out_c

        <span class="token comment"># 只有在使用shortcut连接时才使用dropout层</span>
        self<span class="token punctuation">.</span>drop_rate <span class="token operator">=</span> drop_rate
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>has_shortcut <span class="token keyword">and</span> drop_rate <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> DropPath<span class="token punctuation">(</span>drop_rate<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>has_expansion<span class="token punctuation">:</span>
            result <span class="token operator">=</span> self<span class="token punctuation">.</span>expand_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
            result <span class="token operator">=</span> self<span class="token punctuation">.</span>project_conv<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> self<span class="token punctuation">.</span>project_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>has_shortcut<span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>drop_rate <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                result <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>result<span class="token punctuation">)</span>

            result <span class="token operator">+=</span> x

        <span class="token keyword">return</span> result


<span class="token keyword">class</span> <span class="token class-name">EfficientNetV2</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 model_cnf<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span>
                 num_classes<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span>
                 num_features<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1280</span><span class="token punctuation">,</span>
                 dropout_rate<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
                 drop_connect_rate<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>EfficientNetV2<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> cnf <span class="token keyword">in</span> model_cnf<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cnf<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span>

        norm_layer <span class="token operator">=</span> partial<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>

        stem_filter_num <span class="token operator">=</span> model_cnf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>

        self<span class="token punctuation">.</span>stem <span class="token operator">=</span> ConvBNAct<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>
                              stem_filter_num<span class="token punctuation">,</span>
                              kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
                              stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                              norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">)</span>  <span class="token comment"># 激活函数默认是SiLU</span>

        total_blocks <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> model_cnf<span class="token punctuation">]</span><span class="token punctuation">)</span>
        block_id <span class="token operator">=</span> <span class="token number">0</span>
        blocks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> cnf <span class="token keyword">in</span> model_cnf<span class="token punctuation">:</span>
            repeats <span class="token operator">=</span> cnf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            op <span class="token operator">=</span> FusedMBConv <span class="token keyword">if</span> cnf<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> MBConv
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>repeats<span class="token punctuation">)</span><span class="token punctuation">:</span>
                blocks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>op<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span>cnf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 input_c<span class="token operator">=</span>cnf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> cnf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 out_c<span class="token operator">=</span>cnf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 expand_ratio<span class="token operator">=</span>cnf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 stride<span class="token operator">=</span>cnf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">1</span><span class="token punctuation">,</span>
                                 se_ratio<span class="token operator">=</span>cnf<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 drop_rate<span class="token operator">=</span>drop_connect_rate <span class="token operator">*</span> block_id <span class="token operator">/</span> total_blocks<span class="token punctuation">,</span>
                                 norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">)</span><span class="token punctuation">)</span>
                block_id <span class="token operator">+=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>blocks <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>blocks<span class="token punctuation">)</span>

        head_input_c <span class="token operator">=</span> model_cnf<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span>

        head <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>

        head<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"project_conv"</span><span class="token punctuation">:</span> ConvBNAct<span class="token punctuation">(</span>head_input_c<span class="token punctuation">,</span>
                                               num_features<span class="token punctuation">,</span>
                                               kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                                               norm_layer<span class="token operator">=</span>norm_layer<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># 激活函数默认是SiLU</span>

        head<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"avgpool"</span><span class="token punctuation">:</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        head<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"flatten"</span><span class="token punctuation">:</span> nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> dropout_rate <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            head<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"dropout"</span><span class="token punctuation">:</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span>dropout_rate<span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        head<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"classifier"</span><span class="token punctuation">:</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_features<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>head <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>head<span class="token punctuation">)</span>

        <span class="token comment"># initial weights</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">)</span><span class="token punctuation">:</span>
                nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>kaiming_normal_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"fan_out"</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> m<span class="token punctuation">.</span>bias <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>zeros_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>bias<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">)</span><span class="token punctuation">:</span>
                nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>ones_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">)</span>
                nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>zeros_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>bias<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">)</span><span class="token punctuation">:</span>
                nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span>
                nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>zeros_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>bias<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>stem<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>blocks<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>head<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        feat <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>head<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> feat<span class="token punctuation">,</span>out


<span class="token keyword">def</span> <span class="token function">efficientnetv2_s</span><span class="token punctuation">(</span>num_classes<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    EfficientNetV2
    https://arxiv.org/abs/2104.00298
    """</span>
    <span class="token comment"># train_size: 300, eval_size: 384</span>

    <span class="token comment"># repeat, kernel, stride, expansion, in_c, out_c, operator, se_ratio</span>
    model_config <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    model <span class="token operator">=</span> EfficientNetV2<span class="token punctuation">(</span>model_cnf<span class="token operator">=</span>model_config<span class="token punctuation">,</span>
                           num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">,</span>
                           dropout_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> model


<span class="token keyword">def</span> <span class="token function">efficientnetv2_m</span><span class="token punctuation">(</span>num_classes<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    EfficientNetV2
    https://arxiv.org/abs/2104.00298
    """</span>
    <span class="token comment"># train_size: 384, eval_size: 480</span>

    <span class="token comment"># repeat, kernel, stride, expansion, in_c, out_c, operator, se_ratio</span>
    model_config <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">176</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">176</span><span class="token punctuation">,</span> <span class="token number">304</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">304</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    model <span class="token operator">=</span> EfficientNetV2<span class="token punctuation">(</span>model_cnf<span class="token operator">=</span>model_config<span class="token punctuation">,</span>
                           num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">,</span>
                           dropout_rate<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> model


<span class="token keyword">def</span> <span class="token function">efficientnetv2_l</span><span class="token punctuation">(</span>num_classes<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    EfficientNetV2
    https://arxiv.org/abs/2104.00298
    """</span>
    <span class="token comment"># train_size: 384, eval_size: 480</span>

    <span class="token comment"># repeat, kernel, stride, expansion, in_c, out_c, operator, se_ratio</span>
    model_config <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

    model <span class="token operator">=</span> EfficientNetV2<span class="token punctuation">(</span>model_cnf<span class="token operator">=</span>model_config<span class="token punctuation">,</span>
                           num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">,</span>
                           dropout_rate<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> model
</code></pre> 
<h3><a id="2Center_Loss_391"></a>2、Center Loss损失</h3> 
<p>center_loss.py</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd<span class="token punctuation">.</span>function <span class="token keyword">import</span> Function
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable


<span class="token keyword">class</span> <span class="token class-name">CenterLoss</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Center loss.

    Reference:
    Wen et al. A Discriminative Feature Learning Approach for Deep Face Recognition. ECCV 2016.

    Args:
        num_classes (int): number of classes.
        feat_dim (int): feature dimension.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> feat_dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> use_gpu<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CenterLoss<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>num_classes <span class="token operator">=</span> num_classes
        self<span class="token punctuation">.</span>feat_dim <span class="token operator">=</span> feat_dim
        self<span class="token punctuation">.</span>use_gpu <span class="token operator">=</span> use_gpu

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>use_gpu<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>centers <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_classes<span class="token punctuation">,</span> self<span class="token punctuation">.</span>feat_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>centers <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_classes<span class="token punctuation">,</span> self<span class="token punctuation">.</span>feat_dim<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Args:
            x: feature matrix with shape (batch_size, feat_dim).
            labels: ground truth labels with shape (batch_size).
        """</span>
        batch_size <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        distmat <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span> <span class="token operator">+</span> \
                  torch<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>centers<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_classes<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span>
        distmat<span class="token punctuation">.</span>addmm_<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>centers<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        classes <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>use_gpu<span class="token punctuation">:</span> classes <span class="token operator">=</span> classes<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span>
        mask <span class="token operator">=</span> labels<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>classes<span class="token punctuation">.</span>expand<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">)</span>

        dist <span class="token operator">=</span> distmat <span class="token operator">*</span> mask<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss <span class="token operator">=</span> dist<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">1e</span><span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> batch_size

        <span class="token keyword">return</span> loss

</code></pre> 
<h3><a id="3_448"></a>3、模型训练</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> argparse
<span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> math
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler <span class="token keyword">as</span> lr_scheduler
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn <span class="token keyword">as</span> cudnn
<span class="token keyword">import</span> torchvision
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>image_processing <span class="token keyword">import</span> RandomErasing
<span class="token keyword">from</span> efficient_v2_model <span class="token keyword">import</span> efficientnetv2_l
<span class="token keyword">from</span> losses<span class="token punctuation">.</span>center_loss <span class="token keyword">import</span> CenterLoss
parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"Train on mydatasets"</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--data-dir"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'datasets'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--no-cuda"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--gpu-id"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--lr"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--interval"</span><span class="token punctuation">,</span> <span class="token string">'-i'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--resume'</span><span class="token punctuation">,</span> <span class="token string">'-r'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">)</span>
args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># device</span>
device <span class="token operator">=</span> <span class="token string">"cuda:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
    args<span class="token punctuation">.</span>gpu_id<span class="token punctuation">)</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> args<span class="token punctuation">.</span>no_cuda <span class="token keyword">else</span> <span class="token string">"cpu"</span>
<span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> args<span class="token punctuation">.</span>no_cuda<span class="token punctuation">:</span>
    cudnn<span class="token punctuation">.</span>benchmark <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># data loading</span>
root <span class="token operator">=</span> args<span class="token punctuation">.</span>data_dir
train_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"train"</span><span class="token punctuation">)</span>
test_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span>
transform_train <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment"># ZeroPaddingResize((224, 224)),</span>
    torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># (h,w)</span>
    <span class="token comment"># torchvision.transforms.Resize((256, 128)),  # (h,w)</span>
    <span class="token comment"># torchvision.transforms.RandomCrop((256, 128), padding=4),</span>
    torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>ColorJitter<span class="token punctuation">(</span>brightness<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>RandomVerticalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span>degrees<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    RandomErasing<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
transform_test <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment"># ZeroPaddingResize((224, 224)),</span>
    torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># torchvision.transforms.Resize((256, 128)),</span>
    torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    torchvision<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
trainloader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
    torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span>train_dir<span class="token punctuation">,</span> transform<span class="token operator">=</span>transform_train<span class="token punctuation">)</span><span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span>
testloader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
    torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span>test_dir<span class="token punctuation">,</span> transform<span class="token operator">=</span>transform_test<span class="token punctuation">)</span><span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span>
<span class="token punctuation">)</span>
num_classes <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>trainloader<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>classes<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token builtin">len</span><span class="token punctuation">(</span>testloader<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>classes<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># net definition</span>
start_epoch <span class="token operator">=</span> <span class="token number">0</span>
net <span class="token operator">=</span> efficientnetv2_l<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">81</span><span class="token punctuation">)</span>
weights_dict <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'pre_model/pre_efficientnetv2-l.pth'</span><span class="token punctuation">,</span> map_location<span class="token operator">=</span>device<span class="token punctuation">)</span> <span class="token comment">#预训练模型</span>
load_weights_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>k<span class="token punctuation">:</span> v <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> weights_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> v<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>load_weights_dict<span class="token punctuation">,</span>strict<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
net<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>net<span class="token punctuation">)</span>

<span class="token comment"># cross loss and optimizer</span>
criterion <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>
    net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>lr<span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">5e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token comment"># center loss and optimizer</span>
loss_weight <span class="token operator">=</span> <span class="token number">0.001</span>
center_loss <span class="token operator">=</span> CenterLoss<span class="token punctuation">(</span><span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">1280</span><span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">)</span>
optimzer_center <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>center_loss<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>

lf <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>x <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token number">0.01</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.01</span>  <span class="token comment"># cosine</span>
scheduler <span class="token operator">=</span> lr_scheduler<span class="token punctuation">.</span>LambdaLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> lr_lambda<span class="token operator">=</span>lf<span class="token punctuation">)</span>



<span class="token comment"># train function for each epoch</span>


<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nEpoch : %d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    net<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    training_loss <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span>
    train_loss <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span>
    correct <span class="token operator">=</span> <span class="token number">0</span>
    total <span class="token operator">=</span> <span class="token number">0</span>
    interval <span class="token operator">=</span> args<span class="token punctuation">.</span>interval
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>trainloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># forward</span>
        inputs<span class="token punctuation">,</span> labels <span class="token operator">=</span> inputs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        feats<span class="token punctuation">,</span>outputs <span class="token operator">=</span> net<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token operator">+</span>loss_weight<span class="token operator">*</span>center_loss<span class="token punctuation">(</span>feats<span class="token punctuation">,</span>labels<span class="token punctuation">)</span>

        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimzer_center<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimzer_center<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        training_loss <span class="token operator">+=</span> <span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        train_loss <span class="token operator">+=</span> <span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        correct <span class="token operator">+=</span> outputs<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>eq<span class="token punctuation">(</span>labels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        total <span class="token operator">+=</span> labels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment"># print</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> interval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[progress:{:.1f}%]time:{:.2f}s Loss:{:.5f} Correct:{}/{} Acc:{:.3f}%"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                <span class="token number">100</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">(</span>idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>trainloader<span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">-</span>start<span class="token punctuation">,</span> training_loss <span class="token operator">/</span>
                interval<span class="token punctuation">,</span> correct<span class="token punctuation">,</span> total<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">.</span><span class="token operator">*</span>correct<span class="token operator">/</span>total
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
            training_loss <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span>
            start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>



<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>

    net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    test_loss <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span>
    correct <span class="token operator">=</span> <span class="token number">0</span>
    total <span class="token operator">=</span> <span class="token number">0</span>
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>testloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            inputs<span class="token punctuation">,</span> labels <span class="token operator">=</span> inputs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            feats<span class="token punctuation">,</span>outputs <span class="token operator">=</span> net<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>

            loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token operator">+</span> loss_weight <span class="token operator">*</span> center_loss<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> feats<span class="token punctuation">)</span>

            test_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            correct <span class="token operator">+=</span> outputs<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>eq<span class="token punctuation">(</span>labels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            total <span class="token operator">+=</span> labels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Testing ..."</span><span class="token punctuation">)</span>
        end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[progress:{:.1f}%]time:{:.2f}s Loss:{:.5f} Correct:{}/{} Acc:{:.3f}%"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            <span class="token number">100</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">(</span>idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>testloader<span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">-</span>start<span class="token punctuation">,</span> test_loss <span class="token operator">/</span>
            <span class="token builtin">len</span><span class="token punctuation">(</span>testloader<span class="token punctuation">)</span><span class="token punctuation">,</span> correct<span class="token punctuation">,</span> total<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">.</span><span class="token operator">*</span>correct<span class="token operator">/</span>total
        <span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># saving checkpoint</span>
    acc <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">.</span><span class="token operator">*</span>correct<span class="token operator">/</span>total

    checkpoint <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'net_dict'</span><span class="token punctuation">:</span> net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'acc'</span><span class="token punctuation">:</span> acc<span class="token punctuation">,</span>
        <span class="token string">'epoch'</span><span class="token punctuation">:</span> epoch<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span><span class="token string">'checkpoint'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">'checkpoint'</span><span class="token punctuation">)</span>
    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>checkpoint<span class="token punctuation">,</span> <span class="token string">'checkpoint/ckpt-'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'.t7'</span><span class="token punctuation">)</span>





<span class="token comment"># lr decay</span>

<span class="token keyword">def</span> <span class="token function">lr_decay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> optimizer
    <span class="token keyword">for</span> params <span class="token keyword">in</span> optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">:</span>
        params<span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token number">0.1</span>
        lr <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Learning rate adjusted to {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>lr<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>start_epoch<span class="token punctuation">,</span> start_epoch<span class="token operator">+</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        train<span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
        scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        test<span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">20</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            lr_decay<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="4_641"></a>4、训练结果</h3> 
<p><img src="https://images2.imgbox.com/3d/29/Lu0RouMw_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5e7da2cd4e81bb5c062b957c9968f759/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">整蛊：聊天中，连续发送消息的vbs脚本</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/65d1baa53c7c02fe2b5b4c863f56c7df/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">计算机系的土味情话,大学各专业土味情话大比拼，你够我土吗？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>