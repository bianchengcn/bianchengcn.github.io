<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>kubernetes-2-搭建k8s集群 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="kubernetes-2-搭建k8s集群" />
<meta property="og:description" content="二、搭建k8s集群 2.1 平台规划 1.单master集群 2.多master集群(高可用集群) 2.2 服务器硬件要求 2.3 部署方式 2.3.1. Kubeadm工具安装 官方的部署k8s工具, 用于快速部署
第一、创建一个 Master 节点 kubeadm init
第二、将 Node 节点加入到当前集群中 $ kubeadm join &lt;Master 节点的 IP 和端口 &gt;
1. 前置条件 一台或多台机器，操作系统 CentOS7.x-86_x64
硬件配置:2GB 或更多 RAM，2 个 CPU 或更多 CPU，硬盘 30GB 或更多 - 集群中所有机器之间网络互通
可以访问外网，需要拉取镜像
禁止 swap 分区
步骤
vim /etc/fstab
注释swap那一行
echo vm.swappiness=0 &gt;&gt; /etc/sysctl.conf
重启: sudo reboot
验证 free -m
kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具。
这个工具能通过两条指令完成一个kubernetes集群的部署：
# 创建一个 Master 节点 $ kubeadm init # 将一个 Node 节点加入到当前集群中 $ kubeadm join &lt;Master节点的IP和端口 &gt; 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/281fa9fb9f549faa51610c7692146089/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-03T17:37:41+08:00" />
<meta property="article:modified_time" content="2021-06-03T17:37:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">kubernetes-2-搭建k8s集群</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="k8s_0"></a>二、搭建k8s集群</h2> 
<h3><a id="21__2"></a>2.1 平台规划</h3> 
<h4><a id="1master_4"></a>1.单master集群</h4> 
<p><img src="https://images2.imgbox.com/6a/bc/SSMiq862_o.png" alt="HF3wO7"></p> 
<h4><a id="2master_8"></a>2.多master集群(高可用集群)</h4> 
<p><img src="https://images2.imgbox.com/1d/cc/0aqeinMr_o.png" alt="wXVClp"></p> 
 
<h3><a id="22__14"></a>2.2 服务器硬件要求</h3> 
<p><img src="https://images2.imgbox.com/33/b9/LiqiCTIT_o.png" alt="irGHD7"></p> 
<h3><a id="23__18"></a>2.3 部署方式</h3> 
<h4><a id="231_Kubeadm_20"></a>2.3.1. Kubeadm工具安装</h4> 
<blockquote> 
 <p>官方的部署k8s工具, 用于快速部署</p> 
</blockquote> 
<p>第一、创建一个 Master 节点 kubeadm init</p> 
<p>第二、将 Node 节点加入到当前集群中 $ kubeadm join &lt;Master 节点的 IP 和端口 &gt;</p> 
<h5><a id="1__28"></a>1. 前置条件</h5> 
<ul><li> <p>一台或多台机器，操作系统 CentOS7.x-86_x64</p> </li><li> <p>硬件配置:2GB 或更多 RAM，2 个 CPU 或更多 CPU，硬盘 30GB 或更多 - 集群中所有机器之间网络互通</p> </li><li> <p>可以访问外网，需要拉取镜像</p> </li><li> <p>禁止 swap 分区</p> <p><a href="https://blog.csdn.net/yefun/article/details/102772368?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control">步骤</a></p> 
  <ol><li> <p><code>vim /etc/fstab</code></p> <p>注释swap那一行</p> </li><li> <p><code>echo vm.swappiness=0 &gt;&gt; /etc/sysctl.conf</code></p> </li><li> <p>重启: <code>sudo reboot</code></p> </li><li> <p>验证 <code>free -m</code></p> <p><img src="https://images2.imgbox.com/37/dc/HYnynFgx_o.png" alt="RNdXg4"></p> </li></ol> </li></ul> 
<p>kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具。</p> 
<p>这个工具能通过两条指令完成一个kubernetes集群的部署：</p> 
<pre><code class="prism language-shell"><span class="token comment"># 创建一个 Master 节点</span>
$ kubeadm init

<span class="token comment"># 将一个 Node 节点加入到当前集群中</span>
$ kubeadm <span class="token function">join</span> <span class="token operator">&lt;</span>Master节点的IP和端口 <span class="token operator">&gt;</span>
</code></pre> 
<h5><a id="2__64"></a>2. 准备环境</h5> 
<table><thead><tr><th>角色</th><th>IP</th></tr></thead><tbody><tr><td>master</td><td>192.168.8.146</td></tr><tr><td>node1</td><td>192.168.8.147</td></tr><tr><td>node2</td><td>192.168.8.148</td></tr></tbody></table> 
<pre><code class="prism language-shell"><span class="token comment"># 关闭防火墙</span>
systemctl stop firewalld
systemctl disable firewalld

<span class="token comment"># 关闭selinux</span>
<span class="token function">sed</span> -i <span class="token string">'s/enforcing/disabled/'</span> /etc/selinux/config  <span class="token comment"># 永久</span>
setenforce <span class="token number">0</span>  <span class="token comment"># 临时</span>

<span class="token comment"># 关闭swap</span>
swapoff -a  <span class="token comment"># 临时</span>
<span class="token function">sed</span> -ri <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab    <span class="token comment"># 永久</span>

<span class="token comment"># 根据规划设置主机名</span>
hostnamectl set-hostname <span class="token operator">&lt;</span>hostname<span class="token operator">&gt;</span>

<span class="token comment"># 在master添加hosts (换成自己的IP)</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
192.168.8.146 k8smaster
192.168.8.147 k8snode1
192.168.8.148 k8snode2
EOF</span>

<span class="token comment"># 将桥接的IPv4流量传递到iptables的链</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF</span>
sysctl --system  <span class="token comment"># 生效</span>

<span class="token comment"># 时间同步</span>
yum <span class="token function">install</span> ntpdate -y
ntpdate time.windows.com
</code></pre> 
<h5><a id="3_Dockerkubeadmkubelet_107"></a>3. 所有节点安装Docker/kubeadm/kubelet</h5> 
<p>Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p> 
<h6><a id="31_Docker_111"></a>3.1 安装Docker</h6> 
<pre><code class="prism language-shell">$ <span class="token function">wget</span> https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo
$ yum -y <span class="token function">install</span> docker-ce-18.06.1.ce-3.el7
$ systemctl <span class="token builtin class-name">enable</span> docker <span class="token operator">&amp;&amp;</span> systemctl start docker
$ docker --version
Docker version <span class="token number">18.06</span>.1-ce, build e68fc7a
</code></pre> 
<pre><code class="prism language-shell">$ <span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
{
  "registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"]
}
EOF</span>
</code></pre> 
<h6><a id="32_YUM_129"></a>3.2 添加阿里云YUM软件源</h6> 
<pre><code class="prism language-shell">$ <span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/yum.repos.d/kubernetes.repo <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>
</code></pre> 
<h6><a id="33_kubeadmkubeletkubectl_143"></a>3.3 安装kubeadm，kubelet和kubectl</h6> 
<p>由于版本更新频繁，这里指定版本号部署：</p> 
<pre><code>$ yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0
$ systemctl enable kubelet
</code></pre> 
<h5><a id="4_Kubernetes_Master_152"></a>4. 部署Kubernetes Master</h5> 
<p>在192.168.8.146（Master）执行。</p> 
<pre><code class="prism language-shell"><span class="token comment"># 注意第一个参数换成自己的IP</span>
$ kubeadm init <span class="token punctuation">\</span>
  --apiserver-advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.8.146 <span class="token punctuation">\</span>
  --image-repository registry.aliyuncs.com/google_containers <span class="token punctuation">\</span>
  --kubernetes-version v1.18.0 <span class="token punctuation">\</span>
  --service-cidr<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12 <span class="token punctuation">\</span>
  --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16
</code></pre> 
<blockquote> 
 <p>这一步主要是拉取Master要使用的镜像</p> 
 <p><img src="https://images2.imgbox.com/04/d7/zmPvn5Vj_o.png" alt="XennPZ"></p> 
</blockquote> 
<p>由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定<strong>阿里云镜像仓库地址。</strong></p> 
<p>使用kubectl工具：</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
$ kubectl get nodes
</code></pre> 
<h5><a id="5_Kubernetes_Node_181"></a>5. 加入Kubernetes Node</h5> 
<p>在其他（Node工作节点）执行。</p> 
<p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：(如果没找到可以用下面的命令再创建)</p> 
<pre><code>$ kubeadm join 192.168.1.11:6443 --token esce21.q6hetwm8si29qxwn \    --discovery-token-ca-cert-hash sha256:00603a05805807501d7181c3d60b478788408cfe6cedefedb1f97569708be9c5
</code></pre> 
<p>默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，操作如下：</p> 
<pre><code>kubeadm token create --print-join-command
</code></pre> 
<blockquote> 
 <p>错误: <font color="#e54d42">ERROR: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</font><br> errors pretty printing info, error: exit status 1<br> [ERROR Service-Docker]: docker service is not active, please run ‘systemctl start docker.service’<br> [ERROR IsDockerSystemdCheck]: cannot execute 'docker info -f ……</p> 
 <p>原因: docker服务未启动</p> 
 <p>解决: <code>systemctl start docker.service</code></p> 
</blockquote> 
<p>添加成功后再次在master中检查node:</p> 
<p><img src="https://images2.imgbox.com/4c/69/R1ACri9j_o.png" alt="rIIL0n"></p> 
<h5><a id="6_CNI_210"></a>6. 部署CNI网络插件</h5> 
<blockquote> 
 <p>NotReady状态是不行的, 变成运行状态需要配置网络插件</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">wget</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre> 
<p>默认镜像地址无法访问，sed命令修改为docker hub镜像仓库。</p> 
<pre><code class="prism language-shell">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.ymlkubectl get pods -n kube-system<span class="token comment"># 运行结果:NAME                          READY   STATUS    RESTARTS   AGEkube-flannel-ds-amd64-2pc95   1/1     Running   0          72s.....</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/50/59/rjmRLi0i_o.png" alt="tmG4ju"></p> 
<p><img src="https://images2.imgbox.com/2f/88/TsIG6wV7_o.png" alt="SyoZDI"></p> 
<h5><a id="7_kubernetes_228"></a>7. 测试kubernetes集群</h5> 
<p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p> 
<pre><code class="prism language-shell">$ kubectl create deployment nginx --image<span class="token operator">=</span>nginx		<span class="token comment"># 创建一个nginx pod$ kubectl get pods																# 查看pod状态$ kubectl expose deployment nginx --port=80 --type=NodePort	# 暴露端口$ kubectl get pod,svc															# 再次查看</span>
</code></pre> 
<p>访问地址格式：http://[NodeIP]:[Port]</p> 
<p>例如:</p> 
<p><img src="https://images2.imgbox.com/ba/df/yTXr6l0d_o.png" alt="aL0ypU"></p> 
<p>访问: 192.168.8.146:31798</p> 
<p><img src="https://images2.imgbox.com/ca/1c/LAbIL49u_o.png" alt="DN71Sm"></p> 
<h5><a id="_246"></a>总结步骤</h5> 
<p><img src="https://images2.imgbox.com/ee/31/WpaHMUip_o.png" alt="8d9Thc"></p> 
<h4><a id="232___250"></a>2.3.2 二进制包安装</h4> 
<blockquote> 
 <p>手动的部署过程,可以了解整个过程</p> 
</blockquote> 
<h5><a id="1__254"></a>1. 总步骤</h5> 
<p><img src="https://images2.imgbox.com/ad/67/P2IXPXVl_o.png" alt="ec1FCz"></p> 
<blockquote> 
 <p><strong>前两步同之前, 自行操作</strong></p> 
</blockquote> 
<table><thead><tr><th>角色</th><th>IP</th><th>hostname</th></tr></thead><tbody><tr><td>master</td><td>192.168.8.122</td><td>122-k8smaster</td></tr><tr><td>node1</td><td>192.168.8.121</td><td>121-k8snode1</td></tr></tbody></table> 
<h5><a id="2__265"></a>2. 自签证书和部署</h5> 
<h6><a id="1_cfssl_267"></a>1. cfssl证书生成工具</h6> 
<p>cfssl 是一个开源的证书管理工具，使用 json 文件生成证书，相比 openssl 更方便使用。 找任意一台服务器操作，这里用 Master 节点。</p> 
<pre><code class="prism language-shell"><span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssl_linux-amd64wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64 <span class="token function">mv</span> cfssl_linux-amd64 /usr/local/bin/cfsslmv cfssljson_linux-amd64 /usr/local/bin/cfssljson
</code></pre> 
<h6><a id="2_Etcd_275"></a>2. 生成Etcd证书</h6> 
<ul><li> <p><strong>自签证书颁发机构(CA)</strong></p> <p>创建工作目录:</p> <pre><code class="prism language-shell"><span class="token function">mkdir</span> -p ~/TLS/<span class="token punctuation">{<!-- --></span>etcd, k8s<span class="token punctuation">}</span>cd TLS/etcd
</code></pre> <p>自签CA:(创建两个json文件)</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> ca-config.json <span class="token operator">&lt;&lt;</span> EOF<span class="token punctuation">{<!-- --></span>    <span class="token string">"signing"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>        <span class="token string">"default"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>            <span class="token string">"expiry"</span><span class="token builtin class-name">:</span> <span class="token string">"87660h"</span>        <span class="token punctuation">}</span>,        <span class="token string">"profiles"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>            <span class="token string">"www"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>                <span class="token string">"expiry"</span><span class="token builtin class-name">:</span> <span class="token string">"87660h"</span>,                <span class="token string">"usages"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>                    <span class="token string">"signing"</span>,                    <span class="token string">"key encipherment"</span>,                    <span class="token string">"server auth"</span>,                    <span class="token string">"client auth"</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>EOFcat <span class="token operator">&gt;</span> ca-csr.json <span class="token operator">&lt;&lt;</span> EOF<span class="token punctuation">{<!-- --></span>    <span class="token string">"CN"</span><span class="token builtin class-name">:</span> <span class="token string">"etcd CA"</span>,    <span class="token string">"key"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>        <span class="token string">"algo"</span><span class="token builtin class-name">:</span> <span class="token string">"rsa"</span>,        <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>    <span class="token punctuation">}</span>,    <span class="token string">"names"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{<!-- --></span>            <span class="token string">"C"</span><span class="token builtin class-name">:</span> <span class="token string">"CN"</span>,            <span class="token string">"L"</span><span class="token builtin class-name">:</span> <span class="token string">"Beijing"</span>,            <span class="token string">"ST"</span><span class="token builtin class-name">:</span> <span class="token string">"Beijing"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span>EOF
</code></pre> <p>生成证书:</p> <pre><code class="prism language-shell">cfssl gencert -initca ca-csr.json <span class="token operator">|</span> cfssljson -bare ca -ls *pem	  <span class="token comment"># 查看</span>
</code></pre> <p><img src="https://images2.imgbox.com/78/85/UjexPbMD_o.png" alt=""></p> </li><li> <p><strong>使用自签CA签发Etcd HTTPS证书</strong></p> <p>创建证书申请文件:</p> 
  <blockquote> 
   <p>注意: 这里的Hosts字段改成你自己的集群IP, hosts 字段中 IP 为所有 etcd 节点的集群内部通信 IP，一个都不能少!为了方便后期扩容可以多写几个预留的 IP。</p> 
  </blockquote> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> server-csr.json <span class="token operator">&lt;&lt;</span>EOF<span class="token punctuation">{<!-- --></span>    <span class="token string">"CN"</span><span class="token builtin class-name">:</span> <span class="token string">"etcd"</span>,    <span class="token string">"hosts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token string">"192.168.8.121"</span>,        <span class="token string">"192.168.8.122"</span>    <span class="token punctuation">]</span>,    <span class="token string">"key"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>        <span class="token string">"algo"</span><span class="token builtin class-name">:</span> <span class="token string">"rsa"</span>,        <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>    <span class="token punctuation">}</span>,    <span class="token string">"names"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{<!-- --></span>            <span class="token string">"C"</span><span class="token builtin class-name">:</span> <span class="token string">"CN"</span>,            <span class="token string">"L"</span><span class="token builtin class-name">:</span> <span class="token string">"BeiJing"</span>,            <span class="token string">"ST"</span><span class="token builtin class-name">:</span> <span class="token string">"BeiJing"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span>EOF
</code></pre> <p>生成证书</p> <pre><code class="prism language-shell">cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>www server-csr.json <span class="token operator">|</span> cfssljson -bare server<span class="token comment"># 查看ls server*pem</span>
</code></pre> <p><img src="https://images2.imgbox.com/33/8d/CeXBOcDp_o.png" alt="4YDcal"></p> </li></ul> 
<h6><a id="3_Etcd_317"></a>3. 部署Etcd集群</h6> 
<ul><li>在github上下载etcd二进制文件压缩包:</li></ul> 
<pre><code class="prism language-shell"><span class="token function">wget</span> https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz
</code></pre> 
<p>​ 以下在单个节点上操作,然后复制给其他节点</p> 
<ul><li> <p>创建工作目录并解压二进制包</p> <pre><code class="prism language-shell"><span class="token function">mkdir</span> /opt/etcd/<span class="token punctuation">{<!-- --></span>bin,cfg,ssl<span class="token punctuation">}</span> –ptar zxvf etcd-v3.4.9-linux-amd64.tar.gzmv etcd-v3.4.9-linux-amd64/<span class="token punctuation">{<!-- --></span>etcd,etcdctl<span class="token punctuation">}</span> /opt/etcd/bin/
</code></pre> </li><li> <p>创建etcd配置文件</p> 
  <blockquote> 
   <p>注意: 改成你自己的IP</p> 
  </blockquote> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/etcd/cfg/etcd.conf <span class="token operator">&lt;&lt;</span> EOF<span class="token comment">#[Member]ETCD_NAME="etcd-1"ETCD_DATA_DIR="/var/lib/etcd/default.etcd"ETCD_LISTEN_PEER_URLS="https://192.168.8.122:2380"ETCD_LISTEN_CLIENT_URLS="https://192.168.8.122:2379"#[Clustering]ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.8.122:2380"ETCD_ADVERTISE_CLIENT_URLS="https://192.168.8.122:2379"ETCD_INITIAL_CLUSTER="etcd-1=https://192.168.8.122:2380,etcd-2=https://192.168.8.121:2380"ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"ETCD_INITIAL_CLUSTER_STATE="new"EOF</span>
</code></pre> <p>ETCD_NAME:节点名称，集群中唯一</p> <p>ETCD_DATA_DIR:数据目录</p> <p>ETCD_LISTEN_PEER_URLS:集群通信监听地址</p> <p>ETCD_LISTEN_CLIENT_URLS:客户端访问监听地址</p> <p>ETCD_INITIAL_ADVERTISE_PEER_URLS:集群通告地址</p> <p>ETCD_ADVERTISE_CLIENT_URLS:客户端通告地址</p> <p>ETCD_INITIAL_CLUSTER:集群节点地址</p> <p>ETCD_INITIAL_CLUSTER_TOKEN:集群 Token</p> <p>ETCD_INITIAL_CLUSTER_STATE:加入集群的当前状态，new 是新集群，existing 表示加入有集群</p> </li><li> <p>systemd管理etcd</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/etcd.service <span class="token operator">&lt;&lt;</span> EOF<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>Description<span class="token operator">=</span>Etcd <span class="token assign-left variable">ServerAfter</span><span class="token operator">=</span>network.targetAfter<span class="token operator">=</span>network-online.targetWants<span class="token operator">=</span>network-online.target<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>Type<span class="token operator">=</span>notifyEnvironmentFile<span class="token operator">=</span>/opt/etcd/cfg/etcd.confExecStart<span class="token operator">=</span>/opt/etcd/bin/etcd <span class="token punctuation">\</span>--cert-file<span class="token operator">=</span>/opt/etcd/ssl/server.pem <span class="token punctuation">\</span>--key-file<span class="token operator">=</span>/opt/etcd/ssl/server-key.pem <span class="token punctuation">\</span>--peer-cert-file<span class="token operator">=</span>/opt/etcd/ssl/server.pem <span class="token punctuation">\</span>--peer-key-file<span class="token operator">=</span>/opt/etcd/ssl/server-key.pem <span class="token punctuation">\</span>--trusted-ca-file<span class="token operator">=</span>/opt/etcd/ssl/ca.pem <span class="token punctuation">\</span>--peer-trusted-ca-file<span class="token operator">=</span>/opt/etcd/ssl/ca.pem <span class="token punctuation">\</span> --logger<span class="token operator">=</span>zapRestart<span class="token operator">=</span>on-failureLimitNOFILE<span class="token operator">=</span><span class="token number">65536</span><span class="token punctuation">[</span>Install<span class="token punctuation">]</span>WantedBy<span class="token operator">=</span>multi-user.targetEOF
</code></pre> </li><li> <p>拷贝刚才的证书</p> <p>把刚才的证书拷贝到配置文件中的路径</p> <pre><code class="prism language-shell"><span class="token function">cp</span> ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/
</code></pre> </li><li> <p>复制文件到其他节点(换自己的IP)</p> <pre><code class="prism language-shell"><span class="token function">scp</span> -r /opt/etcd/ root@192.168.8.121:/opt/scp /usr/lib/systemd/system/etcd.service root@192.168.8.121:/usr/lib/systemd/system/
</code></pre> </li><li> <p>修改其他节点的配置文件, 分别修改 etcd.conf 配置文件中的节点名称和当前服务器 IP</p> <p>以第二台为例:</p> <p><img src="https://images2.imgbox.com/0a/c9/rqV9YpiZ_o.png" alt="X5CYPF"></p> </li><li> <p>主节点、从节点分别启动并设置开机自启</p> <pre><code class="prism language-shell">systemctl daemon-reloadsystemctl start etcdsystemctl <span class="token builtin class-name">enable</span> etcd
</code></pre> </li><li> <p>查看日志</p> <pre><code class="prism language-shell">jorunalctl -u etcd
</code></pre> </li></ul> 
<h6><a id="4_Kubeapiserver_397"></a>4. 生成Kube-apiserver证书</h6> 
<p><img src="https://images2.imgbox.com/1f/a8/Qj3LUyxb_o.png" alt="xq3hxf"></p> 
<ul><li> <p>自签证书颁发机构(CA)</p> <p>在<code>~/TLS/k8s/</code>下</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> ca-config.json <span class="token operator">&lt;&lt;</span> EOF<span class="token punctuation">{<!-- --></span>    <span class="token string">"signing"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>        <span class="token string">"default"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>            <span class="token string">"expiry"</span><span class="token builtin class-name">:</span> <span class="token string">"87660h"</span>        <span class="token punctuation">}</span>,        <span class="token string">"profiles"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>            <span class="token string">"kubernetes"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>                <span class="token string">"expiry"</span><span class="token builtin class-name">:</span> <span class="token string">"87660h"</span>,                <span class="token string">"usages"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>                    <span class="token string">"signing"</span>,                    <span class="token string">"key encipherment"</span>,                    <span class="token string">"server auth"</span>,                    <span class="token string">"client auth"</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>EOFcat <span class="token operator">&gt;</span> ca-csr.json <span class="token operator">&lt;&lt;</span> EOF<span class="token punctuation">{<!-- --></span>    <span class="token string">"CN"</span><span class="token builtin class-name">:</span> <span class="token string">"kubernetes"</span>,    <span class="token string">"key"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>        <span class="token string">"algo"</span><span class="token builtin class-name">:</span> <span class="token string">"rsa"</span>,        <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>    <span class="token punctuation">}</span>,    <span class="token string">"names"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{<!-- --></span>            <span class="token string">"C"</span><span class="token builtin class-name">:</span> <span class="token string">"CN"</span>,            <span class="token string">"L"</span><span class="token builtin class-name">:</span> <span class="token string">"Beijing"</span>,            <span class="token string">"ST"</span><span class="token builtin class-name">:</span> <span class="token string">"Beijing"</span>,            <span class="token string">"O"</span><span class="token builtin class-name">:</span> <span class="token string">"k8s"</span>,            <span class="token string">"OU"</span><span class="token builtin class-name">:</span> <span class="token string">"System"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span>EOF
</code></pre> <p>生成证书</p> <pre><code class="prism language-shell">cfssl gencert -initca ca-csr.json <span class="token operator">|</span> cfssljson -bare ca -
</code></pre> </li><li> <p>使用自签CA签发kube-apiserver HTTPS证书</p> <p>创建证书申请文件:</p> 
  <blockquote> 
   <p><font color="#e54d42">这里的hosts就是信任的节点IP</font></p> 
  </blockquote> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> server-csr.json <span class="token operator">&lt;&lt;</span> EOF<span class="token punctuation">{<!-- --></span>    <span class="token string">"CN"</span><span class="token builtin class-name">:</span> <span class="token string">"kubernetes"</span>,    <span class="token string">"hosts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token string">"10.0.0.1"</span>,        <span class="token string">"127.0.0.1"</span>,        <span class="token string">"192.168.8.121"</span>,        <span class="token string">"192.168.8.122"</span>,        <span class="token string">"kubernetes"</span>,        <span class="token string">"kubernetes.default"</span>,        <span class="token string">"kubernetes.default.svc"</span>,        <span class="token string">"kubernetes.default.svc.cluster"</span>,        <span class="token string">"kubernetes.default.svc.cluster.local"</span>    <span class="token punctuation">]</span>,    <span class="token string">"key"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>        <span class="token string">"algo"</span><span class="token builtin class-name">:</span> <span class="token string">"rsa"</span>,        <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>    <span class="token punctuation">}</span>,    <span class="token string">"names"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>        <span class="token string">"C"</span><span class="token builtin class-name">:</span> <span class="token string">"CN"</span>,        <span class="token string">"L"</span><span class="token builtin class-name">:</span> <span class="token string">"BeiJing"</span>,        <span class="token string">"ST"</span><span class="token builtin class-name">:</span> <span class="token string">"BeiJing"</span>,        <span class="token string">"O"</span><span class="token builtin class-name">:</span> <span class="token string">"k8s"</span>,        <span class="token string">"OU"</span><span class="token builtin class-name">:</span> <span class="token string">"System"</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>EOF
</code></pre> <p>生成证书</p> <pre><code class="prism language-shell">cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes server-csr.json <span class="token operator">|</span> cfssljson -bare server
</code></pre> <p>复制证书:</p> <pre><code class="prism language-shell"><span class="token function">cp</span> ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/
</code></pre> </li></ul> 
<h6><a id="5MasterNode_437"></a>5.部署Master-Node</h6> 
<p>在Master主机上操作, 我这里是192.168.8.122节点</p> 
<blockquote> 
 <p><font color="#39b54a"><strong>部署MasterNode一共要部署三个组件: kube-apiserver、 kube-controller-manager、 kube-scheduler, 这些组件启动需要特定的配置文件, 并且将其加入到system管理中,方便日后管理.</strong></font></p> 
</blockquote> 
<p>下载源文件</p> 
<p>下载地址: https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG- 1.18.md#v1183</p> 
<blockquote> 
 <p>貌似已经失效了, 找到的可用的新的连接:</p> 
 <p>https://dl.k8s.io/v1.19.0/kubernetes-server-linux-amd64.tar.gz</p> 
</blockquote> 
<p>只需要压缩包中的server文件夹就够了</p> 
<p>解压压缩包:</p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> -p /opt/kubernetes/<span class="token punctuation">{<!-- --></span>bin,cfg,ssl,logs<span class="token punctuation">}</span>tar zxvf kubernetes-server-linux-amd64.tar.gzcd kubernetes/server/bincp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin <span class="token function">cp</span> kubectl /usr/bin/
</code></pre> 
<h6><a id="1kubeapiserver_459"></a>1.部署kube-apiserver</h6> 
<ul><li> <p>创建配置文件</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/kube-apiserver.conf <span class="token operator">&lt;&lt;</span> <span class="token assign-left variable">EOFKUBE_APISERVER_OPTS</span><span class="token operator">=</span><span class="token string">"--logtostderr=false <span class="token entity" title="\\">\\</span>--v=2 <span class="token entity" title="\\">\\</span>--log-dir=/opt/kubernetes/logs <span class="token entity" title="\\">\\</span>--etcd-servers=https://192.168.8.121:2379,https://192.168.8.122:2379 <span class="token entity" title="\\">\\</span>--bind-address=192.168.8.122 <span class="token entity" title="\\">\\</span>--secure-port=6443 <span class="token entity" title="\\">\\</span>--advertise-address=192.168.8.122 <span class="token entity" title="\\">\\</span>--allow-privileged=true <span class="token entity" title="\\">\\</span>--service-cluster-ip-range=10.0.0.0/24 <span class="token entity" title="\\">\\</span>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction <span class="token entity" title="\\">\\</span>--authorization-mode=RBAC,Node <span class="token entity" title="\\">\\</span>--enable-bootstrap-token-auth=true <span class="token entity" title="\\">\\</span>--token-auth-file=/opt/kubernetes/cfg/token.csv <span class="token entity" title="\\">\\</span>--service-node-port-range=30000-32767 <span class="token entity" title="\\">\\</span>--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem <span class="token entity" title="\\">\\</span>--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem <span class="token entity" title="\\">\\</span>--tls-cert-file=/opt/kubernetes/ssl/server.pem  <span class="token entity" title="\\">\\</span>--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem <span class="token entity" title="\\">\\</span>--client-ca-file=/opt/kubernetes/ssl/ca.pem <span class="token entity" title="\\">\\</span>--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem <span class="token entity" title="\\">\\</span>--etcd-cafile=/opt/etcd/ssl/ca.pem <span class="token entity" title="\\">\\</span>--etcd-certfile=/opt/etcd/ssl/server.pem <span class="token entity" title="\\">\\</span>--etcd-keyfile=/opt/etcd/ssl/server-key.pem <span class="token entity" title="\\">\\</span>--audit-log-maxage=30 <span class="token entity" title="\\">\\</span>--audit-log-maxbackup=3 <span class="token entity" title="\\">\\</span>--audit-log-maxsize=100 <span class="token entity" title="\\">\\</span>--audit-log-path=/opt/kubernetes/logs/k8s-audit.log"</span>EOF
</code></pre> <p>注：上面两个\ \ 第一个是转义符，第二个是换行符，使用转义符是为了使用 EOF 保留换行符。<br> –logtostderr：启用日志<br> —v：日志等级<br> –log-dir：日志目录<br> –etcd-servers：etcd 集群地址 (使用自己的etcd集群地址)<br> –bind-address：监听地址<br> –secure-port：https 安全端口<br> –advertise-address：集群通告地址<br> –allow-privileged：启用授权<br> –service-cluster-ip-range：Service 虚拟 IP 地址段<br> –enable-admission-plugins：准入控制模块<br> –authorization-mode：认证授权，启用 RBAC 授权和节点自管理<br> –enable-bootstrap-token-auth：启用 TLS bootstrap 机制 (新加入节点就自动授权,不用手动签署证书)<br> –token-auth-file：bootstrap token 文件<br> –service-node-port-range：Service nodeport 类型默认分配端口范围<br> –kubelet-client-xxx：apiserver 访问 kubelet 客户端证书<br> –tls-xxx-file：apiserver https 证书<br> –etcd-xxxfile：连接 Etcd 集群证书<br> –audit-log-xxx：审计日志</p> </li><li> <p>启用TLS Bootstrapping机制</p> <p>TLS Bootstraping:Master apiserver 启用 TLS 认证后，Work Node 节点 kubelet 和 kube- proxy 要与 kube-apiserver 进行通信，必须使用 CA 签发的有效证书才可以，当 Node 节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程, kubernetes引入了TLS bootstraping机制来自动颁发客户端证书,kubelet会以一个低权限用户向apiserver申请证书, kubelet证书由apiserver动态签署.</p> <p><img src="https://images2.imgbox.com/9c/a5/Nq2euRbo_o.png" alt="gEHQLj"></p> <p>创建上述描述文件:</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/token.csv <span class="token operator">&lt;&lt;</span> EOFc47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,<span class="token string">"system:node-bootstrapper"</span>EOF
</code></pre> <p>格式: <code>token，用户名，UID，用户组 token</code> 也可自行生成替换:</p> <p><code>head -c 16 /dev/urandom | od -An -t x | tr -d ''</code></p> </li><li> <p>system管理apiserver配置:</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service <span class="token operator">&lt;&lt;</span> EOF<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>Description<span class="token operator">=</span>Kubernetes API <span class="token assign-left variable">ServerDocumentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>EnvironmentFile<span class="token operator">=</span>/opt/kubernetes/cfg/kube-apiserver.confExecStart<span class="token operator">=</span>/opt/kubernetes/bin/kube-apiserver <span class="token punctuation">\</span><span class="token variable">$KUBE_APISERVER_OPTSRestart</span><span class="token operator">=</span>on-failure<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>WantedBy<span class="token operator">=</span>multi-user.targetEOF
</code></pre> </li><li> <p>启动并设置开机自启</p> <pre><code class="prism language-shell">systemctl daemon-reload systemctl start kube-apiserver <span class="token comment"># 检查启动状态systemctl status kube-apiserver		# 查看错误log输出cat /var/log/messages|grep kube-apiserver|grep -i errorsystemctl enable kube-apiserver		# 设置开机自启</span>
</code></pre> 
  <blockquote> 
   <p><strong>错误:</strong> service-account-issuer is a required flag, --service-account-signing-key-file and --service-account-issuer are required flags</p> 
   <p><strong>原因:</strong> 下载的kubernetes-server源文件版本过高(1.20)导致kube-apiserver等执行命令的版本都是1.20, 高版本需要在/opt/kubernetes/cfg/kube-apiserver.conf配置文件中配置以上几个参数</p> 
   <p><strong>解决:</strong> 重新下载低版本</p> 
   <p>https://github.com/kelseyhightower/kubernetes-the-hard-way/issues/626</p> 
  </blockquote> <p>正常运行:</p> <p><img src="https://images2.imgbox.com/10/59/CZakzVZz_o.png" alt="O1APRA"></p> </li><li> <p>授权kubelet-bootstrap用户允许请求证书</p> <pre><code class="prism language-shell">kubectl create clusterrolebinding kubelet-bootstrap <span class="token punctuation">\</span>--clusterrole<span class="token operator">=</span>system:node-bootstrapper <span class="token punctuation">\</span>--user<span class="token operator">=</span>kubelet-bootstrap
</code></pre> <p>提示: <code>clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created</code>代表成功</p> </li></ul> 
<h6><a id="2kubecontrollermanager_535"></a>2.部署kube-controller-manager</h6> 
<ul><li> <p>创建配置文件</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/kube-controller-manager.conf <span class="token operator">&lt;&lt;</span> <span class="token assign-left variable">EOFKUBE_CONTROLLER_MANAGER_OPTS</span><span class="token operator">=</span><span class="token string">"--logtostderr=false <span class="token entity" title="\\">\\</span>--v=2 <span class="token entity" title="\\">\\</span>--log-dir=/opt/kubernetes/logs <span class="token entity" title="\\">\\</span>--leader-elect=true <span class="token entity" title="\\">\\</span>--master=127.0.0.1:8080 <span class="token entity" title="\\">\\</span>--bind-address=127.0.0.1 <span class="token entity" title="\\">\\</span>--allocate-node-cidrs=true <span class="token entity" title="\\">\\</span>--cluster-cidr=10.244.0.0/16 <span class="token entity" title="\\">\\</span>--service-cluster-ip-range=10.0.0.0/24 <span class="token entity" title="\\">\\</span>--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem <span class="token entity" title="\\">\\</span>--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  <span class="token entity" title="\\">\\</span>--root-ca-file=/opt/kubernetes/ssl/ca.pem <span class="token entity" title="\\">\\</span>--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem <span class="token entity" title="\\">\\</span>--experimental-cluster-signing-duration=87600h0m0s"</span>EOF
</code></pre> <p>–master：通过本地非安全本地端口 8080 连接 apiserver。</p> <p>–leader-elect：当该组件启动多个时，自动选举（HA）</p> <p>–cluster-signing-cert-file/–cluster-signing-key-file：自动为 kubelet 颁发证书的 CA，与apiserver保持一致/相同</p> </li><li> <p>使用Systemd管理controller-manager</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-controller-manager.service <span class="token operator">&lt;&lt;</span> EOF<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>Description<span class="token operator">=</span>Kubernetes Controller <span class="token assign-left variable">ManagerDocumentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>EnvironmentFile<span class="token operator">=</span>/opt/kubernetes/cfg/kube-controller-manager.confExecStart<span class="token operator">=</span>/opt/kubernetes/bin/kube-controller-manager <span class="token punctuation">\</span><span class="token variable">$KUBE_CONTROLLER_MANAGER_OPTSRestart</span><span class="token operator">=</span>on-failure<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>WantedBy<span class="token operator">=</span>multi-user.targetEOF
</code></pre> </li><li> <p>启动并设置开机自启</p> <pre><code class="prism language-shell">systemctl daemon-reloadsystemctl start kube-controller-managersystemctl <span class="token builtin class-name">enable</span> kube-controller-managersystemctl status kube-controller-manager
</code></pre> </li></ul> 
<h6><a id="3kubescheduler_561"></a>3.部署kube-scheduler</h6> 
<ul><li> <p>创建配置文件</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/kube-scheduler.conf <span class="token operator">&lt;&lt;</span> <span class="token assign-left variable">EOFKUBE_SCHEDULER_OPTS</span><span class="token operator">=</span><span class="token string">"--logtostderr=false \--v=2 \--log-dir=/opt/kubernetes/logs \--leader-elect \--master=127.0.0.1:8080 \--bind-address=127.0.0.1"</span>EOF
</code></pre> <p>–master：通过本地非安全本地端口 8080 连接 apiserver。</p> <p>–leader-elect：当该组件启动多个时，自动选举（HA）</p> </li><li> <p>systemctl管理</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-scheduler.service <span class="token operator">&lt;&lt;</span> EOF<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>Description<span class="token operator">=</span>Kubernetes <span class="token assign-left variable">SchedulerDocumentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>EnvironmentFile<span class="token operator">=</span>/opt/kubernetes/cfg/kube-scheduler.confExecStart<span class="token operator">=</span>/opt/kubernetes/bin/kube-scheduler <span class="token punctuation">\</span><span class="token variable">$KUBE_SCHEDULER_OPTSRestart</span><span class="token operator">=</span>on-failure<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>WantedBy<span class="token operator">=</span>multi-user.targetEOF
</code></pre> </li><li> <p>启动与开机自启</p> <pre><code class="prism language-shell">systemctl daemon-reloadsystemctl start kube-schedulersystemctl <span class="token builtin class-name">enable</span> kube-schedulersystemctl status kube-scheduler
</code></pre> </li></ul> 
<h6><a id="4_585"></a>4.查看集群状态</h6> 
<p><code>kubectl get cs</code></p> 
<p><img src="https://images2.imgbox.com/ff/a6/ymC8B4yj_o.png" alt="acdmko"></p> 
<h6><a id="6_workNode_591"></a>6. 部署work-Node</h6> 
<p>在工作节点上操作,我这里是192.168.8.121节点</p> 
<blockquote> 
 <p><font color="#39b54a"><strong>工作节点需要安装的组件有: kubelet、 kube-proxy, 同样的使用systemctl进行管理</strong></font></p> 
</blockquote> 
<p>下载kubelet、 kube-proxy源文件</p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> -p /opt/kubernetes/<span class="token punctuation">{<!-- --></span>bin,cfg,ssl,logs<span class="token punctuation">}</span>tar zxvf kubernetes-server-linux-amd64.tar.gzcd kubernetes/server/bincp kubelet kube-proxy /opt/kubernetes/bincp kubectl /usr/bin/
</code></pre> 
<p>或者直接从Master节点发送过来</p> 
<pre><code class="prism language-shell"><span class="token comment"># work节点mkdir -p /opt/kubernetes/{bin,cfg,ssl,logs}# master节点scp ~/k8s/kubernetes/server/bin/kubelet root@192.168.8.121:/opt/kubernetes/binscp ~/k8s/kubernetes/server/bin/kube-proxy root@192.168.8.121:/opt/kubernetes/binscp ~/k8s/kubernetes/server/bin/kubectl root@192.168.8.121:/usr/bin</span>
</code></pre> 
<p>拷贝Master上的一些配置文件到node节点:</p> 
<pre><code class="prism language-shell"><span class="token function">scp</span> -r /opt/kubernetes/ssl root@192.168.8.121:/opt/kubernetes
</code></pre> 
<h6><a id="1kubelet_615"></a>1.部署kubelet</h6> 
<ul><li> <p>配置文件</p> <p><font color="#e54d42"><strong>注意, 这里换成你的worknode的主机名</strong></font></p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/kubelet.conf <span class="token operator">&lt;&lt;</span> <span class="token assign-left variable">EOFKUBELET_OPTS</span><span class="token operator">=</span><span class="token string">"--logtostderr=false <span class="token entity" title="\\">\\</span>--v=2 <span class="token entity" title="\\">\\</span>--log-dir=/opt/kubernetes/logs <span class="token entity" title="\\">\\</span>--hostname-override=121-k8snode1 <span class="token entity" title="\\">\\</span>			--network-plugin=cni <span class="token entity" title="\\">\\</span>--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig <span class="token entity" title="\\">\\</span>--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig <span class="token entity" title="\\">\\</span>--config=/opt/kubernetes/cfg/kubelet-config.yml <span class="token entity" title="\\">\\</span>--cert-dir=/opt/kubernetes/ssl <span class="token entity" title="\\">\\</span>--pod-infra-container-image=lizhenliang/pause-amd64:3.0"</span>EOF
</code></pre> <p>–hostname-override：显示名称，集群中唯一<br> –network-plugin：启用CNI<br> –kubeconfig：空路径，会自动生成，后面用于连接apiserver<br> –bootstrap-kubeconfig：首次启动向apiserver申请证书<br> –config：配置参数文件<br> –cert-dir：kubelet证书生成目录<br> –pod-infra-container-image：管理Pod网络容器的镜像</p> <p>kubelet-config.yml文件:</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/kubelet-config.yml <span class="token operator">&lt;&lt;</span> EOFkind: KubeletConfigurationapiVersion: kubelet.config.k8s.io/v1beta1address: <span class="token number">0.0</span>.0.0port: 10250readOnlyPort: 10255cgroupDriver: cgroupfsclusterDNS:- <span class="token number">10.0</span>.0.2clusterDomain: cluster.local failSwapOn: falseauthentication:  anonymous:    enabled: <span class="token boolean">false</span>  webhook:    cacheTTL: 2m0s    enabled: <span class="token boolean">true</span>  x509:    clientCAFile: /opt/kubernetes/ssl/ca.pem authorization:  mode: Webhook  webhook:    cacheAuthorizedTTL: 5m0s    cacheUnauthorizedTTL: 30sevictionHard:  imagefs.available: <span class="token number">15</span>%  memory.available: 100Mi  nodefs.available: <span class="token number">10</span>%  nodefs.inodesFree: <span class="token number">5</span>%maxOpenFiles: 1000000maxPods: 110EOF
</code></pre> </li><li> <p>生成bootstrap.kubeconfig文件</p> <pre><code class="prism language-shell"><span class="token assign-left variable">KUBE_APISERVER</span><span class="token operator">=</span><span class="token string">"https://192.168.8.122:6443"</span> <span class="token comment"># apiserver IP:PORTTOKEN="c47ffb939f5ca36231d9e3121a252940" # 与token.csv里保持一致kubectl config set-cluster kubernetes \  --certificate-authority=/opt/kubernetes/ssl/ca.pem \  --embed-certs=true \  --server=${KUBE_APISERVER} \  --kubeconfig=bootstrap.kubeconfigkubectl config set-credentials "kubelet-bootstrap" \  --token=${TOKEN} \  --kubeconfig=bootstrap.kubeconfigkubectl config set-context default \  --cluster=kubernetes \  --user="kubelet-bootstrap" \  --kubeconfig=bootstrap.kubeconfigkubectl config use-context default --kubeconfig=bootstrap.kubeconfigmv bootstrap.kubeconfig /opt/kubernetes/cfg</span>
</code></pre> <p>生成的文件类似如下:</p> <p><img src="https://images2.imgbox.com/be/78/dytZPLyN_o.png" alt="d2uzo0"></p> </li><li> <p>systemctl管理kunelet</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kubelet.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[Unit]
Description=Kubernetes Kubelet
After=docker.service
[Service]
EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf
ExecStart=/opt/kubernetes/bin/kubelet \<span class="token variable">$KUBELET_OPTS</span>
Restart=on-failure
LimitNOFILE=65536
[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> </li><li> <p>启动并设置开机自启</p> <pre><code class="prism language-shell">systemctl daemon-reload
systemctl start kubelet
systemctl <span class="token builtin class-name">enable</span> kubelet
systemctl status kubelet
systemctl restart kubelet		<span class="token comment">#  重启</span>
</code></pre> </li><li> <p>批准kubelet证书申请并加入集群(Master操作)</p> <pre><code class="prism language-shell"><span class="token comment"># 查看kubelet证书请求</span>
kubectl get csr
NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION
node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A   6m3s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending

<span class="token comment"># 批准申请(这里后面的Name是上面的Name,每个节点都不同)</span>
kubectl certificate approve node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A

<span class="token comment"># 查看节点</span>
kubectl get node
</code></pre> <p><img src="https://images2.imgbox.com/b0/f2/2463x3pE_o.png" alt="XPDOqE"></p> <p>注:由于网络插件还没有部署，节点会没有准备就绪 NotReady</p> </li></ul> 
<h6><a id="2kubeproxy_695"></a>2.部署kube-proxy</h6> 
<ul><li> <p>配置文件</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/kube-proxy.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
KUBE_PROXY_OPTS="--logtostderr=false <span class="token entity" title="\\">\\</span>
--v=2 <span class="token entity" title="\\">\\</span>
--log-dir=/opt/kubernetes/logs <span class="token entity" title="\\">\\</span>
--config=/opt/kubernetes/cfg/kube-proxy-config.yml"
EOF</span>
</code></pre> <p><font color="#e54d42"><strong>注意, 这里换成你的worknode的主机名</strong></font></p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/kubernetes/cfg/kube-proxy-config.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
metricsBindAddress: 0.0.0.0:10249
clientConnection:
  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig
hostnameOverride: 121-k8snode1			
clusterCIDR: 10.0.0.0/24
EOF</span>
</code></pre> </li><li> <p>生成kube-proxy.kubeconfig文件(master生成在传到node)</p> <p>master</p> <pre><code class="prism language-shell"><span class="token comment"># 切换工作目录</span>
<span class="token builtin class-name">cd</span> ~/TLS/k8s
<span class="token comment"># 创建证书请求文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> kube-proxy-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
{
  "CN": "system:kube-proxy",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "BeiJing",
      "ST": "BeiJing",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
EOF</span>
<span class="token comment"># 生成证书</span>
cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-proxy-csr.json <span class="token operator">|</span> cfssljson -bare kube-proxy

<span class="token comment"># 发送</span>
<span class="token function">scp</span> -r /root/TLS/k8s root@192.168.8.121:/opt/TLS/
</code></pre> </li><li> <p>生成kubeconfig文件</p> <pre><code class="prism language-shell"><span class="token assign-left variable">KUBE_APISERVER</span><span class="token operator">=</span><span class="token string">"https://192.168.8.122:6443"</span>
kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
  --certificate-authority<span class="token operator">=</span>/opt/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
  --server<span class="token operator">=</span><span class="token variable">${KUBE_APISERVER}</span> <span class="token punctuation">\</span>
  --kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig
kubectl config set-credentials kube-proxy <span class="token punctuation">\</span>
  --client-certificate<span class="token operator">=</span>./kube-proxy.pem <span class="token punctuation">\</span>
  --client-key<span class="token operator">=</span>./kube-proxy-key.pem <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
  --kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig
kubectl config set-context default <span class="token punctuation">\</span>
  --cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
  --user<span class="token operator">=</span>kube-proxy <span class="token punctuation">\</span>
  --kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig
kubectl config use-context default --kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig


<span class="token function">cp</span> kube-proxy.kubeconfig /opt/kubernetes/cfg/
</code></pre> </li><li> <p>systemd管理kube-proxy</p> <pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-proxy.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[Unit]
Description=Kubernetes Proxy
After=network.target
[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf
ExecStart=/opt/kubernetes/bin/kube-proxy \<span class="token variable">$KUBE_PROXY_OPTS</span>
Restart=on-failure
LimitNOFILE=65536
[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> </li><li> <p>启动并设置开机自启</p> <pre><code class="prism language-shell">systemctl daemon-reload

systemctl start kube-proxy

systemctl <span class="token builtin class-name">enable</span> kube-proxy

systemctl status kube-proxy
</code></pre> </li></ul> 
<h6><a id="3CNI_810"></a>3.部署CNI网络</h6> 
<pre><code class="prism language-shell"><span class="token function">wget</span> https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz
</code></pre> 
<p>node节点操作</p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> /opt/cni/bin
<span class="token function">tar</span> zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin
</code></pre> 
<p>master节点操作:</p> 
<blockquote> 
 <p>kube-flannel.yml文件下载</p> 
 <p>链接：https://pan.baidu.com/s/1abu6OwzAgcRdpbEpPPpDnw<br> 提取码：hvf3</p> 
</blockquote> 
<pre><code class="prism language-shell">kubectl apply -f kube-flannel.yml
</code></pre> 
<p><img src="https://images2.imgbox.com/a6/68/DY3OyrXP_o.png" alt="Wh1ZnK"></p> 
<h6><a id="4__836"></a>4. 查看集群状态</h6> 
<p>再次检查node节点状态:</p> 
<pre><code class="prism language-shell">kubectl get nodes
</code></pre> 
<p><img src="https://images2.imgbox.com/a5/d7/nTPFLunl_o.png" alt="Fdlx4R"></p> 
<h2><a id="_846"></a>错误栈</h2> 
<p>所有错误首先要做的就是去看对应组件的日志</p> 
<pre><code class="prism language-shell">systemctl status <span class="token punctuation">[</span>组件名<span class="token punctuation">]</span> -l
</code></pre> 
<h3><a id="1creating_854"></a>1.容器无法部署,一直在创建creating</h3> 
<p>我是配置kubelet时主机名称设置错误, 重装即可</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0cc8ca95aceae65e468e4ffb95c027cb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Video SR-2</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7a1414e1292f6182295284ee4b8bf489/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java网络编程入门</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>