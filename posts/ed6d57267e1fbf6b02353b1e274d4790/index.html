<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux入侵检测病毒清理流程 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux入侵检测病毒清理流程" />
<meta property="og:description" content="Linux入侵检测病毒清理流程
1.前言：
根据阿里云快讯病毒公布：
Redis RCE导致h2Miner蠕虫病毒，其利用Redis未授权或弱口令作为入口，使用主从同步的方式从恶意服务器上同步恶意module，之后在目标机器上加载此恶意module并执行恶意指令。在以往常见的攻击者或蠕虫中，其大多都沿用登陆redis后写入定时任务或写ssh key的方式进行入侵，这种方式受权限与系统类型影响并不一定能够成功。而此次使用redis加载module的攻击方式，可以直接执行任意指令或拿到shell交互环境，危害极大。
当服务器中毒了，使用SSH/FTPS大多连接不上的。这时候就需要到云平台，使用VNC方式登录。 2.确认Linux是否是中毒
1.使用命令查看当前系统所有进程
一般消耗CUP或者内存90%以上的基本都是病毒，常见的挖矿进程：xfsdatad、rshim、YDService.exe、kinsing、kdevtmpfsi、sysupdate、systemxlv、kthreaddi、kthreaddk 等，病毒进程一版都会跟系统进程名称相似，要注意区分
top 或 ps aux | less
注：top实时监控退出按键：q
2.查看隐藏进程
如果top命令查看没发现异常，但是服务器依然很卡，服务器资源占用居高不下，那就换个命令，查看是否存在隐藏进程
ps -aux --sort=-pcpu|head -10
3. 确定病毒攻击方式
1.使用命令查看系统日志：
cat /var/log/secure
1.1分析日志文件，看看是否是远程强行破解系统密码，如下：如果是远程登录root，清理病毒后要修改root的密码
1.2如果不是远程登录root，很可能是redis远程登录导致：1.1.2查看redis连接记录：
lsof -i:6379
如果有大量异常链接，立即找到redis安装路径，打开 redis.conf
vim redis.conf
把 bind:127.0.0.1 打开，重启redis
ps -ef | grep redis
kill -9 PID
./src/redis-server ./redis.conf
1.1.3如果redis也没有问题，那就查看系统其他用户：查看系统用户
vim /etc/shadow 或者 vim /etc/passwd
检查是否有异常的用户名，如果有就删除
userdel -r 用户名
4.查看单个进程的执行日志：
more /var/log/cron log | grep “进程名称”
3.病毒查杀
1.先确定挖矿进程的PID" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/ed6d57267e1fbf6b02353b1e274d4790/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-23T23:00:47+08:00" />
<meta property="article:modified_time" content="2023-06-23T23:00:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux入侵检测病毒清理流程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>Linux入侵检测病毒清理流程<br> 1.前言：</p> 
<p>根据阿里云快讯病毒公布：</p> 
<p>Redis RCE导致h2Miner蠕虫病毒，其利用Redis未授权或弱口令作为入口，使用主从同步的方式从恶意服务器上同步恶意module，之后在目标机器上加载此恶意module并执行恶意指令。在以往常见的攻击者或蠕虫中，其大多都沿用登陆redis后写入定时任务或写ssh key的方式进行入侵，这种方式受权限与系统类型影响并不一定能够成功。而此次使用redis加载module的攻击方式，可以直接执行任意指令或拿到shell交互环境，危害极大。</p> 
<pre><code>    当服务器中毒了，使用SSH/FTPS大多连接不上的。这时候就需要到云平台，使用VNC方式登录。
</code></pre> 
<p>2.确认Linux是否是中毒</p> 
<p>1.使用命令查看当前系统所有进程</p> 
<p>一般消耗CUP或者内存90%以上的基本都是病毒，常见的挖矿进程：xfsdatad、rshim、YDService.exe、kinsing、kdevtmpfsi、sysupdate、systemxlv、kthreaddi、kthreaddk 等，病毒进程一版都会跟系统进程名称相似，要注意区分</p> 
<p>top 或 ps aux | less<br> 注：top实时监控退出按键：q</p> 
<p>2.查看隐藏进程</p> 
<p>如果top命令查看没发现异常，但是服务器依然很卡，服务器资源占用居高不下，那就换个命令，查看是否存在隐藏进程</p> 
<p>ps -aux --sort=-pcpu|head -10<br> 3. 确定病毒攻击方式</p> 
<p>1.使用命令查看系统日志：</p> 
<p>cat /var/log/secure<br> 1.1分析日志文件，看看是否是远程强行破解系统密码，如下：如果是远程登录root，清理病毒后要修改root的密码</p> 
<p>1.2如果不是远程登录root，很可能是redis远程登录导致：1.1.2查看redis连接记录：</p> 
<p>lsof -i:6379<br> 如果有大量异常链接，立即找到redis安装路径，打开 redis.conf</p> 
<p>vim redis.conf<br> 把 bind:127.0.0.1 打开，重启redis</p> 
<p>ps -ef | grep redis</p> 
<p>kill -9 PID</p> 
<p>./src/redis-server ./redis.conf<br> 1.1.3如果redis也没有问题，那就查看系统其他用户：查看系统用户</p> 
<p>vim /etc/shadow 或者 vim /etc/passwd<br> 检查是否有异常的用户名，如果有就删除</p> 
<p>userdel -r 用户名<br> 4.查看单个进程的执行日志：</p> 
<p>more /var/log/cron log | grep “进程名称”<br> 3.病毒查杀</p> 
<p>1.先确定挖矿进程的PID</p> 
<p>根据 top 查到的病毒进程，利用PID查看一系列的相关守护进程：</p> 
<p>systemctl status PID<br> 查看所有的守护进程，示例图：</p> 
<p>2.根据展示出来的守护进程，从最高层守护开始杀起（先杀父类）。</p> 
<p>删除最顶层fule守护进程：</p> 
<p>rm -rf 路径 或 find / -name “<em>路径</em>” | xargs rm -rf<br> 有某部分比较刁钻的病毒会报告：rm: cannot remove '文件名称 ': Operation not permitted</p> 
<p>这种情况可能性一，不在root的权限下，切换root再操作。可能性二：病毒使用了chattr 文件锁定的命令。我们只要先执行文件解锁，然后就可以正常删除了</p> 
<p>chattr -i 文件名称<br> ps -ef | grep 守护进程名称<br> 或者</p> 
<p>ps -ef | grep 守护进程名称 | grep -v grep<br> kill -9 PID<br> 注意，有部分挖矿在删除时会触发自我复制，所以删除前可以先控制权限和删除定时扫描：</p> 
<p>chmod 600 守护进程路径<br> 查看定时器，需要在root权限操作：</p> 
<p>查看所有定时器</p> 
<p>crontab -l<br> 如果确认linux服务器重来没有建过定时任务，就可以全部清除</p> 
<p>crontab -r<br> 如果有自定义的定时器就可以编辑：</p> 
<p>crontab -e<br> 手动删除可疑任务后保存退出</p> 
<p>很多病毒是会扫描定时器的，所以在清除定时任务之前，需要把病毒守护进程里面的病毒文件先降低权限才会生效 命令：chmod 600 守护进程路径</p> 
<p>权限降低，清除定时任务 那就可以逐个杀死进程了，由下往上一个个 kill -9 进程号，例如：先杀 9015</p> 
<p>把进程全干掉后就删除对应文件（根据进程树中的文件路径）</p> 
<p>3.如果没有守护进程，那就更简单，直接先控制文件权限，然后停止进程，清理定时任务，最后删除病毒路径即可。</p> 
<p>到此，病毒清理完成。</p> 
<p>4.其他安全建议：</p> 
<p>1.禁止root登录</p> 
<p>使用自定义的用户登录，再切换Root即可</p> 
<p>2.查看SSH链接公钥，清除所有可疑的公钥。</p> 
<p>一般只用用户名密码登录的服务器是不会有公钥文件的，如果有也是空文件。查看公钥文件：</p> 
<p>vim /root/.ssh/authorized_keys</p> 
<h2><a id="_127"></a>解除锁定</h2> 
<p>chattr -i /root/.ssh/authorized_keys</p> 
<h2><a id="_131"></a>编辑权限</h2> 
<p>chmod 777 /root/.ssh/authorized_keys</p> 
<h2><a id="authorized_keys_135"></a>清空或清除不是自建的authorized_keys</h2> 
<p>vi /root/.ssh/authorized_keys</p> 
<h2><a id="_139"></a>清空后恢复权限</h2> 
<p>chmod 400 /root/.ssh/authorized_keys</p> 
<h2><a id="authorized_keys_143"></a>锁定authorized_keys</h2> 
<p>chattr +i /root/.ssh/authorized_keys</p> 
<h2><a id="ssh_147"></a>防止通过重命名.ssh文件夹绕过设置</h2> 
<p>chattr +i /root/.ssh</p> 
<p>3.一定要打开防火墙</p> 
<p>查看防火墙状态命令：</p> 
<p>systemctl status firewalld<br> 如果不是显示active状态，需要打开防火墙，注意要配置穿透自己需要用到的端口号</p> 
<p>systemctl start firewalld<br> 4.要尽量禁止redis的远程访问，redis必须要设置访问密码。</p> 
<p>5.Linux病毒防护软件：</p> 
<p>安装clamAV：</p> 
<p>yum -y install clamav<br> 更新病毒库（需要时间很长，大约20~30分钟）：</p> 
<p>freshclam<br> 查杀当前目录并删除感染的文件：</p> 
<p>clamscan -r --remove<br> 查杀当前目录并删除感染的文件：</p> 
<p>clamscan -r<br> clamAV帮助命令：</p> 
<p>clamscan help<br> 如有错漏或者有更好的技巧，麻烦留言交流。共同进步！！！<br> ————————————————<br> 版权声明：本文为CSDN博主「提枪北上」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br> 原文链接：https://blog.csdn.net/ouxx2009/article/details/123479424</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ab319ea02b49d91f2ba27771bc58ee1b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CentOS7离线安装GCC9.3.0（亲测）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/424ffb1f64370bf533a14f72202efde7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">赞爆！凭借阿里的Java面试突击手册，成功翻盘上岸</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>