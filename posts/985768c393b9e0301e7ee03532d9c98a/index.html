<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>okhttp导致的内存溢出(OOM)sun.security.ssl.SSLSocketImpl - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="okhttp导致的内存溢出(OOM)sun.security.ssl.SSLSocketImpl" />
<meta property="og:description" content="使用分析工具：MAT(Memory Analyzer Tool)、JvisualVM占用内存：sun.security.ssl.SSLSocketImpl 一、 项目场景： 功能：一个定时任务(xxl-job)采用线程池的方式多线程请求第三方拉取数据，网络框架使用okhttp3。
问题：执行job时，内存短时间内暴增，导致OOM
二、问题描述 定时任务执行时，突然内存激增，OOM导致项目重启。下面这张图是重启后再次执行定时任务的内存监控
三、原因分析： 3.1 查看堆栈信息 使用MAT查看堆栈信息，sun.security.ssl.SSLSocketImpl这个东西占了62%
点击Details ，可以看到有9k多个对象
使用OQL查询sun.security.ssl.SSLSocketImpl，发现其中的host都是请求第三方的地址
select * from sun.security.ssl.SSLSocketImpl
到这里，基本可以定位到是由于请求第三方资源没有释放，导致内存暴增。接下来查看请求第三方的代码
3.2 查看代码 看到底层工具类OkHttpClientUtil工具类中获取OkHttpClient对象的代码是这样的，每次请求都是new一个OkhttpClient对象，可能是每次都是new一个OkhttpClient的问题，于是在本地复现。
private static OkHttpClient getHttpClient() { return new OkHttpClient.Builder() .connectTimeout(obtainConnectTimeOut(), TimeUnit.MILLISECONDS) .writeTimeout(obtainWriteTimeOut(), TimeUnit.MILLISECONDS) .readTimeout(obtainReadTimeOut(), TimeUnit.MILLISECONDS) .build(); } 四、场景复现： 模拟生产，采用线程池方式多线程请求，请求地址改为百度，数据随便塞一点只要正常相应就行。
4.1代码 OkHttpClientUtil 工具类,getHttpClient()是之前的，getHttpClientSingleton()是我新写的
@Slf4j public class OkHttpClientUtil { private static final MediaType TYPE_JSON = MediaType.parse(&#34;application/json; charset=utf-8&#34;); private volatile static OkHttpClient okHttpClient; public static OkHttpClient getHttpClient() { return new OkHttpClient." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/985768c393b9e0301e7ee03532d9c98a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-01T10:07:26+08:00" />
<meta property="article:modified_time" content="2023-12-01T10:07:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">okhttp导致的内存溢出(OOM)sun.security.ssl.SSLSocketImpl</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <ul><li><mark>使用分析工具：MAT(Memory Analyzer Tool)、JvisualVM</mark></li><li>占用内存：sun.security.ssl.SSLSocketImpl</li></ul> 
</blockquote> 
<h2><a id="__2"></a>一、 项目场景：</h2> 
<p>功能：一个定时任务(xxl-job)采用线程池的方式多线程请求第三方拉取数据，网络框架使用okhttp3。<br> 问题：执行job时，内存短时间内暴增，导致OOM</p> 
<hr> 
<h2><a id="_11"></a>二、问题描述</h2> 
<ul><li>定时任务执行时，突然内存激增，OOM导致项目重启。</li><li>下面这张图是重启后再次执行定时任务的内存监控<br> <br><img src="https://images2.imgbox.com/70/90/DhouFF0t_o.png" alt="image.png" width="500"></li></ul> 
<hr> 
<h2><a id="_21"></a>三、原因分析：</h2> 
<h3><a id="31__22"></a>3.1 查看堆栈信息</h3> 
<p>使用MAT查看堆栈信息，<code>sun.security.ssl.SSLSocketImpl</code>这个东西占了62%<br><img src="https://images2.imgbox.com/59/cf/V958qay4_o.png" alt="image.png" width="800"></p> 
<blockquote> 
 <p>点击<code>Details</code> ，可以看到有9k多个对象</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/1d/e8/wdesp4EZ_o.png" alt="image.png" width="800"><br> <br> 使用OQL查询sun.security.ssl.SSLSocketImpl，发现其中的host都是请求第三方的地址</p> 
<p><code>select * from sun.security.ssl.SSLSocketImpl</code></p> 
<p><img src="https://images2.imgbox.com/99/71/o8qrX8ou_o.png" alt="image.png" width="800"><br><img src="https://images2.imgbox.com/09/0d/Ka39rZ9V_o.png" alt="image.png" width="800"></p> 
<p><mark>到这里，基本可以定位到是由于请求第三方资源没有释放，导致内存暴增。接下来查看请求第三方的代码</mark></p> 
<h3><a id="32__40"></a>3.2 查看代码</h3> 
<p>看到底层工具类<code>OkHttpClientUtil</code>工具类中获取OkHttpClient对象的代码是这样的，每次请求都是new一个OkhttpClient对象，可能是每次都是new一个OkhttpClient的问题，<mark>于是在本地复现</mark>。</p> 
<pre><code class="prism language-c">   private <span class="token keyword">static</span> OkHttpClient <span class="token function">getHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> new OkHttpClient<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span><span class="token function">obtainConnectTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span><span class="token function">obtainWriteTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span><span class="token function">obtainReadTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<hr> 
<p></p> 
<h2><a id="_58"></a>四、场景复现：</h2> 
<p><mark>模拟生产，采用线程池方式多线程请求，请求地址改为百度，数据随便塞一点只要正常相应就行。</mark></p> 
<h3><a id="41_63"></a>4.1代码</h3> 
<p><code>OkHttpClientUtil</code> 工具类,<code>getHttpClient()</code>是之前的，<code>getHttpClientSingleton()</code>是我新写的</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OkHttpClientUtil</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MediaType</span> <span class="token constant">TYPE_JSON</span> <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"application/json; charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">OkHttpClient</span> okHttpClient<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">OkHttpClient</span> <span class="token function">getHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span><span class="token number">1800000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span><span class="token number">1800000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 单例双重检测
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">OkHttpClient</span> <span class="token function">getHttpClientSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> okHttpClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">OkHttpClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> okHttpClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    okHttpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span><span class="token number">1800000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span><span class="token number">1800000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> okHttpClient<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><code>测试类</code></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringAmqpTest</span> <span class="token punctuation">{<!-- --></span>
    
<span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"banksAssetTaskExecutor"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">TaskExecutor</span> <span class="token function">assetTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ThreadPoolTaskExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置核心线程数</span>
        executor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置最大线程数</span>
        executor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置队列容量</span>
        executor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置默认线程名称</span>
        executor<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span><span class="token string">"AssetTaskExecutor-api-thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置线程池拒绝策略:抛弃旧的</span>
        executor<span class="token punctuation">.</span><span class="token function">setRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>DiscardOldestPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 等待所有任务结束后再关闭线程池</span>
        executor<span class="token punctuation">.</span><span class="token function">setWaitForTasksToCompleteOnShutdown</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> executor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">TaskExecutor</span> assetTaskExecutor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            assetTaskExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//每个线程执行1000个请求</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">long</span> l1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Response</span> response <span class="token operator">=</span> <span class="token function">requestBaidu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">long</span> l2 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"线程id{},请求响应时间{},相应内容{},"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l2 <span class="token operator">-</span> l1<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"执行失败Excetion:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行完成！！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token keyword">private</span> <span class="token class-name">Response</span> <span class="token function">requestBaidu</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// //获取OkHttpClient对象(getHttpClient()\getHttpClientSingleton())</span>
        <span class="token class-name">OkHttpClient</span> okHttpClient <span class="token operator">=</span> <span class="token class-name">OkHttpClientUtil</span><span class="token punctuation">.</span><span class="token function">getHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"江"</span><span class="token punctuation">,</span> <span class="token string">"哈哈"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RequestBody</span> body <span class="token operator">=</span> <span class="token class-name">RequestBody</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token constant">TYPE_JSON</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://baidu.com/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Response</span> response <span class="token operator">=</span> okHttpClient<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p></p> 
<h3><a id="42__176"></a>4.2 测试结果</h3> 
<h4><a id="421_new_HttpClient_179"></a>4.2.1 每次都new HttpClient</h4> 
<blockquote> 
 <p>使用getHttpClient()方法获取HttpClient对象(每次请求都new一个新的HttpClient对象)</p> 
</blockquote> 
<p><code>控制打印可以看到不断的发出请求</code></p> 
<p><img src="https://images2.imgbox.com/52/03/wllm0nL0_o.png" alt="image.png" width="800"></p> 
<p>使用<code>jvisualvm工具(位于jdk bin目录下)</code> 分析堆情况</p> 
<blockquote> 
 <p>执行后，发现堆在不断增大</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/bf/9b/g0Fuk0UE_o.png" alt="image.png"></p> 
<blockquote> 
 <p>点击菜单上的<code>线程</code>，看到一堆的等待线程OkHttp connectionPool(连接池)</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/6a/d2/6xErIPuw_o.png" alt="image.png"></p> 
<p>将堆信息下载下来，用<code>MAT</code>分析</p> 
<blockquote> 
 <p>点击右上角<code>堆Dump</code>下载堆信息</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/98/86/8P0Kf39K_o.png" alt="image.png"></p> 
<p>使用MAT分析</p> 
<blockquote> 
 <p>发现最大占用的两个部分别是：<code>sun.security.ssl.SSLSocketImpl</code> 和 <code>okhttp3.ConnectionPool</code>(连接池)，场景基本复现。</p> 
</blockquote> 
<p></p> 
<p><img src="https://images2.imgbox.com/09/9a/qGEqQqVp_o.png" alt="image.png" width="800"></p> 
<p><img src="https://images2.imgbox.com/42/a9/TZbWOL8K_o.png" alt="image.png" width="800"><br><img src="https://images2.imgbox.com/a8/5c/dI4RY4IN_o.png" alt="image.png" width="800"></p> 
<blockquote> 
 <p>使用OQL查看</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/51/f4/7OqxpfAy_o.png" alt="image.png" width="800"></p> 
<blockquote> 
 <p>host地址是百度地址,基本复现</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/d5/c4/J0uCVORV_o.png" alt="image.png" width="800"><br> </p> 
<h4><a id="422__221"></a>4.2.2 使用单例模式</h4> 
<blockquote> 
 <p>使用getHttpClientSingleton()方法获取HttpClient对象(每次请求都new一个新的HttpClient对象)</p> 
</blockquote> 
<p>使用<code>jvisualVM</code>监控</p> 
<blockquote> 
 <p>堆稳定，不会不断增加</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/f4/f7/XSpOzLZL_o.png" alt="image.png"></p> 
<blockquote> 
 <p>等待线程也不多</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/58/c7/ws1Pz6g5_o.png" alt="image.png"></p> 
<h3><a id="43_OkHttpClient_234"></a>4.3 为什么每次请求都创建OkHttpClient会导致内存溢出</h3> 
<blockquote> 
 <p>分析完知道导致问题的原因是每次请求都去new一个OkHttpClient，那为什么会导致内存溢出呢？<br> 路径：<code>okhttp3.Dispatcher#executorService</code>可以看到这块代码</p> 
</blockquote> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">ExecutorService</span> <span class="token function">executorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executorService <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      executorService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
          <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">threadFactory</span><span class="token punctuation">(</span><span class="token string">"OkHttp Dispatcher"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> executorService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>从这里可以知道每个<code>okHttpClient</code>对象在请求的时候都会创建一个线程池(连接池)，而且线程池的keepAliveTime是1分钟；<br> 由于之前的代码是每次请求都new一个<code>OkHttpClient</code>对象,所以每次请求都会new一个新的线程池，在一分钟内大量进行请求的会，内存会在短时间内暴涨。<br> 解决办法依就是只使用一个<code>OkHttpClient</code></p> 
<h2><a id="_255"></a>五、解决方案：</h2> 
<blockquote> 
 <p>解决方法就是只使用一个OkHttpClient实例，而不是每次都去创建</p> 
</blockquote> 
<p><strong>以下两种都可以</strong></p> 
<ul><li><mark>使用单例模式</mark></li><li><mark>使用静态代码块，只加载一次。</mark></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bbf5d655d7e2e1e8645d368d504d61eb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Godot根据屏幕朝向和窗口大小适配显示布局</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/138e5246b2ebd75fed8c79ef0681f865/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在windows7安装高版本Nodejs</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>