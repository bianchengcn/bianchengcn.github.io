<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s-大型分布式集群环境捷径部署 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s-大型分布式集群环境捷径部署" />
<meta property="og:description" content="转k8s-大型分布式集群环境捷径部署 课程介绍 ​ Kubernetes(k8s)一个用于容器集群的自动化部署、扩容以及运维的开源平台。通过Kubernetes,你可以快速有效地响应用户需求;快速而有预期地部署你的应用;极速地扩展你的应用;无缝对接新应用功能;节省资源，优化硬件资源的使用。为容器编排管理提供了完整的开源方案。
Kubernetes解决了什么问题？
服务器环境服务器资源管理服务容灾恢复硬件资源利用服务资源创建可视化管理服务资源监控资源整合管理 Kubernetes在容器编排可谓是做到了淋漓尽致，解决了之前的种种痛点，但是学习成本也相对较高，需要结合一定的实践，踩一定的坑才能形成自己的理解。
目标 了解什么是k8s，为什么世界需要它，k8s的工程师又为什么这么抢手。k8s企业环境部署捷径，多Master/node躲坑快速部署。基于Kubernetes集群管理,kubeadm，kubectl等常见指令使用。基于Kubernetes快速启动集群Web应用。 一、Kubernetes概述 1、什么是k8s Kubernetes（K8s）是Google在2014年发布的一个开源项目。
​ 据说Google的数据中心里运行着20多亿个容器，而且Google十年多前就开始使用容器技术。
​ 最初，Google开发了一个叫Borg的系统（现在命名为Omega）来调度如此庞大数量的容器和工作负载。在积累了这么多年的经验后，Google决定重写这个容器管理系统，并将其贡献到开源社区，让全世界都能受益。
​ 这个项目就是Kubernetes。简单地讲，Kubernetes是Google Omega的开源版本。
​ 从2014年第一个版本发布以来，Kubernetes迅速获得开源社区的追捧，包括Red Hat、VMware、Canonical在内的很多有影响力的公司加入到开发和推广的阵营。目前Kubernetes已经成为发展最快、市场占有率最高的容器编排引擎产品。
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-wdB55tmI-1617883302059)(./assert/k8s2.png)]
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-NPKxlwa8-1617883302062)(./assert/k8s3.png)]
2、Kubernetes解决了什么问题 通过 Kubernetes，分布式系统工具将拥有网络效应。每当人们为 Kubernetes 制作出的新的工具，都会让所有其他工具更完善。因此，这进一步巩固了 Kubernetes 的标准地位。云提供商并非可替换的商品。不同的云提供的服务会变得越来越独特和不同。如果可以访问不同的云提供商提供的不同服务，那么企业将因此受益。当多节点应用与单节点应用一样可靠时，我们将看到定价模型的变化。这就是为什么我会被 Kubernetes 洗脑的原因，它是跨越异构系统的一个标准层。将来，我们会像讨论编译器和操作系统内核一样讨论 Kubernetes。 Kubernetes 将会是低层级的管路系统，而不在普通应用开发人员的视野之内。 Kubernetes 已成为部署分布式应用的标准方式。在不远的将来，任何新成立的互联网公司都将用到 Kubernetes，无论其是否意识到这点。许多旧应用也正在迁移到 Kubernetes。
2.1 起因：Docker [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-vvLsezLB-1617883302063)(./assert/k8s5.png)]
单一稳定的一体化模型 [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-UAilBBG6-1617883302065)(./assert/k8s6.png)]
微型化的应用部署模型 (微服务、分布式、集群、高可用、负载均衡…)
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-gQCWE38w-1617883302066)(./assert/k8s7.png)]
2.2 容器编排？是需要标准的？ 如此多的docker该如何管理(通信、负载均衡、资源共享管理、容灾、监控、健康检查….)？
Mesos [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Jckcd6yb-1617883302068)(./assert/k8s8.png)]
docker swarm [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-n3LZ37HC-1617883302069)(./assert/k8s9.png)]
kubernetes [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-gjIbp9CR-1617883302069)(./assert/k8s10.png)]
自2016年中，k8s表现出明显优势。
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-JwOqYsxN-1617883302071)(./assert/k8s11.png)]
3. kubernetes工程师价值 [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-j9zqjztE-1617883302072)(./assert/k8s4.png)]
二、环境 2.1 部署软件环境版本 操作系统: Ubuntu 18.10(本教程采用server版本)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/c34a44953d07656316f651048268b66b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-08T20:02:40+08:00" />
<meta property="article:modified_time" content="2021-04-08T20:02:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s-大型分布式集群环境捷径部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="k8s_0"></a>转k8s-大型分布式集群环境捷径部署</h2> 
<h3><a id="_2"></a>课程介绍</h3> 
<p>​ Kubernetes(k8s)一个用于<strong>容器</strong>集群的自动化部署、扩容以及运维的开源平台。通过Kubernetes,你可以<strong>快速有效地响应</strong>用户需求;快速而有预期地部署你的应用;极速地<strong>扩展</strong>你的应用;无缝<strong>对接新应用</strong>功能;节省资源，优化<strong>硬件资源</strong>的使用。为容器编排管理提供了完整的开源方案。</p> 
<p>Kubernetes解决了什么问题？</p> 
<ul><li>服务器环境</li><li>服务器资源管理</li><li>服务容灾恢复</li><li>硬件资源利用</li><li>服务资源创建</li><li>可视化管理</li><li>服务资源监控</li><li>资源整合管理</li></ul> 
<p>Kubernetes在容器编排可谓是做到了淋漓尽致，解决了之前的种种痛点，但是学习成本也相对较高，需要结合一定的实践，踩一定的坑才能形成自己的理解。</p> 
<h4><a id="_19"></a>目标</h4> 
<ul><li>了解什么是k8s，为什么世界需要它，k8s的工程师又为什么这么抢手。</li><li>k8s企业环境部署捷径，多Master/node躲坑快速部署。</li><li>基于Kubernetes集群管理,kubeadm，kubectl等常见指令使用。</li><li>基于Kubernetes快速启动集群Web应用。</li></ul> 
<h2><a id="Kubernetes_32"></a>一、Kubernetes概述</h2> 
<h3><a id="1k8s_34"></a>1、什么是k8s</h3> 
<p>Kubernetes（K8s）是Google在2014年发布的一个开源项目。</p> 
<p>​ 据说Google的数据中心里运行着20多亿个容器，而且Google十年多前就开始使用容器技术。</p> 
<p>​ 最初，Google开发了一个叫Borg的系统（现在命名为Omega）来调度如此庞大数量的容器和工作负载。在积累了这么多年的经验后，Google决定重写这个容器管理系统，并将其贡献到开源社区，让全世界都能受益。</p> 
<p>​ 这个项目就是Kubernetes。简单地讲，Kubernetes是Google Omega的开源版本。</p> 
<p>​ 从2014年第一个版本发布以来，Kubernetes迅速获得开源社区的追捧，包括Red Hat、VMware、Canonical在内的很多有影响力的公司加入到开发和推广的阵营。目前Kubernetes已经成为发展最快、市场占有率最高的容器编排引擎产品。</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-wdB55tmI-1617883302059)(./assert/k8s2.png)]</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-NPKxlwa8-1617883302062)(./assert/k8s3.png)]</p> 
<h3><a id="2Kubernetes_56"></a>2、Kubernetes解决了什么问题</h3> 
<ul><li>通过 Kubernetes，分布式系统工具将拥有网络效应。每当人们为 Kubernetes 制作出的新的工具，都会让所有其他工具更完善。因此，这进一步巩固了 Kubernetes 的标准地位。</li><li>云提供商并非可替换的商品。不同的云提供的服务会变得越来越独特和不同。如果可以访问不同的云提供商提供的不同服务，那么企业将因此受益。</li><li>当多节点应用与单节点应用一样可靠时，我们将看到定价模型的变化。</li><li>这就是为什么我会被 Kubernetes 洗脑的原因，它是跨越异构系统的一个标准层。</li><li>将来，我们会像讨论编译器和操作系统内核一样讨论 Kubernetes。 Kubernetes 将会是低层级的管路系统，而不在普通应用开发人员的视野之内。</li></ul> 
<p>Kubernetes 已成为部署分布式应用的标准方式。在不远的将来，任何新成立的互联网公司都将用到 Kubernetes，无论其是否意识到这点。许多旧应用也正在迁移到 Kubernetes。</p> 
<h5><a id="21_Docker_68"></a>2.1 起因：Docker</h5> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-vvLsezLB-1617883302063)(./assert/k8s5.png)]</p> 
<h5><a id="_76"></a>单一稳定的一体化模型</h5> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-UAilBBG6-1617883302065)(./assert/k8s6.png)]</p> 
<h5><a id="_80"></a>微型化的应用部署模型</h5> 
<p>(微服务、分布式、集群、高可用、负载均衡…)</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-gQCWE38w-1617883302066)(./assert/k8s7.png)]</p> 
<h5><a id="22__88"></a>2.2 容器编排？是需要标准的？</h5> 
<p>如此多的docker该如何管理(通信、负载均衡、资源共享管理、容灾、监控、健康检查….)？</p> 
<ul><li>Mesos</li></ul> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Jckcd6yb-1617883302068)(./assert/k8s8.png)]</p> 
<ul><li>docker swarm</li></ul> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-n3LZ37HC-1617883302069)(./assert/k8s9.png)]</p> 
<ul><li>kubernetes</li></ul> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-gjIbp9CR-1617883302069)(./assert/k8s10.png)]</p> 
<p>自2016年中，k8s表现出明显优势。</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-JwOqYsxN-1617883302071)(./assert/k8s11.png)]</p> 
<h4><a id="3_kubernetes_116"></a>3. kubernetes工程师价值</h4> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-j9zqjztE-1617883302072)(./assert/k8s4.png)]</p> 
<h2><a id="_124"></a>二、环境</h2> 
<h3><a id="21__126"></a>2.1 部署软件环境版本</h3> 
<p>操作系统: <code>Ubuntu 18.10</code>(本教程采用server版本)</p> 
<p>Docker： <code>docker-ce 18.06</code></p> 
<p>Kubernetes: <code>k8s 1.13.1</code></p> 
<h3><a id="22_Ubuntu_136"></a>2.2 Ubuntu搭建研发环境</h3> 
<p>我们直接下载Unbuntu18.10-server版本，server版本的好处是没有Desktop,可以节省资源。</p> 
<pre><code class="prism language-shell"><span class="token function">wget</span> http://mirrors.aliyun.com/ubuntu-releases/18.10/ubuntu-18.10-live-server-amd64.iso
</code></pre> 
<blockquote> 
 <p>注:也可以从配套资料中获取</p> 
</blockquote> 
<h3><a id="23_Ubuntu_148"></a>2.3 Ubuntu安装过程</h3> 
<h4><a id="231__150"></a>2.3.1 创建虚拟机</h4> 
<p>在VMWare 中启动安装虚拟过程</p> 
<ol><li> <p>创建新的虚拟机，选择推荐版本的iso文件</p> <p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-FWHY6CCg-1617883302073)(./assert/ubuntu1.jpg)]</p> </li><li> <p>选择自定义安装</p> </li><li> <p>为此虚拟机选择操作系统 <code>Linux Ubuntu 64位</code></p> </li><li> <p>指定引导固件<code>UEFI</code> 不要选择<code>BIOS</code></p> <p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-x1BOPphp-1617883302075)(./assert/ubuntu2.jpg)]</p> </li><li> <p>命名为<strong>Master</strong></p> </li><li> <p>自定设置 存储为<strong>UbuntuMaster</strong> <strong>2CPU 2048MB 20GB硬盘</strong></p> <p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-amoXia9W-1617883302075)(./assert/ubuntu3.jpg)]</p> <p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-3O6XkHr1-1617883302077)(./assert/ubuntu4.jpg)]</p> </li><li> <p>建议移除声卡和摄像头</p> </li></ol> 
<h4><a id="232__192"></a>2.3.2 图形界面安装方式</h4> 
<ol><li> <p>选择英文语言</p> </li><li> <p>英文键盘</p> </li><li> <p>设置国内镜像源头 <code>http://mirrors.aliyun.com/ubuntu/</code> 注意末尾的斜线</p> </li><li> <p>设置您的用户名和密码，下文使用<em>YOUR_USERNAME</em> <em>YOUR_PASSWORD</em></p> </li><li> <p><strong>切勿选择</strong> <code>microk8s snap</code> <code>stable: v1.14.2</code> 空格选中</p> </li></ol> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Zf8yYwER-1617883302077)(./assert/ubuntu5.jpg)]</p> 
<ol start="6"><li>Tab键切换到<em>DONE</em>回车，开始安装过程</li></ol> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-7THezcN7-1617883302078)(./assert/ubuntu6.jpg)]</p> 
<ol start="7"><li> <p>安装结束后点击重启<em>Reboot Now</em></p> <p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-R2gkGOjt-1617883302079)(./assert/ubuntu7.jpg)]</p> </li></ol> 
<h4><a id="root_222"></a>修改root密码</h4> 
<ol><li>安装过程中，输入用户名 <code>YOUR_USERNAME</code> 密码: <code>YOUR_PASSWORD</code></li><li>重新启动后登录 用户名 <code>YOUR_USERNAME</code> 密码: <code>YOUR_PASSWORD</code></li><li>确认登录成功后输入<code>sudo passwd</code> 输入上面的<code>YOUR_PASSWORD</code>,然后输入root用户的密码<code>root</code></li></ol> 
<pre><code>设置root用户的密码root，是为了教学过程中简单。
但是在生产环境下禁止使用弱强度的密码。
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-vpmVVJ0D-1617883302080)(./assert/ubuntu8.jpg)]</p> 
<ol start="4"><li>执行<code>exit</code>退出当前登录用户，然后使用root用户重新登录</li><li>输入<code>shutdown now</code>停机</li></ol> 
<h3><a id="24__240"></a>2.4 修改主机名</h3> 
<p>修改主机名称</p> 
<ol><li>使用root用户登录</li><li>打开配置文件<code>vim /etc/cloud/cloud.cfg</code></li><li>修改配置<code>preserve_hostname: true</code></li></ol> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-4QzeY8zx-1617883302080)(./assert/ubuntu9.jpg)]</p> 
<ol start="3"><li>重启</li></ol> 
<pre><code class="prism language-shell">$ <span class="token function">shutdown</span> -r now
</code></pre> 
<h3><a id="_256"></a></h3> 
<h3><a id="25_IPNAT_258"></a>2.5 配置静态IP(永久有效)(NAT模式)</h3> 
<ol><li>使用root用户登录Linux，如下以Node2为例</li><li><code>vim /etc/netplan/50-cloud-init.yaml</code></li><li>参考如下截图修改配置文件</li></ol> 
<ul><li>UbuntuMaster <code>172.16.235.146</code></li><li>UbuntuNode1 <code>172.16.235.147</code></li><li>UbuntuNode2 <code>172.16.235.148</code></li></ul> 
<pre><code class="prism language-bash">network:
    ethernets:
        ens33:
            addresses: <span class="token punctuation">[</span>192.168.236.177/24<span class="token punctuation">]</span>
            dhcp4: <span class="token boolean">false</span>
            gateway4: 192.168.236.2
            nameservers:
                       addresses: <span class="token punctuation">[</span>192.168.236.2<span class="token punctuation">]</span>
            optional: <span class="token boolean">true</span>
    version: 2              
</code></pre> 
<p>或者动态获取</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-R9r7CVe5-1617883302082)(./assert/ubuntu10.png)]</p> 
<h3><a id="26_hosts_289"></a>2.6 修改hosts</h3> 
<p>使用root用户登录</p> 
<ol><li> <p>打开hosts文件 <code>vim /etc/hosts</code></p> </li><li> <p>输入如下内容</p> <pre><code class="prism language-shell">192.168.236.177 master
</code></pre> <p>这个ip是当前桥接或者NAT分配的IP地址</p> </li><li> <p>重启机器<code>shutdown -r now</code></p> </li></ol> 
<h3><a id="ip_305"></a>ip应用启动：</h3> 
<p><code>$netplan apply</code></p> 
<h2><a id="DockerCE_311"></a>三、Docker-CE安装及配置</h2> 
<h3><a id="31_Docker_313"></a>3.1 Docker简介</h3> 
<h4><a id="3_11_docker_315"></a>3. 1.1 docker介绍</h4> 
<ul><li> <p>docker是什么 ?</p> 
  <blockquote> 
   <p>Docker 是一个开源的应用<strong>容器引擎</strong>，是直接运行在宿主操作系统之上的一个容器，使用沙箱机制完全虚拟出一个完整的操作，容器之间不会有任何接口，从而让容器与宿主机之间、容器与容器之间隔离的更加彻底。每个容器会有自己的权限管理，独立的网络与存储栈，及自己的资源管理能，使同一台宿主机上可以友好的共存多个容器。</p> 
  </blockquote> </li><li> <p>docker与虚拟机对比</p> 
  <blockquote> 
   <p><font color="red"><strong>如果物理机是一幢住宅楼，虚拟机就是大楼中的一个个套间，而容器技术就是套间里的一个个隔断。</strong></font></p> 
  </blockquote> 
  <ul><li> <p>虚拟化技术不同</p> 
    <blockquote> 
     <ul><li>VMware Workstation、VirtualBoX</li></ul> 
     <p>硬件辅助虚拟化：（Hardware-assisted Virtualization）是指通过硬件辅助支持模拟运行环境，使客户机操作系统可以独立运行，实现完全虚拟化的功能。</p> 
     <ul><li>Docker</li></ul> 
     <p>操作系统层虚拟化：（OS-level virtualization）这种技术将操作系统内核虚拟化，可以允许使用者空间软件实例被分割成几个独立的单元，在内核中运行，而不是只有一个单一实例运行。这个软件实例，也被称为是一个容器（containers）、虚拟引擎（Virtualization engine）、虚拟专用服务器（virtual private servers）。每个容器的进程是独立的，对于使用者来说，就像是在使用自己的专用服务器。</p> 
     <p><font color="red">以上两种虚拟化技术都属于软件虚拟化，在现有的物理平台上实现对物理平台访问的截获和模拟。在软件虚拟化技术中，有些技术不需要硬件支持；而有些软件虚拟化技术，则依赖硬件支持。</font></p> 
    </blockquote> </li><li> <p>应用场景不同</p> 
    <blockquote> 
     <ul><li>虚拟机更擅长于彻底隔离整个运行环境。如: 云服务提供商通常采用虚拟机技术隔离不同的用户。</li><li>Docker通常用于隔离不同的应用，例如前端，后端以及数据库。</li></ul> 
    </blockquote> </li><li> <p>资源的使用率不同</p> 
    <blockquote> 
     <p>虚拟机启动需要数分钟，而Docker容器可以在数毫秒内启动。由于没有臃肿的从操作系统，Docker可以节省大量的磁盘空间以及其他系统资源。</p> 
    </blockquote> </li></ul> </li><li> <p>docker的版本</p> 
  <ul><li>Docker-CE -&gt; 社区版 
    <ul><li>Stable 版 
      <ul><li>稳定版, 一个季度更新一次</li></ul> </li><li>Edge 版 
      <ul><li>一个月更新一般</li></ul> </li></ul> </li><li>Docker-EE 
    <ul><li>企业版</li><li>收费的</li></ul> </li></ul> </li></ul> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-QQW9QyYg-1617883302082)(./assert/docker1.png)]</p> 
<h3><a id="32__359"></a>3.2 配置国内源</h3> 
<h4><a id="321__361"></a>3.2.1 基础准备</h4> 
<ol><li>Docker 要求 Ubuntu 系统的内核版本高于 3.10 ，查看本页面的前提条件来验证你的 Ubuntu 版本是否支持 Docker。</li></ol> 
<pre><code class="prism language-shell"><span class="token function">uname</span> -r 
4.18.0-21-generic<span class="token punctuation">(</span>主版本必须保持一致<span class="token punctuation">)</span>
</code></pre> 
<ol start="2"><li>安装<code>curl</code></li></ol> 
<pre><code class="prism language-shell"><span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y <span class="token function">curl</span> telnet <span class="token function">wget</span> <span class="token function">man</span> \
apt-transport-https \
ca-certificates \
software-properties-common vim 

</code></pre> 
<ol start="3"><li> <p>查看新版本号</p> 
  <ul><li>Ubuntu 18.10</li></ul> <pre><code class="prism language-shell">$ lsb_release -c
Codename:	cosmic
</code></pre> </li><li> <p>查看确认国内源</p> <pre><code class="prism language-shell">	$ <span class="token function">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak
	$ <span class="token function">cat</span> /etc/apt/sources.list
</code></pre> </li></ol> 
<h4><a id="322_Dockerce_404"></a>3.2.2 在线安装Docker-ce(本教程不推荐)</h4> 
<blockquote> 
 <p>(建议下面的手动安装方式，因为在线可能会出现版本不一致)</p> 
</blockquote> 
<p>注意： <strong>该国内源目前提供 <code>18.09</code>版本，与k8s不符。k8s推荐安装<code>Docker ce 18.06</code></strong><br> 安装链接：<a href="https://blog.csdn.net/javalee5156/article/details/83583489">https://blog.csdn.net/javalee5156/article/details/83583489</a></p> 
<ol><li> <p>安装GPG秘钥和添加国内镜像</p> <pre><code class="prism language-shell">$ <span class="token function">curl</span> -fsSL https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key add -
</code></pre> <p>添加国内源头</p> <pre><code class="prism language-shell">$ add-apt-repository \
    <span class="token string">"deb https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu \
    <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> \
    stable"</span>
</code></pre> </li></ol> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-J5UikjEu-1617883302083)(./assert/docker2.jpg)]</p> 
<ol start="2"><li>更新国内源路径</li></ol> 
<pre><code class="prism language-shell">apt update
</code></pre> 
<p>3.安装查看版本指令</p> 
<pre><code>apt-get install -y apt-show-versions
</code></pre> 
<p>4.查看docker-ce版本号</p> 
<pre><code>apt-show-versions -a docker-ce
</code></pre> 
<ol start="5"><li>在线安装<code>Docker-ce</code></li></ol> 
<pre><code class="prism language-shell">   <span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y docker-ce
</code></pre> 
<pre><code>注意到当前安装的版本是 `docker-ce_5%3a18.09.6~3-0~ubuntu-cosmic_amd64.deb`
</code></pre> 
<h4><a id="323_Docker_458"></a>3.2.3 手动安装Docker(离线安装)</h4> 
<ol><li>下载<code>docker-ce_18.06.1\~ce\~3-0\~ubuntu_amd64.deb</code></li><li>上传到上述文件到待安装服务器<code>master</code></li><li>登录待安装服务器，切换到root账户</li><li><code>dpkg -i docker-ce_18.06.1\~ce\~3-0\~ubuntu_amd64.deb</code></li></ol> 
<blockquote> 
 <p>如果提示错误</p> 
</blockquote> 
<pre><code class="prism language-bash">dpkg: error: dpkg frontend is locked by another process
</code></pre> 
<p>说明已经有其他进程在使用dpkg安装程序</p> 
<pre><code>sudo rm /var/lib/dpkg/lock
</code></pre> 
<p>即可。</p> 
<blockquote> 
 <p>如果提示错误</p> 
</blockquote> 
<pre><code class="prism language-bash">itcast@master:~/package$ <span class="token function">sudo</span> dpkg -i docker-ce_18.06.1~ce~3-0~ubuntu_amd64.deb
 
<span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> password <span class="token keyword">for</span> itcast: 
Selecting previously unselected package docker-ce.
<span class="token punctuation">(</span>Reading database <span class="token punctuation">..</span>. 100647 files and directories currently installed.<span class="token punctuation">)</span>
Preparing to unpack docker-ce_18.06.1~ce~3-0~ubuntu_amd64.deb <span class="token punctuation">..</span>.
Unpacking docker-ce <span class="token punctuation">(</span>18.06.1~ce~3-0~ubuntu<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
dpkg: dependency problems prevent configuration of docker-ce:
 docker-ce depends on libltdl7 <span class="token punctuation">(</span><span class="token operator">&gt;=</span> 2.4.6<span class="token punctuation">)</span><span class="token punctuation">;</span> however:
  Package libltdl7 is not installed.

dpkg: error processing package docker-ce <span class="token punctuation">(</span>--install<span class="token punctuation">)</span>:
 dependency problems - leaving unconfigured
Processing triggers <span class="token keyword">for</span> man-db <span class="token punctuation">(</span>2.8.4-2<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
Processing triggers <span class="token keyword">for</span> systemd <span class="token punctuation">(</span>239-7ubuntu10<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
Errors were encountered <span class="token keyword">while</span> processing:
 docker-ce
</code></pre> 
<p>表示当前docker-ce 依赖系统libltd17库，安装就可以了</p> 
<pre><code class="prism language-bash">$ <span class="token function">apt-get</span> <span class="token function">install</span> -y libltdl7
</code></pre> 
<ol start="5"><li>docker version</li></ol> 
<pre><code class="prism language-shell">Client:
 Version:           18.06.1-ce
 API version:       1.38
 Go version:        go1.10.3
 Git commit:        e68fc7a
 Built:             Tue Aug 21 17:24:56 2018
 OS/Arch:           linux/amd64
 Experimental:      <span class="token boolean">false</span>

Server:
 Engine:
  Version:          18.06.1-ce
  API version:      1.38 <span class="token punctuation">(</span>minimum version 1.12<span class="token punctuation">)</span>
  Go version:       go1.10.3
  Git commit:       e68fc7a
  Built:            Tue Aug 21 17:23:21 2018
  OS/Arch:          linux/amd64
  Experimental:     <span class="token boolean">false</span>
</code></pre> 
<p>确保版本号是 <code>18.06</code></p> 
<h3><a id="33_Dockerce_538"></a>3.3 启动Docker-ce</h3> 
<ol><li>开机并启动docker</li></ol> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> systemctl <span class="token function">enable</span> docker 
<span class="token function">sudo</span> systemctl start docker 
</code></pre> 
<ol start="2"><li>重启，登录确认<code>docker</code>已经运行</li></ol> 
<pre><code class="prism language-shell">itcast@ubuntu:~$ <span class="token function">sudo</span> docker <span class="token function">ps</span> 
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</code></pre> 
<ol start="3"><li>下载<code>Alpine</code>镜像热身一下 <code>Docker</code></li></ol> 
<pre><code class="prism language-bash">~$ <span class="token function">sudo</span> docker run -it --rm alpine:latest sh 
</code></pre> 
<p>输出内容如下，我们在<code>Docker</code>容器中测试三个命令，分别是</p> 
<pre><code class="prism language-bash">- <span class="token variable"><span class="token variable">`</span><span class="token function">date</span><span class="token variable">`</span></span>
- <span class="token variable"><span class="token variable">`</span><span class="token function">time</span><span class="token variable">`</span></span>
- <span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -r<span class="token variable">`</span></span>
</code></pre> 
<pre><code class="prism language-bash">itcast@ubuntu:~$ <span class="token function">sudo</span> docker run -it --rm alpine:latest sh 
Unable to <span class="token function">find</span> image <span class="token string">'alpine:latest'</span> locally
latest: Pulling from library/alpine
e7c96db7181b: Pull complete 
Digest: sha256:769fddc7cc2f0a1c35abb2f91432e8beecf83916c421420e6a6da9f8975464b6
Status: Downloaded newer image <span class="token keyword">for</span> alpine:latest
/ <span class="token comment"># date</span>
Mon Jun 10 07:56:01 UTC 2019
/ <span class="token comment"># time</span>
BusyBox v1.29.3 <span class="token punctuation">(</span>2019-01-24 07:45:07 UTC<span class="token punctuation">)</span> multi-call binary.

Usage: <span class="token function">time</span> <span class="token punctuation">[</span>-vpa<span class="token punctuation">]</span> <span class="token punctuation">[</span>-o FILE<span class="token punctuation">]</span> PROG ARGS

Run PROG, display resource usage when it exits

	-v	Verbose
	-p	POSIX output <span class="token function">format</span>
	-f FMT	Custom <span class="token function">format</span>
	-o FILE	Write result to FILE
	-a	Append <span class="token punctuation">(</span>else overwrite<span class="token punctuation">)</span>
/ <span class="token comment"># uname -r </span>
4.18.0-10-generic

</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-ZW8rkwXP-1617883302084)(./assert/docker3.jpg)]</p> 
<h3><a id="34_Docker_600"></a>3.4 创建Docker用户组并添加当前用户</h3> 
<p>使用您的用户登录Linux然后执行如下操作，用户组docker可能已经存在。</p> 
<p>如果使用普通用户目前是无法使用docker指令的</p> 
<pre><code class="prism language-bash">itcast@master:~$ docker <span class="token function">ps</span>
Got permission denied <span class="token keyword">while</span> trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.38/containers/json: dial unix /var/run/docker.sock: connect: permission denied
</code></pre> 
<p>我们需要将当前的普通用户添加到当前的docker用户组中</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">groupadd</span> docker
<span class="token function">sudo</span> <span class="token function">usermod</span> -aG docker <span class="token variable">$USER</span>
<span class="token keyword">exit</span>
</code></pre> 
<p>重新登录使用普通用户登录:</p> 
<pre><code class="prism language-bash">itcast@master:~$ docker <span class="token function">ps</span>
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</code></pre> 
<p>就可以使用了。</p> 
<h3><a id="35__634"></a>3.5 申请阿里云镜像加速器</h3> 
<p>如果不申请阿里云私人专属镜像加速器，鼓励复制如下本人申请的私人专属镜像加速器，直接使用即可。</p> 
<pre><code class="prism language-shell">https://ozcouv1b.mirror.aliyuncs.com
</code></pre> 
<p><strong>申请步骤如下</strong></p> 
<p>在阿里云注册自己账户</p> 
<p>找到<strong>容器镜像服务</strong>，参考网址如下</p> 
<pre><code class="prism language-shell">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors
</code></pre> 
<p>点开左侧菜单<strong>镜像中心</strong>—&gt;<strong>镜像加速器</strong></p> 
<p>右侧加速器地址，即使私人专属的镜像加速器地址，点击<strong>复制</strong></p> 
<p>粘贴到一个文本文件留存</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-63kskHxR-1617883302084)(/Users/apple/Nustore Files/我的坚果云/课程研发/k8s/assert/docker4.jpg)]</p> 
<hr> 
<h3><a id="36_docker_666"></a>3.6 docker配置国内镜像加速器</h3> 
<blockquote> 
 <p>目的 : 为了下载docker镜像更快</p> 
</blockquote> 
<p>您可以通过修改<code>daemon</code>配置文件<code>/etc/docker/daemon.json</code>来使用加速器。</p> 
<p>创建<code>/etc/docker/daemon.json</code>文件，内容如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"registry-mirrors"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"https://ozcouv1b.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>重启docker服务</p> 
<pre><code class="prism language-shell"><span class="token comment"># 重载所有修改过的配置文件</span>
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token comment"># 重启Docker服务</span>
<span class="token function">sudo</span> systemctl restart docker
</code></pre> 
<h2><a id="Kubernetes__689"></a>四、Kubernetes 安装及部署</h2> 
<h3><a id="41_k8s_691"></a>4.1 k8s安装环境准备</h3> 
<h4><a id="411_k8s_693"></a>4.1.1 配置并安装k8s国内源</h4> 
<ol><li> <p>创建配置文件<code>sudo touch /etc/apt/sources.list.d/kubernetes.list</code></p> </li><li> <p>添加写权限</p> <pre><code class="prism language-bash">itcast@master:~$ <span class="token function">sudo</span> <span class="token function">chmod</span> 666 /etc/apt/sources.list.d/kubernetes.list 
</code></pre> <p>再添加，内容如下:</p> <pre><code>deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main
</code></pre> </li><li> <p>执行<code>sudo apt update</code> 更新操作系统源，开始会遇见如下错误</p> <pre><code class="prism language-bash">tcast@master:~$ <span class="token function">sudo</span> apt update
Get:1 http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease <span class="token punctuation">[</span>8,993 B<span class="token punctuation">]</span>
Err:1 http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease    
  The following signatures couldn<span class="token string">'t be verified because the public key is not available: NO_PUBKEY 6A030B21BA07F4FB
Hit:2 http://mirrors.aliyun.com/ubuntu cosmic InRelease                        
Hit:3 http://mirrors.aliyun.com/ubuntu cosmic-updates InRelease                
Hit:4 http://mirrors.aliyun.com/ubuntu cosmic-backports InRelease              
Hit:5 http://mirrors.aliyun.com/ubuntu cosmic-security InRelease               
Err:6 https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu cosmic InRelease      
  Could not wait for server fd - select (11: Resource temporarily unavailable) [IP: 202.141.176.110 443]
Reading package lists... Done                          
W: GPG error: http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease: The following signatures couldn'</span>t be verified because the public key is not available: NO_PUBKEY 6A030B21BA07F4FB
E: The repository <span class="token string">'http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease'</span> is not signed.
N: Updating from such a repository can't be <span class="token keyword">done</span> securely, and is therefore disabled by default.
N: See apt-secure<span class="token punctuation">(</span>8<span class="token punctuation">)</span> manpage <span class="token keyword">for</span> repository creation and user configuration details.
</code></pre> <p>其中：</p> <pre><code class="prism language-bash">The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 6A030B21BA07F4FB
</code></pre> <p>签名认证失败，需要重新生成。记住上面的<em>NO_PUBKEY</em> <code>6A030B21BA07F4FB</code></p> </li><li> <p>添加认证key</p> <p>运行如下命令，添加错误中对应的key(错误中NO_PUBKEY后面的key的后8位)</p> <pre><code class="prism language-shell">gpg --keyserver keyserver.ubuntu.com --recv-keys BA07F4FB
</code></pre> <p>接着运行如下命令，确认看到<strong>OK</strong>，说明成功，之后进行安装:</p> <pre><code class="prism language-shell">gpg --export --armor BA07F4FB <span class="token operator">|</span> <span class="token function">sudo</span> apt-key add -
</code></pre> </li><li> <p>再次重新<code>sudo apt update</code>更新系统下载源数据列表</p> </li></ol> 
<pre><code class="prism language-bash">itcast@master:~$ <span class="token function">sudo</span> apt update
Hit:1 https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu cosmic InRelease                  
Hit:2 http://mirrors.aliyun.com/ubuntu cosmic InRelease                                    
Hit:3 http://mirrors.aliyun.com/ubuntu cosmic-updates InRelease                            
Hit:4 http://mirrors.aliyun.com/ubuntu cosmic-backports InRelease                          
Hit:5 http://mirrors.aliyun.com/ubuntu cosmic-security InRelease                           
Get:6 http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease <span class="token punctuation">[</span>8,993 B<span class="token punctuation">]</span>      
Ign:7 http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial/main amd64 Packages
Get:7 http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial/main amd64 Packages <span class="token punctuation">[</span>26.6 kB<span class="token punctuation">]</span>
Fetched 26.6 kB <span class="token keyword">in</span> 42s <span class="token punctuation">(</span>635 B/s<span class="token punctuation">)</span>    
Reading package lists<span class="token punctuation">..</span>. Done
Building dependency tree       
Reading state information<span class="token punctuation">..</span>. Done
165 packages can be upgraded. Run <span class="token string">'apt list --upgradable'</span> to see them.
</code></pre> 
<p>以上没有报和错误异常，表示成功。</p> 
<h4><a id="412__780"></a>4.1.2 禁止基础设施</h4> 
<ol><li> <p>禁止防火墙</p> <pre><code class="prism language-shell">$ <span class="token function">sudo</span> ufw disable
Firewall stopped and disabled on system startup
</code></pre> </li><li> <p>关闭swap</p> <pre><code class="prism language-shell"><span class="token comment"># 成功</span>
$ <span class="token function">sudo</span> swapoff -a 
<span class="token comment"># 永久关闭swap分区</span>
$ <span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab
</code></pre> </li><li> <p>禁止selinux</p> </li></ol> 
<pre><code class="prism language-shell"><span class="token comment"># 安装操控selinux的命令</span>
$ <span class="token function">sudo</span> apt <span class="token function">install</span> -y selinux-utils
<span class="token comment"># 禁止selinux</span>
$ setenforce 0
<span class="token comment"># 重启操作系统</span>
$ <span class="token function">shutdown</span> -r now
<span class="token comment"># 查看selinux是否已经关闭</span>
$ <span class="token function">sudo</span> getenforce
Disabled<span class="token punctuation">(</span>表示已经关闭<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="42_k8s_814"></a>4.2 k8s系统网络配置</h3> 
<p>(1) 配置内核参数，将桥接的IPv4流量传递到iptables的链</p> 
<p>创建<code>/etc/sysctl.d/k8s.conf</code>文件</p> 
<p>添加内容如下:</p> 
<pre><code class="prism language-ini">net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
vm.swappiness = 0
</code></pre> 
<p>(2) 执行命令使修改生效</p> 
<pre><code class="prism language-bash"><span class="token comment"># 【候选】建议执行下面的命令</span>
$ <span class="token function">sudo</span> modprobe br_netfilter
$ <span class="token function">sudo</span> sysctl -p /etc/sysctl.d/k8s.conf
</code></pre> 
<h3><a id="43_k8s_838"></a>4.3 安装k8s</h3> 
<blockquote> 
 <p><strong>注意: 切换到root用户 <code>$ su</code></strong></p> 
</blockquote> 
<ol><li> <p>安装Kubernetes 目前安装版本 <code>v1.13.1</code></p> <pre><code class="prism language-shell">$ apt update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y kubelet<span class="token operator">=</span>1.13.1-00 kubernetes-cni<span class="token operator">=</span>0.6.0-00 kubeadm<span class="token operator">=</span>1.13.1-00 kubectl<span class="token operator">=</span>1.13.1-00
</code></pre> </li><li> <p>设置为开机重启</p> <pre><code class="prism language-shell">$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> kubelet <span class="token operator">&amp;&amp;</span> systemctl start kubelet
$ <span class="token function">sudo</span> <span class="token function">shutdown</span> -r now
</code></pre> </li></ol> 
<h3><a id="44_k8s_861"></a>4.4 验证k8s</h3> 
<ol><li> <p>使用root用户登录<code>Master</code>主机</p> </li><li> <p>执行如下个命令</p> <pre><code class="prism language-shell">kubectl get nodes 
</code></pre> </li></ol> 
<p>输出如下</p> 
<pre><code class="prism language-shell">$ kubectl get nodes
The connection to the server localhost:8080 was refused - did you specify the right host or port?
</code></pre> 
<ol start="3"><li> <p>查看当前k8s版本</p> <pre><code class="prism language-bash">$ kubectl version
</code></pre> </li></ol> 
<pre><code class="prism language-bash">Client Version: version.Info<span class="token punctuation">{<!-- --></span>Major:<span class="token string">"1"</span>, Minor:<span class="token string">"13"</span>, GitVersion:<span class="token string">"v1.13.1"</span>, GitCommit:<span class="token string">"eec55b9ba98609a46fee712359c7b5b365bdd920"</span>, GitTreeState:<span class="token string">"clean"</span>, BuildDate:<span class="token string">"2018-12-13T10:39:04Z"</span>, GoVersion:<span class="token string">"go1.11.2"</span>, Compiler:<span class="token string">"gc"</span>, Platform:<span class="token string">"linux/amd64"</span><span class="token punctuation">}</span>
The connection to the server localhost:8080 was refused - did you specify the right host or port?
</code></pre> 
<h2><a id="Kubernetes_894"></a>五、创建企业Kubernetes多主机集群环境</h2> 
<h3><a id="51__896"></a>5.1 创建两个节点(两个虚拟机)</h3> 
<ol><li>在VMWare中创建完整克隆，分别命名为<code>UbuntuNode1</code>和<code>UbuntuNode2</code></li></ol> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-gj3aht1G-1617883302085)(/Users/apple/Nustore Files/我的坚果云/课程研发/k8s/assert/k8snode1.jpg)]</p> 
<p>分别对两个完整克隆的虚拟机进行如下操作，修改主机名称和静态IP</p> 
<ol><li>使用root用户登录</li><li>打开配置文件<code>vim /etc/cloud/cloud.cfg</code></li><li>修改配置<code>preserve_hostname: true</code></li></ol> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-JF4rGFNQ-1617883302086)(/Users/apple/Nustore Files/我的坚果云/课程研发/k8s/assert/k8snode2.jpg)]</p> 
<ol start="3"><li>修改<code>/etc/hostname</code>，只有一行 <code>node1</code>或<code>node2</code></li></ol> 
<h3><a id="52_masternode_914"></a>5.2 master和node基础配置</h3> 
<h4><a id="521_nodehostname_916"></a>5.2.1 给node配置hostname</h4> 
<p><code>node1</code>主机</p> 
<p>/etc/hostname</p> 
<pre><code class="prism language-bash">node1
</code></pre> 
<p><code>node2</code>主机</p> 
<p>/et/hostname</p> 
<pre><code class="prism language-bash">node2
</code></pre> 
<p>2.确认配置的三台机器的主机名称</p> 
<pre><code class="prism language-shell">$ <span class="token function">cat</span> /etc/hosts
$ <span class="token function">shutdown</span> -r now
</code></pre> 
<h4><a id="522_IP_943"></a>5.2.2 配置IP地址</h4> 
<ul><li>master</li></ul> 
<p><code>/etc/netplan/50-cloud-init.yaml</code></p> 
<pre><code class="prism language-bash">network:
    ethernets:
        ens33:
            addresses: <span class="token punctuation">[</span>192.168.236.177/24<span class="token punctuation">]</span>
            dhcp4: <span class="token boolean">false</span>
            gateway4: 192.168.236.2
            nameservers:
                       addresses: <span class="token punctuation">[</span>192.168.236.2<span class="token punctuation">]</span>
            optional: <span class="token boolean">true</span>
    version: 2
</code></pre> 
<p>重启ip配置</p> 
<pre><code class="prism language-bash">netplan apply
</code></pre> 
<ul><li>node1</li></ul> 
<p><code>/etc/netplan/50-cloud-init.yaml</code></p> 
<pre><code class="prism language-bash">network:
    ethernets:
        ens33:
            addresses: <span class="token punctuation">[</span>192.168.236.178/24<span class="token punctuation">]</span>
            dhcp4: <span class="token boolean">false</span>
            gateway4: 192.168.236.2
            nameservers:
                       addresses: <span class="token punctuation">[</span>192.168.236.2<span class="token punctuation">]</span>
            optional: <span class="token boolean">true</span>
    version: 2
</code></pre> 
<p>重启ip配置</p> 
<pre><code class="prism language-bash">netplan apply
</code></pre> 
<ul><li>node2</li></ul> 
<p><code>/etc/netplan/50-cloud-init.yaml</code></p> 
<pre><code class="prism language-bash">network:
    ethernets:
        ens33:
            addresses: <span class="token punctuation">[</span>192.168.236.179/24<span class="token punctuation">]</span>
            dhcp4: <span class="token boolean">false</span>
            gateway4: 192.168.236.2
            nameservers:
                       addresses: <span class="token punctuation">[</span>192.168.236.2<span class="token punctuation">]</span>
            optional: <span class="token boolean">true</span>
    version: 2
</code></pre> 
<p>重启ip配置</p> 
<pre><code class="prism language-bash">netplan apply
</code></pre> 
<h4><a id="523_hosts_1020"></a>5.2.3 修改hosts文件</h4> 
<p>注意： (Master、Node1、Node2都需要配置)</p> 
<p>使用root用户登录</p> 
<ol><li> <p>打开hosts文件 <code>vim /etc/hosts</code></p> </li><li> <p>输入如下内容</p> <pre><code class="prism language-shell">192.168.236.177 master
192.168.236.178 node1
192.168.236.179 node2
</code></pre> </li><li> <p>重启机器<code>shutdown -r now</code></p> </li></ol> 
<h3><a id="53_Master_1042"></a>5.3 配置Master节点</h3> 
<h4><a id="531__1044"></a>5.3.1 创建工作目录</h4> 
<pre><code class="prism language-shell">$ <span class="token function">mkdir</span> /home/itcast/working
$ <span class="token function">cd</span> /home/itcast/working/
</code></pre> 
<h4><a id="532_kubeadmconf_1051"></a>5.3.2 创建kubeadm.conf配置文件</h4> 
<ol><li>创建k8s的管理工具<code>kubeadm</code>对应的配置文件，候选操作在<code>home/itcast/working/</code>目录下</li></ol> 
<p>使用kubeadm配置文件，通过在配置文件中指定docker仓库地址，便于内网快速部署。</p> 
<p>生成配置文件</p> 
<pre><code>kubeadm config print init-defaults ClusterConfiguration &gt; kubeadm.conf
</code></pre> 
<p>上面的命令不可以的话用下面的命令：</p> 
<pre><code class="prism language-bash">kubeadm config print init-defaults
kubeadm config print join-defaults
</code></pre> 
<ol start="2"><li>修改<code>kubeadm.conf</code>中的如下两项:</li></ol> 
<ul><li>imageRepository</li><li>kubernetesVersion</li></ul> 
<pre><code class="prism language-bash"><span class="token function">vi</span> kubeadm.conf
<span class="token comment"># 修改 imageRepository: k8s.gcr.io</span>
<span class="token comment"># 改为 registry.cn-beijing.aliyuncs.com/imcto</span>
imageRepository: registry.cn-beijing.aliyuncs.com/imcto
<span class="token comment"># 修改kubernetes版本kubernetesVersion: v1.13.0</span>
<span class="token comment"># 改为kubernetesVersion: v1.13.1</span>
kubernetesVersion: v1.13.1
</code></pre> 
<ol start="3"><li>修改<code>kubeadm.conf</code>中的API服务器地址，后面会频繁使用这个地址。</li></ol> 
<ul><li>localAPIEndpoint:</li></ul> 
<pre><code class="prism language-shell">localAPIEndpoint:
  advertiseAddress: 192.168.236.177
  bindPort: 6443
</code></pre> 
<blockquote> 
 <p>注意: <code>192.168.236.177</code>是master主机的ip地址</p> 
</blockquote> 
<ol start="4"><li>配置子网网络</li></ol> 
<pre><code class="prism language-ini">networking:
  dnsDomain: cluster.local
  podSubnet: 10.244.0.0/16
  serviceSubnet: 10.96.0.0/12
scheduler: {}
</code></pre> 
<p>这里的<code>10.244.0.0/16</code> 和 <code>10.96.0.0/12</code>分别是k8s内部pods和services的子网网络，最好使用这个地址，后续flannel网络需要用到。</p> 
<h4><a id="533_K8s_1110"></a>5.3.3 拉取K8s必备的模块镜像</h4> 
<ol><li>查看一下都需要哪些镜像文件需要拉取</li></ol> 
<pre><code>$ kubeadm config images list --config kubeadm.conf
registry.cn-beijing.aliyuncs.com/imcto/kube-apiserver:v1.13.1
registry.cn-beijing.aliyuncs.com/imcto/kube-controller-manager:v1.13.1
registry.cn-beijing.aliyuncs.com/imcto/kube-scheduler:v1.13.1
registry.cn-beijing.aliyuncs.com/imcto/kube-proxy:v1.13.1
registry.cn-beijing.aliyuncs.com/imcto/pause:3.1
registry.cn-beijing.aliyuncs.com/imcto/etcd:3.2.24
registry.cn-beijing.aliyuncs.com/imcto/coredns:1.2.6
</code></pre> 
<ol start="2"><li>拉取镜像</li></ol> 
<pre><code class="prism language-bash"><span class="token comment">#下载全部当前版本的k8s所关联的镜像</span>
kubeadm config images pull --config ./kubeadm.conf
</code></pre> 
<h4><a id="534_kubernetes_1132"></a>5.3.4 初始化kubernetes环境</h4> 
<pre><code class="prism language-bash"><span class="token comment">#初始化并且启动</span>
$ <span class="token function">sudo</span> kubeadm init --config ./kubeadm.conf
</code></pre> 
<p>更多kubeadm配置文件参数详见</p> 
<pre><code>kubeadm config print-defaults
</code></pre> 
<p><strong>k8s启动成功输出内容较多，但是记住末尾的内容</strong></p> 
<pre><code class="prism language-shell">Your Kubernetes master has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> -p <span class="token variable">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token variable">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token keyword">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token variable">$HOME</span>/.kube/config

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now <span class="token function">join</span> any number of machines by running the following on each node
as root:

  kubeadm <span class="token function">join</span> 192.168.236.177:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:e778d3665e52f5a680a87b00c6d54df726c2eda601c0db3bfa4bb198af2262a8
</code></pre> 
<p>按照官方提示，执行以下操作。</p> 
<ol><li> <p>执行如下命令</p> <pre><code class="prism language-shell">$ <span class="token function">mkdir</span> -p <span class="token variable">$HOME</span>/.kube
$ <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token variable">$HOME</span>/.kube/config
$ <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token keyword">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token variable">$HOME</span>/.kube/config
</code></pre> </li><li> <p>创建系统服务并启动</p> <pre><code class="prism language-shell"><span class="token comment"># 启动kubelet 设置为开机自启动</span>
$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> kubelet
<span class="token comment"># 启动k8s服务程序</span>
$ <span class="token function">sudo</span> systemctl start kubelet
</code></pre> </li></ol> 
<h4><a id="535_kubernetes_1188"></a>5.3.5 验证kubernetes启动结果</h4> 
<ol><li>验证输入，注意显示master状态是<code>NotReady</code>，证明初始化服务器成功</li></ol> 
<pre><code class="prism language-shell">$ kubectl get nodes
NAME     STATUS     ROLES    AGE   VERSION
master   NotReady   master   12m   v1.13.1
</code></pre> 
<ol start="2"><li>查看当前k8s集群状态</li></ol> 
<pre><code class="prism language-shell">$ kubectl get cs
NAME                 STATUS    MESSAGE              ERROR
scheduler            Healthy   ok
controller-manager   Healthy   ok
etcd-0               Healthy   <span class="token punctuation">{<!-- --></span><span class="token string">"health"</span><span class="token keyword">:</span> <span class="token string">"true"</span><span class="token punctuation">}</span>
</code></pre> 
<p>目前只有一个master，还没有node，而且是NotReady状态，那么我们需要将node加入到master管理的集群中来。在加入之前，我们需要先配置k8s集群的内部通信网络，这里采用的是flannel网络。</p> 
<h4><a id="536_flannel_1211"></a>5.3.6 部署集群内部通信flannel网络</h4> 
<pre><code class="prism language-bash"><span class="token variable">$cd</span> <span class="token variable">$HOME</span>/working
<span class="token variable">$wget</span> https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml
</code></pre> 
<p>编辑这个文件，确保flannel网络是对的,找到<code>net-conf.json</code>标记的内容是否正确。</p> 
<pre><code class="prism language-ini"> net-conf.json: |
    {
      "Network": "10.244.0.0/16",
      "Backend": {
        "Type": "vxlan"
      }
</code></pre> 
<p><strong>这个"10.244.0.0/16"和 ./kubeadm.conf中的podsubnet的地址要一致。</strong></p> 
<p>应用当前flannel配置文件</p> 
<pre><code class="prism language-shell">itcast@master:~/working$ kubectl apply -f kube-flannel.yml 
</code></pre> 
<p>输出结果如下</p> 
<pre><code class="prism language-shell">root@master:~/working<span class="token comment"># kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml</span>
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.extensions/kube-flannel-ds-amd64 created
daemonset.extensions/kube-flannel-ds-arm64 created
daemonset.extensions/kube-flannel-ds-arm created
daemonset.extensions/kube-flannel-ds-ppc64le created
daemonset.extensions/kube-flannel-ds-s390x created
</code></pre> 
<p>安装flannel网络前 执行<code>kubectl get nodes</code>输出结果如下</p> 
<pre><code class="prism language-bash">itcast@master:~/working$ kubectl get node
NAME     STATUS     ROLES    AGE   VERSION
master   NotReady   master   10m   v1.13.1
</code></pre> 
<p>安装flannel网络后 执行<code>kubectl get nodes</code>输出结果如下</p> 
<pre><code class="prism language-bash">itcast@master:~/working$ kubectl get node
NAME     STATUS   ROLES    AGE   VERSION
master   Ready    master   10m   v1.13.1
</code></pre> 
<p>此时master已经是<code>Ready</code>状态了，表示已经配置成功了，那么我们就需要配置node来加入这个集群。</p> 
<h3><a id="54_Node_1280"></a>5.4 配置Node</h3> 
<h4><a id="541__1282"></a>5.4.1 确认外部环境</h4> 
<ol><li> <p>确认关闭swap</p> <pre><code class="prism language-shell">apt <span class="token function">install</span> -y selinux-utils
swapoff -a
</code></pre> </li><li> <p>禁止selinux</p> <pre><code class="prism language-shell">setenforce 0
</code></pre> </li><li> <p>确认关闭防火墙</p> <pre><code class="prism language-shell">ufw disable
</code></pre> </li></ol> 
<h4><a id="542_k8sNode_1303"></a>5.4.2 配置k8s集群的Node主机环境</h4> 
<ol><li> <p>启动k8s后台服务</p> <pre><code class="prism language-shell"><span class="token comment"># 启动kubelet 设置为开机自启动</span>
$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> kubelet
<span class="token comment"># 启动k8s服务程序</span>
$ <span class="token function">sudo</span> systemctl start kubelet
</code></pre> </li><li> <p>将master机器的<code>/etc/kubernetes/admin.conf</code>传到到node1和node2</p> <p>登录<code>master</code>终端</p> <pre><code class="prism language-shell"><span class="token comment">#将admin.conf传递给node1</span>
<span class="token function">sudo</span> <span class="token function">scp</span> /etc/kubernetes/admin.conf itcast@192.168.236.178:/home/itcast/
<span class="token comment">#将admin.conf传递给node2</span>
<span class="token function">sudo</span> <span class="token function">scp</span> /etc/kubernetes/admin.conf itcast@192.168.236.179:/home/itcast/
</code></pre> </li><li> <p>登录<code>node1</code>终端，创建基础kube配置文件环境</p> </li></ol> 
<pre><code class="prism language-bash">$ <span class="token function">mkdir</span> -p <span class="token variable">$HOME</span>/.kube
$ <span class="token function">sudo</span> <span class="token function">cp</span> -i <span class="token variable">$HOME</span>/admin.conf <span class="token variable">$HOME</span>/.kube/config
$ <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token keyword">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token variable">$HOME</span>/.kube/config
</code></pre> 
<ol start="4"><li>登录<code>node2</code>终端，创建基础kube配置文件环境</li></ol> 
<pre><code class="prism language-bash">$ <span class="token function">mkdir</span> -p <span class="token variable">$HOME</span>/.kube
$ <span class="token function">sudo</span> <span class="token function">cp</span> -i <span class="token variable">$HOME</span>/admin.conf <span class="token variable">$HOME</span>/.kube/config
$ <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token keyword">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token variable">$HOME</span>/.kube/config
</code></pre> 
<ol start="5"><li><code>node1</code>和<code>node2</code>分别连接<code>master</code>加入master集群。这里用的是<code>kubeadm join</code>指令</li></ol> 
<pre><code class="prism language-shell">$ <span class="token function">sudo</span> kubeadm <span class="token function">join</span> 192.168.236.177:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:e778d3665e52f5a680a87b00c6d54df726c2eda601c0db3bfa4bb198af2262a8
</code></pre> 
<p>这里要注意，使用的hash应该是<code>master</code>主机 <code>kubeadm init</code>成功之后生成的hash码。</p> 
<ol start="6"><li>应用两个node主机分别应用flannel网络</li></ol> 
<p>将<code>master</code>中的<code>kube-flannel.yml</code>分别传递给两个<code>node</code>节点.</p> 
<pre><code class="prism language-bash"><span class="token comment">#将kube-flannel.yml传递给node1</span>
<span class="token function">sudo</span> <span class="token function">scp</span> <span class="token variable">$HOME</span>/working/kube-flannel.yml itcast@192.168.236.178:/home/itcast/
<span class="token comment">#将kube-flannel.yml传递给node2</span>
<span class="token function">sudo</span> <span class="token function">scp</span> <span class="token variable">$HOME</span>/working/kube-flannel.yml itcast@192.168.236.179:/home/itcast/
</code></pre> 
<p>分别启动<code>flannel</code>网络</p> 
<pre><code class="prism language-bash">itcast@node1:~$ kubectl apply -f kube-flannel.yml 
</code></pre> 
<pre><code class="prism language-bash">itcast@node2:~$ kubectl apply -f kube-flannel.yml
</code></pre> 
<ol start="7"><li>查看node是否已经加入到k8s集群中(需要等一段时间才能ready)</li></ol> 
<pre><code class="prism language-bash">itcast@node2:~$ kubectl get nodes
NAME     STATUS   ROLES    AGE     VERSION
master   Ready    master   35m     v1.13.1
node1    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   2m23s   v1.13.1
node2    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   40s     v1.13.1
</code></pre> 
<h2><a id="_1386"></a>六、应用实例</h2> 
<h3><a id="61_MySQL_1388"></a>6.1 创建MySQL实例</h3> 
<h4><a id="611__1390"></a>6.1.1 定义描述文件</h4> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController                            <span class="token comment">#副本控制器RC</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql                                          <span class="token comment">#RC的名称，全局唯一</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1                                          </span><span class="token comment">#Pod副本的期待数量</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql                                         <span class="token comment">#符合目标的Pod拥有此标签</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>                                            <span class="token comment">#根据此模板创建Pod的副本（实例）</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql                                     <span class="token comment">#Pod副本拥有的标签，对应RC的Selector</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>                                      <span class="token comment">#Pod内容器的定义部分</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql                                    <span class="token comment">#容器的名称</span>
        <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.c.163.com/library/mysql              <span class="token comment">#容器对应的Docker image</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306                          </span><span class="token comment">#容器应用监听的端口号</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>                                           <span class="token comment">#注入容器内的环境变量</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD 
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"123456"</span>
</code></pre> 
<h4><a id="612_ReplicationController_1416"></a>6.1.2 加载ReplicationController副本控制器描述文件</h4> 
<p>创建好mysql-rc.yaml后，在master节点使用kubectl命令将它发布到k8s集群中。</p> 
<pre><code class="prism language-shell">kubectl create -f mysql-rc.yaml
</code></pre> 
<h4><a id="613__1424"></a>6.1.3 查看启动状态</h4> 
<p>通过查看当前的<code>pods</code>列表，是否已经启动成功:</p> 
<h4><a id="614__1430"></a>6.1.4 网络异常解决方案(未出现问题可直接跳过)</h4> 
<p>注意：如果这里出现了<code>ContainerCreating</code>状态，那么可以尝试如下解决办法:</p> 
<pre><code class="prism language-bash">itcast@master:~/working$ kubectl get pods
NAME          READY   STATUS              RESTARTS   AGE
mysql-tscrh   0/1     ContainerCreating   0          17m
</code></pre> 
<p>目前mysql-tscrh 描述文件 已经创建，但是没有启动成功. 状态是<code>ContainerCreating</code> 没有启动起来.</p> 
<p>通过<code>kubectl describe pods</code>来查看<code>pods</code>的详细状态</p> 
<pre><code class="prism language-bash">itcast@master:~/working$ kubectl describe pods mysql
Name:               mysql-tscrh
Namespace:          default
Priority:           0
PriorityClassName:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Node:               node1/192.168.236.178
Start Time:         Mon, 17 Jun 2019 09:10:35 +0000
Labels:             app<span class="token operator">=</span>mysql
Annotations:        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Status:             Pending
IP:                 
Controlled By:      ReplicationController/mysql
Containers:
  mysql:
    Container ID:   
    Image:          hub.c.163.com/library/mysql
    Image ID:       
    Port:           3306/TCP
    Host Port:      0/TCP
    State:          Waiting
      Reason:       ContainerCreating
    Ready:          False
    Restart Count:  0
    Environment:
      MYSQL_ROOT_PASSWORD:  123456
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-q6ggq <span class="token punctuation">(</span>ro<span class="token punctuation">)</span>
Conditions:
  Type              Status
  Initialized       True 
  Ready             False 
  ContainersReady   False 
  PodScheduled      True 
Volumes:
  default-token-q6ggq:
    Type:        Secret <span class="token punctuation">(</span>a volume populated by a Secret<span class="token punctuation">)</span>
    SecretName:  default-token-q6ggq
    Optional:    <span class="token boolean">false</span>
QoS Class:       BestEffort
Node-Selectors:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="token keyword">for</span> 300s
                 node.kubernetes.io/unreachable:NoExecute <span class="token keyword">for</span> 300s
Events:
  Type     Reason                  Age                     From               Message
  ----     ------                  ----                    ----               -------
  Normal   Scheduled               22m                     default-scheduler  Successfully assigned default/mysql-tscrh to node1
  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token keyword">set</span> up sandbox container <span class="token string">"58d143373e767c40610587624c667d8e20dd77fa397952406a085f2ae1dc38e6"</span> network <span class="token keyword">for</span> pod <span class="token string">"mysql-tscrh"</span><span class="token keyword">:</span> NetworkPlugin cni failed to <span class="token keyword">set</span> up pod <span class="token string">"mysql-tscrh_default"</span> network: <span class="token function">open</span> /run/flannel/subnet.env: no such <span class="token function">file</span> or directory
  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token keyword">set</span> up sandbox container <span class="token string">"81d12726dbe075c64af48142638e98863231e8201ccc292f0dda1fccfa7fdaec"</span> network <span class="token keyword">for</span> pod <span class="token string">"mysql-tscrh"</span><span class="token keyword">:</span> NetworkPlugin cni failed to <span class="token keyword">set</span> up pod <span class="token string">"mysql-tscrh_default"</span> network: <span class="token function">open</span> /run/flannel/subnet.env: no such <span class="token function">file</span> or directory
  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token keyword">set</span> up sandbox container <span class="token string">"8bd77ee0176d369435ead7bd3c2675b7bbcbdc2b052cf34c784f04053a7d5288"</span> network <span class="token keyword">for</span> pod <span class="token string">"mysql-tscrh"</span><span class="token keyword">:</span> NetworkPlugin cni failed to <span class="token keyword">set</span> up pod <span class="token string">"mysql-tscrh_default"</span> network: <span class="token function">open</span> /run/flannel/subnet.env: no such <span class="token function">file</span> or directory
  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token keyword">set</span> up sandbox container <span class="token string">"0733fc209e085e96f5823a2280b012a609dace41fda967c5ae951005a8699ce6"</span> network <span class="token keyword">for</span> pod <span class="token string">"mysql-tscrh"</span><span class="token keyword">:</span> NetworkPlugin cni failed to <span class="token keyword">set</span> up pod <span class="token string">"mysql-tscrh_default"</span> network: <span class="token function">open</span> /run/flannel/subnet.env: no such <span class="token function">file</span> or directory
  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token keyword">set</span> up sandbox container <span class="token string">"91f337eb334612b2e7426d820ba4b15a9c9c549050517d459508832b69780b5f"</span> network <span class="token keyword">for</span> pod <span class="token string">"mysql-tscrh"</span><span class="token keyword">:</span> NetworkPlugin cni failed to <span class="token keyword">set</span> up pod <span class="token string">"mysql-tscrh_default"</span> network: <span class="token function">open</span> /run/flannel/subnet.env: no such <span class="token function">file</span> or directory
  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token keyword">set</span> up sandbox container <span class="token string">"48cbba9896068a774d9128a6864394e8726a0d857bae61036421ad73f5d6e3dd"</span> network <span class="token keyword">for</span> pod <span class="token string">"mysql-tscrh"</span><span class="token keyword">:</span> NetworkPlugin cni failed to <span class="token keyword">set</span> up pod <span class="token string">"mysql-tscrh_default"</span> network: <span class="token function">open</span> /run/flannel/subnet.env: no such <span class="token function">file</span> or directory
  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token keyword">set</span> up sandbox container <span class="token string">"d259778aa19418a9a429b3175b66afae3d8ffb7324ec9df492b2947dbc153460"</span> network <span class="token keyword">for</span> pod <span class="token string">"mysql-tscrh"</span><span class="token keyword">:</span> NetworkPlugin cni failed to <span class="token keyword">set</span> up pod <span class="token string">"mysql-tscrh_default"</span> network: <span class="token function">open</span> /run/flannel/subnet.env: no such <span class="token function">file</span> or directory
  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token keyword">set</span> up sandbox container <span class="token string">"3d01c00ac9eaac7b2e983402be38c1cf60c4bbd1d454aa45329ce0ca0c2bf792"</span> network <span class="token keyword">for</span> pod <span class="token string">"mysql-tscrh"</span><span class="token keyword">:</span> NetworkPlugin cni failed to <span class="token keyword">set</span> up pod <span class="token string">"mysql-tscrh_default"</span> network: <span class="token function">open</span> /run/flannel/subnet.env: no such <span class="token function">file</span> or directory
  Warning  FailedCreatePodSandBox  22m                     kubelet, node1     Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token keyword">set</span> up sandbox container <span class="token string">"98879cbb0405dac3a24753dd1986070a53fe9ee9f1b819996a903c19286a2bb7"</span> network <span class="token keyword">for</span> pod <span class="token string">"mysql-tscrh"</span><span class="token keyword">:</span> NetworkPlugin cni failed to <span class="token keyword">set</span> up pod <span class="token string">"mysql-tscrh_default"</span> network: <span class="token function">open</span> /run/flannel/subnet.env: no such <span class="token function">file</span> or directory
  Warning  FailedCreatePodSandBox  7m49s <span class="token punctuation">(</span>x838 over 22m<span class="token punctuation">)</span>   kubelet, node1     <span class="token punctuation">(</span>combined from similar events<span class="token punctuation">)</span>: Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token keyword">set</span> up sandbox container <span class="token string">"60923335b41c2d0412b279bdb6150f9b9b7eae20c4a02549e35509083c01384b"</span> network <span class="token keyword">for</span> pod <span class="token string">"mysql-tscrh"</span><span class="token keyword">:</span> NetworkPlugin cni failed to <span class="token keyword">set</span> up pod <span class="token string">"mysql-tscrh_default"</span> network: <span class="token function">open</span> /run/flannel/subnet.env: no such <span class="token function">file</span> or directory
  Normal   SandboxChanged          2m49s <span class="token punctuation">(</span>x1127 over 22m<span class="token punctuation">)</span>  kubelet, node1     Pod sandbox changed, it will be killed and re-created.
</code></pre> 
<p>会看到一个错误:</p> 
<pre><code>"mysql-tscrh": NetworkPlugin cni failed to set up pod "mysql-tscrh_default" network: open /run/flannel/subnet.env: no such file or directory
</code></pre> 
<p>这是缺少/run/flannel/subnet.env文件</p> 
<h6><a id="flannel_1516"></a>解决办法：配置flannel网络</h6> 
<p>分别在三台服务器上执行如下步骤</p> 
<ol><li> <p>创建目录</p> <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">mkdir</span> -p /run/flannel
</code></pre> </li><li> <p>创建环境描述文件</p> <pre><code class="prism language-shell">$ <span class="token function">sudo</span> <span class="token function">tee</span> /run/flannel/subnet.env <span class="token operator">&lt;&lt;</span>-<span class="token string">'EOF'</span>
FLANNEL_NETWORK<span class="token operator">=</span>10.244.0.0/16
FLANNEL_SUBNET<span class="token operator">=</span>10.244.0.1/24
FLANNEL_MTU<span class="token operator">=</span>1450
FLANNEL_IPMASQ<span class="token operator">=</span>true
EOF
</code></pre> </li></ol> 
<h4><a id="615_mysql_1540"></a>6.1.5 查看mysql实例集群状态</h4> 
<pre><code class="prism language-bash">itcast@master:~/working$ kubectl get pods
NAME          READY   STATUS              RESTARTS   AGE
mysql-tscrh   0/1     Running   0          17m
</code></pre> 
<p>如果为<code>Running</code>状态，则为mysql集群启动成功。</p> 
<h3><a id="62_Tomcat_1554"></a>6.2 创建Tomcat实例</h3> 
<h4><a id="621__1556"></a>6.2.1 定义描述文件</h4> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myweb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">5                                       </span><span class="token comment">#Pod副本期待数量为5</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myweb
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> myweb
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myweb
        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.io/kubeguide/tomcat<span class="token punctuation">-</span>app<span class="token punctuation">:</span>v1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_HOST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"mysql"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PORT
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"3306"</span>
</code></pre> 
<h4><a id="622_RC_1586"></a>6.2.2 加载RC副本描述文件</h4> 
<pre><code class="prism language-shell">$ kubectl create -f myweb-rc.yaml
replicationcontroller/myweb created
$ kubectl get rc
NAME    DESIRED   CURRENT   READY   AGE
mysql   1         1         0       4m22s
myweb   5         5         0       7s
$ kubectl get pods
NAME          READY   STATUS              RESTARTS   AGE
mysql-tp69s   1/1     Running             0          21s
myweb-266mz   0/1     ContainerCreating   0          2s
myweb-j7nl7   0/1     ContainerCreating   0          2s
myweb-s7drm   0/1     ContainerCreating   0          2s
myweb-sq4ns   0/1     ContainerCreating   0          2s
myweb-t4vlf   0/1     ContainerCreating   0          2s
$ 
</code></pre> 
<p>注意mysql实例 状态 <code>Running</code></p> 
<p>myweb实例状态 <code>ContainerCreating</code></p> 
<p>过几分钟myweb实例状态变成 <code>Running</code></p> 
<h4><a id="623__1614"></a>6.2.3 创建服务副本</h4> 
<p>在master服务器</p> 
<ol><li>使用root用户登录，并切换到working目录 <code>cd /root/working</code></li><li>创建描述服务描述文件<code>myweb-svc.yaml</code></li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myweb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30001</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myweb 
</code></pre> 
<h4><a id="624__1637"></a>6.2.4 部署服务</h4> 
<pre><code class="prism language-bash"><span class="token variable">$kubectl</span> create -f myweb-svc.yaml
</code></pre> 
<h4><a id="625__1645"></a>6.2.5 验证</h4> 
<pre><code class="prism language-shell">$ kubectl get pods
NAME          READY   STATUS    RESTARTS   AGE
mysql-tp69s   1/1     Running   0          15m
myweb-266mz   1/1     Running   0          14m
myweb-j7nl7   1/1     Running   0          14m
myweb-s7drm   1/1     Running   0          14m
myweb-sq4ns   1/1     Running   0          14m
myweb-t4vlf   1/1     Running   0          14m
</code></pre> 
<pre><code class="prism language-bash">itcast@master:~/working$ kubectl get <span class="token function">service</span>     
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
kubernetes   ClusterIP   10.96.0.1        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        443/TCP          19h
myweb        NodePort    10.109.234.197   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        8080:30001/TCP   25m
</code></pre> 
<p>已经看到已经有一个<code>myweb</code>服务已经启动</p> 
<pre><code class="prism language-bash">itcast@master:~/working$ kubectl describe <span class="token function">service</span> myweb
Name:                     myweb
Namespace:                default
Labels:                   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:              <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Selector:                 app<span class="token operator">=</span>myweb
Type:                     NodePort
IP:                       10.109.234.197
Port:                     <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  8080/TCP
TargetPort:               8080/TCP
NodePort:                 <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  30001/TCP
Endpoints:                10.244.0.6:8080,10.244.0.6:8080,10.244.0.7:8080 + 2 more<span class="token punctuation">..</span>.
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> 
<p>service详情这里的IP就是CLUSTER-IP. CLUSTER-IP是和service绑定的。</p> 
<p>service详情这里的Port就是Service的端口号。</p> 
<p>service详情这里的NodePort就是Node的真实端口号。</p> 
<p>service详情这里的Endpoints就是容器的IP和port。</p> 
<p>验证端口号</p> 
<pre><code class="prism language-shell">$ <span class="token function">netstat</span> -tlp<span class="token operator">|</span><span class="token function">grep</span> 30001
tcp6       0      0 <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:30001              <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:*                  LISTEN      4333/kube-proxy
$
</code></pre> 
<p>我们可以打开浏览器，输入master/node1/node2任何一个地址家30001端口都可以，访问tomcat服务。</p> 
<pre><code>http://192.168.236.177:30001
</code></pre> 
<h3><a id="63_Beego_web_1727"></a>6.3 创建自定义的Beego 应用web程序集群</h3> 
<h4><a id="631_mysql_1729"></a>6.3.1 初始化mysql</h4> 
<ol><li>找到我们之前创建好的mysql的pod的<code>NAME</code></li></ol> 
<pre><code class="prism language-bash">itcast@master:~$ kubectl get pods
NAME          READY   STATUS    RESTARTS   AGE
mysql-kjdz8   1/1     Running   2          4d23h
myweb-f7rt4   1/1     Running   2          4d23h
myweb-jjxbp   1/1     Running   2          4d23h
myweb-k8rmt   1/1     Running   2          4d23h
myweb-rht8n   1/1     Running   2          4d23h
myweb-wsgzw   1/1     Running   2          4d23h
</code></pre> 
<ol start="2"><li>查看当前pod的详细信息</li></ol> 
<pre><code class="prism language-bash">itcast@master:~$ kubectl describe pod mysql-kjdz8

</code></pre> 
<ol start="3"><li>得到mysql在subnet内网的IP地址<code>10.244.1.8</code> 和登录密码</li></ol> 
<pre><code class="prism language-bash">IP:                 10.244.1.8 
 <span class="token punctuation">..</span>.
 Environment:
      MYSQL_ROOT_PASSWORD:  123456
</code></pre> 
<ol start="4"><li>登录mysql实例，创建数据库</li></ol> 
<pre><code class="prism language-bash">itcast@master:~$ kubectl <span class="token function">exec</span> -it mysql-kjdz8 -- <span class="token function">bash</span>
</code></pre> 
<pre><code class="prism language-bash">root@mysql-kjdz8:/<span class="token comment"># mysql -u root --password=123456 --default-character-set=utf8     </span>
</code></pre> 
<ol start="5"><li>创建数据库，注意大小写</li></ol> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> newsWeb  <span class="token keyword">default</span> <span class="token keyword">charset</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span>
</code></pre> 
<ol start="6"><li>使用数据库</li></ol> 
<pre><code class="prism language-sql"><span class="token keyword">use</span> newsWeb
</code></pre> 
<h4><a id="632_beegodocker__1792"></a>6.3.2 下载自定义的beego-docker 镜像</h4> 
<pre><code class="prism language-bash">itcast@master:~$ docker pull registry.cn-shanghai.aliyuncs.com/itcast-golang/beego-microservices:v4
921b31ab772b: Pull complete 
5dbef71438d6: Pull complete 
06b82a06d476: Pull complete 
903fde8a2004: Pull complete 
5102aca51d1d: Pull complete 
b0ebda6ce096: Pull complete 
1a243f1cae73: Pull complete 
Digest: sha256:7b83e5117d964f348750de76104d6302285410365aaf6e6a0d4f57edab7a0ad5
Status: Downloaded newer image <span class="token keyword">for</span> registry.cn-shanghai.aliyuncs.com/itcast-golang/beego-microservices:v4
</code></pre> 
<p>当然，目前该镜像地址是我们自己打包的，如果你想启动你自己的镜像应用，也需要打包成docker镜像放在阿里云或者其他docker仓库中。</p> 
<p>查看docker镜像是否已经下载成功。</p> 
<pre><code class="prism language-bash">itcast@master:~$ docker images
REPOSITORY                                                            TAG                 IMAGE ID            CREATED             SIZE
registry.cn-shanghai.aliyuncs.com/itcast-golang/beego-microservices   v4                  11f6f974f78b        35 minutes ago      23.1MB
alpine                                                                latest              055936d39205        6 weeks ago         5.53MB
registry.cn-beijing.aliyuncs.com/imcto/kube-controller-manager        v1.13.1             6ca952430d0a        3 months ago        146MB
registry.cn-beijing.aliyuncs.com/imcto/kube-proxy                     v1.13.1             a311f9763fcc        3 months ago        80.2MB
registry.cn-beijing.aliyuncs.com/imcto/coredns                        1.2.6               782ac1267b76        3 months ago        40MB
registry.cn-beijing.aliyuncs.com/imcto/etcd                           3.2.24              399cf402bfe9        3 months ago        220MB
registry.cn-beijing.aliyuncs.com/imcto/pause                          3.1                 73ae15a7a613        3 months ago        742kB
registry.cn-beijing.aliyuncs.com/imcto/kube-scheduler                 v1.13.1             4b8df70aff4e        3 months ago        79.6MB
registry.cn-beijing.aliyuncs.com/imcto/kube-apiserver                 v1.13.1             06924f18fe15        3 months ago        181MB
quay.io/coreos/flannel                                                v0.11.0-amd64       ff281650a721        4 months ago        52.6MB
</code></pre> 
<h4><a id="633_beegoRC_1830"></a>6.3.3 创建beego的RC副本文件</h4> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> beego
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">5                                       </span><span class="token comment">#Pod副本期待数量为5</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> beego
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> beego
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> beego
        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>shanghai.aliyuncs.com/itcast<span class="token punctuation">-</span>golang/beego<span class="token punctuation">-</span>microservices<span class="token punctuation">:</span>v4
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_HOST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"10.244.1.8"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PORT
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"3306"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"root"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"123456"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_DATABASE
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"newsWeb"</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> beego
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> beego
~               
</code></pre> 
<p>这里要注意，里面的mysql环境变量IP、端口、数据库用户名密码等，都是我们上面实例获取到的。</p> 
<p>这里实际上是在我们创建一个pods容器的时候，指定的一些环境变量。然后beego的应用程序会从系统中这些环境变量去取数据。</p> 
<p>目前建立了NodePort端口映射，beegoWeb应用在内网的端口是8080，对外的映射端口是30080.那么30080就是我们外网可以访问的端口号。</p> 
<h4><a id="634_RCbeego_1887"></a>6.3.4 装载RC副本文件，创建beego集群实例</h4> 
<pre><code class="prism language-shell">$ kubectl apply -f golang-beego.yaml
</code></pre> 
<p>查看beego的web程序pods是否已经正常启动</p> 
<pre><code class="prism language-bash">itcast@master:~/working$ kubectl get pods
NAME          READY   STATUS    RESTARTS   AGE
beego-2wt7s   1/1     Running   0          2m47s
beego-6jp8x   1/1     Running   0          2m47s
beego-7bkvl   1/1     Running   0          2m47s
beego-qjldn   1/1     Running   0          2m47s
beego-vldmh   1/1     Running   0          2m47s
mysql-kjdz8   1/1     Running   2          5d
myweb-f7rt4   1/1     Running   2          5d
myweb-jjxbp   1/1     Running   2          5d
myweb-k8rmt   1/1     Running   2          5d
myweb-rht8n   1/1     Running   2          5d
myweb-wsgzw   1/1     Running   2          5d
</code></pre> 
<p>也可以查看beego程序的pods的正常输出日志</p> 
<pre><code class="prism language-bash">itcast@master:~/working$ kubectl log beego-2wt7s     
log is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use logs instead.
2019/06/24 09:19:12 root:123456@tcp<span class="token punctuation">(</span>10.244.1.8:3306<span class="token punctuation">)</span>/newsWeb?charset<span class="token operator">=</span>utf8
table <span class="token variable"><span class="token variable">`</span>user<span class="token variable">`</span></span> already exists, skip
table <span class="token variable"><span class="token variable">`</span>article<span class="token variable">`</span></span> already exists, skip
table <span class="token variable"><span class="token variable">`</span>article_type<span class="token variable">`</span></span> already exists, skip
table <span class="token variable"><span class="token variable">`</span>article_users<span class="token variable">`</span></span> already exists, skip
2019/06/24 09:19:12.241 <span class="token punctuation">[</span>I<span class="token punctuation">]</span> <span class="token punctuation">[</span>asm_amd64.s:1337<span class="token punctuation">]</span>  http server Running on http://:8080
</code></pre> 
<p>进入其中一个beego容器，查看环境变量是否和我们配置的一致</p> 
<pre><code class="prism language-bash">itcast@master:~/working$ kubectl  <span class="token function">exec</span> -it beego-2wt7s -- sh
/app <span class="token comment"># env</span>
KUBERNETES_SERVICE_PORT<span class="token operator">=</span>443
KUBERNETES_PORT<span class="token operator">=</span>tcp://10.96.0.1:443
BEEGO_PORT_8080_TCP<span class="token operator">=</span>tcp://10.107.31.251:8080
HOSTNAME<span class="token operator">=</span>beego-2wt7s
MYWEB_SERVICE_HOST<span class="token operator">=</span>10.106.98.4
MYWEB_PORT_8080_TCP_ADDR<span class="token operator">=</span>10.106.98.4
SHLVL<span class="token operator">=</span>1
HOME<span class="token operator">=</span>/root
MYWEB_PORT_8080_TCP_PORT<span class="token operator">=</span>8080
MYWEB_PORT_8080_TCP_PROTO<span class="token operator">=</span>tcp
MYWEB_SERVICE_PORT<span class="token operator">=</span>8080
MYWEB_PORT<span class="token operator">=</span>tcp://10.106.98.4:8080
MYWEB_PORT_8080_TCP<span class="token operator">=</span>tcp://10.106.98.4:8080
TERM<span class="token operator">=</span>xterm
KUBERNETES_PORT_443_TCP_ADDR<span class="token operator">=</span>10.96.0.1
MYSQL_SERVICE_PASSWORD<span class="token operator">=</span>123456
PATH<span class="token operator">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
KUBERNETES_PORT_443_TCP_PORT<span class="token operator">=</span>443
MYSQL_SERVICE_HOST<span class="token operator">=</span>10.244.1.8
KUBERNETES_PORT_443_TCP_PROTO<span class="token operator">=</span>tcp
MYSQL_SERVICE_USER<span class="token operator">=</span>root
BEEGO_SERVICE_HOST<span class="token operator">=</span>10.107.31.251
BEEGO_PORT_8080_TCP_ADDR<span class="token operator">=</span>10.107.31.251
MYSQL_SERVICE_PORT<span class="token operator">=</span>3306
KUBERNETES_SERVICE_PORT_HTTPS<span class="token operator">=</span>443
KUBERNETES_PORT_443_TCP<span class="token operator">=</span>tcp://10.96.0.1:443
BEEGO_PORT_8080_TCP_PORT<span class="token operator">=</span>8080
KUBERNETES_SERVICE_HOST<span class="token operator">=</span>10.96.0.1
BEEGO_PORT_8080_TCP_PROTO<span class="token operator">=</span>tcp
PWD<span class="token operator">=</span>/app
MYSQL_SERVICE_DATABASE<span class="token operator">=</span>newsWeb
BEEGO_PORT<span class="token operator">=</span>tcp://10.107.31.251:8080
BEEGO_SERVICE_PORT<span class="token operator">=</span>8080
/app <span class="token comment"># env | grep MYSQL</span>
MYSQL_SERVICE_PASSWORD<span class="token operator">=</span>123456
MYSQL_SERVICE_HOST<span class="token operator">=</span>10.244.1.8
MYSQL_SERVICE_USER<span class="token operator">=</span>root
MYSQL_SERVICE_PORT<span class="token operator">=</span>3306
MYSQL_SERVICE_DATABASE<span class="token operator">=</span>newsWeb
</code></pre> 
<h4><a id="635__1982"></a>6.3.5 验证集群是否成功</h4> 
<ul><li>注册界面</li></ul> 
<p><a href="http://192.168.236.177:30080/register" rel="nofollow">http://192.168.236.177:30080/register</a></p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-sz2NNQPN-1617883302088)(./assert/beego2.png)]</p> 
<ul><li>登陆界面</li></ul> 
<p><a href="http://192.168.236.177:30080/login" rel="nofollow">http://192.168.236.177:30080/login</a></p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-wx6fsXYU-1617883302088)(./assert/beego3.png)]</p> 
<ul><li>后端界面</li></ul> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-J88mDaGs-1617883302089)(./assert/beego1.png)]</p> 
<h2><a id="k8s_2006"></a>七、k8s架构图</h2> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-J7o5oBQu-1617883302089)(./assert/architecture.png)]</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7ce525878e44bc146d3802b2365e4c4c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[Windows]使用注册表解决《由于安装了格式工厂导致的右键“快速访问”使整个资源管理器崩溃重启的问题》</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a510fce2f9acc98cd71902628c2e1646/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【ES】之集群详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>