<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Hive进阶函数：inline() 和 struct() ,一列转多行 - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Hive进阶函数：inline() 和 struct() ,一列转多行" />
<meta property="og:description" content="一、使用场景 如果存在一张表，记录的是每位学生的各科成绩，现在想把表转换为纵向存储
比如：
name｜english｜math｜history
tom ｜80 ｜90 ｜100
转换为：
name｜subject｜score
tom ｜english｜80
tom ｜math ｜90
tom ｜history ｜100
二、问题分析 可以把这个问题分为两部分
第一部分：将一行转为三行
第二部分：将每行数据的分数和科目填上
三、问题解决 方法一：space() 所以可以使用space把每行数据都炸裂为三行，然后根据name开窗排序，依次写入成绩和科目即可
with base as ( select &#39;tom&#39; as name, 80 as english, 90 as math, 100 as history union all select &#39;jery&#39; as name, 30 as english, 60 as math, 70 as history ) select name ,case when rn = 1 then &#39;english&#39; when rn = 2 then &#39;math&#39; when rn = 3 then &#39;history&#39; end as subject ,case when rn = 1 then english when rn = 2 then math when rn = 3 then history end as score from ( select name ,english ,math ,history ,row_number() over(partition by name) rn from base lateral view explode(split(space(2), &#39; &#39;)) tmp as s ) t 这样写纵然可以，但是很麻烦，消耗资源，并且不健壮，如果再来几个字段，是不是得一直添加下去，所以需要一个函数的出现" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2c9ff39bccb42e826d7205c9be8a21c2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-28T21:08:04+08:00" />
<meta property="article:modified_time" content="2023-11-28T21:08:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Hive进阶函数：inline() 和 struct() ,一列转多行</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_1"></a>一、使用场景</h4> 
<blockquote> 
 <p>如果存在一张表，记录的是每位学生的各科成绩，现在想把表转换为纵向存储</p> 
 <p>比如：</p> 
 <p>name｜english｜math｜history</p> 
 <p>tom ｜80 ｜90 ｜100</p> 
 <p>转换为：</p> 
 <p>name｜subject｜score</p> 
 <p>tom ｜english｜80</p> 
 <p>tom ｜math ｜90</p> 
 <p>tom ｜history ｜100</p> 
</blockquote> 
<h4><a id="_21"></a>二、问题分析</h4> 
<p>可以把这个问题分为两部分</p> 
<p>第一部分：将一行转为三行</p> 
<p>第二部分：将每行数据的分数和科目填上</p> 
<h4><a id="_29"></a>三、问题解决</h4> 
<h5><a id="space_31"></a>方法一：space()</h5> 
<p>所以可以使用space把每行数据都炸裂为三行，然后根据name开窗排序，依次写入成绩和科目即可</p> 
<pre><code class="prism language-sql"><span class="token keyword">with</span> base <span class="token keyword">as</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">'tom'</span> <span class="token keyword">as</span> name<span class="token punctuation">,</span> <span class="token number">80</span> <span class="token keyword">as</span> english<span class="token punctuation">,</span> <span class="token number">90</span> <span class="token keyword">as</span> math<span class="token punctuation">,</span> <span class="token number">100</span> <span class="token keyword">as</span> history
  <span class="token keyword">union</span> <span class="token keyword">all</span> 
  <span class="token keyword">select</span> <span class="token string">'jery'</span> <span class="token keyword">as</span> name<span class="token punctuation">,</span> <span class="token number">30</span> <span class="token keyword">as</span> english<span class="token punctuation">,</span> <span class="token number">60</span> <span class="token keyword">as</span> math<span class="token punctuation">,</span> <span class="token number">70</span> <span class="token keyword">as</span> history
<span class="token punctuation">)</span>
<span class="token keyword">select</span> 
  name 
  <span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> rn <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'english'</span>
    <span class="token keyword">when</span> rn <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">then</span> <span class="token string">'math'</span>
    <span class="token keyword">when</span> rn <span class="token operator">=</span> <span class="token number">3</span> <span class="token keyword">then</span> <span class="token string">'history'</span>
  <span class="token keyword">end</span> <span class="token keyword">as</span> subject 
  <span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> rn <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">then</span> english
    <span class="token keyword">when</span> rn <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">then</span> math 
    <span class="token keyword">when</span> rn <span class="token operator">=</span> <span class="token number">3</span> <span class="token keyword">then</span> history
  <span class="token keyword">end</span> <span class="token keyword">as</span> score
<span class="token keyword">from</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> 
    name
    <span class="token punctuation">,</span>english
    <span class="token punctuation">,</span>math 
    <span class="token punctuation">,</span>history
    <span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> name<span class="token punctuation">)</span> rn 
  <span class="token keyword">from</span> base 
  lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>space<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> s 
<span class="token punctuation">)</span> t 
</code></pre> 
<p>这样写纵然可以，但是很麻烦，消耗资源，并且不健壮，如果再来几个字段，是不是得一直添加下去，所以需要一个函数的出现</p> 
<h5><a id="stack_65"></a>方法二：stack()</h5> 
<p><strong>引入函数</strong></p> 
<p>stack函数：可以将多个列的值转为多行，并且搭配lateral view使用时，还可以充当虚拟表</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> stack<span class="token punctuation">(</span>n<span class="token punctuation">,</span> val1<span class="token punctuation">,</span> val2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> valn<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">(</span>col1<span class="token punctuation">,</span> col2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> coln<span class="token punctuation">)</span> <span class="token keyword">FROM</span> tbl
</code></pre> 
<p>和lateral view搭配使用时</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> stacked_col
<span class="token keyword">FROM</span> tbl
LATERAL <span class="token keyword">VIEW</span> stack<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span> stacked_table <span class="token keyword">AS</span> stacked_col<span class="token punctuation">;</span>
</code></pre> 
<p><em><strong>stack函数传入的参数可以分为两部分</strong></em></p> 
<p><em><strong>第一部分</strong></em>：需要列转行的个数，比如2，就是需要把两个列的值转为行显示</p> 
<p><em><strong>第二部分</strong></em>：需要转的列</p> 
<p>最开始提出的问题，将分数按照科目和分数的形式展示，会存在一个问题，列转为行后，对应的科目应该怎么办？怎么知道每个分数的科目是什么呢？所以在这里需要做一点小小的转换，在传入列值的时候，把科目和分数组合传入</p> 
<pre><code class="prism language-sql"><span class="token keyword">with</span> base <span class="token keyword">as</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">'tom'</span> <span class="token keyword">as</span> name<span class="token punctuation">,</span> <span class="token number">80</span> <span class="token keyword">as</span> english<span class="token punctuation">,</span> <span class="token number">90</span> <span class="token keyword">as</span> math<span class="token punctuation">,</span> <span class="token number">100</span> <span class="token keyword">as</span> history
  <span class="token keyword">union</span> <span class="token keyword">all</span> 
  <span class="token keyword">select</span> <span class="token string">'jery'</span> <span class="token keyword">as</span> name<span class="token punctuation">,</span> <span class="token number">30</span> <span class="token keyword">as</span> english<span class="token punctuation">,</span> <span class="token number">60</span> <span class="token keyword">as</span> math<span class="token punctuation">,</span> <span class="token number">70</span> <span class="token keyword">as</span> history
<span class="token punctuation">)</span>

<span class="token keyword">select</span> 
  name
  <span class="token punctuation">,</span>split<span class="token punctuation">(</span>score<span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> subject
  <span class="token punctuation">,</span>split<span class="token punctuation">(</span>score<span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">as</span> score
<span class="token keyword">from</span> base 
lateral <span class="token keyword">view</span> stack<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> concat<span class="token punctuation">(</span><span class="token string">'english,'</span><span class="token punctuation">,</span>english<span class="token punctuation">)</span><span class="token punctuation">,</span> concat<span class="token punctuation">(</span><span class="token string">'math,'</span><span class="token punctuation">,</span>math<span class="token punctuation">)</span><span class="token punctuation">,</span> concat<span class="token punctuation">(</span><span class="token string">'history,'</span><span class="token punctuation">,</span>history<span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> score
</code></pre> 
<p>这样即可，是不是比之前的方法简单了很多，而且更加的简洁</p> 
<h5><a id="inline_108"></a>方法三：inline()</h5> 
<p>上面的方法虽然简单，但是需要把科目和分数拼接起来，然后在外面切割开使用，所以有没有另一种方法，不需要这样处理，直接使用原字段</p> 
<p>引入函数</p> 
<p>inline()：inline函数用于将数组类型的列转换为多行。它会将数组中的每个元素与原始行的其他列一起展开为多行数据。</p> 
<p>举例</p> 
<pre><code class="prism language-sql"><span class="token keyword">with</span> base <span class="token keyword">as</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">'tom'</span> <span class="token keyword">as</span> name<span class="token punctuation">,</span> array<span class="token punctuation">(</span>struct<span class="token punctuation">(</span><span class="token string">'history'</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>struct<span class="token punctuation">(</span><span class="token string">'english'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>struct<span class="token punctuation">(</span><span class="token string">'history'</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> scores
<span class="token punctuation">)</span>

<span class="token keyword">select</span> name<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> score <span class="token keyword">from</span> base 
lateral <span class="token keyword">view</span> inline<span class="token punctuation">(</span>scores<span class="token punctuation">)</span> <span class="token keyword">as</span> subject<span class="token punctuation">,</span>score
</code></pre> 
<p>这个例子就可以把列炸成三行，包括name、subject、score三个字段</p> 
<p>注意，inline函数的输入参数要求为array(struct&lt;&gt;)类型，所以要保证类型匹配，否则会报错</p> 
<pre><code class="prism language-sql">cannot resolve <span class="token string">'inline(base.`scores`)'</span> due <span class="token keyword">to</span> <span class="token keyword">data</span> <span class="token keyword">type</span> mismatch: input <span class="token keyword">to</span> <span class="token keyword">function</span> inline should be array <span class="token keyword">of</span> struct <span class="token keyword">type</span><span class="token punctuation">,</span> <span class="token operator">not</span> array<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span>
</code></pre> 
<p>所以最初的问题又可以使用inline解决</p> 
<pre><code class="prism language-sql"><span class="token keyword">with</span> base <span class="token keyword">as</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">'tom'</span> <span class="token keyword">as</span> name<span class="token punctuation">,</span> <span class="token number">80</span> <span class="token keyword">as</span> english<span class="token punctuation">,</span> <span class="token number">90</span> <span class="token keyword">as</span> math<span class="token punctuation">,</span> <span class="token number">100</span> <span class="token keyword">as</span> history
  <span class="token keyword">union</span> <span class="token keyword">all</span> 
  <span class="token keyword">select</span> <span class="token string">'jery'</span> <span class="token keyword">as</span> name<span class="token punctuation">,</span> <span class="token number">30</span> <span class="token keyword">as</span> english<span class="token punctuation">,</span> <span class="token number">60</span> <span class="token keyword">as</span> math<span class="token punctuation">,</span> <span class="token number">70</span> <span class="token keyword">as</span> history
<span class="token punctuation">)</span>

<span class="token keyword">select</span> 
  name 
  <span class="token punctuation">,</span>subject
  <span class="token punctuation">,</span>score
<span class="token keyword">from</span> base 
lateral <span class="token keyword">view</span> inline<span class="token punctuation">(</span>array<span class="token punctuation">(</span>
  struct<span class="token punctuation">(</span><span class="token string">'english'</span><span class="token punctuation">,</span> english<span class="token punctuation">)</span><span class="token punctuation">,</span>
  struct<span class="token punctuation">(</span><span class="token string">'math'</span><span class="token punctuation">,</span> math<span class="token punctuation">)</span><span class="token punctuation">,</span>
  struct<span class="token punctuation">(</span><span class="token string">'history'</span><span class="token punctuation">,</span> history<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span> tmp <span class="token keyword">as</span> subject<span class="token punctuation">,</span> score
</code></pre> 
<p>结果</p> 
<pre><code class="prism language-sql">name    subject    score
tom     english    <span class="token number">80</span>
tom     math       <span class="token number">90</span>
tom     history    <span class="token number">100</span>
jery    english    <span class="token number">30</span>
jery    math       <span class="token number">60</span>
jery    history    <span class="token number">70</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/06e27bcf2bd1f2dec4290f4b46cb50a7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Hive进阶函数：SPACE() 一行炸裂指定行</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a23fa59d1dd7c4b63e57e69c9a7d169e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">大模型训练为什么用A100不用4090</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>