<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MXNET深度学习框架-29-语义分割(FCN) - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MXNET深度学习框架-29-语义分割(FCN)" />
<meta property="og:description" content="语义分割计算机视觉领域中的一个重要模块，它与之前的图像分类、目标检测任务不同，它是一个精细到每个像素块的一个图像任务，当然，它包括分类和定位。更多关于语义分割的方法和原理请读者自行搜索相关论文和博文，本文不做过多阐述。
1、数据集
在计算机视觉领域，Pascal VOC 2012 数据集是比较经典的，该数据集包含了目标检测、对象分割的数据及相关标签，本文使用的语义分割数据集就是来自于VOC2012。首先，需要下载该数据集：官网下载链接，注意，该数据集大概有2个G的大小，建议提前下载。
2、读取数据集
写一段程序来读取并显示一下相关数据图片及其标签：
def show_images(imgs, num_rows, num_cols, scale=2): &#34;&#34;&#34;Plot a list of images.&#34;&#34;&#34; figsize = (num_cols * scale, num_rows * scale) _, axes = plt.subplots(num_rows, num_cols, figsize=figsize) for i in range(num_rows): for j in range(num_cols): axes[i][j].imshow(imgs[i * num_cols &#43; j].asnumpy()) axes[i][j].axes.get_xaxis().set_visible(False) axes[i][j].axes.get_yaxis().set_visible(False) plt.show() root=&#39;F:/test/VOC2012_dataset/VOCtrainval_11-May-2012/VOCdevkit/VOC2012&#39; # 1、将训练图片和标注图标读进内存 def read_images(root,train=True): if train: txt_fname=root&#43;&#34;/ImageSets/Segmentation/train.txt&#34; else: txt_fname = root &#43; &#34;/ImageSets/Segmentation/val.txt&#34; with open(txt_fname,&#39;r&#39;) as f: images=f.read().split() features, labels = [None] * len(images), [None] * len(images) for i, fname in enumerate(images): features[i] = image_deal." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/ec44389ce12dce6221c688f910ca1827/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-23T14:48:23+08:00" />
<meta property="article:modified_time" content="2020-05-23T14:48:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MXNET深度学习框架-29-语义分割(FCN)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>          语义分割计算机视觉领域中的一个重要模块，它与之前的图像分类、目标检测任务不同，它是一个精细到每个像素块的一个图像任务，当然，它包括分类和定位。更多关于语义分割的方法和原理请读者自行搜索相关论文和博文，本文不做过多阐述。<br> <img src="https://images2.imgbox.com/c0/bd/GeFhHDDC_o.png" alt="在这里插入图片描述"><br> <strong>1、数据集</strong><br>           在计算机视觉领域，Pascal VOC 2012 数据集是比较经典的，该数据集包含了目标检测、对象分割的数据及相关标签，本文使用的语义分割数据集就是来自于VOC2012。首先，需要下载该数据集：<a href="http://117.128.6.36/cache/host.robots.ox.ac.uk/pascal/VOC/voc2012/VOCtrainval_11-May-2012.tar?ich_args2=471-22094721016000_92029705a99338d0932803388148a725_10001002_9c896d2cd6c2f3d19133518939a83798_b790798e38e961357cf0daba74a0ff90" rel="nofollow">官网下载链接</a>，注意，该数据集大概有2个G的大小，建议提前下载。<br> <img src="https://images2.imgbox.com/1f/00/CnhHGBtu_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/92/ea/6fPcm2Lq_o.png" alt="在这里插入图片描述"></p> 
<p><strong>2、读取数据集</strong><br> 写一段程序来读取并显示一下相关数据图片及其标签：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">show_images</span><span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> num_rows<span class="token punctuation">,</span> num_cols<span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Plot a list of images."""</span>
    figsize <span class="token operator">=</span> <span class="token punctuation">(</span>num_cols <span class="token operator">*</span> scale<span class="token punctuation">,</span> num_rows <span class="token operator">*</span> scale<span class="token punctuation">)</span>
    _<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>num_rows<span class="token punctuation">,</span> num_cols<span class="token punctuation">,</span> figsize<span class="token operator">=</span>figsize<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_rows<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_cols<span class="token punctuation">)</span><span class="token punctuation">:</span>
            axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgs<span class="token punctuation">[</span>i <span class="token operator">*</span> num_cols <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>axes<span class="token punctuation">.</span>get_xaxis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_visible<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>axes<span class="token punctuation">.</span>get_yaxis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_visible<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>


root<span class="token operator">=</span><span class="token string">'F:/test/VOC2012_dataset/VOCtrainval_11-May-2012/VOCdevkit/VOC2012'</span>
<span class="token comment"># 1、将训练图片和标注图标读进内存</span>
<span class="token keyword">def</span> <span class="token function">read_images</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span>train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> train<span class="token punctuation">:</span>
        txt_fname<span class="token operator">=</span>root<span class="token operator">+</span><span class="token string">"/ImageSets/Segmentation/train.txt"</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        txt_fname <span class="token operator">=</span> root <span class="token operator">+</span> <span class="token string">"/ImageSets/Segmentation/val.txt"</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txt_fname<span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        images<span class="token operator">=</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>

    features<span class="token punctuation">,</span> labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i<span class="token punctuation">,</span> fname <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">:</span>
        features<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> image_deal<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'%s/JPEGImages/%s.jpg'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>root<span class="token punctuation">,</span> fname<span class="token punctuation">)</span><span class="token punctuation">)</span>
        labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> image_deal<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>
            <span class="token string">'%s/SegmentationClass/%s.png'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>root<span class="token punctuation">,</span> fname<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> features<span class="token punctuation">,</span> labels

n<span class="token operator">=</span><span class="token number">5</span> <span class="token comment">#显示前5张图片</span>
train_features<span class="token punctuation">,</span>train_labels<span class="token operator">=</span>read_images<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
show_images<span class="token punctuation">(</span>train_features<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span> <span class="token operator">+</span> train_labels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> im <span class="token keyword">in</span> train_features<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>im<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre> 
<p>显示结果：<br> <img src="https://images2.imgbox.com/c2/81/yWATzkxA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a4/e1/JhtFFkuA_o.png" alt="在这里插入图片描述"><br>           我们可以看到，每个图片均对应一个分割的图像，这个分割的图像就是标签(实际上是对一张图片的所以像素块分别赋予了一个label)。在打印的图像大小信息中我们也可以看到，每张图片的大小可能并不是一样的，在CNN训练中，为了批量训练，我们都会把它resize成同样的大小，但是这里不行，为什么？因为它是对每个pixel做了标签，如果resize(比如插值resize)之后，这样会出来一个新的pixel，那么新出来的pixel可能是介于两边的中间值，这就导致标签信息无法匹配上，结果不准。<br> <strong>2、裁剪</strong><br>           无法resize，那怎么办？我们可以注意到，每张图片的宽度好像都是500，为了能批量训练，我们可以使用剪切的方法来使得它们成为一样的大小。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">rand_crop</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> label<span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data<span class="token punctuation">,</span> rect <span class="token operator">=</span> image_deal<span class="token punctuation">.</span>random_crop<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span>
    label <span class="token operator">=</span> image_deal<span class="token punctuation">.</span>fixed_crop<span class="token punctuation">(</span>label<span class="token punctuation">,</span> <span class="token operator">*</span>rect<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data<span class="token punctuation">,</span> label
imgs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    imgs <span class="token operator">+=</span> rand_crop<span class="token punctuation">(</span>train_features<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> train_labels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>
show_images<span class="token punctuation">(</span>imgs<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/62/00/zJiZZQk9_o.png" alt="在这里插入图片描述"><br> <strong>3、每个物体和背景对应的RGB值(官方网站给的)</strong></p> 
<pre><code class="prism language-python">colormap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
colorclass <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'background'</span><span class="token punctuation">,</span> <span class="token string">'aeroplane'</span><span class="token punctuation">,</span> <span class="token string">'bicycle'</span><span class="token punctuation">,</span> <span class="token string">'bird'</span><span class="token punctuation">,</span> <span class="token string">'boat'</span><span class="token punctuation">,</span>
            <span class="token string">'bottle'</span><span class="token punctuation">,</span> <span class="token string">'bus'</span><span class="token punctuation">,</span> <span class="token string">'car'</span><span class="token punctuation">,</span> <span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token string">'chair'</span><span class="token punctuation">,</span> <span class="token string">'cow'</span><span class="token punctuation">,</span>
            <span class="token string">'diningtable'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">,</span> <span class="token string">'horse'</span><span class="token punctuation">,</span> <span class="token string">'motorbike'</span><span class="token punctuation">,</span> <span class="token string">'person'</span><span class="token punctuation">,</span>
            <span class="token string">'potted plant'</span><span class="token punctuation">,</span> <span class="token string">'sheep'</span><span class="token punctuation">,</span> <span class="token string">'sofa'</span><span class="token punctuation">,</span> <span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'tv/monitor'</span><span class="token punctuation">]</span>
</code></pre> 
<p><strong>4、查找pixel中每个类别的像素索引</strong></p> 
<pre><code class="prism language-python">colormap2label <span class="token operator">=</span> nd<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">**</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> color_map <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>colormap<span class="token punctuation">)</span><span class="token punctuation">:</span>
    colormap2label<span class="token punctuation">[</span><span class="token punctuation">(</span>color_map<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> color_map<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> color_map<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> i


<span class="token keyword">def</span> <span class="token function">label_indices</span><span class="token punctuation">(</span>colormap<span class="token punctuation">)</span><span class="token punctuation">:</span>
    colormap <span class="token operator">=</span> colormap<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int32'</span><span class="token punctuation">)</span>
    idx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>colormap<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> colormap<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">256</span>
           <span class="token operator">+</span> colormap<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> colormap2label<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>


y <span class="token operator">=</span> label_indices<span class="token punctuation">(</span>train_labels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">[</span><span class="token number">105</span><span class="token punctuation">:</span><span class="token number">115</span><span class="token punctuation">,</span> <span class="token number">130</span><span class="token punctuation">:</span><span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果：<br>           可以看到是飞机的那块地方均被标记成了1，而背景则被标记成了0。为什么飞机是1？因为飞机排在第2个，那么索引就是1：<img src="https://images2.imgbox.com/b3/41/CrXltwkM_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0c/34/e5ljYcLG_o.png" alt="在这里插入图片描述"><br> <strong>5、图像预处理</strong></p> 
<pre><code class="prism language-python">rgb_mean<span class="token operator">=</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span><span class="token number">0.456</span><span class="token punctuation">,</span><span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#官方给的</span>
rgb_std<span class="token operator">=</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span><span class="token number">0.224</span><span class="token punctuation">,</span><span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">normlize</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">"float32"</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token operator">-</span>rgb_mean<span class="token punctuation">)</span><span class="token operator">/</span>rgb_std
</code></pre> 
<p><strong>6、自定义语义分割数据集类</strong><br>           在mxnet中，可以通过继承Gluon提供的Dataset类自定义了语义分割数据集类VOCSegDataset。通过实现__getitem__函数，可以任意访问数据集中索引为idx的输入图像及其每个像素的类别索引。由于数据集中有些图像的尺寸可能小于随机裁剪所指定的输出尺寸，这些样本需要通过自定义的filter函数所移除。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">VOCSegDataset</span><span class="token punctuation">(</span>gn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> is_train<span class="token punctuation">,</span> crop_size<span class="token punctuation">,</span> voc_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>

        self<span class="token punctuation">.</span>crop_size <span class="token operator">=</span> crop_size
        data<span class="token punctuation">,</span> labels <span class="token operator">=</span> read_images<span class="token punctuation">(</span>root<span class="token operator">=</span>voc_dir<span class="token punctuation">,</span> train<span class="token operator">=</span>is_train<span class="token punctuation">)</span>
        data<span class="token operator">=</span>self<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">[</span>normlize<span class="token punctuation">(</span>im<span class="token punctuation">)</span> <span class="token keyword">for</span> im <span class="token keyword">in</span> data<span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>labels <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'read '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' examples'</span><span class="token punctuation">)</span>

  <span class="token comment">#只保留大于裁剪尺寸的图片</span>
    <span class="token keyword">def</span> <span class="token function">filter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>img <span class="token keyword">for</span> img <span class="token keyword">in</span> images <span class="token keyword">if</span> <span class="token punctuation">(</span>
            img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>crop_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">and</span>
            img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>crop_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token comment"># 每读一张图片，就把它裁剪，并把label的图片转成标签</span>
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data<span class="token punctuation">,</span> label <span class="token operator">=</span> rand_crop<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>labels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                       <span class="token operator">*</span>self<span class="token punctuation">.</span>crop_size<span class="token punctuation">)</span>
        data<span class="token operator">=</span>data<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        label<span class="token operator">=</span>label_indices<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        <span class="token keyword">return</span> data<span class="token punctuation">,</span>label

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
</code></pre> 
<p>看看这样处理之后有多少张图片，这里设裁剪的图片为(h,w)=(320,480)：</p> 
<pre><code class="prism language-python">input_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">320</span><span class="token punctuation">,</span><span class="token number">480</span><span class="token punctuation">)</span>
voc_train<span class="token operator">=</span>VOCSegDataset<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span>input_size<span class="token punctuation">,</span>root<span class="token punctuation">)</span>
voc_test<span class="token operator">=</span>VOCSegDataset<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span>input_size<span class="token punctuation">,</span>root<span class="token punctuation">)</span>
</code></pre> 
<p>结果：<img src="https://images2.imgbox.com/e1/7b/GgYVfLxj_o.png" alt="在这里插入图片描述"><br>           可以看到，训练集有1114张，测试集有1078张，对于这样的样本集，使用深度学习方法从头训练显然是不可能的，到了这里，就要提前想好后面要用到什么方法了——<strong>微调(Fine Tuning)</strong></p> 
<p><strong>7、定义批量读取</strong></p> 
<pre><code class="prism language-python">batch_size<span class="token operator">=</span><span class="token number">5</span> 
train_data<span class="token operator">=</span>gn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>voc_train<span class="token punctuation">,</span>batch_size<span class="token punctuation">,</span>shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test_data<span class="token operator">=</span>gn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>voc_test<span class="token punctuation">,</span>batch_size<span class="token punctuation">,</span>shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token comment"># 查看一下数据维度</span>
<span class="token keyword">for</span> data<span class="token punctuation">,</span>label <span class="token keyword">in</span> train_data<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>shape<span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">,</span>label<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    <span class="token keyword">break</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/77/a6/cye5nI2J_o.png" alt="在这里插入图片描述"><br> 可以看到，图片的维度与我们常见的一样，满足NCHW的要求，而标签则变成了3维的形状。</p> 
<h3><a id="Fully_Convolutional_NetworksFCN_166"></a>全卷积神经网络(Fully Convolutional Networks,FCN)</h3> 
<p>          从上面标签是3维的我们可以知道，分割的任务与分类、检测的任务完全不一样，预测的标号不再是一个数字，而是每个pixel。那么在预测的时候，输出的结果也应该是一个3维的结果，因为要与输入的标签一一对应，但是，我们知道，CNN都是把一个3维的数据变成一个一维的标量，这显然与分割预测的结果不同，对于这种情况，转置卷积（transposed convolution）出现了，全卷积网络通过转置卷积层将中间层特征图的高和宽变换回输入图像的尺寸，从而令预测结果与输入图像在空间维（高和宽）上一一对应：给定空间维上的位置，通道维的输出即该位置对应像素的类别预测。（<strong>FCN就是在Forward时把维度变小，在Backward时把维度变大，卷积本身就是一个对偶函数，卷积的导数的导数还是卷积自己）</strong></p> 
<p>          举个例子:一个(3,320,480)的图片，通过步长为2，padding为1的卷积之后，它的形状变成(3,160,240)，那么，通过转置卷积之后，它的形状变成(3,320,480)，这样就进行了还原。</p> 
<p><strong>1、转置卷积</strong><br>           gluon中已经实现了转置卷积的函数：</p> 
<pre><code class="prism language-python"><span class="token comment"># 除了替换输出的通道数以外，其余的参数都不变，可以将输出还原为输入的大小</span>
conv<span class="token operator">=</span>gn<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>channels<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
conv_trans<span class="token operator">=</span>gn<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2DTranspose<span class="token punctuation">(</span>channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#图片最开始输入通道数为3</span>
conv<span class="token punctuation">.</span>initialize<span class="token punctuation">(</span><span class="token punctuation">)</span>
conv_trans<span class="token punctuation">.</span>initialize<span class="token punctuation">(</span><span class="token punctuation">)</span>
x<span class="token operator">=</span>nd<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">,</span>conv_trans<span class="token punctuation">(</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/22/96/g3ZQEDEz_o.png" alt="在这里插入图片描述"><br>           可以看到，我们定义了输入是(1,3,16,16)，通过卷积层之后，大小变成了(1,10,8,8)，再将结果通过转置卷积之后，结果变成了(1,3,16,16)，与输入的维度一样。</p> 
<p>          另外需要注意的是，在最后的卷积层我们同样使用Flatten或GAP来使得数据偏平化，使其能输入到FC中，而这样操作会损害空间信息，这对语义分割非常重要，其中一个解决办法是去掉不需要的池化层，并利用1X1的卷积层来替代FC。所以给定一个FCN，它需要做以下工作：<br>                               1）利用1X1的卷积替代FC；<br>                               2）去掉损失空间信息的池化层；<br>                               3）最后接上卷积转置层来得到需要输出的大小；<br>                               4）为了训练更快，可使用微调的办法（数据量大可以忽略这一条）。</p> 
<p><strong>2、下载预训练模型(ResNet18，可自行选择预训练模型)</strong></p> 
<pre><code class="prism language-python">pretrained_model<span class="token operator">=</span>models<span class="token punctuation">.</span>resnet18_v2<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>pretrained_model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>pretrained_model<span class="token punctuation">.</span>output<span class="token punctuation">)</span> <span class="token comment">#打印看看最后几层</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/96/23/QliMY8I5_o.png" alt="在这里插入图片描述"><br> 从上图的结果来看，我们是不需要GAP和FC的，所以要把它替换掉。</p> 
<p><strong>3、添加训练好的权重信息，并修改GAP和FC</strong></p> 
<pre><code class="prism language-python">net<span class="token operator">=</span>gn<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> layer <span class="token keyword">in</span> pretrained_model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    net<span class="token punctuation">.</span>add<span class="token punctuation">(</span>layer<span class="token punctuation">)</span>
m<span class="token operator">=</span>nd<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">320</span><span class="token punctuation">,</span><span class="token number">480</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"input shape:"</span><span class="token punctuation">,</span>m<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"out shape:"</span><span class="token punctuation">,</span>net<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

<span class="token comment"># 添加1X1卷积和转置卷积</span>
num_class<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>colorclass<span class="token punctuation">)</span><span class="token comment"># 几个类别</span>
<span class="token keyword">with</span> net<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    net<span class="token punctuation">.</span>add<span class="token punctuation">(</span>gn<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>num_class<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            gn<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2DTranspose<span class="token punctuation">(</span>num_class<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># kernel_size最好大于32，padding=(kernel_size-strides)/2</span>

</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/75/66/rWgfpcLt_o.png" alt="在这里插入图片描述"><br>           可以看到，一张(3,320,480)通过预训练模型之后，输出的维度是(512,10,15)，其中，宽高均缩小了32倍，为什么要明确到32倍？因为最后转置卷积还原的时候会用到这个系数。</p> 
<p><strong>4、训练</strong><br>           因为上面我们把转置卷积的核大小设成了64，所以很难训练，而转置卷积我们可以把它看成是插值的操作，在实际操作中发现，把转置卷积初始化从双线性插值函数可以使得训练更加容易。</p> 
<pre><code class="prism language-python"><span class="token comment"># 双线性插值</span>
<span class="token keyword">def</span> <span class="token function">bilinear_kernel</span><span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    factor <span class="token operator">=</span> <span class="token punctuation">(</span>kernel_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>
    <span class="token keyword">if</span> kernel_size <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        center <span class="token operator">=</span> factor <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        center <span class="token operator">=</span> factor <span class="token operator">-</span> <span class="token number">0.5</span>
    og <span class="token operator">=</span> np<span class="token punctuation">.</span>ogrid<span class="token punctuation">[</span><span class="token punctuation">:</span>kernel_size<span class="token punctuation">,</span> <span class="token punctuation">:</span>kernel_size<span class="token punctuation">]</span>
    filt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>og<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> center<span class="token punctuation">)</span> <span class="token operator">/</span> factor<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>og<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> center<span class="token punctuation">)</span> <span class="token operator">/</span> factor<span class="token punctuation">)</span>
    weight <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> kernel_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
                      dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
    weight<span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span>in_channels<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> filt
    <span class="token keyword">return</span> nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>weight<span class="token punctuation">)</span>

<span class="token comment"># 初始化</span>
net<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>initialize<span class="token punctuation">(</span>init<span class="token operator">=</span>init<span class="token punctuation">.</span>Xavier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 1X1 conv</span>
net<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>initialize<span class="token punctuation">(</span>init<span class="token punctuation">.</span>Constant<span class="token punctuation">(</span>bilinear_kernel<span class="token punctuation">(</span>in_channels<span class="token operator">=</span>num_class<span class="token punctuation">,</span>out_channels<span class="token operator">=</span>num_class<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ctx<span class="token operator">=</span>ctx<span class="token punctuation">)</span>

</code></pre> 
<p>之前做分类的时候，使用了<code>gn.loss.SoftmaxCrossEntropyLoss()</code>这个函数，它默认会把结果Flatten化，所以，这里要加入axis=1的命令，其它的训练都是一样的。</p> 
<pre><code class="prism language-python">cross_loss<span class="token operator">=</span>gn<span class="token punctuation">.</span>loss<span class="token punctuation">.</span>SoftmaxCrossEntropyLoss<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

net<span class="token punctuation">.</span>collect_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_ctx<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
trainer<span class="token operator">=</span>gn<span class="token punctuation">.</span>Trainer<span class="token punctuation">(</span>net<span class="token punctuation">.</span>collect_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'sgd'</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token string">"learning_rate"</span><span class="token punctuation">:</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token string">"wd"</span><span class="token punctuation">:</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># 定义准确率</span>
<span class="token keyword">def</span> <span class="token function">accuracy</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> nd<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>output<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span>label<span class="token punctuation">)</span><span class="token punctuation">.</span>asscalar<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">evaluate_accuracy</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">,</span> net<span class="token punctuation">,</span>ctx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    acc_sum<span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token keyword">for</span> features<span class="token punctuation">,</span>label <span class="token keyword">in</span> data_iter<span class="token punctuation">:</span>
        features <span class="token operator">=</span> features<span class="token punctuation">.</span>as_in_context<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        label <span class="token operator">=</span> label<span class="token punctuation">.</span>as_in_context<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        output<span class="token operator">=</span>net<span class="token punctuation">(</span>features<span class="token punctuation">)</span>
        acc_sum<span class="token operator">+=</span>accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span>label<span class="token punctuation">)</span>
        n <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> acc_sum<span class="token operator">/</span> n

<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>train_iter<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> net<span class="token punctuation">,</span> cross_loss<span class="token punctuation">,</span> trainer<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'training on'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        train_l_sum<span class="token punctuation">,</span> train_acc_sum<span class="token punctuation">,</span> n<span class="token punctuation">,</span>start <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> Xs<span class="token punctuation">,</span> ys <span class="token keyword">in</span> train_iter<span class="token punctuation">:</span>
            Xs<span class="token operator">=</span>Xs<span class="token punctuation">.</span>as_in_context<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            ys<span class="token operator">=</span>ys<span class="token punctuation">.</span>as_in_context<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            <span class="token keyword">with</span> ag<span class="token punctuation">.</span>record<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                output <span class="token operator">=</span> net<span class="token punctuation">(</span>Xs<span class="token punctuation">)</span>
                loss <span class="token operator">=</span> nd<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>cross_loss<span class="token punctuation">(</span>output<span class="token punctuation">,</span> ys<span class="token punctuation">)</span><span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            trainer<span class="token punctuation">.</span>step<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>
            train_l_sum <span class="token operator">+=</span> loss<span class="token punctuation">.</span>asscalar<span class="token punctuation">(</span><span class="token punctuation">)</span>
            train_acc_sum<span class="token operator">+=</span>accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span>ys<span class="token punctuation">)</span>
            n <span class="token operator">+=</span> <span class="token number">1</span>
        test_acc <span class="token operator">=</span> evaluate_accuracy<span class="token punctuation">(</span>test_iter<span class="token punctuation">,</span> net<span class="token punctuation">,</span>ctx<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'epoch %d, loss %.4f, train acc %.3f, test acc %.3f '</span><span class="token string">'time %.1f sec'</span>
              <span class="token operator">%</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> train_l_sum <span class="token operator">/</span> n<span class="token punctuation">,</span> train_acc_sum <span class="token operator">/</span> n<span class="token punctuation">,</span>test_acc<span class="token punctuation">,</span>
                 time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span>
train<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span>test_data<span class="token punctuation">,</span>net<span class="token punctuation">,</span>cross_loss<span class="token punctuation">,</span>trainer<span class="token punctuation">,</span>ctx<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre> 
<p>训练结果：<br> <img src="https://images2.imgbox.com/29/53/wvMeLhNh_o.png" alt="在这里插入图片描述"><br> 训练完了别忘了保存一下模型，好不容易训练的别让它丢了：</p> 
<pre><code class="prism language-python">net<span class="token punctuation">.</span>save_parameters<span class="token punctuation">(</span><span class="token string">"FCN.params"</span><span class="token punctuation">)</span><span class="token comment"># 保存模型</span>
</code></pre> 
<p><strong>5、预测</strong><br> 预测的时候与图像分类类似，主要的区别在于我们需要在axis=1上做argmax，同时我们定义img2label的反函数，它将预测值转成图片。</p> 
<pre><code class="prism language-python">net<span class="token punctuation">.</span>load_parameters<span class="token punctuation">(</span><span class="token string">"FCN.params"</span><span class="token punctuation">)</span> <span class="token comment">#读取参数</span>
<span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data<span class="token operator">=</span>normlize<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    data<span class="token operator">=</span>data<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    y_hat<span class="token operator">=</span>net<span class="token punctuation">(</span>data<span class="token punctuation">.</span>as_in_context<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    pred<span class="token operator">=</span>nd<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pred<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>pred<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>pred<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">label2img</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span>colormap<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cm <span class="token operator">=</span> nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>colormap<span class="token punctuation">,</span> ctx<span class="token operator">=</span>ctx<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'uint8'</span><span class="token punctuation">)</span>
    X <span class="token operator">=</span> pred<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int32'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cm<span class="token punctuation">[</span>X<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>

<span class="token comment"># 读取测试集前几张图片做预测</span>
test_image<span class="token punctuation">,</span>test_label<span class="token operator">=</span>read_images<span class="token punctuation">(</span>root<span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">)</span>

image_6<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    x<span class="token operator">=</span>test_image<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    pred<span class="token operator">=</span>label2img<span class="token punctuation">(</span>predict<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>colormap<span class="token punctuation">)</span>
    image_6<span class="token operator">+=</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span>pred<span class="token punctuation">,</span>test_label<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
show_images<span class="token punctuation">(</span>image_6<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/83/07/VlAovME5_o.png" alt="在这里插入图片描述"><br> 上图中，中间的是预测结果，最右边的是真实结果，预测结果离真实结果还有一段距离，可以多加几个epoch跑跑看。</p> 
<p>下面附上所有源码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> mxnet<span class="token punctuation">.</span>ndarray <span class="token keyword">as</span> nd
<span class="token keyword">import</span> mxnet<span class="token punctuation">.</span>gluon <span class="token keyword">as</span> gn
<span class="token keyword">import</span> mxnet<span class="token punctuation">.</span>autograd <span class="token keyword">as</span> ag
<span class="token keyword">import</span> mxnet<span class="token punctuation">.</span>initializer <span class="token keyword">as</span> init
<span class="token keyword">import</span> mxnet<span class="token punctuation">.</span>image <span class="token keyword">as</span> image_deal
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> mxnet<span class="token punctuation">.</span>gluon<span class="token punctuation">.</span>model_zoo <span class="token keyword">import</span> vision <span class="token keyword">as</span> models
<span class="token keyword">import</span> time
<span class="token keyword">import</span> mxnet <span class="token keyword">as</span> mx

<span class="token comment"># 显示图片</span>
<span class="token keyword">def</span> <span class="token function">show_images</span><span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> num_rows<span class="token punctuation">,</span> num_cols<span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Plot a list of images."""</span>
    figsize <span class="token operator">=</span> <span class="token punctuation">(</span>num_cols <span class="token operator">*</span> scale<span class="token punctuation">,</span> num_rows <span class="token operator">*</span> scale<span class="token punctuation">)</span>
    _<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>num_rows<span class="token punctuation">,</span> num_cols<span class="token punctuation">,</span> figsize<span class="token operator">=</span>figsize<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_rows<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_cols<span class="token punctuation">)</span><span class="token punctuation">:</span>
            axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>imgs<span class="token punctuation">[</span>i <span class="token operator">*</span> num_cols <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>axes<span class="token punctuation">.</span>get_xaxis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_visible<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>axes<span class="token punctuation">.</span>get_yaxis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_visible<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>


root <span class="token operator">=</span> <span class="token string">'F:/test/VOC2012_dataset/VOCtrainval_11-May-2012/VOCdevkit/VOC2012'</span>


<span class="token comment"># 1、将训练图片和标注图标读进内存</span>
<span class="token keyword">def</span> <span class="token function">read_images</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> train<span class="token punctuation">:</span>
        txt_fname <span class="token operator">=</span> root <span class="token operator">+</span> <span class="token string">"/ImageSets/Segmentation/train.txt"</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        txt_fname <span class="token operator">=</span> root <span class="token operator">+</span> <span class="token string">"/ImageSets/Segmentation/val.txt"</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txt_fname<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        images <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>

    features<span class="token punctuation">,</span> labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i<span class="token punctuation">,</span> fname <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">:</span>
        features<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> image_deal<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'%s/JPEGImages/%s.jpg'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>root<span class="token punctuation">,</span> fname<span class="token punctuation">)</span><span class="token punctuation">)</span>
        labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> image_deal<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>
            <span class="token string">'%s/SegmentationClass/%s.png'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>root<span class="token punctuation">,</span> fname<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> features<span class="token punctuation">,</span> labels


n <span class="token operator">=</span> <span class="token number">5</span>  <span class="token comment"># 显示前5张图片</span>
train_features<span class="token punctuation">,</span> train_labels <span class="token operator">=</span> read_images<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
show_images<span class="token punctuation">(</span>train_features<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span> <span class="token operator">+</span> train_labels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment"># for im in train_features:</span>
<span class="token comment">#     print(im.shape)</span>


<span class="token comment"># 2、裁剪</span>
<span class="token keyword">def</span> <span class="token function">rand_crop</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> label<span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data<span class="token punctuation">,</span> rect <span class="token operator">=</span> image_deal<span class="token punctuation">.</span>random_crop<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span>
    label <span class="token operator">=</span> image_deal<span class="token punctuation">.</span>fixed_crop<span class="token punctuation">(</span>label<span class="token punctuation">,</span> <span class="token operator">*</span>rect<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data<span class="token punctuation">,</span> label


imgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    imgs <span class="token operator">+=</span> rand_crop<span class="token punctuation">(</span>train_features<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> train_labels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>
<span class="token comment"># print(imgs)</span>
show_images<span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 3、每个物体和背景对应的RGB值</span>
colormap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
colorclass <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'background'</span><span class="token punctuation">,</span> <span class="token string">'aeroplane'</span><span class="token punctuation">,</span> <span class="token string">'bicycle'</span><span class="token punctuation">,</span> <span class="token string">'bird'</span><span class="token punctuation">,</span> <span class="token string">'boat'</span><span class="token punctuation">,</span>
            <span class="token string">'bottle'</span><span class="token punctuation">,</span> <span class="token string">'bus'</span><span class="token punctuation">,</span> <span class="token string">'car'</span><span class="token punctuation">,</span> <span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token string">'chair'</span><span class="token punctuation">,</span> <span class="token string">'cow'</span><span class="token punctuation">,</span>
            <span class="token string">'diningtable'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">,</span> <span class="token string">'horse'</span><span class="token punctuation">,</span> <span class="token string">'motorbike'</span><span class="token punctuation">,</span> <span class="token string">'person'</span><span class="token punctuation">,</span>
            <span class="token string">'potted plant'</span><span class="token punctuation">,</span> <span class="token string">'sheep'</span><span class="token punctuation">,</span> <span class="token string">'sofa'</span><span class="token punctuation">,</span> <span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'tv/monitor'</span><span class="token punctuation">]</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>colorclass<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 共21类</span>

<span class="token comment"># 4、查找pixel中每个类别的像素索引</span>
colormap2label <span class="token operator">=</span> nd<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">**</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> color_map <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>colormap<span class="token punctuation">)</span><span class="token punctuation">:</span>
    colormap2label<span class="token punctuation">[</span><span class="token punctuation">(</span>color_map<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> color_map<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> color_map<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> i


<span class="token keyword">def</span> <span class="token function">label_indices</span><span class="token punctuation">(</span>colormap<span class="token punctuation">)</span><span class="token punctuation">:</span>
    colormap <span class="token operator">=</span> colormap<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int32'</span><span class="token punctuation">)</span>
    idx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>colormap<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> colormap<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">256</span>
           <span class="token operator">+</span> colormap<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> colormap2label<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>


y <span class="token operator">=</span> label_indices<span class="token punctuation">(</span>train_labels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">[</span><span class="token number">105</span><span class="token punctuation">:</span><span class="token number">115</span><span class="token punctuation">,</span> <span class="token number">130</span><span class="token punctuation">:</span><span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#5、图像预处理</span>
rgb_mean<span class="token operator">=</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span><span class="token number">0.456</span><span class="token punctuation">,</span><span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#官方给的</span>
rgb_std<span class="token operator">=</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span><span class="token number">0.224</span><span class="token punctuation">,</span><span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">normlize</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">"float32"</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token operator">-</span>rgb_mean<span class="token punctuation">)</span><span class="token operator">/</span>rgb_std

<span class="token comment"># for im in train_features:</span>
<span class="token comment">#     print(normlize(im))</span>
<span class="token comment">#6、自定义语义分割数据集类</span>
<span class="token keyword">class</span> <span class="token class-name">VOCSegDataset</span><span class="token punctuation">(</span>gn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> is_train<span class="token punctuation">,</span> crop_size<span class="token punctuation">,</span> voc_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>

        self<span class="token punctuation">.</span>crop_size <span class="token operator">=</span> crop_size
        data<span class="token punctuation">,</span> labels <span class="token operator">=</span> read_images<span class="token punctuation">(</span>root<span class="token operator">=</span>voc_dir<span class="token punctuation">,</span> train<span class="token operator">=</span>is_train<span class="token punctuation">)</span>
        data<span class="token operator">=</span>self<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">[</span>normlize<span class="token punctuation">(</span>im<span class="token punctuation">)</span> <span class="token keyword">for</span> im <span class="token keyword">in</span> data<span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>labels <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'read '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' examples'</span><span class="token punctuation">)</span>

  <span class="token comment">#只保留大于裁剪尺寸的图片</span>
    <span class="token keyword">def</span> <span class="token function">filter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>img <span class="token keyword">for</span> img <span class="token keyword">in</span> images <span class="token keyword">if</span> <span class="token punctuation">(</span>
            img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>crop_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">and</span>
            img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>crop_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token comment"># 每读一张图片，就把它裁剪，并把label的图片转成标签</span>
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data<span class="token punctuation">,</span> label <span class="token operator">=</span> rand_crop<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>labels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                       <span class="token operator">*</span>self<span class="token punctuation">.</span>crop_size<span class="token punctuation">)</span>
        data<span class="token operator">=</span>data<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        label<span class="token operator">=</span>label_indices<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        <span class="token keyword">return</span> data<span class="token punctuation">,</span>label

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
input_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">320</span><span class="token punctuation">,</span><span class="token number">480</span><span class="token punctuation">)</span>
voc_train<span class="token operator">=</span>VOCSegDataset<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span>input_size<span class="token punctuation">,</span>root<span class="token punctuation">)</span>
voc_test<span class="token operator">=</span>VOCSegDataset<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span>input_size<span class="token punctuation">,</span>root<span class="token punctuation">)</span>

<span class="token comment">#7、定义批量读取</span>
batch_size<span class="token operator">=</span><span class="token number">5</span>
train_data<span class="token operator">=</span>gn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>voc_train<span class="token punctuation">,</span>batch_size<span class="token punctuation">,</span>shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test_data<span class="token operator">=</span>gn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>voc_test<span class="token punctuation">,</span>batch_size<span class="token punctuation">,</span>shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token comment"># 查看一下数据维度</span>
<span class="token keyword">for</span> data<span class="token punctuation">,</span>label <span class="token keyword">in</span> train_data<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>shape<span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">,</span>label<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    <span class="token keyword">break</span>

<span class="token triple-quoted-string string">'''---------FCN---------'''</span>
<span class="token comment">#1、转置卷积实例</span>
<span class="token comment"># 除了替换输出的通道数以外，其余的参数都不变，可以将输出还原为输入的大小</span>
conv<span class="token operator">=</span>gn<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>channels<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
conv_trans<span class="token operator">=</span>gn<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2DTranspose<span class="token punctuation">(</span>channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#图片最开始输入通道数为3</span>
conv<span class="token punctuation">.</span>initialize<span class="token punctuation">(</span><span class="token punctuation">)</span>
conv_trans<span class="token punctuation">.</span>initialize<span class="token punctuation">(</span><span class="token punctuation">)</span>
x<span class="token operator">=</span>nd<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">,</span>conv_trans<span class="token punctuation">(</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

<span class="token comment"># 2、下载预训练模型resnet18</span>
ctx<span class="token operator">=</span>mx<span class="token punctuation">.</span>gpu<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
pretrained_model<span class="token operator">=</span>models<span class="token punctuation">.</span>resnet18_v2<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>ctx<span class="token operator">=</span>ctx<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>pretrained_model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>pretrained_model<span class="token punctuation">.</span>output<span class="token punctuation">)</span>

<span class="token comment">#3、添加训练好的权重信息，并修改GAP和FC</span>
net<span class="token operator">=</span>gn<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> layer <span class="token keyword">in</span> pretrained_model<span class="token punctuation">.</span>features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    net<span class="token punctuation">.</span>add<span class="token punctuation">(</span>layer<span class="token punctuation">)</span>
m<span class="token operator">=</span>nd<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">320</span><span class="token punctuation">,</span><span class="token number">480</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ctx<span class="token operator">=</span>ctx<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"input shape:"</span><span class="token punctuation">,</span>m<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"out shape:"</span><span class="token punctuation">,</span>net<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

<span class="token comment"># 添加1X1卷积和转置卷积</span>
num_class<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>colorclass<span class="token punctuation">)</span><span class="token comment"># 几个类别</span>
<span class="token keyword">with</span> net<span class="token punctuation">.</span>name_scope<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    net<span class="token punctuation">.</span>add<span class="token punctuation">(</span>gn<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>num_class<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            gn<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Conv2DTranspose<span class="token punctuation">(</span>num_class<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># kernel_size最好大于32，padding=(kernel_size-strides)/2</span>

<span class="token comment"># 4、训练</span>
<span class="token comment"># 双线性插值</span>
<span class="token keyword">def</span> <span class="token function">bilinear_kernel</span><span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    factor <span class="token operator">=</span> <span class="token punctuation">(</span>kernel_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>
    <span class="token keyword">if</span> kernel_size <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        center <span class="token operator">=</span> factor <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        center <span class="token operator">=</span> factor <span class="token operator">-</span> <span class="token number">0.5</span>
    og <span class="token operator">=</span> np<span class="token punctuation">.</span>ogrid<span class="token punctuation">[</span><span class="token punctuation">:</span>kernel_size<span class="token punctuation">,</span> <span class="token punctuation">:</span>kernel_size<span class="token punctuation">]</span>
    filt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>og<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> center<span class="token punctuation">)</span> <span class="token operator">/</span> factor<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>og<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> center<span class="token punctuation">)</span> <span class="token operator">/</span> factor<span class="token punctuation">)</span>
    weight <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> kernel_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
                      dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
    weight<span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span>in_channels<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> filt
    <span class="token keyword">return</span> nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>weight<span class="token punctuation">)</span>

<span class="token comment"># 初始化</span>
net<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>initialize<span class="token punctuation">(</span>init<span class="token operator">=</span>init<span class="token punctuation">.</span>Xavier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ctx<span class="token operator">=</span>ctx<span class="token punctuation">)</span> <span class="token comment"># 1X1 conv</span>

net<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>initialize<span class="token punctuation">(</span>init<span class="token punctuation">.</span>Constant<span class="token punctuation">(</span>bilinear_kernel<span class="token punctuation">(</span>in_channels<span class="token operator">=</span>num_class<span class="token punctuation">,</span>out_channels<span class="token operator">=</span>num_class<span class="token punctuation">,</span>
                                                 kernel_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ctx<span class="token operator">=</span>ctx<span class="token punctuation">)</span>

cross_loss<span class="token operator">=</span>gn<span class="token punctuation">.</span>loss<span class="token punctuation">.</span>SoftmaxCrossEntropyLoss<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

net<span class="token punctuation">.</span>collect_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_ctx<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
trainer<span class="token operator">=</span>gn<span class="token punctuation">.</span>Trainer<span class="token punctuation">(</span>net<span class="token punctuation">.</span>collect_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'sgd'</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token string">"learning_rate"</span><span class="token punctuation">:</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token string">"wd"</span><span class="token punctuation">:</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># 定义准确率</span>
<span class="token keyword">def</span> <span class="token function">accuracy</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> nd<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>output<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span>label<span class="token punctuation">)</span><span class="token punctuation">.</span>asscalar<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">evaluate_accuracy</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">,</span> net<span class="token punctuation">,</span>ctx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    acc_sum<span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token keyword">for</span> features<span class="token punctuation">,</span>label <span class="token keyword">in</span> data_iter<span class="token punctuation">:</span>
        features <span class="token operator">=</span> features<span class="token punctuation">.</span>as_in_context<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        label <span class="token operator">=</span> label<span class="token punctuation">.</span>as_in_context<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        output<span class="token operator">=</span>net<span class="token punctuation">(</span>features<span class="token punctuation">)</span>
        acc_sum<span class="token operator">+=</span>accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span>label<span class="token punctuation">)</span>
        n <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> acc_sum<span class="token operator">/</span> n

<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>train_iter<span class="token punctuation">,</span> test_iter<span class="token punctuation">,</span> net<span class="token punctuation">,</span> cross_loss<span class="token punctuation">,</span> trainer<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'training on'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        train_l_sum<span class="token punctuation">,</span> train_acc_sum<span class="token punctuation">,</span> n<span class="token punctuation">,</span>start <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> Xs<span class="token punctuation">,</span> ys <span class="token keyword">in</span> train_iter<span class="token punctuation">:</span>
            Xs<span class="token operator">=</span>Xs<span class="token punctuation">.</span>as_in_context<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            ys<span class="token operator">=</span>ys<span class="token punctuation">.</span>as_in_context<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            <span class="token keyword">with</span> ag<span class="token punctuation">.</span>record<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                output <span class="token operator">=</span> net<span class="token punctuation">(</span>Xs<span class="token punctuation">)</span>
                loss <span class="token operator">=</span> nd<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>cross_loss<span class="token punctuation">(</span>output<span class="token punctuation">,</span> ys<span class="token punctuation">)</span><span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            trainer<span class="token punctuation">.</span>step<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>
            train_l_sum <span class="token operator">+=</span> loss<span class="token punctuation">.</span>asscalar<span class="token punctuation">(</span><span class="token punctuation">)</span>
            train_acc_sum<span class="token operator">+=</span>accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span>ys<span class="token punctuation">)</span>
            n <span class="token operator">+=</span> <span class="token number">1</span>
        test_acc <span class="token operator">=</span> evaluate_accuracy<span class="token punctuation">(</span>test_iter<span class="token punctuation">,</span> net<span class="token punctuation">,</span>ctx<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'epoch %d, loss %.4f, train acc %.3f, test acc %.3f '</span><span class="token string">'time %.1f sec'</span>
              <span class="token operator">%</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> train_l_sum <span class="token operator">/</span> n<span class="token punctuation">,</span> train_acc_sum <span class="token operator">/</span> n<span class="token punctuation">,</span>test_acc<span class="token punctuation">,</span>
                 time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># train(train_data,test_data,net,cross_loss,trainer,ctx,10)</span>
<span class="token comment"># net.save_parameters("FCN.params")# 保存模型</span>

<span class="token comment"># 5、预测</span>
net<span class="token punctuation">.</span>load_parameters<span class="token punctuation">(</span><span class="token string">"FCN.params"</span><span class="token punctuation">)</span> <span class="token comment">#读取参数</span>
<span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data<span class="token operator">=</span>normlize<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    data<span class="token operator">=</span>data<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    y_hat<span class="token operator">=</span>net<span class="token punctuation">(</span>data<span class="token punctuation">.</span>as_in_context<span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    pred<span class="token operator">=</span>nd<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pred<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>pred<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>pred<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">label2img</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span>colormap<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cm <span class="token operator">=</span> nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>colormap<span class="token punctuation">,</span> ctx<span class="token operator">=</span>ctx<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'uint8'</span><span class="token punctuation">)</span>
    X <span class="token operator">=</span> pred<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int32'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cm<span class="token punctuation">[</span>X<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>

<span class="token comment"># 读取测试集前几张图片做预测</span>
test_image<span class="token punctuation">,</span>test_label<span class="token operator">=</span>read_images<span class="token punctuation">(</span>root<span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">)</span>

image_6<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    x<span class="token operator">=</span>test_image<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    pred<span class="token operator">=</span>label2img<span class="token punctuation">(</span>predict<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>colormap<span class="token punctuation">)</span>
    image_6<span class="token operator">+=</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span>pred<span class="token punctuation">,</span>test_label<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
show_images<span class="token punctuation">(</span>image_6<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/efe2dcd56506821cb747dbf98ba5a7ba/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">图形类设计——c&#43;&#43;圆、矩形、三角形类的设计</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4de944ffe0042f6f53279c39f124ca21/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LaTeX 中的段落和换行</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>