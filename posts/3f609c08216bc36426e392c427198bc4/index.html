<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>etcd故障-recovering backend from snapshot error: failed to find database snapshot file - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="etcd故障-recovering backend from snapshot error: failed to find database snapshot file" />
<meta property="og:description" content="一、问题描述 服务器意外宕机，k8s无法启动,查看kubelet日志提示node “master” not found,查看etcd 的日志报错如下面：
很明显是数据库文件损坏了
[root@master01 ~]# journalctl -u etcd -f ... Oct 08 19:13:40 master01 etcd[66468]: recovering backend from snapshot error: failed to find database snapshot file (snap: snapshot file doesn&#39;t exist) Oct 08 19:13:40 master01 etcd[66468]: panic: recovering backend from snapshot error: failed to find database snapshot file (snap: snapshot file doesn&#39;t exist)
二、解决问题 进一步查看发现：etcd1 和etcd2 都存在上面的报错，但是3没有
2.1 备份 etcd1和etcd2上执行：
mv /var/lib/etcd/member /opt/ 2.2 复制数据 将etcd3上的正常数据复制到etcd1和etcd2上" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/3f609c08216bc36426e392c427198bc4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-09T11:28:45+08:00" />
<meta property="article:modified_time" content="2023-10-09T11:28:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">etcd故障-recovering backend from snapshot error: failed to find database snapshot file</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>一、问题描述</h2> 
<p>服务器意外宕机，k8s无法启动,查看kubelet日志提示node “master” not found,查看etcd 的日志报错如下面：<br> 很明显是数据库文件损坏了<br> <code>[root@master01 ~]# journalctl -u etcd -f ... Oct 08 19:13:40 master01 etcd[66468]: recovering backend from snapshot error: failed to find database snapshot file (snap: snapshot file doesn't exist) Oct 08 19:13:40 master01 etcd[66468]: panic: recovering backend from snapshot error: failed to find database snapshot file (snap: snapshot file doesn't exist)</code></p> 
<h2><a id="_8"></a>二、解决问题</h2> 
<p><code>进一步查看发现：etcd1 和etcd2 都存在上面的报错，但是3没有</code></p> 
<h3><a id="21__11"></a>2.1 备份</h3> 
<p>etcd1和etcd2上执行：</p> 
<pre><code class="prism language-bash"><span class="token function">mv</span> /var/lib/etcd/member /opt/
</code></pre> 
<h3><a id="22__17"></a>2.2 复制数据</h3> 
<p>将etcd3上的正常数据复制到etcd1和etcd2上</p> 
<pre><code class="prism language-bash"><span class="token function">scp</span> /var/lib/etcd/member  <span class="token number">10.0</span>.0.87:/var/lib/etcd/
<span class="token function">scp</span> /var/lib/etcd/member  <span class="token number">10.0</span>.0.97:/var/lib/etcd/
</code></pre> 
<h3><a id="23_etcd1etcd2_24"></a>2.3 启动etcd1和etcd2</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master01 etcd<span class="token punctuation">]</span><span class="token comment"># systemctl start etcd</span>
<span class="token punctuation">[</span>root@master01 etcd<span class="token punctuation">]</span><span class="token comment"># systemctl status etcd</span>
● etcd.service - Etcd Service
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/etcd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Sun <span class="token number">2023</span>-10-08 <span class="token number">19</span>:24:37 CST<span class="token punctuation">;</span> 27min ago
     Docs: https://coreos.com/etcd/docs/latest/
 Main PID: <span class="token number">71124</span> <span class="token punctuation">(</span>etcd<span class="token punctuation">)</span>
    Tasks: <span class="token number">11</span>
   Memory: <span class="token number">84</span>.5M
   CGroup: /system.slice/etcd.service
           └─71124 /usr/local/bin/etcd --config-file<span class="token operator">=</span>/etc/etcd/etcd.config.yml

-------------------------------------
<span class="token punctuation">[</span>root@master02 etcd<span class="token punctuation">]</span><span class="token comment"># systemctl start etcd</span>
<span class="token punctuation">[</span>root@master02 etcd<span class="token punctuation">]</span><span class="token comment"># systemctl status etcd</span>
● etcd.service - Etcd Service
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/etcd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Sun <span class="token number">2023</span>-10-08 <span class="token number">19</span>:24:37 CST<span class="token punctuation">;</span> 27min ago
     Docs: https://coreos.com/etcd/docs/latest/
 Main PID: <span class="token number">4643</span> <span class="token punctuation">(</span>etcd<span class="token punctuation">)</span>
    Tasks: <span class="token number">12</span>
   Memory: <span class="token number">72</span>.2M
   CGroup: /system.slice/etcd.service
           └─4643 /usr/local/bin/etcd --config-file<span class="token operator">=</span>/etc/etcd/etcd.config.yml

</code></pre> 
<h3><a id="24_etcd3_52"></a>2.4 启动etcd3</h3> 
<p>但是启动etcd3 报错了</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master03 etcd<span class="token punctuation">]</span><span class="token comment"># systemctl start etcd</span>
Job <span class="token keyword">for</span> etcd.service failed because the control process exited with error code. See <span class="token string">"systemctl status etcd.service"</span> and <span class="token string">"journalctl -xe"</span> <span class="token keyword">for</span> details.
</code></pre> 
<p>因为etcd1和etcd2 都正常了，所以可以把etcd3的数据删除，然后让他自己同步数据</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master03 etcd<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/var/lib/etcd
<span class="token punctuation">[</span>root@master03 etcd<span class="token punctuation">]</span><span class="token comment"># rm -rf ./*</span>

<span class="token comment">#验证</span>
<span class="token punctuation">[</span>root@master03 etcd<span class="token punctuation">]</span><span class="token comment"># journalctl -u etcd -f</span>
-- Logs begin at Sat <span class="token number">2023</span>-10-07 <span class="token number">20</span>:57:40 CST. --
Oct 08 <span class="token number">19</span>:54:41 master03 etcd<span class="token punctuation">[</span><span class="token number">12512</span><span class="token punctuation">]</span>: store.index: compact <span class="token number">2706</span>
Oct 08 <span class="token number">19</span>:54:41 master03 etcd<span class="token punctuation">[</span><span class="token number">12512</span><span class="token punctuation">]</span>: finished scheduled compaction at <span class="token number">2706</span> <span class="token punctuation">(</span>took <span class="token number">1</span>.3901ms<span class="token punctuation">)</span>
Oct 08 <span class="token number">19</span>:54:41 master03 etcd<span class="token punctuation">[</span><span class="token number">12512</span><span class="token punctuation">]</span>: store.index: compact <span class="token number">3302</span>
Oct 08 <span class="token number">19</span>:54:41 master03 etcd<span class="token punctuation">[</span><span class="token number">12512</span><span class="token punctuation">]</span>: finished scheduled compaction at <span class="token number">3302</span> <span class="token punctuation">(</span>took <span class="token number">2</span>.115ms<span class="token punctuation">)</span>
Oct 08 <span class="token number">19</span>:54:41 master03 etcd<span class="token punctuation">[</span><span class="token number">12512</span><span class="token punctuation">]</span>: published <span class="token punctuation">{<!-- --></span>Name:master03 ClientURLs:<span class="token punctuation">[</span>https://10.0.0.107:2379<span class="token punctuation">]</span><span class="token punctuation">}</span> to cluster 514c88d14c1a2aa1
Oct 08 <span class="token number">19</span>:54:41 master03 etcd<span class="token punctuation">[</span><span class="token number">12512</span><span class="token punctuation">]</span>: ready to serve client requests
Oct 08 <span class="token number">19</span>:54:41 master03 etcd<span class="token punctuation">[</span><span class="token number">12512</span><span class="token punctuation">]</span>: ready to serve client requests
Oct 08 <span class="token number">19</span>:54:41 master03 etcd<span class="token punctuation">[</span><span class="token number">12512</span><span class="token punctuation">]</span>: serving insecure client requests on <span class="token number">127.0</span>.0.1:2379, this is strongly discouraged<span class="token operator">!</span>
Oct 08 <span class="token number">19</span>:54:41 master03 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started Etcd Service.
Oct 08 <span class="token number">19</span>:54:41 master03 etcd<span class="token punctuation">[</span><span class="token number">12512</span><span class="token punctuation">]</span>: serving client requests on <span class="token number">10.0</span>.0.107:2379
Oct 08 <span class="token number">19</span>:54:42 master03 etcd<span class="token punctuation">[</span><span class="token number">12512</span><span class="token punctuation">]</span>: updated the cluster version from <span class="token number">3.0</span> to <span class="token number">3.4</span>
Oct 08 <span class="token number">19</span>:54:42 master03 etcd<span class="token punctuation">[</span><span class="token number">12512</span><span class="token punctuation">]</span>: enabled capabilities <span class="token keyword">for</span> version <span class="token number">3.4</span>

</code></pre> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master03 etcd<span class="token punctuation">]</span><span class="token comment"># systemctl status etcd</span>
● etcd.service - Etcd Service
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/etcd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Sun <span class="token number">2023</span>-10-08 <span class="token number">19</span>:54:41 CST<span class="token punctuation">;</span> 2min 41s ago
     Docs: https://coreos.com/etcd/docs/latest/
 Main PID: <span class="token number">12512</span> <span class="token punctuation">(</span>etcd<span class="token punctuation">)</span>
    Tasks: <span class="token number">10</span>
   Memory: <span class="token number">58</span>.7M
   CGroup: /system.slice/etcd.service
           └─12512 /usr/local/bin/etcd --config-file<span class="token operator">=</span>/etc/etcd/etcd.config.yml

</code></pre> 
<h2><a id="_98"></a>三、验证数据</h2> 
<h3><a id="31_etcd_99"></a>3.1 验证etcd集群</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master01 init<span class="token punctuation">]</span><span class="token comment"># export ETCDCTL_API=3</span>
<span class="token punctuation">[</span>root@master01 init<span class="token punctuation">]</span><span class="token comment"># etcdctl --endpoints="10.0.0.87:2379,10.0.0.97:2379,10.0.0.107:2379" --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span>
+-----------------+------------------+---------+---------+--------
<span class="token operator">|</span>    ENDPOINT     <span class="token operator">|</span>        ID        <span class="token operator">|</span> VERSION <span class="token operator">|</span> DB SIZE <span class="token operator">|</span> IS LEADER <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span> RAFT <span class="token environment constant">TERM</span> <span class="token operator">|</span> RAFT INDEX <span class="token operator">|</span> RAFT APPLIED INDEX <span class="token operator">|</span> ERRORS <span class="token operator">|</span>
+-----------------+------------------+---------+---------+--------
<span class="token operator">|</span>  <span class="token number">10.0</span>.0.87:2379 <span class="token operator">|</span> 949b9ccaa465bea8 <span class="token operator">|</span>  <span class="token number">3.4</span>.13 <span class="token operator">|</span>  <span class="token number">3.9</span> MB <span class="token operator">|</span>      <span class="token boolean">true</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>        <span class="token number">14</span> <span class="token operator">|</span>       <span class="token number">5239</span> <span class="token operator">|</span>               <span class="token number">5239</span> <span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">10.0</span>.0.97:2379 <span class="token operator">|</span> 795272eff6c8418e <span class="token operator">|</span>  <span class="token number">3.4</span>.13 <span class="token operator">|</span>  <span class="token number">3.8</span> MB <span class="token operator">|</span>     <span class="token boolean">false</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>        <span class="token number">14</span> <span class="token operator">|</span>       <span class="token number">5239</span> <span class="token operator">|</span>               <span class="token number">5239</span> <span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10.0</span>.0.107:2379 <span class="token operator">|</span> 41172b80a9c89e7f <span class="token operator">|</span>  <span class="token number">3.4</span>.13 <span class="token operator">|</span>  <span class="token number">3.9</span> MB <span class="token operator">|</span>     <span class="token boolean">false</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>        <span class="token number">14</span> <span class="token operator">|</span>       <span class="token number">5239</span> <span class="token operator">|</span>               <span class="token number">5239</span> <span class="token operator">|</span>        <span class="token operator">|</span>
+-----------------+------------------+---------+---------+--------

</code></pre> 
<h3><a id="32_k8s__113"></a>3.2 验证k8s 集群</h3> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node</span>
NAME       STATUS   ROLES    AGE   VERSION
master01   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   35m   v1.20.0
master02   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   35m   v1.20.0
master03   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   35m   v1.20.0
node02     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   35m   v1.20.0

<span class="token punctuation">[</span>root@master01 dashboard<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -A</span>
NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE
kube-system            calico-kube-controllers-5f6d4b864b-jf7sl     <span class="token number">1</span>/1     Running   <span class="token number">1</span>          50m
kube-system            calico-node-5vkdg                            <span class="token number">1</span>/1     Running   <span class="token number">2</span>          50m
kube-system            calico-node-k4jtq                            <span class="token number">1</span>/1     Running   <span class="token number">1</span>          50m
kube-system            calico-node-l27hd                            <span class="token number">1</span>/1     Running   <span class="token number">1</span>          50m
kube-system            calico-node-vt9jf                            <span class="token number">1</span>/1     Running   <span class="token number">2</span>          50m
kube-system            calico-node-w7x9b                            <span class="token number">1</span>/1     Running   <span class="token number">1</span>          50m
kube-system            coredns-867d46bfc6-6rx4r                     <span class="token number">1</span>/1     Running   <span class="token number">2</span>          38m
kube-system            metrics-server-595f65d8d5-wvp8s              <span class="token number">1</span>/1     Running   <span class="token number">1</span>          36m
kubernetes-dashboard   dashboard-metrics-scraper-79c5968bdc-ghmzr   <span class="token number">1</span>/1     Running   <span class="token number">2</span>          31m
kubernetes-dashboard   kubernetes-dashboard-9f9799597-vqzmq         <span class="token number">1</span>/1     Running   <span class="token number">1</span>          24m


</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/08d64faa344c184de4fcc0a3f28878fb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">卸载宝塔面板</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80a9b9e60b8723593346d07af79f3d4f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">js数字排序</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>