<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Nordic 中心设备（central）获取 外围设备（peripheral）设备名 （Device Name） - 编程中国的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Nordic 中心设备（central）获取 外围设备（peripheral）设备名 （Device Name）" />
<meta property="og:description" content="Nordic 中心设备（central）获取 外围设备（peripheral）设备名 （Device Name） 中心设备在扫描到外围设备后，我想知道扫描到设备的设备名称。通过ble_advdata_parse( )可获得外设设备的设备名称，即蓝牙广播名称。
需要的头文件包括：ble_gap.h，ble_advdata.h
在ble_gap_evt_t结构体中有adv_report字段。通过上面的接口可从这个字段中获取到设备名。
typedef struct { uint16_t conn_handle; /**&lt; Connection Handle on which event occurred. */ union /**&lt; union alternative identified by evt_id in enclosing struct. */ { ble_gap_evt_connected_t connected; /**&lt; Connected Event Parameters. */ ble_gap_evt_disconnected_t disconnected; /**&lt; Disconnected Event Parameters. */ ble_gap_evt_conn_param_update_t conn_param_update; /**&lt; Connection Parameter Update Parameters. */ ble_gap_evt_sec_params_request_t sec_params_request; /**&lt; Security Parameters Request Event Parameters. */ ble_gap_evt_sec_info_request_t sec_info_request; /**&lt; Security Information Request Event Parameters." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/afab9e47c5f7f67510052582ea358ff1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-16T21:03:05+08:00" />
<meta property="article:modified_time" content="2022-10-16T21:03:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程中国的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程中国的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nordic 中心设备（central）获取 外围设备（peripheral）设备名 （Device Name）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3 align="center">Nordic 中心设备（central）获取 外围设备（peripheral）设备名 （Device Name） </h3> 
<p>中心设备在扫描到外围设备后，我想知道扫描到设备的设备名称。通过<code>ble_advdata_parse( )</code>可获得外设设备的设备名称，即蓝牙广播名称。</p> 
<p>需要的头文件包括：<code>ble_gap.h</code>，<code>ble_advdata.h</code></p> 
<p>在<code>ble_gap_evt_t</code>结构体中有<code>adv_report</code>字段。通过上面的接口可从这个字段中获取到设备名。</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint16_t</span> conn_handle<span class="token punctuation">;</span>                                     <span class="token comment">/**&lt; Connection Handle on which event occurred. */</span>
  <span class="token keyword">union</span>                                                     <span class="token comment">/**&lt; union alternative identified by evt_id in enclosing struct. */</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ble_gap_evt_connected_t</span>                   connected<span class="token punctuation">;</span>                    <span class="token comment">/**&lt; Connected Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_disconnected_t</span>                disconnected<span class="token punctuation">;</span>                 <span class="token comment">/**&lt; Disconnected Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_conn_param_update_t</span>           conn_param_update<span class="token punctuation">;</span>            <span class="token comment">/**&lt; Connection Parameter Update Parameters. */</span>
    <span class="token class-name">ble_gap_evt_sec_params_request_t</span>          sec_params_request<span class="token punctuation">;</span>           <span class="token comment">/**&lt; Security Parameters Request Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_sec_info_request_t</span>            sec_info_request<span class="token punctuation">;</span>             <span class="token comment">/**&lt; Security Information Request Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_passkey_display_t</span>             passkey_display<span class="token punctuation">;</span>              <span class="token comment">/**&lt; Passkey Display Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_key_pressed_t</span>                 key_pressed<span class="token punctuation">;</span>                  <span class="token comment">/**&lt; Key Pressed Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_auth_key_request_t</span>            auth_key_request<span class="token punctuation">;</span>             <span class="token comment">/**&lt; Authentication Key Request Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_lesc_dhkey_request_t</span>          lesc_dhkey_request<span class="token punctuation">;</span>           <span class="token comment">/**&lt; LE Secure Connections DHKey calculation request. */</span>
    <span class="token class-name">ble_gap_evt_auth_status_t</span>                 auth_status<span class="token punctuation">;</span>                  <span class="token comment">/**&lt; Authentication Status Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_conn_sec_update_t</span>             conn_sec_update<span class="token punctuation">;</span>              <span class="token comment">/**&lt; Connection Security Update Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_timeout_t</span>                     timeout<span class="token punctuation">;</span>                      <span class="token comment">/**&lt; Timeout Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_rssi_changed_t</span>                rssi_changed<span class="token punctuation">;</span>                 <span class="token comment">/**&lt; RSSI Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_adv_report_t</span>                  adv_report<span class="token punctuation">;</span>                   <span class="token comment">/**&lt; Advertising Report Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_adv_set_terminated_t</span>          adv_set_terminated<span class="token punctuation">;</span>           <span class="token comment">/**&lt; Advertising Set Terminated Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_sec_request_t</span>                 sec_request<span class="token punctuation">;</span>                  <span class="token comment">/**&lt; Security Request Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_conn_param_update_request_t</span>   conn_param_update_request<span class="token punctuation">;</span>    <span class="token comment">/**&lt; Connection Parameter Update Parameters. */</span>
    <span class="token class-name">ble_gap_evt_scan_req_report_t</span>             scan_req_report<span class="token punctuation">;</span>              <span class="token comment">/**&lt; Scan Request Report Parameters. */</span>
    <span class="token class-name">ble_gap_evt_phy_update_request_t</span>          phy_update_request<span class="token punctuation">;</span>           <span class="token comment">/**&lt; PHY Update Request Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_phy_update_t</span>                  phy_update<span class="token punctuation">;</span>                   <span class="token comment">/**&lt; PHY Update Parameters. */</span>
    <span class="token class-name">ble_gap_evt_data_length_update_request_t</span>  data_length_update_request<span class="token punctuation">;</span>   <span class="token comment">/**&lt; Data Length Update Request Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_data_length_update_t</span>          data_length_update<span class="token punctuation">;</span>           <span class="token comment">/**&lt; Data Length Update Event Parameters. */</span>
    <span class="token class-name">ble_gap_evt_qos_channel_survey_report_t</span>   qos_channel_survey_report<span class="token punctuation">;</span>    <span class="token comment">/**&lt; Quality of Service (QoS) Channel Survey Report Parameters. */</span>
  <span class="token punctuation">}</span> params<span class="token punctuation">;</span>                                                                 <span class="token comment">/**&lt; Event Parameters. */</span>
<span class="token punctuation">}</span> <span class="token class-name">ble_gap_evt_t</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里有两个地方都可以进行这个处理。<br> 一是在<code>nRF_BLE\nrf_ble_scan</code>中，通过<code>nRF_BLE\ble_advdata.c</code>中的接口<code>bel_advdata_parse()</code>进行获取。</p> 
<p><img src="https://images2.imgbox.com/26/5b/0ZHEbUDp_o.png" alt="在这里插入图片描述"><br> 在<code>BLE_GAP_EVT_ADV_REPORT</code>事件中进行处理。但是这个文件我们尽量不要进行更改，会影响到SDK中的其它文件。</p> 
<p>二是在<code>scan_evt_handler()</code>扫描回调中进行处理。<code>NRF_BLE_SCAN_EVT_FILTER_MATCH</code>，<code>NRF_BLE_SCAN_EVT_NOT_FOUND</code>都是可以进行处理的。只要包含<code>ble_gap_evt_adv_report_t</code>这个参数的地方都可以进行处理。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scan_evt_handler</span><span class="token punctuation">(</span><span class="token class-name">scan_evt_t</span> <span class="token keyword">const</span> <span class="token operator">*</span> p_scan_evt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ret_code_t</span> err_code<span class="token punctuation">;</span>
    <span class="token class-name">ble_gap_evt_adv_report_t</span> <span class="token keyword">const</span> <span class="token operator">*</span>p_adv <span class="token operator">=</span> p_scan_evt<span class="token operator">-&gt;</span>params<span class="token punctuation">.</span>filter_match<span class="token punctuation">.</span>p_adv_report<span class="token punctuation">;</span>
    <span class="token class-name">ble_gap_scan_params_t</span> <span class="token keyword">const</span> <span class="token operator">*</span>p_scan_param <span class="token operator">=</span> p_scan_evt<span class="token operator">-&gt;</span>p_scan_params<span class="token punctuation">;</span>
    <span class="token class-name">ble_gap_evt_connected_t</span> <span class="token keyword">const</span> <span class="token operator">*</span> p_connected <span class="token operator">=</span> p_scan_evt<span class="token operator">-&gt;</span>params<span class="token punctuation">.</span>connected<span class="token punctuation">.</span>p_connected<span class="token punctuation">;</span>
    <span class="token class-name">ble_gap_evt_adv_report_t</span> <span class="token keyword">const</span>  <span class="token operator">*</span> p_not_found <span class="token operator">=</span> p_scan_evt<span class="token operator">-&gt;</span>params<span class="token punctuation">.</span>p_not_found<span class="token punctuation">;</span>

    <span class="token keyword">switch</span><span class="token punctuation">(</span>p_scan_evt<span class="token operator">-&gt;</span>scan_evt_id<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> NRF_BLE_SCAN_EVT_FILTER_MATCH<span class="token operator">:</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">NRF_LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"match "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">NRF_LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"scan to target %02x%02x%02x%02x%02x%02x"</span><span class="token punctuation">,</span>
                     p_adv<span class="token operator">-&gt;</span>peer_addr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     p_adv<span class="token operator">-&gt;</span>peer_addr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     p_adv<span class="token operator">-&gt;</span>peer_addr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     p_adv<span class="token operator">-&gt;</span>peer_addr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     p_adv<span class="token operator">-&gt;</span>peer_addr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     p_adv<span class="token operator">-&gt;</span>peer_addr<span class="token punctuation">.</span>addr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> NRF_BLE_SCAN_EVT_NOT_FOUND<span class="token operator">:</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token function">get_scan_list</span><span class="token punctuation">(</span>p_not_found<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ble_gap_scan_params_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p_scan_param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">uint8_t</span> <span class="token operator">*</span> adv_data <span class="token operator">=</span> p_not_found<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>p_data<span class="token punctuation">;</span>
            <span class="token class-name">uint16_t</span> adv_data_size <span class="token operator">=</span> p_not_found<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>len<span class="token punctuation">;</span>
            <span class="token class-name">uint8_t</span> <span class="token operator">*</span> device_name <span class="token operator">=</span> <span class="token function">ble_advdata_parse</span><span class="token punctuation">(</span>adv_data<span class="token punctuation">,</span> \
                                    adv_data_size<span class="token punctuation">,</span> \
                                    BLE_GAP_AD_TYPE_COMPLETE_LOCAL_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>device_name<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                device_name <span class="token operator">=</span> <span class="token function">ble_advdata_parse</span><span class="token punctuation">(</span>adv_data<span class="token punctuation">,</span> \
                                                adv_data_size<span class="token punctuation">,</span> \
                                                BLE_GAP_AD_TYPE_SHORT_LOCAL_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>device_name<span class="token punctuation">)</span>
                    <span class="token function">NRF_LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"BLE_GAP_AD_TYPE_SHORT_LOCAL_NAME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>device_name<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">char</span> device_name_buff<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token class-name">uint16_t</span> data_len <span class="token operator">=</span> <span class="token punctuation">(</span>adv_data <span class="token operator">+</span> adv_data_size <span class="token operator">-</span> device_name<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">NRF_LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"size: %d"</span><span class="token punctuation">,</span> data_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>device_name_buff<span class="token punctuation">,</span> device_name<span class="token punctuation">,</span> data_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">NRF_LOG_INFO</span><span class="token punctuation">(</span><span class="token string">"device name: %s"</span><span class="token punctuation">,</span> device_name_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>打印出扫描到的设备的MAC地址和设备名。<br> <img src="https://images2.imgbox.com/42/4c/B9Yg84Bh_o.png" alt="在这里插入图片描述"></p> 
<p>另外的，当连接的时候也能获取到设备名。在<code>ble_evt_handler()</code>回调中也能进行处理，因为这里从协议栈传出了我们需要的结构体参数。<br> <img src="https://images2.imgbox.com/22/76/t4LWD8TA_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0b2fcd18853084ae0bcc42a704aa9e76/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">js Object 对象 属性和方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8cc7e0a49ca3930427017b183c6bd30d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[转]为什么要建立数据中台？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程中国的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>